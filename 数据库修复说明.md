# 数据库修复脚本说明

## 问题背景
您遇到的错误是因为数据库中缺少 `site` 字段，导致前端无法正确查询和显示数据。这个脚本会安全地修复数据库结构。

## 脚本功能说明

### 1. 检查当前表结构
- 检查 `ae_self_operated_daily` 表是否存在
- 检查表中有哪些字段
- 确认是否缺少 `site` 字段

### 2. 添加站点字段
- 如果表存在但没有 `site` 字段，会自动添加
- 设置 `site` 字段为必填字段，默认值为 'A站'
- 更新主键约束，包含 `site` 字段
- 创建索引以提高查询性能

### 3. 创建站点管理表
- 如果 `sites` 表不存在，会自动创建
- 包含站点ID、名称、平台类型、显示名称等字段

### 4. 初始化默认站点数据
- 创建以下默认站点：
  - `ae_self_operated_a`: 速卖通自运营 A站
  - `ae_managed`: 速卖通全托管
  - `independent_poolsvacuum`: 独立站 poolsvacuum.com
  - `independent_icyberite`: 独立站 icyberite.com

### 5. 更新现有数据
- 将所有现有数据的 `site` 字段设置为 'A站'
- 确保没有空值或NULL值

### 6. 重新创建视图
- 更新周度和月度汇总视图
- 确保视图包含 `site` 字段

### 7. 设置安全策略
- 启用行级安全策略（RLS）
- 创建适当的访问权限策略

### 8. 验证修复结果
- 检查最终表结构
- 验证主键约束
- 统计各站点的数据量
- 确认站点配置

## 执行步骤

1. **备份数据**（重要）：
   ```sql
   CREATE TABLE ae_self_operated_daily_backup AS 
   SELECT * FROM ae_self_operated_daily;
   ```

2. **执行修复脚本**：
   - 复制 `fix_database_site_field.sql` 的内容
   - 在 Supabase SQL Editor 中粘贴并执行

3. **验证结果**：
   - 检查是否显示 "Database structure fix completed successfully!"
   - 查看表结构是否包含 `site` 字段
   - 确认数据是否正确更新

## 预期结果

执行成功后，您应该看到：
- ✅ 表结构包含 `site` 字段
- ✅ 主键包含 `site, product_id, stat_date`
- ✅ 所有现有数据的 `site` 字段为 'A站'
- ✅ 站点配置表包含默认站点
- ✅ 前端可以正常查询和显示数据

## 注意事项

- 这个脚本是安全的，可以多次执行
- 不会删除现有数据
- 如果字段已存在，会跳过创建步骤
- 建议在执行前备份重要数据

## 如果遇到问题

如果执行过程中遇到错误：
1. 检查错误信息
2. 确认数据库权限
3. 查看是否有其他进程正在使用表
4. 联系技术支持

执行完成后，您的多站点功能应该可以正常工作了！
