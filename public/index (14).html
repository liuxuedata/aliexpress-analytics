
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>速卖通全托管数据分析</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250811-single">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
</head>
<body class="fm">
<div class="container">
  <nav class="sidebar" id="sidebar">
    <h3>产品导航</h3>
    <ul>
      <li class="has-submenu open">
        <a href="#">速卖通</a>
        <ul class="submenu">
          <li><a href="index.html" class="active">全托管</a></li>
          <li><a href="self-operated.html">自运营</a></li>
        </ul>
      </li>
      <li><a href="#">TikTok Shop</a></li>
      <li><a href="#">亚马逊</a></li>
      <li class="has-submenu open">
        <a href="#">独立站</a>
        <ul class="submenu">
          <li><a href="independent-site.html">数据分析</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <main class="main">
    <div class="upload-section">
      <div class="upload-top">
        <div style="font-size:28px;font-weight:800;">速卖通全托管数据分析</div>
        <div class="controls">
          <label class="badge">时间粒度</label>
          <label><input type="radio" name="gran" value="week" checked> 周</label>
          <label><input type="radio" name="gran" value="month"> 月</label>

          <select id="periodSelect" class="sel"><option value="">加载中...</option></select>

          <label for="file" id="pickLabel" class="upload-btn">选择文件</label>
          <input type="file" id="file" accept=".xlsx,.xls" />
          <span id="status" class="notice"></span>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="content-pad">
        <div class="stats-cards" id="kpi"></div>
        <div class="divider"></div>
        
<div class="tabs">
  <div class="tab active" data-tab="detail">明细表</div>
  <div class="tab" data-tab="analysis">运营分析</div>
</div>

<section id="detail" class="content-pad">
  <div class="table-section">
          <table id="report" class="display" style="width:100%">
            <thead>
              <tr>
                <th>商品ID</th>
<th>搜索曝光量</th>
                <th>商品访客数</th>
                <th>商品浏览量</th>
                <th>加购人数</th>
                <th>加购件数</th>
                <th>支付件数</th>
                <th>支付订单数</th>
                <th>支付买家数</th>
                <th>访客到加购转化率(%)</th>
                <th>加购到支付转化率(%)</th>
                <th>访客比(%)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
</section>

<section id="analysis" class="content-pad" style="display:none;">
  <div class="grid grid-2">
    <div class="panel">
      <h3>平均比率</h3>
      <div id="ratioBar" style="width:100%;height:300px;"></div>
      <div class="notice">指标：访客到加购、加购到支付、访客比。</div>
    </div>
    <div class="panel">
      <h3>Top6 加购商品</h3>
      <div id="topBar" style="width:100%;height:320px;"></div>
      <div id="topBarLinks" class="legend-list" style="margin-top:6px;"></div>
    </div>
  </div>
</section>

      </div>
    </div>
  </main>
</div>

<script>
(function(){
  document.querySelectorAll('.has-submenu > a').forEach(a => {
    a.addEventListener('click', function(e){
      const li = this.parentElement;
      const sub = li.querySelector('.submenu');
      if (!sub) return;
      e.preventDefault();
      li.classList.toggle('open');
    });
  });

  const state = { granularity: 'week', table: null, uploading: false };

  $('input[name="gran"]').on('change', function(){
    state.granularity = this.value;
    loadPeriods().then(loadData);
  });

  $('#file').on('change', async function(e){
    const file = e.target.files[0];
    if (!file) return;
    await autoUpload(file);
    e.target.value = '';
  });

  async function autoUpload(file){
    if (state.uploading) return;
    state.uploading = true;
    setStatus('上传中…'); togglePick(true);
    try {
      const fd = new FormData();
      fd.append('file', file, file.name);
      fd.append('filename', file.name); // 可选：后端也能拿到
      const r = await fetch('/api/ingest', { method:'POST', body: fd });
      const j = await r.json();
      if (!j.ok) throw new Error((j.step?('[步骤 '+j.step+'] '):'') + (j.msg || '导入失败'));
      setStatus('已入库：' + j.type + ' ' + j.date + '（' + j.rows + ' 行）');
      await loadPeriods(); await loadData();
    } catch(err){
      alert(err.message);
      setStatus('上传失败：' + err.message);
    } finally {
      togglePick(false); setTimeout(()=> setStatus(''), 5000); state.uploading = false;
    }
  }
  function togglePick(disabled){ $('#pickLabel').css({ opacity: disabled?.6:1, pointerEvents: disabled?'none':'auto' }).text(disabled?'上传中…':'选择文件'); }
  function setStatus(t){ $('#status').text(t||''); }

  async function loadPeriods(){
    const r = await fetch('/api/periods'); const j = await r.json();
    const list = (state.granularity==='week' ? j.weeks : j.months) || [];
    state.periods = list.slice();
    const $sel = $('#periodSelect').empty();
    if (!list.length){ $sel.append('<option value="">暂无数据</option>'); return; }
    list.forEach(d=> $sel.append('<option value="'+d+'">'+d+'</option>'));
  }

  $('#periodSelect').on('change', loadData);

  
  async function loadData(){
    const period = $('#periodSelect').val();
    const qsA = new URLSearchParams({ granularity: state.granularity });
    if (period) qsA.set('period_end', period);

    // Determine previous period by index in state.periods
    let prev = '';
    if (state.periods && period){
      const idx = state.periods.indexOf(period);
      if (idx > 0) prev = state.periods[idx-1];
    }
    const qsB = new URLSearchParams({ granularity: state.granularity });
    if (prev) qsB.set('period_end', prev);

    // Fetch current (A) and previous (B) in parallel (B optional)
    const [ra, rb] = await Promise.all([ fetch('/api/stats?'+qsA.toString()), prev? fetch('/api/stats?'+qsB.toString()) : Promise.resolve(null) ]);
    const ja = await ra.json();
    const jb = rb ? await rb.json() : { ok:true, rows:[] };
    if (!ja.ok){ alert(ja.msg||'查询失败'); return; }

    window._rowsA = (ja.rows||[]);
    window._rowsB = (jb.rows||[]);
    window._periodA = period || '';
    window._periodB = prev || '';

    // table uses current period A
    const rows = window._rowsA.map(x => [
      (x.product_link ? '<a href="'+x.product_link+'" target="_blank">'+(x.product_id||'')+'</a>' : (x.product_id||'')),
      
      x.search_exposure || 0, x.uv || 0, x.pv || 0,
      x.add_to_cart_users || 0, x.add_to_cart_qty || 0,
      x.pay_items || 0, x.pay_orders || 0, x.pay_buyers || 0,
      (x.uv ? ((x.add_to_cart_users||0)/x.uv*100).toFixed(2) : '0.00'),
      (x.add_to_cart_users ? ((x.pay_buyers||0)/x.add_to_cart_users*100).toFixed(2) : '0.00'),
     (x.search_exposure ? ((x.uv||0)/x.search_exposure*100).toFixed(2) : '0.00')

    ]);
    if (state.table) state.table.clear().rows.add(rows).draw();
    else state.table = $('#report').DataTable({ data: rows, paging:true, searching:true, info:true, order:[[2,'desc']], fixedHeader:true, scrollY:'60vh', scrollCollapse:true, autoWidth:false });
    renderAnalysis(window._rowsA, window._rowsB);
  }

  function card(title, val){ return '<div class="stat-card"><h4>'+title+'</h4><p>'+val+'</p></div>'; }
  function renderKPI(k){
    $('#kpi').html([
      card('平均访客到加购转化率', (k.avg_visit_to_atc||0)+'%'),
      card('平均加购到支付转化率', (k.avg_atc_to_pay||0)+'%'),
      card('平均访客比', (k.avg_visit_rate||0)+'%'),
      card('产品总数', k.product_count||0),
      card('有加购的产品数', k.atc_product_count||0),
      card('有支付的产品数', k.pay_product_count||0)
    ].join(''));
  }

  loadPeriods().then(loadData);
})();

  // ---- Tabs switch ----
  $(document).on('click', '.tabs .tab', function(){
    $('.tabs .tab').removeClass('active');
    $(this).addClass('active');
    const tab = $(this).data('tab');
    $('#detail, #analysis').hide();
    $('#'+tab).show();
    setTimeout(()=>{ if(tab==='analysis'){ ratioChart && ratioChart.resize(); topChart && topChart.resize(); }}, 30);
  });

  // ---- Analysis charts ----
  let ratioChart=null, topChart=null;
  function renderAnalysis(rows){
    if (!Array.isArray(rows)) rows=[];
    const sum = rows.reduce((acc,x)=>{
      acc.exposure += Number(x.search_exposure||0);
      acc.uv += Number(x.uv||0);
      acc.pv += Number(x.pv||0);
      acc.atc_users += Number(x.add_to_cart_users||0);
      acc.atc_qty += Number(x.add_to_cart_qty||0);
      acc.pay_buyers += Number(x.pay_buyers||0);
      acc.pay_orders += Number(x.pay_orders||0);
      return acc;
    }, {exposure:0,uv:0,pv:0,atc_users:0,atc_qty:0,pay_buyers:0,pay_orders:0});

    const visitToAtc = sum.uv ? (sum.atc_users/sum.uv*100) : 0;
    const atcToPay = sum.atc_users ? (sum.pay_buyers/sum.atc_users*100) : 0;
    const visitRate = sum.exposure ? (sum.uv/sum.exposure*100) : 0;

    // Ratio bar
    ratioChart = ratioChart || echarts.init(document.getElementById('ratioBar'));
    ratioChart.setOption({
      tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},
      grid:{left:8,right:16,top:20,bottom:30,containLabel:true},
      xAxis:{type:'category',data:['访客到加购','加购到支付','访客比']},
      yAxis:{type:'value',axisLabel:{formatter:'{value}%'}},
      series:[{type:'bar',data:[visitToAtc.toFixed(2), atcToPay.toFixed(2), visitRate.toFixed(2)]}]
    });

    // Top6 by add_to_cart_users
    const top = rows.slice().sort((a,b)=> (b.add_to_cart_users||0)-(a.add_to_cart_users||0)).slice(0,6);
    const names = top.map(x=> x.product_id || '');
    const vals = top.map(x=> Number(x.add_to_cart_users||0));
    topChart = topChart || echarts.init(document.getElementById('topBar'));
    topChart.setOption({
      tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},
      grid:{left:8,right:16,top:20,bottom:30,containLabel:true},
      xAxis:{type:'value'},
      yAxis:{type:'category',data:names},
      series:[{type:'bar',data:vals}]
    });
    // links
    const linksHtml = top.map(x => {
      const link = x.product_link || '';
      const id = x.product_id || '';
      return link ? '<a href="'+link+'" target="_blank">'+id+'</a>' : '<span>'+id+'</span>';
    }).join(' | ');
    $('#topBarLinks').html(linksHtml);
  }
</script>

</body>
</html>
