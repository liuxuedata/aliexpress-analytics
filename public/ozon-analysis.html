<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ozon 运营分析</title>
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250811-single">
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script>const t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);</script>
  <style>.kpi-row{display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:12px}</style>
</head>
<body class="fm">
<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> 跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="#">速卖通</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon"><a href="amazon-overview.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon active"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="#">独立站</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header">
      <div class="site-title">
        <span>Ozon</span>
      </div>
    </div>
    <ul class="sub-nav">
      <li><a href="ozon-detail.html">数据明细</a></li>
      <li><a href="ozon-analysis.html" class="active">运营分析</a></li>
      <li><a href="ozon-product-insights.html">产品分析</a></li>
    </ul>
  </nav>
  <main class="main">
    <div class="content">
      <section class="content-pad">
        <div class="kpi-row"><div class="stat-card"><h4>产品总数</h4><p id="prodTotal">--</p></div></div>
        <div class="grid grid-2">
          <div class="panel"><h3>总展示数</h3><div id="expChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>详情页访客数</h3><div id="uvChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>加购次数</h3><div id="cartChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>订购商品数</h3><div id="orderChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>有曝光商品数</h3><div id="expProdChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>有加购商品数</h3><div id="cartProdChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>有支付商品数</h3><div id="payProdChart" style="width:100%;height:260px;"></div></div>
        </div>
      </section>
    </div>
  </main>
</div>
<script src="assets/site-nav.js"></script>
<script>
(function(){
  const storeId='demo';

  function startOfWeek(date){
    const d=new Date(date);
    const day=d.getDay();
    const diff=(day===0?-6:1-day);
    d.setDate(d.getDate()+diff);
    return d;
  }
  function addDays(date,n){const d=new Date(date);d.setDate(d.getDate()+n);return d;}
  function formatMD(iso){const d=new Date(iso);return (d.getMonth()+1)+'/'+d.getDate();}

  async function fetchRange(start,end){
    const url=`/api/ozon/stats?store_id=${encodeURIComponent(storeId)}&start=${start}&end=${end}`;
    const r=await fetch(url);const j=await r.json();
    if(!j.ok) throw new Error(j.msg||'fetch failed');
    return j.rows||[];
  }

  function sum(rows){
    const expSet=new Set(),cartSet=new Set(),paySet=new Set();
    let exposure=0,uv=0,cart=0,pay=0;
    rows.forEach(r=>{
      const e=Number(r.voronka_prodazh_pokazy_vsego)||0;exposure+=e;if(e>0)expSet.add(r.product_id||r.sku+'@@'+(r.model||''));
      const u=Number(r.voronka_prodazh_uv_s_prosmotrom_kartochki_tovara)||0;uv+=u;
      const c=Number(r.voronka_prodazh_dobavleniya_v_korzinu_vsego)||0;cart+=c;if(c>0)cartSet.add(r.product_id||r.sku+'@@'+(r.model||''));
      const p=Number(r.voronka_prodazh_zakazano_tovarov)||0;pay+=p;if(p>0)paySet.add(r.product_id||r.sku+'@@'+(r.model||''));
    });
    return {exposure,uv,cart,pay,expProds:expSet.size,cartProds:cartSet.size,payProds:paySet.size};
  }

  async function loadProdTotal(){
    try{
      const today=new Date().toISOString().slice(0,10);
      const url=`/api/ozon/kpi?store_id=${encodeURIComponent(storeId)}&start=2000-01-01&end=${today}`;
      const r=await fetch(url);const j=await r.json();
      const val=j.metrics?.product_total?.current||0;
      document.getElementById('prodTotal').textContent=val;
    }catch(e){
      console.error(e);
      document.getElementById('prodTotal').textContent='0';
    }
  }

  async function loadData(){
    const today=new Date();
    const weekStart=startOfWeek(today);
    const start=startOfWeek(addDays(weekStart,-7*7));
    const weeks=[];
    for(let i=0;i<8;i++){
      const ws=addDays(start,i*7);
      const we=addDays(ws,6);
      weeks.push({
        label:`${formatMD(ws.toISOString().slice(0,10))}~${formatMD(we.toISOString().slice(0,10))}`,
        start:ws.toISOString().slice(0,10),
        end:we.toISOString().slice(0,10)
      });
    }
    const stats=await Promise.all(weeks.map(w=>fetchRange(w.start,w.end).then(sum)));
    const labels=weeks.map(w=>w.label);
    renderBar('expChart',labels,stats.map(s=>s.exposure));
    renderBar('uvChart',labels,stats.map(s=>s.uv));
    renderBar('cartChart',labels,stats.map(s=>s.cart));
    renderBar('orderChart',labels,stats.map(s=>s.pay));
    renderBar('expProdChart',labels,stats.map(s=>s.expProds));
    renderBar('cartProdChart',labels,stats.map(s=>s.cartProds));
    renderBar('payProdChart',labels,stats.map(s=>s.payProds));
  }

  function renderBar(id,labels,data){
    const chart=echarts.init(document.getElementById(id));
    chart.setOption({
      tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},
      xAxis:{type:'category',data:labels},
      yAxis:{type:'value'},
      series:[{type:'bar',data,label:{show:true,position:'top'}}]
    });
    window.addEventListener('resize',()=>chart.resize());
  }

  loadProdTotal();
  loadData();
})();
</script>
</body>
</html>
