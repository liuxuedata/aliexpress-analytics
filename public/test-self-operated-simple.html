<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªè¿è¥é¡µé¢æµ‹è¯• - ç®€åŒ–ç‰ˆ</title>
    
    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .kpi-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin: 8px 0;
        }

        .kpi-label {
            color: #666;
            font-size: 0.8em;
        }

        .kpi-comparison {
            margin-top: 8px;
            font-size: 0.7em;
        }

        @media (max-width: 600px) {
            .kpi-card {
                padding: 10px;
            }
            .kpi-value {
                font-size: 1.25em;
            }
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .date-filter {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .debug-info {
            background: #e2e3e5;
            color: #383d41;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ è‡ªè¿è¥é¡µé¢æµ‹è¯• - ç®€åŒ–ç‰ˆ</h1>
            <p>å®Œå…¨ç‹¬ç«‹çš„æµ‹è¯•ç¯å¢ƒï¼Œç”¨äºæ’æŸ¥æ•°æ®åŠ è½½å’Œæ˜¾ç¤ºé—®é¢˜</p>
        </div>
        
        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="debug-info">
            <strong>è°ƒè¯•ä¿¡æ¯:</strong>
            <div id="debugInfo">é¡µé¢åŠ è½½ä¸­...</div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <h3>ğŸ“Š æ§åˆ¶é¢æ¿</h3>
            <input type="text" id="dateFilter" class="date-filter" placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´" readonly>
            <button id="loadDataBtn" class="btn btn-primary">åŠ è½½æ•°æ®</button>
            <button id="clearDataBtn" class="btn btn-primary">æ¸…ç©ºæ•°æ®</button>
            <button id="testApiBtn" class="btn btn-primary">æµ‹è¯•API</button>
        </div>
        
        <!-- KPIå¡ç‰‡ -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">å¹³å‡è®¿å®¢æ¯”</div>
                <div class="kpi-value" id="avgVisitor">-</div>
                <div class="kpi-comparison" id="avgVisitorComparison"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">å¹³å‡åŠ è´­æ¯”</div>
                <div class="kpi-value" id="avgCart">-</div>
                <div class="kpi-comparison" id="avgCartComparison"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">å¹³å‡æ”¯ä»˜æ¯”</div>
                <div class="kpi-value" id="avgPay">-</div>
                <div class="kpi-comparison" id="avgPayComparison"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">å•†å“æ€»æ•°</div>
                <div class="kpi-value" id="totalProducts">-</div>
                <div class="kpi-comparison" id="totalProductsComparison"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">åŠ è´­å•†å“æ•°</div>
                <div class="kpi-value" id="cartedProducts">-</div>
                <div class="kpi-comparison" id="cartedProductsComparison"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">æ”¯ä»˜å•†å“æ•°</div>
                <div class="kpi-value" id="purchasedProducts">-</div>
                <div class="kpi-comparison" id="purchasedProductsComparison"></div>
            </div>
        </div>
        
        <!-- æ•°æ®è¡¨æ ¼ -->
        <div id="tableContainer">
            <h3>ğŸ“‹ æ•°æ®è¡¨æ ¼</h3>
            <div id="loadingState" class="loading" style="display: none;">
                <div>ğŸ”„ æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div>
            </div>
            <div id="errorState" class="error" style="display: none;"></div>
            <div id="successState" class="success" style="display: none;"></div>
            <table id="dataTable" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>å•†å“ID</th>
                        <th>å‘¨æœŸ</th>
                        <th>è®¿å®¢æ¯”(%)</th>
                        <th>åŠ è´­æ¯”(%)</th>
                        <th>æ”¯ä»˜æ¯”(%)</th>
                        <th>æ›å…‰é‡</th>
                        <th>è®¿å®¢æ•°</th>
                        <th>åŠ è´­äººæ•°</th>
                        <th>æ”¯ä»˜ä¹°å®¶æ•°</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- æ•°æ®è¡Œå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ===== å®Œå…¨ç‹¬ç«‹çš„æµ‹è¯•ä»£ç  =====
        
        class SimpleSelfOperatedTester {
            constructor() {
                this.dataTable = null;
                this.isLoading = false;
                this.currentData = null;
                this.comparisonData = null;
                
                this.init();
            }
            
            init() {
                console.log('ğŸš€ ç®€åŒ–ç‰ˆè‡ªè¿è¥æµ‹è¯•å™¨åˆå§‹åŒ–...');
                this.updateDebugInfo('æµ‹è¯•å™¨åˆå§‹åŒ–å®Œæˆ');
                this.bindEvents();
                this.initDatePicker();
            }
            
            updateDebugInfo(message) {
                const debugEl = document.getElementById('debugInfo');
                if (debugEl) {
                    const timestamp = new Date().toLocaleTimeString();
                    debugEl.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                    // ä¿æŒæœ€æ–°çš„10æ¡è®°å½•
                    const lines = debugEl.innerHTML.split('<div>');
                    if (lines.length > 11) {
                        debugEl.innerHTML = lines.slice(-10).join('<div>');
                    }
                }
            }
            
            bindEvents() {
                // åŠ è½½æ•°æ®æŒ‰é’®
                document.getElementById('loadDataBtn').addEventListener('click', () => {
                    this.loadData();
                });
                
                // æ¸…ç©ºæ•°æ®æŒ‰é’®
                document.getElementById('clearDataBtn').addEventListener('click', () => {
                    this.clearData();
                });
                
                // æµ‹è¯•APIæŒ‰é’®
                document.getElementById('testApiBtn').addEventListener('click', () => {
                    this.testApi();
                });
            }
            
            initDatePicker() {
                const dateFilter = document.getElementById('dateFilter');
                if (dateFilter) {
                    const today = new Date();
                    const end = today.toISOString().slice(0, 10);
                    const start = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
                    dateFilter.value = `${start} to ${end}`;
                    this.updateDebugInfo(`æ—¥æœŸé€‰æ‹©å™¨åˆå§‹åŒ–: ${start} åˆ° ${end}`);
                }
            }
            
            async loadData() {
                if (this.isLoading) {
                    this.updateDebugInfo('âš ï¸ æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
                    return;
                }
                
                try {
                    this.isLoading = true;
                    this.showLoading();
                    this.updateDebugInfo('ğŸ”„ å¼€å§‹åŠ è½½æ•°æ®...');
                    
                    // è·å–æ—¥æœŸèŒƒå›´
                    const dateRange = this.getDateRange();
                    if (!dateRange) {
                        throw new Error('æ— æ³•è·å–æ—¥æœŸèŒƒå›´');
                    }
                    
                    this.updateDebugInfo(`ğŸ“… æ—¥æœŸèŒƒå›´: ${dateRange.start} åˆ° ${dateRange.end}`);
                    
                    // å¹¶è¡ŒåŠ è½½å½“å‰æ•°æ®å’Œå¯¹æ¯”æ•°æ®
                    const [currentData, comparisonData] = await Promise.all([
                        this.fetchData(dateRange.start, dateRange.end),
                        this.fetchComparisonData(dateRange)
                    ]);
                    
                    this.currentData = currentData;
                    this.comparisonData = comparisonData;
                    
                    this.updateDebugInfo(`âœ… æ•°æ®åŠ è½½å®Œæˆ: å½“å‰${currentData.length}æ¡, å¯¹æ¯”${comparisonData.length}æ¡`);
                    
                    // è®¡ç®—å’Œæ˜¾ç¤ºKPI
                    this.calculateAndDisplayKPIs(currentData, comparisonData);
                    
                    // æ¸²æŸ“è¡¨æ ¼
                    this.renderTable(currentData);
                    
                    this.showSuccess(`æ•°æ®åŠ è½½æˆåŠŸï¼å…±${currentData.length}æ¡è®°å½•`);
                    
                } catch (error) {
                    console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                    this.updateDebugInfo(`âŒ æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
                    this.showError(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
                } finally {
                    this.isLoading = false;
                    this.hideLoading();
                }
            }
            
            getDateRange() {
                const dateFilter = document.getElementById('dateFilter');
                if (!dateFilter || !dateFilter.value) {
                    // ä½¿ç”¨é»˜è®¤æ—¥æœŸ
                    const today = new Date();
                    const end = today.toISOString().slice(0, 10);
                    const start = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
                    return { start, end };
                }
                
                const value = dateFilter.value;
                if (value.includes(' to ')) {
                    const [start, end] = value.split(' to ');
                    return { start: start.trim(), end: end.trim() };
                }
                
                return null;
            }
            
            async fetchData(start, end) {
                const params = new URLSearchParams({
                    start: start,
                    end: end,
                    granularity: 'day',
                    site: 'ae_self_operated_a',
                    aggregate: 'product'
                });
                
                const url = `/api/ae_query?${params.toString()}`;
                this.updateDebugInfo(`ğŸŒ è¯·æ±‚URL: ${url}`);
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (!data.ok) {
                    throw new Error(data.msg || 'APIè¯·æ±‚å¤±è´¥');
                }
                
                const rows = data.rows || [];
                this.updateDebugInfo(`ğŸ“Š APIå“åº”: ${rows.length}æ¡è®°å½•`);
                
                return rows;
            }
            
            async fetchComparisonData(dateRange) {
                try {
                    const prevStart = new Date(dateRange.start);
                    prevStart.setDate(prevStart.getDate() - 30);
                    const prevEnd = new Date(dateRange.start);
                    prevEnd.setDate(prevEnd.getDate() - 1);
                    
                    const prevData = await this.fetchData(
                        prevStart.toISOString().slice(0, 10),
                        prevEnd.toISOString().slice(0, 10)
                    );
                    
                    this.updateDebugInfo(`ğŸ“ˆ å¯¹æ¯”æ•°æ®: ${prevData.length}æ¡è®°å½•`);
                    return prevData;
                } catch (error) {
                    this.updateDebugInfo(`âš ï¸ å¯¹æ¯”æ•°æ®è·å–å¤±è´¥: ${error.message}`);
                    return [];
                }
            }
            
            calculateAndDisplayKPIs(currentData, comparisonData) {
                if (!currentData || currentData.length === 0) return;
                
                this.updateDebugInfo('ğŸ§® å¼€å§‹è®¡ç®—KPI...');
                
                // è®¡ç®—å½“å‰å‘¨æœŸKPI
                const currentKPIs = this.calculateKPIs(currentData);
                
                // è®¡ç®—å¯¹æ¯”å‘¨æœŸKPI
                const comparisonKPIs = comparisonData && comparisonData.length > 0 ? 
                    this.calculateKPIs(comparisonData) : null;
                
                // è®¡ç®—å˜åŒ–
                const changes = comparisonKPIs ? this.calculateChanges(currentKPIs, comparisonKPIs) : null;
                
                // æ˜¾ç¤ºKPI
                this.displayKPIs(currentKPIs, changes);
                
                this.updateDebugInfo('âœ… KPIè®¡ç®—å®Œæˆ');
            }
            
            calculateKPIs(data) {
                let totalVisitorRatio = 0;
                let totalCartRatio = 0;
                let totalPayRatio = 0;
                let cartedProducts = 0;
                let purchasedProducts = 0;
                
                data.forEach((row, index) => {
                    // è°ƒè¯•å‰3è¡Œæ•°æ®
                    if (index < 3) {
                        this.updateDebugInfo(`è¡Œ${index + 1}æ•°æ®: è®¿å®¢æ¯”=${row.visitor_ratio}, åŠ è´­æ¯”=${row.add_to_cart_ratio}, æ”¯ä»˜æ¯”=${row.payment_ratio}`);
                    }
                    
                    const visitorRatio = parseFloat(row.visitor_ratio) || 0;
                    const cartRatio = parseFloat(row.add_to_cart_ratio) || 0;
                    const payRatio = parseFloat(row.payment_ratio) || 0;
                    
                    totalVisitorRatio += visitorRatio;
                    totalCartRatio += cartRatio;
                    totalPayRatio += payRatio;
                    
                    if (row.cart_users && row.cart_users > 0) cartedProducts++;
                    if (row.pay_buyers && row.pay_buyers > 0) purchasedProducts++;
                });
                
                const total = data.length;
                return {
                    avgVisitorRatio: total > 0 ? totalVisitorRatio / total : 0,
                    avgCartRatio: total > 0 ? totalCartRatio / total : 0,
                    avgPayRatio: total > 0 ? totalPayRatio / total : 0,
                    totalProducts: total,
                    cartedProducts: cartedProducts,
                    purchasedProducts: purchasedProducts
                };
            }
            
            calculateChanges(current, previous) {
                return {
                    avgVisitorRatio: this.calculatePercentageChange(current.avgVisitorRatio, previous.avgVisitorRatio),
                    avgCartRatio: this.calculatePercentageChange(current.avgCartRatio, previous.avgCartRatio),
                    avgPayRatio: this.calculatePercentageChange(current.avgPayRatio, previous.avgPayRatio),
                    totalProducts: current.totalProducts - previous.totalProducts,
                    cartedProducts: current.cartedProducts - previous.cartedProducts,
                    purchasedProducts: current.purchasedProducts - previous.purchasedProducts
                };
            }
            
            calculatePercentageChange(current, previous) {
                if (previous === 0) return current > 0 ? 100 : 0;
                return ((current - previous) / previous) * 100;
            }
            
            displayKPIs(kpis, changes) {
                // æ›´æ–°ä¸»è¦KPIå€¼
                this.updateKPI('avgVisitor', this.formatPercentage(kpis.avgVisitorRatio));
                this.updateKPI('avgCart', this.formatPercentage(kpis.avgCartRatio));
                this.updateKPI('avgPay', this.formatPercentage(kpis.avgPayRatio));
                this.updateKPI('totalProducts', kpis.totalProducts);
                this.updateKPI('cartedProducts', kpis.cartedProducts);
                this.updateKPI('purchasedProducts', kpis.purchasedProducts);
                
                // æ˜¾ç¤ºå¯¹æ¯”å˜åŒ–
                if (changes) {
                    this.updateComparison('avgVisitor', changes.avgVisitorRatio);
                    this.updateComparison('avgCart', changes.avgCartRatio);
                    this.updateComparison('avgPay', changes.avgPayRatio);
                    this.updateComparison('totalProducts', changes.totalProducts);
                    this.updateComparison('cartedProducts', changes.cartedProducts);
                    this.updateComparison('purchasedProducts', changes.purchasedProducts);
                }
            }
            
            updateKPI(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            }
            
            updateComparison(id, change) {
                const element = document.getElementById(id + 'Comparison');
                if (element && change !== undefined) {
                    const arrow = change > 0 ? 'â†‘' : change < 0 ? 'â†“' : 'â†’';
                    const color = change > 0 ? 'green' : change < 0 ? 'red' : 'gray';
                    const changeText = typeof change === 'number' && change !== 0 ? 
                        (change > 0 ? `+${change.toFixed(2)}` : change.toFixed(2)) : change;
                    
                    element.innerHTML = `<span style="color: ${color};">${arrow} ${changeText}</span>`;
                }
            }
            
            renderTable(data) {
                if (!data || data.length === 0) return;
                
                this.updateDebugInfo(`ğŸ“‹ å¼€å§‹æ¸²æŸ“è¡¨æ ¼ï¼Œæ•°æ®é‡: ${data.length}`);
                
                // é”€æ¯ç°æœ‰DataTable
                if (this.dataTable) {
                    this.dataTable.destroy();
                    this.dataTable = null;
                }
                
                // æ¸…ç©ºè¡¨æ ¼å†…å®¹
                const tbody = document.querySelector('#dataTable tbody');
                tbody.innerHTML = '';
                
                // æ·»åŠ æ•°æ®è¡Œ
                data.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.product_id || '-'}</td>
                        <td>${row.bucket || '-'}</td>
                        <td>${this.formatPercentage(row.visitor_ratio)}</td>
                        <td>${this.formatPercentage(row.add_to_cart_ratio)}</td>
                        <td>${this.formatPercentage(row.payment_ratio)}</td>
                        <td>${this.formatNumber(row.exposure)}</td>
                        <td>${this.formatNumber(row.visitors)}</td>
                        <td>${this.formatNumber(row.cart_users)}</td>
                        <td>${this.formatNumber(row.pay_buyers)}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // åˆå§‹åŒ–DataTable
                this.dataTable = $('#dataTable').DataTable({
                    pageLength: 10,
                    order: [[1, 'desc']],
                    scrollX: true,
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/zh.json'
                    }
                });
                
                this.updateDebugInfo('âœ… è¡¨æ ¼æ¸²æŸ“å®Œæˆ');
            }
            
            formatPercentage(num) {
                if (num === null || num === undefined) return '0%';
                let n = Number(num);
                if (isNaN(n)) return '0%';
                if (n <= 1) n *= 100;
                return n.toFixed(2) + '%';
            }
            
            formatNumber(num) {
                if (num === null || num === undefined) return '0';
                const n = Number(num);
                if (isNaN(n)) return '0';
                return n.toLocaleString();
            }
            
            clearData() {
                this.currentData = null;
                this.comparisonData = null;
                
                // æ¸…ç©ºKPI
                ['avgVisitor', 'avgCart', 'avgPay', 'totalProducts', 'cartedProducts', 'purchasedProducts'].forEach(id => {
                    this.updateKPI(id, '-');
                    this.updateComparison(id, null);
                });
                
                // æ¸…ç©ºè¡¨æ ¼
                if (this.dataTable) {
                    this.dataTable.destroy();
                    this.dataTable = null;
                }
                
                const tbody = document.querySelector('#dataTable tbody');
                tbody.innerHTML = '';
                
                this.updateDebugInfo('ğŸ—‘ï¸ æ•°æ®å·²æ¸…ç©º');
                this.hideAllStates();
            }
            
            async testApi() {
                this.updateDebugInfo('ğŸ§ª å¼€å§‹æµ‹è¯•APIè¿æ¥...');
                
                try {
                    const response = await fetch('/api/ae_query?start=2025-08-01&end=2025-08-31&granularity=day&site=ae_self_operated_a&aggregate=product');
                    const data = await response.json();
                    
                    if (data.ok) {
                        this.updateDebugInfo(`âœ… APIæµ‹è¯•æˆåŠŸ: ${data.rows ? data.rows.length : 0}æ¡è®°å½•`);
                    } else {
                        this.updateDebugInfo(`âš ï¸ APIå“åº”å¼‚å¸¸: ${data.msg || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                } catch (error) {
                    this.updateDebugInfo(`âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            }
            
            showLoading() {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('successState').style.display = 'none';
            }
            
            hideLoading() {
                document.getElementById('loadingState').style.display = 'none';
            }
            
            showError(message) {
                const errorEl = document.getElementById('errorState');
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                document.getElementById('successState').style.display = 'none';
            }
            
            showSuccess(message) {
                const successEl = document.getElementById('successState');
                successEl.textContent = message;
                successEl.style.display = 'block';
                document.getElementById('errorState').style.display = 'none';
            }
            
            hideAllStates() {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('successState').style.display = 'none';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æµ‹è¯•å™¨
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æµ‹è¯•å™¨...');
            window.tester = new SimpleSelfOperatedTester();
        });
    </script>
</body>
</html>
