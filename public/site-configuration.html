<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç«™ç‚¹é…ç½® Â· è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/login.css">
     <link rel="stylesheet" href="assets/theme.css?v=20250810c">
  <style>
    .site-configuration {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .config-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }
    .config-section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .config-section h3 {
      margin: 0 0 20px 0;
      color: #1f2937;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 10px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .btn {
      padding: 12px 24px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn:hover {
      background: #f9fafb;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    .btn-success {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    .btn-success:hover {
      background: #059669;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .site-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
    }
    .site-item {
      padding: 15px;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .site-item:last-child {
      border-bottom: none;
    }
    .site-info h4 {
      margin: 0 0 5px 0;
      color: #1f2937;
    }
    .site-info .platform {
      color: #6b7280;
      font-size: 12px;
    }
    .site-info .data-source {
      color: #059669;
      font-size: 12px;
      font-weight: 500;
    }
    .template-preview {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .status-message {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 500;
    }
    .status-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .status-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .status-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .file-upload {
      border: 2px dashed #d1d5db;
      border-radius: 6px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .file-upload:hover {
      border-color: #3b82f6;
    }
    .file-upload.dragover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
         .hidden {
       display: none;
     }
     .progress-bar {
       width: 100%;
       height: 4px;
       background-color: #e5e7eb;
       border-radius: 2px;
       overflow: hidden;
       margin: 10px 0;
     }
     .progress-fill {
       height: 100%;
       background-color: #3b82f6;
       width: 0%;
       transition: width 0.3s ease;
       animation: progress-animation 2s infinite;
     }
     @keyframes progress-animation {
       0% { width: 0%; }
       50% { width: 70%; }
       100% { width: 100%; }
     }
     .status-message {
       padding: 10px;
       border-radius: 6px;
       margin: 10px 0;
       font-weight: 500;
       position: relative;
     }
     .status-message.with-progress {
       padding-bottom: 20px;
     }
  </style>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <h2>ç™»å½•</h2>
    <form id="loginForm">
      <div class="form-group">
        <input type="text" id="username" placeholder="ç”¨æˆ·å" required>
      </div>
      <div class="form-group">
        <input type="password" id="password" placeholder="å¯†ç " required>
      </div>
      <button type="submit" class="btn btn-primary">ç™»å½•</button>
    </form>
  </div>
</div>

<div class="site-configuration">
  <h1>ç«™ç‚¹é…ç½®ç®¡ç†</h1>
  <p>é…ç½®å’Œç®¡ç†å¤šç«™ç‚¹æ•°æ®æºï¼Œæ”¯æŒè‡ªåŠ¨ç”Ÿæˆæ•°æ®è¡¨å’ŒAPIæ¥å£</p>

  <div class="config-grid">
    <!-- å·¦ä¾§ï¼šç«™ç‚¹é…ç½® -->
    <div class="config-section">
      <h3>ğŸ“Š ç«™ç‚¹é…ç½®</h3>
      
      <form id="siteConfigForm">
        <div class="form-row">
          <div class="form-group">
            <label for="siteName">ç«™ç‚¹åç§° *</label>
            <input type="text" id="siteName" required placeholder="å¦‚ï¼šicyberite.com">
          </div>
          <div class="form-group">
            <label for="sitePlatform">å¹³å°ç±»å‹ *</label>
            <select id="sitePlatform" required>
              <option value="">é€‰æ‹©å¹³å°</option>
              <option value="ae_self_operated">é€Ÿå–é€šè‡ªè¿è¥</option>
              <option value="ae_managed">é€Ÿå–é€šå…¨æ‰˜ç®¡</option>
              <option value="independent">ç‹¬ç«‹ç«™</option>
              <option value="amazon">äºšé©¬é€Š</option>
              <option value="ebay">eBay</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="displayName">æ˜¾ç¤ºåç§° *</label>
            <input type="text" id="displayName" required placeholder="å¦‚ï¼šç‹¬ç«‹ç«™ icyberite.com">
          </div>
          <div class="form-group">
            <label for="domain">åŸŸå</label>
            <input type="text" id="domain" placeholder="å¦‚ï¼šicyberite.com">
          </div>
        </div>
        
        <div class="form-group">
          <label for="dataSource">æ•°æ®æºç±»å‹ *</label>
          <select id="dataSource" required>
            <option value="">é€‰æ‹©æ•°æ®æº</option>
            <option value="ae_api">é€Ÿå–é€šAPI</option>
            <option value="google_ads">Google Ads</option>
            <option value="facebook_ads">Facebook Ads</option>
            <option value="tiktok_ads">TikTok Ads</option>
            <option value="custom">è‡ªå®šä¹‰</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="templateId">æ•°æ®æ¨¡æ¿</label>
          <select id="templateId">
            <option value="">è‡ªåŠ¨é€‰æ‹©</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="configJson">é…ç½®ä¿¡æ¯ (JSON)</label>
          <textarea id="configJson" rows="4" placeholder='{"api_key": "xxx", "custom_field": "value"}'></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary">åˆ›å»ºç«™ç‚¹</button>
        <button type="button" class="btn" onclick="resetForm()">é‡ç½®</button>
      </form>
    </div>

    <!-- å³ä¾§ï¼šç«™ç‚¹åˆ—è¡¨å’Œæ¨¡æ¿é¢„è§ˆ -->
    <div class="config-section">
      <h3>ğŸ¢ ç°æœ‰ç«™ç‚¹</h3>
      
      <div class="site-list" id="siteList">
        <div class="site-item">
          <div class="site-info">
            <h4>é€Ÿå–é€šè‡ªè¿è¥ Aç«™</h4>
            <div class="platform">å¹³å°ï¼šé€Ÿå–é€šè‡ªè¿è¥</div>
            <div class="data-source">æ•°æ®æºï¼šé€Ÿå–é€šAPI</div>
          </div>
          <div>
            <button class="btn btn-success" onclick="editSite('ae_self_operated_a')">ç¼–è¾‘</button>
            <button class="btn btn-danger" onclick="deleteSite('ae_self_operated_a')">åˆ é™¤</button>
          </div>
        </div>
        <div class="site-item">
          <div class="site-info">
            <h4>ç‹¬ç«‹ç«™ poolsvacuum.com</h4>
            <div class="platform">å¹³å°ï¼šç‹¬ç«‹ç«™</div>
            <div class="data-source">æ•°æ®æºï¼šGoogle Ads</div>
          </div>
          <div>
            <button class="btn btn-success" onclick="editSite('independent_poolsvacuum')">ç¼–è¾‘</button>
            <button class="btn btn-danger" onclick="deleteSite('independent_poolsvacuum')">åˆ é™¤</button>
          </div>
        </div>
        <div class="site-item">
          <div class="site-info">
            <h4>ç‹¬ç«‹ç«™ icyberite.com</h4>
            <div class="platform">å¹³å°ï¼šç‹¬ç«‹ç«™</div>
            <div class="data-source">æ•°æ®æºï¼šFacebook Ads</div>
          </div>
          <div>
            <button class="btn btn-success" onclick="editSite('independent_icyberite')">ç¼–è¾‘</button>
            <button class="btn btn-danger" onclick="deleteSite('independent_icyberite')">åˆ é™¤</button>
          </div>
        </div>
      </div>
      
      <h3 style="margin-top: 30px;">ğŸ“‹ æ•°æ®æ¨¡æ¿é¢„è§ˆ</h3>
      <div class="template-preview" id="templatePreview">
        é€‰æ‹©æ•°æ®æºç±»å‹æŸ¥çœ‹æ¨¡æ¿é…ç½®...
      </div>
    </div>
  </div>

  <!-- æ•°æ®ä¸Šä¼ æµ‹è¯•åŒºåŸŸ -->
  <div class="config-section" style="margin-top: 30px;">
    <h3>ğŸ“¤ æ•°æ®ä¸Šä¼ æµ‹è¯•</h3>
    
    <div class="form-row">
      <div class="form-group">
        <label for="testSite">é€‰æ‹©ç«™ç‚¹</label>
        <select id="testSite">
          <option value="">é€‰æ‹©è¦æµ‹è¯•çš„ç«™ç‚¹</option>
        </select>
      </div>
      <div class="form-group">
        <label for="testFile">ä¸Šä¼ æ•°æ®æ–‡ä»¶</label>
        <div class="file-upload" id="fileUpload">
          <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
          <input type="file" id="testFile" accept=".xlsx,.csv" style="display: none;">
        </div>
      </div>
    </div>
    
         <button class="btn btn-primary" onclick="testDataUpload()">æµ‹è¯•æ•°æ®ä¸Šä¼ </button>
     <button class="btn" onclick="generateTestData()">ç”Ÿæˆæµ‹è¯•æ•°æ®</button>
     <button class="btn" onclick="testAPI()">æµ‹è¯•APIè¿æ¥</button>
  </div>

  <!-- çŠ¶æ€æ¶ˆæ¯ -->
  <div id="statusMessage"></div>
</div>

<script>
// å…¨å±€å˜é‡
let currentSites = [];
let currentTemplates = [];

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  loadSites();
  loadTemplates();
  setupEventListeners();
});

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
  // å¹³å°ç±»å‹å˜åŒ–æ—¶æ›´æ–°æ•°æ®æºé€‰é¡¹
  document.getElementById('sitePlatform').addEventListener('change', function() {
    updateDataSourceOptions();
  });
  
  // æ•°æ®æºå˜åŒ–æ—¶æ›´æ–°æ¨¡æ¿é€‰é¡¹
  document.getElementById('dataSource').addEventListener('change', function() {
    updateTemplateOptions();
    updateTemplatePreview();
  });
  
  // æ–‡ä»¶ä¸Šä¼ 
  const fileUpload = document.getElementById('fileUpload');
  const fileInput = document.getElementById('testFile');
  
  fileUpload.addEventListener('click', () => fileInput.click());
  fileUpload.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUpload.classList.add('dragover');
  });
  fileUpload.addEventListener('dragleave', () => {
    fileUpload.classList.remove('dragover');
  });
  fileUpload.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUpload.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      showStatus('æ–‡ä»¶å·²é€‰æ‹©ï¼š' + files[0].name, 'success');
    }
  });
  
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      const fileName = e.target.files[0].name;
      showStatus('æ–‡ä»¶å·²é€‰æ‹©ï¼š' + fileName, 'success');
      // æ˜¾ç¤ºæ–‡ä»¶å
      document.getElementById('fileUpload').innerHTML = `
        <p>å·²é€‰æ‹©æ–‡ä»¶ï¼š${fileName}</p>
        <p style="font-size: 12px; color: #6b7280;">ç‚¹å‡»é‡æ–°é€‰æ‹©æ–‡ä»¶</p>
      `;
    } else {
      // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–‡ä»¶ï¼Œé‡ç½®æ˜¾ç¤º
      document.getElementById('fileUpload').innerHTML = `
        <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
      `;
    }
  });
}

// åŠ è½½ç«™ç‚¹åˆ—è¡¨
async function loadSites() {
  try {
    showStatus('æ­£åœ¨åŠ è½½ç«™ç‚¹åˆ—è¡¨...', 'info');
    const response = await fetch('/api/site-configs');
    
    console.log('ç«™ç‚¹APIå“åº”çŠ¶æ€:', response.status);
    console.log('ç«™ç‚¹APIå“åº”å¤´:', response.headers);
    
    let data = null;
    try {
      data = await response.json();
      console.log('ç«™ç‚¹APIå“åº”æ•°æ®:', data);
    } catch (e) {
      console.error('ç«™ç‚¹API JSONè§£æå¤±è´¥:', e);
      showStatus('åŠ è½½ç«™ç‚¹å¤±è´¥: APIè¿”å›éJSONæ ¼å¼æ•°æ®', 'error');
      return;
    }
    
    if (response.ok) {
      currentSites = data.data || [];
      console.log('è®¾ç½®currentSites:', currentSites);
      renderSiteList();
      updateTestSiteOptions();
      showStatus(`æˆåŠŸåŠ è½½ ${currentSites.length} ä¸ªç«™ç‚¹`, 'success');
    } else {
      showStatus('åŠ è½½ç«™ç‚¹å¤±è´¥: ' + (data.error || data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
  } catch (error) {
    console.error('åŠ è½½ç«™ç‚¹å¤±è´¥:', error);
    showStatus('åŠ è½½ç«™ç‚¹å¤±è´¥: ' + error.message, 'error');
  }
}

// åŠ è½½æ¨¡æ¿åˆ—è¡¨
async function loadTemplates() {
  try {
    console.log('å¼€å§‹åŠ è½½æ¨¡æ¿åˆ—è¡¨...');
    const response = await fetch('/api/data-source-templates');
    
    console.log('æ¨¡æ¿APIå“åº”çŠ¶æ€:', response.status);
    const data = await response.json();
    console.log('æ¨¡æ¿APIå“åº”æ•°æ®:', data);
    
    if (response.ok) {
      currentTemplates = data.data || [];
      console.log('åŠ è½½çš„æ¨¡æ¿æ•°é‡:', currentTemplates.length);
      console.log('æ¨¡æ¿æ•°æ®:', currentTemplates);
    } else {
      console.error('æ¨¡æ¿åŠ è½½å¤±è´¥:', data.error || data.message);
    }
  } catch (error) {
    console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
  }
}

// æ¸²æŸ“ç«™ç‚¹åˆ—è¡¨
function renderSiteList() {
  const siteList = document.getElementById('siteList');
  siteList.innerHTML = '';
  
  console.log('æ¸²æŸ“ç«™ç‚¹åˆ—è¡¨ï¼Œç«™ç‚¹æ•°é‡:', currentSites.length);
  console.log('ç«™ç‚¹æ•°æ®:', currentSites);
  
  if (currentSites.length === 0) {
    siteList.innerHTML = '<div class="site-item"><div class="site-info"><p>æš‚æ— ç«™ç‚¹é…ç½®</p></div></div>';
    return;
  }
  
  currentSites.forEach(site => {
    const siteItem = document.createElement('div');
    siteItem.className = 'site-item';
    siteItem.innerHTML = `
      <div class="site-info">
        <h4>${site.display_name || site.name}</h4>
        <div class="platform">å¹³å°ï¼š${getPlatformDisplayName(site.platform)}</div>
        <div class="data-source">æ•°æ®æºï¼š${getDataSourceDisplayName(site.data_source)}</div>
      </div>
      <div>
        <button class="btn btn-success" onclick="editSite('${site.id}')">ç¼–è¾‘</button>
        <button class="btn btn-danger" onclick="deleteSite('${site.id}')">åˆ é™¤</button>
      </div>
    `;
    siteList.appendChild(siteItem);
  });
}

// æ›´æ–°æ•°æ®æºé€‰é¡¹
function updateDataSourceOptions() {
  const platform = document.getElementById('sitePlatform').value;
  const dataSource = document.getElementById('dataSource');
  
  // æ¸…ç©ºç°æœ‰é€‰é¡¹
  dataSource.innerHTML = '<option value="">é€‰æ‹©æ•°æ®æº</option>';
  
  if (platform === 'ae_self_operated' || platform === 'ae_managed') {
    dataSource.innerHTML += '<option value="ae_api">é€Ÿå–é€šAPI</option>';
  } else if (platform === 'independent') {
    dataSource.innerHTML += `
      <option value="google_ads">Google Ads</option>
      <option value="facebook_ads">Facebook Ads</option>
      <option value="tiktok_ads">TikTok Ads</option>
      <option value="custom">è‡ªå®šä¹‰</option>
    `;
  }
}

// æ›´æ–°æ¨¡æ¿é€‰é¡¹
function updateTemplateOptions() {
  const dataSource = document.getElementById('dataSource').value;
  const templateId = document.getElementById('templateId');
  
  // æ¸…ç©ºç°æœ‰é€‰é¡¹
  templateId.innerHTML = '<option value="">è‡ªåŠ¨é€‰æ‹©</option>';
  
  if (dataSource) {
    const templates = currentTemplates.filter(t => t.source_type === dataSource);
    templates.forEach(template => {
      templateId.innerHTML += `<option value="${template.id}">${template.name}</option>`;
    });
  }
}

// æ›´æ–°æ¨¡æ¿é¢„è§ˆ
function updateTemplatePreview() {
  const dataSource = document.getElementById('dataSource').value;
  const templatePreview = document.getElementById('templatePreview');
  
  console.log('æ›´æ–°æ¨¡æ¿é¢„è§ˆï¼Œæ•°æ®æº:', dataSource);
  console.log('å½“å‰æ¨¡æ¿åˆ—è¡¨:', currentTemplates);
  
  if (!dataSource) {
    templatePreview.textContent = 'é€‰æ‹©æ•°æ®æºç±»å‹æŸ¥çœ‹æ¨¡æ¿é…ç½®...';
    return;
  }
  
  const template = currentTemplates.find(t => t.source_type === dataSource);
  console.log('æ‰¾åˆ°çš„æ¨¡æ¿:', template);
  
  if (template) {
    templatePreview.innerHTML = `
      <strong>æ¨¡æ¿ï¼š${template.name}</strong><br>
      <strong>å­—æ®µæ˜ å°„ï¼š</strong><br>
      ${Object.entries(template.fields_json.mappings || {}).map(([key, value]) => 
        `  ${key} â†’ ${value}`
      ).join('<br>')}
    `;
  } else {
    templatePreview.textContent = `æœªæ‰¾åˆ°åŒ¹é…çš„æ¨¡æ¿é…ç½® (æ•°æ®æº: ${dataSource})`;
    console.log('æœªæ‰¾åˆ°æ¨¡æ¿ï¼Œå¯ç”¨çš„æ•°æ®æºç±»å‹:', currentTemplates.map(t => t.source_type));
  }
}

// å…¨å±€å˜é‡
let editingSiteId = null;

// è¡¨å•æäº¤
document.getElementById('siteConfigForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = {
    name: document.getElementById('siteName').value,
    platform: document.getElementById('sitePlatform').value,
    display_name: document.getElementById('displayName').value,
    domain: document.getElementById('domain').value || null,
    data_source: document.getElementById('dataSource').value,
    template_id: document.getElementById('templateId').value || null,
    config_json: document.getElementById('configJson').value ? 
      JSON.parse(document.getElementById('configJson').value) : null
  };
  
  try {
    const method = editingSiteId ? 'POST' : 'POST';
    const url = editingSiteId ? '/api/site-configs/update' : '/api/site-configs';
    const requestData = editingSiteId ? { siteId: editingSiteId, ...formData } : formData;
    
    showStatus(editingSiteId ? 'æ­£åœ¨æ›´æ–°ç«™ç‚¹...' : 'æ­£åœ¨åˆ›å»ºç«™ç‚¹...', 'info', true);
    
    console.log('å‘é€è¯·æ±‚:', { method, url, requestData });
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestData)
    });
    
    console.log('å“åº”çŠ¶æ€:', response.status);
    const result = await response.json();
    console.log('å“åº”æ•°æ®:', result);
    
    if (response.ok) {
      showStatus(editingSiteId ? 'ç«™ç‚¹æ›´æ–°æˆåŠŸï¼' : 'ç«™ç‚¹åˆ›å»ºæˆåŠŸï¼', 'success');
      console.log('æ“ä½œæˆåŠŸï¼Œå¼€å§‹åˆ·æ–°ç«™ç‚¹åˆ—è¡¨...');
      await loadSites(); // ç­‰å¾…åŠ è½½å®Œæˆ
      console.log('ç«™ç‚¹åˆ—è¡¨åˆ·æ–°å®Œæˆ');
      resetForm();
      editingSiteId = null;
    } else {
      showStatus((editingSiteId ? 'æ›´æ–°' : 'åˆ›å»º') + 'å¤±è´¥: ' + (result.error || result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
  } catch (error) {
    console.error('è¯·æ±‚é”™è¯¯:', error);
    showStatus((editingSiteId ? 'æ›´æ–°' : 'åˆ›å»º') + 'å¤±è´¥: ' + error.message, 'error');
  }
});

// ç¼–è¾‘ç«™ç‚¹
function editSite(siteId) {
  const site = currentSites.find(s => s.id === siteId);
  if (site) {
    editingSiteId = siteId;
    document.getElementById('siteName').value = site.name;
    document.getElementById('sitePlatform').value = site.platform;
    document.getElementById('displayName').value = site.display_name;
    document.getElementById('domain').value = site.domain || '';
    document.getElementById('dataSource').value = site.data_source;
    document.getElementById('templateId').value = site.template_id || '';
    document.getElementById('configJson').value = site.config_json ? 
      JSON.stringify(site.config_json, null, 2) : '';
    
    updateDataSourceOptions();
    updateTemplateOptions();
    updateTemplatePreview();
    
    // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
    document.querySelector('#siteConfigForm button[type="submit"]').textContent = 'æ›´æ–°ç«™ç‚¹';
    
    showStatus('æ­£åœ¨ç¼–è¾‘ç«™ç‚¹ï¼š' + site.display_name, 'info');
  }
}

// åˆ é™¤ç«™ç‚¹
async function deleteSite(siteId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç«™ç‚¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
    return;
  }
  
  try {
    showStatus('æ­£åœ¨åˆ é™¤ç«™ç‚¹...', 'info', true);
    
    console.log('åˆ é™¤ç«™ç‚¹ID:', siteId);
    
    const response = await fetch('/api/site-configs/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ siteId })
    });
    
    console.log('åˆ é™¤APIå“åº”çŠ¶æ€:', response.status);
    const result = await response.json();
    console.log('åˆ é™¤APIå“åº”æ•°æ®:', result);
    
    if (response.ok) {
      showStatus('ç«™ç‚¹åˆ é™¤æˆåŠŸï¼', 'success');
      console.log('åˆ é™¤æˆåŠŸï¼Œå¼€å§‹åˆ·æ–°ç«™ç‚¹åˆ—è¡¨...');
      await loadSites(); // ç­‰å¾…åŠ è½½å®Œæˆ
      console.log('ç«™ç‚¹åˆ—è¡¨åˆ·æ–°å®Œæˆ');
    } else {
      showStatus('åˆ é™¤å¤±è´¥: ' + (result.error || result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
  } catch (error) {
    console.error('åˆ é™¤ç«™ç‚¹é”™è¯¯:', error);
    showStatus('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
  }
}

// é‡ç½®è¡¨å•
function resetForm() {
  document.getElementById('siteConfigForm').reset();
  document.getElementById('templatePreview').textContent = 'é€‰æ‹©æ•°æ®æºç±»å‹æŸ¥çœ‹æ¨¡æ¿é…ç½®...';
  editingSiteId = null;
  document.querySelector('#siteConfigForm button[type="submit"]').textContent = 'åˆ›å»ºç«™ç‚¹';
}

// æ›´æ–°æµ‹è¯•ç«™ç‚¹é€‰é¡¹
function updateTestSiteOptions() {
  const testSite = document.getElementById('testSite');
  testSite.innerHTML = '<option value="">é€‰æ‹©è¦æµ‹è¯•çš„ç«™ç‚¹</option>';
  
  currentSites.forEach(site => {
    testSite.innerHTML += `<option value="${site.id}">${site.display_name}</option>`;
  });
}

// æµ‹è¯•æ•°æ®ä¸Šä¼ 
async function testDataUpload() {
  const siteId = document.getElementById('testSite').value;
  const fileInput = document.getElementById('testFile');
  
  console.log('æ–‡ä»¶ä¸Šä¼ æ£€æŸ¥:', {
    siteId: siteId,
    fileInput: fileInput,
    fileInputExists: !!fileInput,
    files: fileInput?.files,
    filesLength: fileInput?.files?.length
  });
  
  if (!siteId) {
    showStatus('è¯·é€‰æ‹©è¦æµ‹è¯•çš„ç«™ç‚¹', 'error');
    return;
  }
  
  if (!fileInput) {
    showStatus('æ–‡ä»¶è¾“å…¥å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    return;
  }
  
  if (!fileInput.files || fileInput.files.length === 0) {
    showStatus('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', fileInput.files[0]);
  
  try {
    showStatus('æ­£åœ¨ä¸Šä¼ æ•°æ®ï¼Œè¯·ç¨å€™...', 'info', true);
    
    console.log('ä¸Šä¼ ç«™ç‚¹ID:', siteId);
    console.log('ä¸Šä¼ æ–‡ä»¶:', fileInput.files[0].name);
    console.log('æ–‡ä»¶å¤§å°:', fileInput.files[0].size, 'bytes');
    
    const response = await fetch(`/api/dynamic-ingest/${encodeURIComponent(siteId)}`, {
      method: 'POST',
      body: formData
    });
    
    console.log('ä¸Šä¼ APIå“åº”çŠ¶æ€:', response.status);
    const result = await response.json();
    console.log('ä¸Šä¼ APIå“åº”æ•°æ®:', result);
    
    if (response.ok) {
      const message = `æ•°æ®ä¸Šä¼ æˆåŠŸï¼å¤„ç†äº† ${result.processed} æ¡è®°å½•ï¼Œæ’å…¥äº† ${result.upserted} æ¡è®°å½•`;
      showStatus(message, 'success');
      
      // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
      fileInput.value = '';
      document.getElementById('fileUpload').innerHTML = `
        <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
      `;
      
      // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
      setTimeout(() => {
        showStatus(`ä¸Šä¼ è¯¦æƒ…ï¼šå¤„ç† ${result.processed} æ¡ï¼Œæ’å…¥ ${result.upserted} æ¡ï¼Œè¡¨åï¼š${result.table}`, 'info');
      }, 3000);
    } else {
      showStatus('ä¸Šä¼ å¤±è´¥: ' + (result.error || result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
  } catch (error) {
    console.error('ä¸Šä¼ æ•°æ®é”™è¯¯:', error);
    showStatus('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
  }
}

// ç”Ÿæˆæµ‹è¯•æ•°æ®
async function generateTestData() {
  const siteId = document.getElementById('testSite').value;
  
  if (!siteId) {
    showStatus('è¯·é€‰æ‹©è¦æµ‹è¯•çš„ç«™ç‚¹', 'error');
    return;
  }
  
  try {
    showStatus('æ­£åœ¨ç”Ÿæˆæµ‹è¯•æ•°æ®...', 'info');
    
    const response = await fetch(`/api/dynamic-ingest/${siteId}/generate-test-data`, {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showStatus('æµ‹è¯•æ•°æ®ç”Ÿæˆå®Œæˆï¼', 'success');
    } else {
      showStatus('ç”Ÿæˆæµ‹è¯•æ•°æ®å¤±è´¥: ' + (result.error || result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
    }
  } catch (error) {
    showStatus('ç”Ÿæˆæµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message, 'error');
  }
}

// æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
function showStatus(message, type = 'info', showProgress = false) {
  const statusDiv = document.getElementById('statusMessage');
  const progressHtml = showProgress ? '<div class="progress-bar"><div class="progress-fill"></div></div>' : '';
  const progressClass = showProgress ? ' with-progress' : '';
  
  statusDiv.innerHTML = `<div class="status-message status-${type}${progressClass}">${message}${progressHtml}</div>`;
  
  // å¦‚æœæ˜¯è¿›åº¦æ¶ˆæ¯ï¼Œå»¶é•¿æ˜¾ç¤ºæ—¶é—´
  const timeout = showProgress ? 10000 : 5000;
  setTimeout(() => {
    statusDiv.innerHTML = '';
  }, timeout);
}

// æµ‹è¯•APIè¿æ¥
async function testAPI() {
  try {
    showStatus('æ­£åœ¨æµ‹è¯•APIè¿æ¥...', 'info');
    
    // æµ‹è¯•å¥åº·æ£€æŸ¥API
    console.log('æµ‹è¯•å¥åº·æ£€æŸ¥API...');
    const healthResponse = await fetch('/api/health');
    console.log('å¥åº·æ£€æŸ¥APIçŠ¶æ€:', healthResponse.status);
    let healthData = null;
    try {
      healthData = await healthResponse.json();
      console.log('å¥åº·æ£€æŸ¥APIç»“æœ:', healthData);
    } catch (e) {
      console.error('å¥åº·æ£€æŸ¥API JSONè§£æå¤±è´¥:', e);
    }
    
    // æµ‹è¯•åŸºç¡€API
    console.log('æµ‹è¯•åŸºç¡€API...');
    const testResponse = await fetch('/api/test');
    console.log('åŸºç¡€APIçŠ¶æ€:', testResponse.status);
    let testData = null;
    try {
      testData = await testResponse.json();
      console.log('åŸºç¡€APIç»“æœ:', testData);
    } catch (e) {
      console.error('åŸºç¡€API JSONè§£æå¤±è´¥:', e);
    }
    
    // æµ‹è¯•ç«™ç‚¹é…ç½®API
    console.log('æµ‹è¯•ç«™ç‚¹é…ç½®API...');
    const sitesResponse = await fetch('/api/site-configs');
    console.log('ç«™ç‚¹é…ç½®APIçŠ¶æ€:', sitesResponse.status);
    let sitesData = null;
    try {
      sitesData = await sitesResponse.json();
      console.log('ç«™ç‚¹é…ç½®APIç»“æœ:', sitesData);
    } catch (e) {
      console.error('ç«™ç‚¹é…ç½®API JSONè§£æå¤±è´¥:', e);
    }
    
    // æµ‹è¯•æ¨¡æ¿API
    console.log('æµ‹è¯•æ¨¡æ¿API...');
    const templatesResponse = await fetch('/api/data-source-templates');
    console.log('æ¨¡æ¿APIçŠ¶æ€:', templatesResponse.status);
    let templatesData = null;
    try {
      templatesData = await templatesResponse.json();
      console.log('æ¨¡æ¿APIç»“æœ:', templatesData);
    } catch (e) {
      console.error('æ¨¡æ¿API JSONè§£æå¤±è´¥:', e);
    }
    
    // æµ‹è¯•åŠ¨æ€æ•°æ®æ‘„å…¥API
    console.log('æµ‹è¯•åŠ¨æ€æ•°æ®æ‘„å…¥API...');
    const dynamicResponse = await fetch('/api/dynamic-ingest/test', { method: 'POST' });
    console.log('åŠ¨æ€æ•°æ®æ‘„å…¥APIçŠ¶æ€:', dynamicResponse.status);
    
    let message = 'APIæµ‹è¯•å®Œæˆï¼\n';
    message += `å¥åº·æ£€æŸ¥API: ${healthResponse.ok ? 'æ­£å¸¸' : 'å¤±è´¥'} (${healthResponse.status})\n`;
    message += `åŸºç¡€API: ${testResponse.ok ? 'æ­£å¸¸' : 'å¤±è´¥'} (${testResponse.status})\n`;
    message += `ç«™ç‚¹é…ç½®API: ${sitesResponse.ok ? 'æ­£å¸¸' : 'å¤±è´¥'} (${sitesResponse.status})\n`;
    message += `æ¨¡æ¿API: ${templatesResponse.ok ? 'æ­£å¸¸' : 'å¤±è´¥'} (${templatesResponse.status})\n`;
    message += `åŠ¨æ€æ•°æ®æ‘„å…¥API: ${dynamicResponse.status === 400 ? 'æ­£å¸¸(éœ€è¦ç«™ç‚¹ID)' : 'å¤±è´¥'} (${dynamicResponse.status})\n`;
    message += `ç«™ç‚¹æ•°é‡: ${sitesData?.data?.length || 0}\n`;
    message += `æ¨¡æ¿æ•°é‡: ${templatesData?.data?.length || 0}`;
    
    const allAPIsWorking = healthResponse.ok && testResponse.ok && sitesResponse.ok && templatesResponse.ok;
    showStatus(message, allAPIsWorking ? 'success' : 'error');
    
  } catch (error) {
    console.error('APIæµ‹è¯•é”™è¯¯:', error);
    showStatus('APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
  }
}

// å·¥å…·å‡½æ•°
function getPlatformDisplayName(platform) {
  const names = {
    'ae_self_operated': 'é€Ÿå–é€šè‡ªè¿è¥',
    'ae_managed': 'é€Ÿå–é€šå…¨æ‰˜ç®¡',
    'independent': 'ç‹¬ç«‹ç«™',
    'amazon': 'äºšé©¬é€Š',
    'ebay': 'eBay'
  };
  return names[platform] || platform;
}

function getDataSourceDisplayName(dataSource) {
  const names = {
    'ae_api': 'é€Ÿå–é€šAPI',
    'google_ads': 'Google Ads',
    'facebook_ads': 'Facebook Ads',
    'tiktok_ads': 'TikTok Ads',
    'custom': 'è‡ªå®šä¹‰'
  };
  return names[dataSource] || dataSource;
}
</script>
</body>
</html>
