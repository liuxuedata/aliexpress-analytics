<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ozon 数据明细</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250811-single">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>const t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);</script>
  <style>
    #report td:first-child a{display:inline-block;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .kpi .card .mini-link{font-size:12px;margin-left:8px;text-decoration:underline;cursor:pointer;display:none;}
    .help{margin-left:4px;color:#888;cursor:pointer;}
  </style>
</head>
<body class="fm">
<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> 跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="#">速卖通</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon"><a href="amazon-overview.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon active"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="#">独立站</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span>Ozon</span></div>
    <ul class="sub-nav">
      <li><a href="ozon-detail.html" class="active">数据明细</a></li>
      <li><a href="ozon-analysis.html">运营分析</a></li>
      <li><a href="ozon-product-insights.html">产品分析</a></li>
    </ul>
  </nav>
  <main class="main">
    <div class="upload-section">
      <div class="upload-top">
        <div style="font-size:28px;font-weight:800;">Ozon 数据明细</div>
        <div class="controls">
          <span class="badge">时间粒度</span>
          <span class="sel" style="background:#1f2937;color:#fff;border-color:#334155;cursor:not-allowed">按日</span>
          <input type="hidden" value="day">
          <span>日期</span>
          <input id="dateFilter" class="date-filter" placeholder="选择日期范围">
          <label for="file" id="pickLabel" class="upload-btn">选择文件</label>
          <input type="file" id="file" accept=".xlsx,.xls,.csv" />
          <span id="status" class="notice"></span>
        </div>
      </div>
    </div>

    <div class="content">
      <div id="kpi" class="kpi"></div>
      <section id="detail" class="content-pad">
        <div class="panel">
          <h3>数据明细</h3>
          <div class="table-wrapper">
            <table id="report" class="display" style="width:100%">
              <thead>
                <tr>
                  <th>产品名</th>
                  <th>型号</th>
                  <th>总展示次数</th>
                  <th>在搜索和目录中的展示次数</th>
                  <th>商品详情页展示次数</th>
                  <th>总独立访客数</th>
                  <th>在搜索或目录中浏览过的独立访客</th>
                  <th>浏览过商品详情页的独立访客</th>
                  <th>总加入购物车数</th>
                  <th>从搜索和目录加入购物车</th>
                  <th>从商品详情页加入购物车</th>
                  <th>已订购商品数</th>
                  <th>已订购商品总金额</th>
                  <th>访客比<span class="help" onclick="alert('访客比 = 浏览过商品详情页的独立访客 / 总展示次数')">?</span></th>
                  <th>加购比<span class="help" onclick="alert('加购比 = 总加入购物车次数 / 浏览过商品详情页的独立访客')">?</span></th>
                  <th>支付比</th>
                  <th>产品详情</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
</main>
</div>
<script src="assets/site-nav.js"></script>
<script>
(function(){
  const storeId = 'demo';
  let table = null;
  let currentStart = '';
  let currentEnd = '';
  let newProducts = [];
  let onlyNew = false;

  function initTable(){
    if(!table){
      table = $('#report').DataTable({
        paging:true,
        searching:true,
        info:true,
        order:[[5,'desc']],
        scrollY:'60vh',
        scrollCollapse:true,
        autoWidth:false,
        language:{ emptyTable:'暂无数据' }
      });
      $('#report tbody').on('dblclick','td',function(){
        const col = table.cell(this).index().column;
        const last = table.columns().count()-1;
        if(col===0 || col===last) return;
        const pid = $(this).closest('tr').find('a[data-pid]').data('pid');
        if(pid) window.open('ozon-product-insights.html?pid='+pid,'_blank');
      });
    }
    return table;
  }

  function setStatus(t){ $('#status').text(t||''); }

  async function loadData(){
    setStatus('加载中...');
    const range = $('#dateFilter').val();
    let startISO, endISO;
    if(range && range.includes(' to ')){
      [startISO, endISO] = range.split(' to ');
    } else {
      const stored = localStorage.getItem('ozonRange');
      if(stored && stored.includes(' to ')){
        [startISO, endISO] = stored.split(' to ');
        $('#dateFilter').val(stored);
        if(window.fp) window.fp.setDate([startISO,endISO], true, 'Y-m-d');
      }else{
        const now=new Date();
        endISO = now.toISOString().slice(0,10);
        startISO = new Date(now.getTime()-6*86400000).toISOString().slice(0,10);
        $('#dateFilter').val(`${startISO} to ${endISO}`);
        if(window.fp) window.fp.setDate([startISO,endISO], true, 'Y-m-d');
      }
    }
    localStorage.setItem('ozonRange', `${startISO} to ${endISO}`);
    currentStart = startISO;
    currentEnd = endISO;
    try{
      const url = `/api/ozon/stats?store_id=${encodeURIComponent(storeId)}&start=${startISO}&end=${endISO}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if(!json.ok) throw new Error(json.msg||'查询失败');
      let rows = json.rows || [];
      if(onlyNew && newProducts.length){
        const idSet = new Set(newProducts.map(p=>`${p.sku}@@${p.model||''}`));
        rows = rows.filter(r=>idSet.has(`${r.product_id}@@${r.model||''}`));
      }
      const mapped = rows.map(r=>{
        const exposure = Number(r.voronka_prodazh_pokazy_vsego)||0;
        const allUv = Number(r.voronka_prodazh_unikalnye_posetiteli_vsego)||0;
        const detailUv = Number(r.voronka_prodazh_uv_s_prosmotrom_kartochki_tovara)||0;
        const cart = Number(r.voronka_prodazh_dobavleniya_v_korzinu_vsego)||0;
        const pay = Number(r.voronka_prodazh_zakazano_tovarov)||0;
        const visitorRate = exposure ? (detailUv/exposure) : 0;
        const cartRate = detailUv ? (cart/detailUv) : 0;
        const payRate = cart ? (pay/cart) : 0;
        const title = r.product_title || r.product_id;
        return [
          `<a data-pid="${r.product_id}" href="https://ozon.ru/product/${r.product_id}" target="_blank" rel="noopener" title="${title}">${title}</a>`,
          r.model || '',
          exposure,
          Number(r.voronka_prodazh_pokazy_v_poiske_i_kataloge)||0,
          Number(r.voronka_prodazh_pokazy_na_kartochke_tovara)||0,
          allUv,
          Number(r.voronka_prodazh_uv_s_prosmotrom_v_poiske_ili_kataloge)||0,
          detailUv,
          cart,
          Number(r.voronka_prodazh_dobavleniya_iz_poiska_i_kataloge_v_korzinu)||0,
          Number(r.voronka_prodazh_dobavleniya_iz_kartochki_v_korzinu)||0,
          pay,
          Number(r.prodazhi_zakazano_na_summu)||0,
          (visitorRate*100).toFixed(2)+'%',
          (cartRate*100).toFixed(2)+'%',
          (payRate*100).toFixed(2)+'%',
          `<a href="ozon-product-insights.html?pid=${r.product_id}" target="_blank">详情</a>`
        ];
      });
      const dt = initTable();
      dt.clear().rows.add(mapped).draw();
      loadKpi().catch(err=>console.error(err));
      setStatus('加载完成');
    }catch(err){
      console.error(err);
      setStatus('加载失败');
      throw err;
    }
  }

  async function upload(file){
    const fd = new FormData();
    fd.append('file', file);
    fd.append('store_id', storeId);
    const resp = await fetch('/api/ozon/import', { method:'POST', body:fd });
    const json = await resp.json();
    if(!json.ok) throw new Error(json.msg||'上传失败');
    return json;
  }

  function renderKpi(k){
    const host = document.getElementById('kpi');
    if(!host) return;
    const delta = (c,p,isPct)=>{ const d=c-p; const cls=d>=0?'up':'down'; const val=isPct ? (d*100).toFixed(2)+'%' : d; const sign=d>=0&&isPct?'+':''; return `<span class="delta ${cls}">${sign}${val}</span>`; };
    host.innerHTML = [
      `<div class="card"><h4>总访客比<span class=\"help\" onclick=\"alert('访客比 = 浏览过商品详情页的独立访客 / 总展示次数')\">?</span></h4><p>${(k.visitor_rate.current*100).toFixed(2)}%${delta(k.visitor_rate.current,k.visitor_rate.previous,true)}</p></div>`,
      `<div class="card"><h4>加购比<span class=\"help\" onclick=\"alert('加购比 = 总加入购物车次数 / 浏览过商品详情页的独立访客')\">?</span></h4><p>${(k.cart_rate.current*100).toFixed(2)}%${delta(k.cart_rate.current,k.cart_rate.previous,true)}</p></div>`,
      `<div class="card"><h4>支付比</h4><p>${(k.pay_rate.current*100).toFixed(2)}%${delta(k.pay_rate.current,k.pay_rate.previous,true)}</p></div>`,
      `<div class="card"><h4>商品总数</h4><p>${k.product_total.current}${delta(k.product_total.current,k.product_total.previous,false)}</p></div>`,
      `<div class="card"><h4>有加购商品总数</h4><p>${k.cart_product_total.current}${delta(k.cart_product_total.current,k.cart_product_total.previous,false)}</p></div>`,
      `<div class="card"><h4>有支付商品总数</h4><p>${k.pay_product_total.current}${delta(k.pay_product_total.current,k.pay_product_total.previous,false)}</p></div>`,
      `<div class="card clickable" id="kpi-new"><h4>新品数</h4><p>${k.new_product_total}<a id="kpi-new-clear" class="mini-link" style="display:${onlyNew?'inline':'none'}">清除筛选</a></p></div>`
    ].join('');
    newProducts = k.new_products || [];
    const newCard = document.getElementById('kpi-new');
    const clearLink = document.getElementById('kpi-new-clear');
    if(newCard){
      newCard.addEventListener('click',()=>{
        if(!onlyNew){
          onlyNew = true;
          loadData().catch(err=>console.error(err));
        }
      });
    }
    if(clearLink){
      clearLink.addEventListener('click',e=>{
        e.stopPropagation();
        if(onlyNew){
          onlyNew = false;
          loadData().catch(err=>console.error(err));
        }
      });
    }
  }

  async function loadKpi(){
    if(!currentStart || !currentEnd) return;
    try{
      const resp = await fetch(`/api/ozon/kpi?store_id=${encodeURIComponent(storeId)}&start=${currentStart}&end=${currentEnd}`);
      const json = await resp.json();
      if(!json.ok) throw new Error(json.msg||'加载失败');
      if(json.metrics){
        renderKpi(json.metrics);
      }else{
        document.getElementById('kpi').innerHTML='';
      }
    }catch(err){
      console.error(err);
    }
  }

  $('#file').on('change', async function(e){
    const file = e.target.files[0];
    if(!file) return;
    try{
      setStatus('上传中...');
      const result = await upload(file);
      await loadData();
      setStatus(`新增${result.inserted||0}条，重复${result.duplicates||0}条`);
    }catch(err){ console.error(err); setStatus('失败: '+err.message); }
    e.target.value='';
  });

  window.fp = flatpickr('#dateFilter',{
    mode:'range',
    dateFormat:'Y-m-d',
    onClose:(ds)=>{
      if(ds.length===2){
        const s=ds[0].toISOString().slice(0,10);
        const e=ds[1].toISOString().slice(0,10);
        localStorage.setItem('ozonRange', `${s} to ${e}`);
        loadData().catch(err=>console.error(err));
      }
    }
  });
  const stored = localStorage.getItem('ozonRange');
  if(stored && stored.includes(' to ')){
    $('#dateFilter').val(stored);
    window.fp.setDate(stored.split(' to '), true, 'Y-m-d');
  }
  loadData().catch(err=>console.error(err));
})();
</script>
</body>
</html>
