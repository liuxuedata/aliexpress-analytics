<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ozon 数据明细</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250811-single">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>const t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);</script>
  <style>
    #report td:first-child{max-width:200px;white-space:normal;word-break:break-word;}
    #newModal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;}
    #newModal .box{background:#fff;padding:20px;border-radius:8px;max-width:400px;max-height:60vh;overflow:auto;}
    #newModal ul{margin:0;padding-left:20px;}
  </style>
</head>
<body class="fm">
<header class="header">
  <div class="logo-title">跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="#">速卖通</a>
        <ul class="dropdown">
          <li><a href="index.html">全托管</a></li>
          <li><a href="self-operated.html">自运营</a></li>
        </ul>
      </li>
      <li class="amazon"><a href="amazon.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon active"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="independent-site.html">独立站</a></li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span>Ozon</span></div>
    <ul class="sub-nav">
      <li><a href="ozon-detail.html" class="active">数据明细</a></li>
      <li><a href="ozon-analysis.html">运营分析</a></li>
      <li><a href="ozon-product-insights.html">产品分析</a></li>
    </ul>
  </nav>
  <main class="main">
    <div class="upload-section">
      <div class="upload-top">
        <div style="font-size:28px;font-weight:800;">Ozon 数据明细</div>
        <div class="controls">
          <span class="badge">时间粒度</span>
          <span class="sel" style="background:#1f2937;color:#fff;border-color:#334155;cursor:not-allowed">按日</span>
          <input type="hidden" value="day">
          <span>日期</span>
          <input id="dateFilter" class="date-filter" placeholder="选择日期范围">
          <button id="refreshBtn" class="btn">刷新</button>
          <label for="file" id="pickLabel" class="upload-btn">选择文件</label>
          <input type="file" id="file" accept=".xlsx,.xls,.csv" />
          <span id="status" class="notice"></span>
        </div>
      </div>
    </div>

    <div class="content">
      <div id="kpi" class="kpi"></div>
      <section id="detail" class="content-pad">
        <div class="panel">
          <h3>数据明细</h3>
          <div class="table-wrapper">
            <table id="report" class="display" style="width:100%">
              <thead>
                <tr>
                  <th>产品名</th>
                  <th>曝光量</th>
                  <th>访客数</th>
                  <th>浏览量</th>
                  <th>加购人数</th>
                  <th>加购件数</th>
                  <th>支付件数</th>
                  <th>支付订单数</th>
                  <th>支付买家数</th>
                  <th>访客→加购</th>
                  <th>加购→支付</th>
                  <th>访客比</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>
<div id="newModal"><div class="box"><h4>新品列表</h4><ul id="newItems"></ul></div></div>
<script>
(function(){
  const storeId = 'demo';
  let table = null;
  let periodStart = '';
  let periodEnd = '';
  let newProducts = [];

  function initTable(){
    if(!table){
      table = $('#report').DataTable({
        paging:true,
        searching:true,
        info:true,
        order:[[2,'desc']],
        scrollY:'60vh',
        scrollCollapse:true,
        autoWidth:false,
        language:{ emptyTable:'暂无数据' }
      });
    }
    return table;
  }

  function setStatus(t){ $('#status').text(t||''); }

  async function loadData(){
    let fromDate, toDate;
    const val = $('#dateFilter').val();
    if(val && val.includes(' to ')){
      [fromDate, toDate] = val.split(' to ');
    }else{
      const today = new Date();
      toDate = today.toISOString().slice(0,10);
      fromDate = new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
      $('#dateFilter').val(`${fromDate} to ${toDate}`);
    }
    const resp = await fetch(`/api/ozon/stats?store_id=${encodeURIComponent(storeId)}&from=${fromDate}&to=${toDate}`);
    const json = await resp.json();
    if(!json.ok) throw new Error(json.msg||'查询失败');
    // use period returned by backend (may differ if no data for requested range)
    periodStart = json.period_start || fromDate;
    periodEnd = json.period_end || toDate;
    $('#dateFilter').val(`${periodStart} to ${periodEnd}`);
    const mapped = (json.rows||[]).map(r=>{
      const impressions = Number(r.exposure)||0;
      const sessions = Number(r.uv)||0;
      const pageviews = Number(r.pv)||0;
      const atcUsers = Number(r.add_to_cart_users)||0;
      const atcQty = Number(r.add_to_cart_qty)||0;
      const itemsSold = Number(r.pay_items)||0;
      const orders = Number(r.pay_orders)||0;
      const buyers = Number(r.pay_buyers)||0;
      const v2a = sessions ? (atcUsers/sessions*100).toFixed(2)+'%' : '0%';
      const a2p = atcUsers ? (orders/atcUsers*100).toFixed(2)+'%' : '0%';
      const visitRate = impressions ? (sessions/impressions*100).toFixed(2)+'%' : '0%';
      return [
        `<a href="https://ozon.ru/product/${r.product_id}" target="_blank" rel="noopener">${r.product_title || r.product_id}</a>`,
        impressions,
        sessions,
        pageviews,
        atcUsers,
        atcQty,
        itemsSold,
        orders,
        buyers,
        v2a,
        a2p,
        visitRate
      ];
    });
    const dt = initTable();
    dt.clear().rows.add(mapped).draw();
    loadKpi().catch(err=>console.error(err));
  }

  async function upload(file){
    const fd = new FormData();
    fd.append('file', file);
    fd.append('store_id', storeId);
    const resp = await fetch('/api/ozon/import', { method:'POST', body:fd });
    const json = await resp.json();
    if(!json.ok) throw new Error(json.msg||'上传失败');
  }

  function renderKpi(k){
    const host = document.getElementById('kpi');
    if(!host) return;
    const delta = (c,p,isPct)=>{ const d=c-p; const cls=d>=0?'up':'down'; const val=isPct ? (d*100).toFixed(2)+'%' : d; const sign=d>=0&&isPct?'+':''; return `<span class="delta ${cls}">${sign}${val}</span>`; };
    host.innerHTML = [
      `<div class="card"><h4>访客比</h4><p>${(k.visitor_rate.current*100).toFixed(2)}%${delta(k.visitor_rate.current,k.visitor_rate.previous,true)}</p></div>`,
      `<div class="card"><h4>加购比</h4><p>${(k.cart_rate.current*100).toFixed(2)}%${delta(k.cart_rate.current,k.cart_rate.previous,true)}</p></div>`,
      `<div class="card"><h4>支付比</h4><p>${(k.pay_rate.current*100).toFixed(2)}%${delta(k.pay_rate.current,k.pay_rate.previous,true)}</p></div>`,
      `<div class="card"><h4>商品总数</h4><p>${k.product_total.current}${delta(k.product_total.current,k.product_total.previous,false)}</p></div>`,
      `<div class="card"><h4>有加购商品总数</h4><p>${k.cart_product_total.current}${delta(k.cart_product_total.current,k.cart_product_total.previous,false)}</p></div>`,
      `<div class="card"><h4>有支付商品总数</h4><p>${k.pay_product_total.current}${delta(k.pay_product_total.current,k.pay_product_total.previous,false)}</p></div>`,
      `<div class="card clickable" id="kpi-new"><h4>新品数</h4><p>${k.new_product_total}</p></div>`
    ].join('');
    newProducts = k.new_products || [];
    const newCard = document.getElementById('kpi-new');
    if(newCard) newCard.addEventListener('click',()=>{
      const modal=document.getElementById('newModal');
      const ul=document.getElementById('newItems');
      ul.innerHTML=newProducts.map(p=>`<li>${p.title||p.sku}</li>`).join('');
      modal.style.display='flex';
    });
  }

  async function loadKpi(){
    if(!periodStart || !periodEnd) return;
    const resp = await fetch(`/api/ozon/kpi?from=${periodStart}&to=${periodEnd}`);
    const json = await resp.json();
    if(json.ok && json.metrics){
      renderKpi(json.metrics);
    }
  }

  $('#file').on('change', async function(e){
    const file = e.target.files[0];
    if(!file) return;
    try{
      setStatus('上传中...');
      await upload(file);
      setStatus('加载数据...');
      await loadData();
      setStatus('完成');
    }catch(err){ console.error(err); setStatus('失败: '+err.message); }
    e.target.value='';
  });

  document.getElementById('newModal').addEventListener('click',e=>{ if(e.target.id==='newModal') e.currentTarget.style.display='none'; });

  const fp=flatpickr('#dateFilter',{mode:'range',dateFormat:'Y-m-d',onClose:ds=>{ if(ds.length===2) loadData().catch(err=>console.error(err)); }});
  $('#refreshBtn').on('click',()=>loadData().catch(err=>console.error(err)));
  const today=new Date();
  const end=today.toISOString().slice(0,10);
  const start=new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
  $('#dateFilter').val(`${start} to ${end}`);
  loadData().catch(err=>console.error(err));
})();
</script>
</body>
</html>
