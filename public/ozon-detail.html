<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ozon 数据明细</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250811-single">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>const t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);</script>
</head>
<body class="fm">
<header class="header">
  <div class="logo-title">跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="#">速卖通</a>
        <ul class="dropdown">
          <li><a href="index.html">全托管</a></li>
          <li><a href="self-operated.html">自运营</a></li>
        </ul>
      </li>
      <li class="amazon"><a href="amazon.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon active"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="independent-site.html">独立站</a></li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span>Ozon</span></div>
    <ul class="sub-nav">
      <li><a href="ozon-detail.html" class="active">数据明细</a></li>
      <li><a href="ozon-analysis.html">运营分析</a></li>
      <li><a href="ozon-product-insights.html">产品分析</a></li>
    </ul>
  </nav>
  <main class="main">
    <div class="upload-section">
      <div class="upload-top">
        <div style="font-size:28px;font-weight:800;">Ozon 数据明细</div>
        <div class="controls">
          <span class="badge">时间粒度</span>
          <span class="sel" style="background:#1f2937;color:#fff;border-color:#334155;cursor:not-allowed">按日</span>
          <input type="hidden" value="day">
          <label for="file" id="pickLabel" class="upload-btn">选择文件</label>
          <input type="file" id="file" accept=".xlsx,.xls,.csv" />
          <span id="status" class="notice"></span>
        </div>
      </div>
    </div>

    <div class="content">
      <section id="detail" class="content-pad">
        <div class="panel">
          <h3>数据明细</h3>
          <div class="table-wrapper">
            <table id="report" class="display" style="width:100%">
              <thead>
                <tr>
                  <th>产品名</th>
                  <th>曝光量</th>
                  <th>访客数</th>
                  <th>浏览量</th>
                  <th>加购人数</th>
                  <th>加购件数</th>
                  <th>支付件数</th>
                  <th>支付订单数</th>
                  <th>支付买家数</th>
                  <th>访客→加购</th>
                  <th>加购→支付</th>
                  <th>访客比</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>
<script>
(function(){
  const storeId = 'demo';
  let table = null;

  function initTable(){
    if(!table){
      table = $('#report').DataTable({
        paging:true,
        searching:true,
        info:true,
        order:[[2,'desc']],
        scrollY:'60vh',
        scrollCollapse:true,
        autoWidth:false,
        language:{ emptyTable:'暂无数据' }
      });
    }
    return table;
  }

  function setStatus(t){ $('#status').text(t||''); }

  async function loadData(){
    const resp = await fetch(`/api/ozon/stats?store_id=${encodeURIComponent(storeId)}`);
    const json = await resp.json();
    if(!json.ok) throw new Error(json.msg||'查询失败');
    const mapped = (json.rows||[]).map(r=>{
      const impressions = Number(r.search_exposure)||0;
      const sessions = Number(r.uv)||0;
      const pageviews = Number(r.pv)||0;
      const atcUsers = Number(r.add_to_cart_users)||0;
      const atcQty = Number(r.add_to_cart_qty)||0;
      const itemsSold = Number(r.pay_items)||0;
      const orders = Number(r.pay_orders)||0;
      const buyers = Number(r.pay_buyers)||0;
      const v2a = sessions ? (atcUsers/sessions*100).toFixed(2)+'%' : '0%';
      const a2p = atcUsers ? (orders/atcUsers*100).toFixed(2)+'%' : '0%';
      const visitRate = impressions ? (sessions/impressions*100).toFixed(2)+'%' : '0%';
      return [
        `<a href="https://ozon.ru/product/${r.product_id}" target="_blank" rel="noopener">${r.product_title || r.product_id}</a>`,
        impressions,
        sessions,
        pageviews,
        atcUsers,
        atcQty,
        itemsSold,
        orders,
        buyers,
        v2a,
        a2p,
        visitRate
      ];
    });
    const dt = initTable();
    dt.clear().rows.add(mapped).draw();
  }

  async function upload(file){
    const fd = new FormData();
    fd.append('file', file);
    fd.append('store_id', storeId);
    const resp = await fetch('/api/ozon/import', { method:'POST', body:fd });
    const json = await resp.json();
    if(!json.ok) throw new Error(json.msg||'上传失败');
  }

  $('#file').on('change', async function(e){
    const file = e.target.files[0];
    if(!file) return;
    try{
      setStatus('上传中...');
      await upload(file);
      setStatus('加载数据...');
      await loadData();
      setStatus('完成');
    }catch(err){ console.error(err); setStatus('失败: '+err.message); }
    e.target.value='';
  });

  loadData().catch(err=>console.error(err));
})();
</script>
</body>
</html>
