<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title id="pageTitle">跨境电商数据分析平台 - Amazon数据总览</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg" sizes="64x64">
  <!-- libs -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <!-- 主题样式 -->
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250810b">
  <link rel="stylesheet" href="assets/global-theme.css">
  <script src="assets/site-nav.js"></script>
  <script src="assets/page-template.js"></script>
  <script src="assets/self-operated.js"></script>
  <style>
    /* Amazon专用样式 */
    .amazon-kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .amazon-kpi-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
    }
    
    .amazon-kpi-value {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 0.5rem;
    }
    
    .amazon-kpi-label {
      color: #64748b;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .amazon-chart-container {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .amazon-table-container {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .asin-link {
      color: #3b82f6;
      text-decoration: none;
    }
    
    .asin-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body class="fm">
<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> 跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="#">速卖通</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon active"><a href="amazon-overview.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="#">独立站</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>

<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span>Amazon数据总览</span></div>
    <ul class="sub-nav">
      <li><a href="amazon-overview.html" class="active">总览</a></li>
      <li><a href="amazon-ads.html">广告</a></li>
    </ul>
  </nav>
  
  <main class="main">
    <!-- 日期选择器 -->
    <div class="date-range-selector" style="margin-bottom: 2rem;">
      <div class="date-inputs">
        <input type="text" id="startDate" placeholder="开始日期" readonly>
        <span>至</span>
        <input type="text" id="endDate" placeholder="结束日期" readonly>
        <button id="loadData" class="btn-primary">查询数据</button>
      </div>
    </div>

    <!-- KPI卡片 -->
    <div class="amazon-kpi-grid" id="kpiGrid">
      <div class="amazon-kpi-card">
        <div class="amazon-kpi-value" id="totalSessions">-</div>
        <div class="amazon-kpi-label">总访客数</div>
      </div>
      <div class="amazon-kpi-card">
        <div class="amazon-kpi-value" id="totalPageViews">-</div>
        <div class="amazon-kpi-label">总曝光数</div>
      </div>
      <div class="amazon-kpi-card">
        <div class="amazon-kpi-value" id="totalOrders">-</div>
        <div class="amazon-kpi-label">总下单数</div>
      </div>
      <div class="amazon-kpi-card">
        <div class="amazon-kpi-value" id="totalGMV">-</div>
        <div class="amazon-kpi-label">总GMV</div>
      </div>
      <div class="amazon-kpi-card">
        <div class="amazon-kpi-value" id="avgBuyBox">-</div>
        <div class="amazon-kpi-label">平均Buy Box%</div>
      </div>
    </div>

    <!-- 趋势图表 -->
    <div class="amazon-chart-container">
      <h3 style="margin-bottom: 1rem;">趋势分析</h3>
      <div id="trendChart" style="width: 100%; height: 400px;"></div>
    </div>

    <!-- 数据表格 -->
    <div class="amazon-table-container">
      <h3 style="margin-bottom: 1rem;">详细数据</h3>
      <table id="amazonDataTable" class="table">
        <thead>
          <tr>
            <th>ASIN</th>
            <th>日期</th>
            <th>访客数</th>
            <th>曝光数</th>
            <th>下单数</th>
            <th>GMV</th>
            <th>Buy Box%</th>
            <th>转化率</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>
</div>

<script>
let amazonDataTable;
let trendChart;

// 初始化页面
$(document).ready(function() {
  initializeDatePicker();
  initializeDataTable();
  initializeChart();
  loadDefaultData();
});

// 初始化日期选择器
function initializeDatePicker() {
  const today = new Date();
  const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  flatpickr("#startDate", {
    dateFormat: "Y-m-d",
    defaultDate: lastWeek,
    maxDate: today
  });
  
  flatpickr("#endDate", {
    dateFormat: "Y-m-d", 
    defaultDate: today,
    maxDate: today
  });
  
  $("#loadData").click(loadData);
}

// 初始化数据表格
function initializeDataTable() {
  amazonDataTable = $("#amazonDataTable").DataTable({
    pageLength: 25,
    order: [[1, 'desc']],
    columnDefs: [
      {
        targets: 0,
        render: function(data, type, row) {
          if (type === 'display' && data) {
            return `<a href="https://www.amazon.com/dp/${data}" target="_blank" class="asin-link">${data}</a>`;
          }
          return data;
        }
      },
      {
        targets: [2, 3, 4],
        render: function(data, type, row) {
          if (type === 'display') {
            return parseInt(data || 0).toLocaleString();
          }
          return data;
        }
      },
      {
        targets: 5,
        render: function(data, type, row) {
          if (type === 'display') {
            return '$' + parseFloat(data || 0).toFixed(2);
          }
          return data;
        }
      },
      {
        targets: 6,
        render: function(data, type, row) {
          if (type === 'display' && data) {
            return (parseFloat(data) * 100).toFixed(2) + '%';
          }
          return data;
        }
      },
      {
        targets: 7,
        render: function(data, type, row) {
          if (type === 'display') {
            const sessions = parseInt(row[2] || 0);
            const orders = parseInt(row[4] || 0);
            const rate = sessions > 0 ? (orders / sessions * 100) : 0;
            return rate.toFixed(2) + '%';
          }
          return data;
        }
      }
    ]
  });
}

// 初始化图表
function initializeChart() {
  trendChart = echarts.init(document.getElementById('trendChart'));
  
  const option = {
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'cross'
      }
    },
    legend: {
      data: ['访客数', '曝光数', '下单数', 'GMV']
    },
    xAxis: {
      type: 'category',
      data: []
    },
    yAxis: [
      {
        type: 'value',
        name: '数量',
        position: 'left'
      },
      {
        type: 'value',
        name: 'GMV ($)',
        position: 'right'
      }
    ],
    series: [
      {
        name: '访客数',
        type: 'line',
        data: []
      },
      {
        name: '曝光数',
        type: 'line',
        data: []
      },
      {
        name: '下单数',
        type: 'line',
        data: []
      },
      {
        name: 'GMV',
        type: 'line',
        yAxisIndex: 1,
        data: []
      }
    ]
  };
  
  trendChart.setOption(option);
}

// 加载默认数据（最近7天）
function loadDefaultData() {
  const end = new Date();
  const start = new Date(end.getTime() - 6 * 24 * 60 * 60 * 1000);
  
  $("#startDate").val(start.toISOString().slice(0, 10));
  $("#endDate").val(end.toISOString().slice(0, 10));
  
  loadData();
}

// 加载数据
async function loadData() {
  const startDate = $("#startDate").val();
  const endDate = $("#endDate").val();
  
  if (!startDate || !endDate) {
    alert('请选择开始和结束日期');
    return;
  }
  
  try {
    showLoading();
    
    const response = await fetch(`/api/amazon/query?start=${startDate}&end=${endDate}&granularity=day`);
    const data = await response.json();
    
    if (data.ok && data.rows) {
      updateKPIs(data.rows);
      updateChart(data.rows);
      updateTable(data.rows);
    } else {
      showError('数据加载失败: ' + (data.error || '未知错误'));
    }
  } catch (error) {
    showError('网络错误: ' + error.message);
  } finally {
    hideLoading();
  }
}

// 更新KPI卡片
function updateKPIs(rows) {
  const totals = rows.reduce((acc, row) => {
    acc.sessions += parseInt(row.sessions || 0);
    acc.pageViews += parseInt(row.page_views || 0);
    acc.orders += parseInt(row.units_ordered || 0);
    acc.gmv += parseFloat(row.ordered_product_sales || 0);
    acc.buyBoxSum += parseFloat(row.buy_box_pct || 0);
    acc.buyBoxCount += row.buy_box_pct ? 1 : 0;
    return acc;
  }, {
    sessions: 0,
    pageViews: 0,
    orders: 0,
    gmv: 0,
    buyBoxSum: 0,
    buyBoxCount: 0
  });
  
  $("#totalSessions").text(totals.sessions.toLocaleString());
  $("#totalPageViews").text(totals.pageViews.toLocaleString());
  $("#totalOrders").text(totals.orders.toLocaleString());
  $("#totalGMV").text('$' + totals.gmv.toFixed(2));
  $("#avgBuyBox").text(totals.buyBoxCount > 0 ? (totals.buyBoxSum / totals.buyBoxCount * 100).toFixed(2) + '%' : '-');
}

// 更新图表
function updateChart(rows) {
  const dates = [...new Set(rows.map(row => row.bucket))].sort();
  const aggregated = {};
  
  // 按日期聚合数据
  rows.forEach(row => {
    if (!aggregated[row.bucket]) {
      aggregated[row.bucket] = {
        sessions: 0,
        pageViews: 0,
        orders: 0,
        gmv: 0
      };
    }
    aggregated[row.bucket].sessions += parseInt(row.sessions || 0);
    aggregated[row.bucket].pageViews += parseInt(row.page_views || 0);
    aggregated[row.bucket].orders += parseInt(row.units_ordered || 0);
    aggregated[row.bucket].gmv += parseFloat(row.ordered_product_sales || 0);
  });
  
  const option = {
    xAxis: {
      data: dates
    },
    series: [
      {
        data: dates.map(date => aggregated[date]?.sessions || 0)
      },
      {
        data: dates.map(date => aggregated[date]?.pageViews || 0)
      },
      {
        data: dates.map(date => aggregated[date]?.orders || 0)
      },
      {
        data: dates.map(date => aggregated[date]?.gmv || 0)
      }
    ]
  };
  
  trendChart.setOption(option);
}

// 更新表格
function updateTable(rows) {
  const tableData = rows.map(row => [
    row.asin,
    row.bucket_label,
    row.sessions,
    row.page_views,
    row.units_ordered,
    row.ordered_product_sales,
    row.buy_box_pct,
    null // 转化率会在columnDefs中计算
  ]);
  
  amazonDataTable.clear().rows.add(tableData).draw();
}

// 显示加载状态
function showLoading() {
  $("#loadData").prop('disabled', true).text('加载中...');
}

// 隐藏加载状态
function hideLoading() {
  $("#loadData").prop('disabled', false).text('查询数据');
}

// 显示错误
function showError(message) {
  alert(message);
}

// 窗口大小改变时重新调整图表
$(window).resize(function() {
  if (trendChart) {
    trendChart.resize();
  }
});
</script>

<script src="assets/site-nav.js"></script>
</body>
</html>
