<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>独立站 · Landing Pages 明细</title>
  <link rel="stylesheet" href="assets/login.css">
  <style>
    #report td:first-child{ text-align:left; }
    #report td:first-child a.name{ display:inline-block; max-width:180px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    #columnToggleWrapper{ position:relative; display:inline-block; }
    #columnMenu{ display:none; position:absolute; top:100%; right:0; background:#fff; border:1px solid #ccc; padding:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    #columnMenu label{ display:block; margin:4px 0; white-space:nowrap; }
  </style>
  <!-- DataTables & ECharts CDN -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250811-single">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">跨境电商数据分析平台</div>
        <div class="form-subtitle">登录账户以继续</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">邮箱</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">密码</label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">👁️</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">登录</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">演示账户</div>
        <div class="demo-account-info">邮箱：demo@example.com<br>密码：demo123</div>
      </div>
    </div>
  </div>
</div>

<header class="header">
  <div class="logo-title">跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li><a href="#">速卖通</a>
        <ul class="dropdown">
          <li class="submenu"><a href="#">全托管</a>
            <ul id="managedMenu"></ul>
          </li>
          <li><a href="self-operated.html">自运营</a></li>
        </ul>
      </li>
      <li><a href="#">亚马逊</a></li>
      <li><a href="#">TikTok Shop</a></li>
      <li><a href="#">Temu</a></li>
      <li><a href="#">Ozon</a></li>
      <li><a href="independent-site.html" class="active">独立站</a></li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>

<div class="layout">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span>独立站</span></div>
    <ul class="sub-nav">
      <li><a href="#" data-jump="analysis" class="active">运营分析</a></li>
      <li><a href="#" data-jump="detail">明细表</a></li>
      <li><a href="#" data-jump="import">数据导入</a></li>
      <li><a href="#" data-jump="config">系统配置</a></li>
    </ul>
  </nav>

  <main class="main mx-auto max-w-container px-6">
    <div class="content">
    <!-- 控件 -->
    <section id="filters" class="content-pad">
      <div class="panel">
        <div class="controls">
          <label>站点：</label>
          <input type="text" id="site" value="" placeholder="如：poolsvacuum.com">
          <label>起止：</label>
          <input type="date" id="from">
          <input type="date" id="to">
          <label>网络：</label>
          <select id="networkSel"><option value="">全部</option></select>
          <label>Campaign：</label>
          <select id="campaignSel"><option value="">全部</option></select>
          <button id="refreshBtn" class="btn">刷新</button>
          <div id="columnToggleWrapper">
            <button id="columnToggle" class="btn">筛选列</button>
            <div id="columnMenu" class="small"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 运营分析 -->
    <section id="analysis" class="content-pad">
      <div id="analysisTabs" class="tab-nav">
        <a href="#" class="active" data-tab="tab-trend">周/月对比</a>
        <a href="#" data-tab="tab-product">单品诊断</a>
        <a href="#" data-tab="tab-channel">渠道分析</a>
        <a href="#" data-tab="tab-region">地区分析</a>
      </div>
      <div id="tab-trend" class="tab-panel">
        <div class="grid">
          <div class="panel">
            <h3>Daily 趋势（点击 / 曝光 / 转化价值）</h3>
            <div id="lineChart" style="width:100%;height:360px;"></div>
          </div>
          <div class="panel">
            <div class="top-panel-head">
              <h3>Top商品榜单</h3>
              <div class="top-tabs">
                <button class="active" data-metric="sales">Top销售</button>
                <button data-metric="cart">Top加购</button>
                <button data-metric="visitor">Top访客</button>
              </div>
            </div>
            <table id="topTable" class="top-table">
              <thead>
                <tr><th>排名</th><th>商品ID</th><th id="currLabel">本期销售额</th><th id="prevLabel">上期销售额</th><th>变化</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="tab-product" class="tab-panel" style="display:none;"><p>单品诊断建设中...</p></div>
      <div id="tab-channel" class="tab-panel" style="display:none;"><p>渠道分析建设中...</p></div>
      <div id="tab-region" class="tab-panel" style="display:none;"><p>地区分析建设中...</p></div>
    </section>

    <!-- 明细表 -->
    <section id="detail" class="content-pad" style="display:none;">
      <div class="panel">
        <h3>Landing Pages 明细</h3>
        <div id="kpi" class="stats-cards"></div>
        <div class="divider"></div>
        <div class="table-section">
          <div id="tableLoading" class="small" style="padding:1em;text-align:center;">数据加载中...</div>
          <div class="table-wrapper" style="display:none;">
            <table id="report" class="display nowrap" style="width:100%">
              <thead>
                <tr>
                  <th>产品</th><th>设备</th><th>网络</th><th>Campaign</th><th>日期</th>
                  <th>点击</th><th>曝光</th><th>CTR</th><th>Avg CPC</th><th>Cost</th>
                  <th>转化</th><th>Cost/Conv</th><th>All conv</th><th>Conv value</th>
                  <th>All conv rate</th><th>Conv rate</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- 数据导入 -->
    <section id="import" class="content-pad" style="display:none;">
      <div class="panel">
        <h3>数据导入</h3>
        <div class="import-area" style="text-align:center;padding:2em;border:2px dashed #ccc;">
          <p>支持 CSV 或 Excel 文件，最大 10MB</p>
          <button id="uploadBtn" class="btn">选择文件</button>
          <input type="file" id="fileInput" accept=".xlsx,.csv" style="display:none;">
          <span id="uploadStatus" class="small"></span>
        </div>
        <div class="divider"></div>
        <h4>导入历史</h4>
        <table id="importHistory" class="display" style="width:100%">
          <thead><tr><th>文件名</th><th>日期</th><th>记录数</th><th>状态</th></tr></thead>
          <tbody><tr><td colspan="4" style="text-align:center">暂无数据</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- 系统配置 -->
    <section id="config" class="content-pad" style="display:none;">
      <div class="panel">
        <h3>系统配置</h3>
        <div class="form" style="max-width:400px;">
          <label>站点名称：<input type="text" class="form-input" placeholder="如：Amazon US"></label>
          <label>站点 URL：<input type="text" class="form-input" placeholder="https://example.com"></label>
          <button class="btn" style="margin-top:1em;">保存</button>
        </div>
        <div class="divider"></div>
        <h4>站点列表</h4>
        <table class="display" style="width:100%">
          <thead><tr><th>站点</th><th>URL</th><th>状态</th><th>操作</th></tr></thead>
          <tbody>
            <tr><td>Amazon US</td><td>https://sellercentral.amazon.com</td><td>启用</td><td><button class="btn small">编辑</button></td></tr>
          </tbody>
        </table>
      </div>
    </section>
    </div>
  </main>
</div>

<script>
// 左侧局部导航切换
(function(){
  const sb = document.getElementById('sidebar');
  const filters = document.getElementById('filters');
  sb.addEventListener('click', function(e){
    const a = e.target.closest('a[data-jump]');
    if (!a) return;
    e.preventDefault();
    const to = a.getAttribute('data-jump');
    ['analysis','detail','import','config'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.style.display = (id===to ? '' : 'none');
    });
    sb.querySelectorAll('a[data-jump]').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    filters.style.display = (to==='analysis' || to==='detail') ? '' : 'none';
    setTimeout(()=> window.dispatchEvent(new Event('resize')), 0);
  });
})();
</script>

<script>
// 页面逻辑：拉取 /api/independent/stats
(function(){
  const shorten=(s,l=30)=>{if(!s) return '';return s.length>l?s.slice(0,l)+'…':s;};
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  const siteInput = document.getElementById('site');
  const fromInput = document.getElementById('from');
  const toInput = document.getElementById('to');
  const columnMenu = document.getElementById('columnMenu');
  const columnToggle = document.getElementById('columnToggle');
  const networkSel = document.getElementById('networkSel');
  const campaignSel = document.getElementById('campaignSel');
  const tableWrapper = document.querySelector('#detail .table-wrapper');
  const loadingEl = document.getElementById('tableLoading');
  const optionalCols = [
    { idx:1, label:'设备' }
  ];
  optionalCols.forEach(c=>{
    const lab=document.createElement('label');
    lab.innerHTML=`<input type="checkbox" data-col="${c.idx}"> ${c.label}`;
    columnMenu.appendChild(lab);
  });
  columnToggle.addEventListener('click',()=>{
    columnMenu.style.display = columnMenu.style.display==='block' ? 'none' : 'block';
  });
  let dt;
  let rawTable = [];

  function renderKPI(curr, prev={}){
    const items=[
      {key:'avg_ctr', label:'平均点击率', unit:'%'},
      {key:'avg_conv_rate', label:'平均转化率', unit:'%'},
      {key:'exposure_product_count', label:'曝光商品总数'},
      {key:'click_product_count', label:'点击商品总数'},
      {key:'conversion_product_count', label:'转化商品总数'},
      {key:'new_product_count', label:'新品总数'}
    ];
    const html = items.map((c,i)=>{
      const cur = curr[c.key] || 0;
      const prevVal = prev[c.key] || 0;
      const diff = prevVal ? (((cur - prevVal)/prevVal)*100).toFixed(2) : '0.00';
      const trend = diff >= 0 ? 'up' : 'down';
      const display = c.unit ? cur + c.unit : cur;
      return `<div class="stat-card grad${i+1}"><h4>${c.label}</h4><p>${display}</p><span class="compare ${trend}">${diff}%</span></div>`;
    }).join('');
    $('#kpi').html(html);
  }

  let topData=[];let topMetric='sales';
  function renderTopTable(list){topData=list;updateTopTable();}
  function updateTopTable(){
    const metric=topMetric;
    const map={sales:['conv_value','销售额'],cart:['conversions','加购数'],visitor:['clicks','访客数']};
    const [key,label]=map[metric];
    const prevKey=metric==='sales'?'prev_conv_value':metric==='cart'?'prev_conversions':'prev_clicks';
    $('#currLabel').text('本期'+label);$('#prevLabel').text('上期'+label);
    const rows=topData.slice().sort((a,b)=>(b[key]||0)-(a[key]||0)).slice(0,5).map((x,i)=>{
      const curr=x[key]||0;const prev=x[prevKey]||0;const diff=prev?((curr-prev)/prev*100).toFixed(1)+'%':'—';
      const cls=prev?((curr-prev)>=0?'pos':'neg'):'neutral';
      const name=shorten(x.product||x.path||'');
      const url=x.landing_url||x.url||'#';
      return `<tr><td>${i+1}</td><td><a href="${url}" target="_blank">${name}</a></td><td>${curr}</td><td>${prev}</td><td class="${cls}">${diff}</td><td><a href="#" class="ai-link" data-id="${name}">AI分析</a></td></tr>`;
    }).join('');
    $('#topTable tbody').html(rows||'<tr><td colspan="6" style="text-align:center">暂无数据</td></tr>');
  }

  $(document).on('click','#topTable .ai-link',function(e){
    e.preventDefault();
    const id=$(this).data('id');
    alert('AI分析功能建设中：'+id);
  });
  $(document).on('click','.top-tabs button',function(){
    $('.top-tabs button').removeClass('active');
    $(this).addClass('active');
    topMetric=$(this).data('metric');
    updateTopTable();
  });

  const tabNav=document.getElementById('analysisTabs');
  if(tabNav){
    tabNav.addEventListener('click',e=>{
      const a=e.target.closest('a[data-tab]');
      if(!a) return;
      e.preventDefault();
      tabNav.querySelectorAll('a').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      const t=a.dataset.tab;
      document.querySelectorAll('#analysis .tab-panel').forEach(p=>{
        p.style.display=p.id===t?'':'none';
      });
    });
  }

  function aggregateTable(data, showDevice, showNetwork, showCampaign){
    const map = {};
    data.forEach(r=>{
      const keyParts=[r.day, r.landing_path];
      if(showDevice) keyParts.push(r.device||'');
      if(showNetwork) keyParts.push(r.network||'');
      if(showCampaign) keyParts.push(r.campaign||'');
      const key=keyParts.join('|');
      if(!map[key]){
        map[key]={
          product:r.product,
          landing_path:r.landing_path,
          landing_url:r.landing_url,
          day:r.day,
          device: showDevice ? r.device : '',
          network: showNetwork ? r.network : '',
          campaign: showCampaign ? r.campaign : '',
          clicks:0, impr:0, cost:0, conversions:0, all_conv:0, conv_value:0
        };
      }
      const m=map[key];
      m.clicks+=r.clicks||0;
      m.impr+=r.impr||0;
      m.cost+=r.cost||0;
      m.conversions+=r.conversions||0;
      m.all_conv+=r.all_conv||0;
      m.conv_value+=r.conv_value||0;
    });
    return Object.values(map).map(m=>{
      m.ctr = m.impr>0 ? m.clicks/m.impr : 0;
      m.avg_cpc = m.clicks>0 ? m.cost/m.clicks : 0;
      m.conv_rate = m.clicks>0 ? m.conversions/m.clicks : 0;
      m.cost_per_conv = m.conversions>0 ? m.cost/m.conversions : 0;
      m.all_conv_rate = m.clicks>0 ? m.all_conv/m.clicks : 0;
      return m;
    }).sort((a,b)=> b.day.localeCompare(a.day));
  }

  function buildTable(){
    let data = rawTable;
    const net = networkSel.value;
    const camp = campaignSel.value;
    if(net) data = data.filter(r=>r.network===net);
    if(camp) data = data.filter(r=>r.campaign===camp);
    const showDevice = $('#columnMenu input[data-col=1]').prop('checked');
    const showNetwork = !!net;
    const showCampaign = !!camp;
    data = aggregateTable(data, showDevice, showNetwork, showCampaign);
    if(dt) dt.destroy();
    dt = $('#report').DataTable({
      destroy:true,
      pageLength:20,
      data,
      scrollX:true,
      fixedHeader:true,
      autoWidth:false,
      columns:[
        { data:'product', render:(v,t,r)=>{
            const name = v || r.landing_path || '';
            return `<a href="${r.landing_url}" target="_blank" class="name" title="${name}">${shorten(name)}</a>`;
          }},
        { data:'device', render: v => v || '' },
        { data:'network', render: v => v || '' },
        { data:'campaign', render: v => v || '' },
        { data:'day', render: v => v || '' },
        { data:'clicks', render: v => v ?? 0 },
        { data:'impr', render: v => v ?? 0 },
        { data:'ctr', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%' },
        { data:'avg_cpc', render: v => v ?? 0 },
        { data:'cost', render: v => v ?? 0 },
        { data:'conversions', render: v => v ?? 0 },
        { data:'cost_per_conv', render: v => v ?? 0 },
        { data:'all_conv', render: v => v ?? 0 },
        { data:'conv_value', render: v => v ?? 0 },
        { data:'all_conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%' },
        { data:'conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%' },
      ]
    });
    dt.column(1).visible(showDevice);
    dt.column(2).visible(showNetwork);
    dt.column(3).visible(showCampaign);
  }

  $('#columnMenu').on('change','input[type=checkbox]', buildTable);
  networkSel.addEventListener('change', buildTable);
  campaignSel.addEventListener('change', buildTable);

  // 默认站点取 url 参数或从示例取
  siteInput.value = getParam('site') || 'poolsvacuum.com';
  const today = new Date();
  const dow = today.getDay();
  const mondayThisWeek = new Date(today);
  mondayThisWeek.setDate(today.getDate() - ((dow + 6) % 7));
  const mondayLastWeek = new Date(mondayThisWeek);
  mondayLastWeek.setDate(mondayThisWeek.getDate() - 7);
  const sundayLastWeek = new Date(mondayLastWeek);
  sundayLastWeek.setDate(mondayLastWeek.getDate() + 6);
  const fromDef = mondayLastWeek.toISOString().slice(0,10);
  const toDef = sundayLastWeek.toISOString().slice(0,10);
  fromInput.value = getParam('from') || fromDef;
  toInput.value = getParam('to') || toDef;

  function populateFilters(){
    const nets = Array.from(new Set(rawTable.map(r=>r.network).filter(Boolean))).sort();
    networkSel.innerHTML = '<option value="">全部</option>' + nets.map(n=>`<option value="${n}">${n}</option>`).join('');
    const camps = Array.from(new Set(rawTable.map(r=>r.campaign).filter(Boolean))).sort();
    campaignSel.innerHTML = '<option value="">全部</option>' + camps.map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  async function load() {
    loadingEl.textContent = '数据加载中...';
    loadingEl.style.display = 'block';
    tableWrapper.style.display = 'none';
    try {
      const site = siteInput.value.trim();
      const from = fromInput.value;
      const to = toInput.value;
      const url = `/api/independent/stats?site=${encodeURIComponent(site)}&from=${from}&to=${to}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || '加载失败');

      rawTable = json.table || [];
      renderKPI(json.kpis || {}, json.kpis_prev || {});
      populateFilters();
      buildTable();

      // 趋势图
      const days = json.series.map(x=>x.day);
      const clicks = json.series.map(x=>x.clicks);
      const impr = json.series.map(x=>x.impr);
      const value = json.series.map(x=>x.conv_value);
      const ec = echarts.init(document.getElementById('lineChart'));
      ec.setOption({
        tooltip: { trigger: 'axis' },
        legend: { data:['Clicks','Impr.','Conv value'] },
        xAxis: { type:'category', data: days },
        yAxis: [{ type:'value', name:'Clicks / Impr' }, { type:'value', name:'Value', position:'right' }],
        series: [
          { name:'Clicks', type:'line', smooth:true, data: clicks },
          { name:'Impr.', type:'bar', data: impr },
          { name:'Conv value', type:'line', yAxisIndex:1, smooth:true, data: value },
        ]
      });

      // Top lists
      renderTopTable(json.topList || []);

      tableWrapper.style.display = '';
      loadingEl.style.display = 'none';
    } catch(e) {
      console.error(e);
      loadingEl.textContent = '加载失败';
      alert(e.message || '加载失败');
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', load);
  // 上传逻辑
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusEl = document.getElementById('uploadStatus');
  uploadBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', async () => {
    if (!fileInput.files.length) return;
    const fd = new FormData();
    fd.append('file', fileInput.files[0]);
    try {
      statusEl.textContent = '导入中...';
      uploadBtn.disabled = true;
      const resp = await fetch('/api/independent/ingest', { method: 'POST', body: fd });
      const json = await resp.json().catch(() => ({ ok:false, error:`HTTP ${resp.status}` }));
      if (!resp.ok || !json.ok) throw new Error(json.error || '上传失败');
      statusEl.textContent = '导入完成，加载中...';
      await load();
      statusEl.textContent = '完成';
      alert(`上传成功，记录数: ${json.inserted}`);
    } catch(e) {
      statusEl.textContent = `上传失败: ${e.message}`;
      alert(`上传失败: ${e.message}`);
    } finally {
      fileInput.value = '';
      uploadBtn.disabled = false;
      setTimeout(() => { statusEl.textContent = ''; }, 3000);
    }
  });
  load();
})();
</script>

<script src="assets/login.js"></script>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const userArea=document.getElementById('userArea');
  function refreshUser(){
    const u=JSON.parse(localStorage.getItem('user')||'null');
    if(u){
      userArea.innerHTML=`<div class="user-section"><div class="user-menu-trigger">${u.name}</div><div class="user-dropdown" style="display:none"><button class="user-dropdown-item" id="logoutBtn">退出</button></div></div>`;
      const trigger=userArea.querySelector('.user-menu-trigger');
      const dropdown=userArea.querySelector('.user-dropdown');
      trigger.addEventListener('click',()=>{dropdown.style.display=dropdown.style.display==='block'?'none':'block';});
      document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.removeItem('user');dropdown.style.display='none';refreshUser();showLoginOverlay();});
    }else{
      userArea.innerHTML='<div class="user-section"><span class="user-demo">未登录</span><button class="login-button" id="loginTrigger">登录</button></div>';
      document.getElementById('loginTrigger').addEventListener('click',showLoginOverlay);
      showLoginOverlay();
    }
  }
  refreshUser();
  window.addEventListener('user-login', refreshUser);
});
</script>

<script>
// populate 全托管站下拉列表
const siteListKey='managedSites';
const currentSiteKey='managedCurrentSite';
const menuEl=document.getElementById('managedMenu');
let sites=JSON.parse(localStorage.getItem(siteListKey)||'[]');
if(!sites.length) sites=['A站'];
function save(){localStorage.setItem(siteListKey,JSON.stringify(sites));}
function renderMenu(){
  if(!menuEl) return;
  menuEl.innerHTML='';
  sites.forEach((name,idx)=>{
    const li=document.createElement('li');
    const a=document.createElement('a');
    a.href='index.html';
    a.textContent=name;
    a.addEventListener('click',e=>{e.preventDefault();localStorage.setItem(currentSiteKey,name);window.location.href='index.html';});
    li.appendChild(a);menuEl.appendChild(li);
  });
}
renderMenu();
</script>

</body>
</html>
