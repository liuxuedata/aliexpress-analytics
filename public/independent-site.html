<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ç‹¬ç«‹ç«™ Â· Landing Pages æ˜ç»†</title>
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg" sizes="64x64">
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/global-theme.css">
  <style>
    #report td:first-child{ text-align:left; }
    #report td:first-child a.name{ display:inline-block; max-width:180px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    #columnToggleWrapper{ position:relative; display:inline-block; }
    #columnMenu{ display:none; position:absolute; top:100%; right:0; background:#fff; border:1px solid #ccc; padding:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    #columnMenu label{ display:block; margin:4px 0; white-space:nowrap; }
    
    /* ç¡®ä¿è¡¨æ ¼åˆ—å¯¹é½ */
    #report th, #report td {
      text-align: center;
      vertical-align: middle;
      padding: 8px 4px;
    }
    
    #report th:first-child, #report td:first-child {
      text-align: left;
    }
    
    /* æ•°å­—åˆ—å³å¯¹é½ */
    #report td:nth-child(n+5):nth-child(-n+15) {
      text-align: right;
    }
    
    /* ç™¾åˆ†æ¯”åˆ—å±…ä¸­ */
    #report td:nth-child(7), #report td:nth-child(14), #report td:nth-child(15) {
      text-align: center;
    }
    
    /* é˜²æ­¢è¡¨æ ¼å®¹å™¨å‡ºç°æ°´å¹³æ»šåŠ¨æ¡ */
    .dataTables_wrapper {
      overflow-x: hidden !important;
    }
    
    /* ç¡®ä¿è¡¨æ ¼å®½åº¦å›ºå®š */
    #report {
      width: 100% !important;
      table-layout: fixed;
    }
    
    /* å¼ºåˆ¶åˆ—å®½ */
    #report th, #report td {
      box-sizing: border-box;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* é—®å·å›¾æ ‡æ ·å¼ */
    .help-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      font-weight: bold;
      cursor: help;
      margin-left: 4px;
    }
    .help-icon:hover {
      background: #2563eb;
    }
    
    /* è¿è¥åˆ†æå›¾è¡¨å¸ƒå±€ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .panel {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .panel h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: #374151;
      text-align: center;
    }

    /* æ–°å¢ï¼šä¼˜åŒ–ç‹¬ç«‹ç«™åˆ†æé¡µé¢çš„UI */
    
    /* æ—¶é—´æ§ä»¶æ ·å¼ */
    .time-controls-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .time-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .time-controls label {
      font-weight: 600;
      color: #374151;
      min-width: 80px;
    }
    
    .time-controls .date-filter {
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      min-width: 200px;
    }
    
    .time-controls .date-filter:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .time-controls .notice {
      color: #6b7280;
      font-size: 12px;
    }
    
    /* åˆ†æé¡µé¢å®¹å™¨æ ·å¼ - ä¸è‡ªè¿è¥é¡µé¢ä¿æŒä¸€è‡´çš„ç™½åº•æ¨¡å— */
    .analysis-container {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .analysis-container h3 {
      color: #374151;
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 20px 0;
      text-align: center;
      text-shadow: none;
    }
    
    /* åˆ†æKPIå¡ç‰‡ç½‘æ ¼ */
    .analysis-kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .analysis-kpi-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .analysis-kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
    }

    /* æ¸å˜è‰²é¡¶éƒ¨æ ‡è¯† */
    .analysis-kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #ef4444);
      background-size: 200% 100%;
      animation: gradient-shift 3s ease-in-out infinite;
    }

    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .analysis-kpi-card h4 {
      color: #374151;
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .analysis-kpi-card p {
      color: #1f2937;
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    /* å›¾è¡¨ç½‘æ ¼å¸ƒå±€ */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }
    
    .chart-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 1px solid #e5e7eb;
      position: relative;
      overflow: hidden;
    }
    
    .chart-panel:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .chart-panel h3 {
      color: #374151;
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 16px 0;
      text-align: center;
      text-shadow: none;
    }
    
    /* äº§å“é€‰æ‹©å™¨æ ·å¼ */
    .product-selector {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    
    .product-selector .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .product-selector label {
      font-weight: 600;
      color: #374151;
      min-width: 60px;
    }
    
    .product-selector .sel {
      min-width: 200px;
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .product-selector .sel:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .product-selector .notice {
      color: #6b7280;
      font-size: 12px;
    }
    
    /* ç½‘ç»œé€‰æ‹©å™¨æ ·å¼ */
    .network-selector {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    
    .network-selector .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .network-selector label {
      font-weight: 600;
      color: #374151;
      min-width: 80px;
    }
    
    .network-selector .sel {
      min-width: 150px;
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .network-selector .sel:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .analysis-container {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .analysis-kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .product-selector .controls,
      .network-selector .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .product-selector .sel,
      .network-selector .sel {
        min-width: auto;
        width: 100%;
      }
    }
    
    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .analysis-container {
      animation: fadeInUp 0.6s ease-out;
    }
    
    .analysis-kpi-card {
      animation: fadeInUp 0.6s ease-out;
      animation-fill-mode: both;
    }
    
    .analysis-kpi-card:nth-child(1) { animation-delay: 0.1s; }
    .analysis-kpi-card:nth-child(2) { animation-delay: 0.2s; }
    .analysis-kpi-card:nth-child(3) { animation-delay: 0.3s; }
    .analysis-kpi-card:nth-child(4) { animation-delay: 0.4s; }
      margin: 0 0 20px 0;
      font-size: 18px;
      font-weight: 600;
      color: #374151;
    }
    
    /* DataTables åŠ è½½çŠ¶æ€æ ·å¼ */
    .dataTables_processing {
      background: rgba(255, 255, 255, 0.9) !important;
      border-radius: 8px !important;
      padding: 20px !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
    }

    /* KPIç½‘æ ¼å¸ƒå±€ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }
    
    /* å ä½å†…å®¹æ ·å¼ */
    .placeholder-content {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--primary-500);
      font-size: 0.875rem;
    }
    
    .placeholder-content p {
      margin: 0;
      font-style: italic;
    }
    
    /* äº§å“åˆ†ææ ·å¼ */
    .product-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      padding: 1rem 0;
    }
    
    .product-info-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .product-info-item label {
      font-weight: 600;
      color: var(--primary-700);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .product-info-item span,
    .product-info-item .product-url {
      color: var(--primary-800);
      font-size: 1rem;
    }
    
    .product-link {
      color: var(--brand-blue);
      text-decoration: none;
      word-break: break-all;
      line-height: 1.4;
    }
    
    .product-link:hover {
      text-decoration: underline;
      color: var(--brand-blue-dark);
    }
    
    /* äº§å“è¡Œé“¾æ¥æ ·å¼ */
    .product-row-link {
      color: var(--brand-blue);
      text-decoration: none;
      cursor: pointer;
      font-weight: 500;
    }
    
    .product-row-link:hover {
      text-decoration: underline;
      color: var(--brand-blue-dark);
    }
    
    .dataTables_processing p {
      font-size: 14px;
      margin: 0;
    }
  </style>
  <!-- DataTables & ECharts CDN -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250811-single">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="assets/site-nav.js"></script>
  <script src="assets/loading.js"></script>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
        <div class="form-subtitle">ç™»å½•è´¦æˆ·ä»¥ç»§ç»­</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">é‚®ç®±</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">å¯†ç </label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">ğŸ‘ï¸</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">ç™»å½•</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">æ¼”ç¤ºè´¦æˆ·</div>
        <div class="demo-account-info">é‚®ç®±ï¼šdemo@example.com<br>å¯†ç ï¼šdemo123</div>
      </div>
    </div>
  </div>
</div>

<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="#">é€Ÿå–é€š</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon"><a href="amazon-overview.html">äºšé©¬é€Š</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent active"><a href="#">ç‹¬ç«‹ç«™</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>

<div class="layout">
  <nav class="sidebar" id="sidebar">
    <div class="site-header">
      <div class="site-title">
        <svg class="site-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 0 20M12 2a15.3 15.3 0 0 0 0 20"/></svg>
        <span id="currentSite">ç‹¬ç«‹ç«™</span>
      </div>
    </div>
    <ul class="sub-nav">
      <li><a href="#" class="active" data-target="detail">æ˜ç»†æ•°æ®</a></li>
      <li><a href="#analysis" data-target="analysis">è¿è¥åˆ†æ</a></li>
      <li><a href="#products" data-target="products">äº§å“åˆ†æ</a></li>
    </ul>
  </nav>

  <main class="main mx-auto max-w-container px-6">
    <div class="content">
    <!-- æ§ä»¶ -->
    <section class="content-pad">
      <div class="panel">
        <div class="controls">
          <label>ç«™ç‚¹ï¼š</label>
          <input type="text" id="site" value="" placeholder="å¦‚ï¼špoolsvacuum.com">
          <span>æ—¥æœŸï¼š</span>
          <input id="dateFilter" class="date-filter" placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´">
          <label>ç½‘ç»œï¼š</label>
          <select id="networkSel"><option value="">å…¨éƒ¨</option></select>
          <label>Campaignï¼š</label>
          <select id="campaignSel"><option value="">å…¨éƒ¨</option></select>
          <button id="refreshBtn" class="btn">åˆ·æ–°</button>
          <button id="uploadBtn" class="btn">ä¸Šä¼ æ•°æ®</button>
          <input type="file" id="fileInput" accept=".xlsx,.csv" style="display:none;">
          <span id="uploadStatus" class="small"></span>
          <div id="columnToggleWrapper">
            <button id="columnToggle" class="btn">ç­›é€‰åˆ—</button>
            <div id="columnMenu" class="small"></div>
          </div>
        </div>
      </div>
    </section>
    <div id="kpi" class="kpi-grid"></div>
    <div class="divider"></div>

    <!-- è¿è¥åˆ†æ -->
    <section id="analysis" class="content-pad" style="display:none;">
      <div class="analysis-container">
        <!-- è¿è¥åˆ†æKPIå¡ç‰‡ -->
        <div id="analysisKpi" class="analysis-kpi-grid">
          <div class="analysis-kpi-card">
            <h4>å¹³å‡ç‚¹å‡»ç‡</h4>
            <p id="avgCtr">0%</p>
          </div>
          <div class="analysis-kpi-card">
            <h4>å¹³å‡è½¬åŒ–ç‡</h4>
            <p id="avgConvRate">0%</p>
          </div>
          <div class="analysis-kpi-card">
            <h4>æ›å…‰å•†å“æ€»æ•°</h4>
            <p id="exposureProducts">0</p>
          </div>
          <div class="analysis-kpi-card">
            <h4>ç‚¹å‡»å•†å“æ€»æ•°</h4>
            <p id="clickedProducts">0</p>
          </div>
          <div class="analysis-kpi-card">
            <h4>è½¬åŒ–å•†å“æ€»æ•°</h4>
            <p id="convertedProducts">0</p>
          </div>
          <div class="analysis-kpi-card">
            <h4>æœ¬å‘¨æœŸæ–°å“æ•°</h4>
            <p id="newProducts">0</p>
          </div>
        </div>
        
        <!-- å¯¹æ¯”å›¾è¡¨ -->
        <div class="charts-grid">
          <div class="chart-panel">
            <h3>äº§å“å±•ç¤ºæ€»æ•°å¯¹æ¯”</h3>
            <div id="impressionsComparisonChart" style="width:100%;height:300px;"></div>
          </div>
          <div class="chart-panel">
            <h3>CTR å¯¹æ¯”</h3>
            <div id="ctrComparisonChart" style="width:100%;height:300px;"></div>
          </div>
          <div class="chart-panel">
            <h3>è½¬åŒ–æ¬¡æ•°å¯¹æ¯”</h3>
            <div id="conversionsComparisonChart" style="width:100%;height:300px;"></div>
          </div>
          <div class="chart-panel">
            <h3>æœ‰ç‚¹å‡»å•†å“æ•°å¯¹æ¯”</h3>
            <div id="clickedProductsComparisonChart" style="width:100%;height:300px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- æ˜ç»†è¡¨ -->
    <section id="detail" class="content-pad">
      <div class="chart-container">
        <h3>Landing Pages æ˜ç»†</h3>
        
        <!-- æ•°æ®è¡¨æ ¼ -->
        <div id="detailContent">
          <table id="report" class="data-table display nowrap" style="width:100%">
            <thead>
              <tr>
                <th>äº§å“</th><th>è®¾å¤‡</th><th>ç½‘ç»œ</th><th>Campaign</th>
                <th>ç‚¹å‡»</th><th>æ›å…‰</th><th>CTR <span class="help-icon" title="CTR = æ€»ç‚¹å‡» / æ€»æ›å…‰">?</span></th><th>Avg CPC</th><th>Cost</th>
                <th>è½¬åŒ–</th><th>Cost/Conv</th><th>All conv</th><th>Conv value</th>
                <th>All conv rate <span class="help-icon" title="All conv rate = All conv / æ€»ç‚¹å‡»">?</span></th><th>Conv rate <span class="help-icon" title="Conv rate = è½¬åŒ– / æ€»ç‚¹å‡»">?</span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- äº§å“åˆ†æ -->
    <section id="products" class="content-pad" style="display:none;">
      <div class="analysis-container">
        <h3>ğŸ” äº§å“åˆ†æ</h3>

        <!-- äº§å“é€‰æ‹© -->
        <div class="time-controls-panel">
          <div class="time-controls" style="flex-wrap:nowrap;gap:12px;">
            <label>äº§å“ï¼š</label>
            <select id="productSelect" class="sel" style="width:200px;max-width:200px;white-space:nowrap;"></select>
            <a id="productLink" href="#" target="_blank" style="display:none;margin-left:8px;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></a>
            <span id="productListingDate" style="margin-left:8px;"></span>
          </div>
        </div>

        <!-- äº§å“KPIï¼ˆéšè—ï¼‰ -->
        <div id="productKpi" class="analysis-kpi-grid" style="display:none;"></div>
        
        <!-- äº§å“è¶‹åŠ¿å›¾è¡¨ -->
        <div id="productCharts" class="charts-grid" style="display:none;">
          <div>
            <div id="productClicksChart" style="width:100%;height:260px;"></div>
          </div>
          <div>
            <div id="productImpressionsChart" style="width:100%;height:260px;"></div>
          </div>
          <div>
            <div id="productCtrChart" style="width:100%;height:260px;"></div>
          </div>
          <div>
            <div id="productConversionsChart" style="width:100%;height:260px;"></div>
          </div>
        </div>
      </div>
    </section>
    </div>
  </main>
</div>

<!-- Hash è·¯ç”±è„šæœ¬ç§»åŠ¨è‡³æ–‡æœ«ä»¥ç¡®ä¿ä¾èµ–å‡½æ•°å·²å®šä¹‰ -->

<script>
function getParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}
// ç«™ç‚¹å‚æ•°ç»Ÿä¸€ä¸ºå®Œæ•´åŸŸå
function normalizeSite(site) {
  const map = {
    'poolsvacuum': 'poolsvacuum.com',
    'independent_poolsvacuum': 'poolsvacuum.com',
    'icyberite': 'icyberite.com',
    'independent_icyberite': 'icyberite.com'
  };
  return map[site] || site || '';
}

// ç‹¬ç«‹ç«™è¿è¥åˆ†ææ•°æ®åŠ è½½
async function loadIndependentAnalysisData() {
  try {
    showLoading();
    const rawSite = document.getElementById('site').value || getParam('site');
    const site = normalizeSite(rawSite);
    if (!site) {
      console.warn('æœªæŒ‡å®šç«™ç‚¹ï¼Œæ— æ³•åŠ è½½è¿è¥åˆ†ææ•°æ®');
      return;
    }

    const dateRange = getDateRange();
    const params = new URLSearchParams({
      site: site,
      from: dateRange.start,
      to: dateRange.end
    });

    // è·å–å½“å‰å‘¨æœŸæ•°æ®
    const response = await fetch(`/api/independent/stats?${params.toString()}`);
    const data = await response.json();

    if (data.ok) {
      const { table = [], kpis } = data;
      // æ›´æ–°KPIå¡ç‰‡
      updateIndependentAnalysisKPI(table, kpis);
      // æ¸²æŸ“å›¾è¡¨
      await renderIndependentAnalysisCharts(table, kpis);
    }
  } catch (error) {
    console.error('åŠ è½½ç‹¬ç«‹ç«™è¿è¥åˆ†ææ•°æ®å¤±è´¥:', error);
  } finally {
    hideLoading();
  }
}

// ç‹¬ç«‹ç«™äº§å“åˆ†ææ•°æ®åŠ è½½
async function loadIndependentProductAnalysisData() {
  try {
    showLoading();
    const rawSite = document.getElementById('site').value || getParam('site');
    const site = normalizeSite(rawSite);
    if (!site) {
      console.warn('æœªæŒ‡å®šç«™ç‚¹ï¼Œæ— æ³•åŠ è½½äº§å“åˆ†ææ•°æ®');
      return;
    }

    const dateRange = getDateRange();
    const params = new URLSearchParams({
      site: site,
      from: dateRange.start,
      to: dateRange.end,
      aggregate: 'product'
    });

    // è·å–äº§å“åˆ—è¡¨
    const response = await fetch(`/api/independent/stats?${params.toString()}`);
    const data = await response.json();

    if (data.ok) {
      populateIndependentProductSelect(data.table || []);
    }
  } catch (error) {
    console.error('åŠ è½½ç‹¬ç«‹ç«™äº§å“åˆ†ææ•°æ®å¤±è´¥:', error);
  } finally {
    hideLoading();
  }
}

// è·å–æ—¥æœŸèŒƒå›´
function getDateRange() {
  const input = document.getElementById('dateFilter');
  if (input && input.value && input.value.includes(' to ')) {
    const [start, end] = input.value.split(' to ');
    return { start, end };
  }
  const today = new Date();
  const end = today.toISOString().slice(0, 10);
  const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
  const def = `${start} to ${end}`;
  if (input) input.value = def;
  return { start, end };
}

// æ›´æ–°ç‹¬ç«‹ç«™è¿è¥åˆ†æKPI
function updateIndependentAnalysisKPI(data, kpis = {}) {
  const pct = v => `${Number(v || 0).toFixed(2)}%`;

  const avgCtrEl = document.getElementById('avgCtr');
  if (avgCtrEl) avgCtrEl.textContent = pct(kpis.avg_ctr);

  const avgConvEl = document.getElementById('avgConvRate');
  if (avgConvEl) avgConvEl.textContent = pct(kpis.avg_conv_rate);

  const exposureEl = document.getElementById('exposureProducts');
  if (exposureEl) exposureEl.textContent = (kpis.exposure_product_count || 0).toLocaleString();

  const clickEl = document.getElementById('clickedProducts');
  if (clickEl) clickEl.textContent = (kpis.click_product_count || 0).toLocaleString();

  const convEl = document.getElementById('convertedProducts');
  if (convEl) convEl.textContent = (kpis.conversion_product_count || 0).toLocaleString();

  const newEl = document.getElementById('newProducts');
  if (newEl) newEl.textContent = (kpis.new_product_count || 0).toLocaleString();
}

// æ¸²æŸ“ç‹¬ç«‹ç«™è¿è¥åˆ†æå¯¹æ¯”å›¾è¡¨
async function renderIndependentAnalysisCharts(data, kpis = {}) {
  // è·å–ä¸Šä¸€å‘¨æœŸæ•°æ®è¿›è¡Œå¯¹æ¯”
  const previousData = await getIndependentPreviousPeriodData();

  // è®¡ç®—å½“å‰å‘¨æœŸæ•°æ®
  const currentData = {
    impressions: data.reduce((sum, item) => sum + (item.impressions || item.impr || 0), 0),
    clicks: data.reduce((sum, item) => sum + (item.clicks || 0), 0),
    conversions: data.reduce((sum, item) => sum + (item.conversions || 0), 0),
    ctr: 0,
    clickedProducts: kpis.click_product_count != null
      ? kpis.click_product_count
      : new Set(data.filter(item => (item.clicks || 0) > 0).map(item => item.product)).size
  };
  currentData.ctr = currentData.impressions > 0 ? currentData.clicks / currentData.impressions * 100 : 0;

  // è®¡ç®—ä¸Šä¸€å‘¨æœŸæ•°æ®
  const previousDataCalculated = previousData ? {
    impressions: previousData.table.reduce((sum, item) => sum + (item.impressions || item.impr || 0), 0),
    clicks: previousData.table.reduce((sum, item) => sum + (item.clicks || 0), 0),
    conversions: previousData.table.reduce((sum, item) => sum + (item.conversions || 0), 0),
    ctr: 0,
    clickedProducts: previousData.kpis?.click_product_count != null
      ? previousData.kpis.click_product_count
      : new Set(previousData.table.filter(item => (item.clicks || 0) > 0).map(item => item.product)).size
  } : null;
  if (previousDataCalculated) {
    previousDataCalculated.ctr = previousDataCalculated.impressions > 0
      ? previousDataCalculated.clicks / previousDataCalculated.impressions * 100
      : 0;
  }

  // æ¸²æŸ“äº§å“å±•ç¤ºæ€»æ•°å¯¹æ¯”å›¾
  renderIndependentComparisonChart('impressionsComparisonChart',
    currentData.impressions, previousDataCalculated?.impressions || 0, 'äº§å“å±•ç¤ºæ€»æ•°');

  // æ¸²æŸ“ CTR å¯¹æ¯”å›¾
  renderIndependentComparisonChart('ctrComparisonChart',
    currentData.ctr, previousDataCalculated?.ctr || 0, 'CTR (%)');

  // æ¸²æŸ“è½¬åŒ–æ¬¡æ•°å¯¹æ¯”å›¾
  renderIndependentComparisonChart('conversionsComparisonChart',
    currentData.conversions, previousDataCalculated?.conversions || 0, 'è½¬åŒ–æ¬¡æ•°');

  // æ¸²æŸ“æœ‰ç‚¹å‡»å•†å“æ•°å¯¹æ¯”å›¾
  renderIndependentComparisonChart('clickedProductsComparisonChart',
    currentData.clickedProducts, previousDataCalculated?.clickedProducts || 0, 'æœ‰ç‚¹å‡»å•†å“æ•°');
}

// æ¸²æŸ“ç‹¬ç«‹ç«™å¯¹æ¯”æŸ±çŠ¶å›¾
function renderIndependentComparisonChart(chartId, currentValue, previousValue, label) {
  const chart = echarts.init(document.getElementById(chartId));
  const formatVal = v => label.includes('CTR') ? v.toFixed(2) + '%' : v.toLocaleString();
  const option = {
    tooltip: {
      trigger: 'axis',
      formatter: function(params) {
        const data = params[0];
        return `${data.seriesName}: ${formatVal(data.value)}`;
      }
    },
    legend: {
      data: ['å½“å‰å‘¨æœŸ', 'ä¸Šä¸€å‘¨æœŸ'],
      textStyle: { color: '#374151' }
    },
    xAxis: {
      type: 'category',
      data: ['å½“å‰å‘¨æœŸ', 'ä¸Šä¸€å‘¨æœŸ'],
      axisLabel: { color: '#374151', fontSize: 12 }
    },
    yAxis: {
      type: 'value',
      axisLabel: { color: '#374151', fontSize: 12 }
    },
    series: [
      {
        name: 'å½“å‰å‘¨æœŸ',
        data: [currentValue, null],
        type: 'bar',
        itemStyle: { color: '#3B82F6' },
        barWidth: '40%',
        label: { show: true, position: 'top', formatter: p => formatVal(p.value) }
      },
      {
        name: 'ä¸Šä¸€å‘¨æœŸ',
        data: [null, previousValue],
        type: 'bar',
        itemStyle: { color: '#10B981' },
        barWidth: '40%',
        label: { show: true, position: 'top', formatter: p => formatVal(p.value) }
      }
    ]
  };
  chart.setOption(option);
}

// è·å–ç‹¬ç«‹ç«™ä¸Šä¸€å‘¨æœŸæ•°æ®
async function getIndependentPreviousPeriodData() {
  try {
    const dateRange = getDateRange();
    const currentSite = normalizeSite(getParam('site')) || 'icyberite.com';
    
    // è®¡ç®—ä¸Šä¸€å‘¨æœŸçš„æ—¥æœŸèŒƒå›´
    const currentStart = new Date(dateRange.start);
    const currentEnd = new Date(dateRange.end);
    const periodDays = Math.ceil((currentEnd - currentStart) / (1000 * 60 * 60 * 24)) + 1;
    
    const previousEnd = new Date(currentStart);
    previousEnd.setDate(previousEnd.getDate() - 1);
    const previousStart = new Date(previousEnd);
    previousStart.setDate(previousStart.getDate() - periodDays + 1);
    
    const params = new URLSearchParams({
      site: currentSite,
      from: previousStart.toISOString().slice(0, 10),
      to: previousEnd.toISOString().slice(0, 10)
    });

    const response = await fetch(`/api/independent/stats?${params.toString()}`);

    if (response.ok) {
      const data = await response.json();
      if (data.ok) {
        return data;
      }
    }
  } catch (error) {
    console.error('è·å–ç‹¬ç«‹ç«™ä¸Šä¸€å‘¨æœŸæ•°æ®å¤±è´¥:', error);
  }

  return null;
}

// å¡«å……ç‹¬ç«‹ç«™äº§å“é€‰æ‹©å™¨
function populateIndependentProductSelect(data) {
  const productSelect = document.getElementById('productSelect');
  if (!productSelect) return;

  // æ¸…ç©ºç°æœ‰é€‰é¡¹
  productSelect.innerHTML = '<option value="">é€‰æ‹©äº§å“</option>';

  // æŒ‰æ›å…‰é‡æ’åºçš„å”¯ä¸€ landing page
  const seen = new Set();
  const list = [];
  data.forEach(item => {
    const key = item.landing_path;
    if (!key || seen.has(key)) return;
    seen.add(key);
    list.push({
      path: key,
      name: item.product || key,
      url: item.landing_url || '',
      firstSeen: item.first_seen_date || '',
      impr: item.impr || 0
    });
  });
  list.sort((a,b)=> b.impr - a.impr);

  list.forEach(p => {
    const option = document.createElement('option');
    option.value = p.path;
    option.textContent = p.name;
    option.dataset.url = p.url;
    option.dataset.firstSeen = p.firstSeen;
    productSelect.appendChild(option);
  });

  // äº§å“é€‰æ‹©äº‹ä»¶
  productSelect.addEventListener('change', function() {
    const opt = this.selectedOptions[0];
    if (opt && opt.value) {
      loadIndependentProductData(opt.value, opt.dataset.url, opt.dataset.firstSeen);
    } else {
      const linkEl = document.getElementById('productLink');
      if (linkEl) linkEl.style.display = 'none';
      const dateEl = document.getElementById('productListingDate');
      if (dateEl) dateEl.textContent = '';
      const kpiEl = document.getElementById('productKpi');
      if (kpiEl) { kpiEl.style.display = 'none'; kpiEl.innerHTML = ''; }
      const chartWrap = document.getElementById('productCharts');
      if (chartWrap) chartWrap.style.display = 'none';
    }
  });

  // é»˜è®¤é€‰æ‹©æ›å…‰é‡æœ€é«˜çš„äº§å“
  if (list.length) {
    const first = list[0];
    productSelect.value = first.path;
    loadIndependentProductData(first.path, first.url, first.firstSeen);
  }
}

// åŠ è½½ç‰¹å®šäº§å“çš„åˆ†ææ•°æ®
async function loadIndependentProductData(landingPath, landingUrl, firstSeen) {
  try {
    showLoading();
    const rawSite = document.getElementById('site').value || getParam('site');
    const site = normalizeSite(rawSite);
    if (!site) return;

    const { start, end } = getDateRange();
    const params = new URLSearchParams({ site, from: start, to: end });
    const res = await fetch(`/api/independent/stats?${params.toString()}`);
    const json = await res.json();
    if (!json.ok) return;

    const rows = (json.table || []).filter(item => item.landing_path === landingPath);
    if (!rows.length) return;

    const totalImpressions = rows.reduce((sum, r) => sum + (r.impr || r.impressions || 0), 0);
    const totalClicks = rows.reduce((sum, r) => sum + (r.clicks || 0), 0);
    const totalConversions = rows.reduce((sum, r) => sum + (r.conversions || 0), 0);
    const ctr = totalImpressions > 0 ? (totalClicks / totalImpressions * 100).toFixed(2) : '0.00';
    const kpiWrap = document.getElementById('productKpi');
    if (kpiWrap) {
      kpiWrap.innerHTML = `
        <div class="analysis-kpi-card"><h4>æ›å…‰æ€»æ•°</h4><p>${totalImpressions.toLocaleString()}</p></div>
        <div class="analysis-kpi-card"><h4>ç‚¹å‡»æ€»æ•°</h4><p>${totalClicks.toLocaleString()}</p></div>
        <div class="analysis-kpi-card"><h4>è½¬åŒ–æ€»æ•°</h4><p>${totalConversions.toLocaleString()}</p></div>
        <div class="analysis-kpi-card"><h4>CTR</h4><p>${ctr}%</p></div>`;
      kpiWrap.style.display = 'grid';
    }

    const linkEl = document.getElementById('productLink');
    if (linkEl && landingUrl) {
      linkEl.href = landingUrl;
      linkEl.textContent = landingUrl;
      linkEl.style.display = '';
    }
    const dateEl = document.getElementById('productListingDate');
    if (dateEl) dateEl.textContent = firstSeen ? `ä¸Šæ¶æ—¥æœŸï¼š${firstSeen}` : '';

    const byDay = {};
    rows.forEach(r => {
      const d = r.day;
      if (!byDay[d]) byDay[d] = { clicks: 0, impressions: 0, conversions: 0 };
      byDay[d].clicks += r.clicks || 0;
      byDay[d].impressions += r.impr || r.impressions || 0;
      byDay[d].conversions += r.conversions || 0;
    });
    // è·å–ä¸Šä¸€å‘¨æœŸæ•°æ®
    const prev = await getIndependentPreviousPeriodData();
    const prevRows = (prev?.table || []).filter(item => item.landing_path === landingPath);
    const prevByDay = {};
    prevRows.forEach(r => {
      const d = r.day;
      if (!prevByDay[d]) prevByDay[d] = { clicks: 0, impressions: 0, conversions: 0 };
      prevByDay[d].clicks += r.clicks || 0;
      prevByDay[d].impressions += r.impr || r.impressions || 0;
      prevByDay[d].conversions += r.conversions || 0;
    });

    // æ„é€ å½“å‰ä¸ä¸Šä¸€å‘¨æœŸæ—¥æœŸåºåˆ—
    const periodDays = Math.round((new Date(end) - new Date(start)) / (1000*60*60*24)) + 1;
    const dates = [];
    const currSeries = { clicks: [], impressions: [], ctr: [], conv: [] };
    const prevSeries = { clicks: [], impressions: [], ctr: [], conv: [] };
    for (let i = 0; i < periodDays; i++) {
      const currDate = new Date(start);
      currDate.setDate(currDate.getDate() + i);
      const currKey = currDate.toISOString().slice(0,10);
      dates.push(currKey);
      const curr = byDay[currKey] || { clicks:0, impressions:0, conversions:0 };
      currSeries.clicks.push(curr.clicks);
      currSeries.impressions.push(curr.impressions);
      currSeries.ctr.push(curr.impressions>0 ? +(curr.clicks/curr.impressions*100).toFixed(2) : 0);
      currSeries.conv.push(curr.conversions);

      const prevDate = new Date(start);
      prevDate.setDate(prevDate.getDate() - periodDays + i);
      const prevKey = prevDate.toISOString().slice(0,10);
      const prevDay = prevByDay[prevKey] || { clicks:0, impressions:0, conversions:0 };
      prevSeries.clicks.push(prevDay.clicks);
      prevSeries.impressions.push(prevDay.impressions);
      prevSeries.ctr.push(prevDay.impressions>0 ? +(prevDay.clicks/prevDay.impressions*100).toFixed(2) : 0);
      prevSeries.conv.push(prevDay.conversions);
    }

    const chartWrap = document.getElementById('productCharts');
    chartWrap.style.display = 'grid';

    renderComparisonLineChart('productClicksChart', 'ç‚¹å‡»è¶‹åŠ¿', dates, currSeries.clicks, prevSeries.clicks);
    renderComparisonLineChart('productImpressionsChart', 'æ›å…‰è¶‹åŠ¿', dates, currSeries.impressions, prevSeries.impressions);
    renderComparisonLineChart('productCtrChart', 'CTRè¶‹åŠ¿', dates, currSeries.ctr, prevSeries.ctr);
    renderComparisonLineChart('productConversionsChart', 'è½¬åŒ–è¶‹åŠ¿', dates, currSeries.conv, prevSeries.conv);
  } catch (err) {
    console.error('åŠ è½½ç‹¬ç«‹ç«™äº§å“æ•°æ®å¤±è´¥:', err);
  } finally {
    hideLoading();
  }
}

function renderComparisonLineChart(id, title, dates, current, previous) {
  const el = document.getElementById(id);
  const chart = echarts.init(el);
  chart.setOption({
    title: { text: title, left: 'center', textStyle: { color: '#374151', fontSize: 16 } },
    tooltip: { trigger: 'axis' },
    legend: { data: ['å½“å‰å‘¨æœŸ','ä¸Šä¸€å‘¨æœŸ'] },
    xAxis: { type: 'category', data: dates },
    yAxis: { type: 'value' },
    series: [
      { name: 'å½“å‰å‘¨æœŸ', type: 'line', smooth: true, data: current, itemStyle: { color: '#3b82f6' } },
      { name: 'ä¸Šä¸€å‘¨æœŸ', type: 'line', smooth: true, data: previous, itemStyle: { color: '#9ca3af' } }
    ]
  });
  new ResizeObserver(() => chart.resize()).observe(el);
}

// é¡µé¢é€»è¾‘ï¼šæ‹‰å– /api/independent/stats
(function(){
  const shorten=(s,l=30)=>{if(!s) return '';return s.length>l?s.slice(0,l)+'â€¦':s;};
  const siteInput = document.getElementById('site');
  const fromInput = document.getElementById('from');
  const toInput = document.getElementById('to');
  const columnMenu = document.getElementById('columnMenu');
  const columnToggle = document.getElementById('columnToggle');
  const networkSel = document.getElementById('networkSel');
  const campaignSel = document.getElementById('campaignSel');
  const optionalCols = [
    { idx:1, label:'è®¾å¤‡' }
  ];
  optionalCols.forEach(c=>{
    const lab=document.createElement('label');
    lab.innerHTML=`<input type="checkbox" data-col="${c.idx}"> ${c.label}`;
    columnMenu.appendChild(lab);
  });
  columnToggle.addEventListener('click',()=>{
    columnMenu.style.display = columnMenu.style.display==='block' ? 'none' : 'block';
  });
  let dt;
  let rawTable = [];

  function card(title,val){
    return `<div class="stat-card"><h4>${title}</h4><p>${val}</p></div>`;
  }
  function renderKPI(k){
    const kpiEl = document.getElementById('kpi');
    if (!kpiEl) return;
    
    const cards = [
      { 
        title: 'å¹³å‡ç‚¹å‡»ç‡', 
        value: (k.avg_ctr || 0).toFixed(2) + '%', 
        type: 'info'
      },
      { 
        title: 'å¹³å‡è½¬åŒ–ç‡', 
        value: (k.avg_conv_rate || 0).toFixed(2) + '%', 
        type: 'success'
      },
      { 
        title: 'æ›å…‰å•†å“æ€»æ•°', 
        value: k.exposure_product_count || 0, 
        type: 'success'
      },
      { 
        title: 'ç‚¹å‡»å•†å“æ€»æ•°', 
        value: k.click_product_count || 0, 
        type: 'info'
      },
      { 
        title: 'è½¬åŒ–å•†å“æ€»æ•°', 
        value: k.conversion_product_count || 0, 
        type: 'danger'
      },
      { 
        title: 'æœ¬å‘¨æœŸæ–°å“æ•°', 
        value: k.new_product_count || 0, 
        type: 'warning'
      }
    ];
    
    kpiEl.innerHTML = cards.map(card => `
      <div class="kpi-card ${card.type}">
        <h4>${card.title}</h4>
        <p>${card.value}</p>
      </div>
    `).join('');
  }

  function aggregateTable(data, showDevice, showNetwork, showCampaign){
    // å®‰å…¨å¤„ç†ç©ºæ•°æ®
    if (!data || !Array.isArray(data) || data.length === 0) {
      return [];
    }
    
    const map = {};
    data.forEach(r=>{
      const keyParts=[r.day, r.landing_path];
      if(showDevice) keyParts.push(r.device||'');
      if(showNetwork) keyParts.push(r.network||'');
      if(showCampaign) keyParts.push(r.campaign||'');
      const key=keyParts.join('|');
      if(!map[key]){
        map[key]={
          product:r.product,
          landing_path:r.landing_path,
          landing_url:r.landing_url,
          day:r.day,
          device: showDevice ? r.device : '',
          network: showNetwork ? r.network : '',
          campaign: showCampaign ? r.campaign : '',
          clicks:0, impr:0, cost:0, conversions:0, all_conv:0, conv_value:0
        };
      }
      const m=map[key];
      m.clicks+=r.clicks||0;
      m.impr+=r.impr||0;
      m.cost+=r.cost||0;
      m.conversions+=r.conversions||0;
      m.all_conv+=r.all_conv||0;
      m.conv_value+=r.conv_value||0;
    });
    return Object.values(map).map(m=>{
      m.ctr = m.impr>0 ? m.clicks/m.impr : 0;
      m.avg_cpc = m.clicks>0 ? m.cost/m.clicks : 0;
      m.conv_rate = m.clicks>0 ? m.conversions/m.clicks : 0;
      m.cost_per_conv = m.conversions>0 ? m.cost/m.conversions : 0;
      m.all_conv_rate = m.clicks>0 ? m.all_conv/m.clicks : 0;
      return m;
    }).sort((a,b)=> {
      // å®‰å…¨æ’åºï¼Œå¤„ç†undefinedå€¼
      const dayA = a.day || '';
      const dayB = b.day || '';
      return dayB.localeCompare(dayA);
    });
  }

  function buildTable(){
    // å®‰å…¨å¤„ç†ç©ºæ•°æ®
    if (!rawTable || !Array.isArray(rawTable) || rawTable.length === 0) {
      if(dt) dt.destroy();
      dt = $('#report').DataTable({
        destroy:true,
        pageLength:20,
        data: [],
        scrollX: false,
        fixedHeader:true,
        autoWidth: true,
        processing: true,
        responsive: false,
        columns:[
                  { data:'product', render:(v,t,r)=>{
            const name = v || r.landing_path || '';
            return `<a href="${r.landing_url}" target="_blank" class="name" title="${name}">${shorten(name)}</a>`;
          }, width: '200px' },
          { data:'device', render: v => v || '', width: '80px' },
          { data:'network', render: v => v || '', width: '100px' },
          { data:'campaign', render: v => v || '', width: '120px' },
          { data:'clicks', render: v => v ?? 0, width: '80px' },
          { data:'impr', render: v => v ?? 0, width: '80px' },
          { data:'ctr', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%', width: '80px' },
          { data:'avg_cpc', render: v => (v ?? 0).toFixed(2), width: '100px' },
          { data:'cost', render: v => (v ?? 0).toFixed(2), width: '100px' },
          { data:'conversions', render: v => v ?? 0, width: '80px' },
          { data:'cost_per_conv', render: v => (v ?? 0).toFixed(2), width: '100px' },
          { data:'all_conv', render: v => v ?? 0, width: '80px' },
          { data:'conv_value', render: v => (v ?? 0).toFixed(2), width: '100px' },
          { data:'all_conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%', width: '120px' },
          { data:'conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%', width: '100px' }
        ]
      });
      
      // é»˜è®¤éšè—ç­›é€‰åˆ—
      dt.column(1).visible(false); // è®¾å¤‡åˆ—
      dt.column(2).visible(false); // ç½‘ç»œåˆ—
      dt.column(3).visible(false); // Campaignåˆ—
      
      // å¼ºåˆ¶é‡æ–°è®¡ç®—åˆ—å®½ï¼Œç¡®ä¿å¯¹é½
      setTimeout(() => {
        dt.columns.adjust();
        dt.fixedHeader.adjust();
      }, 100);
      
      return;
    }
    
    let data = rawTable;
    const net = networkSel.value;
    const camp = campaignSel.value;
    if(net) data = data.filter(r=>r.network===net);
    if(camp) data = data.filter(r=>r.campaign===camp);
    const showDevice = $('#columnMenu input[data-col=1]').prop('checked');
    const showNetwork = !!net;
    const showCampaign = !!camp;
    data = aggregateTable(data, showDevice, showNetwork, showCampaign);
    if(dt) dt.destroy();
    dt = $('#report').DataTable({
      destroy:true,
      pageLength:20,
      data,
      scrollX: false,
      fixedHeader:true,
      autoWidth: true,
      processing: true,
      responsive: false,
      columns:[
        { data:'product', render:(v,t,r)=>{
            const name = v || r.landing_path || '';
            return `<a href="${r.landing_url}" target="_blank" class="name" title="${name}">${shorten(name)}</a>`;
          }, width: '200px' },
        { data:'device', render: v => v || '', width: '80px' },
        { data:'network', render: v => v || '', width: '100px' },
        { data:'campaign', render: v => v || '', width: '120px' },
        { data:'clicks', render: v => v ?? 0, width: '80px' },
        { data:'impr', render: v => v ?? 0, width: '80px' },
        { data:'ctr', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%', width: '80px' },
        { data:'avg_cpc', render: v => (v ?? 0).toFixed(2), width: '100px' },
        { data:'cost', render: v => (v ?? 0).toFixed(2), width: '100px' },
        { data:'conversions', render: v => v ?? 0, width: '80px' },
        { data:'cost_per_conv', render: v => (v ?? 0).toFixed(2), width: '100px' },
        { data:'all_conv', render: v => v ?? 0, width: '80px' },
        { data:'conv_value', render: v => (v ?? 0).toFixed(2), width: '100px' },
        { data:'all_conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%', width: '120px' },
        { data:'conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%', width: '100px' }
      ]
    });
    // é»˜è®¤éšè—ç­›é€‰åˆ—ï¼Œåªä½œä¸ºç­›é€‰æ¡ä»¶
    dt.column(1).visible(false); // è®¾å¤‡åˆ—é»˜è®¤éšè—
    dt.column(2).visible(false); // ç½‘ç»œåˆ—é»˜è®¤éšè—
    dt.column(3).visible(false); // Campaignåˆ—é»˜è®¤éšè—
    
    // æ ¹æ®ç­›é€‰æ¡ä»¶æ˜¾ç¤ºåˆ—
    if (showDevice) dt.column(1).visible(true);
    if (showNetwork) dt.column(2).visible(true);
    if (showCampaign) dt.column(3).visible(true);
    
    // å¼ºåˆ¶é‡æ–°è®¡ç®—åˆ—å®½ï¼Œç¡®ä¿å¯¹é½
    setTimeout(() => {
      dt.columns.adjust();
      dt.fixedHeader.adjust();
    }, 100);
  }

  $('#columnMenu').on('change','input[type=checkbox]', buildTable);
  networkSel.addEventListener('change', buildTable);
  campaignSel.addEventListener('change', buildTable);

  // è·å–å½“å‰é€‰ä¸­çš„ç‹¬ç«‹ç«™ç«™ç‚¹ID
  let currentIndepSiteId = localStorage.getItem('currentIndepSite');
  let currentIndepSiteName = localStorage.getItem('currentIndepSiteName');
  
  // æ›´æ–°ç«™ç‚¹åç§°æ˜¾ç¤º
  function updateSiteDisplay() {
    const currentSiteEl = document.getElementById('currentSite');
    if (currentSiteEl) {
      // é‡æ–°è·å–æœ€æ–°çš„localStorageå€¼
      const latestSiteId = localStorage.getItem('currentIndepSite');
      const latestSiteName = localStorage.getItem('currentIndepSiteName');

      if (latestSiteName) {
        const display = normalizeSite(latestSiteName);
        currentSiteEl.textContent = display;
        console.log('ç‹¬ç«‹ç«™é¡µé¢æ›´æ–°ç«™ç‚¹åç§°:', display);
      } else if (latestSiteId) {
        const displayName = normalizeSite(latestSiteId) || 'ç‹¬ç«‹ç«™';
        currentSiteEl.textContent = displayName;
        console.log('ç‹¬ç«‹ç«™é¡µé¢æ›´æ–°ç«™ç‚¹åç§°:', displayName);
      } else {
        // ä»URLå‚æ•°è·å–ç«™ç‚¹åç§°
        const urlParams = new URLSearchParams(window.location.search);
        const siteParam = urlParams.get('site');
        if (siteParam) {
          const display = normalizeSite(siteParam);
          currentSiteEl.textContent = display;
          console.log('ç‹¬ç«‹ç«™é¡µé¢ä»URLå‚æ•°è·å–ç«™ç‚¹åç§°:', display);
        } else {
          currentSiteEl.textContent = 'poolsvacuum.com';
          console.log('ç‹¬ç«‹ç«™é¡µé¢ä½¿ç”¨é»˜è®¤åç§°: poolsvacuum.com');
        }
      }
    }
  }
  
  // è·å–å½“å‰ç«™ç‚¹åç§°ç”¨äºAPIè°ƒç”¨
  function getCurrentSiteForAPI() {
    const currentIndepSiteId = localStorage.getItem('currentIndepSite');
    const currentIndepSiteName = localStorage.getItem('currentIndepSiteName');

    // å¦‚æœæœ‰ç«™ç‚¹åç§°ï¼Œä½¿ç”¨ç«™ç‚¹åç§°ï¼ˆè¿™æ˜¯æ•°æ®åº“ä¸­çš„siteå­—æ®µå€¼ï¼‰
    if (currentIndepSiteName) {
      return normalizeSite(currentIndepSiteName);
    }

    // å¦‚æœæœ‰ç«™ç‚¹IDï¼Œæ ¹æ®IDæ˜ å°„åˆ°ç«™ç‚¹åç§°
    if (currentIndepSiteId) {
      return normalizeSite(currentIndepSiteId) || 'poolsvacuum.com';
    }

    // ä»URLå‚æ•°è·å–
    const urlParams = new URLSearchParams(window.location.search);
    const siteParam = urlParams.get('site');
    if (siteParam) {
      return normalizeSite(siteParam);
    }
    
    // é»˜è®¤å€¼
    return 'poolsvacuum.com';
  }
  
  // é»˜è®¤ç«™ç‚¹å– url å‚æ•°ã€å½“å‰é€‰ä¸­çš„ç«™ç‚¹æˆ–ä»ç¤ºä¾‹å–
  siteInput.value = normalizeSite(getParam('site')) || getCurrentSiteForAPI();
  
  // åˆå§‹åŒ–ç«™ç‚¹åç§°æ˜¾ç¤º
  updateSiteDisplay();
  
  // ç›‘å¬localStorageå˜åŒ–ï¼Œå®æ—¶æ›´æ–°ç«™ç‚¹åç§°
  window.addEventListener('storage', (e) => {
    if (e.key === 'currentIndepSite' || e.key === 'currentIndepSiteName') {
      updateSiteDisplay();
      // åŒæ—¶æ›´æ–°è¾“å…¥æ¡†çš„å€¼
      siteInput.value = getCurrentSiteForAPI();
    }
  });
  
  // å®šæœŸæ£€æŸ¥ç«™ç‚¹åç§°å˜åŒ–ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
  setInterval(() => {
    const newSiteId = localStorage.getItem('currentIndepSite');
    const newSiteName = localStorage.getItem('currentIndepSiteName');
    if (newSiteId !== currentIndepSiteId || newSiteName !== currentIndepSiteName) {
      updateSiteDisplay();
      siteInput.value = getCurrentSiteForAPI();
    }
  }, 1000);
  
  // åˆå§‹åŒ–ç»Ÿä¸€çš„æ—¶é—´æ§ä»¶
  const fp = flatpickr('#dateFilter', { 
    mode: 'range', 
    dateFormat: 'Y-m-d', 
    onClose: (ds) => {
      if (ds.length === 2) {
        load();
      }
    }
  });
  
  // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ€è¿‘7å¤©ï¼‰
  const today = new Date();
  const end = today.toISOString().slice(0,10);
  const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0,10);
  const def = `${start} to ${end}`;
  $('#dateFilter').val(def);
  window.fp = fp;
  function parseDateRange() {
    const input = document.getElementById('dateFilter');
    if (input && input.value && input.value.includes(' to ')) {
      const [s, e] = input.value.split(' to ');
      return { from: s, to: e };
    }
    const today = new Date();
    const to = today.toISOString().slice(0,10);
    const from = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0,10);
    return { from, to };
  }

  function populateFilters(){
    // å®‰å…¨å¤„ç†ç©ºæ•°æ®
    if (!rawTable || !Array.isArray(rawTable) || rawTable.length === 0) {
      networkSel.innerHTML = '<option value="">å…¨éƒ¨</option>';
      campaignSel.innerHTML = '<option value="">å…¨éƒ¨</option>';
      return;
    }
    
    const nets = Array.from(new Set(rawTable.map(r=>r.network).filter(Boolean))).sort();
    networkSel.innerHTML = '<option value="">å…¨éƒ¨</option>' + nets.map(n=>`<option value="${n}">${n}</option>`).join('');
    const camps = Array.from(new Set(rawTable.map(r=>r.campaign).filter(Boolean))).sort();
    campaignSel.innerHTML = '<option value="">å…¨éƒ¨</option>' + camps.map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  // æ¸²æŸ“åˆ†æå›¾è¡¨
  function renderAnalysisCharts(data) {
    try {
      // å‘¨æœŸå¯¹æ¯”æŸ±çŠ¶å›¾
      renderCompareBarChart(data);
      
      // ç‚¹å‡»ç‡è¶‹åŠ¿å›¾
      renderCTRTrendChart(data);
      
      // è½¬åŒ–ç‡è¶‹åŠ¿å›¾
      renderConvTrendChart(data);
    } catch (error) {
      console.error('æ¸²æŸ“åˆ†æå›¾è¡¨å¤±è´¥:', error);
    }
  }

  // æ¸²æŸ“å‘¨æœŸå¯¹æ¯”æŸ±çŠ¶å›¾
  function renderCompareBarChart(data) {
    const current = data.kpis || {};
    const previous = data.previous?.kpis || {};
    
    const chart = echarts.init(document.getElementById('compareBar'));
    chart.setOption({
      tooltip: { trigger: 'axis' },
      legend: { data: ['æœ¬å‘¨æœŸ', 'ä¸Šä¸€å‘¨æœŸ'] },
      xAxis: { 
        type: 'category', 
        data: ['æ›å…‰é‡', 'ç‚¹å‡»é‡', 'è½¬åŒ–æ¬¡æ•°', 'è½¬åŒ–å•†å“æ•°'] 
      },
      yAxis: { type: 'value' },
      series: [
        {
          name: 'æœ¬å‘¨æœŸ',
          type: 'bar',
          data: [
            current.exposure_product_count || 0,
            current.click_product_count || 0,
            current.conversion_count || 0,
            current.conversion_product_count || 0
          ],
          itemStyle: { color: '#3b82f6' }
        },
        {
          name: 'ä¸Šä¸€å‘¨æœŸ',
          type: 'bar',
          data: [
            previous.exposure_product_count || 0,
            previous.click_product_count || 0,
            previous.conversion_count || 0,
            previous.conversion_product_count || 0
          ],
          itemStyle: { color: '#10b981' }
        }
      ]
    });
  }

  // æ¸²æŸ“ç‚¹å‡»ç‡è¶‹åŠ¿å›¾
  function renderCTRTrendChart(data) {
    const current = data.series || [];
    const previous = data.previous?.series || [];
    
    const chart = echarts.init(document.getElementById('ctrChart'));
    chart.setOption({
      tooltip: { trigger: 'axis' },
      legend: { data: ['æœ¬å‘¨æœŸ', 'ä¸Šä¸€å‘¨æœŸ'] },
      xAxis: { 
        type: 'category', 
        data: current.map(x => x.day) 
      },
      yAxis: { 
        type: 'value',
        axisLabel: {
          formatter: function(value) {
            return (value * 100).toFixed(2) + '%';
          }
        }
      },
      series: [
        {
          name: 'æœ¬å‘¨æœŸ',
          type: 'line',
          smooth: true,
          data: current.map(x => x.ctr || 0),
          itemStyle: { color: '#3b82f6' }
        },
        {
          name: 'ä¸Šä¸€å‘¨æœŸ',
          type: 'line',
          smooth: true,
          data: previous.map(x => x.ctr || 0),
          itemStyle: { color: '#10b981' }
        }
      ]
    });
  }

  // æ¸²æŸ“è½¬åŒ–ç‡è¶‹åŠ¿å›¾
  function renderConvTrendChart(data) {
    const current = data.series || [];
    const previous = data.previous?.series || [];
    
    const chart = echarts.init(document.getElementById('convChart'));
    chart.setOption({
      tooltip: { trigger: 'axis' },
      legend: { data: ['æœ¬å‘¨æœŸ', 'ä¸Šä¸€å‘¨æœŸ'] },
      xAxis: { 
        type: 'category', 
        data: current.map(x => x.day) 
      },
      yAxis: { 
        type: 'value',
        axisLabel: {
          formatter: function(value) {
            return (value * 100).toFixed(2) + '%';
          }
        }
      },
      series: [
        {
          name: 'æœ¬å‘¨æœŸ',
          type: 'line',
          smooth: true,
          data: current.map(x => x.conv_rate || 0),
          itemStyle: { color: '#ef4444' }
        },
        {
          name: 'ä¸Šä¸€å‘¨æœŸ',
          type: 'line',
          smooth: true,
          data: previous.map(x => x.conv_rate || 0),
          itemStyle: { color: '#f59e0b' }
        }
      ]
    });
  }

  async function load() {
    try {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showLoading();
      
      const siteName = siteInput.value.trim();
      
      // è§£ææ—¥æœŸèŒƒå›´
      const dateRange = parseDateRange();
      const from = dateRange.from;
      const to = dateRange.to;
      
      // ä½¿ç”¨æ–°çš„ç«™ç‚¹å‚æ•°è·å–é€»è¾‘
      const siteParam = getCurrentSiteForAPI();
      
      console.log('ç‹¬ç«‹ç«™æŸ¥è¯¢å‚æ•°:', { siteName, siteParam, from, to });
      
      // è·å–å½“å‰å‘¨æœŸæ•°æ®
      const currentUrl = `/api/independent/stats?site=${encodeURIComponent(siteParam)}&from=${from}&to=${to}&aggregate=product`;
      
      // è®¡ç®—ä¸Šä¸€å‘¨æœŸæ—¥æœŸèŒƒå›´
      const currentFrom = new Date(from);
      const currentTo = new Date(to);
      const daysDiff = Math.ceil((currentTo - currentFrom) / (1000 * 60 * 60 * 24));
      
      const prevTo = new Date(currentFrom);
      prevTo.setDate(prevTo.getDate() - 1);
      const prevFrom = new Date(prevTo);
      prevFrom.setDate(prevFrom.getDate() - daysDiff + 1);
      
      const prevFromStr = prevFrom.toISOString().slice(0, 10);
      const prevToStr = prevTo.toISOString().slice(0, 10);
      
      console.log('å¯¹æ¯”å‘¨æœŸ:', { current: `${from} to ${to}`, previous: `${prevFromStr} to ${prevToStr}` });
      
      // å¹¶è¡Œè·å–ä¸¤ä¸ªå‘¨æœŸçš„æ•°æ®
      const [currentRes, prevRes] = await Promise.all([
        fetch(currentUrl),
        fetch(`/api/independent/stats?site=${encodeURIComponent(siteParam)}&from=${prevFromStr}&to=${prevToStr}&aggregate=product`)
      ]);
      
      if (!currentRes.ok) throw new Error(`å½“å‰å‘¨æœŸ HTTP ${currentRes.status}`);
      if (!prevRes.ok) throw new Error(`ä¸Šä¸€å‘¨æœŸ HTTP ${prevRes.status}`);
      
      const currentJson = await currentRes.json();
      const prevJson = await prevRes.json();
      
      if (!currentJson.ok) throw new Error(currentJson.error || 'å½“å‰å‘¨æœŸåŠ è½½å¤±è´¥');
      if (!prevJson.ok) throw new Error(prevJson.error || 'ä¸Šä¸€å‘¨æœŸåŠ è½½å¤±è´¥');

      // åˆå¹¶æ•°æ®
      const json = {
        ...currentJson,
        previous: prevJson
      };

      rawTable = json.table || [];
      renderKPI(json.kpis || {});
      populateFilters();
      buildTable();

      // æ¸²æŸ“å¯¹æ¯”å›¾è¡¨
      renderAnalysisCharts(json);
      
      // Top landing pages
      const topRows = json.topList.map(r => [
        shorten(r.product || r.path), r.clicks, r.impr, (r.ctr*100).toFixed(2)+'%', r.conversions, r.cost, r.conv_value, r.cpa.toFixed(2), r.roas.toFixed(2)
      ]);
      $('#topTable').DataTable({ destroy:true, paging:false, searching:false, info:false, data: topRows, scrollX:true, autoWidth:false });
      
      // éšè—åŠ è½½çŠ¶æ€
      hideLoading();
      
      // ç§»é™¤äº§å“è¡Œç‚¹å‡»äº‹ä»¶ç»‘å®šï¼Œå› ä¸ºäº§å“åˆ†æåŠŸèƒ½å·²ç§»è‡³å¤–éƒ¨é¡µé¢
    } catch(e) {
      console.error(e);
      alert(e.message || 'åŠ è½½å¤±è´¥');
      // éšè—åŠ è½½çŠ¶æ€
      hideLoading();
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', () => {
    // ä¿å­˜å½“å‰æ—¥æœŸèŒƒå›´åˆ°localStorage
    const refreshSiteId = localStorage.getItem('currentIndepSite') || 'independent_poolsvacuum';
    const indepPeriodKey = `indepPeriod_${refreshSiteId}`;
    const dateFilter = document.getElementById('dateFilter');
    if (dateFilter && dateFilter.value) {
      localStorage.setItem(indepPeriodKey, dateFilter.value);
    }
    load();
  });
  // ä¸Šä¼ é€»è¾‘
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusEl = document.getElementById('uploadStatus');
  uploadBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', async () => {
    if (!fileInput.files.length) return;
    
    const file = fileInput.files[0];
    if (!file) {
      alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
      return;
    }
    
    const fd = new FormData();
    fd.append('file', file);
    
    // è·å–å½“å‰ç«™ç‚¹ä¿¡æ¯
    const uploadSiteId = localStorage.getItem('currentIndepSite');
    const currentSiteName = getCurrentSiteForAPI();
    console.log('æ–‡ä»¶ä¸Šä¼  - å½“å‰ç‹¬ç«‹ç«™ç«™ç‚¹ID:', uploadSiteId);
    console.log('æ–‡ä»¶ä¸Šä¼  - å½“å‰ç«™ç‚¹åç§°:', currentSiteName);
    console.log('æ–‡ä»¶ä¿¡æ¯:', { name: file.name, size: file.size, type: file.type });
    
    try {
      statusEl.textContent = 'å¯¼å…¥ä¸­...';
      uploadBtn.disabled = true;
      
      // æ ¹æ®ç«™ç‚¹IDé€‰æ‹©æ­£ç¡®çš„API
      let apiUrl = '/api/independent/ingest'; // é»˜è®¤Google Ads API
      
      // å¦‚æœæ˜¯icyberite.comï¼Œä½¿ç”¨Facebook Ads API
      if (uploadSiteId === 'independent_icyberite') {
        apiUrl = '/api/independent/facebook-ingest';
        console.log('ä½¿ç”¨Facebook Ads API:', apiUrl);
      } else {
        console.log('ä½¿ç”¨Google Ads API:', apiUrl);
      }
      
      const headers = {};
      if (uploadSiteId) {
        headers['X-Site-ID'] = uploadSiteId;
      }
      // æ·»åŠ ç«™ç‚¹åç§°å¤´ï¼Œç”¨äºæ•°æ®å¯¼å…¥
      headers['X-Site-Name'] = currentSiteName;
      
      const resp = await fetch(apiUrl, { 
        method: 'POST', 
        body: fd,
        headers: headers
      });
      
      if (!resp.ok) {
        const errorText = await resp.text();
        throw new Error(`HTTP ${resp.status}: ${errorText}`);
      }
      
      const json = await resp.json().catch(() => ({ ok:false, error:`HTTP ${resp.status}` }));
      if (!json.ok) throw new Error(json.error || 'ä¸Šä¼ å¤±è´¥');
      
      statusEl.textContent = 'å¯¼å…¥å®Œæˆï¼ŒåŠ è½½ä¸­...';
      await load();
      statusEl.textContent = 'å®Œæˆ';
      alert(`ä¸Šä¼ æˆåŠŸï¼Œè®°å½•æ•°: ${json.inserted}`);
    } catch(e) {
      console.error('ä¸Šä¼ é”™è¯¯:', e);
      statusEl.textContent = `ä¸Šä¼ å¤±è´¥: ${e.message}`;
      alert(`ä¸Šä¼ å¤±è´¥: ${e.message}`);
    } finally {
      fileInput.value = '';
      uploadBtn.disabled = false;
      setTimeout(() => { statusEl.textContent = ''; }, 3000);
    }
  });
  
  // ç¡®ä¿æ‰€æœ‰å‡½æ•°å®šä¹‰å®Œæˆåå†è°ƒç”¨load
  setTimeout(() => {
    if (typeof load === 'function') {
      try {
        load();
      } catch (error) {
        console.error('loadå‡½æ•°æ‰§è¡Œé”™è¯¯:', error);
      }
    } else {
      console.error('loadå‡½æ•°æœªå®šä¹‰');
    }
  }, 1000);
})();
</script>

<script>
// å»¶è¿Ÿæ‰§è¡ŒHashè·¯ç”±é€»è¾‘ï¼Œç¡®ä¿æ•°æ®åŠ è½½å‡½æ•°å·²å®šä¹‰
document.addEventListener('DOMContentLoaded', () => {
  function handleHashRoute() {
    const hash = window.location.hash.slice(1) || 'detail';
    const link = document.querySelector(`[data-target="${hash}"]`);
    if (link) {
      document.querySelectorAll('.sub-nav a').forEach(x => x.classList.remove('active'));
      link.classList.add('active');

      ['detail', 'analysis', 'products'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = (id === hash ? '' : 'none');
      });

      const kpiBlock = document.getElementById('kpi');
      if (kpiBlock) kpiBlock.style.display = (hash === 'detail') ? '' : 'none';

      if (hash === 'analysis') {
        loadIndependentAnalysisData();
      } else if (hash === 'products') {
        loadIndependentProductAnalysisData();
      }

      setTimeout(() => window.dispatchEvent(new Event('resize')), 0);
    }
  }

  window.addEventListener('hashchange', handleHashRoute);
  handleHashRoute();

  document.querySelectorAll('.sub-nav a').forEach(a => {
    a.addEventListener('click', e => {
      const target = a.dataset.target;
      if (target) {
        e.preventDefault();
        window.location.hash = target;
      }
    });
  });
});
</script>

<script src="assets/login.js"></script>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  // ç§»é™¤æ—§çš„ç¡¬ç¼–ç ç«™ç‚¹é€»è¾‘ï¼Œç°åœ¨ä½¿ç”¨ç»Ÿä¸€çš„site-nav.js
  // ç«™ç‚¹èœå•ç”±site-nav.jsç»Ÿä¸€ç®¡ç†
  const userArea=document.getElementById('userArea');
  function refreshUser(){
    const u=JSON.parse(localStorage.getItem('user')||'null');
    if(u){
      userArea.innerHTML=`<div class="user-section"><div class="user-menu-trigger">${u.name}</div><div class="user-dropdown" style="display:none"><button class="user-dropdown-item" id="logoutBtn">é€€å‡º</button></div></div>`;
      const trigger=userArea.querySelector('.user-menu-trigger');
      const dropdown=userArea.querySelector('.user-dropdown');
      trigger.addEventListener('click',()=>{dropdown.style.display=dropdown.style.display==='block'?'none':'block';});
      document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.removeItem('user');dropdown.style.display='none';refreshUser();showLoginOverlay();});
    }else{
      userArea.innerHTML='<div class="user-section"><span class="user-demo">æœªç™»å½•</span><button class="login-button" id="loginTrigger">ç™»å½•</button></div>';
      document.getElementById('loginTrigger').addEventListener('click',showLoginOverlay);
      showLoginOverlay();
    }
  }
  refreshUser();
  window.addEventListener('user-login', refreshUser);
});
</script>

</body>
</html>
