<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>独立站数据分析</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
<link rel="stylesheet" href="assets/theme.css?v=20250810b">
</head>
<body>
<div class="container">
  <nav class="sidebar" id="sidebar">
    <h3>产品导航</h3>
    <ul>
      <li class="has-submenu">
        <a href="#">速卖通</a>
        <ul class="submenu">
          <li><a href="index.html">全托管</a></li>
          <li><a href="self-operated.html">自运营</a></li>
        </ul>
      </li>
      <li><a href="#">TikTok Shop</a></li>
      <li><a href="#">亚马逊</a></li>
      <li class="has-submenu">
        <a href="#">独立站</a>
        <ul class="submenu">
          <li><a href="independent-site.html">数据分析</a></li>
        </ul>
      </li>
    </ul>
  </nav>
  <div class="main">
    <div class="upload-section">
      <div class="upload-top">
        <label for="fileInput" class="upload-btn">选择文件</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <div>
          <label>筛选时间：</label>
          <input id="dateFilter" class="date-filter" placeholder="选择日期范围">
        </div>
      </div>
      <div class="stats-cards">
        <div class="stat-card">
          <h4>平均访客比
            <span class="info" onclick="showInfo('visitorRate')" title="点击查看公式">?</span>
          </h4>
          <p id="avgVisitor">0%</p>
        </div>
        <div class="stat-card">
          <h4>平均加购比
            <span class="info" onclick="showInfo('cartRate')" title="点击查看公式">?</span>
          </h4>
          <p id="avgCart">0%</p>
        </div>
        <div class="stat-card">
          <h4>平均支付比
            <span class="info" onclick="showInfo('payRate')" title="点击查看公式">?</span>
          </h4>
          <p id="avgPay">0%</p>
        </div>
        <div class="stat-card"><h4>商品总数</h4><p id="totalProducts">0</p></div>
        <div class="stat-card"><h4>加购商品数</h4><p id="cartedProducts">0</p></div>
        <div class="stat-card"><h4>支付商品数</h4><p id="purchasedProducts">0</p></div>
      </div>
    </div>
    <div class="table-section">
      <div class="table-wrapper">
        <table id="report" class="display nowrap" style="width:100%"></table>
      </div>
    </div>
  </div>
</div>
<script>
// --- Sidebar: set active & toggle ---
(function() {
  var currentPage = window.location.pathname.split('/').pop();
  if (!currentPage) currentPage = 'independent-site.html';
  $('.sidebar a[href="' + currentPage + '"]').addClass('active');
  $('.sidebar a.active').closest('.has-submenu').addClass('open');
  $('.has-submenu > a').on('click', function(e){
    e.preventDefault();
    $(this).parent().toggleClass('open');
  });
})();

function showInfo(key) {
  const infoMap = {
    visitorRate: '访客比 = 商品访客数 ÷ 搜索曝光量 × 100% （注：独立站若无曝光量字段，则该指标显示为 N/A）',
    cartRate:   '加购比 = 商品加购人数 ÷ 商品访客数 × 100%',
    payRate:    '支付比 = 支付买家数 ÷ 商品加购人数 × 100%',
  };
  alert(infoMap[key] || '暂无说明');
}

let table = null;
let fullData = [];
let headers = [];
let idIdx = -1, linkIdx = -1, visitorIdx = -1, exposureIdx = -1, cartIdx = -1, payIdx = -1, orderIdx = -1, timeIdx = -1;

function findIdx(keywords) {
  return headers.findIndex(h => {
    const cleanHeader = h.trim().toLowerCase();
    return keywords.some(k => cleanHeader.includes(k.toLowerCase()));
  });
}

function renderTable(data) {
  const groupedData = {};
  const uniqueIds = new Set();
  const cartedIds = new Set();
  const paidIds = new Set();

  const rows = data.map(row => {
    const id = idIdx >= 0 ? row[idIdx] : '';
    const linkRaw = linkIdx >= 0 ? (row[linkIdx] || '') : '';
    const visitor = visitorIdx >= 0 ? (parseFloat(row[visitorIdx]) || 0) : 0;
    const exposure = exposureIdx >= 0 ? (parseFloat(row[exposureIdx]) || 0) : 0;
    const cart = cartIdx >= 0 ? (parseFloat(row[cartIdx]) || 0) : 0;
    const pay = payIdx >= 0 ? (parseFloat(row[payIdx]) || 0) : 0;
    const order = orderIdx >= 0 ? (parseFloat(row[orderIdx]) || 0) : 0;
    const time = timeIdx >= 0 ? (row[timeIdx] || '未知时间') : '未知时间';

    const visitorRate = exposure ? ((visitor/exposure)*100).toFixed(2) : 'N/A';
    const cartRate = visitor ? ((cart/visitor)*100).toFixed(2) : (visitor === 0 ? '0.00' : '0.00');
    const payRate = cart ? ((pay/cart)*100).toFixed(2) : (cart === 0 ? '0.00' : '0.00');

    if (!groupedData[time]) groupedData[time] = { v: [], c: [], p: [] };
    if (visitorRate !== 'N/A') groupedData[time].v.push(+visitorRate);
    groupedData[time].c.push(+cartRate);
    groupedData[time].p.push(+payRate);

    if (id) uniqueIds.add(id);
    if (cart > 0 && id) cartedIds.add(id);
    if (pay > 0 && id) paidIds.add(id);

    const idCell = linkRaw
      ? `<a href="${linkRaw}" target="_blank">${id || '查看链接'}</a>`
      : (id ? id : '');

    return [
      idCell,
      visitorRate === 'N/A' ? 'N/A' : (visitorRate + '%'),
      cartRate + '%',
      payRate + '%',
      ...row
    ];
  });

  if (table) table.destroy();
  $('#report').empty();
  const dynCols = headers.map(h => ({ title: h }));
  table = $('#report').DataTable({
    data: rows,
    columns: [
      { title: '商品/链接' },
      { title: '访客比(%) <span class="info" onclick="showInfo(\'visitorRate\')" title="点击查看公式">?</span>' },
      { title: '加购比(%) <span class="info" onclick="showInfo(\'cartRate\')" title="点击查看公式">?</span>' },
      { title: '支付比(%) <span class="info" onclick="showInfo(\'payRate\')" title="点击查看公式">?</span>' },
      ...dynCols
    ],
    scrollX: true,
    scrollY: 'calc(100vh - 330px)',
    scrollCollapse: true,
    fixedHeader: true,
    fixedColumns: {
      leftColumns: 1
    }
  });

  const avg = arr => (arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : '0.00');
  const allV = [].concat(...Object.values(groupedData).map(d => d.v || []));
  const allC = [].concat(...Object.values(groupedData).map(d => d.c || []));
  const allP = [].concat(...Object.values(groupedData).map(d => d.p || []));
  $('#avgVisitor').text(allV.length ? (avg(allV) + '%') : 'N/A');
  $('#avgCart').text(avg(allC) + '%');
  $('#avgPay').text(avg(allP) + '%');
  $('#totalProducts').text(uniqueIds.size);
  $('#cartedProducts').text(cartedIds.size);
  $('#purchasedProducts').text(paidIds.size);
}

$('#fileInput').on('change', function(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
    if (sheet.length < 2) return alert('表格无有效数据');

    headers = sheet[0];

    idIdx = findIdx(['商品id', '商品ID', 'id', 'sku', '产品id', '变体id']);
    linkIdx = findIdx(['产品链接', '链接', 'url', 'product url']);
    visitorIdx = findIdx(['访客数', '访客', 'sessions', 'session', '访问次数']);
    exposureIdx = findIdx(['曝光量', '展示量', 'impressions', '搜索曝光量', '商品曝光量']);
    cartIdx = findIdx(['加购人数', '加购', '加入购物车', '添加到购物车人数', 'ATC']);
    payIdx = findIdx(['支付买家数', '支付人数', '支付买家', '成交人数', 'purchased buyers']);
    orderIdx = findIdx(['下单买家数', '订单数', '下单人数', '下单买家', '订单']);
    timeIdx = findIdx(['统计时间', '日期', '数据时间', 'date']);

    // 允许缺少曝光量与链接字段，其余必须存在
    if (idIdx < 0 || visitorIdx < 0 || cartIdx < 0 || payIdx < 0 || orderIdx < 0 || timeIdx < 0) {
      alert('请检查上传表格字段，至少需要：商品ID/SKU、访客数、加购人数、支付买家数、下单买家数、日期（可选：曝光量、产品链接）');
      return;
    }
    const body = sheet.slice(1).filter(r => r.length);
    fullData = body;
    renderTable(body);
  };
  reader.readAsArrayBuffer(file);
});
</script>



<script>
(function() {
  var page = location.pathname.split('/').pop() || 'index.html';

  // Highlight current page
  var links = document.querySelectorAll('.sidebar a[href]');
  for (var i=0;i<links.length;i++) {
    if (links[i].getAttribute('href') === page) {
      links[i].classList.add('active');
      var p = links[i].closest('.has-submenu');
      if (p) p.classList.add('open');
    }
  }

  // Make sure sidebar sits above content and is clickable
  var sb = document.querySelector('.sidebar');
  if (sb) { sb.style.zIndex = 1000; }

  // Parent click: if only one child, go directly; else toggle
  var parents = document.querySelectorAll('.has-submenu > a');
  for (var j=0;j<parents.length;j++) {
    parents[j].addEventListener('click', function(e){
      var li = this.parentElement;
      var submenu = li.querySelector('.submenu');
      if (!submenu) return;
      var items = submenu.querySelectorAll('a[href]');
      if (items.length === 1) {
        window.location.href = items[0].getAttribute('href');
      } else {
        e.preventDefault();
        li.classList.toggle('open');
      }
    });
  }

  // Submenu links: always navigate
  var subLinks = document.querySelectorAll('.submenu a[href]');
  for (var k=0;k<subLinks.length;k++) {
    subLinks[k].addEventListener('click', function(e){
      // Some browsers may have preventDefault from other handlers; enforce navigation
      window.location.href = this.getAttribute('href');
    });
  }

  // If we're on independent-site.html, auto-open the 速卖通菜单（第一个带有"速卖通"文本的父级）
  if (page === 'independent-site.html') {
    var groups = document.querySelectorAll('.has-submenu');
    for (var g=0; g<groups.length; g++) {
      var txt = groups[g].textContent || '';
      if (txt.indexOf('速卖通') !== -1 || txt.toLowerCase().indexOf('aliexpress') !== -1) {
        groups[g].classList.add('open');
        break;
      }
    }
  }
})();
</script>

</body>
</html>
