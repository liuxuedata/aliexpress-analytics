<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>独立站数据分析</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    .container { display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #2d3e50; color: #fff; padding: 15px; box-sizing: border-box; border-right: 2px solid #444; }
    .sidebar h3 { margin-top: 0; color: #fff; }
    .sidebar ul { list-style: none; padding-left: 0; }
    .sidebar li { margin-bottom: 10px; }
    .sidebar a { text-decoration: none; color: #ddd; font-size: 14px; display: block; padding: 5px; border-radius: 3px; }
    .sidebar a:hover { color: #fff; text-decoration: underline; }
    .sidebar .submenu { list-style: none; padding-left: 20px; display: none; }
    .sidebar .submenu a { font-size: 13px; color: #bbb; }
    .sidebar .submenu a.active { color: #fff; background-color: #4a90e2; }
    .sidebar .has-submenu > a { cursor: pointer; }
    .sidebar .has-submenu.open > .submenu { display: block; }
    .main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
    .upload-section { background: #2d3e50; color: #fff; padding: 15px; flex-shrink: 0; }
    .upload-top { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
    .upload-btn { background: #00b488; color: #fff; padding: 6px 14px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; }
    .upload-section input[type="file"] { display: none; }
    .stats-cards { display: flex; flex-wrap: nowrap; gap: 10px; margin-top: 15px; overflow-x: auto; }
    .stat-card { flex: 0 0 160px; padding: 12px; border-radius: 6px; background: #4a90e2; color: #fff; text-align: center; }
    .stat-card h4 { margin: 0 0 5px 0; font-size: 14px; }
    .stat-card p { margin: 0; font-size: 18px; font-weight: bold; }
    .info {
      cursor: pointer;
      margin-left: 6px;
      color: #fff200;
      font-weight: bold;
      background: #4a90e2;
      border-radius: 50%;
      padding: 0 7px;
      font-size: 14px;
      display: inline-block;
      vertical-align: middle;
    }
    .table-section { background: #fff; flex-grow: 1; overflow: hidden; padding: 15px; }
    .table-wrapper { width: 100%; height: 100%; overflow: auto; }
    .date-filter { color: #000; padding: 5px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; }
    .DTFC_LeftBodyLiner, .DTFC_LeftHeadWrapper { background: #f8fafc !important; }
    .DTFC_LeftHeadWrapper th, .DTFC_LeftBodyLiner td { background: #f0f3fa !important; }
    .fixedHeader-floating, .fixedHeader-floating th { background: #e9edf5 !important; }
  </style>
</head>
<body>
<div class="container">
  <nav class="sidebar" id="sidebar">
    <h3>产品导航</h3>
    <ul>
      <li class="has-submenu">
        <a href="#">速卖通</a>
        <ul class="submenu">
          <li><a href="index.html">全托管</a></li>
          <li><a href="self-operated.html">自运营</a></li>
        </ul>
      </li>
      <li><a href="#">TikTok Shop</a></li>
      <li><a href="#">亚马逊</a></li>
      <li class="has-submenu">
        <a href="#">独立站</a>
        <ul class="submenu">
          <li><a href="independent-site.html">数据分析</a></li>
        </ul>
      </li>
    </ul>
  </nav>
  <div class="main">
    <div class="upload-section">
      <div class="upload-top">
        <label for="fileInput" class="upload-btn">选择文件</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <div>
          <label>筛选时间：</label>
          <input id="dateFilter" class="date-filter" placeholder="选择日期范围">
        </div>
      </div>
      <div class="stats-cards">
        <div class="stat-card">
          <h4>平均访客比
            <span class="info" onclick="showInfo('visitorRate')" title="点击查看公式">?</span>
          </h4>
          <p id="avgVisitor">0%</p>
        </div>
        <div class="stat-card">
          <h4>平均加购比
            <span class="info" onclick="showInfo('cartRate')" title="点击查看公式">?</span>
          </h4>
          <p id="avgCart">0%</p>
        </div>
        <div class="stat-card">
          <h4>平均支付比
            <span class="info" onclick="showInfo('payRate')" title="点击查看公式">?</span>
          </h4>
          <p id="avgPay">0%</p>
        </div>
        <div class="stat-card"><h4>商品总数</h4><p id="totalProducts">0</p></div>
        <div class="stat-card"><h4>加购商品数</h4><p id="cartedProducts">0</p></div>
        <div class="stat-card"><h4>支付商品数</h4><p id="purchasedProducts">0</p></div>
      </div>
    </div>
    <div class="table-section">
      <div class="table-wrapper">
        <table id="report" class="display nowrap" style="width:100%"></table>
      </div>
    </div>
  </div>
</div>
<script>
// --- Sidebar: set active & toggle ---
(function() {
  var currentPage = window.location.pathname.split('/').pop();
  if (!currentPage) currentPage = 'independent-site.html';
  $('.sidebar a[href="' + currentPage + '"]').addClass('active');
  $('.sidebar a.active').closest('.has-submenu').addClass('open');
  $('.has-submenu > a').on('click', function(e){
    e.preventDefault();
    $(this).parent().toggleClass('open');
  });
})();

function showInfo(key) {
  const infoMap = {
    visitorRate: '访客比 = 商品访客数 ÷ 搜索曝光量 × 100% （注：独立站若无曝光量字段，则该指标显示为 N/A）',
    cartRate:   '加购比 = 商品加购人数 ÷ 商品访客数 × 100%',
    payRate:    '支付比 = 支付买家数 ÷ 商品加购人数 × 100%',
  };
  alert(infoMap[key] || '暂无说明');
}

let table = null;
let fullData = [];
let headers = [];
let idIdx = -1, linkIdx = -1, visitorIdx = -1, exposureIdx = -1, cartIdx = -1, payIdx = -1, orderIdx = -1, timeIdx = -1;

function findIdx(keywords) {
  return headers.findIndex(h => {
    const cleanHeader = h.trim().toLowerCase();
    return keywords.some(k => cleanHeader.includes(k.toLowerCase()));
  });
}

function renderTable(data) {
  const groupedData = {};
  const uniqueIds = new Set();
  const cartedIds = new Set();
  const paidIds = new Set();

  const rows = data.map(row => {
    const id = idIdx >= 0 ? row[idIdx] : '';
    const linkRaw = linkIdx >= 0 ? (row[linkIdx] || '') : '';
    const visitor = visitorIdx >= 0 ? (parseFloat(row[visitorIdx]) || 0) : 0;
    const exposure = exposureIdx >= 0 ? (parseFloat(row[exposureIdx]) || 0) : 0;
    const cart = cartIdx >= 0 ? (parseFloat(row[cartIdx]) || 0) : 0;
    const pay = payIdx >= 0 ? (parseFloat(row[payIdx]) || 0) : 0;
    const order = orderIdx >= 0 ? (parseFloat(row[orderIdx]) || 0) : 0;
    const time = timeIdx >= 0 ? (row[timeIdx] || '未知时间') : '未知时间';

    const visitorRate = exposure ? ((visitor/exposure)*100).toFixed(2) : 'N/A';
    const cartRate = visitor ? ((cart/visitor)*100).toFixed(2) : (visitor === 0 ? '0.00' : '0.00');
    const payRate = cart ? ((pay/cart)*100).toFixed(2) : (cart === 0 ? '0.00' : '0.00');

    if (!groupedData[time]) groupedData[time] = { v: [], c: [], p: [] };
    if (visitorRate !== 'N/A') groupedData[time].v.push(+visitorRate);
    groupedData[time].c.push(+cartRate);
    groupedData[time].p.push(+payRate);

    if (id) uniqueIds.add(id);
    if (cart > 0 && id) cartedIds.add(id);
    if (pay > 0 && id) paidIds.add(id);

    const idCell = linkRaw
      ? `<a href="${linkRaw}" target="_blank">${id || '查看链接'}</a>`
      : (id ? id : '');

    return [
      idCell,
      visitorRate === 'N/A' ? 'N/A' : (visitorRate + '%'),
      cartRate + '%',
      payRate + '%',
      ...row
    ];
  });

  if (table) table.destroy();
  $('#report').empty();
  const dynCols = headers.map(h => ({ title: h }));
  table = $('#report').DataTable({
    data: rows,
    columns: [
      { title: '商品/链接' },
      { title: '访客比(%) <span class="info" onclick="showInfo(\'visitorRate\')" title="点击查看公式">?</span>' },
      { title: '加购比(%) <span class="info" onclick="showInfo(\'cartRate\')" title="点击查看公式">?</span>' },
      { title: '支付比(%) <span class="info" onclick="showInfo(\'payRate\')" title="点击查看公式">?</span>' },
      ...dynCols
    ],
    scrollX: true,
    scrollY: 'calc(100vh - 330px)',
    scrollCollapse: true,
    fixedHeader: true,
    fixedColumns: {
      leftColumns: 1
    }
  });

  const avg = arr => (arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : '0.00');
  const allV = [].concat(...Object.values(groupedData).map(d => d.v || []));
  const allC = [].concat(...Object.values(groupedData).map(d => d.c || []));
  const allP = [].concat(...Object.values(groupedData).map(d => d.p || []));
  $('#avgVisitor').text(allV.length ? (avg(allV) + '%') : 'N/A');
  $('#avgCart').text(avg(allC) + '%');
  $('#avgPay').text(avg(allP) + '%');
  $('#totalProducts').text(uniqueIds.size);
  $('#cartedProducts').text(cartedIds.size);
  $('#purchasedProducts').text(paidIds.size);
}

$('#fileInput').on('change', function(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
    if (sheet.length < 2) return alert('表格无有效数据');

    headers = sheet[0];

    idIdx = findIdx(['商品id', '商品ID', 'id', 'sku', '产品id', '变体id']);
    linkIdx = findIdx(['产品链接', '链接', 'url', 'product url']);
    visitorIdx = findIdx(['访客数', '访客', 'sessions', 'session', '访问次数']);
    exposureIdx = findIdx(['曝光量', '展示量', 'impressions', '搜索曝光量', '商品曝光量']);
    cartIdx = findIdx(['加购人数', '加购', '加入购物车', '添加到购物车人数', 'ATC']);
    payIdx = findIdx(['支付买家数', '支付人数', '支付买家', '成交人数', 'purchased buyers']);
    orderIdx = findIdx(['下单买家数', '订单数', '下单人数', '下单买家', '订单']);
    timeIdx = findIdx(['统计时间', '日期', '数据时间', 'date']);

    // 允许缺少曝光量与链接字段，其余必须存在
    if (idIdx < 0 || visitorIdx < 0 || cartIdx < 0 || payIdx < 0 || orderIdx < 0 || timeIdx < 0) {
      alert('请检查上传表格字段，至少需要：商品ID/SKU、访客数、加购人数、支付买家数、下单买家数、日期（可选：曝光量、产品链接）');
      return;
    }
    const body = sheet.slice(1).filter(r => r.length);
    fullData = body;
    renderTable(body);
  };
  reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>
