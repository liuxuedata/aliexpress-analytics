<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ç‹¬ç«‹ç«™ Â· Landing Pages æ˜ç»†</title>
  <link rel="stylesheet" href="assets/login.css">
  <style>
    #report td:first-child{ text-align:left; }
    #report td:first-child a.name{ display:inline-block; max-width:180px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    #columnToggleWrapper{ position:relative; display:inline-block; }
    #columnMenu{ display:none; position:absolute; top:100%; right:0; background:#fff; border:1px solid #ccc; padding:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    #columnMenu label{ display:block; margin:4px 0; white-space:nowrap; }
    
    /* é—®å·å›¾æ ‡æ ·å¼ */
    .help-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      font-weight: bold;
      cursor: help;
      margin-left: 4px;
    }
    .help-icon:hover {
      background: #2563eb;
    }
  </style>
  <!-- DataTables & ECharts CDN -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250811-single">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="assets/site-nav.js"></script>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
        <div class="form-subtitle">ç™»å½•è´¦æˆ·ä»¥ç»§ç»­</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">é‚®ç®±</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">å¯†ç </label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">ğŸ‘ï¸</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">ç™»å½•</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">æ¼”ç¤ºè´¦æˆ·</div>
        <div class="demo-account-info">é‚®ç®±ï¼šdemo@example.com<br>å¯†ç ï¼šdemo123</div>
      </div>
    </div>
  </div>
</div>

<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="#">é€Ÿå–é€š</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon"><a href="amazon-overview.html">äºšé©¬é€Š</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent active"><a href="#">ç‹¬ç«‹ç«™</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>

<div class="layout">
  <nav class="sidebar" id="sidebar">
    <div class="site-header">
      <div class="site-title">
        <svg class="site-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 0 20M12 2a15.3 15.3 0 0 0 0 20"/></svg>
        <span id="currentSite">ç‹¬ç«‹ç«™</span>
      </div>
    </div>
    <ul class="sub-nav">
      <li><a href="#" data-jump="detail" class="active">æ˜ç»†æ•°æ®</a></li>
      <li><a href="#" data-jump="analysis">è¿è¥åˆ†æ</a></li>
      <li><a href="#" data-jump="product">äº§å“åˆ†æ</a></li>
    </ul>
  </nav>

  <main class="main mx-auto max-w-container px-6">
    <div class="content">
    <!-- æ§ä»¶ -->
    <section class="content-pad">
      <div class="panel">
        <div class="controls">
          <label>ç«™ç‚¹ï¼š</label>
          <input type="text" id="site" value="" placeholder="å¦‚ï¼špoolsvacuum.com">
          <span>æ—¥æœŸï¼š</span>
          <input id="dateFilter" class="date-filter" placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´">
          <label>ç½‘ç»œï¼š</label>
          <select id="networkSel"><option value="">å…¨éƒ¨</option></select>
          <label>Campaignï¼š</label>
          <select id="campaignSel"><option value="">å…¨éƒ¨</option></select>
          <button id="refreshBtn" class="btn">åˆ·æ–°</button>
          <button id="uploadBtn" class="btn">ä¸Šä¼ æ•°æ®</button>
          <input type="file" id="fileInput" accept=".xlsx,.csv" style="display:none;">
          <span id="uploadStatus" class="small"></span>
          <div id="columnToggleWrapper">
            <button id="columnToggle" class="btn">ç­›é€‰åˆ—</button>
            <div id="columnMenu" class="small"></div>
          </div>
        </div>
      </div>
    </section>
    <div id="kpi" class="stats-cards"></div>
    <div class="divider"></div>

    <!-- è¿è¥åˆ†æ -->
    <section id="analysis" class="content-pad" style="display:none;">
      <div class="grid">
        <div class="panel">
          <h3>Daily è¶‹åŠ¿ï¼ˆç‚¹å‡» / æ›å…‰ / è½¬åŒ–ä»·å€¼ï¼‰</h3>
          <div id="lineChart" style="width:100%;height:360px;"></div>
        </div>
        <div class="panel">
          <h3>Top Landing Pagesï¼ˆæŒ‰è½¬åŒ–æ•°ï¼‰</h3>
          <div class="table-section">
            <div class="table-wrapper">
              <table id="topTable" class="display nowrap"><thead>
                <tr><th>äº§å“</th><th>ç‚¹å‡»</th><th>æ›å…‰</th><th>CTR</th><th>è½¬åŒ–</th><th>èŠ±è´¹</th><th>è½¬åŒ–ä»·å€¼</th><th>CPA</th><th>ROAS</th></tr>
              </thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- æ˜ç»†è¡¨ -->
    <section id="detail" class="content-pad">
      <div class="panel">
        <h3>Landing Pages æ˜ç»†</h3>
        <div class="table-section">
          <div class="table-wrapper">
            <table id="report" class="display nowrap" style="width:100%">
              <thead>
                <tr>
                  <th>äº§å“</th><th>è®¾å¤‡</th><th>ç½‘ç»œ</th><th>Campaign</th><th>å‘¨æœŸ</th>
                  <th>ç‚¹å‡»</th><th>æ›å…‰</th><th>CTR <span class="help-icon" title="CTR = æ€»ç‚¹å‡» / æ€»æ›å…‰">?</span></th><th>Avg CPC</th><th>Cost</th>
                  <th>è½¬åŒ–</th><th>Cost/Conv</th><th>All conv</th><th>Conv value</th>
                  <th>All conv rate <span class="help-icon" title="All conv rate = All conv / æ€»ç‚¹å‡»">?</span></th><th>Conv rate <span class="help-icon" title="Conv rate = è½¬åŒ– / æ€»ç‚¹å‡»">?</span></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- äº§å“åˆ†æï¼ˆå ä½ï¼‰ -->
    <section id="product" class="content-pad" style="display:none;">
      <div class="panel"><h3>äº§å“åˆ†æ</h3>
        <div class="small">ï¼ˆåç»­å¯æŒ‰è·¯å¾„æ˜ å°„åˆ°å•†å“ï¼Œå¢åŠ å”®ä»·ã€æ¯›åˆ©ã€åº“å­˜ã€ç±»ç›®ç­‰ç»´åº¦çš„åˆ†æï¼‰</div>
      </div>
    </section>
    </div>
  </main>
</div>

<script>
// å·¦ä¾§å±€éƒ¨å¯¼èˆªåˆ‡æ¢
(function(){
  const sb = document.getElementById('sidebar');
  sb.addEventListener('click', function(e){
    const a = e.target.closest('a[data-jump]');
    if (!a) return;
    e.preventDefault();
    const to = a.getAttribute('data-jump');
    ['detail','analysis','product'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.style.display = (id===to ? '' : 'none');
    });
    sb.querySelectorAll('a[data-jump]').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    setTimeout(()=> window.dispatchEvent(new Event('resize')), 0);
  });
})();
</script>

<script>
// é¡µé¢é€»è¾‘ï¼šæ‹‰å– /api/independent/stats
(function(){
  const shorten=(s,l=30)=>{if(!s) return '';return s.length>l?s.slice(0,l)+'â€¦':s;};
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  const siteInput = document.getElementById('site');
  const fromInput = document.getElementById('from');
  const toInput = document.getElementById('to');
  const columnMenu = document.getElementById('columnMenu');
  const columnToggle = document.getElementById('columnToggle');
  const networkSel = document.getElementById('networkSel');
  const campaignSel = document.getElementById('campaignSel');
  const optionalCols = [
    { idx:1, label:'è®¾å¤‡' }
  ];
  optionalCols.forEach(c=>{
    const lab=document.createElement('label');
    lab.innerHTML=`<input type="checkbox" data-col="${c.idx}"> ${c.label}`;
    columnMenu.appendChild(lab);
  });
  columnToggle.addEventListener('click',()=>{
    columnMenu.style.display = columnMenu.style.display==='block' ? 'none' : 'block';
  });
  let dt;
  let rawTable = [];

  function card(title,val){
    return `<div class="stat-card"><h4>${title}</h4><p>${val}</p></div>`;
  }
  function renderKPI(k){
    $('#kpi').html([
      card('å¹³å‡ç‚¹å‡»ç‡', (k.avg_ctr||0)+'%'),
      card('å¹³å‡è½¬åŒ–ç‡', (k.avg_conv_rate||0)+'%'),
      card('æ›å…‰å•†å“æ€»æ•°', k.exposure_product_count||0),
      card('ç‚¹å‡»å•†å“æ€»æ•°', k.click_product_count||0),
      card('è½¬åŒ–å•†å“æ€»æ•°', k.conversion_product_count||0),
      card('æ–°å“æ€»æ•°', k.new_product_count||0)
    ].join(''));
  }

  function aggregateTable(data, showDevice, showNetwork, showCampaign){
    // å®‰å…¨å¤„ç†ç©ºæ•°æ®
    if (!data || !Array.isArray(data) || data.length === 0) {
      return [];
    }
    
    const map = {};
    data.forEach(r=>{
      const keyParts=[r.day, r.landing_path];
      if(showDevice) keyParts.push(r.device||'');
      if(showNetwork) keyParts.push(r.network||'');
      if(showCampaign) keyParts.push(r.campaign||'');
      const key=keyParts.join('|');
      if(!map[key]){
        map[key]={
          product:r.product,
          landing_path:r.landing_path,
          landing_url:r.landing_url,
          day:r.day,
          device: showDevice ? r.device : '',
          network: showNetwork ? r.network : '',
          campaign: showCampaign ? r.campaign : '',
          clicks:0, impr:0, cost:0, conversions:0, all_conv:0, conv_value:0
        };
      }
      const m=map[key];
      m.clicks+=r.clicks||0;
      m.impr+=r.impr||0;
      m.cost+=r.cost||0;
      m.conversions+=r.conversions||0;
      m.all_conv+=r.all_conv||0;
      m.conv_value+=r.conv_value||0;
    });
    return Object.values(map).map(m=>{
      m.ctr = m.impr>0 ? m.clicks/m.impr : 0;
      m.avg_cpc = m.clicks>0 ? m.cost/m.clicks : 0;
      m.conv_rate = m.clicks>0 ? m.conversions/m.clicks : 0;
      m.cost_per_conv = m.conversions>0 ? m.cost/m.conversions : 0;
      m.all_conv_rate = m.clicks>0 ? m.all_conv/m.clicks : 0;
      return m;
    }).sort((a,b)=> {
      // å®‰å…¨æ’åºï¼Œå¤„ç†undefinedå€¼
      const dayA = a.day || '';
      const dayB = b.day || '';
      return dayB.localeCompare(dayA);
    });
  }

  function buildTable(){
    // å®‰å…¨å¤„ç†ç©ºæ•°æ®
    if (!rawTable || !Array.isArray(rawTable) || rawTable.length === 0) {
      if(dt) dt.destroy();
      dt = $('#report').DataTable({
        destroy:true,
        pageLength:20,
        data: [],
        scrollX:true,
        fixedHeader:true,
        autoWidth:false,
        columns:[
          { data:'product', render:(v,t,r)=>{
              const name = v || r.landing_path || '';
              return `<a href="${r.landing_url}" target="_blank" class="name" title="${name}">${shorten(name)}</a>`;
            }},
          { data:'device', render: v => v || '' },
          { data:'network', render: v => v || '' },
          { data:'campaign', render: v => v || '' },
          { data:'period', render: v => v || '' },
          { data:'clicks', render: v => v ?? 0 },
          { data:'impr', render: v => v ?? 0 },
          { data:'ctr', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%' },
          { data:'avg_cpc', render: v => v ?? 0 },
          { data:'cost', render: v => v ?? 0 },
          { data:'conversions', render: v => v ?? 0 },
          { data:'cost_per_conv', render: v => v ?? 0 },
          { data:'all_conv', render: v => v ?? 0 },
          { data:'conv_value', render: v => v ?? 0 },
          { data:'all_conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%' },
          { data:'conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%' },
        ]
      });
      return;
    }
    
    let data = rawTable;
    const net = networkSel.value;
    const camp = campaignSel.value;
    if(net) data = data.filter(r=>r.network===net);
    if(camp) data = data.filter(r=>r.campaign===camp);
    const showDevice = $('#columnMenu input[data-col=1]').prop('checked');
    const showNetwork = !!net;
    const showCampaign = !!camp;
    data = aggregateTable(data, showDevice, showNetwork, showCampaign);
    if(dt) dt.destroy();
    dt = $('#report').DataTable({
      destroy:true,
      pageLength:20,
      data,
      scrollX:true,
      fixedHeader:true,
      autoWidth:false,
      columns:[
        { data:'product', render:(v,t,r)=>{
            const name = v || r.landing_path || '';
            return `<a href="${r.landing_url}" target="_blank" class="name" title="${name}">${shorten(name)}</a>`;
          }},
        { data:'device', render: v => v || '' },
        { data:'network', render: v => v || '' },
        { data:'campaign', render: v => v || '' },
        { data:'period', render: v => v || '' }, // æ˜¾ç¤ºå‘¨æœŸèŒƒå›´
        { data:'clicks', render: v => v ?? 0 },
        { data:'impr', render: v => v ?? 0 },
        { data:'ctr', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%' },
        { data:'avg_cpc', render: v => v ?? 0 },
        { data:'cost', render: v => v ?? 0 },
        { data:'conversions', render: v => v ?? 0 },
        { data:'cost_per_conv', render: v => v ?? 0 },
        { data:'all_conv', render: v => v ?? 0 },
        { data:'conv_value', render: v => v ?? 0 },
        { data:'all_conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%' },
        { data:'conv_rate', render: v => v != null ? (v*100).toFixed(2)+'%' : '0%' },
      ]
    });
    dt.column(1).visible(showDevice);
    dt.column(2).visible(showNetwork);
    dt.column(3).visible(showCampaign);
  }

  $('#columnMenu').on('change','input[type=checkbox]', buildTable);
  networkSel.addEventListener('change', buildTable);
  campaignSel.addEventListener('change', buildTable);

  // è·å–å½“å‰é€‰ä¸­çš„ç‹¬ç«‹ç«™ç«™ç‚¹ID
  const currentIndepSiteId = localStorage.getItem('currentIndepSite');
  const currentIndepSiteName = localStorage.getItem('currentIndepSiteName');
  
  // æ›´æ–°ç«™ç‚¹åç§°æ˜¾ç¤º
  function updateSiteDisplay() {
    const currentSiteEl = document.getElementById('currentSite');
    if (currentSiteEl) {
      // é‡æ–°è·å–æœ€æ–°çš„localStorageå€¼
      const latestSiteId = localStorage.getItem('currentIndepSite');
      const latestSiteName = localStorage.getItem('currentIndepSiteName');
      
      if (latestSiteName) {
        currentSiteEl.textContent = latestSiteName;
        console.log('ç‹¬ç«‹ç«™é¡µé¢æ›´æ–°ç«™ç‚¹åç§°:', latestSiteName);
      } else if (latestSiteId) {
        // æ ¹æ®ç«™ç‚¹IDæ˜¾ç¤ºåç§°
        const siteNameMap = {
          'independent_icyberite': 'icyberite.com',
          'independent_poolsvacuum': 'poolsvacuum.com'
        };
        const displayName = siteNameMap[latestSiteId] || 'ç‹¬ç«‹ç«™';
        currentSiteEl.textContent = displayName;
        console.log('ç‹¬ç«‹ç«™é¡µé¢æ›´æ–°ç«™ç‚¹åç§°:', displayName);
      } else {
        // ä»URLå‚æ•°è·å–ç«™ç‚¹åç§°
        const urlParams = new URLSearchParams(window.location.search);
        const siteParam = urlParams.get('site');
        if (siteParam) {
          currentSiteEl.textContent = siteParam;
          console.log('ç‹¬ç«‹ç«™é¡µé¢ä»URLå‚æ•°è·å–ç«™ç‚¹åç§°:', siteParam);
        } else {
          currentSiteEl.textContent = 'poolsvacuum.com';
          console.log('ç‹¬ç«‹ç«™é¡µé¢ä½¿ç”¨é»˜è®¤åç§°: poolsvacuum.com');
        }
      }
    }
  }
  
  // è·å–å½“å‰ç«™ç‚¹åç§°ç”¨äºAPIè°ƒç”¨
  function getCurrentSiteForAPI() {
    const currentIndepSiteId = localStorage.getItem('currentIndepSite');
    const currentIndepSiteName = localStorage.getItem('currentIndepSiteName');
    
    // å¦‚æœæœ‰ç«™ç‚¹åç§°ï¼Œä½¿ç”¨ç«™ç‚¹åç§°ï¼ˆè¿™æ˜¯æ•°æ®åº“ä¸­çš„siteå­—æ®µå€¼ï¼‰
    if (currentIndepSiteName) {
      return currentIndepSiteName;
    }
    
    // å¦‚æœæœ‰ç«™ç‚¹IDï¼Œæ ¹æ®IDæ˜ å°„åˆ°ç«™ç‚¹åç§°
    if (currentIndepSiteId) {
      const siteNameMap = {
        'independent_icyberite': 'icyberite.com',
        'independent_poolsvacuum': 'poolsvacuum.com'
      };
      return siteNameMap[currentIndepSiteId] || 'poolsvacuum.com';
    }
    
    // ä»URLå‚æ•°è·å–
    const urlParams = new URLSearchParams(window.location.search);
    const siteParam = urlParams.get('site');
    if (siteParam) {
      return siteParam;
    }
    
    // é»˜è®¤å€¼
    return 'poolsvacuum.com';
  }
  
  // é»˜è®¤ç«™ç‚¹å– url å‚æ•°ã€å½“å‰é€‰ä¸­çš„ç«™ç‚¹æˆ–ä»ç¤ºä¾‹å–
  siteInput.value = getParam('site') || getCurrentSiteForAPI();
  
  // åˆå§‹åŒ–ç«™ç‚¹åç§°æ˜¾ç¤º
  updateSiteDisplay();
  
  // ç›‘å¬localStorageå˜åŒ–ï¼Œå®æ—¶æ›´æ–°ç«™ç‚¹åç§°
  window.addEventListener('storage', (e) => {
    if (e.key === 'currentIndepSite' || e.key === 'currentIndepSiteName') {
      updateSiteDisplay();
      // åŒæ—¶æ›´æ–°è¾“å…¥æ¡†çš„å€¼
      siteInput.value = getCurrentSiteForAPI();
    }
  });
  
  // å®šæœŸæ£€æŸ¥ç«™ç‚¹åç§°å˜åŒ–ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
  setInterval(() => {
    const newSiteId = localStorage.getItem('currentIndepSite');
    const newSiteName = localStorage.getItem('currentIndepSiteName');
    if (newSiteId !== currentIndepSiteId || newSiteName !== currentIndepSiteName) {
      updateSiteDisplay();
      siteInput.value = getCurrentSiteForAPI();
    }
  }, 1000);
  
  // åˆå§‹åŒ–ç»Ÿä¸€çš„æ—¶é—´æ§ä»¶
  const fp = flatpickr('#dateFilter', { 
    mode: 'range', 
    dateFormat: 'Y-m-d', 
    onClose: (ds) => { 
      if (ds.length === 2) load(); 
    } 
  });
  
  // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´
  const currentIndepSiteId = localStorage.getItem('currentIndepSite') || 'independent_poolsvacuum';
  const indepPeriodKey = `indepPeriod_${currentIndepSiteId}`;
  const stored = localStorage.getItem(indepPeriodKey);
  if (stored && stored.includes(' to ')) {
    $('#dateFilter').val(stored);
  } else {
    const today = new Date();
    const end = today.toISOString().slice(0,10);
    const start = today.getFullYear() < 2025 ? '2025-07-01' : new Date(today.getTime()-30*86400000).toISOString().slice(0,10);
    const def = `${start} to ${end}`;
    $('#dateFilter').val(def);
    localStorage.setItem(indepPeriodKey, def);
  }

  function parseDateRange() {
    const input = document.getElementById('dateFilter');
    if (input && input.value && input.value.includes(' to ')) {
      const [s, e] = input.value.split(' to ');
      return { from: s, to: e };
    }
    const today = new Date();
    const to = today.toISOString().slice(0,10);
    const from = today.getFullYear() < 2025 ? '2025-07-01' : new Date(today.getTime()-30*86400000).toISOString().slice(0,10);
    return { from, to };
  }

  function populateFilters(){
    // å®‰å…¨å¤„ç†ç©ºæ•°æ®
    if (!rawTable || !Array.isArray(rawTable) || rawTable.length === 0) {
      networkSel.innerHTML = '<option value="">å…¨éƒ¨</option>';
      campaignSel.innerHTML = '<option value="">å…¨éƒ¨</option>';
      return;
    }
    
    const nets = Array.from(new Set(rawTable.map(r=>r.network).filter(Boolean))).sort();
    networkSel.innerHTML = '<option value="">å…¨éƒ¨</option>' + nets.map(n=>`<option value="${n}">${n}</option>`).join('');
    const camps = Array.from(new Set(rawTable.map(r=>r.campaign).filter(Boolean))).sort();
    campaignSel.innerHTML = '<option value="">å…¨éƒ¨</option>' + camps.map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  async function load() {
    try {
      const siteName = siteInput.value.trim();
      
      // è§£ææ—¥æœŸèŒƒå›´
      const dateRange = parseDateRange();
      const from = dateRange.from;
      const to = dateRange.to;
      
      // ä½¿ç”¨æ–°çš„ç«™ç‚¹å‚æ•°è·å–é€»è¾‘
      const siteParam = getCurrentSiteForAPI();
      
      console.log('ç‹¬ç«‹ç«™æŸ¥è¯¢å‚æ•°:', { siteName, siteParam, from, to });
      
      // æ·»åŠ  aggregate=product å‚æ•°æ¥å®ç°äº§å“çº§åˆ«çš„èšåˆ
      const url = `/api/independent/stats?site=${encodeURIComponent(siteParam)}&from=${from}&to=${to}&aggregate=product`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'åŠ è½½å¤±è´¥');

      rawTable = json.table || [];
      renderKPI(json.kpis || {});
      populateFilters();
      buildTable();

      // è¶‹åŠ¿å›¾
      const days = json.series.map(x=>x.day);
      const clicks = json.series.map(x=>x.clicks);
      const impr = json.series.map(x=>x.impr);
      const value = json.series.map(x=>x.conv_value);
      const ec = echarts.init(document.getElementById('lineChart'));
      ec.setOption({
        tooltip: { trigger: 'axis' },
        legend: { data:['Clicks','Impr.','Conv value'] },
        xAxis: { type:'category', data: days },
        yAxis: [{ type:'value', name:'Clicks / Impr' }, { type:'value', name:'Value', position:'right' }],
        series: [
          { name:'Clicks', type:'line', smooth:true, data: clicks },
          { name:'Impr.', type:'bar', data: impr },
          { name:'Conv value', type:'line', yAxisIndex:1, smooth:true, data: value },
        ]
      });

      // Top landing pages
      const topRows = json.topList.map(r => [
        shorten(r.product || r.path), r.clicks, r.impr, (r.ctr*100).toFixed(2)+'%', r.conversions, r.cost, r.conv_value, r.cpa.toFixed(2), r.roas.toFixed(2)
      ]);
      $('#topTable').DataTable({ destroy:true, paging:false, searching:false, info:false, data: topRows, scrollX:true, autoWidth:false });
    } catch(e) {
      console.error(e);
      alert(e.message || 'åŠ è½½å¤±è´¥');
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', () => {
    // ä¿å­˜å½“å‰æ—¥æœŸèŒƒå›´åˆ°localStorage
    const currentIndepSiteId = localStorage.getItem('currentIndepSite') || 'independent_poolsvacuum';
    const indepPeriodKey = `indepPeriod_${currentIndepSiteId}`;
    const dateFilter = document.getElementById('dateFilter');
    if (dateFilter && dateFilter.value) {
      localStorage.setItem(indepPeriodKey, dateFilter.value);
    }
    load();
  });
  // ä¸Šä¼ é€»è¾‘
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusEl = document.getElementById('uploadStatus');
  uploadBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', async () => {
    if (!fileInput.files.length) return;
    
    const file = fileInput.files[0];
    if (!file) {
      alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
      return;
    }
    
    const fd = new FormData();
    fd.append('file', file);
    
    // è·å–å½“å‰ç«™ç‚¹ä¿¡æ¯
    const currentIndepSiteId = localStorage.getItem('currentIndepSite');
    const currentSiteName = getCurrentSiteForAPI();
    console.log('æ–‡ä»¶ä¸Šä¼  - å½“å‰ç‹¬ç«‹ç«™ç«™ç‚¹ID:', currentIndepSiteId);
    console.log('æ–‡ä»¶ä¸Šä¼  - å½“å‰ç«™ç‚¹åç§°:', currentSiteName);
    console.log('æ–‡ä»¶ä¿¡æ¯:', { name: file.name, size: file.size, type: file.type });
    
    try {
      statusEl.textContent = 'å¯¼å…¥ä¸­...';
      uploadBtn.disabled = true;
      
      // æ ¹æ®ç«™ç‚¹IDé€‰æ‹©æ­£ç¡®çš„API
      let apiUrl = '/api/independent/ingest'; // é»˜è®¤Google Ads API
      
      // å¦‚æœæ˜¯icyberite.comï¼Œä½¿ç”¨Facebook Ads API
      if (currentIndepSiteId === 'independent_icyberite') {
        apiUrl = '/api/independent/facebook-ingest';
        console.log('ä½¿ç”¨Facebook Ads API:', apiUrl);
      } else {
        console.log('ä½¿ç”¨Google Ads API:', apiUrl);
      }
      
      const headers = {};
      if (currentIndepSiteId) {
        headers['X-Site-ID'] = currentIndepSiteId;
      }
      // æ·»åŠ ç«™ç‚¹åç§°å¤´ï¼Œç”¨äºæ•°æ®å¯¼å…¥
      headers['X-Site-Name'] = currentSiteName;
      
      const resp = await fetch(apiUrl, { 
        method: 'POST', 
        body: fd,
        headers: headers
      });
      
      if (!resp.ok) {
        const errorText = await resp.text();
        throw new Error(`HTTP ${resp.status}: ${errorText}`);
      }
      
      const json = await resp.json().catch(() => ({ ok:false, error:`HTTP ${resp.status}` }));
      if (!json.ok) throw new Error(json.error || 'ä¸Šä¼ å¤±è´¥');
      
      statusEl.textContent = 'å¯¼å…¥å®Œæˆï¼ŒåŠ è½½ä¸­...';
      await load();
      statusEl.textContent = 'å®Œæˆ';
      alert(`ä¸Šä¼ æˆåŠŸï¼Œè®°å½•æ•°: ${json.inserted}`);
    } catch(e) {
      console.error('ä¸Šä¼ é”™è¯¯:', e);
      statusEl.textContent = `ä¸Šä¼ å¤±è´¥: ${e.message}`;
      alert(`ä¸Šä¼ å¤±è´¥: ${e.message}`);
    } finally {
      fileInput.value = '';
      uploadBtn.disabled = false;
      setTimeout(() => { statusEl.textContent = ''; }, 3000);
    }
  });
  load();
})();
</script>

<script src="assets/login.js"></script>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  // ç§»é™¤æ—§çš„ç¡¬ç¼–ç ç«™ç‚¹é€»è¾‘ï¼Œç°åœ¨ä½¿ç”¨ç»Ÿä¸€çš„site-nav.js
  // ç«™ç‚¹èœå•ç”±site-nav.jsç»Ÿä¸€ç®¡ç†
  const userArea=document.getElementById('userArea');
  function refreshUser(){
    const u=JSON.parse(localStorage.getItem('user')||'null');
    if(u){
      userArea.innerHTML=`<div class="user-section"><div class="user-menu-trigger">${u.name}</div><div class="user-dropdown" style="display:none"><button class="user-dropdown-item" id="logoutBtn">é€€å‡º</button></div></div>`;
      const trigger=userArea.querySelector('.user-menu-trigger');
      const dropdown=userArea.querySelector('.user-dropdown');
      trigger.addEventListener('click',()=>{dropdown.style.display=dropdown.style.display==='block'?'none':'block';});
      document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.removeItem('user');dropdown.style.display='none';refreshUser();showLoginOverlay();});
    }else{
      userArea.innerHTML='<div class="user-section"><span class="user-demo">æœªç™»å½•</span><button class="login-button" id="loginTrigger">ç™»å½•</button></div>';
      document.getElementById('loginTrigger').addEventListener('click',showLoginOverlay);
      showLoginOverlay();
    }
  }
  refreshUser();
  window.addEventListener('user-login', refreshUser);
});
</script>

</body>
</html>
