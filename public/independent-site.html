<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>独立站 · Landing Pages 明细</title>
  <link rel="stylesheet" href="assets/theme.css">
  <!-- DataTables & ECharts CDN (可替换为本地) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt/css/jquery.dataTables.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>

<header class="top-nav"><div class="nav-inner"><ul class="top-menu"><li><a href="#">速卖通</a><ul class="dropdown"><li class="submenu"><a href="#">全托管</a><ul id="managedMenu"></ul></li><li><a href="self-operated.html">自运营</a></li></ul></li><li><a href="#">亚马逊</a></li><li><a href="#">TikTok Shop</a></li><li><a href="#">Temu</a></li><li><a href="#">Ozon</a></li><li><a href="independent-site.html" class="active">独立站</a></li></ul><div id="userArea" class="user-area"></div></div></header>

<div class="container">
  <nav class="sidebar" id="sidebar">
    <h3>本页</h3>
    <ul>
      <li><a href="#" data-jump="detail" class="active">明细数据</a></li>
      <li><a href="#" data-jump="analysis">运营分析</a></li>
      <li><a href="#" data-jump="product">产品分析</a></li>
    </ul>
  </nav>

  <main class="main">
    <!-- 控件 -->
    <section class="content-pad">
      <div class="panel">
        <div class="controls">
          <label>站点：</label>
          <input type="text" id="site" value="" placeholder="如：poolsvacuum.com">
          <label>起止：</label>
          <input type="date" id="from">
          <input type="date" id="to">
          <button id="refreshBtn" class="btn">刷新</button>
          <a id="uploadLink" class="btn" href="/api/independent/ingest" title="POST xlsx/csv 到此接口，字段名自动识别">上传数据接口</a>
        </div>
      </div>
    </section>

    <!-- 运营分析 -->
    <div class="tabs">
      <div class="tab" data-tab="analysis">运营分析</div>
      <div class="tab active" data-tab="detail">明细表</div>
    </div>

    <section id="analysis" class="content-pad" style="display:none;">
      <div class="grid" style="display:grid;grid-template-columns:1fr;gap:12px;">
        <div class="panel">
          <h3>Daily 趋势（点击 / 曝光 / 转化价值）</h3>
          <div id="lineChart" style="width:100%;height:360px;"></div>
        </div>
        <div class="panel">
          <h3>Top Landing Pages（按转化数）</h3>
          <div class="table-wrapper">
            <table id="topTable" class="display"><thead>
              <tr><th>路径</th><th>点击</th><th>曝光</th><th>CTR</th><th>转化</th><th>花费</th><th>转化价值</th><th>CPA</th><th>ROAS</th></tr>
            </thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </section>

    <!-- 明细表 -->
    <section id="detail" class="content-pad">
      <div class="panel">
        <h3>Landing Pages 明细</h3>
        <div class="table-wrapper">
          <table id="report" class="display" style="width:100%">
            <thead>
              <tr>
                <th>日期</th><th>页面</th><th>设备</th><th>网络</th><th>Campaign</th>
                <th>点击</th><th>曝光</th><th>CTR</th><th>Avg CPC</th><th>Cost</th>
                <th>转化</th><th>Cost/Conv</th><th>All conv</th><th>Conv value</th>
                <th>All conv rate</th><th>Conv rate</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 产品分析（占位） -->
    <section id="product" class="content-pad" style="display:none;">
      <div class="panel"><h3>产品分析</h3>
        <div class="small">（后续可按路径映射到商品，增加售价、毛利、库存、类目等维度的分析）</div>
      </div>
    </section>
  </main>
</div>

<script>
// 左侧局部导航切换
(function(){
  const sb = document.getElementById('sidebar');
  sb.addEventListener('click', function(e){
    const a = e.target.closest('a[data-jump]');
    if (!a) return;
    e.preventDefault();
    const to = a.getAttribute('data-jump');
    ['detail','analysis','product'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.style.display = (id===to ? '' : 'none');
    });
    document.querySelectorAll('.tabs .tab').forEach(t=>{
      t.classList.toggle('active', t.dataset.tab === to);
    });
    sb.querySelectorAll('a[data-jump]').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    setTimeout(()=> window.dispatchEvent(new Event('resize')), 0);
  });
})();
</script>

<script>
// 页面逻辑：拉取 /api/independent/stats
(function(){
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  const siteInput = document.getElementById('site');
  const fromInput = document.getElementById('from');
  const toInput = document.getElementById('to');

  // 默认站点取 url 参数或从示例取
  siteInput.value = getParam('site') || 'poolsvacuum.com';
  const today = new Date();
  const toDef = today.toISOString().slice(0,10);
  const fromDef = new Date(today.getTime() - 29*86400000).toISOString().slice(0,10);
  fromInput.value = getParam('from') || fromDef;
  toInput.value = getParam('to') || toDef;

  async function load() {
    const site = siteInput.value.trim();
    const from = fromInput.value;
    const to = toInput.value;
    const url = `/api/independent/stats?site=${encodeURIComponent(site)}&from=${from}&to=${to}`;
    const res = await fetch(url);
    const json = await res.json();
    if (!json.ok) { alert(json.error || '加载失败'); return; }

    // 明细表
    const tb = $('#report').DataTable({
      destroy: true,
      pageLength: 20,
      data: json.table,
      columns: [
        { data: 'day' },
        { data: 'landing_path', render: (v,t,r)=> `<a href="${r.landing_url}" target="_blank">${v}</a>` },
        { data: 'device' },
        { data: 'network' },
        { data: 'campaign' },
        { data: 'clicks' },
        { data: 'impr' },
        { data: 'ctr', render: v => (v*100).toFixed(2)+'%' },
        { data: 'avg_cpc' },
        { data: 'cost' },
        { data: 'conversions' },
        { data: 'cost_per_conv' },
        { data: 'all_conv' },
        { data: 'conv_value' },
        { data: 'all_conv_rate', render: v => (v*100).toFixed(2)+'%' },
        { data: 'conv_rate', render: v => (v*100).toFixed(2)+'%' },
      ]
    });

    // 趋势图
    const days = json.series.map(x=>x.day);
    const clicks = json.series.map(x=>x.clicks);
    const impr = json.series.map(x=>x.impr);
    const value = json.series.map(x=>x.conv_value);
    const ec = echarts.init(document.getElementById('lineChart'));
    ec.setOption({
      tooltip: { trigger: 'axis' },
      legend: { data:['Clicks','Impr.','Conv value'] },
      xAxis: { type:'category', data: days },
      yAxis: [{ type:'value', name:'Clicks / Impr' }, { type:'value', name:'Value', position:'right' }],
      series: [
        { name:'Clicks', type:'line', smooth:true, data: clicks },
        { name:'Impr.', type:'bar', data: impr },
        { name:'Conv value', type:'line', yAxisIndex:1, smooth:true, data: value },
      ]
    });

    // Top landing pages
    const topRows = json.topList.map(r => [
      r.path, r.clicks, r.impr, (r.ctr*100).toFixed(2)+'%', r.conversions, r.cost, r.conv_value, r.cpa.toFixed(2), r.roas.toFixed(2)
    ]);
    $('#topTable').DataTable({ destroy:true, paging:false, searching:false, info:false, data: topRows });
  }

  document.getElementById('refreshBtn').addEventListener('click', load);
  load();
})();
</script>

</body>
</html>
