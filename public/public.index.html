<!DOCTYPE html>
<html lang=\"zh-CN\">
<head>
  <meta charset=\"UTF-8\" />
  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>
  <title>电商数据分析 - Phase A</title>

  <!-- DataTables & jQuery -->
  <link rel=\"stylesheet\" href=\"https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css\">
  <script src=\"https://code.jquery.com/jquery-3.7.1.min.js\"></script>
  <script src=\"https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js\"></script>

  <!-- File parse -->
  <script src=\"https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js\"></script>
  <script src=\"https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js\"></script>

  <style>
    body { font-family: system-ui, -apple-system, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial; padding: 16px; }
    .row { display:flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 12px; }
    .row label { font-weight: 600; margin-right: 6px; }
    input, select, button { padding: 8px 10px; }
    #saveBtn { background:#111827; color:#fff; border:0; border-radius:6px; cursor:pointer; opacity:.6 }
    #saveBtn.enabled { opacity: 1; }
    .hint { color:#6b7280; font-size: 12px; }
    .toolbar { display:flex; align-items:center; gap:8px; justify-content: space-between; }
  </style>
</head>
<body>
  <h2>电商数据分析（Phase A）</h2>

  <div class=\"row\">
    <div>
      <label>日期</label>
      <input type=\"date\" id=\"statDate\">
    </div>
    <div>
      <label>来源</label>
      <select id=\"sourceCode\">
        <option value=\"AE_FBM\">速卖通-全托管</option>
        <option value=\"AE_SO\">速卖通-自运营</option>
        <option value=\"SHOPIFY\">独立站-Shopify</option>
      </select>
    </div>
    <div>
      <label>平台</label>
      <select id=\"platform\">
        <option value=\"aliexpress\">aliexpress</option>
        <option value=\"shopify\">shopify</option>
      </select>
    </div>
    <div class=\"toolbar\" style=\"flex:1\">
      <div>
        <input type=\"file\" id=\"fileInput\" accept=\".csv,.xlsx,.xls\" />
        <div class=\"hint\">支持 CSV / XLSX。表头建议包含：product_id, exposure, visitors, views, add_people, add_count, pay_items, pay_orders, pay_buyers。</div>
      </div>
      <div>
        <button id=\"saveBtn\" disabled>保存到数据库</button>
        <a href=\"history.html\" style=\"margin-left:10px\">查看历史数据 →</a>
      </div>
    </div>
  </div>

  <table id=\"dataTable\" class=\"display\" style=\"width:100%\">
    <thead>
      <tr>
        <th>product_id</th>
        <th>exposure</th>
        <th>visitors</th>
        <th>views</th>
        <th>add_people</th>
        <th>add_count</th>
        <th>pay_items</th>
        <th>pay_orders</th>
        <th>pay_buyers</th>
        <th>visitor_to_add</th>
        <th>add_to_pay</th>
        <th>visitor_ratio</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const table = $('#dataTable').DataTable({
  pageLength: 50,
  columns: [
    { data:'product_id' },
    { data:'exposure' },
    { data:'visitors' },
    { data:'views' },
    { data:'add_people' },
    { data:'add_count' },
    { data:'pay_items' },
    { data:'pay_orders' },
    { data:'pay_buyers' },
    { data:'visitor_to_add' },
    { data:'add_to_pay' },
    { data:'visitor_ratio' },
  ]
});

const toNum = (v) => (v===undefined || v===null || v==='' ? 0 : Number(String(v).replace(/,/g,'')));

function derive(row){
  const visitors = toNum(row.visitors);
  const add_people = toNum(row.add_people);
  const pay_orders = toNum(row.pay_orders);

  const visitor_to_add = visitors ? add_people / visitors : 0;
  const add_to_pay = add_people ? pay_orders / add_people : 0;
  const visitor_ratio = visitors ? pay_orders / visitors : 0;

  return {
    visitor_to_add: Number((visitor_to_add*100).toFixed(2)),
    add_to_pay: Number((add_to_pay*100).toFixed(2)),
    visitor_ratio: Number((visitor_ratio*100).toFixed(2)),
  };
}

let parsedRows = [];

function inferDateFromFilename(filename) {
  const m = filename.match(/(20\d{2})(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])/);
  if (!m) return null;
  return `${m[1]}-${m[2]}-${m[3]}`;
}
function inferDateFromRows(rows) {
  if (!rows || !rows.length) return null;
  const dateKeys = ['统计日期','日期','date','stat_date'];
  for (const key of dateKeys) {
    if (rows[0].hasOwnProperty(key)) {
      const vals = Array.from(new Set(rows.map(r => String(r[key] || '').trim()).filter(Boolean)));
      if (vals.length === 1) {
        const v = vals[0].replace(/[-/]/g,'');
        if (/^\d{8}$/.test(v)) {
          return `${v.slice(0,4)}-${v.slice(4,6)}-${v.slice(6,8)}`;
        }
      }
    }
  }
  return null;
}
function handleRowsWithDateAutofill(file, rows) {
  const dateInput = document.getElementById('statDate');
  if (!dateInput.value) {
    const fromRows = inferDateFromRows(rows);
    if (fromRows) {
      dateInput.value = fromRows;
    } else {
      const fromName = inferDateFromFilename(file.name);
      if (fromName) dateInput.value = fromName;
    }
  }
  handleRows(rows);
}

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if(!file) return;

  const ext = file.name.split('.').pop().toLowerCase();
  if(ext === 'csv'){
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (res) => handleRowsWithDateAutofill(file, res.data)
    });
    return;
  } else {
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
    handleRowsWithDateAutofill(file, json);
  }
});

function handleRows(rows){
  parsedRows = rows.map(r => {
    const row = {
      product_id: r.product_id ?? r.productId ?? r.id ?? '',
      exposure: toNum(r.exposure ?? r.impressions),
      visitors: toNum(r.visitors ?? r.sessions),
      views: toNum(r.views ?? r.pageviews),
      add_people: toNum(r.add_people ?? r.addPeople),
      add_count: toNum(r.add_count ?? r.addCount),
      pay_items: toNum(r.pay_items ?? r.payItems),
      pay_orders: toNum(r.pay_orders ?? r.payOrders ?? r.orders),
      pay_buyers: toNum(r.pay_buyers ?? r.payBuyers ?? r.buyers),
    };
    Object.assign(row, derive(row));
    return row;
  }).filter(r => r.product_id);

  table.clear().rows.add(parsedRows).draw();

  const btn = document.getElementById('saveBtn');
  btn.disabled = parsedRows.length === 0;
  btn.classList.toggle('enabled', parsedRows.length>0);
}

document.getElementById('saveBtn').addEventListener('click', async () => {
  const stat_date = document.getElementById('statDate').value || new Date().toISOString().slice(0,10);
  const source_code = document.getElementById('sourceCode').value;
  const platform = document.getElementById('platform').value;

  const payload = { source_code, platform, stat_date, rows: parsedRows };
  const resp = await fetch('/api/submitData', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await resp.json();
  if(data.success){
    alert('入库成功：' + data.count + ' 条');
  } else {
    alert('入库失败：' + (data.error || '未知错误'));
  }
});

// 默认日期 = 今天
document.getElementById('statDate').valueAsDate = new Date();
</script>
</body>
</html>