<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>自运营数据分析 · 对比增强版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- libs -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <style>
    :root { --bg:#0f172a; --panel:#0b1a3b; --brand:#1e40af; --blue:#2563EB; --orange:#F97316; --text:#E5E7EB; --muted:#94a3b8; }
    *{box-sizing:border-box}
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; background:#0b1220; color:var(--text);}
    .container { display: flex; height: 100vh; }
    .sidebar { width: 220px; background: var(--bg); color: #fff; padding: 16px; border-right: 1px solid #1f2937; }
    .sidebar h3 { margin: 0 0 10px 0; font-size:16px; }
    .sidebar ul { list-style: none; padding-left: 0; }
    .sidebar li { margin-bottom: 10px; }
    .sidebar a { text-decoration: none; color: #94a3b8; font-size: 14px; display: block; padding: 6px 8px; border-radius: 6px; }
    .sidebar a:hover { color: #fff; background:#0b1a3b; }
    .sidebar .submenu { list-style: none; padding-left: 14px; display: none; }
    .sidebar .submenu a { font-size: 13px; color: #94a3b8; }
    .sidebar .submenu a.active { color: #fff; background-color: var(--brand); }
    .sidebar .has-submenu > a { cursor: pointer; }
    .sidebar .has-submenu.open > .submenu { display: block; }
    .main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
    .upload-section { background: #0b1220; color: #fff; padding: 12px 16px; border-bottom:1px solid #1f2937; }
    .upload-top { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .upload-btn { background: #00b488; color: #001; padding: 8px 16px; border: none; border-radius: 24px; font-size: 14px; font-weight: bold; cursor: pointer; }
    .upload-section input[type="file"] { display: none; }
    .btn { background: var(--blue); color: #fff; padding: 8px 12px; border: 0; border-radius: 8px; cursor: pointer; }
    .sel, .date-filter, .num { color: #0b1220; padding: 7px 8px; font-size: 14px; border-radius: 8px; border: 1px solid #334155; background:#fff; }
    .tabs { display:flex; gap:12px; padding:10px 16px; border-bottom:1px solid #1f2937; background:#0b1220;}
    .tab { padding:8px 12px; border-radius:8px; background:#111827; color:#9CA3AF; cursor:pointer; }
    .tab.active { background:#1f2937; color:#fff; box-shadow: inset 0 -2px 0 0 var(--blue); }
    .content { flex:1; overflow:auto; }
    .content-pad{ padding: 14px 16px; }
    .kpi { display:grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap:10px; }
    .card { background:var(--panel); color:#fff; padding:12px; border-radius:10px; min-width:160px; }
    .card h4 { margin:0 0 6px 0; font-size:13px; color:#93c5fd; }
    .card p { margin:0; font-size:18px; font-weight:bold; }
    .grid { display:grid; gap:16px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .panel { background:var(--panel); border-radius:12px; padding:12px; }
    .panel h3 { margin:0 0 10px 0; font-weight:600; font-size:15px; color:#93c5fd;}
    #report_wrapper { background:var(--panel); border-radius:12px; padding:8px; }
    table.dataTable thead th { color:#93c5fd; }
    table.dataTable thead th.sorting_asc, table.dataTable thead th.sorting_desc { color:#fff !important; background:#1f2937 !important; }
    table.dataTable tbody td, table.dataTable thead th { border-color:#172554 !important; }
    /* 链接：浅色、无白底、hover 更亮 */
    #report a, #report a:visited {
      color: #e5e7eb;
      background: transparent !important;
      text-decoration: none;
      font-weight: 600;
    }
    #report a:hover { color: #ffffff; text-decoration: underline; }
    /* 表格文字再亮一点 */
    table.dataTable tbody td { color: #e5e7eb; }
    .notice { font-size: 12px; color: var(--muted); }
    .progress { font-size: 13px; margin-left: 8px; }
    .divider { height:1px; background:#1f2937; margin:8px 0 12px; }
    /* Top6 下方链接列表 */
    .legend-list a { color:#e5e7eb; text-decoration:none; margin-right:10px; }
    .legend-list a:hover { text-decoration:underline; color:#fff; }
    /* ===== 商品(ID) 列：蓝底 + 白字 + 加粗 ===== */
/* 主表第一列 */
#report.dataTable tbody td:first-child {
  background-color: #1e3a8a !important;  /* 蓝色底 */
  color: #ffffff !important;             /* 白字 */
  font-weight: 800;                      /* 加粗 */
  border-color: #1f2a5f !important;
}

/* 第一列里的超链接：白色 + 加粗，hover 更亮 */
#report.dataTable tbody td:first-child a,
#report.dataTable tbody td:first-child a:visited {
  color: #ffffff !important;
  font-weight: 800;
  text-decoration: none;
}
#report.dataTable tbody td:first-child a:hover {
  color: #ffffff !important;
  text-decoration: underline;
}

/* DataTables 排序高亮（sorting_1）有时会把第一列刷白，这里强制回蓝底 */
#report.dataTable tbody td.sorting_1:first-child {
  background-color: #1e3a8a !important;
  color: #ffffff !important;
}

/* FixedColumns 左侧克隆表也要同步样式（它只包含被固定的第一列） */
.DTFC_Cloned tbody td {
  background-color: #1e3a8a !important;
  color: #ffffff !important;
  font-weight: 800;
  border-color: #1f2a5f !important;
}
.DTFC_Cloned tbody td.sorting_1 {
  background-color: #1e3a8a !important;
  color: #ffffff !important;
}

/* 悬停整行时，第一列仍保持蓝底白字 */
#report.dataTable tbody tr:hover td:first-child,
.DTFC_Cloned tbody tr:hover td {
  background-color: #1e40af !important; /* 稍深一点的蓝，表示 hover */
  color: #ffffff !important;
}

/* （可选）表头第一列也用蓝底白字 */
#report thead th:first-child {
  background-color: #1f2a5f !important;
  color: #ffffff !important;
  font-weight: 800;
}
    /* 首列商品ID：保持蓝底，但文字改成默认的浅蓝色 */
#report.dataTable tbody td:first-child a,
#report.dataTable tbody td:first-child a:visited {
  color: #60a5fa !important;   /* 默认浅蓝（和页面其它链接一致） */
  font-weight: 800;            /* 保持加粗 */
  text-decoration: none;
}
#report.dataTable tbody td:first-child a:hover {
  color: #93c5fd !important;   /* hover 更亮一点 */
  text-decoration: underline;
}

/* FixedColumns 左侧克隆表里的链接也同步为蓝色 */
.DTFC_Cloned tbody td a,
.DTFC_Cloned tbody td a:visited {
  color: #60a5fa !important;
  font-weight: 800;
  text-decoration: none;
}
.DTFC_Cloned tbody td a:hover {
  color: #93c5fd !important;
  text-decoration: underline;
}


  </style>
  
</head>
<body>
<div class="container">
  <!-- 左侧导航（和你现有结构一致） -->
  <nav class="sidebar" id="sidebar">
    <h3>产品导航</h3>
    <ul>
      <li class="has-submenu">
        <a href="#">速卖通</a>
        <ul class="submenu">
          <li><a href="index.html">全托管</a></li>
          <li><a href="self-operated-final-contrast.html" class="active">自运营</a></li>
        </ul>
      </li>
      <li><a href="#">TikTok Shop</a></li>
      <li><a href="#">亚马逊</a></li>
      <li class="has-submenu">
        <a href="#">独立站</a>
        <ul class="submenu">
          <li><a href="independent-site.html">数据分析</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div class="main">
    <!-- 顶部：上传 + 全局过滤 -->
    <div class="upload-section">
      <div class="upload-top">
        <div class="controls">
          <label for="fileInput" class="upload-btn">选择文件</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
          <span class="notice">（上传→服务端入库→可视化与明细展示）</span>
          <span id="progress" class="progress"></span>
        </div>
        <div class="controls">
          <span>粒度：</span>
          <select id="granularity" class="sel">
            <option value="week" selected>自然周</option>
            <option value="month">自然月</option>
            <option value="day">按日</option>
          </select>
          <span>日期：</span>
          <input id="dateFilter" class="date-filter" placeholder="选择日期范围">
          <button id="refreshBtn" class="btn">刷新</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="kpi">
        <div class="card"><h4>平均访客比</h4><p id="avgVisitor">0%</p></div>
        <div class="card"><h4>平均加购比</h4><p id="avgCart">0%</p></div>
        <div class="card"><h4>平均支付比</h4><p id="avgPay">0%</p></div>
        <div class="card"><h4>商品总数</h4><p id="totalProducts">0</p></div>
        <div class="card"><h4>加购商品数</h4><p id="cartedProducts">0</p></div>
        <div class="card"><h4>支付商品数</h4><p id="purchasedProducts">0</p></div>
      </div>
    </div>

    <!-- 顶部 Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="summary">汇总对比</div>
      <div class="tab" data-tab="detail">明细表</div>
    </div>

    <div class="content">
      <!-- 汇总对比 -->
      <section id="summary" class="content-pad">
        <div class="panel">
          <h3>周期 A vs 周期 B · 总量曲线（按天）</h3>
          <div class="controls" style="margin-bottom:8px;">
            <span>维度：</span>
            <select id="metricSel" class="sel">
              <option value="exposure_sum">曝光量总和</option>
              <option value="visitors_sum">访客数总和</option>
              <option value="add_people_sum">加购人数总和</option>
              <option value="fav_sum">收藏总数</option>
              <option value="orders_sum">下单总数</option>
            </select>
            <span class="notice">A = 当前选择；B = 上一周期（向前平移同长度）。</span>
          </div>
          <div id="lineChart" style="width:100%;height:360px;"></div>
        </div>

        <div class="grid grid-2" style="margin-top:16px;">
          <div class="panel">
            <h3>平均比率对比（A vs B）</h3>
            <div id="ratioBar" style="width:100%;height:300px;"></div>
            <div class="notice">对比：平均加购比、平均访客比、平均支付比。</div>
          </div>
          <div class="panel">
            <h3>Top6 加购商品（A & B 同图）</h3>
            <div id="topBar" style="width:100%;height:320px;"></div>
            <div id="topBarLinks" class="legend-list" style="margin-top:6px;"></div>
          </div>
        </div>
      </section>

      <!-- 明细表 -->
      <section id="detail" class="content-pad" style="display:none;">
        <div class="panel">
          <h3>数据明细</h3>
          <div class="table-wrapper">
            <table id="report" class="display nowrap" style="width:100%"></table>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
/* ---------- UI 基础 ---------- */
(function() { $('.has-submenu > a').on('click', function(e){ e.preventDefault(); $(this).parent().toggleClass('open'); }); })();
$('.tab').on('click', function(){
  $('.tab').removeClass('active'); $(this).addClass('active');
  const id = $(this).data('tab'); $('#summary').toggle(id==='summary'); $('#detail').toggle(id==='detail');
});
const toNum = v => { if (v===null||v===undefined) return 0; if (typeof v==='number') return isFinite(v)?v:0; const n=parseFloat(String(v).replace(/,/g,'').trim()); return isNaN(n)?0:n; };

/* ---------- 高对比样式常量（给 ECharts 用） ---------- */
const AXIS_LABEL = { color: '#E5E7EB', fontWeight: 700, fontSize: 12 };
const GRID_LINE  = 'rgba(148,163,184,0.18)';

/* ---------- 上传 Excel → 入库 ---------- */
$('#fileInput').on('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(evt) {
    try {
      $('#progress').text('解析中…');
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
      if (sheet.length < 2) throw new Error('表格无有效数据');
      const headers = sheet[0].map(h => String(h).trim());

      const findIdx = (re) => headers.findIndex(h => re.test(String(h).trim()));
      const idx = {
        product_id: findIdx(/^(商品)?ID$|^商品id$|^id$|^item id$|^item_id$/i),
        stat_date:  findIdx(/^(统计时间|日期|数据时间|date)$/i),
        exposure:   findIdx(/^(搜索曝光量|曝光量|商品曝光量|impressions)$/i),
        visitors:   (function(){ const rs=[/^(商品)?访客数$/i,/^访客人数$/i,/^访客量$/i,/^uv$/i,/^sessions$/i];
          for (const re of rs){const i = findIdx(re); if(i!==-1) return i;}
          const i2=headers.findIndex(h=>/访客数|访客/i.test(String(h).trim())&&!/(老|新|回|复)访客/i.test(String(h).trim()));
          return i2;
        })(),
        visitors_new: findIdx(/^(新访客数|新访客|新用户|新增访客)$/i),
        visitors_old: findIdx(/^(老访客数|老访客|回访客|复访客)$/i),
        views:      findIdx(/^(商品浏览量|浏览量|pv|page views)$/i),
        add_people: findIdx(/^(商品加购人数|加购人数|加购买家数)$/i),
        add_count:  findIdx(/^(商品加购件数|加购件数)$/i),
        pay_items:  findIdx(/^支付件数$/i),
        pay_orders: findIdx(/^(支付订单数|下单人数|订单数)$/i),
        pay_buyers: findIdx(/^(支付买家数|支付人数|成交人数)$/i),
        fav_people: findIdx(/^(收藏人数|收藏买家数|收藏用户数)$/i),
        fav_count:  findIdx(/^(收藏件数|收藏量)$/i)
      };
      if (idx.product_id<0 || idx.stat_date<0) throw new Error('缺少必填：商品ID / 统计时间');

      function excelDateToISO(n){ if(typeof n!=='number') return null; const utc_days=Math.floor(n-25569); const utc_value=utc_days*86400; const date_info=new Date(utc_value*1000); const y=date_info.getUTCFullYear(); const m=(date_info.getUTCMonth()+1).toString().padStart(2,'0'); const d=date_info.getUTCDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; }
      function parseDateToISO(v){ if(v===null||v===undefined||v==='') return null; if(typeof v==='number') return excelDateToISO(v); let s=String(v).trim(); s=s.replace(/[.]/g,'-').replace(/\//g,'-'); const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`; const m2=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/); if(m2) return `${m2[3]}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`; return s.slice(0,10); }

      const rows = sheet.slice(1).filter(r => r && r.length).map(r => {
        const pid = String(r[idx.product_id]).trim();
        const sd  = parseDateToISO(r[idx.stat_date]);
        const visitors = (idx.visitors !== -1 ? toNum(r[idx.visitors])
                        : ((idx.visitors_new !== -1 ? toNum(r[idx.visitors_new]) : 0)
                        + (idx.visitors_old !== -1 ? toNum(r[idx.visitors_old]) : 0)));
        const row = {
          product_id: pid, stat_date: sd,
          exposure:  idx.exposure  === -1 ? 0 : toNum(r[idx.exposure]),
          visitors,
          views:     idx.views     === -1 ? 0 : toNum(r[idx.views]),
          add_people:idx.add_people=== -1 ? 0 : toNum(r[idx.add_people]),
          add_count: idx.add_count === -1 ? 0 : toNum(r[idx.add_count]),
          pay_items: idx.pay_items === -1 ? 0 : toNum(r[idx.pay_items]),
          pay_orders:idx.pay_orders=== -1 ? 0 : toNum(r[idx.pay_orders]),
          pay_buyers:idx.pay_buyers=== -1 ? 0 : toNum(r[idx.pay_buyers]),
        };
        if (idx.fav_people !== -1) row.fav_people = toNum(r[idx.fav_people]);
        if (idx.fav_count  !== -1) row.fav_count  = toNum(r[idx.fav_count]);
        return row;
      }).filter(x => x.product_id && x.stat_date);
      const dmap=new Map(); rows.forEach(r=>dmap.set(r.product_id+'__'+r.stat_date,r)); const deduped=Array.from(dmap.values());

      $('#progress').text(`入库中（${deduped.length} 条）…`);
      const resp = await fetch('/api/ae_upsert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rows: deduped }) });
      const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Upsert API响应不是JSON：' + txt.slice(0,200)); }
      if (!resp.ok || !j.ok) throw new Error(j.error || '入库失败');
      $('#progress').text('入库完成 ✔'); $('#refreshBtn').click();
    } catch(err) {
      console.error(err); alert('处理失败：' + (err.message || err)); $('#progress').text('');
    }
  };
  reader.readAsArrayBuffer(file);
});

/* ---------- 查询 / 汇总 ---------- */
async function fetchAgg(startISO, endISO, granularity) {
  const url = `/api/ae_query?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}&granularity=${encodeURIComponent(granularity)}`;
  const resp = await fetch(url);
  const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Query API响应不是JSON：' + txt.slice(0,200)); }
  if (!resp.ok || !j.ok) throw new Error(j.error || '查询失败');
  return j.rows || [];
}
function periodShift(startISO, endISO) {
  const start = new Date(startISO + 'T00:00:00'); const end = new Date(endISO + 'T00:00:00');
  const days = Math.round((end - start) / 86400000) + 1;
  const prevEnd = new Date(start.getTime() - 86400000);
  const prevStart = new Date(prevEnd.getTime() - (days-1)*86400000);
  const fmt = d => d.toISOString().slice(0,10);
  return { prevStart: fmt(prevStart), prevEnd: fmt(prevEnd), days };
}
function computeCards(rows) {
  if (!rows.length) {
    $('#avgVisitor').text('0%'); $('#avgCart').text('0%'); $('#avgPay').text('0%');
    $('#totalProducts').text(0); $('#cartedProducts').text(0); $('#purchasedProducts').text(0); return;
  }
  const sum = rows.reduce((a,b)=>({exposure:a.exposure+b.exposure,visitors:a.visitors+b.visitors,add_people:a.add_people+b.add_people,pay_buyers:a.pay_buyers+b.pay_buyers}), {exposure:0,visitors:0,add_people:0,pay_buyers:0});
  const products=new Map(); rows.forEach(r=>{ if(!products.has(r.product_id)) products.set(r.product_id,{exp:0,add:0,pay:0}); const acc=products.get(r.product_id); acc.exp+=r.exposure||0; acc.add+=r.add_people||0; acc.pay+=r.pay_buyers||0; });
  let pe=0,pc=0,pp=0; products.forEach(v=>{ if(v.exp>0)pe++; if(v.add>0)pc++; if(v.pay>0)pp++; });
  const vr=sum.exposure>0?((sum.visitors/sum.exposure)*100).toFixed(2)+'%':'0%';
  const cr=sum.visitors>0?((sum.add_people/sum.visitors)*100).toFixed(2)+'%':'0%';
  const pr=sum.add_people>0?((sum.pay_buyers/sum.add_people)*100).toFixed(2)+'%':'0%';
  $('#avgVisitor').text(vr); $('#avgCart').text(cr); $('#avgPay').text(pr);
  $('#totalProducts').text(products.size); $('#cartedProducts').text(pc); $('#purchasedProducts').text(pp);
}
function buildDailyTotals(rows, days, startISO) {
  const byDay=new Map(); rows.forEach(r=>{ const d=r.bucket; if(!byDay.has(d)) byDay.set(d,{exp:0,vis:0,add:0,fav:0,orders:0}); const a=byDay.get(d); a.exp+=r.exposure||0; a.vis+=r.visitors||0; a.add+=r.add_people||0; a.orders+=r.pay_orders||0; a.fav+=(r.fav_people||r.fav_count||0); });
  const x=[],A=[]; const start=new Date(startISO+'T00:00:00');
  for(let i=0;i<days;i++){ const cur=new Date(start.getTime()+i*86400000); const key=cur.toISOString().slice(0,10); x.push(`Day ${i+1}`); const a=byDay.get(key)||{exp:0,vis:0,add:0,fav:0,orders:0}; A.push({exp:a.exp,vis:a.vis,add:a.add,fav:a.fav,orders:a.orders,date:key}); }
  return { x, A };
}
function drawLineChartDaily(rowsA, rowsB, days, startA, startB, metricKey) {
  const chart=echarts.init(document.getElementById('lineChart'));
  const A=buildDailyTotals(rowsA,days,startA); const B=buildDailyTotals(rowsB,days,startB); const x=A.x;
  function pick(arr){ return arr.map(o=>Number((o[metricKey]||0))) }
  chart.setOption({
    tooltip:{ trigger:'axis', formatter:(params)=>{ let s=''; params.forEach(p=>{ const series=p.seriesName==='周期A'?A.A:B.A; const o=series[p.dataIndex]; s+=`<div>${p.marker}${p.seriesName}：${p.data} <span style='color:#9CA3AF'>(${o?.date||''})</span></div>`; }); return s||'无数据'; }, backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
    legend:{ data:['周期A','周期B'], textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:40, right:16, top:36, bottom:24 },
    xAxis:{ type:'category', data:x, axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:true, lineStyle:{ color:GRID_LINE }} },
    yAxis:{ type:'value', axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE }} },
    series:[
      { name:'周期A', type:'line', data:pick(A.A), smooth:true, showSymbol:false, lineStyle:{ width:3 }, itemStyle:{ color:'#2563EB' } },
      { name:'周期B', type:'line', data:pick(B.A), smooth:true, showSymbol:false, lineStyle:{ width:3 }, itemStyle:{ color:'#F97316' } }
    ]
  }); window.addEventListener('resize', ()=>chart.resize());
}
function drawRatioBar(rowsA, rowsB){
  function sums(rows){ return rows.reduce((a,b)=>({exp:a.exp+b.exposure,vis:a.vis+b.visitors,add:a.add+b.add_people,pay:a.pay+b.pay_buyers}),{exp:0,vis:0,add:0,pay:0}); }
  const A=sums(rowsA), B=sums(rowsB);
  const d={ A:[(A.vis>0?A.add/A.vis*100:0),(A.exp>0?A.vis/A.exp*100:0),(A.add>0?A.pay/A.add*100:0)], B:[(B.vis>0?B.add/B.vis*100:0),(B.exp>0?B.vis/B.exp*100:0),(B.add>0?B.pay/B.add*100:0)] };
  const chart=echarts.init(document.getElementById('ratioBar'));
  chart.setOption({
    tooltip:{ trigger:'axis', backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
    legend:{ data:['周期A','周期B'], textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:40, right:16, top:36, bottom:24 },
    xAxis:{ type:'category', data:['平均加购比','平均访客比','平均支付比'], axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:false } },
    yAxis:{ type:'value', axisLabel:{ ...AXIS_LABEL, formatter:'{value} %' }, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE }} },
    series:[
      { name:'周期A', type:'bar', data:d.A.map(v=>Number(v.toFixed(2))), itemStyle:{ color:'#2563EB' }, label:{ show:true, position:'top', formatter:'{c}%', color:'#E5E7EB', fontWeight:700 } },
      { name:'周期B', type:'bar', data:d.B.map(v=>Number(v.toFixed(2))), itemStyle:{ color:'#F97316' }, label:{ show:true, position:'top', formatter:'{c}%', color:'#E5E7EB', fontWeight:700 } }
    ]
  }); window.addEventListener('resize', ()=>chart.resize());
}
async function drawTop6Both(rowsA, rowsB){
  function perAdd(rows){ const m=new Map(); rows.forEach(r=>m.set(r.product_id,(m.get(r.product_id)||0)+(r.add_people||0))); return m; }
  const mapA=perAdd(rowsA), mapB=perAdd(rowsB);
  const topN=(map,n=6)=>Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([id])=>id);
  const unionIds=Array.from(new Set([...topN(mapA,6),...topN(mapB,6)]));
  const rows=unionIds.map(id=>({id,a:mapA.get(id)||0,b:mapB.get(id)||0,max:Math.max(mapA.get(id)||0,mapB.get(id)||0)})).sort((x,y)=>y.max-x.max);
  const ids=rows.map(r=>r.id), labels=ids, dataA=rows.map(r=>r.a), dataB=rows.map(r=>r.b);
  function hue(id){ let h=0; for(let i=0;i<id.length;i++) h=(h*31+id.charCodeAt(i))%360; return h; }
  const colorsA=ids.map(id=>`hsl(${hue(id)}, 70%, 55%)`), colorsB=ids.map(id=>`hsl(${hue(id)}, 70%, 80%)`);
  const chart=echarts.init(document.getElementById('topBar'));
  chart.setOption({
    tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' }, backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
    legend:{ textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:140, right:20, top:20, bottom:24 },
    xAxis:{ type:'value', axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE }} },
    yAxis:{ type:'category', data:labels, axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:false } },
    series:[
      { name:'周期A', type:'bar', data:dataA.map((v,i)=>({value:v,itemStyle:{color:colorsA[i]}})), label:{ show:true, position:'right', color:'#E5E7EB', fontWeight:700 } },
      { name:'周期B', type:'bar', data:dataB.map((v,i)=>({value:v,itemStyle:{color:colorsB[i]}})), label:{ show:true, position:'right', color:'#E5E7EB', fontWeight:700 } }
    ]
  });
  chart.off('click'); chart.on('click', p=>{ const id=ids[p.dataIndex]; if(id) window.open(`https://aliexpress.com/item/${id}.html`,'_blank'); });
  window.addEventListener('resize', ()=>chart.resize());
  const linksDiv=document.getElementById('topBarLinks');
  if(linksDiv){ linksDiv.innerHTML=ids.map(id=>`<a href="https://aliexpress.com/item/${id}.html" target="_blank">#${id}</a>`).join(' '); }
}
async function renderTable(rows, granularity) {
  if (window.dataTable) window.dataTable.destroy(); $('#report').empty();
  const data = rows.map(r => {
    const link = r.product_id ? `<a href="https://aliexpress.com/item/${r.product_id}.html" target="_blank">${r.product_id}</a>` : '';
    const conv1 = r.exposure>0 ? ((r.visitors/r.exposure)*100).toFixed(2) : '0.00';
    const conv2 = r.visitors>0 ? ((r.add_people/r.visitors)*100).toFixed(2) : '0.00';
    const conv3 = r.add_people>0 ? ((r.pay_buyers/r.add_people)*100).toFixed(2) : '0.00';
    return [link, r.bucket_label || r.bucket, conv1 + '%', conv2 + '%', conv3 + '%', r.exposure, r.visitors, r.views, r.add_people, r.add_count, r.pay_items, r.pay_orders, r.pay_buyers];
  });
  window.dataTable = $('#report').DataTable({
    data,
    columns: [
      { title: '商品（ID）' },
      { title: granularity==='day' ? '日期' : (granularity==='week' ? '周范围' : '月份范围') },
      { title: '访客比(%)' }, { title: '加购比(%)' }, { title: '支付比(%)' },
      { title: '曝光量' }, { title: '访客数' }, { title: '浏览量' },
      { title: '加购人数' }, { title: '加购件数' }, { title: '支付件数' },
      { title: '支付订单数' }, { title: '支付买家数' }
    ],
    order: [[1,'desc']], scrollX:true, scrollY:'calc(100vh - 420px)', scrollCollapse:true, fixedHeader:true, fixedColumns:{leftColumns:1}
  });
}
async function fetchAndRenderAll() {
  try {
    const val=$('#dateFilter').val(); let startISO,endISO;
    if (val && val.includes(' to ')) { const [s,e]=val.split(' to '); startISO=s; endISO=e; }
    else { const today=new Date(); endISO=today.toISOString().slice(0,10); startISO=new Date(today.getTime()-6*86400000).toISOString().slice(0,10); $('#dateFilter').val(`${startISO} to ${endISO}`); }
    const g=$('#granularity').val(); $('#progress').text('查询中…');

    const rowsNowAgg=await fetchAgg(startISO,endISO,g);
    computeCards(rowsNowAgg);
    await renderTable(rowsNowAgg,g);

    const { prevStart, prevEnd, days }=periodShift(startISO,endISO);
    const rowsA=await fetchAgg(startISO,endISO,'day');
    const rowsB=await fetchAgg(prevStart,prevEnd,'day');
    const metricKey=(function(k){ if(k==='exposure_sum')return 'exp'; if(k==='visitors_sum')return 'vis'; if(k==='add_people_sum')return 'add'; if(k==='orders_sum')return 'orders'; if(k==='fav_sum')return 'fav'; })(document.getElementById('metricSel').value);
    drawLineChartDaily(rowsA,rowsB,days,startISO,prevStart,metricKey);
    drawRatioBar(rowsA,rowsB);
    await drawTop6Both(rowsA,rowsB);

    $('#progress').text(`A: ${rowsA.length} 条 · B: ${rowsB.length} 条`);
  } catch (err) {
    console.error(err); alert('查询失败：' + (err.message || err)); $('#progress').text('');
  }
}
/* ---------- 初始化 ---------- */
const fp=flatpickr('#dateFilter',{ mode:'range', dateFormat:'Y-m-d', onClose:(ds)=>{ if(ds.length===2) fetchAndRenderAll(); } });
$('#refreshBtn').on('click', fetchAndRenderAll);
$('#metricSel, #granularity').on('change', fetchAndRenderAll);
(async function initDefault(){
  const today=new Date(); const end=today.toISOString().slice(0,10);
  const startDate=new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
  $('#dateFilter').val(`${startDate} to ${end}`);
  await fetchAndRenderAll();
})();
</script>
</body>
</html>
