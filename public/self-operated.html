<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title id="pageTitle">跨境电商数据分析平台 - 自运营Robot站</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- libs -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <!-- 主题样式（沿用你现有的） -->
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250810b">
  <link rel="stylesheet" href="assets/global-theme.css">
  <script src="assets/site-nav.js"></script>
  <script src="assets/page-template.js"></script>
  <script src="assets/self-operated.js"></script>
  <style>
    /* 移除旧的KPI样式，使用全局UI系统 */
    /* 旧的样式已被全局主题系统替代 */
    
    /* 站点选择器样式 */
    .site-selector {
      padding: 10px 15px;
      border-bottom: 1px solid #374151;
    }
    .site-selector select {
      width: 100%;
      padding: 8px;
      border: 1px solid #4b5563;
      border-radius: 4px;
      background: #1f2937;
      color: white;
      font-size: 14px;
    }
    .add-site-btn {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }
    .add-site-btn:hover {
      background: #2563eb;
    }
    
    /* 使用全局UI系统的样式，移除旧的骨架屏样式 */
    .loading-state {
      text-align: center;
      background: #f8fafc;
      border-radius: 8px;
      margin: 20px 0;
      padding: 40px 20px;
    }
    
    .loading-bar {
      width: 200px;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      margin: 0 auto 20px;
      overflow: hidden;
    }
    
    .loading-progress {
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      border-radius: 2px;
      animation: loading-progress 2s ease-in-out infinite;
    }
    
    @keyframes loading-progress {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(0%); }
      100% { transform: translateX(100%); }
    }
    
    .loading-text {
      color: #6b7280;
      font-size: 14px;
      margin: 0;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .controls {
      margin-bottom: 16px;
    }
    
    .sel {
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: white;
      margin: 0 8px;
    }
    
    .notice {
      color: #6b7280;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .legend-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .legend-list a {
      color: #3b82f6;
      text-decoration: none;
      font-size: 12px;
    }
    
    .legend-list a:hover {
      text-decoration: underline;
    }
    
    /* KPI对比数据样式 */
    .kpi-comparison {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      text-align: center;
    }
    
    .kpi-comparison .text-green-600 {
      color: #059669;
    }
    
    .kpi-comparison .text-red-600 {
      color: #dc2626;
    }
    
    .kpi-comparison .text-gray-500 {
      color: #6b7280;
    }
    
    /* 状态显示样式 */
    .status-display {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      min-width: 120px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .status-display.loading {
      background: rgba(59, 130, 246, 0.1);
      color: #1d4ed8;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .status-display.success {
      background: rgba(34, 197, 94, 0.1);
      color: #166534;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    
    .status-display.error {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* 新增：优化运营分析和产品分析页面的UI */
    
    /* 分析页面容器样式 - 改为白色背景与主页面一致 */
    .analysis-container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    
    .analysis-container h3 {
      color: #374151;
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 20px 0;
      text-align: center;
      text-shadow: none;
    }
    
    /* 分析KPI卡片网格 */
    .analysis-kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
         .analysis-kpi-card {
       background: white;
       border-radius: 12px;
       padding: 20px;
       text-align: center;
       box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
       transition: all 0.3s ease;
       border: 2px solid transparent;
       position: relative;
       overflow: hidden;
     }
     
     .analysis-kpi-card:hover {
       transform: translateY(-4px);
       box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
       border-color: rgba(59, 130, 246, 0.3);
     }
     
     /* 渐变色顶部标识 */
     .analysis-kpi-card::before {
       content: '';
       position: absolute;
       top: 0;
       left: 0;
       right: 0;
       height: 4px;
       background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #ef4444);
       background-size: 200% 100%;
       animation: gradient-shift 3s ease-in-out infinite;
     }
     
     @keyframes gradient-shift {
       0%, 100% { background-position: 0% 50%; }
       50% { background-position: 100% 50%; }
     }
     
     /* 产品分析页面的KPI卡片特殊样式 */
     #products .analysis-kpi-card::before {
       background: linear-gradient(90deg, #8b5cf6, #06b6d4, #10b981, #f59e0b);
     }
    
    .analysis-kpi-card h4 {
      color: #374151;
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .analysis-kpi-card p {
      color: #1f2937;
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
         /* 图表网格布局 */
     .charts-grid {
       display: grid;
       grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
       gap: 20px;
     }
     
     .chart-panel {
       background: white;
       border-radius: 12px;
       padding: 20px;
       box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
       transition: all 0.3s ease;
       border: 1px solid #e5e7eb;
       position: relative;
       overflow: hidden;
     }
     
     .chart-panel:hover {
       transform: translateY(-2px);
       box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
     }
     
     .chart-panel h3 {
       color: #374151;
       font-size: 18px;
       font-weight: 600;
       margin: 0 0 16px 0;
       text-align: center;
       text-shadow: none;
     }
     
     /* 图表容器样式优化 - 让曲线延伸到KPI框内 */
     .chart-panel .echarts-for-react,
     .chart-panel div[id*="Chart"] {
       width: 100% !important;
       height: 100% !important;
       min-height: 300px;
     }
     
     /* 产品分析页面的图表特殊样式 */
     #products .chart-panel {
       padding: 24px;
       min-height: 350px;
     }
     
     #products .chart-panel div[id*="Chart"] {
       min-height: 280px;
       margin: -12px;
       width: calc(100% + 24px) !important;
       height: calc(100% + 24px) !important;
     }
    
    /* 产品选择器样式 */
    .product-selector {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    
    .product-selector .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .product-selector label {
      font-weight: 600;
      color: #374151;
      min-width: 60px;
    }
    
    .product-selector .sel {
      min-width: 200px;
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
         .product-selector .sel:focus {
       outline: none;
       border-color: #3b82f6;
       box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
     }
     
     .product-selector .product-count-info {
       margin-left: auto;
       padding: 8px 16px;
       background: #f3f4f6;
       border-radius: 6px;
       font-size: 14px;
       color: #374151;
     }
     
     .product-selector .product-count-info strong {
       color: #1f2937;
       font-weight: 600;
     }
     
     .product-selector .time-controls {
       margin-top: 16px;
       padding-top: 16px;
       border-top: 1px solid #e5e7eb;
       display: flex;
       align-items: center;
       gap: 12px;
       flex-wrap: wrap;
     }
     
     .product-selector .time-controls label {
       font-weight: 600;
       color: #374151;
       min-width: 80px;
     }
     
     .product-selector .time-controls .date-filter {
       padding: 8px 12px;
       border: 2px solid #e5e7eb;
       border-radius: 8px;
       font-size: 14px;
       transition: all 0.3s ease;
       min-width: 200px;
     }
     
     .product-selector .time-controls .date-filter:focus {
       outline: none;
       border-color: #3b82f6;
       box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
     }
     
     .product-selector img {
       border-radius: 8px;
       border: 2px solid #e5e7eb;
     }
     
     .product-selector a {
       color: #3b82f6;
       text-decoration: none;
       font-weight: 500;
       transition: color 0.3s ease;
     }
     
     .product-selector a:hover {
       color: #2563eb;
       text-decoration: underline;
     }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
      .analysis-container {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .analysis-kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .product-selector .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .product-selector .sel {
        min-width: auto;
        width: 100%;
      }
    }
    
    /* 动画效果 */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .analysis-container {
      animation: fadeInUp 0.6s ease-out;
    }
    
    .analysis-kpi-card {
      animation: fadeInUp 0.6s ease-out;
      animation-fill-mode: both;
    }
    
         .analysis-kpi-card:nth-child(1) { animation-delay: 0.1s; }
     .analysis-kpi-card:nth-child(2) { animation-delay: 0.2s; }
     .analysis-kpi-card:nth-child(3) { animation-delay: 0.3s; }
     .analysis-kpi-card:nth-child(4) { animation-delay: 0.4s; }
     
     /* 新增：优化产品详情分析页面的UI */
     .product-info-panel {
       background: #f9fafb;
       border-radius: 12px;
       padding: 20px;
       margin-bottom: 24px;
       box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
       border: 1px solid #e5e7eb;
     }
     
     .product-header {
       display: flex;
       justify-content: space-around;
       align-items: center;
       gap: 20px;
       flex-wrap: wrap;
     }
     
     .product-id, .product-link, .product-listing-date {
       text-align: center;
       flex: 1;
       min-width: 150px;
     }
     
     .product-id h4, .product-link h4, .product-listing-date h4 {
       color: #374151;
       font-size: 14px;
       font-weight: 600;
       margin-bottom: 8px;
     }
     
     .product-id p, .product-listing-date p {
       color: #1f2937;
       font-size: 24px;
       font-weight: 700;
       margin: 0;
       text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
     }
     
     .product-link-btn {
       background: #3b82f6;
       color: white;
       padding: 10px 20px;
       border-radius: 8px;
       font-size: 16px;
       font-weight: 600;
       text-decoration: none;
       transition: background-color 0.3s ease;
       display: inline-block;
     }
     
     .product-link-btn:hover {
       background: #2563eb;
     }
   </style>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">跨境电商数据分析平台</div>
        <div class="form-subtitle">登录账户以继续</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">邮箱</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">密码</label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">👁️</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">登录</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">演示账户</div>
        <div class="demo-account-info">邮箱：demo@example.com<br>密码：demo123</div>
      </div>
    </div>
  </div>
</div>
<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> 跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali active"><a href="#" data-platform="ae_self_operated">速卖通</a>
        <ul class="dropdown" id="managedMenu">
          <li><a href="managed.html">全托管</a></li>
        </ul>
      </li>
      <li class="amazon"><a href="#" data-platform="amazon">亚马逊</a></li>
      <li class="tiktok"><a href="#" data-platform="tiktok">TikTok Shop</a></li>
      <li class="temu"><a href="#" data-platform="temu">Temu</a></li>
      <li class="ozon"><a href="#" data-platform="ozon">Ozon</a></li>
      <li class="independent"><a href="#" data-platform="independent">独立站</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout">
  <nav class="sidebar" id="sidebar">
    <div class="site-header">
      <span id="currentSite">自运营</span>
    </div>
    <ul class="sub-nav">
      <li><a href="#" class="active" data-target="detail">详细数据</a></li>
      <li><a href="#analysis" data-target="analysis">运营分析</a></li>
      <li><a href="#products" data-target="products">产品分析</a></li>
    </ul>
  </nav>

  <main class="main mx-auto max-w-container px-6">
    <!-- 页面标题 -->
    <div class="page-header" style="margin-bottom: 20px; text-align: center;">
      <h1 style="font-size: 28px; font-weight: 600; color: #1f2937; margin: 0;">自运营Robot站 - 智能数据分析与决策支持</h1>
    </div>
    
    <!-- 顶部：上传 + 全局过滤 -->
    <div class="upload-section">
      <div class="upload-top">
        <div class="controls">
          <label for="fileInput" class="upload-btn">选择文件</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
          <span class="notice">（上传→服务端入库→可视化与明细展示）</span>
          <span id="progress" class="progress"></span>
        </div>
        <div class="controls">
          <span>粒度：</span>
          <span class="sel" style="background:#1f2937;color:#fff;border-color:#334155;cursor:not-allowed">按日</span>
          <input type="hidden" id="granularity" value="day">
          <span>日期：</span>
          <input id="dateFilter" class="date-filter" placeholder="选择日期范围">
          <div id="statusDisplay" class="status-display">数据加载完成</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="kpi-grid">
        <div class="kpi-card info">
          <h4>平均访客比</h4>
          <p id="avgVisitor">0%</p>
          <div id="avgVisitorComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card success">
          <h4>平均加购比</h4>
          <p id="avgCart">0%</p>
          <div id="avgCartComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card success">
          <h4>平均支付比</h4>
          <p id="avgPay">0%</p>
          <div id="avgPayComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card success">
          <h4>商品总数</h4>
          <p id="totalProducts">0</p>
          <div id="totalProductsComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card warning">
          <h4>加购商品数</h4>
          <p id="cartedProducts">0</p>
          <div id="cartedProductsComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card danger">
          <h4>支付商品数</h4>
          <p id="purchasedProducts">0</p>
          <div id="purchasedProductsComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card info" style="cursor: pointer;" title="点击筛选新品数据">
          <h4>本周期新品数</h4>
          <p id="newProducts">0</p>
          <div id="newProductsClear" class="kpi-clear" style="display: none;">
            <a href="#" id="clearNewProductsFilter" style="color: #007bff; text-decoration: underline; font-size: 12px;">清除筛选</a>
          </div>
        </div>
      </div>
    </div>

    <!-- 顶部 Tabs -->
    <div class="content">
      <!-- 明细表 -->
      <section id="detail" class="content-pad">
        <div class="chart-container">
          <h3>数据明细</h3>
          
          <!-- 加载状态 -->
          <div id="detailLoading" class="loading-state" style="display: none;">
            <div class="loading-spinner"></div>
            <p class="loading-text">努力加载中,请等待片刻。。。</p>
          </div>
          
          <!-- 数据表格 -->
          <div id="detailContent">
            <table id="report" class="data-table display nowrap" style="width:100%"></table>
          </div>
        </div>
      </section>

      <!-- 运营分析 -->
      <section id="analysis" class="content-pad" style="display:none;">
        <div class="analysis-container">
          <h3>运营分析</h3>
          
          <!-- 运营分析KPI卡片 -->
          <div id="analysisKpi" class="analysis-kpi-grid">
            <div class="analysis-kpi-card">
              <h4>总展示数</h4>
              <p id="totalExposure">0</p>
              <div id="exposureComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>详情页访客数</h4>
              <p id="totalVisitors">0</p>
              <div id="visitorsComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>加购次数</h4>
              <p id="totalAddCount">0</p>
              <div id="addCountComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>订购商品数</h4>
              <p id="totalPayItems">0</p>
              <div id="payItemsComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>有曝光商品数</h4>
              <p id="exposedProducts">0</p>
              <div id="exposedProductsComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>有加购商品数</h4>
              <p id="cartedProducts">0</p>
              <div id="cartedProductsComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>有支付商品数</h4>
              <p id="paidProducts">0</p>
              <div id="paidProductsComparison" class="kpi-comparison"></div>
            </div>
          </div>
          
          <!-- 对比图表 -->
          <div class="charts-grid">
            <div class="chart-panel">
              <h3>总展示数对比</h3>
              <div id="exposureComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>详情页访客数对比</h3>
              <div id="visitorsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>加购次数对比</h3>
              <div id="addCountComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>订购商品数对比</h3>
              <div id="payItemsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>有曝光商品数对比</h3>
              <div id="exposedProductsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>有加购商品数对比</h3>
              <div id="cartedProductsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>有支付商品数对比</h3>
              <div id="paidProductsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
          </div>
        </div>
      </section>
             <!-- 产品分析 -->
       <section id="products" class="content-pad" style="display:none;">
         <div class="analysis-container">
           <h3>产品详情分析</h3>
           
           <!-- 产品基本信息 -->
           <div class="product-info-panel">
             <div class="product-header">
               <div class="product-id">
                 <h4>产品ID</h4>
                 <p id="currentProductId">--</p>
               </div>
               <div class="product-link">
                 <h4>产品链接</h4>
                 <a id="productLink" href="#" target="_blank" class="product-link-btn">查看产品</a>
               </div>
               <div class="product-listing-date">
                 <h4>上架时间</h4>
                 <p id="productListingDate">2025-07-03</p>
               </div>
             </div>
           </div>
          
                                 <!-- 产品选择器和时间控件 -->
            <div class="product-selector">
              <div class="controls">
                <label>产品：</label>
                <select id="productSelect" class="sel">
                  <option value="">加载中...</option>
                </select>
                <span class="notice">（按曝光量排序）</span>
                <div class="product-count-info">
                  <span>产品总数：<strong id="productTotalCount">0</strong></span>
                </div>
              </div>
              <div class="time-controls">
                <label>时间周期：</label>
                <input id="productDateFilter" class="date-filter" placeholder="选择日期范围">
                <span class="notice">（默认显示最近7天）</span>
              </div>
            </div>
           
                       <!-- 产品KPI - 单个产品的KPI指标 -->
            <div id="productKpi" class="analysis-kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div class="analysis-kpi-card">
                <h4>平均访客比</h4>
                <p id="productAvgVisitor">0%</p>
                <div id="productAvgVisitorComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>平均加购比</h4>
                <p id="productAvgCart">0%</p>
                <div id="productAvgCartComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>平均支付比</h4>
                <p id="productAvgPay">0%</p>
                <div id="productAvgPayComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>总曝光量</h4>
                <p id="productTotalExposure">0</p>
                <div id="productTotalExposureComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>总访客数</h4>
                <p id="productTotalVisitors">0</p>
                <div id="productTotalVisitorsComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>总加购人数</h4>
                <p id="productTotalAddPeople">0</p>
                <div id="productTotalAddPeopleComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>总支付买家数</h4>
                <p id="productTotalPayBuyers">0</p>
                <div id="productTotalPayBuyersComparison" class="kpi-comparison"></div>
              </div>
            </div>
          
          <!-- 产品趋势图表 -->
          <div id="productCharts" class="charts-grid" style="display:none;">
            <div class="chart-panel">
              <h3>曝光趋势</h3>
              <div id="productExposureChart" style="width:100%;height:260px;"></div>
            </div>
            <div class="chart-panel">
              <h3>访客比趋势</h3>
              <div id="productVisitorRateChart" style="width:100%;height:260px;"></div>
            </div>
            <div class="chart-panel">
              <h3>加购比趋势</h3>
              <div id="productAddRateChart" style="width:100%;height:260px;"></div>
            </div>
            <div class="chart-panel">
              <h3>支付比趋势</h3>
              <div id="productPayRateChart" style="width:100%;height:260px;"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
/* ---------- UI 基础 ---------- */
const toNum = v => { if (v===null||v===undefined) return 0; if (typeof v==='number') return isFinite(v)?v:0; const n=parseFloat(String(v).replace(/,/g,'').trim()); return isNaN(n)?0:n; };


// 统一点击率显示：<=1 视为 0~1 比率，先×100再加百分号；>1 视为已是百分数
function formatCtr(v){
  if (v==null || v==='') return '';
  let n = Number(v);
  if (!isFinite(n)) return '';
  if (n <= 1) n *= 100;
  return n.toFixed(2) + '%';
}
/* ---------- 高对比样式常量（给 ECharts 用） ---------- */
const AXIS_LABEL = { color: '#E5E7EB', fontWeight: 700, fontSize: 12 };
const GRID_LINE  = 'rgba(148,163,184,0.18)';

/* ---------- 上传 Excel → 入库 ---------- */
// NOTE: 这里已支持 4 个字段：
//  - 支付商品件数（→ pay_items，兼容“支付件数/付款件数/成交件数”）
//  - 下单商品件数（→ order_items）
//  - 平均停留时长（秒）（→ avg_stay_seconds）
//  - 搜索点击率（% 数值）（→ search_ctr）
$('#fileInput').on('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(evt) {
    try {
      $('#progress').text('解析中…');
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
      if (sheet.length < 2) throw new Error('表格无有效数据');
      const headers = sheet[0].map(h => String(h).trim());

      const findIdx = (re) => headers.findIndex(h => re.test(String(h).trim()));
      const idx = {
        product_id: findIdx(/^(商品)?ID$|^商品id$|^id$|^item id$|^item_id$/i),
        stat_date:  findIdx(/^(统计时间|日期|数据时间|date)$/i),
        exposure:   findIdx(/^(搜索曝光量|曝光量|商品曝光量|impressions)$/i),
        visitors:   (function(){ const rs=[/^(商品)?访客数$/i,/^访客人数$/i,/^访客量$/i,/^uv$/i,/^sessions$/i];
          for (const re of rs){const i = findIdx(re); if(i!==-1) return i;}
          const i2=headers.findIndex(h=>/访客数|访客/i.test(String(h).trim())&&!/(老|新|回|复)访客/i.test(String(h).trim()));
          return i2;
        })(),
        visitors_new: findIdx(/^(新访客数|新访客|新用户|新增访客)$/i),
        visitors_old: findIdx(/^(老访客数|老访客|回访客|复访客)$/i),
        views:      findIdx(/^(商品浏览量|浏览量|pv|page views)$/i),
        add_people: findIdx(/^(商品加购人数|加购人数|加购买家数)$/i),
        add_count:  findIdx(/^(商品加购件数|加购件数)$/i),
        // ✅ 支付商品件数：兼容“支付件数/付款件数/成交件数/支付商品件数”
        pay_items:  (function(){ const rs=[/^支付商品件数$/i,/^支付件数$/i,/^付款件数$/i,/^成交件数$/i]; for (const re of rs){const i=findIdx(re); if(i!==-1) return i;} return -1; })(),
        pay_orders: findIdx(/^(支付订单数|下单人数|订单数)$/i),
        pay_buyers: findIdx(/^(支付买家数|支付人数|成交人数)$/i),
        fav_people: findIdx(/^(收藏人数|收藏买家数|收藏用户数)$/i),
        fav_count:  findIdx(/^(收藏件数|收藏量)$/i),
        // ✅ 新增：下单商品件数 / 平均停留时长 / 搜索点击率
        order_items: findIdx(/^(下单商品件数|下单件数|下单商品数|下单商品数量)$/i),
        avg_stay_seconds: findIdx(/^(平均停留时长(\(秒\))?|平均停留时间|平均访问时长)$/i),
        search_ctr: findIdx(/^(搜索点击率(\(%\))?|点击率(\(%\))?|搜索点击率|点击率)$/i),
      };
      if (idx.product_id<0 || idx.stat_date<0) throw new Error('缺少必填：商品ID / 统计时间');

      function excelDateToISO(n){ if(typeof n!=='number') return null; const utc_days=Math.floor(n-25569); const utc_value=utc_days*86400; const date_info=new Date(utc_value*1000); const y=date_info.getUTCFullYear(); const m=(date_info.getUTCMonth()+1).toString().padStart(2,'0'); const d=date_info.getUTCDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; }
      function parseDateToISO(v){ if(v===null||v===undefined||v==='') return null; if(typeof v==='number') return excelDateToISO(v); let s=String(v).trim(); s=s.replace(/[.]/g,'-').replace(/\//g,'-'); const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`; const m2=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/); if(m2) return `${m2[3]}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`; return s.slice(0,10); }

      const rows = sheet.slice(1).filter(r => r && r.length).map(r => {
        const pid = String(r[idx.product_id]).trim();
        const sd  = parseDateToISO(r[idx.stat_date]);
        const visitors = (idx.visitors !== -1 ? toNum(r[idx.visitors])
                        : ((idx.visitors_new !== -1 ? toNum(r[idx.visitors_new]) : 0)
                        + (idx.visitors_old !== -1 ? toNum(r[idx.visitors_old]) : 0)));
        // 将“12.3%”型点击率转成 12.3
        const pct = (x) => { const n = String(x ?? '').trim(); if (!n) return 0; return toNum(n.replace('%','')); };
        const row = {
          product_id: pid, stat_date: sd,
          exposure:  idx.exposure  === -1 ? 0 : toNum(r[idx.exposure]),
          visitors,
          views:     idx.views     === -1 ? 0 : toNum(r[idx.views]),
          add_people:idx.add_people=== -1 ? 0 : toNum(r[idx.add_people]),
          add_count: idx.add_count === -1 ? 0 : toNum(r[idx.add_count]),
          pay_items: idx.pay_items === -1 ? 0 : toNum(r[idx.pay_items]),
          pay_orders:idx.pay_orders=== -1 ? 0 : toNum(r[idx.pay_orders]),
          pay_buyers:idx.pay_buyers=== -1 ? 0 : toNum(r[idx.pay_buyers]),
          // 新增字段
          order_items: idx.order_items === -1 ? 0 : toNum(r[idx.order_items]),
          avg_stay_seconds: idx.avg_stay_seconds === -1 ? 0 : toNum(r[idx.avg_stay_seconds]),
          search_ctr: idx.search_ctr === -1 ? 0 : pct(r[idx.search_ctr]),
        };
        if (idx.fav_people !== -1) row.fav_people = toNum(r[idx.fav_people]);
        if (idx.fav_count  !== -1) row.fav_count  = toNum(r[idx.fav_count]);
        return row;
      }).filter(x => x.product_id && x.stat_date);
      const dmap=new Map(); rows.forEach(r=>dmap.set(r.product_id+'__'+r.stat_date,r)); const deduped=Array.from(dmap.values());

      $('#progress').text(`入库中（${deduped.length} 条）…`);
      const resp = await fetch('/api/ae_upsert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rows: deduped }) });
      const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Upsert API响应不是JSON：' + txt.slice(0,200)); }
      if (!resp.ok || !j.ok) throw new Error(j.error || '入库失败');
      $('#progress').text('入库完成 ✔'); $('#refreshBtn').click();
    } catch(err) {
      console.error(err); alert('处理失败：' + (err.message || err)); $('#progress').text('');
    }
  };
  reader.readAsArrayBuffer(file);
});

/* ---------- 查询 / 汇总 ---------- */
// 这些函数已被新的页面模板系统替代，保留注释以说明功能
// 新的系统在 self-operated.js 中实现
/* ---------- 初始化 ---------- */
// 这些初始化代码已被新的页面模板系统替代
// 新的系统在 self-operated.js 中实现
</script>

<!-- ====== New Products KPI (Self) ====== -->
<script>
(function(){
  let removeNewFilter = null;
  let lastData = null;

  function getDT(){
    if (!window.jQuery || !jQuery.fn || !jQuery.fn.dataTable) return null;
    try { return window.dataTable || jQuery('#report').DataTable(); } catch(e){ return null; }
  }
  async function fetchRange(fromISO, toISO){
    const qs = new URLSearchParams({ platform:'self' });
    if (fromISO) qs.set('from', fromISO);
    if (toISO) qs.set('to', toISO);
    const r = await fetch('/api/new-products?'+qs.toString());
    const j = await r.json();
    if (!j.ok) throw new Error(j.msg||'fetch error');
    return j;
  }
  function parseDateRange(){
    const input = document.getElementById('dateFilter');
    if (input && input.value && input.value.includes(' to ')){
      const [s, e] = input.value.split(' to ');
      return { from:s, to:e };
    }
    const today = new Date();
    const to = today.toISOString().slice(0,10);
    // 如果今天是2024年或更早，使用2025-07-01作为开始日期
const from = today.getFullYear() < 2025 ? '2025-07-01' : new Date(today.getTime()-30*86400000).toISOString().slice(0,10);
    return { from, to };
  }
  function ensureCard(){
    let wrap = document.querySelector('.kpi') || document.getElementById('kpi');
    if (!wrap){
      const table = document.querySelector('#report');
      const host = document.createElement('div');
      host.className = 'kpi-row';
      if (table && table.parentNode) table.parentNode.insertBefore(host, table);
      else document.body.insertBefore(host, document.body.firstChild);
      wrap = host;
    }
    let card = document.getElementById('kpi-new-self-card');
    if (!card){
      const div = document.createElement('div');
      div.className = 'card clickable stat-card';
      div.id = 'kpi-new-self-card';
      div.innerHTML = '<h4>本周期新品数</h4><p id="kpi-new-self-count">--</p><a id="kpi-new-self-clear" class="mini-link">清除筛选</a>';
      wrap.appendChild(div);
      card = div;
    }
    const old = document.getElementById('kpi-new-self-ctrl');
    if (old && old.parentNode) old.parentNode.removeChild(old);
    return {
      card,
      countEl: document.getElementById('kpi-new-self-count'),
      clearEl: document.getElementById('kpi-new-self-clear'),
    };
  }
  function applyFilterByIds(ids){
    const dt = getDT();
    if (removeNewFilter){ removeNewFilter(); removeNewFilter = null; }

    if (dt && jQuery.fn.dataTable.ext){
      const ext = jQuery.fn.dataTable.ext;
      const filterFn = (settings, data, dataIndex) => {
        let pid = (data[0]||'').toString().trim();
        if (!pid || /<a/i.test(pid)) {
          const rowNode = dt.row(dataIndex).node();
          const cell = rowNode && rowNode.querySelector('td:first-child');
          if (cell) pid = (cell.textContent||'').trim();
        }
        const m = pid.match(/(\d{6,})/g);
        if (m && m.length) pid = m[m.length-1];
        return ids.has(pid);
      };
      ext.search.push(filterFn);
      dt.draw();
      removeNewFilter = () => {
        const pos = ext.search.findIndex(f => f === filterFn);
        if (pos > -1) ext.search.splice(pos, 1);
        dt.draw();
      };
    } else {
      const table = document.querySelector('#report');
      if (!table || !table.tBodies[0]) return;
      const rows = Array.from(table.tBodies[0].rows);
      const original = new Map();
      rows.forEach(tr => {
        const td = tr.cells[0];
        let pid = td ? td.textContent.trim() : '';
        const m = pid.match(/(\d{6,})/g);
        if (m && m.length) pid = m[m.length-1];
        if (!original.has(tr)) original.set(tr, tr.style.display);
        tr.style.display = ids.has(pid) ? '' : 'none';
      });
      removeNewFilter = () => { for (const [tr, disp] of original) tr.style.display = disp; };
    }
  }
  async function refreshFromPageRange(){
    const ui = ensureCard();
    const { from, to } = parseDateRange();
    try{
      lastData = await fetchRange(from, to);
      ui.countEl.textContent = lastData.new_count || 0;
      ui.card.onclick = () => {
        if (!lastData.items || !lastData.items.length) return;
        const ids = new Set(lastData.items.map(x => String(x.product_id)));
        applyFilterByIds(ids);
        ui.clearEl.style.display = 'inline';
      };
      ui.clearEl.onclick = (e) => {
        e.stopPropagation();
        if (removeNewFilter) removeNewFilter();
        ui.clearEl.style.display = 'none';
      };
    }catch(e){
      console.warn('[Self KPI] fetch failed:', e);
    }
  }

  // 移除旧的MutationObserver和事件监听器，避免重复触发数据加载
  // 现在由新的页面模板系统统一管理数据加载
  console.log('自运营页面：旧的MutationObserver已移除，避免重复数据加载');
})();
</script>
<script src="assets/login.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  // 使用 site-nav.js 的站点管理逻辑
  const currentSiteEl = document.getElementById('currentSite');
  // 初始化站点显示
  function updateCurrentSiteDisplay() {
    if (currentSiteEl) {
      // 从 localStorage 获取当前站点信息
      const currentSiteId = localStorage.getItem('currentSite') || 'ae_self_operated_a';
      const currentSiteName = localStorage.getItem('currentSiteName') || '自运营robot站';
      
      // 更新显示
      currentSiteEl.textContent = currentSiteName;
      
      // 确保 localStorage 中有正确的值
      if (!localStorage.getItem('currentSite')) {
        localStorage.setItem('currentSite', currentSiteId);
      }
      if (!localStorage.getItem('currentSiteName')) {
        localStorage.setItem('currentSiteName', currentSiteName);
      }
      
      console.log('自运营页面站点显示更新:', { currentSiteId, currentSiteName });
    }
  }


      // 初始化站点显示
    updateCurrentSiteDisplay();
    
    // 初始化主页面时间控件
    initializeMainDateFilter();
    
    // 监听 localStorage 变化
    window.addEventListener('storage', (e) => {
      if (e.key === 'currentSite' || e.key === 'currentSiteName') {
        updateCurrentSiteDisplay();
      }
    });
  
  // 平台切换处理 - 通用机制
  function handlePlatformSwitch(platform) {
    console.log('平台切换:', platform);
    
    // 根据平台设置相应的站点和参数
    switch(platform) {
      case 'ae_self_operated':
        // 保持当前自运营站点
        break;
      case 'independent':
        // 切换到独立站
        window.location.href = 'independent-site.html';
        return;
      case 'managed':
        // 切换到全托管
        window.location.href = 'managed.html';
        return;
      case 'amazon':
        // 切换到亚马逊
        window.location.href = 'amazon-overview.html';
        return;
      case 'tiktok':
        // 切换到TikTok Shop
        window.location.href = 'tiktok.html';
        return;
      case 'temu':
        // 切换到Temu
        window.location.href = 'temu.html';
        return;
      case 'ozon':
        // 切换到Ozon
        window.location.href = 'ozon-detail.html';
        return;
      default:
        // 其他平台暂时跳转到相应页面或显示提示
        console.log('平台', platform, '暂未实现');
        return;
    }
    
    // 如果是自运营平台，重新加载数据
    if (platform === 'ae_self_operated') {
      // 重新加载数据
      if (typeof fetchAndRenderAll === 'function') {
        fetchAndRenderAll();
      }
    }
  }
  
  // 将平台切换函数暴露到全局，供 site-nav.js 调用
  window.handlePlatformSwitch = handlePlatformSwitch;
  
  // 运营分析数据加载
  async function loadAnalysisData() {
    try {
      const dateRange = getDateRange();
      const currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
      
      console.log('开始加载运营分析数据:', { dateRange, currentSite });
      
      // 构建查询参数 - 使用GET请求而不是POST
      const queryParams = new URLSearchParams({
        start: dateRange.start,
        end: dateRange.end,
        granularity: 'day',
        site: currentSite,
        aggregate: 'time'  // 使用'time'而不是true
      });
      
      // 获取当前周期数据 - 使用GET请求
      const currentResponse = await fetch(`/api/ae_query?${queryParams.toString()}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!currentResponse.ok) {
        throw new Error(`API响应错误: ${currentResponse.status} ${currentResponse.statusText}`);
      }
      
      const currentData = await currentResponse.json();
      console.log('运营分析数据响应:', currentData);
      
      if (currentData.ok && currentData.rows) {  // 注意：API返回的是rows而不是data
        // 更新KPI卡片
        updateAnalysisKPI(currentData.rows);
        // 渲染图表
        renderAnalysisCharts(currentData.rows);
      } else {
        console.warn('运营分析数据格式不正确:', currentData);
        showAnalysisError('数据格式不正确，请检查API响应');
      }
    } catch (error) {
      console.error('加载运营分析数据失败:', error);
      showAnalysisError(`加载运营分析数据失败: ${error.message}`);
    }
  }
  
  // 显示运营分析错误信息
  function showAnalysisError(message) {
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = 'color: #ef4444; text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px; margin: 20px 0; border: 1px solid #fecaca;';
    errorMsg.textContent = message;
    
    const analysisSection = document.getElementById('analysis');
    if (analysisSection) {
      const existingError = analysisSection.querySelector('.error-message');
      if (existingError) existingError.remove();
      errorMsg.className = 'error-message';
      analysisSection.insertBefore(errorMsg, analysisSection.firstChild);
    }
  }
  
  // 显示产品分析错误信息
  function showProductAnalysisError(message) {
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = 'color: #ef4444; text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px; margin: 20px 0; border: 1px solid #fecaca;';
    errorMsg.textContent = message;
    
    const productsSection = document.getElementById('products');
    if (productsSection) {
      const existingError = productsSection.querySelector('.error-message');
      if (existingError) existingError.remove();
      errorMsg.className = 'error-message';
      productsSection.insertBefore(errorMsg, productsSection.firstChild);
    }
  }
  
  // 显示产品数据错误信息
  function showProductDataError(message) {
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = 'color: #ef4444; text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px; margin: 20px 0; border: 1px solid #fecaca;';
    errorMsg.textContent = message;
    
    const productsSection = document.getElementById('products');
    if (productsSection) {
      const existingError = productsSection.querySelector('.error-message');
      if (existingError) existingError.remove();
      errorMsg.className = 'error-message';
      productsSection.insertBefore(errorMsg, productsSection.firstChild);
    }
  }
  
           // 产品分析数据加载 - 加载产品列表并按曝光量排序
    async function loadProductAnalysisData() {
      try {
        const dateRange = getProductDateRange();
        const currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
        
        console.log('开始加载产品分析数据:', { dateRange, currentSite });
        
        // 初始化产品页面的时间控件
        initializeProductDateFilter();
        
        // 构建查询参数 - 使用GET请求而不是POST
        const queryParams = new URLSearchParams({
          start: dateRange.start,
          end: dateRange.end,
          granularity: 'day',
          site: currentSite,
          aggregate: 'product'  // 使用'product'获取产品级别的数据
        });
        
        // 获取产品列表 - 使用GET请求
        const productsResponse = await fetch(`/api/ae_query?${queryParams.toString()}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!productsResponse.ok) {
          throw new Error(`API响应错误: ${productsResponse.status} ${productsResponse.statusText}`);
        }
        
        const productsData = await productsResponse.json();
        console.log('产品列表数据响应:', productsData);
        
        if (productsData.ok && productsData.rows) {
          // 按曝光量排序产品
          const sortedProducts = productsData.rows.sort((a, b) => (b.exposure || 0) - (a.exposure || 0));
          
          // 更新产品总数
          document.getElementById('productTotalCount').textContent = sortedProducts.length;
          
          // 填充产品选择器
          populateProductSelect(sortedProducts);
          
          // 默认选择曝光量最大的产品
          if (sortedProducts.length > 0) {
            const topProduct = sortedProducts[0];
            console.log('默认选择曝光量最大的产品:', topProduct.product_id);
            document.getElementById('productSelect').value = topProduct.product_id;
            await loadProductData(topProduct.product_id);
          }
        } else {
          console.warn('产品列表数据格式不正确:', productsData);
          showProductAnalysisError('数据格式不正确，请检查API响应');
        }
      } catch (error) {
        console.error('加载产品分析数据失败:', error);
        showProductAnalysisError(`加载产品分析数据失败: ${error.message}`);
      }
    }
    
    // 初始化产品页面的时间控件
    function initializeProductDateFilter() {
      const productDateFilter = document.getElementById('productDateFilter');
      if (!productDateFilter) return;
      
      // 设置默认日期范围（最近7天）
      const today = new Date();
      const end = today.toISOString().slice(0, 10);
      const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
      
      // 使用flatpickr初始化日期选择器
      if (window.flatpickr) {
        const picker = flatpickr(productDateFilter, {
          mode: 'range',
          dateFormat: 'Y-m-d',
          defaultDate: [start, end],
          onChange: function(selectedDates, dateStr) {
            if (selectedDates.length === 2) {
              console.log('产品分析时间范围变更:', dateStr);
              // 同步主页面时间控件
              const mainDateFilter = document.getElementById('dateFilter');
              if (mainDateFilter) {
                mainDateFilter.value = dateStr;
                // 触发主页面时间变更事件
                const event = new Event('change', { bubbles: true });
                mainDateFilter.dispatchEvent(event);
              }
              // 重新加载产品数据
              const currentProductId = document.getElementById('productSelect').value;
              if (currentProductId) {
                loadProductData(currentProductId);
              }
            }
          }
        });
        
        // 设置初始值
        productDateFilter.value = `${start} to ${end}`;
      }
    }
  
  // 初始化主页面时间控件
  function initializeMainDateFilter() {
    const mainDateFilter = document.getElementById('dateFilter');
    if (!mainDateFilter) return;
    
    // 设置默认日期范围（最近7天）
    const today = new Date();
    const end = today.toISOString().slice(0, 10);
    const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
    
    // 使用flatpickr初始化日期选择器
    if (window.flatpickr) {
      const picker = flatpickr(mainDateFilter, {
        mode: 'range',
        dateFormat: 'Y-m-d',
        defaultDate: [start, end],
        onChange: function(selectedDates, dateStr) {
          if (selectedDates.length === 2) {
            console.log('主页面时间范围变更:', dateStr);
            // 同步产品分析页面时间控件
            const productDateFilter = document.getElementById('productDateFilter');
            if (productDateFilter) {
              productDateFilter.value = dateStr;
            }
            // 重新加载数据
            if (typeof fetchAndRenderAll === 'function') {
              fetchAndRenderAll();
            }
          }
        }
      });
      
      // 设置初始值
      mainDateFilter.value = `${start} to ${end}`;
    }
  }
  
  // 获取日期范围
  function getDateRange() {
    const input = document.getElementById('dateFilter');
    if (input && input.value && input.value.includes(' to ')) {
      const [start, end] = input.value.split(' to ');
      return { start, end };
    }
    const today = new Date();
    const end = today.toISOString().slice(0, 10);
    const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
    return { start, end };
  }
  
  // 更新运营分析KPI
  function updateAnalysisKPI(data) {
    console.log('更新运营分析KPI，数据:', data);
    
    // 计算新的KPI指标
    const totalExposure = data.reduce((sum, item) => sum + (item.exposure || 0), 0);
    const totalVisitors = data.reduce((sum, item) => sum + (item.visitors || 0), 0);
    const totalAddCount = data.reduce((sum, item) => sum + (item.add_count || 0), 0);
    const totalPayItems = data.reduce((sum, item) => sum + (item.pay_items || 0), 0);
    
    // 计算商品数量（去重）
    const exposedProducts = new Set(data.filter(item => item.exposure > 0).map(item => item.product_id)).size;
    const cartedProducts = new Set(data.filter(item => item.add_count > 0).map(item => item.product_id)).size;
    const paidProducts = new Set(data.filter(item => item.pay_items > 0).map(item => item.product_id)).size;
    
    console.log('KPI计算结果:', {
      totalExposure,
      totalVisitors, 
      totalAddCount,
      totalPayItems,
      exposedProducts,
      cartedProducts,
      paidProducts
    });
    
    // 更新KPI显示
    document.getElementById('totalExposure').textContent = totalExposure.toLocaleString();
    document.getElementById('totalVisitors').textContent = totalVisitors.toLocaleString();
    document.getElementById('totalAddCount').textContent = totalAddCount.toLocaleString();
    document.getElementById('totalPayItems').textContent = totalPayItems.toLocaleString();
    document.getElementById('exposedProducts').textContent = exposedProducts.toLocaleString();
    document.getElementById('cartedProducts').textContent = cartedProducts.toLocaleString();
    document.getElementById('paidProducts').textContent = paidProducts.toLocaleString();
  }
  
  // 渲染运营分析对比图表
  async function renderAnalysisCharts(data) {
    console.log('渲染运营分析对比图表，数据:', data);
    
    // 获取上一周期数据进行对比
    const previousData = await getPreviousPeriodData();
    
    // 计算当前周期数据
    const currentData = {
      exposure: data.reduce((sum, item) => sum + (item.exposure || 0), 0),
      visitors: data.reduce((sum, item) => sum + (item.visitors || 0), 0),
      addCount: data.reduce((sum, item) => sum + (item.add_count || 0), 0),
      payItems: data.reduce((sum, item) => sum + (item.pay_items || 0), 0),
      exposedProducts: new Set(data.filter(item => item.exposure > 0).map(item => item.product_id)).size,
      cartedProducts: new Set(data.filter(item => item.add_count > 0).map(item => item.product_id)).size,
      paidProducts: new Set(data.filter(item => item.pay_items > 0).map(item => item.product_id)).size
    };
    
    // 计算上一周期数据
    const previousDataCalculated = previousData ? {
      exposure: previousData.reduce((sum, item) => sum + (item.exposure || 0), 0),
      visitors: previousData.reduce((sum, item) => sum + (item.visitors || 0), 0),
      addCount: previousData.reduce((sum, item) => sum + (item.add_count || 0), 0),
      payItems: previousData.reduce((sum, item) => sum + (item.pay_items || 0), 0),
      exposedProducts: new Set(previousData.filter(item => item.exposure > 0).map(item => item.product_id)).size,
      cartedProducts: new Set(previousData.filter(item => item.add_count > 0).map(item => item.product_id)).size,
      paidProducts: new Set(previousData.filter(item => item.pay_items > 0).map(item => item.product_id)).size
    } : null;
    
    // 渲染总展示数对比图
    renderComparisonChart('exposureComparisonChart', '总展示数对比', 
      currentData.exposure, previousDataCalculated?.exposure || 0, '总展示数');
    
    // 渲染详情页访客数对比图
    renderComparisonChart('visitorsComparisonChart', '详情页访客数对比', 
      currentData.visitors, previousDataCalculated?.visitors || 0, '详情页访客数');
    
    // 渲染加购次数对比图
    renderComparisonChart('addCountComparisonChart', '加购次数对比', 
      currentData.addCount, previousDataCalculated?.addCount || 0, '加购次数');
    
    // 渲染订购商品数对比图
    renderComparisonChart('payItemsComparisonChart', '订购商品数对比', 
      currentData.payItems, previousDataCalculated?.payItems || 0, '订购商品数');
    
    // 渲染有曝光商品数对比图
    renderComparisonChart('exposedProductsComparisonChart', '有曝光商品数对比', 
      currentData.exposedProducts, previousDataCalculated?.exposedProducts || 0, '有曝光商品数');
    
    // 渲染有加购商品数对比图
    renderComparisonChart('cartedProductsComparisonChart', '有加购商品数对比', 
      currentData.cartedProducts, previousDataCalculated?.cartedProducts || 0, '有加购商品数');
    
    // 渲染有支付商品数对比图
    renderComparisonChart('paidProductsComparisonChart', '有支付商品数对比', 
      currentData.paidProducts, previousDataCalculated?.paidProducts || 0, '有支付商品数');
  }
  
  // 渲染对比柱状图
  function renderComparisonChart(chartId, title, currentValue, previousValue, label) {
    const chart = echarts.init(document.getElementById(chartId));
    const option = {
      title: { 
        text: title, 
        textStyle: { color: '#374151', fontSize: 16 },
        subtext: `${label}: ${currentValue.toLocaleString()}`,
        subtextStyle: { color: '#6b7280', fontSize: 14 }
      },
      tooltip: { 
        trigger: 'axis',
        formatter: function(params) {
          const data = params[0];
          return `${data.name}<br/>${data.seriesName}: ${data.value.toLocaleString()}`;
        }
      },
      legend: {
        data: ['当前周期', '上一周期'],
        textStyle: { color: '#374151' }
      },
      xAxis: { 
        type: 'category', 
        data: ['当前周期', '上一周期'],
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      series: [
        {
          name: '当前周期',
          data: [currentValue, 0],
          type: 'bar',
          itemStyle: { color: '#3B82F6' },
          barWidth: '40%'
        },
        {
          name: '上一周期',
          data: [0, previousValue],
          type: 'bar',
          itemStyle: { color: '#10B981' },
          barWidth: '40%'
        }
      ]
    };
    chart.setOption(option);
  }
  
     // 填充产品选择器
   function populateProductSelect(data) {
     const productSelect = document.getElementById('productSelect');
     if (!productSelect) return;
     
     console.log('填充产品选择器，数据:', data);
     
     // 清空现有选项
     productSelect.innerHTML = '<option value="">选择产品</option>';
     
     // 按曝光量排序显示产品（data已经是排序后的）
     data.forEach(item => {
       const option = document.createElement('option');
       option.value = item.product_id;
       const exposure = item.exposure || 0;
       option.textContent = `${item.product_id} (曝光: ${exposure.toLocaleString()})`;
       productSelect.appendChild(option);
     });
     
     // 添加产品选择事件
     productSelect.addEventListener('change', function() {
       const selectedProductId = this.value;
       if (selectedProductId) {
         console.log('选择产品:', selectedProductId);
         loadProductData(selectedProductId);
       }
     });
   }
  
           // 加载特定产品数据
    async function loadProductData(productId) {
      try {
        const dateRange = getProductDateRange();
        const currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
        
        console.log('开始加载产品数据:', { productId, dateRange, currentSite });
        
        // 更新产品基本信息
        document.getElementById('currentProductId').textContent = productId;
        document.getElementById('productLink').href = `https://aliexpress.com/item/${productId}.html`;
        
        // 构建查询参数 - 使用GET请求而不是POST
        const queryParams = new URLSearchParams({
          start: dateRange.start,
          end: dateRange.end,
          granularity: 'day',
          site: currentSite,
          aggregate: 'time'  // 使用'time'获取时间序列数据
        });
        
        const response = await fetch(`/api/ae_query?${queryParams.toString()}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`API响应错误: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('产品数据响应:', data);
        
        if (data.ok && data.rows) {  // 注意：API返回的是rows而不是data
          // 过滤出指定产品的数据
          const productData = data.rows.filter(item => item.product_id === productId);
          if (productData.length > 0) {
            updateProductKPI(productData);
            renderProductCharts(productData);
            document.getElementById('productCharts').style.display = 'grid';
          } else {
            showProductDataError('未找到该产品的数据');
          }
        } else {
          console.warn('产品数据格式不正确:', data);
          showProductDataError('数据格式不正确，请检查API响应');
        }
      } catch (error) {
        console.error('加载产品数据失败:', error);
        showProductDataError(`加载产品数据失败: ${error.message}`);
      }
    }
  
           // 更新产品KPI - 计算单个产品的KPI指标，包含与上一周期的对比
    async function updateProductKPI(data) {
      if (!data || data.length === 0) return;
      
      console.log('更新产品KPI，数据:', data);
      
      // 计算当前周期的KPI指标
      const currentTotalExposure = data.reduce((sum, item) => sum + (item.exposure || 0), 0);
      const currentTotalVisitors = data.reduce((sum, item) => sum + (item.visitors || 0), 0);
      const currentTotalViews = data.reduce((sum, item) => sum + (item.views || 0), 0);
      const currentTotalAddPeople = data.reduce((sum, item) => sum + (item.add_people || 0), 0);
      const currentTotalAddCount = data.reduce((sum, item) => sum + (item.add_count || 0), 0);
      const currentTotalPayBuyers = data.reduce((sum, item) => sum + (item.pay_buyers || 0), 0);
      const currentTotalPayItems = data.reduce((sum, item) => sum + (item.pay_items || 0), 0);
      
      // 计算当前周期比率
      const currentAvgVisitorRate = currentTotalExposure > 0 ? (currentTotalVisitors / currentTotalExposure * 100).toFixed(2) : 0;
      const currentAvgCartRate = currentTotalVisitors > 0 ? (currentTotalAddCount / currentTotalVisitors * 100).toFixed(2) : 0;
      const currentAvgPayRate = currentTotalAddCount > 0 ? (currentTotalPayItems / currentTotalAddCount * 100).toFixed(2) : 0;
      
      // 获取上一周期数据进行对比
      const previousData = await getPreviousPeriodData();
      let comparisonData = {};
      
      if (previousData && previousData.length > 0) {
        const previousTotalExposure = previousData.reduce((sum, item) => sum + (item.exposure || 0), 0);
        const previousTotalVisitors = previousData.reduce((sum, item) => sum + (item.visitors || 0), 0);
        const previousTotalAddCount = previousData.reduce((sum, item) => sum + (item.add_count || 0), 0);
        const previousTotalPayItems = previousData.reduce((sum, item) => sum + (item.pay_items || 0), 0);
        const previousTotalAddPeople = previousData.reduce((sum, item) => sum + (item.add_people || 0), 0);
        const previousTotalPayBuyers = previousData.reduce((sum, item) => sum + (item.pay_buyers || 0), 0);
        
        const previousAvgVisitorRate = previousTotalExposure > 0 ? (previousTotalVisitors / previousTotalExposure * 100).toFixed(2) : 0;
        const previousAvgCartRate = previousTotalVisitors > 0 ? (previousTotalAddCount / previousTotalVisitors * 100).toFixed(2) : 0;
        const previousAvgPayRate = previousTotalAddCount > 0 ? (previousTotalPayItems / previousTotalAddCount * 100).toFixed(2) : 0;
        
        comparisonData = {
          avgVisitorRate: {
            current: parseFloat(currentAvgVisitorRate),
            previous: parseFloat(previousAvgVisitorRate),
            change: parseFloat(currentAvgVisitorRate) - parseFloat(previousAvgVisitorRate)
          },
          avgCartRate: {
            current: parseFloat(currentAvgCartRate),
            previous: parseFloat(previousAvgCartRate),
            change: parseFloat(currentAvgCartRate) - parseFloat(previousAvgCartRate)
          },
          avgPayRate: {
            current: parseFloat(currentAvgPayRate),
            previous: parseFloat(previousAvgPayRate),
            change: parseFloat(currentAvgPayRate) - parseFloat(previousAvgPayRate)
          },
          totalExposure: {
            current: currentTotalExposure,
            previous: previousTotalExposure,
            change: currentTotalExposure - previousTotalExposure
          },
          totalVisitors: {
            current: currentTotalVisitors,
            previous: previousTotalVisitors,
            change: currentTotalVisitors - previousTotalVisitors
          },
          totalAddPeople: {
            current: currentTotalAddPeople,
            previous: previousTotalAddPeople,
            change: currentTotalAddPeople - previousTotalAddPeople
          },
          totalPayBuyers: {
            current: currentTotalPayBuyers,
            previous: previousTotalPayBuyers,
            change: currentTotalPayBuyers - previousTotalPayBuyers
          }
        };
      }
      
      console.log('产品KPI计算结果:', {
        currentAvgVisitorRate,
        currentAvgCartRate,
        currentAvgPayRate,
        currentTotalExposure,
        currentTotalVisitors,
        currentTotalAddPeople,
        currentTotalPayBuyers,
        comparisonData
      });
      
      // 更新KPI显示
      document.getElementById('productAvgVisitor').textContent = currentAvgVisitorRate + '%';
      document.getElementById('productAvgCart').textContent = currentAvgCartRate + '%';
      document.getElementById('productAvgPay').textContent = currentAvgPayRate + '%';
      document.getElementById('productTotalExposure').textContent = currentTotalExposure.toLocaleString();
      document.getElementById('productTotalVisitors').textContent = currentTotalVisitors.toLocaleString();
      document.getElementById('productTotalAddPeople').textContent = currentTotalAddPeople.toLocaleString();
      document.getElementById('productTotalPayBuyers').textContent = currentTotalPayBuyers.toLocaleString();
      
      // 更新对比数据显示
      updateProductComparisonDisplay(comparisonData);
    }
    
    // 更新产品对比数据显示
    function updateProductComparisonDisplay(comparisonData) {
      if (!comparisonData || Object.keys(comparisonData).length === 0) {
        // 如果没有对比数据，显示占位符
        document.getElementById('productAvgVisitorComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productAvgCartComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productAvgPayComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productTotalExposureComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productTotalVisitorsComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productTotalAddPeopleComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productTotalPayBuyersComparison').innerHTML = '<span class="text-gray-500">--</span>';
        return;
      }
      
      // 更新平均访客比对比
      const visitorChange = comparisonData.avgVisitorRate.change;
      const visitorSymbol = visitorChange > 0 ? '↑' : visitorChange < 0 ? '↓' : '';
      const visitorColor = visitorChange > 0 ? 'text-green-600' : visitorChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productAvgVisitorComparison').innerHTML = 
        `<span class="${visitorColor}">${visitorSymbol} ${Math.abs(visitorChange).toFixed(2)}%</span>`;
      
      // 更新平均加购比对比
      const cartChange = comparisonData.avgCartRate.change;
      const cartSymbol = cartChange > 0 ? '↑' : cartChange < 0 ? '↓' : '';
      const cartColor = cartChange > 0 ? 'text-green-600' : cartChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productAvgCartComparison').innerHTML = 
        `<span class="${cartColor}">${cartSymbol} ${Math.abs(cartChange).toFixed(2)}%</span>`;
      
      // 更新平均支付比对比
      const payChange = comparisonData.avgPayRate.change;
      const paySymbol = payChange > 0 ? '↑' : payChange < 0 ? '↓' : '';
      const payColor = payChange > 0 ? 'text-green-600' : payChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productAvgPayComparison').innerHTML = 
        `<span class="${payColor}">${cartSymbol} ${Math.abs(payChange).toFixed(2)}%</span>`;
      
      // 更新总曝光量对比
      const exposureChange = comparisonData.totalExposure.change;
      const exposureSymbol = exposureChange > 0 ? '↑' : exposureChange < 0 ? '↓' : '';
      const exposureColor = exposureChange > 0 ? 'text-green-600' : exposureChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productTotalExposureComparison').innerHTML = 
        `<span class="${exposureColor}">${exposureSymbol} ${Math.abs(exposureChange).toLocaleString()}</span>`;
      
      // 更新总访客数对比
      const visitorsChange = comparisonData.totalVisitors.change;
      const visitorsSymbol = visitorsChange > 0 ? '↑' : visitorsChange < 0 ? '↓' : '';
      const visitorsColor = visitorsChange > 0 ? 'text-green-600' : visitorsChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productTotalVisitorsComparison').innerHTML = 
        `<span class="${visitorsColor}">${visitorsSymbol} ${Math.abs(visitorsChange).toLocaleString()}</span>`;
      
      // 更新总加购人数对比
      const addPeopleChange = comparisonData.totalAddPeople.change;
      const addPeopleSymbol = addPeopleChange > 0 ? '↑' : addPeopleChange < 0 ? '↓' : '';
      const addPeopleColor = addPeopleChange > 0 ? 'text-green-600' : addPeopleChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productTotalAddPeopleComparison').innerHTML = 
        `<span class="${addPeopleColor}">${addPeopleSymbol} ${Math.abs(addPeopleChange).toLocaleString()}</span>`;
      
      // 更新总支付买家数对比
      const payBuyersChange = comparisonData.totalPayBuyers.change;
      const payBuyersSymbol = payBuyersChange > 0 ? '↑' : payBuyersChange < 0 ? '↓' : '';
      const payBuyersColor = payBuyersChange > 0 ? 'text-green-600' : payBuyersChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productTotalPayBuyersComparison').innerHTML = 
        `<span class="${payBuyersColor}">${payBuyersSymbol} ${Math.abs(payBuyersChange).toLocaleString()}</span>`;
    }
    
    // 获取上一周期数据
    async function getPreviousPeriodData() {
      try {
        const dateRange = getProductDateRange();
        const currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
        
        // 计算上一周期的日期范围
        const currentStart = new Date(dateRange.start);
        const currentEnd = new Date(dateRange.end);
        const periodDays = Math.ceil((currentEnd - currentStart) / (1000 * 60 * 60 * 24));
        
        const previousEnd = new Date(currentStart);
        previousEnd.setDate(previousEnd.getDate() - 1);
        const previousStart = new Date(previousEnd);
        previousStart.setDate(previousStart.getDate() - periodDays + 1);
        
        const queryParams = new URLSearchParams({
          start: previousStart.toISOString().slice(0, 10),
          end: previousEnd.toISOString().slice(0, 10),
          granularity: 'day',
          site: currentSite,
          aggregate: 'time'
        });
        
        const response = await fetch(`/api/ae_query?${queryParams.toString()}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.ok && data.rows) {
            return data.rows;
          }
        }
      } catch (error) {
        console.error('获取上一周期数据失败:', error);
      }
      
      return null;
    }
    
    // 获取产品分析页面的日期范围
    function getProductDateRange() {
      const input = document.getElementById('productDateFilter');
      if (input && input.value && input.value.includes(' to ')) {
        const [start, end] = input.value.split(' to ');
        return { start, end };
      }
      
      // 默认显示最近7天
      const today = new Date();
      const end = today.toISOString().slice(0, 10);
      const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
      return { start, end };
    }
  
  // 渲染产品图表
  function renderProductCharts(data) {
    console.log('渲染产品图表，数据:', data);
    
    // 获取日期标签 - 优先使用bucket，如果没有则使用stat_date
    const getDateLabel = (item) => {
      if (item.bucket && item.bucket !== 'undefined') return item.bucket;
      if (item.stat_date && item.stat_date !== 'undefined') return item.stat_date;
      if (item.bucket_label && item.bucket_label !== 'undefined') return item.bucket_label;
      return '未知日期';
    };
    
    const dateLabels = data.map(getDateLabel);
    console.log('产品图表日期标签:', dateLabels);
    
    // 产品曝光趋势图
    const productExposureChart = echarts.init(document.getElementById('productExposureChart'));
    const productExposureOption = {
      title: { text: '曝光趋势', textStyle: { color: '#374151' } },
      tooltip: { trigger: 'axis' },
      xAxis: { 
        type: 'category', 
        data: dateLabels,
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      series: [{
        data: data.map(item => item.exposure || 0),
        type: 'line',
        smooth: true,
        itemStyle: { color: '#3B82F6' }
      }]
    };
    productExposureChart.setOption(productExposureOption);
    
    // 访客比趋势图
    const productVisitorRateChart = echarts.init(document.getElementById('productVisitorRateChart'));
    const productVisitorRateOption = {
      title: { text: '访客比趋势', textStyle: { color: '#374151' } },
      tooltip: { trigger: 'axis' },
      xAxis: { 
        type: 'category', 
        data: dateLabels,
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12, formatter: '{value}%' }
      },
      series: [{
        data: data.map(item => {
          const exposure = item.exposure || 0;
          const visitors = item.visitors || 0;
          return exposure > 0 ? ((visitors / exposure) * 100).toFixed(2) : 0;
        }),
        type: 'line',
        smooth: true,
        itemStyle: { color: '#10B981' }
      }]
    };
    productVisitorRateChart.setOption(productVisitorRateOption);
    
    // 加购比趋势图
    const productAddRateChart = echarts.init(document.getElementById('productAddRateChart'));
    const productAddRateOption = {
      title: { text: '加购比趋势', textStyle: { color: '#374151' } },
      tooltip: { trigger: 'axis' },
      xAxis: { 
        type: 'category', 
        data: dateLabels,
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12, formatter: '{value}%' }
      },
      series: [{
        data: data.map(item => {
          const visitors = item.visitors || 0;
          const addCount = item.add_count || 0;
          return visitors > 0 ? ((addCount / visitors) * 100).toFixed(2) : 0;
        }),
        type: 'line',
        smooth: true,
        itemStyle: { color: '#F59E0B' }
      }]
    };
    productAddRateChart.setOption(productAddRateOption);
    
    // 支付比趋势图
    const productPayRateChart = echarts.init(document.getElementById('productPayRateChart'));
    const productPayRateOption = {
      title: { text: '支付比趋势', textStyle: { color: '#374151' } },
      tooltip: { trigger: 'axis' },
      xAxis: { 
        type: 'category', 
        data: dateLabels,
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12, formatter: '{value}%' }
      },
      series: [{
        data: data.map(item => {
          const addCount = item.add_count || 0;
          const payItems = item.pay_items || 0;
          return addCount > 0 ? ((payItems / addCount) * 100).toFixed(2) : 0;
        }),
        type: 'line',
        smooth: true,
        itemStyle: { color: '#EF4444' }
      }]
    };
    productPayRateChart.setOption(productPayRateOption);
  }
  
  const userArea=document.getElementById('userArea');
  function refreshUser(){
    const u=JSON.parse(localStorage.getItem('user')||'null');
    if(u){
      userArea.innerHTML=`<div class="user-section"><div class="user-menu-trigger">${u.name}</div><div class="user-dropdown" style="display:none"><button class="user-dropdown-item" id="logoutBtn">退出</button></div></div>`;
      const trigger=userArea.querySelector('.user-menu-trigger');
      const dropdown=userArea.querySelector('.user-dropdown');
      trigger.addEventListener('click',()=>{dropdown.style.display=dropdown.style.display==='block'?'none':'block';});
      document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.removeItem('user');dropdown.style.display='none';refreshUser();showLoginOverlay();});
    }else{
      userArea.innerHTML='<div class="user-section"><span class="user-demo">未登录</span><button class="login-button" id="loginTrigger">登录</button></div>';
      document.getElementById('loginTrigger').addEventListener('click',showLoginOverlay);
      showLoginOverlay();
    }
  }
  refreshUser();
  window.addEventListener('user-login', refreshUser);
     // Hash路由处理
   function handleHashRoute() {
     const hash = window.location.hash.slice(1) || 'detail';
     const targetLink = document.querySelector(`[data-target="${hash}"]`);
     
     if (targetLink) {
       // 更新导航状态
       document.querySelectorAll('.sub-nav a').forEach(x => x.classList.remove('active'));
       targetLink.classList.add('active');
       
       // 显示对应内容
       ['detail', 'analysis', 'products'].forEach(id => {
         const el = document.getElementById(id);
         if (el) el.style.display = (id === hash ? '' : 'none');
       });
       
       // 控制主KPI卡片的显示/隐藏
       const uploadSection = document.querySelector('.upload-section');
       if (uploadSection) {
         console.log('找到upload-section，当前hash:', hash);
         if (hash === 'products') {
           // 产品分析页面隐藏主KPI卡片
           console.log('隐藏KPI卡片');
           uploadSection.style.display = 'none';
           console.log('KPI卡片隐藏后的display值:', uploadSection.style.display);
         } else {
           // 其他页面显示主KPI卡片
           console.log('显示KPI卡片');
           uploadSection.style.display = '';
           console.log('KPI卡片显示后的display值:', uploadSection.style.display);
         }
       } else {
         console.log('未找到upload-section元素');
       }
       
       // 根据路由加载相应数据
       if (hash === 'analysis') {
         loadAnalysisData();
       } else if (hash === 'products') {
         loadProductAnalysisData();
       }
     }
   }
   
   // 添加双击产品跳转功能
   function addProductDoubleClickHandler() {
     // 监听数据表格中的产品ID双击事件
     document.addEventListener('dblclick', function(e) {
       const target = e.target;
       
       // 检查是否双击了产品ID
       if (target.tagName === 'A' && target.getAttribute('data-pid')) {
         const productId = target.getAttribute('data-pid');
         console.log('双击产品ID:', productId);
         
         // 跳转到产品分析页面
         window.location.href = `self-operated.html#products?pid=${productId}`;
       }
     });
   }
  
  // 监听hash变化
  window.addEventListener('hashchange', handleHashRoute);
  
     // 初始化hash路由
   handleHashRoute();
   
   // 添加双击产品跳转功能
   addProductDoubleClickHandler();
   
   // 导航点击处理
   document.querySelectorAll('.sub-nav a').forEach(a => {
     a.addEventListener('click', e => {
       const target = a.dataset.target;
       if (target) {
         e.preventDefault();
         window.location.hash = target;
       }
     });
   });
 });
</script>
</body>
</html>
