<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>自运营数据分析</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- libs -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <style>
    :root{--bg:#0b1220;--text:#E5E7EB;--muted:#94A3B8;--card:#111827;--border:#1F2937}
    body{background:var(--bg);color:var(--text);margin:0;font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif}
    .container{display:flex;min-height:100vh}
    nav.sidebar{width:220px;background:#0a1020;padding:16px;border-right:1px solid rgba(148,163,184,.15)}
    nav h3{margin:0 0 12px 0;font-weight:700}
    nav ul{list-style:none;padding:0;margin:0}
    nav li{margin:8px 0}
    nav a{color:var(--text);text-decoration:none;opacity:.9}
    nav a.active{color:#60A5FA}
    .main{flex:1;padding:16px}
    .upload-section .controls{display:flex;align-items:center;gap:.5rem;margin:.25rem 0}
    .upload-btn{padding:.4rem .8rem;border:1px solid var(--border);background:#0f172a;border-radius:8px;cursor:pointer}
    input[type="file"]{display:none}
    .btn{padding:.4rem .8rem;border:1px solid var(--border);background:#0f172a;border-radius:8px;color:var(--text);cursor:pointer}
    .sel{padding:.35rem .5rem;border:1px solid var(--border);background:#0f172a;border-radius:8px;color:var(--text)}
    .date-filter{padding:.4rem .6rem;border:1px solid var(--border);background:#0f172a;border-radius:8px;color:var(--text);min-width:220px}
    .divider{height:1px;background:rgba(148,163,184,.12);margin:10px 0 12px}
    .kpi{display:flex;gap:.75rem;flex-wrap:wrap}
    .kpi .card{background:var(--card);border:1px solid rgba(148,163,184,.15);padding:12px 14px;border-radius:12px;min-width:150px}
    .kpi .card h4{margin:0 0 4px 0;font-weight:600;color:#9CA3AF}
    .kpi .card p{margin:0;font-size:20px;font-weight:800}
    .tabs{display:flex;gap:12px;margin:10px 0}
    .tab{padding:.4rem .75rem;border:1px solid var(--border);border-radius:999px;cursor:pointer;background:#0f172a}
    .tab.active{background:#172554;color:#fff}
    .content-pad .panel{background:var(--card);border:1px solid rgba(148,163,184,.15);border-radius:12px;padding:14px;margin-top:10px}
    .table-wrapper{overflow:auto}
    table.dataTable thead th{background:#0f172a;color:#cbd5e1}
    table.dataTable tbody td{color:#dbeafe}
    a{color:#60a5fa}
    .legend-list a{margin-right:8px}
  </style>
</head>
<body>
<div class="container">
  <nav class="sidebar">
    <h3>产品导航</h3>
    <ul>
      <li><a href="index.html">全托管</a></li>
      <li><a href="self-operated.html" class="active">自运营</a></li>
    </ul>
  </nav>

  <div class="main">
    <div class="upload-section">
      <div class="controls">
        <label for="fileInput" class="upload-btn">选择文件</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <span class="notice">（上传→服务端入库→可视化与明细展示）</span>
        <span id="progress" class="progress"></span>
      </div>
      <div class="controls">
        <span>粒度：</span>
        <span class="sel" style="background:#1f2937;color:#fff;border-color:#334155;cursor:not-allowed">按日</span>
        <input type="hidden" id="granularity" value="day">
        <span>日期：</span>
        <input id="dateFilter" class="date-filter" placeholder="选择日期范围">
        <button id="refreshBtn" class="btn">刷新</button>
      </div>
      <div class="divider"></div>
      <div class="kpi">
        <div class="card"><h4>平均访客比</h4><p id="avgVisitor">0%</p></div>
        <div class="card"><h4>平均加购比</h4><p id="avgCart">0%</p></div>
        <div class="card"><h4>平均支付比</h4><p id="avgPay">0%</p></div>
        <div class="card"><h4>商品总数</h4><p id="totalProducts">0</p></div>
        <div class="card"><h4>加购商品数</h4><p id="cartedProducts">0</p></div>
        <div class="card"><h4>支付商品数</h4><p id="purchasedProducts">0</p></div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="summary">汇总对比</div>
      <div class="tab" data-tab="detail">明细表</div>
    </div>

    <div class="content">
      <section id="summary" class="content-pad">
        <div class="panel">
          <h3>周期 A vs 周期 B · 总量曲线（按天）</h3>
          <div class="controls" style="margin-bottom:8px;">
            <span>维度：</span>
            <select id="metricSel" class="sel">
              <option value="exposure_sum">曝光量总和</option>
              <option value="visitors_sum">访客数总和</option>
              <option value="add_people_sum">加购人数总和</option>
              <option value="fav_sum">收藏总数</option>
              <option value="orders_sum">下单总数</option>
            </select>
            <span class="notice">A = 当前选择；B = 上一周期（向前平移同长度）。</span>
          </div>
          <div id="lineChart" style="width:100%;height:360px;"></div>
        </div>
        <div class="panel">
          <h3>平均比率对比（A vs B）</h3>
          <div id="ratioBar" style="width:100%;height:300px;"></div>
        </div>
        <div class="panel">
          <h3>Top6 加购商品（A & B）</h3>
          <div id="topBar" style="width:100%;height:320px;"></div>
          <div id="topBarLinks" class="legend-list" style="margin-top:6px;"></div>
        </div>
      </section>

      <section id="detail" class="content-pad" style="display:none;">
        <div class="panel">
          <h3>数据明细</h3>
          <div class="table-wrapper">
            <table id="report" class="display nowrap" style="width:100%"></table>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
/* -------------- 小工具 -------------- */
const toNum = v => { if (v===null||v===undefined) return 0; if (typeof v==='number') return isFinite(v)?v:0; const n=parseFloat(String(v).replace(/,/g,'').trim()); return isNaN(n)?0:n; };
function formatCtr(v){
  if (v==null || v==='') return '';
  let n = Number(v);
  if (!isFinite(n)) return '';
  // 统一显示为百分比：若值<=1，视为比率乘100；否则认为已是百分数
  if (n <= 1) n *= 100;
  return n.toFixed(2) + '%';
}
(function(){ $('.tab').on('click', function(){ $('.tab').removeClass('active'); $(this).addClass('active'); const id=$(this).data('tab'); $('#summary').toggle(id==='summary'); $('#detail').toggle(id==='detail'); }); })();

/* -------------- 上传 Excel -> 入库 -------------- */
$('#fileInput').on('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(evt) {
    try {
      $('#progress').text('解析中…');
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
      if (sheet.length < 2) throw new Error('表格无有效数据');
      const headers = sheet[0].map(h => String(h).trim());
      const norm = s => String(s||'').replace(/[\s%（）()]/g,'').toLowerCase();
      const headersN = headers.map(norm);
      const findIdx = (re) => headers.findIndex(h => re.test(String(h).trim()));
      const findAny = (tokens) => {
        for (let i=0;i<headers.length;i++){
          for (const t of tokens){
            if (headersN[i].includes(norm(t))) return i;
          }
        }
        return -1;
      };
      const idx = {
        product_id: findAny(['商品id','id','item id','product id']) !== -1 ? findAny(['商品id','id','item id','product id']) : findIdx(/^(商品)?ID$|^商品id$|^id$|^item id$|^item_id$/i),
        stat_date:  findAny(['统计时间','日期','数据时间','date']) !== -1 ? findAny(['统计时间','日期','数据时间','date']) : findIdx(/^(统计时间|日期|数据时间|date)$/i),
        exposure:   findAny(['搜索曝光量','曝光量','商品曝光量','impressions']) !== -1 ? findAny(['搜索曝光量','曝光量','商品曝光量','impressions']) : findIdx(/^(搜索曝光量|曝光量|商品曝光量|impressions)$/i),
        visitors:   (function(){ const rs=[/^(商品)?访客数$/i,/^访客人数$/i,/^访客量$/i,/^uv$/i,/^sessions$/i]; for (const re of rs){const i=findIdx(re); if(i!==-1) return i;} const i2=headers.findIndex(h=>/访客数|访客/i.test(String(h).trim())&&!/(老|新|回|复)访客/i.test(String(h).trim())); return i2; })(),
        visitors_new: findIdx(/^(新访客数|新访客|新用户|新增访客)$/i),
        visitors_old: findIdx(/^(老访客数|老访客|回访客|复访客)$/i),
        views:      findAny(['商品浏览量','浏览量','pv','page views']) !== -1 ? findAny(['商品浏览量','浏览量','pv','page views']) : findIdx(/^(商品浏览量|浏览量|pv|page views)$/i),
        add_people: findAny(['商品加购人数','加购人数','加购买家数']) !== -1 ? findAny(['商品加购人数','加购人数','加购买家数']) : findIdx(/^(商品加购人数|加购人数|加购买家数)$/i),
        add_count:  findAny(['商品加购件数','加购件数']) !== -1 ? findAny(['商品加购件数','加购件数']) : findIdx(/^(商品加购件数|加购件数)$/i),
        pay_items:  (function(){ const i1=findAny(['支付商品件数','支付件数','付款件数','成交件数']); if(i1!==-1) return i1; const rs=[/^支付商品件数$/i,/^支付件数$/i,/^付款件数$/i,/^成交件数$/i]; for(const re of rs){const i=findIdx(re); if(i!==-1) return i;} return -1; })(),
        pay_orders: findAny(['支付订单数','下单人数','订单数']) !== -1 ? findAny(['支付订单数','下单人数','订单数']) : findIdx(/^(支付订单数|下单人数|订单数)$/i),
        pay_buyers: findAny(['支付买家数','支付人数','成交人数']) !== -1 ? findAny(['支付买家数','支付人数','成交人数']) : findIdx(/^(支付买家数|支付人数|成交人数)$/i),
        fav_people: findAny(['收藏人数','收藏买家数','收藏用户数']),
        fav_count:  findAny(['收藏件数','收藏量']),
        order_items: (function(){ const i1=findAny(['下单商品件数','下单件数','下单商品数','下单商品数量']); if(i1!==-1) return i1; return findIdx(/^(下单商品件数|下单件数|下单商品数|下单商品数量)$/i); })(),
        avg_stay_seconds: (function(){ const i1=findAny(['平均停留时长','平均停留时间','平均访问时长']); if(i1!==-1) return i1; return findIdx(/^(平均停留时长(\(秒\))?|平均停留时间|平均访问时长)$/i); })(),
        search_ctr: (function(){ const i1=findAny(['搜索点击率','点击率']); if(i1!==-1) return i1; return findIdx(/^(搜索点击率(\(%\))?|点击率(\(%\))?|搜索点击率|点击率)$/i); })(),
      };
      if (idx.product_id<0 || idx.stat_date<0) throw new Error('缺少必填：商品ID / 统计时间');

      function excelDateToISO(n){ if(typeof n!=='number') return null; const utc_days=Math.floor(n-25569); const utc_value=utc_days*86400; const date_info=new Date(utc_value*1000); const y=date_info.getUTCFullYear(); const m=(date_info.getUTCMonth()+1).toString().padStart(2,'0'); const d=date_info.getUTCDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; }
      function parseDateToISO(v){ if(v===null||v===undefined||v==='') return null; if(typeof v==='number') return excelDateToISO(v); let s=String(v).trim(); s=s.replace(/[.]/g,'-').replace(/\//g,'-'); const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`; const m2=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/); if(m2) return `${m2[3]}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`; return s.slice(0,10); }

      const rows = sheet.slice(1).filter(r => r && r.length).map(r => {
        const pid = String(r[idx.product_id]).trim();
        const sd  = parseDateToISO(r[idx.stat_date]);
        const visitors = (idx.visitors !== -1 ? toNum(r[idx.visitors])
                        : ((idx.visitors_new !== -1 ? toNum(r[idx.visitors_new]) : 0)
                        + (idx.visitors_old !== -1 ? toNum(r[idx.visitors_old]) : 0)));
        // 解析点击率：接受 0.0733 或 '7.33%'
        const parseCtr = (x) => {
          const s = String(x ?? '').trim();
          if (!s) return 0;
          if (s.endsWith('%')) return toNum(s.replace('%','')) / 100;
          const n = toNum(s);
          return n > 1 ? n/100 : n; // 7.33 -> 0.0733；0.0733 保持
        };
        const row = {
          product_id: pid, stat_date: sd,
          exposure:  idx.exposure  === -1 ? 0 : toNum(r[idx.exposure]),
          visitors,
          views:     idx.views     === -1 ? 0 : toNum(r[idx.views]),
          add_people:idx.add_people=== -1 ? 0 : toNum(r[idx.add_people]),
          add_count: idx.add_count === -1 ? 0 : toNum(r[idx.add_count]),
          pay_items: idx.pay_items === -1 ? 0 : toNum(r[idx.pay_items]),
          pay_orders:idx.pay_orders=== -1 ? 0 : toNum(r[idx.pay_orders]),
          pay_buyers:idx.pay_buyers=== -1 ? 0 : toNum(r[idx.pay_buyers]),
          order_items: idx.order_items === -1 ? 0 : toNum(r[idx.order_items]),
          avg_stay_seconds: idx.avg_stay_seconds === -1 ? 0 : toNum(r[idx.avg_stay_seconds]),
          search_ctr: idx.search_ctr === -1 ? 0 : parseCtr(r[idx.search_ctr]),
        };
        if (idx.fav_people !== -1) row.fav_people = toNum(r[idx.fav_people]);
        if (idx.fav_count  !== -1) row.fav_count  = toNum(r[idx.fav_count]);
        return row;
      }).filter(x => x.product_id && x.stat_date);

      const dmap=new Map(); rows.forEach(r=>dmap.set(r.product_id+'__'+r.stat_date,r)); const deduped=Array.from(dmap.values());
      console.log('[AE Upload Preview]', deduped.slice(0,5));

      $('#progress').text(`入库中（${deduped.length} 条）…`);
      const dry = false; // 如需仅调试改为 true（不入库）
      const resp = await fetch('/api/ae_upsert' + (dry ? '?dry_run=1' : ''), {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rows: deduped })
      });
      const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Upsert API响应不是JSON：' + txt.slice(0,200)); }
      if (!resp.ok || !j.ok) throw new Error(j.error || '入库失败');
      $('#progress').text('入库完成 ✔'); $('#refreshBtn').click();
    } catch(err) { console.error(err); alert('处理失败：' + (err.message || err)); $('#progress').text(''); }
  };
  reader.readAsArrayBuffer(file);
});

/* -------------- 查询 / 汇总 / 表格 -------------- */
async function fetchAgg(startISO, endISO, granularity) {
  const url = `/api/ae_query?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}&granularity=${encodeURIComponent(granularity)}`;
  const resp = await fetch(url);
  const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Query API响应不是JSON：' + txt.slice(0,200)); }
  if (!resp.ok || !j.ok) throw new Error(j.error || '查询失败');
  return j.rows || [];
}
function periodShift(startISO, endISO) {
  const start = new Date(startISO + 'T00:00:00'); const end = new Date(endISO + 'T00:00:00');
  const days = Math.round((end - start) / 86400000) + 1;
  const prevEnd = new Date(start.getTime() - 86400000);
  const prevStart = new Date(prevEnd.getTime() - (days-1)*86400000);
  const fmt = d => d.toISOString().slice(0,10);
  return { prevStart: fmt(prevStart), prevEnd: fmt(prevEnd), days };
}
function computeCards(rows) {
  if (!rows.length) {
    $('#avgVisitor').text('0%'); $('#avgCart').text('0%'); $('#avgPay').text('0%');
    $('#totalProducts').text(0); $('#cartedProducts').text(0); $('#purchasedProducts').text(0); return;
  }
  const sum = rows.reduce((a,b)=>({exposure:a.exposure+b.exposure,visitors:a.visitors+b.visitors,add_people:a.add_people+b.add_people,pay_buyers:a.pay_buyers+b.pay_buyers}), {exposure:0,visitors:0,add_people:0,pay_buyers:0});
  const products=new Map(); rows.forEach(r=>{ if(!products.has(r.product_id)) products.set(r.product_id,{exp:0,add:0,pay:0}); const acc=products.get(r.product_id); acc.exp+=r.exposure||0; acc.add+=r.add_people||0; acc.pay+=r.pay_buyers||0; });
  let pe=0,pc=0,pp=0; products.forEach(v=>{ if(v.exp>0)pe++; if(v.add>0)pc++; if(v.pay>0)pp++; });
  const vr=sum.exposure>0?((sum.visitors/sum.exposure)*100).toFixed(2)+'%':'0%';
  const cr=sum.visitors>0?((sum.add_people/sum.visitors)*100).toFixed(2)+'%':'0%';
  const pr=sum.add_people>0?((sum.pay_buyers/sum.add_people)*100).toFixed(2)+'%':'0%';
  $('#avgVisitor').text(vr); $('#avgCart').text(cr); $('#avgPay').text(pr);
  $('#totalProducts').text(products.size); $('#cartedProducts').text(pc); $('#purchasedProducts').text(pp);
}
function buildDailyTotals(rows, days, startISO) {
  const byDay=new Map(); rows.forEach(r=>{ const d=r.bucket; if(!byDay.has(d)) byDay.set(d,{exp:0,vis:0,add:0,fav:0,orders:0}); const a=byDay.get(d); a.exp+=r.exposure||0; a.vis+=r.visitors||0; a.add+=r.add_people||0; a.orders+=r.pay_orders||0; a.fav+=(r.fav_people||r.fav_count||0); });
  const x=[],A=[]; const start=new Date(startISO+'T00:00:00');
  for(let i=0;i<days;i++){ const cur=new Date(start.getTime()+i*86400000); const key=cur.toISOString().slice(0,10); x.push(`Day ${i+1}`); const a=byDay.get(key)||{exp:0,vis:0,add:0,fav:0,orders:0}; A.push({exp:a.exp,vis:a.vis,add:a.add,fav:a.fav,orders:a.orders,date:key}); }
  return { x, A };
}
function drawLineChartDaily(rowsA, rowsB, days, startA, startB, metricKey) {
  const chart=echarts.init(document.getElementById('lineChart'));
  const A=buildDailyTotals(rowsA,days,startA); const B=buildDailyTotals(rowsB,days,startB); const x=A.x;
  function pick(arr){ return arr.map(o=>Number((o[metricKey]||0))) }
  chart.setOption({
    tooltip:{ trigger:'axis', backgroundColor:'#0b1220', borderColor:'rgba(148,163,184,0.18)', textStyle:{ color:'#E5E7EB' } },
    legend:{ data:['周期A','周期B'], textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:40, right:16, top:36, bottom:24 },
    xAxis:{ type:'category', data:x, axisLabel:{ color:'#E5E7EB', fontWeight:700 }, axisLine:{ lineStyle:{ color:'rgba(148,163,184,0.18)'}}, splitLine:{ show:true, lineStyle:{ color:'rgba(148,163,184,0.18)'}} },
    yAxis:{ type:'value', axisLabel:{ color:'#E5E7EB', fontWeight:700 }, axisLine:{ lineStyle:{ color:'rgba(148,163,184,0.18)'}}, splitLine:{ lineStyle:{ color:'rgba(148,163,184,0.18)'}} },
    series:[
      { name:'周期A', type:'line', data:pick(A.A), smooth:true, showSymbol:false, lineStyle:{ width:3 } },
      { name:'周期B', type:'line', data:pick(B.A), smooth:true, showSymbol:false, lineStyle:{ width:3 } }
    ]
  }); window.addEventListener('resize', ()=>chart.resize());
}
function drawRatioBar(rowsA, rowsB){
  function sums(rows){ return rows.reduce((a,b)=>({exp:a.exp+b.exposure,vis:a.vis+b.visitors,add:a.add+b.add_people,pay:a.pay+b.pay_buyers}),{exp:0,vis:0,add:0,pay:0}); }
  const A=sums(rowsA), B=sums(rowsB);
  const d={ A:[(A.vis>0?A.add/A.vis*100:0),(A.exp>0?A.vis/A.exp*100:0),(A.add>0?A.pay/A.add*100:0)], B:[(B.vis>0?B.add/B.vis*100:0),(B.exp>0?B.vis/B.exp*100:0),(B.add>0?B.pay/B.add*100:0)] };
  const chart=echarts.init(document.getElementById('ratioBar'));
  chart.setOption({
    tooltip:{ trigger:'axis', backgroundColor:'#0b1220', borderColor:'rgba(148,163,184,0.18)', textStyle:{ color:'#E5E7EB' } },
    legend:{ data:['周期A','周期B'], textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:40, right:16, top:36, bottom:24 },
    xAxis:{ type:'category', data:['平均加购比','平均访客比','平均支付比'], axisLabel:{ color:'#E5E7EB', fontWeight:700 }, axisLine:{ lineStyle:{ color:'rgba(148,163,184,0.18)'}}, splitLine:{ show:false } },
    yAxis:{ type:'value', axisLabel:{ color:'#E5E7EB', fontWeight:700, formatter:'{value} %' }, axisLine:{ lineStyle:{ color:'rgba(148,163,184,0.18)'}}, splitLine:{ lineStyle:{ color:'rgba(148,163,184,0.18)'}} },
    series:[
      { name:'周期A', type:'bar', data:d.A.map(v=>Number(v.toFixed(2))), label:{ show:true, position:'top', formatter:'{c}%', color:'#E5E7EB', fontWeight:700 } },
      { name:'周期B', type:'bar', data:d.B.map(v=>Number(v.toFixed(2))), label:{ show:true, position:'top', formatter:'{c}%', color:'#E5E7EB', fontWeight:700 } }
    ]
  }); window.addEventListener('resize', ()=>chart.resize());
}
async function drawTop6Both(rowsA, rowsB){
  function perAdd(rows){ const m=new Map(); rows.forEach(r=>m.set(r.product_id,(m.get(r.product_id)||0)+(r.add_people||0))); return m; }
  const mapA=perAdd(rowsA), mapB=perAdd(rowsB);
  const topN=(map,n=6)=>Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([id])=>id);
  const unionIds=Array.from(new Set([...topN(mapA,6),...topN(mapB,6)]));
  const rows=unionIds.map(id=>({id,a:mapA.get(id)||0,b:mapB.get(id)||0,max:Math.max(mapA.get(id)||0,mapB.get(id)||0)})).sort((x,y)=>y.max-x.max);
  const ids=rows.map(r=>r.id), labels=ids, dataA=rows.map(r=>r.a), dataB=rows.map(r=>r.b);
  const chart=echarts.init(document.getElementById('topBar'));
  chart.setOption({
    tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' }, backgroundColor:'#0b1220', borderColor:'rgba(148,163,184,0.18)', textStyle:{ color:'#E5E7EB' } },
    legend:{ textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:140, right:20, top:20, bottom:24 },
    xAxis:{ type:'value', axisLabel:{ color:'#E5E7EB', fontWeight:700 }, axisLine:{ lineStyle:{ color:'rgba(148,163,184,0.18)'}}, splitLine:{ lineStyle:{ color:'rgba(148,163,184,0.18)'}} },
    yAxis:{ type:'category', data:labels, axisLabel:{ color:'#E5E7EB', fontWeight:700 }, axisLine:{ lineStyle:{ color:'rgba(148,163,184,0.18)'}}, splitLine:{ show:false } },
    series:[
      { name:'周期A', type:'bar', data:dataA, label:{ show:true, position:'right', color:'#E5E7EB', fontWeight:700 } },
      { name:'周期B', type:'bar', data:dataB, label:{ show:true, position:'right', color:'#E5E7EB', fontWeight:700 } }
    ]
  });
  chart.off('click'); chart.on('click', p=>{ const id=ids[p.dataIndex]; if(id) window.open(`https://aliexpress.com/item/${id}.html`,'_blank'); });
  window.addEventListener('resize', ()=>chart.resize());
  const linksDiv=document.getElementById('topBarLinks'); if(linksDiv){ linksDiv.innerHTML=ids.map(id=>`<a href="https://aliexpress.com/item/${id}.html" target="_blank">#${id}</a>`).join(' '); }
}
async function renderTable(rows, granularity) {
  if (window.dataTable) window.dataTable.destroy(); $('#report').empty();
  const data = rows.map(r => {
    const link = r.product_id ? `<a href="https://aliexpress.com/item/${r.product_id}.html" target="_blank">${r.product_id}</a>` : '';
    const conv1 = r.exposure>0 ? ((r.visitors/r.exposure)*100).toFixed(2) : '0.00';
    const conv2 = r.visitors>0 ? ((r.add_people/r.visitors)*100).toFixed(2) : '0.00';
    const conv3 = r.add_people>0 ? ((r.pay_buyers/r.add_people)*100).toFixed(2) : '0.00';
    const ctr = formatCtr(r.search_ctr);
    const stay = (r.avg_stay_seconds==null || r.avg_stay_seconds===undefined) ? '' : Math.round(r.avg_stay_seconds);
    const rowArr = [link, r.bucket_label || r.bucket, conv1 + '%', conv2 + '%', conv3 + '%', r.exposure, r.visitors, r.views, r.add_people, r.order_items, r.pay_items, r.pay_buyers, ctr, stay];
    while (rowArr.length < 14) rowArr.push('');
    if (rowArr.length > 14) rowArr.length = 14;
    return rowArr;
  });
  const allColumns = [
    { title: '商品（ID）' },
    { title: granularity==='day' ? '日期' : (granularity==='week' ? '周范围' : '月份范围') },
    { title: '访客比(%)' }, { title: '加购比(%)' }, { title: '支付比(%)' },
    { title: '曝光量' }, { title: '访客数' }, { title: '浏览量' },
    { title: '加购人数' }, { title: '下单商品件数' }, { title: '支付件数' },
    { title: '支付买家数' }, { title: '搜索点击率(%)' }, { title: '平均停留时长(秒)' }
  ];
  window.dataTable = $('#report').DataTable({
    data, columns: allColumns, order: [[1,'desc']],
    scrollX:true, scrollY:'calc(100vh - 420px)', scrollCollapse:true, fixedHeader:true, fixedColumns:{leftColumns:1}
  });
}
async function fetchAndRenderAll() {
  try {
    const val=$('#dateFilter').val(); let startISO,endISO;
    if (val && val.includes(' to ')) { const [s,e]=val.split(' to '); startISO=s; endISO=e; }
    else { const today=new Date(); endISO=today.toISOString().slice(0,10); startISO=new Date(today.getTime()-6*86400000).toISOString().slice(0,10); $('#dateFilter').val(`${startISO} to ${endISO}`); }
    const g='day'; $('#progress').text('查询中…');
    const rowsNowAgg=await fetchAgg(startISO,endISO,g);
    computeCards(rowsNowAgg);
    await renderTable(rowsNowAgg,g);
    const { prevStart, prevEnd, days }=periodShift(startISO,endISO);
    const rowsA=await fetchAgg(startISO,endISO,'day');
    const rowsB=await fetchAgg(prevStart,prevEnd,'day');
    drawLineChartDaily(rowsA,rowsB,days,startISO,prevStart,'exp');
    drawRatioBar(rowsA,rowsB);
    await drawTop6Both(rowsA,rowsB);
    $('#progress').text(`A: ${rowsA.length} 条 · B: ${rowsB.length} 条`);
  } catch (err) { console.error(err); alert('查询失败：' + (err.message || err)); $('#progress').text(''); }
}
const fp=flatpickr('#dateFilter',{ mode:'range', dateFormat:'Y-m-d', onClose:(ds)=>{ if(ds.length===2) fetchAndRenderAll(); } });
$('#refreshBtn').on('click', fetchAndRenderAll);
(async function initDefault(){ const today=new Date(); const end=today.toISOString().slice(0,10); const startDate=new Date(today.getTime()-6*86400000).toISOString().slice(0,10); $('#dateFilter').val(`${startDate} to ${end}`); await fetchAndRenderAll(); })();
</script>
</body>
</html>
