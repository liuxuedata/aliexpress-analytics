<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title id="pageTitle">è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å° - è‡ªè¿è¥Robotç«™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- libs -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <!-- ä¸»é¢˜æ ·å¼ï¼ˆæ²¿ç”¨ä½ ç°æœ‰çš„ï¼‰ -->
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250810b">
  <link rel="stylesheet" href="assets/global-theme.css">
  <script src="assets/site-nav.js"></script>
  <script src="assets/page-template.js"></script>
  <script src="assets/self-operated.js"></script>
  <style>
    /* ç§»é™¤æ—§çš„KPIæ ·å¼ï¼Œä½¿ç”¨å…¨å±€UIç³»ç»Ÿ */
    /* æ—§çš„æ ·å¼å·²è¢«å…¨å±€ä¸»é¢˜ç³»ç»Ÿæ›¿ä»£ */
    
    /* ç«™ç‚¹é€‰æ‹©å™¨æ ·å¼ */
    .site-selector {
      padding: 10px 15px;
      border-bottom: 1px solid #374151;
    }
    .site-selector select {
      width: 100%;
      padding: 8px;
      border: 1px solid #4b5563;
      border-radius: 4px;
      background: #1f2937;
      color: white;
      font-size: 14px;
    }
    .add-site-btn {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 4px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }
    .add-site-btn:hover {
      background: #2563eb;
    }
    
    /* ä½¿ç”¨å…¨å±€UIç³»ç»Ÿçš„æ ·å¼ï¼Œç§»é™¤æ—§çš„éª¨æ¶å±æ ·å¼ */
    .loading-state {
      text-align: center;
      background: #f8fafc;
      border-radius: 8px;
      margin: 20px 0;
      padding: 40px 20px;
    }
    
    .loading-bar {
      width: 200px;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      margin: 0 auto 20px;
      overflow: hidden;
    }
    
    .loading-progress {
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      border-radius: 2px;
      animation: loading-progress 2s ease-in-out infinite;
    }
    
    @keyframes loading-progress {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(0%); }
      100% { transform: translateX(100%); }
    }
    
    .loading-text {
      color: #6b7280;
      font-size: 14px;
      margin: 0;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .controls {
      margin-bottom: 16px;
    }
    
    .sel {
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: white;
      margin: 0 8px;
    }
    
    .notice {
      color: #6b7280;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .legend-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .legend-list a {
      color: #3b82f6;
      text-decoration: none;
      font-size: 12px;
    }
    
    .legend-list a:hover {
      text-decoration: underline;
    }
    
    /* KPIå¯¹æ¯”æ•°æ®æ ·å¼ */
    .kpi-comparison {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      text-align: center;
    }
    
    .kpi-comparison .text-green-600 {
      color: #059669;
    }
    
    .kpi-comparison .text-red-600 {
      color: #dc2626;
    }
    
    .kpi-comparison .text-gray-500 {
      color: #6b7280;
    }
    
    /* çŠ¶æ€æ˜¾ç¤ºæ ·å¼ */
    .status-display {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      min-width: 120px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .status-display.loading {
      background: rgba(59, 130, 246, 0.1);
      color: #1d4ed8;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .status-display.success {
      background: rgba(34, 197, 94, 0.1);
      color: #166534;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    
    .status-display.error {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* æ–°å¢ï¼šä¼˜åŒ–è¿è¥åˆ†æå’Œäº§å“åˆ†æé¡µé¢çš„UI */
    
    /* åˆ†æé¡µé¢å®¹å™¨æ ·å¼ - æ”¹ä¸ºç™½è‰²èƒŒæ™¯ä¸ä¸»é¡µé¢ä¸€è‡´ */
    .analysis-container {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    
    .analysis-container h3 {
      color: #374151;
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 20px 0;
      text-align: center;
      text-shadow: none;
    }
    
    /* åˆ†æKPIå¡ç‰‡ç½‘æ ¼ */
    .analysis-kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
         .analysis-kpi-card {
       background: white;
       border-radius: 12px;
       padding: 20px;
       text-align: center;
       box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
       transition: all 0.3s ease;
       border: 2px solid transparent;
       position: relative;
       overflow: hidden;
     }
     
     .analysis-kpi-card:hover {
       transform: translateY(-4px);
       box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
       border-color: rgba(59, 130, 246, 0.3);
     }
     
     /* æ¸å˜è‰²é¡¶éƒ¨æ ‡è¯† */
     .analysis-kpi-card::before {
       content: '';
       position: absolute;
       top: 0;
       left: 0;
       right: 0;
       height: 4px;
       background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #ef4444);
       background-size: 200% 100%;
       animation: gradient-shift 3s ease-in-out infinite;
     }
     
     @keyframes gradient-shift {
       0%, 100% { background-position: 0% 50%; }
       50% { background-position: 100% 50%; }
     }
     
     /* äº§å“åˆ†æé¡µé¢çš„KPIå¡ç‰‡ç‰¹æ®Šæ ·å¼ */
     #products .analysis-kpi-card::before {
       background: linear-gradient(90deg, #8b5cf6, #06b6d4, #10b981, #f59e0b);
     }
    
    .analysis-kpi-card h4 {
      color: #374151;
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .analysis-kpi-card p {
      color: #1f2937;
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
         /* å›¾è¡¨ç½‘æ ¼å¸ƒå±€ */
     .charts-grid {
       display: grid;
       grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
       gap: 20px;
     }
     
     .chart-panel {
       background: white;
       border-radius: 12px;
       padding: 20px;
       box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
       transition: all 0.3s ease;
       border: 1px solid #e5e7eb;
       position: relative;
       overflow: hidden;
     }
     
     .chart-panel:hover {
       transform: translateY(-2px);
       box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
     }
     
     .chart-panel h3 {
       color: #374151;
       font-size: 18px;
       font-weight: 600;
       margin: 0 0 16px 0;
       text-align: center;
       text-shadow: none;
     }
     
     /* å›¾è¡¨å®¹å™¨æ ·å¼ä¼˜åŒ– - è®©æ›²çº¿å»¶ä¼¸åˆ°KPIæ¡†å†… */
     .chart-panel .echarts-for-react,
     .chart-panel div[id*="Chart"] {
       width: 100% !important;
       height: 100% !important;
       min-height: 300px;
     }
     
     /* äº§å“åˆ†æé¡µé¢çš„å›¾è¡¨ç‰¹æ®Šæ ·å¼ */
     #products .chart-panel {
       padding: 24px;
       min-height: 350px;
     }
     
     #products .chart-panel div[id*="Chart"] {
       min-height: 280px;
       margin: -12px;
       width: calc(100% + 24px) !important;
       height: calc(100% + 24px) !important;
     }
    
    /* äº§å“é€‰æ‹©å™¨æ ·å¼ */
    .product-selector {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    
    .product-selector .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .product-selector label {
      font-weight: 600;
      color: #374151;
      min-width: 60px;
    }
    
    .product-selector .sel {
      min-width: 200px;
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
         .product-selector .sel:focus {
       outline: none;
       border-color: #3b82f6;
       box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
     }
     
     .product-selector .product-count-info {
       margin-left: auto;
       padding: 8px 16px;
       background: #f3f4f6;
       border-radius: 6px;
       font-size: 14px;
       color: #374151;
     }
     
     .product-selector .product-count-info strong {
       color: #1f2937;
       font-weight: 600;
     }
     
     .product-selector .time-controls {
       margin-top: 16px;
       padding-top: 16px;
       border-top: 1px solid #e5e7eb;
       display: flex;
       align-items: center;
       gap: 12px;
       flex-wrap: wrap;
     }
     
     .product-selector .time-controls label {
       font-weight: 600;
       color: #374151;
       min-width: 80px;
     }
     
     .product-selector .time-controls .date-filter {
       padding: 8px 12px;
       border: 2px solid #e5e7eb;
       border-radius: 8px;
       font-size: 14px;
       transition: all 0.3s ease;
       min-width: 200px;
     }
     
     .product-selector .time-controls .date-filter:focus {
       outline: none;
       border-color: #3b82f6;
       box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
     }
     
     .product-selector img {
       border-radius: 8px;
       border: 2px solid #e5e7eb;
     }
     
     .product-selector a {
       color: #3b82f6;
       text-decoration: none;
       font-weight: 500;
       transition: color 0.3s ease;
     }
     
     .product-selector a:hover {
       color: #2563eb;
       text-decoration: underline;
     }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .analysis-container {
        padding: 16px;
        margin-bottom: 16px;
      }
      
      .analysis-kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .product-selector .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .product-selector .sel {
        min-width: auto;
        width: 100%;
      }
    }
    
    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .analysis-container {
      animation: fadeInUp 0.6s ease-out;
    }
    
    .analysis-kpi-card {
      animation: fadeInUp 0.6s ease-out;
      animation-fill-mode: both;
    }
    
         .analysis-kpi-card:nth-child(1) { animation-delay: 0.1s; }
     .analysis-kpi-card:nth-child(2) { animation-delay: 0.2s; }
     .analysis-kpi-card:nth-child(3) { animation-delay: 0.3s; }
     .analysis-kpi-card:nth-child(4) { animation-delay: 0.4s; }
     
     /* æ–°å¢ï¼šä¼˜åŒ–äº§å“è¯¦æƒ…åˆ†æé¡µé¢çš„UI */
     .product-info-panel {
       background: #f9fafb;
       border-radius: 12px;
       padding: 20px;
       margin-bottom: 24px;
       box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
       border: 1px solid #e5e7eb;
     }
     
     .product-header {
       display: flex;
       justify-content: space-around;
       align-items: center;
       gap: 20px;
       flex-wrap: wrap;
     }
     
     .product-id, .product-link, .product-listing-date {
       text-align: center;
       flex: 1;
       min-width: 150px;
     }
     
     .product-id h4, .product-link h4, .product-listing-date h4 {
       color: #374151;
       font-size: 14px;
       font-weight: 600;
       margin-bottom: 8px;
     }
     
     .product-id p, .product-listing-date p {
       color: #1f2937;
       font-size: 24px;
       font-weight: 700;
       margin: 0;
       text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
     }
     
     .product-link-btn {
       background: #3b82f6;
       color: white;
       padding: 10px 20px;
       border-radius: 8px;
       font-size: 16px;
       font-weight: 600;
       text-decoration: none;
       transition: background-color 0.3s ease;
       display: inline-block;
     }
     
     .product-link-btn:hover {
       background: #2563eb;
     }
   </style>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
        <div class="form-subtitle">ç™»å½•è´¦æˆ·ä»¥ç»§ç»­</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">é‚®ç®±</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">å¯†ç </label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">ğŸ‘ï¸</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">ç™»å½•</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">æ¼”ç¤ºè´¦æˆ·</div>
        <div class="demo-account-info">é‚®ç®±ï¼šdemo@example.com<br>å¯†ç ï¼šdemo123</div>
      </div>
    </div>
  </div>
</div>
<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali active"><a href="#" data-platform="ae_self_operated">é€Ÿå–é€š</a>
        <ul class="dropdown" id="managedMenu">
          <li><a href="managed.html">å…¨æ‰˜ç®¡</a></li>
        </ul>
      </li>
      <li class="amazon"><a href="#" data-platform="amazon">äºšé©¬é€Š</a></li>
      <li class="tiktok"><a href="#" data-platform="tiktok">TikTok Shop</a></li>
      <li class="temu"><a href="#" data-platform="temu">Temu</a></li>
      <li class="ozon"><a href="#" data-platform="ozon">Ozon</a></li>
      <li class="independent"><a href="#" data-platform="independent">ç‹¬ç«‹ç«™</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout">
  <nav class="sidebar" id="sidebar">
    <div class="site-header">
      <span id="currentSite">è‡ªè¿è¥</span>
    </div>
    <ul class="sub-nav">
      <li><a href="#" class="active" data-target="detail">è¯¦ç»†æ•°æ®</a></li>
      <li><a href="#analysis" data-target="analysis">è¿è¥åˆ†æ</a></li>
      <li><a href="#products" data-target="products">äº§å“åˆ†æ</a></li>
    </ul>
  </nav>

  <main class="main mx-auto max-w-container px-6">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header" style="margin-bottom: 20px; text-align: center;">
      <h1 style="font-size: 28px; font-weight: 600; color: #1f2937; margin: 0;">è‡ªè¿è¥Robotç«™ - æ™ºèƒ½æ•°æ®åˆ†æä¸å†³ç­–æ”¯æŒ</h1>
    </div>
    
    <!-- é¡¶éƒ¨ï¼šä¸Šä¼  + å…¨å±€è¿‡æ»¤ -->
    <div class="upload-section">
      <div class="upload-top">
        <div class="controls">
          <label for="fileInput" class="upload-btn">é€‰æ‹©æ–‡ä»¶</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
          <span class="notice">ï¼ˆä¸Šä¼ â†’æœåŠ¡ç«¯å…¥åº“â†’å¯è§†åŒ–ä¸æ˜ç»†å±•ç¤ºï¼‰</span>
          <span id="progress" class="progress"></span>
        </div>
        <div class="controls">
          <span>ç²’åº¦ï¼š</span>
          <span class="sel" style="background:#1f2937;color:#fff;border-color:#334155;cursor:not-allowed">æŒ‰æ—¥</span>
          <input type="hidden" id="granularity" value="day">
          <span>æ—¥æœŸï¼š</span>
          <input id="dateFilter" class="date-filter" placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´">
          <div id="statusDisplay" class="status-display">æ•°æ®åŠ è½½å®Œæˆ</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="kpi-grid">
        <div class="kpi-card info">
          <h4>å¹³å‡è®¿å®¢æ¯”</h4>
          <p id="avgVisitor">0%</p>
          <div id="avgVisitorComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card success">
          <h4>å¹³å‡åŠ è´­æ¯”</h4>
          <p id="avgCart">0%</p>
          <div id="avgCartComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card success">
          <h4>å¹³å‡æ”¯ä»˜æ¯”</h4>
          <p id="avgPay">0%</p>
          <div id="avgPayComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card success">
          <h4>å•†å“æ€»æ•°</h4>
          <p id="totalProducts">0</p>
          <div id="totalProductsComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card warning">
          <h4>åŠ è´­å•†å“æ•°</h4>
          <p id="cartedProducts">0</p>
          <div id="cartedProductsComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card danger">
          <h4>æ”¯ä»˜å•†å“æ•°</h4>
          <p id="purchasedProducts">0</p>
          <div id="purchasedProductsComparison" class="kpi-comparison"></div>
        </div>
        <div class="kpi-card info" style="cursor: pointer;" title="ç‚¹å‡»ç­›é€‰æ–°å“æ•°æ®">
          <h4>æœ¬å‘¨æœŸæ–°å“æ•°</h4>
          <p id="newProducts">0</p>
          <div id="newProductsClear" class="kpi-clear" style="display: none;">
            <a href="#" id="clearNewProductsFilter" style="color: #007bff; text-decoration: underline; font-size: 12px;">æ¸…é™¤ç­›é€‰</a>
          </div>
        </div>
      </div>
    </div>

    <!-- é¡¶éƒ¨ Tabs -->
    <div class="content">
      <!-- æ˜ç»†è¡¨ -->
      <section id="detail" class="content-pad">
        <div class="chart-container">
          <h3>æ•°æ®æ˜ç»†</h3>
          
          <!-- åŠ è½½çŠ¶æ€ -->
          <div id="detailLoading" class="loading-state" style="display: none;">
            <div class="loading-spinner"></div>
            <p class="loading-text">åŠªåŠ›åŠ è½½ä¸­,è¯·ç­‰å¾…ç‰‡åˆ»ã€‚ã€‚ã€‚</p>
          </div>
          
          <!-- æ•°æ®è¡¨æ ¼ -->
          <div id="detailContent">
            <table id="report" class="data-table display nowrap" style="width:100%"></table>
          </div>
        </div>
      </section>

      <!-- è¿è¥åˆ†æ -->
      <section id="analysis" class="content-pad" style="display:none;">
        <div class="analysis-container">
          <h3>è¿è¥åˆ†æ</h3>
          
          <!-- è¿è¥åˆ†æKPIå¡ç‰‡ -->
          <div id="analysisKpi" class="analysis-kpi-grid">
            <div class="analysis-kpi-card">
              <h4>æ€»å±•ç¤ºæ•°</h4>
              <p id="totalExposure">0</p>
              <div id="exposureComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>è¯¦æƒ…é¡µè®¿å®¢æ•°</h4>
              <p id="totalVisitors">0</p>
              <div id="visitorsComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>åŠ è´­æ¬¡æ•°</h4>
              <p id="totalAddCount">0</p>
              <div id="addCountComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>è®¢è´­å•†å“æ•°</h4>
              <p id="totalPayItems">0</p>
              <div id="payItemsComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>æœ‰æ›å…‰å•†å“æ•°</h4>
              <p id="exposedProducts">0</p>
              <div id="exposedProductsComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>æœ‰åŠ è´­å•†å“æ•°</h4>
              <p id="cartedProducts">0</p>
              <div id="cartedProductsComparison" class="kpi-comparison"></div>
            </div>
            <div class="analysis-kpi-card">
              <h4>æœ‰æ”¯ä»˜å•†å“æ•°</h4>
              <p id="paidProducts">0</p>
              <div id="paidProductsComparison" class="kpi-comparison"></div>
            </div>
          </div>
          
          <!-- å¯¹æ¯”å›¾è¡¨ -->
          <div class="charts-grid">
            <div class="chart-panel">
              <h3>æ€»å±•ç¤ºæ•°å¯¹æ¯”</h3>
              <div id="exposureComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>è¯¦æƒ…é¡µè®¿å®¢æ•°å¯¹æ¯”</h3>
              <div id="visitorsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>åŠ è´­æ¬¡æ•°å¯¹æ¯”</h3>
              <div id="addCountComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>è®¢è´­å•†å“æ•°å¯¹æ¯”</h3>
              <div id="payItemsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>æœ‰æ›å…‰å•†å“æ•°å¯¹æ¯”</h3>
              <div id="exposedProductsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>æœ‰åŠ è´­å•†å“æ•°å¯¹æ¯”</h3>
              <div id="cartedProductsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h3>æœ‰æ”¯ä»˜å•†å“æ•°å¯¹æ¯”</h3>
              <div id="paidProductsComparisonChart" style="width:100%;height:300px;"></div>
            </div>
          </div>
        </div>
      </section>
             <!-- äº§å“åˆ†æ -->
       <section id="products" class="content-pad" style="display:none;">
         <div class="analysis-container">
           <h3>äº§å“è¯¦æƒ…åˆ†æ</h3>
           
           <!-- äº§å“åŸºæœ¬ä¿¡æ¯ -->
           <div class="product-info-panel">
             <div class="product-header">
               <div class="product-id">
                 <h4>äº§å“ID</h4>
                 <p id="currentProductId">--</p>
               </div>
               <div class="product-link">
                 <h4>äº§å“é“¾æ¥</h4>
                 <a id="productLink" href="#" target="_blank" class="product-link-btn">æŸ¥çœ‹äº§å“</a>
               </div>
               <div class="product-listing-date">
                 <h4>ä¸Šæ¶æ—¶é—´</h4>
                 <p id="productListingDate">2025-07-03</p>
               </div>
             </div>
           </div>
          
                                 <!-- äº§å“é€‰æ‹©å™¨å’Œæ—¶é—´æ§ä»¶ -->
            <div class="product-selector">
              <div class="controls">
                <label>äº§å“ï¼š</label>
                <select id="productSelect" class="sel">
                  <option value="">åŠ è½½ä¸­...</option>
                </select>
                <span class="notice">ï¼ˆæŒ‰æ›å…‰é‡æ’åºï¼‰</span>
                <div class="product-count-info">
                  <span>äº§å“æ€»æ•°ï¼š<strong id="productTotalCount">0</strong></span>
                </div>
              </div>
              <div class="time-controls">
                <label>æ—¶é—´å‘¨æœŸï¼š</label>
                <input id="productDateFilter" class="date-filter" placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´">
                <span class="notice">ï¼ˆé»˜è®¤æ˜¾ç¤ºæœ€è¿‘7å¤©ï¼‰</span>
              </div>
            </div>
           
                       <!-- äº§å“KPI - å•ä¸ªäº§å“çš„KPIæŒ‡æ ‡ -->
            <div id="productKpi" class="analysis-kpi-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div class="analysis-kpi-card">
                <h4>å¹³å‡è®¿å®¢æ¯”</h4>
                <p id="productAvgVisitor">0%</p>
                <div id="productAvgVisitorComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>å¹³å‡åŠ è´­æ¯”</h4>
                <p id="productAvgCart">0%</p>
                <div id="productAvgCartComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>å¹³å‡æ”¯ä»˜æ¯”</h4>
                <p id="productAvgPay">0%</p>
                <div id="productAvgPayComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>æ€»æ›å…‰é‡</h4>
                <p id="productTotalExposure">0</p>
                <div id="productTotalExposureComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>æ€»è®¿å®¢æ•°</h4>
                <p id="productTotalVisitors">0</p>
                <div id="productTotalVisitorsComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>æ€»åŠ è´­äººæ•°</h4>
                <p id="productTotalAddPeople">0</p>
                <div id="productTotalAddPeopleComparison" class="kpi-comparison"></div>
              </div>
              <div class="analysis-kpi-card">
                <h4>æ€»æ”¯ä»˜ä¹°å®¶æ•°</h4>
                <p id="productTotalPayBuyers">0</p>
                <div id="productTotalPayBuyersComparison" class="kpi-comparison"></div>
              </div>
            </div>
          
          <!-- äº§å“è¶‹åŠ¿å›¾è¡¨ -->
          <div id="productCharts" class="charts-grid" style="display:none;">
            <div class="chart-panel">
              <h3>æ›å…‰è¶‹åŠ¿</h3>
              <div id="productExposureChart" style="width:100%;height:260px;"></div>
            </div>
            <div class="chart-panel">
              <h3>è®¿å®¢æ¯”è¶‹åŠ¿</h3>
              <div id="productVisitorRateChart" style="width:100%;height:260px;"></div>
            </div>
            <div class="chart-panel">
              <h3>åŠ è´­æ¯”è¶‹åŠ¿</h3>
              <div id="productAddRateChart" style="width:100%;height:260px;"></div>
            </div>
            <div class="chart-panel">
              <h3>æ”¯ä»˜æ¯”è¶‹åŠ¿</h3>
              <div id="productPayRateChart" style="width:100%;height:260px;"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
/* ---------- UI åŸºç¡€ ---------- */
const toNum = v => { if (v===null||v===undefined) return 0; if (typeof v==='number') return isFinite(v)?v:0; const n=parseFloat(String(v).replace(/,/g,'').trim()); return isNaN(n)?0:n; };


// ç»Ÿä¸€ç‚¹å‡»ç‡æ˜¾ç¤ºï¼š<=1 è§†ä¸º 0~1 æ¯”ç‡ï¼Œå…ˆÃ—100å†åŠ ç™¾åˆ†å·ï¼›>1 è§†ä¸ºå·²æ˜¯ç™¾åˆ†æ•°
function formatCtr(v){
  if (v==null || v==='') return '';
  let n = Number(v);
  if (!isFinite(n)) return '';
  if (n <= 1) n *= 100;
  return n.toFixed(2) + '%';
}
/* ---------- é«˜å¯¹æ¯”æ ·å¼å¸¸é‡ï¼ˆç»™ ECharts ç”¨ï¼‰ ---------- */
const AXIS_LABEL = { color: '#E5E7EB', fontWeight: 700, fontSize: 12 };
const GRID_LINE  = 'rgba(148,163,184,0.18)';

/* ---------- ä¸Šä¼  Excel â†’ å…¥åº“ ---------- */
// NOTE: è¿™é‡Œå·²æ”¯æŒ 4 ä¸ªå­—æ®µï¼š
//  - æ”¯ä»˜å•†å“ä»¶æ•°ï¼ˆâ†’ pay_itemsï¼Œå…¼å®¹â€œæ”¯ä»˜ä»¶æ•°/ä»˜æ¬¾ä»¶æ•°/æˆäº¤ä»¶æ•°â€ï¼‰
//  - ä¸‹å•å•†å“ä»¶æ•°ï¼ˆâ†’ order_itemsï¼‰
//  - å¹³å‡åœç•™æ—¶é•¿ï¼ˆç§’ï¼‰ï¼ˆâ†’ avg_stay_secondsï¼‰
//  - æœç´¢ç‚¹å‡»ç‡ï¼ˆ% æ•°å€¼ï¼‰ï¼ˆâ†’ search_ctrï¼‰
$('#fileInput').on('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(evt) {
    try {
      $('#progress').text('è§£æä¸­â€¦');
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
      if (sheet.length < 2) throw new Error('è¡¨æ ¼æ— æœ‰æ•ˆæ•°æ®');
      const headers = sheet[0].map(h => String(h).trim());

      const findIdx = (re) => headers.findIndex(h => re.test(String(h).trim()));
      const idx = {
        product_id: findIdx(/^(å•†å“)?ID$|^å•†å“id$|^id$|^item id$|^item_id$/i),
        stat_date:  findIdx(/^(ç»Ÿè®¡æ—¶é—´|æ—¥æœŸ|æ•°æ®æ—¶é—´|date)$/i),
        exposure:   findIdx(/^(æœç´¢æ›å…‰é‡|æ›å…‰é‡|å•†å“æ›å…‰é‡|impressions)$/i),
        visitors:   (function(){ const rs=[/^(å•†å“)?è®¿å®¢æ•°$/i,/^è®¿å®¢äººæ•°$/i,/^è®¿å®¢é‡$/i,/^uv$/i,/^sessions$/i];
          for (const re of rs){const i = findIdx(re); if(i!==-1) return i;}
          const i2=headers.findIndex(h=>/è®¿å®¢æ•°|è®¿å®¢/i.test(String(h).trim())&&!/(è€|æ–°|å›|å¤)è®¿å®¢/i.test(String(h).trim()));
          return i2;
        })(),
        visitors_new: findIdx(/^(æ–°è®¿å®¢æ•°|æ–°è®¿å®¢|æ–°ç”¨æˆ·|æ–°å¢è®¿å®¢)$/i),
        visitors_old: findIdx(/^(è€è®¿å®¢æ•°|è€è®¿å®¢|å›è®¿å®¢|å¤è®¿å®¢)$/i),
        views:      findIdx(/^(å•†å“æµè§ˆé‡|æµè§ˆé‡|pv|page views)$/i),
        add_people: findIdx(/^(å•†å“åŠ è´­äººæ•°|åŠ è´­äººæ•°|åŠ è´­ä¹°å®¶æ•°)$/i),
        add_count:  findIdx(/^(å•†å“åŠ è´­ä»¶æ•°|åŠ è´­ä»¶æ•°)$/i),
        // âœ… æ”¯ä»˜å•†å“ä»¶æ•°ï¼šå…¼å®¹â€œæ”¯ä»˜ä»¶æ•°/ä»˜æ¬¾ä»¶æ•°/æˆäº¤ä»¶æ•°/æ”¯ä»˜å•†å“ä»¶æ•°â€
        pay_items:  (function(){ const rs=[/^æ”¯ä»˜å•†å“ä»¶æ•°$/i,/^æ”¯ä»˜ä»¶æ•°$/i,/^ä»˜æ¬¾ä»¶æ•°$/i,/^æˆäº¤ä»¶æ•°$/i]; for (const re of rs){const i=findIdx(re); if(i!==-1) return i;} return -1; })(),
        pay_orders: findIdx(/^(æ”¯ä»˜è®¢å•æ•°|ä¸‹å•äººæ•°|è®¢å•æ•°)$/i),
        pay_buyers: findIdx(/^(æ”¯ä»˜ä¹°å®¶æ•°|æ”¯ä»˜äººæ•°|æˆäº¤äººæ•°)$/i),
        fav_people: findIdx(/^(æ”¶è—äººæ•°|æ”¶è—ä¹°å®¶æ•°|æ”¶è—ç”¨æˆ·æ•°)$/i),
        fav_count:  findIdx(/^(æ”¶è—ä»¶æ•°|æ”¶è—é‡)$/i),
        // âœ… æ–°å¢ï¼šä¸‹å•å•†å“ä»¶æ•° / å¹³å‡åœç•™æ—¶é•¿ / æœç´¢ç‚¹å‡»ç‡
        order_items: findIdx(/^(ä¸‹å•å•†å“ä»¶æ•°|ä¸‹å•ä»¶æ•°|ä¸‹å•å•†å“æ•°|ä¸‹å•å•†å“æ•°é‡)$/i),
        avg_stay_seconds: findIdx(/^(å¹³å‡åœç•™æ—¶é•¿(\(ç§’\))?|å¹³å‡åœç•™æ—¶é—´|å¹³å‡è®¿é—®æ—¶é•¿)$/i),
        search_ctr: findIdx(/^(æœç´¢ç‚¹å‡»ç‡(\(%\))?|ç‚¹å‡»ç‡(\(%\))?|æœç´¢ç‚¹å‡»ç‡|ç‚¹å‡»ç‡)$/i),
      };
      if (idx.product_id<0 || idx.stat_date<0) throw new Error('ç¼ºå°‘å¿…å¡«ï¼šå•†å“ID / ç»Ÿè®¡æ—¶é—´');

      function excelDateToISO(n){ if(typeof n!=='number') return null; const utc_days=Math.floor(n-25569); const utc_value=utc_days*86400; const date_info=new Date(utc_value*1000); const y=date_info.getUTCFullYear(); const m=(date_info.getUTCMonth()+1).toString().padStart(2,'0'); const d=date_info.getUTCDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; }
      function parseDateToISO(v){ if(v===null||v===undefined||v==='') return null; if(typeof v==='number') return excelDateToISO(v); let s=String(v).trim(); s=s.replace(/[.]/g,'-').replace(/\//g,'-'); const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`; const m2=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/); if(m2) return `${m2[3]}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`; return s.slice(0,10); }

      const rows = sheet.slice(1).filter(r => r && r.length).map(r => {
        const pid = String(r[idx.product_id]).trim();
        const sd  = parseDateToISO(r[idx.stat_date]);
        const visitors = (idx.visitors !== -1 ? toNum(r[idx.visitors])
                        : ((idx.visitors_new !== -1 ? toNum(r[idx.visitors_new]) : 0)
                        + (idx.visitors_old !== -1 ? toNum(r[idx.visitors_old]) : 0)));
        // å°†â€œ12.3%â€å‹ç‚¹å‡»ç‡è½¬æˆ 12.3
        const pct = (x) => { const n = String(x ?? '').trim(); if (!n) return 0; return toNum(n.replace('%','')); };
        const row = {
          product_id: pid, stat_date: sd,
          exposure:  idx.exposure  === -1 ? 0 : toNum(r[idx.exposure]),
          visitors,
          views:     idx.views     === -1 ? 0 : toNum(r[idx.views]),
          add_people:idx.add_people=== -1 ? 0 : toNum(r[idx.add_people]),
          add_count: idx.add_count === -1 ? 0 : toNum(r[idx.add_count]),
          pay_items: idx.pay_items === -1 ? 0 : toNum(r[idx.pay_items]),
          pay_orders:idx.pay_orders=== -1 ? 0 : toNum(r[idx.pay_orders]),
          pay_buyers:idx.pay_buyers=== -1 ? 0 : toNum(r[idx.pay_buyers]),
          // æ–°å¢å­—æ®µ
          order_items: idx.order_items === -1 ? 0 : toNum(r[idx.order_items]),
          avg_stay_seconds: idx.avg_stay_seconds === -1 ? 0 : toNum(r[idx.avg_stay_seconds]),
          search_ctr: idx.search_ctr === -1 ? 0 : pct(r[idx.search_ctr]),
        };
        if (idx.fav_people !== -1) row.fav_people = toNum(r[idx.fav_people]);
        if (idx.fav_count  !== -1) row.fav_count  = toNum(r[idx.fav_count]);
        return row;
      }).filter(x => x.product_id && x.stat_date);
      const dmap=new Map(); rows.forEach(r=>dmap.set(r.product_id+'__'+r.stat_date,r)); const deduped=Array.from(dmap.values());

      $('#progress').text(`å…¥åº“ä¸­ï¼ˆ${deduped.length} æ¡ï¼‰â€¦`);
      const resp = await fetch('/api/ae_upsert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rows: deduped }) });
      const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Upsert APIå“åº”ä¸æ˜¯JSONï¼š' + txt.slice(0,200)); }
      if (!resp.ok || !j.ok) throw new Error(j.error || 'å…¥åº“å¤±è´¥');
      $('#progress').text('å…¥åº“å®Œæˆ âœ”'); $('#refreshBtn').click();
    } catch(err) {
      console.error(err); alert('å¤„ç†å¤±è´¥ï¼š' + (err.message || err)); $('#progress').text('');
    }
  };
  reader.readAsArrayBuffer(file);
});

/* ---------- æŸ¥è¯¢ / æ±‡æ€» ---------- */
// è¿™äº›å‡½æ•°å·²è¢«æ–°çš„é¡µé¢æ¨¡æ¿ç³»ç»Ÿæ›¿ä»£ï¼Œä¿ç•™æ³¨é‡Šä»¥è¯´æ˜åŠŸèƒ½
// æ–°çš„ç³»ç»Ÿåœ¨ self-operated.js ä¸­å®ç°
/* ---------- åˆå§‹åŒ– ---------- */
// è¿™äº›åˆå§‹åŒ–ä»£ç å·²è¢«æ–°çš„é¡µé¢æ¨¡æ¿ç³»ç»Ÿæ›¿ä»£
// æ–°çš„ç³»ç»Ÿåœ¨ self-operated.js ä¸­å®ç°
</script>

<!-- ====== New Products KPI (Self) ====== -->
<script>
(function(){
  let removeNewFilter = null;
  let lastData = null;

  function getDT(){
    if (!window.jQuery || !jQuery.fn || !jQuery.fn.dataTable) return null;
    try { return window.dataTable || jQuery('#report').DataTable(); } catch(e){ return null; }
  }
  async function fetchRange(fromISO, toISO){
    const qs = new URLSearchParams({ platform:'self' });
    if (fromISO) qs.set('from', fromISO);
    if (toISO) qs.set('to', toISO);
    const r = await fetch('/api/new-products?'+qs.toString());
    const j = await r.json();
    if (!j.ok) throw new Error(j.msg||'fetch error');
    return j;
  }
  function parseDateRange(){
    const input = document.getElementById('dateFilter');
    if (input && input.value && input.value.includes(' to ')){
      const [s, e] = input.value.split(' to ');
      return { from:s, to:e };
    }
    const today = new Date();
    const to = today.toISOString().slice(0,10);
    // å¦‚æœä»Šå¤©æ˜¯2024å¹´æˆ–æ›´æ—©ï¼Œä½¿ç”¨2025-07-01ä½œä¸ºå¼€å§‹æ—¥æœŸ
const from = today.getFullYear() < 2025 ? '2025-07-01' : new Date(today.getTime()-30*86400000).toISOString().slice(0,10);
    return { from, to };
  }
  function ensureCard(){
    let wrap = document.querySelector('.kpi') || document.getElementById('kpi');
    if (!wrap){
      const table = document.querySelector('#report');
      const host = document.createElement('div');
      host.className = 'kpi-row';
      if (table && table.parentNode) table.parentNode.insertBefore(host, table);
      else document.body.insertBefore(host, document.body.firstChild);
      wrap = host;
    }
    let card = document.getElementById('kpi-new-self-card');
    if (!card){
      const div = document.createElement('div');
      div.className = 'card clickable stat-card';
      div.id = 'kpi-new-self-card';
      div.innerHTML = '<h4>æœ¬å‘¨æœŸæ–°å“æ•°</h4><p id="kpi-new-self-count">--</p><a id="kpi-new-self-clear" class="mini-link">æ¸…é™¤ç­›é€‰</a>';
      wrap.appendChild(div);
      card = div;
    }
    const old = document.getElementById('kpi-new-self-ctrl');
    if (old && old.parentNode) old.parentNode.removeChild(old);
    return {
      card,
      countEl: document.getElementById('kpi-new-self-count'),
      clearEl: document.getElementById('kpi-new-self-clear'),
    };
  }
  function applyFilterByIds(ids){
    const dt = getDT();
    if (removeNewFilter){ removeNewFilter(); removeNewFilter = null; }

    if (dt && jQuery.fn.dataTable.ext){
      const ext = jQuery.fn.dataTable.ext;
      const filterFn = (settings, data, dataIndex) => {
        let pid = (data[0]||'').toString().trim();
        if (!pid || /<a/i.test(pid)) {
          const rowNode = dt.row(dataIndex).node();
          const cell = rowNode && rowNode.querySelector('td:first-child');
          if (cell) pid = (cell.textContent||'').trim();
        }
        const m = pid.match(/(\d{6,})/g);
        if (m && m.length) pid = m[m.length-1];
        return ids.has(pid);
      };
      ext.search.push(filterFn);
      dt.draw();
      removeNewFilter = () => {
        const pos = ext.search.findIndex(f => f === filterFn);
        if (pos > -1) ext.search.splice(pos, 1);
        dt.draw();
      };
    } else {
      const table = document.querySelector('#report');
      if (!table || !table.tBodies[0]) return;
      const rows = Array.from(table.tBodies[0].rows);
      const original = new Map();
      rows.forEach(tr => {
        const td = tr.cells[0];
        let pid = td ? td.textContent.trim() : '';
        const m = pid.match(/(\d{6,})/g);
        if (m && m.length) pid = m[m.length-1];
        if (!original.has(tr)) original.set(tr, tr.style.display);
        tr.style.display = ids.has(pid) ? '' : 'none';
      });
      removeNewFilter = () => { for (const [tr, disp] of original) tr.style.display = disp; };
    }
  }
  async function refreshFromPageRange(){
    const ui = ensureCard();
    const { from, to } = parseDateRange();
    try{
      lastData = await fetchRange(from, to);
      ui.countEl.textContent = lastData.new_count || 0;
      ui.card.onclick = () => {
        if (!lastData.items || !lastData.items.length) return;
        const ids = new Set(lastData.items.map(x => String(x.product_id)));
        applyFilterByIds(ids);
        ui.clearEl.style.display = 'inline';
      };
      ui.clearEl.onclick = (e) => {
        e.stopPropagation();
        if (removeNewFilter) removeNewFilter();
        ui.clearEl.style.display = 'none';
      };
    }catch(e){
      console.warn('[Self KPI] fetch failed:', e);
    }
  }

  // ç§»é™¤æ—§çš„MutationObserverå’Œäº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤è§¦å‘æ•°æ®åŠ è½½
  // ç°åœ¨ç”±æ–°çš„é¡µé¢æ¨¡æ¿ç³»ç»Ÿç»Ÿä¸€ç®¡ç†æ•°æ®åŠ è½½
  console.log('è‡ªè¿è¥é¡µé¢ï¼šæ—§çš„MutationObserverå·²ç§»é™¤ï¼Œé¿å…é‡å¤æ•°æ®åŠ è½½');
})();
</script>
<script src="assets/login.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  // ä½¿ç”¨ site-nav.js çš„ç«™ç‚¹ç®¡ç†é€»è¾‘
  const currentSiteEl = document.getElementById('currentSite');
  // åˆå§‹åŒ–ç«™ç‚¹æ˜¾ç¤º
  function updateCurrentSiteDisplay() {
    if (currentSiteEl) {
      // ä» localStorage è·å–å½“å‰ç«™ç‚¹ä¿¡æ¯
      const currentSiteId = localStorage.getItem('currentSite') || 'ae_self_operated_a';
      const currentSiteName = localStorage.getItem('currentSiteName') || 'è‡ªè¿è¥robotç«™';
      
      // æ›´æ–°æ˜¾ç¤º
      currentSiteEl.textContent = currentSiteName;
      
      // ç¡®ä¿ localStorage ä¸­æœ‰æ­£ç¡®çš„å€¼
      if (!localStorage.getItem('currentSite')) {
        localStorage.setItem('currentSite', currentSiteId);
      }
      if (!localStorage.getItem('currentSiteName')) {
        localStorage.setItem('currentSiteName', currentSiteName);
      }
      
      console.log('è‡ªè¿è¥é¡µé¢ç«™ç‚¹æ˜¾ç¤ºæ›´æ–°:', { currentSiteId, currentSiteName });
    }
  }


      // åˆå§‹åŒ–ç«™ç‚¹æ˜¾ç¤º
    updateCurrentSiteDisplay();
    
    // åˆå§‹åŒ–ä¸»é¡µé¢æ—¶é—´æ§ä»¶
    initializeMainDateFilter();
    
    // ç›‘å¬ localStorage å˜åŒ–
    window.addEventListener('storage', (e) => {
      if (e.key === 'currentSite' || e.key === 'currentSiteName') {
        updateCurrentSiteDisplay();
      }
    });
  
  // å¹³å°åˆ‡æ¢å¤„ç† - é€šç”¨æœºåˆ¶
  function handlePlatformSwitch(platform) {
    console.log('å¹³å°åˆ‡æ¢:', platform);
    
    // æ ¹æ®å¹³å°è®¾ç½®ç›¸åº”çš„ç«™ç‚¹å’Œå‚æ•°
    switch(platform) {
      case 'ae_self_operated':
        // ä¿æŒå½“å‰è‡ªè¿è¥ç«™ç‚¹
        break;
      case 'independent':
        // åˆ‡æ¢åˆ°ç‹¬ç«‹ç«™
        window.location.href = 'independent-site.html';
        return;
      case 'managed':
        // åˆ‡æ¢åˆ°å…¨æ‰˜ç®¡
        window.location.href = 'managed.html';
        return;
      case 'amazon':
        // åˆ‡æ¢åˆ°äºšé©¬é€Š
        window.location.href = 'amazon-overview.html';
        return;
      case 'tiktok':
        // åˆ‡æ¢åˆ°TikTok Shop
        window.location.href = 'tiktok.html';
        return;
      case 'temu':
        // åˆ‡æ¢åˆ°Temu
        window.location.href = 'temu.html';
        return;
      case 'ozon':
        // åˆ‡æ¢åˆ°Ozon
        window.location.href = 'ozon-detail.html';
        return;
      default:
        // å…¶ä»–å¹³å°æš‚æ—¶è·³è½¬åˆ°ç›¸åº”é¡µé¢æˆ–æ˜¾ç¤ºæç¤º
        console.log('å¹³å°', platform, 'æš‚æœªå®ç°');
        return;
    }
    
    // å¦‚æœæ˜¯è‡ªè¿è¥å¹³å°ï¼Œé‡æ–°åŠ è½½æ•°æ®
    if (platform === 'ae_self_operated') {
      // é‡æ–°åŠ è½½æ•°æ®
      if (typeof fetchAndRenderAll === 'function') {
        fetchAndRenderAll();
      }
    }
  }
  
  // å°†å¹³å°åˆ‡æ¢å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä¾› site-nav.js è°ƒç”¨
  window.handlePlatformSwitch = handlePlatformSwitch;
  
  // è¿è¥åˆ†ææ•°æ®åŠ è½½
  async function loadAnalysisData() {
    try {
      const dateRange = getDateRange();
      const currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
      
      console.log('å¼€å§‹åŠ è½½è¿è¥åˆ†ææ•°æ®:', { dateRange, currentSite });
      
      // æ„å»ºæŸ¥è¯¢å‚æ•° - ä½¿ç”¨GETè¯·æ±‚è€Œä¸æ˜¯POST
      const queryParams = new URLSearchParams({
        start: dateRange.start,
        end: dateRange.end,
        granularity: 'day',
        site: currentSite,
        aggregate: 'time'  // ä½¿ç”¨'time'è€Œä¸æ˜¯true
      });
      
      // è·å–å½“å‰å‘¨æœŸæ•°æ® - ä½¿ç”¨GETè¯·æ±‚
      const currentResponse = await fetch(`/api/ae_query?${queryParams.toString()}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (!currentResponse.ok) {
        throw new Error(`APIå“åº”é”™è¯¯: ${currentResponse.status} ${currentResponse.statusText}`);
      }
      
      const currentData = await currentResponse.json();
      console.log('è¿è¥åˆ†ææ•°æ®å“åº”:', currentData);
      
      if (currentData.ok && currentData.rows) {  // æ³¨æ„ï¼šAPIè¿”å›çš„æ˜¯rowsè€Œä¸æ˜¯data
        // æ›´æ–°KPIå¡ç‰‡
        updateAnalysisKPI(currentData.rows);
        // æ¸²æŸ“å›¾è¡¨
        renderAnalysisCharts(currentData.rows);
      } else {
        console.warn('è¿è¥åˆ†ææ•°æ®æ ¼å¼ä¸æ­£ç¡®:', currentData);
        showAnalysisError('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥APIå“åº”');
      }
    } catch (error) {
      console.error('åŠ è½½è¿è¥åˆ†ææ•°æ®å¤±è´¥:', error);
      showAnalysisError(`åŠ è½½è¿è¥åˆ†ææ•°æ®å¤±è´¥: ${error.message}`);
    }
  }
  
  // æ˜¾ç¤ºè¿è¥åˆ†æé”™è¯¯ä¿¡æ¯
  function showAnalysisError(message) {
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = 'color: #ef4444; text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px; margin: 20px 0; border: 1px solid #fecaca;';
    errorMsg.textContent = message;
    
    const analysisSection = document.getElementById('analysis');
    if (analysisSection) {
      const existingError = analysisSection.querySelector('.error-message');
      if (existingError) existingError.remove();
      errorMsg.className = 'error-message';
      analysisSection.insertBefore(errorMsg, analysisSection.firstChild);
    }
  }
  
  // æ˜¾ç¤ºäº§å“åˆ†æé”™è¯¯ä¿¡æ¯
  function showProductAnalysisError(message) {
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = 'color: #ef4444; text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px; margin: 20px 0; border: 1px solid #fecaca;';
    errorMsg.textContent = message;
    
    const productsSection = document.getElementById('products');
    if (productsSection) {
      const existingError = productsSection.querySelector('.error-message');
      if (existingError) existingError.remove();
      errorMsg.className = 'error-message';
      productsSection.insertBefore(errorMsg, productsSection.firstChild);
    }
  }
  
  // æ˜¾ç¤ºäº§å“æ•°æ®é”™è¯¯ä¿¡æ¯
  function showProductDataError(message) {
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = 'color: #ef4444; text-align: center; padding: 20px; background: #fef2f2; border-radius: 8px; margin: 20px 0; border: 1px solid #fecaca;';
    errorMsg.textContent = message;
    
    const productsSection = document.getElementById('products');
    if (productsSection) {
      const existingError = productsSection.querySelector('.error-message');
      if (existingError) existingError.remove();
      errorMsg.className = 'error-message';
      productsSection.insertBefore(errorMsg, productsSection.firstChild);
    }
  }
  
           // äº§å“åˆ†ææ•°æ®åŠ è½½ - åŠ è½½äº§å“åˆ—è¡¨å¹¶æŒ‰æ›å…‰é‡æ’åº
    async function loadProductAnalysisData() {
      try {
        const dateRange = getProductDateRange();
        const currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
        
        console.log('å¼€å§‹åŠ è½½äº§å“åˆ†ææ•°æ®:', { dateRange, currentSite });
        
        // åˆå§‹åŒ–äº§å“é¡µé¢çš„æ—¶é—´æ§ä»¶
        initializeProductDateFilter();
        
        // æ„å»ºæŸ¥è¯¢å‚æ•° - ä½¿ç”¨GETè¯·æ±‚è€Œä¸æ˜¯POST
        const queryParams = new URLSearchParams({
          start: dateRange.start,
          end: dateRange.end,
          granularity: 'day',
          site: currentSite,
          aggregate: 'product'  // ä½¿ç”¨'product'è·å–äº§å“çº§åˆ«çš„æ•°æ®
        });
        
        // è·å–äº§å“åˆ—è¡¨ - ä½¿ç”¨GETè¯·æ±‚
        const productsResponse = await fetch(`/api/ae_query?${queryParams.toString()}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!productsResponse.ok) {
          throw new Error(`APIå“åº”é”™è¯¯: ${productsResponse.status} ${productsResponse.statusText}`);
        }
        
        const productsData = await productsResponse.json();
        console.log('äº§å“åˆ—è¡¨æ•°æ®å“åº”:', productsData);
        
        if (productsData.ok && productsData.rows) {
          // æŒ‰æ›å…‰é‡æ’åºäº§å“
          const sortedProducts = productsData.rows.sort((a, b) => (b.exposure || 0) - (a.exposure || 0));
          
          // æ›´æ–°äº§å“æ€»æ•°
          document.getElementById('productTotalCount').textContent = sortedProducts.length;
          
          // å¡«å……äº§å“é€‰æ‹©å™¨
          populateProductSelect(sortedProducts);
          
          // é»˜è®¤é€‰æ‹©æ›å…‰é‡æœ€å¤§çš„äº§å“
          if (sortedProducts.length > 0) {
            const topProduct = sortedProducts[0];
            console.log('é»˜è®¤é€‰æ‹©æ›å…‰é‡æœ€å¤§çš„äº§å“:', topProduct.product_id);
            document.getElementById('productSelect').value = topProduct.product_id;
            await loadProductData(topProduct.product_id);
          }
        } else {
          console.warn('äº§å“åˆ—è¡¨æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', productsData);
          showProductAnalysisError('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥APIå“åº”');
        }
      } catch (error) {
        console.error('åŠ è½½äº§å“åˆ†ææ•°æ®å¤±è´¥:', error);
        showProductAnalysisError(`åŠ è½½äº§å“åˆ†ææ•°æ®å¤±è´¥: ${error.message}`);
      }
    }
    
    // åˆå§‹åŒ–äº§å“é¡µé¢çš„æ—¶é—´æ§ä»¶
    function initializeProductDateFilter() {
      const productDateFilter = document.getElementById('productDateFilter');
      if (!productDateFilter) return;
      
      // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ€è¿‘7å¤©ï¼‰
      const today = new Date();
      const end = today.toISOString().slice(0, 10);
      const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
      
      // ä½¿ç”¨flatpickråˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
      if (window.flatpickr) {
        const picker = flatpickr(productDateFilter, {
          mode: 'range',
          dateFormat: 'Y-m-d',
          defaultDate: [start, end],
          onChange: function(selectedDates, dateStr) {
            if (selectedDates.length === 2) {
              console.log('äº§å“åˆ†ææ—¶é—´èŒƒå›´å˜æ›´:', dateStr);
              // åŒæ­¥ä¸»é¡µé¢æ—¶é—´æ§ä»¶
              const mainDateFilter = document.getElementById('dateFilter');
              if (mainDateFilter) {
                mainDateFilter.value = dateStr;
                // è§¦å‘ä¸»é¡µé¢æ—¶é—´å˜æ›´äº‹ä»¶
                const event = new Event('change', { bubbles: true });
                mainDateFilter.dispatchEvent(event);
              }
              // é‡æ–°åŠ è½½äº§å“æ•°æ®
              const currentProductId = document.getElementById('productSelect').value;
              if (currentProductId) {
                loadProductData(currentProductId);
              }
            }
          }
        });
        
        // è®¾ç½®åˆå§‹å€¼
        productDateFilter.value = `${start} to ${end}`;
      }
    }
  
  // åˆå§‹åŒ–ä¸»é¡µé¢æ—¶é—´æ§ä»¶
  function initializeMainDateFilter() {
    const mainDateFilter = document.getElementById('dateFilter');
    if (!mainDateFilter) return;
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ€è¿‘7å¤©ï¼‰
    const today = new Date();
    const end = today.toISOString().slice(0, 10);
    const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
    
    // ä½¿ç”¨flatpickråˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
    if (window.flatpickr) {
      const picker = flatpickr(mainDateFilter, {
        mode: 'range',
        dateFormat: 'Y-m-d',
        defaultDate: [start, end],
        onChange: function(selectedDates, dateStr) {
          if (selectedDates.length === 2) {
            console.log('ä¸»é¡µé¢æ—¶é—´èŒƒå›´å˜æ›´:', dateStr);
            // åŒæ­¥äº§å“åˆ†æé¡µé¢æ—¶é—´æ§ä»¶
            const productDateFilter = document.getElementById('productDateFilter');
            if (productDateFilter) {
              productDateFilter.value = dateStr;
            }
            // é‡æ–°åŠ è½½æ•°æ®
            if (typeof fetchAndRenderAll === 'function') {
              fetchAndRenderAll();
            }
          }
        }
      });
      
      // è®¾ç½®åˆå§‹å€¼
      mainDateFilter.value = `${start} to ${end}`;
    }
  }
  
  // è·å–æ—¥æœŸèŒƒå›´
  function getDateRange() {
    const input = document.getElementById('dateFilter');
    if (input && input.value && input.value.includes(' to ')) {
      const [start, end] = input.value.split(' to ');
      return { start, end };
    }
    const today = new Date();
    const end = today.toISOString().slice(0, 10);
    const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
    return { start, end };
  }
  
  // æ›´æ–°è¿è¥åˆ†æKPI
  function updateAnalysisKPI(data) {
    console.log('æ›´æ–°è¿è¥åˆ†æKPIï¼Œæ•°æ®:', data);
    
    // è®¡ç®—æ–°çš„KPIæŒ‡æ ‡
    const totalExposure = data.reduce((sum, item) => sum + (item.exposure || 0), 0);
    const totalVisitors = data.reduce((sum, item) => sum + (item.visitors || 0), 0);
    const totalAddCount = data.reduce((sum, item) => sum + (item.add_count || 0), 0);
    const totalPayItems = data.reduce((sum, item) => sum + (item.pay_items || 0), 0);
    
    // è®¡ç®—å•†å“æ•°é‡ï¼ˆå»é‡ï¼‰
    const exposedProducts = new Set(data.filter(item => item.exposure > 0).map(item => item.product_id)).size;
    const cartedProducts = new Set(data.filter(item => item.add_count > 0).map(item => item.product_id)).size;
    const paidProducts = new Set(data.filter(item => item.pay_items > 0).map(item => item.product_id)).size;
    
    console.log('KPIè®¡ç®—ç»“æœ:', {
      totalExposure,
      totalVisitors, 
      totalAddCount,
      totalPayItems,
      exposedProducts,
      cartedProducts,
      paidProducts
    });
    
    // æ›´æ–°KPIæ˜¾ç¤º
    document.getElementById('totalExposure').textContent = totalExposure.toLocaleString();
    document.getElementById('totalVisitors').textContent = totalVisitors.toLocaleString();
    document.getElementById('totalAddCount').textContent = totalAddCount.toLocaleString();
    document.getElementById('totalPayItems').textContent = totalPayItems.toLocaleString();
    document.getElementById('exposedProducts').textContent = exposedProducts.toLocaleString();
    document.getElementById('cartedProducts').textContent = cartedProducts.toLocaleString();
    document.getElementById('paidProducts').textContent = paidProducts.toLocaleString();
  }
  
  // æ¸²æŸ“è¿è¥åˆ†æå¯¹æ¯”å›¾è¡¨
  async function renderAnalysisCharts(data) {
    console.log('æ¸²æŸ“è¿è¥åˆ†æå¯¹æ¯”å›¾è¡¨ï¼Œæ•°æ®:', data);
    
    // è·å–ä¸Šä¸€å‘¨æœŸæ•°æ®è¿›è¡Œå¯¹æ¯”
    const previousData = await getPreviousPeriodData();
    
    // è®¡ç®—å½“å‰å‘¨æœŸæ•°æ®
    const currentData = {
      exposure: data.reduce((sum, item) => sum + (item.exposure || 0), 0),
      visitors: data.reduce((sum, item) => sum + (item.visitors || 0), 0),
      addCount: data.reduce((sum, item) => sum + (item.add_count || 0), 0),
      payItems: data.reduce((sum, item) => sum + (item.pay_items || 0), 0),
      exposedProducts: new Set(data.filter(item => item.exposure > 0).map(item => item.product_id)).size,
      cartedProducts: new Set(data.filter(item => item.add_count > 0).map(item => item.product_id)).size,
      paidProducts: new Set(data.filter(item => item.pay_items > 0).map(item => item.product_id)).size
    };
    
    // è®¡ç®—ä¸Šä¸€å‘¨æœŸæ•°æ®
    const previousDataCalculated = previousData ? {
      exposure: previousData.reduce((sum, item) => sum + (item.exposure || 0), 0),
      visitors: previousData.reduce((sum, item) => sum + (item.visitors || 0), 0),
      addCount: previousData.reduce((sum, item) => sum + (item.add_count || 0), 0),
      payItems: previousData.reduce((sum, item) => sum + (item.pay_items || 0), 0),
      exposedProducts: new Set(previousData.filter(item => item.exposure > 0).map(item => item.product_id)).size,
      cartedProducts: new Set(previousData.filter(item => item.add_count > 0).map(item => item.product_id)).size,
      paidProducts: new Set(previousData.filter(item => item.pay_items > 0).map(item => item.product_id)).size
    } : null;
    
    // æ¸²æŸ“æ€»å±•ç¤ºæ•°å¯¹æ¯”å›¾
    renderComparisonChart('exposureComparisonChart', 'æ€»å±•ç¤ºæ•°å¯¹æ¯”', 
      currentData.exposure, previousDataCalculated?.exposure || 0, 'æ€»å±•ç¤ºæ•°');
    
    // æ¸²æŸ“è¯¦æƒ…é¡µè®¿å®¢æ•°å¯¹æ¯”å›¾
    renderComparisonChart('visitorsComparisonChart', 'è¯¦æƒ…é¡µè®¿å®¢æ•°å¯¹æ¯”', 
      currentData.visitors, previousDataCalculated?.visitors || 0, 'è¯¦æƒ…é¡µè®¿å®¢æ•°');
    
    // æ¸²æŸ“åŠ è´­æ¬¡æ•°å¯¹æ¯”å›¾
    renderComparisonChart('addCountComparisonChart', 'åŠ è´­æ¬¡æ•°å¯¹æ¯”', 
      currentData.addCount, previousDataCalculated?.addCount || 0, 'åŠ è´­æ¬¡æ•°');
    
    // æ¸²æŸ“è®¢è´­å•†å“æ•°å¯¹æ¯”å›¾
    renderComparisonChart('payItemsComparisonChart', 'è®¢è´­å•†å“æ•°å¯¹æ¯”', 
      currentData.payItems, previousDataCalculated?.payItems || 0, 'è®¢è´­å•†å“æ•°');
    
    // æ¸²æŸ“æœ‰æ›å…‰å•†å“æ•°å¯¹æ¯”å›¾
    renderComparisonChart('exposedProductsComparisonChart', 'æœ‰æ›å…‰å•†å“æ•°å¯¹æ¯”', 
      currentData.exposedProducts, previousDataCalculated?.exposedProducts || 0, 'æœ‰æ›å…‰å•†å“æ•°');
    
    // æ¸²æŸ“æœ‰åŠ è´­å•†å“æ•°å¯¹æ¯”å›¾
    renderComparisonChart('cartedProductsComparisonChart', 'æœ‰åŠ è´­å•†å“æ•°å¯¹æ¯”', 
      currentData.cartedProducts, previousDataCalculated?.cartedProducts || 0, 'æœ‰åŠ è´­å•†å“æ•°');
    
    // æ¸²æŸ“æœ‰æ”¯ä»˜å•†å“æ•°å¯¹æ¯”å›¾
    renderComparisonChart('paidProductsComparisonChart', 'æœ‰æ”¯ä»˜å•†å“æ•°å¯¹æ¯”', 
      currentData.paidProducts, previousDataCalculated?.paidProducts || 0, 'æœ‰æ”¯ä»˜å•†å“æ•°');
  }
  
  // æ¸²æŸ“å¯¹æ¯”æŸ±çŠ¶å›¾
  function renderComparisonChart(chartId, title, currentValue, previousValue, label) {
    const chart = echarts.init(document.getElementById(chartId));
    const option = {
      title: { 
        text: title, 
        textStyle: { color: '#374151', fontSize: 16 },
        subtext: `${label}: ${currentValue.toLocaleString()}`,
        subtextStyle: { color: '#6b7280', fontSize: 14 }
      },
      tooltip: { 
        trigger: 'axis',
        formatter: function(params) {
          const data = params[0];
          return `${data.name}<br/>${data.seriesName}: ${data.value.toLocaleString()}`;
        }
      },
      legend: {
        data: ['å½“å‰å‘¨æœŸ', 'ä¸Šä¸€å‘¨æœŸ'],
        textStyle: { color: '#374151' }
      },
      xAxis: { 
        type: 'category', 
        data: ['å½“å‰å‘¨æœŸ', 'ä¸Šä¸€å‘¨æœŸ'],
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      series: [
        {
          name: 'å½“å‰å‘¨æœŸ',
          data: [currentValue, 0],
          type: 'bar',
          itemStyle: { color: '#3B82F6' },
          barWidth: '40%'
        },
        {
          name: 'ä¸Šä¸€å‘¨æœŸ',
          data: [0, previousValue],
          type: 'bar',
          itemStyle: { color: '#10B981' },
          barWidth: '40%'
        }
      ]
    };
    chart.setOption(option);
  }
  
     // å¡«å……äº§å“é€‰æ‹©å™¨
   function populateProductSelect(data) {
     const productSelect = document.getElementById('productSelect');
     if (!productSelect) return;
     
     console.log('å¡«å……äº§å“é€‰æ‹©å™¨ï¼Œæ•°æ®:', data);
     
     // æ¸…ç©ºç°æœ‰é€‰é¡¹
     productSelect.innerHTML = '<option value="">é€‰æ‹©äº§å“</option>';
     
     // æŒ‰æ›å…‰é‡æ’åºæ˜¾ç¤ºäº§å“ï¼ˆdataå·²ç»æ˜¯æ’åºåçš„ï¼‰
     data.forEach(item => {
       const option = document.createElement('option');
       option.value = item.product_id;
       const exposure = item.exposure || 0;
       option.textContent = `${item.product_id} (æ›å…‰: ${exposure.toLocaleString()})`;
       productSelect.appendChild(option);
     });
     
     // æ·»åŠ äº§å“é€‰æ‹©äº‹ä»¶
     productSelect.addEventListener('change', function() {
       const selectedProductId = this.value;
       if (selectedProductId) {
         console.log('é€‰æ‹©äº§å“:', selectedProductId);
         loadProductData(selectedProductId);
       }
     });
   }
  
           // åŠ è½½ç‰¹å®šäº§å“æ•°æ®
    async function loadProductData(productId) {
      try {
        const dateRange = getProductDateRange();
        const currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
        
        console.log('å¼€å§‹åŠ è½½äº§å“æ•°æ®:', { productId, dateRange, currentSite });
        
        // æ›´æ–°äº§å“åŸºæœ¬ä¿¡æ¯
        document.getElementById('currentProductId').textContent = productId;
        document.getElementById('productLink').href = `https://aliexpress.com/item/${productId}.html`;
        
        // æ„å»ºæŸ¥è¯¢å‚æ•° - ä½¿ç”¨GETè¯·æ±‚è€Œä¸æ˜¯POST
        const queryParams = new URLSearchParams({
          start: dateRange.start,
          end: dateRange.end,
          granularity: 'day',
          site: currentSite,
          aggregate: 'time'  // ä½¿ç”¨'time'è·å–æ—¶é—´åºåˆ—æ•°æ®
        });
        
        const response = await fetch(`/api/ae_query?${queryParams.toString()}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
          throw new Error(`APIå“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('äº§å“æ•°æ®å“åº”:', data);
        
        if (data.ok && data.rows) {  // æ³¨æ„ï¼šAPIè¿”å›çš„æ˜¯rowsè€Œä¸æ˜¯data
          // è¿‡æ»¤å‡ºæŒ‡å®šäº§å“çš„æ•°æ®
          const productData = data.rows.filter(item => item.product_id === productId);
          if (productData.length > 0) {
            updateProductKPI(productData);
            renderProductCharts(productData);
            document.getElementById('productCharts').style.display = 'grid';
          } else {
            showProductDataError('æœªæ‰¾åˆ°è¯¥äº§å“çš„æ•°æ®');
          }
        } else {
          console.warn('äº§å“æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', data);
          showProductDataError('æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥APIå“åº”');
        }
      } catch (error) {
        console.error('åŠ è½½äº§å“æ•°æ®å¤±è´¥:', error);
        showProductDataError(`åŠ è½½äº§å“æ•°æ®å¤±è´¥: ${error.message}`);
      }
    }
  
           // æ›´æ–°äº§å“KPI - è®¡ç®—å•ä¸ªäº§å“çš„KPIæŒ‡æ ‡ï¼ŒåŒ…å«ä¸ä¸Šä¸€å‘¨æœŸçš„å¯¹æ¯”
    async function updateProductKPI(data) {
      if (!data || data.length === 0) return;
      
      console.log('æ›´æ–°äº§å“KPIï¼Œæ•°æ®:', data);
      
      // è®¡ç®—å½“å‰å‘¨æœŸçš„KPIæŒ‡æ ‡
      const currentTotalExposure = data.reduce((sum, item) => sum + (item.exposure || 0), 0);
      const currentTotalVisitors = data.reduce((sum, item) => sum + (item.visitors || 0), 0);
      const currentTotalViews = data.reduce((sum, item) => sum + (item.views || 0), 0);
      const currentTotalAddPeople = data.reduce((sum, item) => sum + (item.add_people || 0), 0);
      const currentTotalAddCount = data.reduce((sum, item) => sum + (item.add_count || 0), 0);
      const currentTotalPayBuyers = data.reduce((sum, item) => sum + (item.pay_buyers || 0), 0);
      const currentTotalPayItems = data.reduce((sum, item) => sum + (item.pay_items || 0), 0);
      
      // è®¡ç®—å½“å‰å‘¨æœŸæ¯”ç‡
      const currentAvgVisitorRate = currentTotalExposure > 0 ? (currentTotalVisitors / currentTotalExposure * 100).toFixed(2) : 0;
      const currentAvgCartRate = currentTotalVisitors > 0 ? (currentTotalAddCount / currentTotalVisitors * 100).toFixed(2) : 0;
      const currentAvgPayRate = currentTotalAddCount > 0 ? (currentTotalPayItems / currentTotalAddCount * 100).toFixed(2) : 0;
      
      // è·å–ä¸Šä¸€å‘¨æœŸæ•°æ®è¿›è¡Œå¯¹æ¯”
      const previousData = await getPreviousPeriodData();
      let comparisonData = {};
      
      if (previousData && previousData.length > 0) {
        const previousTotalExposure = previousData.reduce((sum, item) => sum + (item.exposure || 0), 0);
        const previousTotalVisitors = previousData.reduce((sum, item) => sum + (item.visitors || 0), 0);
        const previousTotalAddCount = previousData.reduce((sum, item) => sum + (item.add_count || 0), 0);
        const previousTotalPayItems = previousData.reduce((sum, item) => sum + (item.pay_items || 0), 0);
        const previousTotalAddPeople = previousData.reduce((sum, item) => sum + (item.add_people || 0), 0);
        const previousTotalPayBuyers = previousData.reduce((sum, item) => sum + (item.pay_buyers || 0), 0);
        
        const previousAvgVisitorRate = previousTotalExposure > 0 ? (previousTotalVisitors / previousTotalExposure * 100).toFixed(2) : 0;
        const previousAvgCartRate = previousTotalVisitors > 0 ? (previousTotalAddCount / previousTotalVisitors * 100).toFixed(2) : 0;
        const previousAvgPayRate = previousTotalAddCount > 0 ? (previousTotalPayItems / previousTotalAddCount * 100).toFixed(2) : 0;
        
        comparisonData = {
          avgVisitorRate: {
            current: parseFloat(currentAvgVisitorRate),
            previous: parseFloat(previousAvgVisitorRate),
            change: parseFloat(currentAvgVisitorRate) - parseFloat(previousAvgVisitorRate)
          },
          avgCartRate: {
            current: parseFloat(currentAvgCartRate),
            previous: parseFloat(previousAvgCartRate),
            change: parseFloat(currentAvgCartRate) - parseFloat(previousAvgCartRate)
          },
          avgPayRate: {
            current: parseFloat(currentAvgPayRate),
            previous: parseFloat(previousAvgPayRate),
            change: parseFloat(currentAvgPayRate) - parseFloat(previousAvgPayRate)
          },
          totalExposure: {
            current: currentTotalExposure,
            previous: previousTotalExposure,
            change: currentTotalExposure - previousTotalExposure
          },
          totalVisitors: {
            current: currentTotalVisitors,
            previous: previousTotalVisitors,
            change: currentTotalVisitors - previousTotalVisitors
          },
          totalAddPeople: {
            current: currentTotalAddPeople,
            previous: previousTotalAddPeople,
            change: currentTotalAddPeople - previousTotalAddPeople
          },
          totalPayBuyers: {
            current: currentTotalPayBuyers,
            previous: previousTotalPayBuyers,
            change: currentTotalPayBuyers - previousTotalPayBuyers
          }
        };
      }
      
      console.log('äº§å“KPIè®¡ç®—ç»“æœ:', {
        currentAvgVisitorRate,
        currentAvgCartRate,
        currentAvgPayRate,
        currentTotalExposure,
        currentTotalVisitors,
        currentTotalAddPeople,
        currentTotalPayBuyers,
        comparisonData
      });
      
      // æ›´æ–°KPIæ˜¾ç¤º
      document.getElementById('productAvgVisitor').textContent = currentAvgVisitorRate + '%';
      document.getElementById('productAvgCart').textContent = currentAvgCartRate + '%';
      document.getElementById('productAvgPay').textContent = currentAvgPayRate + '%';
      document.getElementById('productTotalExposure').textContent = currentTotalExposure.toLocaleString();
      document.getElementById('productTotalVisitors').textContent = currentTotalVisitors.toLocaleString();
      document.getElementById('productTotalAddPeople').textContent = currentTotalAddPeople.toLocaleString();
      document.getElementById('productTotalPayBuyers').textContent = currentTotalPayBuyers.toLocaleString();
      
      // æ›´æ–°å¯¹æ¯”æ•°æ®æ˜¾ç¤º
      updateProductComparisonDisplay(comparisonData);
    }
    
    // æ›´æ–°äº§å“å¯¹æ¯”æ•°æ®æ˜¾ç¤º
    function updateProductComparisonDisplay(comparisonData) {
      if (!comparisonData || Object.keys(comparisonData).length === 0) {
        // å¦‚æœæ²¡æœ‰å¯¹æ¯”æ•°æ®ï¼Œæ˜¾ç¤ºå ä½ç¬¦
        document.getElementById('productAvgVisitorComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productAvgCartComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productAvgPayComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productTotalExposureComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productTotalVisitorsComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productTotalAddPeopleComparison').innerHTML = '<span class="text-gray-500">--</span>';
        document.getElementById('productTotalPayBuyersComparison').innerHTML = '<span class="text-gray-500">--</span>';
        return;
      }
      
      // æ›´æ–°å¹³å‡è®¿å®¢æ¯”å¯¹æ¯”
      const visitorChange = comparisonData.avgVisitorRate.change;
      const visitorSymbol = visitorChange > 0 ? 'â†‘' : visitorChange < 0 ? 'â†“' : '';
      const visitorColor = visitorChange > 0 ? 'text-green-600' : visitorChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productAvgVisitorComparison').innerHTML = 
        `<span class="${visitorColor}">${visitorSymbol} ${Math.abs(visitorChange).toFixed(2)}%</span>`;
      
      // æ›´æ–°å¹³å‡åŠ è´­æ¯”å¯¹æ¯”
      const cartChange = comparisonData.avgCartRate.change;
      const cartSymbol = cartChange > 0 ? 'â†‘' : cartChange < 0 ? 'â†“' : '';
      const cartColor = cartChange > 0 ? 'text-green-600' : cartChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productAvgCartComparison').innerHTML = 
        `<span class="${cartColor}">${cartSymbol} ${Math.abs(cartChange).toFixed(2)}%</span>`;
      
      // æ›´æ–°å¹³å‡æ”¯ä»˜æ¯”å¯¹æ¯”
      const payChange = comparisonData.avgPayRate.change;
      const paySymbol = payChange > 0 ? 'â†‘' : payChange < 0 ? 'â†“' : '';
      const payColor = payChange > 0 ? 'text-green-600' : payChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productAvgPayComparison').innerHTML = 
        `<span class="${payColor}">${cartSymbol} ${Math.abs(payChange).toFixed(2)}%</span>`;
      
      // æ›´æ–°æ€»æ›å…‰é‡å¯¹æ¯”
      const exposureChange = comparisonData.totalExposure.change;
      const exposureSymbol = exposureChange > 0 ? 'â†‘' : exposureChange < 0 ? 'â†“' : '';
      const exposureColor = exposureChange > 0 ? 'text-green-600' : exposureChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productTotalExposureComparison').innerHTML = 
        `<span class="${exposureColor}">${exposureSymbol} ${Math.abs(exposureChange).toLocaleString()}</span>`;
      
      // æ›´æ–°æ€»è®¿å®¢æ•°å¯¹æ¯”
      const visitorsChange = comparisonData.totalVisitors.change;
      const visitorsSymbol = visitorsChange > 0 ? 'â†‘' : visitorsChange < 0 ? 'â†“' : '';
      const visitorsColor = visitorsChange > 0 ? 'text-green-600' : visitorsChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productTotalVisitorsComparison').innerHTML = 
        `<span class="${visitorsColor}">${visitorsSymbol} ${Math.abs(visitorsChange).toLocaleString()}</span>`;
      
      // æ›´æ–°æ€»åŠ è´­äººæ•°å¯¹æ¯”
      const addPeopleChange = comparisonData.totalAddPeople.change;
      const addPeopleSymbol = addPeopleChange > 0 ? 'â†‘' : addPeopleChange < 0 ? 'â†“' : '';
      const addPeopleColor = addPeopleChange > 0 ? 'text-green-600' : addPeopleChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productTotalAddPeopleComparison').innerHTML = 
        `<span class="${addPeopleColor}">${addPeopleSymbol} ${Math.abs(addPeopleChange).toLocaleString()}</span>`;
      
      // æ›´æ–°æ€»æ”¯ä»˜ä¹°å®¶æ•°å¯¹æ¯”
      const payBuyersChange = comparisonData.totalPayBuyers.change;
      const payBuyersSymbol = payBuyersChange > 0 ? 'â†‘' : payBuyersChange < 0 ? 'â†“' : '';
      const payBuyersColor = payBuyersChange > 0 ? 'text-green-600' : payBuyersChange < 0 ? 'text-red-600' : 'text-gray-500';
      document.getElementById('productTotalPayBuyersComparison').innerHTML = 
        `<span class="${payBuyersColor}">${payBuyersSymbol} ${Math.abs(payBuyersChange).toLocaleString()}</span>`;
    }
    
    // è·å–ä¸Šä¸€å‘¨æœŸæ•°æ®
    async function getPreviousPeriodData() {
      try {
        const dateRange = getProductDateRange();
        const currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
        
        // è®¡ç®—ä¸Šä¸€å‘¨æœŸçš„æ—¥æœŸèŒƒå›´
        const currentStart = new Date(dateRange.start);
        const currentEnd = new Date(dateRange.end);
        const periodDays = Math.ceil((currentEnd - currentStart) / (1000 * 60 * 60 * 24));
        
        const previousEnd = new Date(currentStart);
        previousEnd.setDate(previousEnd.getDate() - 1);
        const previousStart = new Date(previousEnd);
        previousStart.setDate(previousStart.getDate() - periodDays + 1);
        
        const queryParams = new URLSearchParams({
          start: previousStart.toISOString().slice(0, 10),
          end: previousEnd.toISOString().slice(0, 10),
          granularity: 'day',
          site: currentSite,
          aggregate: 'time'
        });
        
        const response = await fetch(`/api/ae_query?${queryParams.toString()}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.ok && data.rows) {
            return data.rows;
          }
        }
      } catch (error) {
        console.error('è·å–ä¸Šä¸€å‘¨æœŸæ•°æ®å¤±è´¥:', error);
      }
      
      return null;
    }
    
    // è·å–äº§å“åˆ†æé¡µé¢çš„æ—¥æœŸèŒƒå›´
    function getProductDateRange() {
      const input = document.getElementById('productDateFilter');
      if (input && input.value && input.value.includes(' to ')) {
        const [start, end] = input.value.split(' to ');
        return { start, end };
      }
      
      // é»˜è®¤æ˜¾ç¤ºæœ€è¿‘7å¤©
      const today = new Date();
      const end = today.toISOString().slice(0, 10);
      const start = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
      return { start, end };
    }
  
  // æ¸²æŸ“äº§å“å›¾è¡¨
  function renderProductCharts(data) {
    console.log('æ¸²æŸ“äº§å“å›¾è¡¨ï¼Œæ•°æ®:', data);
    
    // è·å–æ—¥æœŸæ ‡ç­¾ - ä¼˜å…ˆä½¿ç”¨bucketï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨stat_date
    const getDateLabel = (item) => {
      if (item.bucket && item.bucket !== 'undefined') return item.bucket;
      if (item.stat_date && item.stat_date !== 'undefined') return item.stat_date;
      if (item.bucket_label && item.bucket_label !== 'undefined') return item.bucket_label;
      return 'æœªçŸ¥æ—¥æœŸ';
    };
    
    const dateLabels = data.map(getDateLabel);
    console.log('äº§å“å›¾è¡¨æ—¥æœŸæ ‡ç­¾:', dateLabels);
    
    // äº§å“æ›å…‰è¶‹åŠ¿å›¾
    const productExposureChart = echarts.init(document.getElementById('productExposureChart'));
    const productExposureOption = {
      title: { text: 'æ›å…‰è¶‹åŠ¿', textStyle: { color: '#374151' } },
      tooltip: { trigger: 'axis' },
      xAxis: { 
        type: 'category', 
        data: dateLabels,
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      series: [{
        data: data.map(item => item.exposure || 0),
        type: 'line',
        smooth: true,
        itemStyle: { color: '#3B82F6' }
      }]
    };
    productExposureChart.setOption(productExposureOption);
    
    // è®¿å®¢æ¯”è¶‹åŠ¿å›¾
    const productVisitorRateChart = echarts.init(document.getElementById('productVisitorRateChart'));
    const productVisitorRateOption = {
      title: { text: 'è®¿å®¢æ¯”è¶‹åŠ¿', textStyle: { color: '#374151' } },
      tooltip: { trigger: 'axis' },
      xAxis: { 
        type: 'category', 
        data: dateLabels,
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12, formatter: '{value}%' }
      },
      series: [{
        data: data.map(item => {
          const exposure = item.exposure || 0;
          const visitors = item.visitors || 0;
          return exposure > 0 ? ((visitors / exposure) * 100).toFixed(2) : 0;
        }),
        type: 'line',
        smooth: true,
        itemStyle: { color: '#10B981' }
      }]
    };
    productVisitorRateChart.setOption(productVisitorRateOption);
    
    // åŠ è´­æ¯”è¶‹åŠ¿å›¾
    const productAddRateChart = echarts.init(document.getElementById('productAddRateChart'));
    const productAddRateOption = {
      title: { text: 'åŠ è´­æ¯”è¶‹åŠ¿', textStyle: { color: '#374151' } },
      tooltip: { trigger: 'axis' },
      xAxis: { 
        type: 'category', 
        data: dateLabels,
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12, formatter: '{value}%' }
      },
      series: [{
        data: data.map(item => {
          const visitors = item.visitors || 0;
          const addCount = item.add_count || 0;
          return visitors > 0 ? ((addCount / visitors) * 100).toFixed(2) : 0;
        }),
        type: 'line',
        smooth: true,
        itemStyle: { color: '#F59E0B' }
      }]
    };
    productAddRateChart.setOption(productAddRateOption);
    
    // æ”¯ä»˜æ¯”è¶‹åŠ¿å›¾
    const productPayRateChart = echarts.init(document.getElementById('productPayRateChart'));
    const productPayRateOption = {
      title: { text: 'æ”¯ä»˜æ¯”è¶‹åŠ¿', textStyle: { color: '#374151' } },
      tooltip: { trigger: 'axis' },
      xAxis: { 
        type: 'category', 
        data: dateLabels,
        axisLabel: { color: '#374151', fontSize: 12 }
      },
      yAxis: { 
        type: 'value',
        axisLabel: { color: '#374151', fontSize: 12, formatter: '{value}%' }
      },
      series: [{
        data: data.map(item => {
          const addCount = item.add_count || 0;
          const payItems = item.pay_items || 0;
          return addCount > 0 ? ((payItems / addCount) * 100).toFixed(2) : 0;
        }),
        type: 'line',
        smooth: true,
        itemStyle: { color: '#EF4444' }
      }]
    };
    productPayRateChart.setOption(productPayRateOption);
  }
  
  const userArea=document.getElementById('userArea');
  function refreshUser(){
    const u=JSON.parse(localStorage.getItem('user')||'null');
    if(u){
      userArea.innerHTML=`<div class="user-section"><div class="user-menu-trigger">${u.name}</div><div class="user-dropdown" style="display:none"><button class="user-dropdown-item" id="logoutBtn">é€€å‡º</button></div></div>`;
      const trigger=userArea.querySelector('.user-menu-trigger');
      const dropdown=userArea.querySelector('.user-dropdown');
      trigger.addEventListener('click',()=>{dropdown.style.display=dropdown.style.display==='block'?'none':'block';});
      document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.removeItem('user');dropdown.style.display='none';refreshUser();showLoginOverlay();});
    }else{
      userArea.innerHTML='<div class="user-section"><span class="user-demo">æœªç™»å½•</span><button class="login-button" id="loginTrigger">ç™»å½•</button></div>';
      document.getElementById('loginTrigger').addEventListener('click',showLoginOverlay);
      showLoginOverlay();
    }
  }
  refreshUser();
  window.addEventListener('user-login', refreshUser);
     // Hashè·¯ç”±å¤„ç†
   function handleHashRoute() {
     const hash = window.location.hash.slice(1) || 'detail';
     const targetLink = document.querySelector(`[data-target="${hash}"]`);
     
     if (targetLink) {
       // æ›´æ–°å¯¼èˆªçŠ¶æ€
       document.querySelectorAll('.sub-nav a').forEach(x => x.classList.remove('active'));
       targetLink.classList.add('active');
       
       // æ˜¾ç¤ºå¯¹åº”å†…å®¹
       ['detail', 'analysis', 'products'].forEach(id => {
         const el = document.getElementById(id);
         if (el) el.style.display = (id === hash ? '' : 'none');
       });
       
       // æ§åˆ¶ä¸»KPIå¡ç‰‡çš„æ˜¾ç¤º/éšè—
       const uploadSection = document.querySelector('.upload-section');
       if (uploadSection) {
         console.log('æ‰¾åˆ°upload-sectionï¼Œå½“å‰hash:', hash);
         if (hash === 'products') {
           // äº§å“åˆ†æé¡µé¢éšè—ä¸»KPIå¡ç‰‡
           console.log('éšè—KPIå¡ç‰‡');
           uploadSection.style.display = 'none';
           console.log('KPIå¡ç‰‡éšè—åçš„displayå€¼:', uploadSection.style.display);
         } else {
           // å…¶ä»–é¡µé¢æ˜¾ç¤ºä¸»KPIå¡ç‰‡
           console.log('æ˜¾ç¤ºKPIå¡ç‰‡');
           uploadSection.style.display = '';
           console.log('KPIå¡ç‰‡æ˜¾ç¤ºåçš„displayå€¼:', uploadSection.style.display);
         }
       } else {
         console.log('æœªæ‰¾åˆ°upload-sectionå…ƒç´ ');
       }
       
       // æ ¹æ®è·¯ç”±åŠ è½½ç›¸åº”æ•°æ®
       if (hash === 'analysis') {
         loadAnalysisData();
       } else if (hash === 'products') {
         loadProductAnalysisData();
       }
     }
   }
   
   // æ·»åŠ åŒå‡»äº§å“è·³è½¬åŠŸèƒ½
   function addProductDoubleClickHandler() {
     // ç›‘å¬æ•°æ®è¡¨æ ¼ä¸­çš„äº§å“IDåŒå‡»äº‹ä»¶
     document.addEventListener('dblclick', function(e) {
       const target = e.target;
       
       // æ£€æŸ¥æ˜¯å¦åŒå‡»äº†äº§å“ID
       if (target.tagName === 'A' && target.getAttribute('data-pid')) {
         const productId = target.getAttribute('data-pid');
         console.log('åŒå‡»äº§å“ID:', productId);
         
         // è·³è½¬åˆ°äº§å“åˆ†æé¡µé¢
         window.location.href = `self-operated.html#products?pid=${productId}`;
       }
     });
   }
  
  // ç›‘å¬hashå˜åŒ–
  window.addEventListener('hashchange', handleHashRoute);
  
     // åˆå§‹åŒ–hashè·¯ç”±
   handleHashRoute();
   
   // æ·»åŠ åŒå‡»äº§å“è·³è½¬åŠŸèƒ½
   addProductDoubleClickHandler();
   
   // å¯¼èˆªç‚¹å‡»å¤„ç†
   document.querySelectorAll('.sub-nav a').forEach(a => {
     a.addEventListener('click', e => {
       const target = a.dataset.target;
       if (target) {
         e.preventDefault();
         window.location.hash = target;
       }
     });
   });
 });
</script>
</body>
</html>
