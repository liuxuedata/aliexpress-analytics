        <!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>速卖通自运营统计</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f9; }
        .container { max-width: 1200px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        h1 { font-size: 24px; color: #333; margin: 0; }
        .control-panel { display: flex; align-items: center; gap: 15px; }
        .control-panel label, .control-panel button { font-size: 14px; }
        #data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #data-table th, #data-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        #data-table th { background-color: #eef; color: #555; }
        #data-table tr:nth-child(even) { background-color: #f9f9f9; }
        .upload-section { margin-bottom: 20px; padding: 15px; border: 1px dashed #ccc; border-radius: 5px; background-color: #f9f9f9; text-align: center; }
        .upload-section input[type="file"] { border: 1px solid #ddd; padding: 8px; border-radius: 4px; }
        .upload-section button { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; }
        .upload-section button:hover { background-color: #0056b3; }
        #status-message { margin-top: 10px; font-size: 14px; color: #333; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>速卖通自运营统计</h1>
        <div class="control-panel">
            <label for="date-range">选择日期范围:</label>
            <input type="date" id="start-date">
            <span>到</span>
            <input type="date" id="end-date">
            <button onclick="filterDataByDate()">筛选</button>
        </div>
    </div>
    
    <div class="upload-section">
        <h3>上传自运营数据</h3>
        <p>请选择一个CSV文件进行上传。数据将自动去重并保存到数据库中。</p>
        <input type="file" id="csv-file" accept=".csv, .xlsx">
        <button id="upload-button">上传数据并保存</button>
        <div id="status-message"></div>
    </div>

    <div id="data-container">
        <canvas id="myChart" width="400" height="200"></canvas>
    </div>

    <table id="data-table">
        <thead>
            <tr>
                <th>统计时间</th>
                <th>商品ID</th>
                <th>排名</th>
                <th>支付买家数</th>
                <th>浏览量</th>
                <th>下单金额</th>
                <th>访客数</th>
                <th>支付转化率</th>
                <th>根类目名称</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script>
    // 假设这是从您的 Supabase 数据库加载的初始数据
    // 在实际应用中，您需要在此处调用一个 API 来获取数据
    let rawData = [];
    let myChart;

    document.addEventListener('DOMContentLoaded', () => {
        // 在页面加载时，调用 API 加载数据库中的数据
        fetchAndLoadData();
    });

    async function fetchAndLoadData() {
        try {
            // 这里需要替换成您从 Supabase 读取数据的 API 端点
            // 例如: '/api/get-data'
            const response = await fetch('/api/get-data');
            if (!response.ok) {
                throw new Error('Failed to fetch data from API');
            }
            const data = await response.json();
            rawData = data;
            renderTable(rawData);
            renderChart(rawData);
        } catch (error) {
            console.error('Error fetching data:', error);
            alert('获取数据失败，请检查API。');
        }
    }

    function renderTable(data) {
        const tbody = document.querySelector('#data-table tbody');
        tbody.innerHTML = '';
        data.forEach(item => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = item["统计时间"];
            row.insertCell(1).textContent = item["商品ID"];
            row.insertCell(2).textContent = item["排名"];
            row.insertCell(3).textContent = item["支付买家数"];
            row.insertCell(4).textContent = item["浏览量"];
            row.insertCell(5).textContent = item["下单金额"];
            row.insertCell(6).textContent = item["访客数"];
            row.insertCell(7).textContent = item["支付转化率"];
            row.insertCell(8).textContent = item["根类目名称"];
        });
    }

    function renderChart(data) {
        if (myChart) {
            myChart.destroy();
        }
        
        const ctx = document.getElementById('myChart').getContext('2d');
        const labels = data.map(item => item["统计时间"]);
        const visitors = data.map(item => item["访客数"]);
        const payments = data.map(item => item["支付买家数"]);
        const revenue = data.map(item => item["下单金额"]);

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '访客数',
                    data: visitors,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }, {
                    label: '支付买家数',
                    data: payments,
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }, {
                    label: '下单金额',
                    data: revenue,
                    borderColor: 'rgb(54, 162, 235)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: '统计时间' }
                    },
                    y: {
                        title: { display: true, text: '数值' },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function filterDataByDate() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        const filtered = rawData.filter(item => {
            const itemDate = item["统计时间"];
            return itemDate >= startDate && itemDate <= endDate;
        });

        renderTable(filtered);
        renderChart(filtered);
    }

    // 新增的文件上传和API调用逻辑
    document.getElementById('upload-button').addEventListener('click', async () => {
        const fileInput = document.getElementById('csv-file');
        const statusMessage = document.getElementById('status-message');
        const file = fileInput.files[0];

        if (!file) {
            statusMessage.textContent = '请选择一个 CSV 文件！';
            statusMessage.style.color = 'red';
            return;
        }

        statusMessage.textContent = '正在上传...';
        statusMessage.style.color = '#007bff';

        const reader = new FileReader();
        reader.onload = async (event) => {
            const csvData = event.target.result;
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ csv_data: csvData }),
                });

                const result = await response.json();

                if (response.ok) {
                    statusMessage.textContent = result.message;
                    statusMessage.style.color = 'green';
                    // 上传成功后重新加载数据
                    fetchAndLoadData();
                } else {
                    statusMessage.textContent = '上传失败: ' + result.error;
                    statusMessage.style.color = 'red';
                }
            } catch (error) {
                console.error('Network or server error:', error);
                statusMessage.textContent = '网络请求失败，请检查网络连接或后端服务。';
                statusMessage.style.color = 'red';
            }
        };
        reader.readAsText(file);
    });
</script>

</body>
</html>
