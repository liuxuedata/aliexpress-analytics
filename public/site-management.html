<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç«™ç‚¹ç®¡ç† Â· è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250810b">
  <style>
    .site-management {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .site-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .site-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .site-card h3 {
      margin: 0 0 10px 0;
      color: #1f2937;
    }
    .site-card .platform {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 15px;
    }
    .site-card .actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .btn {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background: #f9fafb;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .add-site-form {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #374151;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
  </style>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
        <div class="form-subtitle">ç™»å½•è´¦æˆ·ä»¥ç»§ç»­</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">é‚®ç®±</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">å¯†ç </label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">ğŸ‘ï¸</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">ç™»å½•</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">æ¼”ç¤ºè´¦æˆ·</div>
        <div class="demo-account-info">é‚®ç®±ï¼šdemo@example.com<br>å¯†ç ï¼šdemo123</div>
      </div>
    </div>
  </div>
</div>

<header class="header">
  <div class="logo-title">è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li><a href="#">é€Ÿå–é€š</a>
        <ul class="dropdown">
          <li class="submenu"><a href="#">å…¨æ‰˜ç®¡</a>
            <ul id="managedMenu"></ul>
          </li>
          <li><a href="self-operated.html">è‡ªè¿è¥</a></li>
        </ul>
      </li>
      <li><a href="#">äºšé©¬é€Š</a></li>
      <li><a href="#">TikTok Shop</a></li>
      <li><a href="#">Temu</a></li>
      <li><a href="#">Ozon</a></li>
      <li><a href="independent-site.html">ç‹¬ç«‹ç«™</a></li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>

<div class="layout">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span>ç«™ç‚¹ç®¡ç†</span></div>
    <ul class="sub-nav">
      <li><a href="#" class="active" data-target="sites">ç«™ç‚¹åˆ—è¡¨</a></li>
      <li><a href="#" data-target="add">æ·»åŠ ç«™ç‚¹</a></li>
    </ul>
  </nav>

  <main class="main mx-auto max-w-container px-6">
    <div class="site-management">
      <h1>ç«™ç‚¹ç®¡ç†</h1>
      <p>ç®¡ç†å¤šç«™ç‚¹é…ç½®å’Œæ•°æ®æº</p>
      
      <div style="margin-bottom: 20px;">
        <a href="/site-configuration.html" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
          ğŸš€ é«˜çº§ç«™ç‚¹é…ç½®
        </a>
        <span style="margin-left: 10px; color: #6b7280; font-size: 14px;">
          æ”¯æŒè‡ªåŠ¨ç”Ÿæˆæ•°æ®è¡¨å’ŒAPIæ¥å£
        </span>
      </div>
      
      <!-- æ·»åŠ ç«™ç‚¹è¡¨å• -->
      <div class="add-site-form">
        <h2>æ·»åŠ æ–°ç«™ç‚¹</h2>
        <form id="addSiteForm">
          <div class="form-row">
            <div class="form-group">
              <label for="siteName">ç«™ç‚¹åç§°</label>
              <input type="text" id="siteName" required placeholder="å¦‚ï¼šrobot æˆ– flagship">
            </div>
            <div class="form-group">
              <label for="sitePlatform">å¹³å°</label>
              <select id="sitePlatform" required>
                <option value="">é€‰æ‹©å¹³å°</option>
                <option value="ae_self_operated">é€Ÿå–é€šè‡ªè¿è¥</option>
                <option value="ae_managed">é€Ÿå–é€šå…¨æ‰˜ç®¡</option>
                <option value="independent">ç‹¬ç«‹ç«™</option>
                <option value="amazon">äºšé©¬é€Š</option>
                <option value="ozon">Ozon</option>
                <option value="tiktok">TikTok Shop</option>
                <option value="temu">Temu</option>
                <option value="lazada">Lazada</option>
                <option value="shopee">Shopee</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="displayName">æ˜¾ç¤ºåç§°</label>
              <input type="text" id="displayName" required placeholder="å¦‚ï¼šé€Ÿå–é€šè‡ªè¿è¥ Robot">
            </div>
            <div class="form-group">
              <label for="siteDomain">åŸŸå / æ ‡è¯†</label>
              <input type="text" id="siteDomain" placeholder="å¦‚ï¼šrobot.aliexpress.com">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="siteDataSource">æ•°æ®æº</label>
              <select id="siteDataSource" required>
                <option value="">é€‰æ‹©æ•°æ®æº</option>
              </select>
            </div>
            <div class="form-group">
              <label for="templateId">æ•°æ®æ¨¡æ¿</label>
              <input type="text" id="templateId" placeholder="å¯é€‰ï¼šfacebook_ads_v2025">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">æ·»åŠ ç«™ç‚¹</button>
        </form>
      </div>

      <!-- ç«™ç‚¹åˆ—è¡¨ -->
      <div id="sitesList">
        <h2>ç°æœ‰ç«™ç‚¹</h2>
        <div class="site-grid" id="siteGrid">
          <!-- ç«™ç‚¹å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </main>
</div>

<script>
// ç™»å½•é€»è¾‘
(function() {
  const loginOverlay = document.getElementById('loginOverlay');
  const loginForm = document.getElementById('loginForm');
  const userArea = document.getElementById('userArea');

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  function checkAuth() {
    const token = localStorage.getItem('authToken');
    if (!token) {
      loginOverlay.style.display = 'flex';
    } else {
      loginOverlay.style.display = 'none';
      userArea.innerHTML = `
        <span>æ¬¢è¿ï¼Œç”¨æˆ·</span>
        <button onclick="logout()" class="btn">é€€å‡º</button>
      `;
    }
  }

  // ç™»å½•å¤„ç†
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    // æ¼”ç¤ºç™»å½•é€»è¾‘
    if (email === 'demo@example.com' && password === 'demo123') {
      localStorage.setItem('authToken', 'demo-token');
      checkAuth();
    } else {
      alert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ');
    }
  });

  // é€€å‡ºç™»å½•
  window.logout = function() {
    localStorage.removeItem('authToken');
    checkAuth();
  };

  // å¯†ç æ˜¾ç¤ºåˆ‡æ¢
  document.getElementById('password-toggle').addEventListener('click', function() {
    const passwordInput = document.getElementById('password');
    passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
  });

  checkAuth();
})();

// ç«™ç‚¹ç®¡ç†é€»è¾‘
(function() {
  const addSiteForm = document.getElementById('addSiteForm');
  const siteGrid = document.getElementById('siteGrid');
  const platformSelect = document.getElementById('sitePlatform');
  const dataSourceSelect = document.getElementById('siteDataSource');
  let currentSites = [];

  const PLATFORM_CATALOG = {
    ae_self_operated: {
      label: 'é€Ÿå–é€šè‡ªè¿è¥',
      dataSources: [
        { value: 'ae_api', label: 'é€Ÿå–é€š API' },
        { value: 'ae_report', label: 'é€Ÿå–é€šè¿è¥æŠ¥è¡¨' }
      ]
    },
    ae_managed: {
      label: 'é€Ÿå–é€šå…¨æ‰˜ç®¡',
      dataSources: [
        { value: 'ae_api', label: 'é€Ÿå–é€š API' },
        { value: 'managed_report', label: 'å…¨æ‰˜ç®¡æŠ¥è¡¨' }
      ]
    },
    independent: {
      label: 'ç‹¬ç«‹ç«™',
      dataSources: [
        { value: 'google_ads', label: 'Google Ads' },
        { value: 'facebook_ads', label: 'Facebook Ads' },
        { value: 'tiktok_ads', label: 'TikTok Ads' },
        { value: 'custom', label: 'è‡ªå®šä¹‰/åŸ‹ç‚¹' }
      ]
    },
    amazon: {
      label: 'äºšé©¬é€Š',
      dataSources: [
        { value: 'amazon_sp_api', label: 'Amazon SP-API' },
        { value: 'amazon_ads', label: 'Amazon Ads æŠ¥è¡¨' }
      ]
    },
    ozon: {
      label: 'Ozon',
      dataSources: [
        { value: 'ozon_api', label: 'Ozon API' },
        { value: 'ozon_report', label: 'Ozon æŠ¥è¡¨' }
      ]
    },
    tiktok: {
      label: 'TikTok Shop',
      dataSources: [
        { value: 'tiktok_shop_api', label: 'TikTok Shop API' },
        { value: 'tiktok_ads', label: 'TikTok Ads æŠ¥è¡¨' }
      ]
    },
    temu: {
      label: 'Temu',
      dataSources: [
        { value: 'temu_report', label: 'Temu æŠ¥è¡¨' },
        { value: 'temu_api', label: 'Temu API (è§„åˆ’)' }
      ]
    },
    lazada: {
      label: 'Lazada',
      dataSources: [
        { value: 'lazada_api', label: 'Lazada API' },
        { value: 'lazada_ads', label: 'Lazada Ads æŠ¥è¡¨' },
        { value: 'custom', label: 'è‡ªå®šä¹‰/ç¬¬ä¸‰æ–¹' }
      ]
    },
    shopee: {
      label: 'Shopee',
      dataSources: [
        { value: 'shopee_api', label: 'Shopee API' },
        { value: 'shopee_ads', label: 'Shopee Ads æŠ¥è¡¨' },
        { value: 'custom', label: 'è‡ªå®šä¹‰/ç¬¬ä¸‰æ–¹' }
      ]
    },
    ebay: {
      label: 'eBay',
      dataSources: [
        { value: 'ebay_report', label: 'eBay æŠ¥è¡¨' },
        { value: 'custom', label: 'è‡ªå®šä¹‰/ç¬¬ä¸‰æ–¹' }
      ]
    }
  };

  const DATA_SOURCE_LABELS = Object.values(PLATFORM_CATALOG).reduce((acc, platform) => {
    platform.dataSources.forEach(ds => acc[ds.value] = ds.label);
    return acc;
  }, { custom: 'è‡ªå®šä¹‰/ç¬¬ä¸‰æ–¹' });

  platformSelect.addEventListener('change', updateDataSourceOptions);

  async function loadSites() {
    try {
      const response = await fetch('/api/site-configs');
      const result = await response.json();
      if (!response.ok) throw new Error(result.error || 'åŠ è½½å¤±è´¥');
      currentSites = result.data || [];
      renderSites();
    } catch (error) {
      console.error('åŠ è½½ç«™ç‚¹å¤±è´¥:', error);
      siteGrid.innerHTML = '<div class="site-card">åŠ è½½ç«™ç‚¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</div>';
    }
  }

  function renderSites() {
    if (!currentSites.length) {
      siteGrid.innerHTML = '<div class="site-card">æš‚æ— ç«™ç‚¹ï¼Œè¯·å…ˆåˆ›å»ºã€‚</div>';
      return;
    }

    siteGrid.innerHTML = currentSites.map(site => `
      <div class="site-card">
        <h3>${site.display_name || site.name}</h3>
        <div class="platform">å¹³å°: ${getPlatformName(site.platform)}</div>
        <div class="platform">æ•°æ®æº: ${getDataSourceName(site.data_source)}</div>
        <div class="platform">ç«™ç‚¹ID: ${site.id}</div>
        <div class="platform">åŸŸå: ${site.domain || 'â€”'}</div>
        <div class="actions">
          <button class="btn" onclick="editSite('${site.id}')">ç¼–è¾‘</button>
          <button class="btn btn-danger" onclick="deleteSite('${site.id}')">åˆ é™¤</button>
        </div>
      </div>
    `).join('');
  }

  function updateDataSourceOptions() {
    const platform = platformSelect.value;
    const options = PLATFORM_CATALOG[platform]?.dataSources || [];
    dataSourceSelect.innerHTML = '<option value="">é€‰æ‹©æ•°æ®æº</option>';
    options.forEach(source => {
      const option = document.createElement('option');
      option.value = source.value;
      option.textContent = source.label;
      dataSourceSelect.appendChild(option);
    });
    if (!options.find(item => item.value === 'custom')) {
      const fallback = document.createElement('option');
      fallback.value = 'custom';
      fallback.textContent = DATA_SOURCE_LABELS.custom;
      dataSourceSelect.appendChild(fallback);
    }
  }

  function getPlatformName(platform) {
    return PLATFORM_CATALOG[platform]?.label || platform;
  }

  function getDataSourceName(source) {
    if (!source) return 'æœªé…ç½®';
    return DATA_SOURCE_LABELS[source] || source;
  }

  addSiteForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('siteName').value.trim();
    const platform = platformSelect.value;
    const displayName = document.getElementById('displayName').value.trim();
    const domain = document.getElementById('siteDomain').value.trim() || null;
    const dataSource = dataSourceSelect.value;
    const templateId = document.getElementById('templateId').value.trim() || null;

    if (!name || !platform || !displayName || !dataSource) {
      alert('è¯·å¡«å†™å®Œæ•´çš„ç«™ç‚¹åç§°ã€å¹³å°ã€æ˜¾ç¤ºåç§°ä¸æ•°æ®æºã€‚');
      return;
    }

    const payload = {
      name,
      platform,
      display_name: displayName,
      domain,
      data_source: dataSource,
      template_id: templateId || null
    };

    try {
      const response = await fetch('/api/site-configs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (response.ok) {
        alert('ç«™ç‚¹æ·»åŠ æˆåŠŸï¼Œå·²è‡ªåŠ¨æ³¨å†Œå¯¼èˆªæ¨¡å—ï¼');
        addSiteForm.reset();
        updateDataSourceOptions();
        await loadSites();
        if (result.data?.id) {
          await syncSite(result.data.id, 'create');
        }
      } else {
        alert('æ·»åŠ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
      }
    } catch (error) {
      console.error('æ·»åŠ ç«™ç‚¹å¤±è´¥:', error);
      alert('æ·»åŠ ç«™ç‚¹å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  });

  async function syncSite(siteId, action) {
    try {
      await fetch('/api/site-sync', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ siteId, action })
      });
    } catch (error) {
      console.warn('è§¦å‘ç«™ç‚¹åŒæ­¥å¤±è´¥:', error);
    }
  }

  window.editSite = function() {
    alert('å¦‚éœ€ç¼–è¾‘ç«™ç‚¹é…ç½®ï¼Œè¯·å‰å¾€ admin.html ç®¡ç†åå°ã€‚');
  };

  window.deleteSite = async function(siteId) {
    if (!siteId) {
      alert('æœªæ‰¾åˆ°ç«™ç‚¹IDï¼Œæ— æ³•åˆ é™¤ã€‚');
      return;
    }

    const confirmed = confirm('ç¡®å®šè¦åˆ é™¤è¯¥ç«™ç‚¹å—ï¼Ÿæ­¤æ“ä½œå°†ç§»é™¤ç«™ç‚¹é…ç½®å¹¶ä»å¯¼èˆªä¸­éšè—ã€‚');
    if (!confirmed) return;

    try {
      const response = await fetch('/api/site-configs/delete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ siteId })
      });

      const result = await response.json();
      if (!response.ok) {
        throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
      }

      alert('ç«™ç‚¹å·²åˆ é™¤ã€‚');
      await loadSites();
    } catch (error) {
      console.error('åˆ é™¤ç«™ç‚¹å¤±è´¥:', error);
      alert('åˆ é™¤ç«™ç‚¹å¤±è´¥ï¼š' + error.message);
    }
  };

  updateDataSourceOptions();
  loadSites();
})();
</script>
</body>
</html>
