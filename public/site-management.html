<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>站点管理 · 跨境电商数据分析平台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250810b">
  <style>
    .site-management {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .site-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .site-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .site-card h3 {
      margin: 0 0 10px 0;
      color: #1f2937;
    }
    .site-card .platform {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 15px;
    }
    .site-card .actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .btn {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background: #f9fafb;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    .btn-primary:hover {
      background: #2563eb;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .add-site-form {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #374151;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
  </style>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">跨境电商数据分析平台</div>
        <div class="form-subtitle">登录账户以继续</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">邮箱</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">密码</label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">👁️</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">登录</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">演示账户</div>
        <div class="demo-account-info">邮箱：demo@example.com<br>密码：demo123</div>
      </div>
    </div>
  </div>
</div>

<header class="header">
  <div class="logo-title">跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li><a href="#">速卖通</a>
        <ul class="dropdown">
          <li class="submenu"><a href="#">全托管</a>
            <ul id="managedMenu"></ul>
          </li>
          <li><a href="self-operated.html">自运营</a></li>
        </ul>
      </li>
      <li><a href="#">亚马逊</a></li>
      <li><a href="#">TikTok Shop</a></li>
      <li><a href="#">Temu</a></li>
      <li><a href="#">Ozon</a></li>
      <li><a href="independent-site.html">独立站</a></li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>

<div class="layout">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span>站点管理</span></div>
    <ul class="sub-nav">
      <li><a href="#" class="active" data-target="sites">站点列表</a></li>
      <li><a href="#" data-target="add">添加站点</a></li>
    </ul>
  </nav>

  <main class="main mx-auto max-w-container px-6">
    <div class="site-management">
      <h1>站点管理</h1>
      <p>管理多站点配置和数据源</p>
      
      <div style="margin-bottom: 20px;">
        <a href="/site-configuration.html" class="btn btn-primary" style="text-decoration: none; display: inline-block;">
          🚀 高级站点配置
        </a>
        <span style="margin-left: 10px; color: #6b7280; font-size: 14px;">
          支持自动生成数据表和API接口
        </span>
      </div>
      
      <!-- 添加站点表单 -->
      <div class="add-site-form">
        <h2>添加新站点</h2>
        <form id="addSiteForm">
          <div class="form-row">
            <div class="form-group">
              <label for="siteName">站点名称</label>
              <input type="text" id="siteName" required placeholder="如：robot 或 flagship">
            </div>
            <div class="form-group">
              <label for="sitePlatform">平台</label>
              <select id="sitePlatform" required>
                <option value="">选择平台</option>
                <option value="ae_self_operated">速卖通自运营</option>
                <option value="ae_managed">速卖通全托管</option>
                <option value="independent">独立站</option>
                <option value="amazon">亚马逊</option>
                <option value="ozon">Ozon</option>
                <option value="tiktok">TikTok Shop</option>
                <option value="temu">Temu</option>
                <option value="lazada">Lazada</option>
                <option value="shopee">Shopee</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="displayName">显示名称</label>
              <input type="text" id="displayName" required placeholder="如：速卖通自运营 Robot">
            </div>
            <div class="form-group">
              <label for="siteDomain">域名 / 标识</label>
              <input type="text" id="siteDomain" placeholder="如：robot.aliexpress.com">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="siteDataSource">数据源</label>
              <select id="siteDataSource" required>
                <option value="">选择数据源</option>
              </select>
            </div>
            <div class="form-group">
              <label for="templateId">数据模板</label>
              <input type="text" id="templateId" placeholder="可选：facebook_ads_v2025">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">添加站点</button>
        </form>
      </div>

      <!-- 站点列表 -->
      <div id="sitesList">
        <h2>现有站点</h2>
        <div class="site-grid" id="siteGrid">
          <!-- 站点卡片将通过JavaScript动态生成 -->
        </div>
      </div>
    </div>
  </main>
</div>

<script>
// 登录逻辑
(function() {
  const loginOverlay = document.getElementById('loginOverlay');
  const loginForm = document.getElementById('loginForm');
  const userArea = document.getElementById('userArea');

  // 检查登录状态
  function checkAuth() {
    const token = localStorage.getItem('authToken');
    if (!token) {
      loginOverlay.style.display = 'flex';
    } else {
      loginOverlay.style.display = 'none';
      userArea.innerHTML = `
        <span>欢迎，用户</span>
        <button onclick="logout()" class="btn">退出</button>
      `;
    }
  }

  // 登录处理
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    // 演示登录逻辑
    if (email === 'demo@example.com' && password === 'demo123') {
      localStorage.setItem('authToken', 'demo-token');
      checkAuth();
    } else {
      alert('登录失败，请检查邮箱和密码');
    }
  });

  // 退出登录
  window.logout = function() {
    localStorage.removeItem('authToken');
    checkAuth();
  };

  // 密码显示切换
  document.getElementById('password-toggle').addEventListener('click', function() {
    const passwordInput = document.getElementById('password');
    passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
  });

  checkAuth();
})();

// 站点管理逻辑
(function() {
  const addSiteForm = document.getElementById('addSiteForm');
  const siteGrid = document.getElementById('siteGrid');
  const platformSelect = document.getElementById('sitePlatform');
  const dataSourceSelect = document.getElementById('siteDataSource');
  let currentSites = [];

  const PLATFORM_CATALOG = {
    ae_self_operated: {
      label: '速卖通自运营',
      dataSources: [
        { value: 'ae_api', label: '速卖通 API' },
        { value: 'ae_report', label: '速卖通运营报表' }
      ]
    },
    ae_managed: {
      label: '速卖通全托管',
      dataSources: [
        { value: 'ae_api', label: '速卖通 API' },
        { value: 'managed_report', label: '全托管报表' }
      ]
    },
    independent: {
      label: '独立站',
      dataSources: [
        { value: 'google_ads', label: 'Google Ads' },
        { value: 'facebook_ads', label: 'Facebook Ads' },
        { value: 'tiktok_ads', label: 'TikTok Ads' },
        { value: 'custom', label: '自定义/埋点' }
      ]
    },
    amazon: {
      label: '亚马逊',
      dataSources: [
        { value: 'amazon_sp_api', label: 'Amazon SP-API' },
        { value: 'amazon_ads', label: 'Amazon Ads 报表' }
      ]
    },
    ozon: {
      label: 'Ozon',
      dataSources: [
        { value: 'ozon_api', label: 'Ozon API' },
        { value: 'ozon_report', label: 'Ozon 报表' }
      ]
    },
    tiktok: {
      label: 'TikTok Shop',
      dataSources: [
        { value: 'tiktok_shop_api', label: 'TikTok Shop API' },
        { value: 'tiktok_ads', label: 'TikTok Ads 报表' }
      ]
    },
    temu: {
      label: 'Temu',
      dataSources: [
        { value: 'temu_report', label: 'Temu 报表' },
        { value: 'temu_api', label: 'Temu API (规划)' }
      ]
    },
    lazada: {
      label: 'Lazada',
      dataSources: [
        { value: 'lazada_api', label: 'Lazada API' },
        { value: 'lazada_ads', label: 'Lazada Ads 报表' },
        { value: 'custom', label: '自定义/第三方' }
      ]
    },
    shopee: {
      label: 'Shopee',
      dataSources: [
        { value: 'shopee_api', label: 'Shopee API' },
        { value: 'shopee_ads', label: 'Shopee Ads 报表' },
        { value: 'custom', label: '自定义/第三方' }
      ]
    },
    ebay: {
      label: 'eBay',
      dataSources: [
        { value: 'ebay_report', label: 'eBay 报表' },
        { value: 'custom', label: '自定义/第三方' }
      ]
    }
  };

  const DATA_SOURCE_LABELS = Object.values(PLATFORM_CATALOG).reduce((acc, platform) => {
    platform.dataSources.forEach(ds => acc[ds.value] = ds.label);
    return acc;
  }, { custom: '自定义/第三方' });

  platformSelect.addEventListener('change', updateDataSourceOptions);

  async function loadSites() {
    try {
      const response = await fetch('/api/site-configs');
      const result = await response.json();
      if (!response.ok) throw new Error(result.error || '加载失败');
      currentSites = result.data || [];
      renderSites();
    } catch (error) {
      console.error('加载站点失败:', error);
      siteGrid.innerHTML = '<div class="site-card">加载站点失败，请稍后重试。</div>';
    }
  }

  function renderSites() {
    if (!currentSites.length) {
      siteGrid.innerHTML = '<div class="site-card">暂无站点，请先创建。</div>';
      return;
    }

    siteGrid.innerHTML = currentSites.map(site => `
      <div class="site-card">
        <h3>${site.display_name || site.name}</h3>
        <div class="platform">平台: ${getPlatformName(site.platform)}</div>
        <div class="platform">数据源: ${getDataSourceName(site.data_source)}</div>
        <div class="platform">站点ID: ${site.id}</div>
        <div class="platform">域名: ${site.domain || '—'}</div>
        <div class="actions">
          <button class="btn" onclick="editSite('${site.id}')">编辑</button>
          <button class="btn btn-danger" onclick="deleteSite('${site.id}')">删除</button>
        </div>
      </div>
    `).join('');
  }

  function updateDataSourceOptions() {
    const platform = platformSelect.value;
    const options = PLATFORM_CATALOG[platform]?.dataSources || [];
    dataSourceSelect.innerHTML = '<option value="">选择数据源</option>';
    options.forEach(source => {
      const option = document.createElement('option');
      option.value = source.value;
      option.textContent = source.label;
      dataSourceSelect.appendChild(option);
    });
    if (!options.find(item => item.value === 'custom')) {
      const fallback = document.createElement('option');
      fallback.value = 'custom';
      fallback.textContent = DATA_SOURCE_LABELS.custom;
      dataSourceSelect.appendChild(fallback);
    }
  }

  function getPlatformName(platform) {
    return PLATFORM_CATALOG[platform]?.label || platform;
  }

  function getDataSourceName(source) {
    if (!source) return '未配置';
    return DATA_SOURCE_LABELS[source] || source;
  }

  addSiteForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('siteName').value.trim();
    const platform = platformSelect.value;
    const displayName = document.getElementById('displayName').value.trim();
    const domain = document.getElementById('siteDomain').value.trim() || null;
    const dataSource = dataSourceSelect.value;
    const templateId = document.getElementById('templateId').value.trim() || null;

    if (!name || !platform || !displayName || !dataSource) {
      alert('请填写完整的站点名称、平台、显示名称与数据源。');
      return;
    }

    const payload = {
      name,
      platform,
      display_name: displayName,
      domain,
      data_source: dataSource,
      template_id: templateId || null
    };

    try {
      const response = await fetch('/api/site-configs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (response.ok) {
        alert('站点添加成功，已自动注册导航模块！');
        addSiteForm.reset();
        updateDataSourceOptions();
        await loadSites();
        if (result.data?.id) {
          await syncSite(result.data.id, 'create');
        }
      } else {
        alert('添加失败: ' + (result.error || '未知错误'));
      }
    } catch (error) {
      console.error('添加站点失败:', error);
      alert('添加站点失败，请重试');
    }
  });

  async function syncSite(siteId, action) {
    try {
      await fetch('/api/site-sync', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ siteId, action })
      });
    } catch (error) {
      console.warn('触发站点同步失败:', error);
    }
  }

  window.editSite = function() {
    alert('如需编辑站点配置，请前往 admin.html 管理后台。');
  };

  window.deleteSite = async function(siteId) {
    if (!siteId) {
      alert('未找到站点ID，无法删除。');
      return;
    }

    const confirmed = confirm('确定要删除该站点吗？此操作将移除站点配置并从导航中隐藏。');
    if (!confirmed) return;

    try {
      const response = await fetch('/api/site-configs/delete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ siteId })
      });

      const result = await response.json();
      if (!response.ok) {
        throw new Error(result.error || '删除失败');
      }

      alert('站点已删除。');
      await loadSites();
    } catch (error) {
      console.error('删除站点失败:', error);
      alert('删除站点失败：' + error.message);
    }
  };

  updateDataSourceOptions();
  loadSites();
})();
</script>
</body>
</html>
