<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>速卖通报告与导航</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; }
      .container { display: flex; height: 100vh; }
      .sidebar { width: 220px; background: #2d3e50; color: #fff; padding: 15px; box-sizing: border-box; border-right: 2px solid #444; }
      .sidebar h3 { margin-top: 0; color: #fff; }
      .sidebar ul { list-style: none; padding-left: 0; }
      .sidebar li { margin-bottom: 10px; }
      .sidebar a { text-decoration: none; color: #ddd; font-size: 14px; }
      .sidebar a:hover { color: #fff; text-decoration: underline; }
      /* Hide abbreviated label by default */
      .sidebar .abbr { display: none; }
      /* Collapsed sidebar styles */
      .sidebar.collapsed { width: 60px; }
      .sidebar.collapsed .nav-title { display: none; }
      .sidebar.collapsed .label { display: none; }
      .sidebar.collapsed .abbr { display: block; text-align: center; font-size: 18px; color: #fff; }
      .sidebar.collapsed li { margin-bottom: 20px; }

      /* Toggle button for collapsing/expanding sidebar */
      .toggle-btn {
        display: block;
        margin: 10px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        background: #4a90e2;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        text-align: center;
        line-height: 24px;
      }
      /* Center toggle button when sidebar is collapsed */
      .sidebar.collapsed .toggle-btn {
        margin-left: 18px;
      }
      .main { flex-grow: 1; display: flex; flex-direction: column; }
      .upload-section { background: #2d3e50; color: #fff; padding: 15px; }
      .upload-section h2 { margin-top: 0; color: #fff; }
      .upload-section p { color: #ddd; }
      .upload-section input { margin-top: 5px; }
      .stats-cards { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
      .stat-card { flex: 1 1 160px; padding: 12px; border-radius: 6px; background: #4a90e2; color: #fff; }
      .stat-card h4 { margin: 0 0 5px 0; font-size: 14px; }
      .stat-card p { margin: 0; font-size: 18px; font-weight: bold; }
      .table-section { background: #fff; flex-grow: 1; overflow: auto; padding: 15px; }
      .info { cursor: pointer; margin-left: 4px; color: #4a90e2; font-weight:bold; }
      /* Allow table header text to wrap on multiple lines */
      #report th {
        white-space: normal;
        word-break: break-word;
      }
      /* upload section layout */
      .upload-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      /* hide default file input */
      #fileInput { display: none; }
      /* styled upload button */
      .upload-btn {
        /* Use a distinct color from the stat cards */
        background: #00b488;
        color: #fff;
        padding: 6px 14px;
        border: none;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
      }
    </style>
</head>
<body>
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button id="toggleBtn" class="toggle-btn">«</button>
            <h3 class="nav-title">产品导航</h3>
            <ul>
                <li><a href="index.html"><span class="abbr">S</span><span class="label">速卖通</span></a></li>
                <li><a href="#"><span class="abbr">T</span><span class="label">TikTok Shop</span></a></li>
                <li><a href="#"><span class="abbr">A</span><span class="label">亚马逊</span></a></li>
                <li><a href="independent_placeholder.html"><span class="abbr">独</span><span class="label">独立站</span></a></li>
            </ul>
        </nav>
        <div class="main">
            <div class="upload-section">
                <h2>速卖通 Excel 数据上传与分析</h2>
                <div class="upload-top">
                    <p class="upload-instruction">请选择包含商品数据的 Excel 文件，系统会自动计算转化率并显示完整数据：</p>
                    <label for="fileInput" class="upload-btn">选择文件</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
                </div>
                <div class="stats-cards">
                    <div class="stat-card" id="card-conv1"><h4>平均访客到加购转化率</h4><p></p></div>
                    <div class="stat-card" id="card-conv2"><h4>平均加购到支付转化率</h4><p></p></div>
                    <div class="stat-card" id="card-visavg"><h4>平均访客比</h4><p></p></div>
                    <div class="stat-card" id="card-total"><h4>产品总数</h4><p></p></div>
                    <div class="stat-card" id="card-addcount"><h4>有加购的产品数</h4><p></p></div>
                    <div class="stat-card" id="card-visitors"><h4>到访客户总数</h4><p></p></div>
                    <div class="stat-card" id="card-paycount"><h4>有支付的产品数</h4><p></p></div>
                </div>
                <button id="saveBtn" style="margin-top: 15px; padding: 8px 14px; font-size: 14px; border: none; border-radius: 4px; background: #4a90e2; color: #fff; cursor: pointer; opacity: 0.6;" disabled>保存到数据库</button>
            </div>
            <div class="table-section">
                <table id="report" class="display" style="width:100%"></table>
            </div>
        </div>
    </div>
<script>
function showInfo(key) {
    var messages = {
        'conv1': '访客到加购转化率 = 商品加购人数 ÷ 商品访客数 × 100%',
        'conv2': '加购到支付转化率 = 支付买家数 ÷ 商品加购人数 × 100%',
        'visRatio': '访客比 = 商品访客数 ÷ 搜索曝光量 × 100%'
    };
    if (messages[key]) alert(messages[key]);
}

function computeAndFormat(dataArray) {
    var results = [];
    for (var i = 0; i < dataArray.length; i++) {
        var row = dataArray[i];
        var productId = row['商品ID'];
        var exposures = row['搜索曝光量'];
        var visitors = row['商品访客数'];
        var views    = row['商品浏览量'];
        var addPeople = row['商品加购人数'];
        var addItems  = row['商品加购件数'];
        var payItems  = row['支付件数'];
        var payOrders = row['支付订单数'];
        var buyers    = row['支付买家数'];
        var exposuresN = parseFloat(exposures);
        var visitorsN  = parseFloat(visitors);
        var addPeopleN = parseFloat(addPeople);
        var buyersN    = parseFloat(buyers);
        var conv1 = '';
        var conv2 = '';
        var visRatio = '';
        if (!isNaN(visitorsN) && visitorsN !== 0 && !isNaN(addPeopleN)) conv1 = ((addPeopleN / visitorsN) * 100).toFixed(2);
        if (!isNaN(addPeopleN) && addPeopleN !== 0 && !isNaN(buyersN)) conv2 = ((buyersN / addPeopleN) * 100).toFixed(2);
        if (!isNaN(exposuresN) && exposuresN !== 0 && !isNaN(visitorsN)) visRatio = ((visitorsN / exposuresN) * 100).toFixed(2);
        var link = productId ? 'https://aliexpress.ru/item/' + productId + '.html' : '';
        
        results.push([
            productId || '',
            link ? '<a href="' + link + '" target="_blank">' + link + '</a>' : '',
            exposures || '',
            visitors || '',
            views || '',
            addPeople || '',
            addItems || '',
            payItems || '',
            payOrders || '',
            buyers || '',
            conv1,
            conv2,
            visRatio
        ]);
    }
    return results;
}

function updateCards(avg1, avg2, avgVis, totalProducts, addProductCount, totalVisitors, payProductCount) {
    document.querySelector('#card-conv1 p').textContent = avg1 + '%';
    document.querySelector('#card-conv2 p').textContent = avg2 + '%';
    document.querySelector('#card-visavg p').textContent = avgVis + '%';
    document.querySelector('#card-total p').textContent = totalProducts;
    document.querySelector('#card-addcount p').textContent = addProductCount;
    document.querySelector('#card-visitors p').textContent = totalVisitors;
    document.querySelector('#card-paycount p').textContent = payProductCount;
}

$(document).ready(function() {
    var table = $('#report').DataTable({
        data: [],
        columns: [
            { title: '商品ID' },
            { title: '产品链接' },
            { title: '搜索曝光量' },
            { title: '商品访客数' },
            { title: '商品浏览量' },
            { title: '商品加购人数' },
            { title: '商品加购件数' },
            { title: '支付件数' },
            { title: '支付订单数' },
            { title: '支付买家数' },
            { title: '访客到加购转化率(%) <span class="info" onclick="showInfo(\'conv1\')">?</span>' },
            { title: '加购到支付转化率(%) <span class="info" onclick="showInfo(\'conv2\')">?</span>' },
            { title: '访客比(%) <span class="info" onclick="showInfo(\'visRatio\')">?</span>' }
        ],
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh.json'
        },
        scrollX: true
    });

    var processedDataToSave = [];
    document.getElementById('fileInput').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(evt) {
            var data = new Uint8Array(evt.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];
            var json = XLSX.utils.sheet_to_json(worksheet, { defval: '', raw: false });
            var processed = computeAndFormat(json);
            processedDataToSave = [];
            for (var i = 0; i < json.length; i++) {
                var obj = json[i];
                var visitorCount = parseFloat(obj['商品访客数']) || 0;
                var addPeople = parseFloat(obj['商品加购人数']) || 0;
                var payBuyers = parseFloat(obj['支付买家数']) || 0;
                var exp = parseFloat(obj['搜索曝光量']) || 0;
                var conv1 = addPeople && visitorCount ? ((addPeople / visitorCount) * 100).toFixed(2) : '0.00';
                var conv2 = payBuyers && addPeople ? ((payBuyers / addPeople) * 100).toFixed(2) : '0.00';
                var visRatio = visitorCount && exp ? ((visitorCount / exp) * 100).toFixed(2) : '0.00';
                processedDataToSave.push({
                    product_id: obj['商品ID'],
                    product_link: 'https://aliexpress.ru/item/' + obj['商品ID'] + '.html',
                    exposure: exp,
                    visitors: visitorCount,
                    views: parseFloat(obj['商品浏览量']) || 0,
                    add_people: addPeople,
                    add_count: parseFloat(obj['商品加购件数']) || 0,
                    pay_items: parseFloat(obj['支付件数']) || 0,
                    pay_orders: parseFloat(obj['支付订单数']) || 0,
                    pay_buyers: payBuyers,
                    visitor_to_add: conv1,
                    add_to_pay: conv2,
                    visitor_ratio: visRatio
                });
            }
            var saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = false;
            saveBtn.style.opacity = 1;
            table.clear();
            table.rows.add(processed).draw();
            // compute stats
            var total1 = 0, count1 = 0, total2 = 0, count2 = 0, totalVis = 0, countVis = 0;
            var totalProducts = json.length;
            var addProductCount = 0, payProductCount = 0, totalVisitors = 0;
            for (var i = 0; i < processed.length; i++) {
                var c1 = parseFloat(processed[i][10]);
                var c2 = parseFloat(processed[i][11]);
                var c3 = parseFloat(processed[i][12]);
                if (!isNaN(c1)) { total1 += c1; count1++; }
                if (!isNaN(c2)) { total2 += c2; count2++; }
                if (!isNaN(c3)) { totalVis += c3; countVis++; }
            }
            for (var i = 0; i < json.length; i++) {
                var row = json[i];
                var addPeopleVal = parseFloat(row['商品加购人数']);
                var payOrdersVal = parseFloat(row['支付订单数']);
                var v = parseFloat(row['商品访客数']);
                if (!isNaN(addPeopleVal) && addPeopleVal > 0) addProductCount++;
                if (!isNaN(payOrdersVal) && payOrdersVal > 0) payProductCount++;
                if (!isNaN(v)) totalVisitors += v;
            }
            var avg1 = count1 ? (total1 / count1).toFixed(2) : '0.00';
            var avg2 = count2 ? (total2 / count2).toFixed(2) : '0.00';
            var avgVis = countVis ? (totalVis / countVis).toFixed(2) : '0.00';
            updateCards(avg1, avg2, avgVis, totalProducts, addProductCount, totalVisitors, payProductCount);
            
            // Collapse sidebar to show only initials after data is loaded
            var sidebar = document.getElementById('sidebar');
            var toggleBtn = document.getElementById('toggleBtn');
            if (sidebar && !sidebar.classList.contains('collapsed')) {
                sidebar.classList.add('collapsed');
                if (toggleBtn) toggleBtn.textContent = '»';
            }
        };
        reader.readAsArrayBuffer(file);
    });

    document.getElementById('saveBtn').addEventListener('click', function() {
        if (processedDataToSave.length === 0) {
            alert('没有可保存的数据。');
            return;
        }
        fetch('/api/submitData', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(processedDataToSave)
        })
        .then(function(response) { return response.json(); })
        .then(function(result) {
            if (result.success) {
                alert('数据已成功保存到数据库。');
            } else {
                alert('保存失败：' + (result.error || '未知错误'));
            }
        })
        .catch(function(err) {
            alert('保存时发生错误：' + err.message);
        });
    });

    // Sidebar toggle button to expand/collapse manually
    document.getElementById('toggleBtn').addEventListener('click', function() {
        var sidebar = document.getElementById('sidebar');
        if (sidebar) {
            var collapsed = sidebar.classList.toggle('collapsed');
            // Update button symbol: « when expanded (can collapse), » when collapsed (can expand)
            this.textContent = collapsed ? '»' : '«';
        }
    });
});
</script>
</body>
</html>
