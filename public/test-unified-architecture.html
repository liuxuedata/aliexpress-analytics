<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»Ÿä¸€è¡¨æ¶æ„æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    .btn:hover {
      background: #0056b3;
    }
    .btn-success {
      background: #28a745;
    }
    .btn-success:hover {
      background: #1e7e34;
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .file-upload {
      border: 2px dashed #ccc;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      margin: 10px 0;
    }
    .file-upload:hover {
      border-color: #007bff;
    }
    .result-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ—ï¸ ç»Ÿä¸€è¡¨æ¶æ„æµ‹è¯•</h1>
  
  <!-- æ¶æ„ä¿¡æ¯ -->
  <div class="test-section">
    <h2>ğŸ“Š æ¶æ„ä¿¡æ¯</h2>
    <div class="result-box">
ç»Ÿä¸€è¡¨æ¶æ„å·²å®æ–½å®Œæˆï¼

è¡¨ç»“æ„ï¼š
â€¢ Facebook Ads â†’ independent_facebook_ads_daily
â€¢ Google Ads â†’ independent_landing_metrics  
â€¢ TikTok Ads â†’ independent_tiktok_ads_daily

ä¼˜åŠ¿ï¼š
âœ… é›¶ç»´æŠ¤æˆæœ¬ï¼šæ–°ç«™ç‚¹æ— éœ€åˆ›å»ºæ–°è¡¨
âœ… æ— é™æ‰©å±•ï¼šæ”¯æŒä»»æ„æ•°é‡ç«™ç‚¹
âœ… ç»Ÿä¸€ç®¡ç†ï¼šæ‰€æœ‰æ•°æ®é›†ä¸­å­˜å‚¨
âœ… æŸ¥è¯¢ä¼˜åŒ–ï¼šè·¨ç«™ç‚¹åˆ†ææ›´å®¹æ˜“
    </div>
  </div>

  <!-- APIæµ‹è¯• -->
  <div class="test-section">
    <h2>ğŸ”Œ APIè¿æ¥æµ‹è¯•</h2>
    <button class="btn" onclick="testAPIs()">æµ‹è¯•æ‰€æœ‰API</button>
    <div id="apiResults"></div>
  </div>

  <!-- ç«™ç‚¹é…ç½®æµ‹è¯• -->
  <div class="test-section">
    <h2>ğŸ¢ ç«™ç‚¹é…ç½®æµ‹è¯•</h2>
    <button class="btn" onclick="testSiteConfigs()">æµ‹è¯•ç«™ç‚¹é…ç½®</button>
    <button class="btn btn-success" onclick="createTestSite()">åˆ›å»ºæµ‹è¯•ç«™ç‚¹</button>
    <div id="siteResults"></div>
  </div>

  <!-- æ•°æ®ä¸Šä¼ æµ‹è¯• -->
  <div class="test-section">
    <h2>ğŸ“¤ æ•°æ®ä¸Šä¼ æµ‹è¯•</h2>
    <div>
      <label>é€‰æ‹©ç«™ç‚¹ï¼š</label>
      <select id="testSiteSelect">
        <option value="">é€‰æ‹©ç«™ç‚¹</option>
      </select>
    </div>
    <div class="file-upload" onclick="document.getElementById('testFile').click()">
      <p>ç‚¹å‡»é€‰æ‹©Facebook Adsæ•°æ®æ–‡ä»¶</p>
      <input type="file" id="testFile" accept=".xlsx,.csv" style="display: none;">
    </div>
    <button class="btn" onclick="testDataUpload()">æµ‹è¯•æ•°æ®ä¸Šä¼ </button>
    <div id="uploadResults"></div>
  </div>

  <!-- æ•°æ®æŸ¥è¯¢æµ‹è¯• -->
  <div class="test-section">
    <h2>ğŸ“Š æ•°æ®æŸ¥è¯¢æµ‹è¯•</h2>
    <button class="btn" onclick="testDataQuery()">æŸ¥è¯¢ç»Ÿä¸€è¡¨æ•°æ®</button>
    <button class="btn btn-success" onclick="testCrossSiteQuery()">è·¨ç«™ç‚¹æŸ¥è¯¢æµ‹è¯•</button>
    <div id="queryResults"></div>
  </div>

  <!-- æ–°ç«™ç‚¹æ·»åŠ æµ‹è¯• -->
  <div class="test-section">
    <h2>â• æ–°ç«™ç‚¹æ·»åŠ æµ‹è¯•</h2>
    <div>
      <input type="text" id="newSiteName" placeholder="æ–°ç«™ç‚¹åç§°" style="padding: 8px; margin: 5px;">
      <input type="text" id="newSiteDomain" placeholder="åŸŸå" style="padding: 8px; margin: 5px;">
      <select id="newSiteDataSource" style="padding: 8px; margin: 5px;">
        <option value="facebook_ads">Facebook Ads</option>
        <option value="google_ads">Google Ads</option>
        <option value="tiktok_ads">TikTok Ads</option>
      </select>
    </div>
    <button class="btn btn-success" onclick="addNewSite()">æ·»åŠ æ–°ç«™ç‚¹</button>
    <div id="newSiteResults"></div>
  </div>

  <script>
    let currentSites = [];

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadSites();
    });

    // åŠ è½½ç«™ç‚¹åˆ—è¡¨
    async function loadSites() {
      try {
        const response = await fetch('/api/site-configs');
        const data = await response.json();
        
        if (data.ok) {
          currentSites = data.data || [];
          updateSiteSelect();
          showStatus('apiResults', 'ç«™ç‚¹åˆ—è¡¨åŠ è½½æˆåŠŸ', 'success');
        } else {
          showStatus('apiResults', 'åŠ è½½ç«™ç‚¹å¤±è´¥: ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('apiResults', 'åŠ è½½ç«™ç‚¹å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ›´æ–°ç«™ç‚¹é€‰æ‹©å™¨
    function updateSiteSelect() {
      const select = document.getElementById('testSiteSelect');
      select.innerHTML = '<option value="">é€‰æ‹©ç«™ç‚¹</option>';
      
      currentSites.forEach(site => {
        select.innerHTML += `<option value="${site.id}">${site.display_name} (${site.data_source})</option>`;
      });
    }

    // æµ‹è¯•æ‰€æœ‰API
    async function testAPIs() {
      const results = [];
      
      // æµ‹è¯•ç«™ç‚¹é…ç½®API
      try {
        const response = await fetch('/api/site-configs');
        const data = await response.json();
        results.push(`ç«™ç‚¹é…ç½®API: ${response.ok ? 'âœ… æ­£å¸¸' : 'âŒ å¤±è´¥'} (${response.status})`);
      } catch (error) {
        results.push(`ç«™ç‚¹é…ç½®API: âŒ é”™è¯¯ - ${error.message}`);
      }

      // æµ‹è¯•æ¨¡æ¿API
      try {
        const response = await fetch('/api/data-source-templates');
        const data = await response.json();
        results.push(`æ¨¡æ¿API: ${response.ok ? 'âœ… æ­£å¸¸' : 'âŒ å¤±è´¥'} (${response.status})`);
      } catch (error) {
        results.push(`æ¨¡æ¿API: âŒ é”™è¯¯ - ${error.message}`);
      }

      // æµ‹è¯•ç»Ÿä¸€Facebook Ads API
      try {
        const response = await fetch('/api/universal-ingest/facebook-ads', {
          method: 'POST',
          headers: { 'X-Site-ID': 'test' }
        });
        results.push(`ç»Ÿä¸€Facebook Ads API: ${response.status === 400 ? 'âœ… æ­£å¸¸(éœ€è¦æ–‡ä»¶)' : 'âŒ å¼‚å¸¸'} (${response.status})`);
      } catch (error) {
        results.push(`ç»Ÿä¸€Facebook Ads API: âŒ é”™è¯¯ - ${error.message}`);
      }

      showStatus('apiResults', results.join('\n'), 'info');
    }

    // æµ‹è¯•ç«™ç‚¹é…ç½®
    async function testSiteConfigs() {
      try {
        const response = await fetch('/api/site-configs');
        const data = await response.json();
        
        if (data.ok) {
          const sites = data.data || [];
          const result = `ç«™ç‚¹é…ç½®æµ‹è¯•æˆåŠŸï¼\n\nç«™ç‚¹æ•°é‡: ${sites.length}\n\nç«™ç‚¹åˆ—è¡¨:\n${sites.map(site => 
            `â€¢ ${site.display_name} (${site.id})\n  å¹³å°: ${site.platform}\n  æ•°æ®æº: ${site.data_source}\n  åŸŸå: ${site.domain || 'N/A'}`
          ).join('\n\n')}`;
          
          showStatus('siteResults', result, 'success');
        } else {
          showStatus('siteResults', 'ç«™ç‚¹é…ç½®æµ‹è¯•å¤±è´¥: ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('siteResults', 'ç«™ç‚¹é…ç½®æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆ›å»ºæµ‹è¯•ç«™ç‚¹
    async function createTestSite() {
      const testSite = {
        name: 'test-unified-site.com',
        platform: 'independent',
        display_name: 'ç»Ÿä¸€æ¶æ„æµ‹è¯•ç«™ç‚¹',
        domain: 'test-unified-site.com',
        data_source: 'facebook_ads',
        template_id: null,
        config_json: { test: true }
      };

      try {
        const response = await fetch('/api/site-configs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testSite)
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showStatus('siteResults', `æµ‹è¯•ç«™ç‚¹åˆ›å»ºæˆåŠŸï¼\nç«™ç‚¹ID: ${data.data.id}\nä½¿ç”¨ç»Ÿä¸€è¡¨: independent_facebook_ads_daily`, 'success');
          loadSites(); // é‡æ–°åŠ è½½ç«™ç‚¹åˆ—è¡¨
        } else {
          showStatus('siteResults', 'åˆ›å»ºæµ‹è¯•ç«™ç‚¹å¤±è´¥: ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('siteResults', 'åˆ›å»ºæµ‹è¯•ç«™ç‚¹å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æµ‹è¯•æ•°æ®ä¸Šä¼ 
    async function testDataUpload() {
      const siteId = document.getElementById('testSiteSelect').value;
      const fileInput = document.getElementById('testFile');
      
      if (!siteId) {
        showStatus('uploadResults', 'è¯·é€‰æ‹©ç«™ç‚¹', 'error');
        return;
      }
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showStatus('uploadResults', 'è¯·é€‰æ‹©æ–‡ä»¶', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      try {
        showStatus('uploadResults', 'æ­£åœ¨ä¸Šä¼ æ•°æ®...', 'info');
        
        const site = currentSites.find(s => s.id === siteId);
        let apiEndpoint;
        let headers = {};
        
        if (site.data_source === 'facebook_ads') {
          apiEndpoint = '/api/universal-ingest/facebook-ads';
          headers['X-Site-ID'] = siteId;
        } else {
          apiEndpoint = `/api/dynamic-ingest/${encodeURIComponent(siteId)}`;
        }
        
        const response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: headers,
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          showStatus('uploadResults', `æ•°æ®ä¸Šä¼ æˆåŠŸï¼\nå¤„ç†è®°å½•: ${result.processed}\næ’å…¥è®°å½•: ${result.upserted}\nç›®æ ‡è¡¨: ${result.table}`, 'success');
        } else {
          showStatus('uploadResults', 'ä¸Šä¼ å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showStatus('uploadResults', 'ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æµ‹è¯•æ•°æ®æŸ¥è¯¢
    async function testDataQuery() {
      try {
        // è¿™é‡Œéœ€è¦åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢APIï¼Œæš‚æ—¶æ¨¡æ‹Ÿ
        showStatus('queryResults', 'æ•°æ®æŸ¥è¯¢æµ‹è¯•åŠŸèƒ½éœ€è¦å®ç°æŸ¥è¯¢API', 'info');
      } catch (error) {
        showStatus('queryResults', 'æŸ¥è¯¢æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      }
    }

    // è·¨ç«™ç‚¹æŸ¥è¯¢æµ‹è¯•
    async function testCrossSiteQuery() {
      try {
        showStatus('queryResults', 'è·¨ç«™ç‚¹æŸ¥è¯¢æµ‹è¯•ï¼š\n\nç»Ÿä¸€è¡¨æ¶æ„æ”¯æŒé€šè¿‡siteå­—æ®µè¿›è¡Œè·¨ç«™ç‚¹åˆ†æ\n\nç¤ºä¾‹æŸ¥è¯¢ï¼š\nSELECT site, COUNT(*) as records, SUM(spend_usd) as total_spend\nFROM independent_facebook_ads_daily\nGROUP BY site\nORDER BY total_spend DESC;', 'info');
      } catch (error) {
        showStatus('queryResults', 'è·¨ç«™ç‚¹æŸ¥è¯¢æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ·»åŠ æ–°ç«™ç‚¹
    async function addNewSite() {
      const name = document.getElementById('newSiteName').value;
      const domain = document.getElementById('newSiteDomain').value;
      const dataSource = document.getElementById('newSiteDataSource').value;
      
      if (!name || !domain) {
        showStatus('newSiteResults', 'è¯·å¡«å†™ç«™ç‚¹åç§°å’ŒåŸŸå', 'error');
        return;
      }

      const newSite = {
        name: name,
        platform: 'independent',
        display_name: `ç‹¬ç«‹ç«™ ${domain}`,
        domain: domain,
        data_source: dataSource,
        template_id: null,
        config_json: null
      };

      try {
        const response = await fetch('/api/site-configs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newSite)
        });
        
        const data = await response.json();
        
        if (response.ok) {
          const tableMapping = {
            'facebook_ads': 'independent_facebook_ads_daily',
            'google_ads': 'independent_landing_metrics',
            'tiktok_ads': 'independent_tiktok_ads_daily'
          };
          
          showStatus('newSiteResults', `æ–°ç«™ç‚¹æ·»åŠ æˆåŠŸï¼\nç«™ç‚¹ID: ${data.data.id}\nä½¿ç”¨ç»Ÿä¸€è¡¨: ${tableMapping[dataSource]}\n\né›¶ç»´æŠ¤æˆæœ¬ï¼šæ— éœ€åˆ›å»ºæ–°è¡¨ï¼Œç«‹å³å¯ç”¨ï¼`, 'success');
          loadSites(); // é‡æ–°åŠ è½½ç«™ç‚¹åˆ—è¡¨
          
          // æ¸…ç©ºè¡¨å•
          document.getElementById('newSiteName').value = '';
          document.getElementById('newSiteDomain').value = '';
        } else {
          showStatus('newSiteResults', 'æ·»åŠ æ–°ç«™ç‚¹å¤±è´¥: ' + data.error, 'error');
        }
      } catch (error) {
        showStatus('newSiteResults', 'æ·»åŠ æ–°ç«™ç‚¹å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status status-${type}">${message}</div>`;
    }
  </script>
</body>
</html>
