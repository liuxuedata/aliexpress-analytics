<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>速卖通报告与导航 - 全托管</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js">document.getElementById('statDate') && (document.getElementById('statDate').valueAsDate = new Date());
</script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js">document.getElementById('statDate') && (document.getElementById('statDate').valueAsDate = new Date());
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">document.getElementById('statDate') && (document.getElementById('statDate').valueAsDate = new Date());
</script>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; }
      .container { display: flex; height: 100vh; }
      .sidebar { width: 220px; background: #2d3e50; color: #fff; padding: 15px; box-sizing: border-box; border-right: 2px solid #444; transition: width 0.3s; }
      .sidebar h3 { margin-top: 0; color: #fff; }
      .sidebar ul { list-style: none; padding-left: 0; }
      .sidebar li { margin-bottom: 10px; }
      .sidebar a { text-decoration: none; color: #ddd; font-size: 14px; display: block; padding: 5px; border-radius: 3px; }
      .sidebar a:hover { color: #fff; text-decoration: underline; }
      .sidebar .submenu { list-style: none; padding-left: 20px; display: none; }
      .sidebar .submenu a { font-size: 13px; color: #bbb; }
      .sidebar .submenu a:hover { color: #fff; }
      .sidebar .submenu a.active { color: #fff; background-color: #4a90e2; }
      .sidebar .has-submenu > a { cursor: pointer; }
      .sidebar .has-submenu.open > .submenu { display: block; }
      .sidebar .abbr { display: none; }
      .sidebar.collapsed { width: 60px; }
      .sidebar.collapsed .nav-title, .sidebar.collapsed .label, .sidebar.collapsed .submenu { display: none; }
      .sidebar.collapsed .abbr { display: block; text-align: center; font-size: 18px; color: #fff; }
      .sidebar.collapsed li { margin-bottom: 20px; }
      .toggle-btn { display: block; margin: 10px; width: 24px; height: 24px; border-radius: 50%; border: none; background: #4a90e2; color: #fff; font-size: 16px; cursor: pointer; text-align: center; line-height: 24px; }
      .sidebar.collapsed .toggle-btn { margin-left: 18px; }
      .main { flex-grow: 1; display: flex; flex-direction: column; }
      .upload-section { background: #2d3e50; color: #fff; padding: 15px; }
      .upload-section h2 { margin-top: 0; color: #fff; }
      .upload-section p { color: #ddd; }
      .upload-section input { margin-top: 5px; }
      .stats-cards { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
      .stat-card { flex: 1 1 160px; padding: 12px; border-radius: 6px; background: #4a90e2; color: #fff; }
      .stat-card h4 { margin: 0 0 5px 0; font-size: 14px; }
      .stat-card p { margin: 0; font-size: 18px; font-weight: bold; }
      .table-section { background: #fff; flex-grow: 1; overflow: auto; padding: 15px; }
      .info { cursor: pointer; margin-left: 4px; color: #4a90e2; font-weight:bold; }
      #report th { white-space: normal; word-break: break-word; }
      .upload-top { display: flex; align-items: center; justify-content: space-between; }
      #fileInput { display: none; }
      .upload-btn { background: #00b488; color: #fff; padding: 6px 14px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; }
    </style>

    <style>
      .stats-cards .stat-card { min-width:180px; flex:1; }
    </style>
    </head>
<body>
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button id="toggleBtn" class="toggle-btn">«</button>
            <h3 class="nav-title">产品导航</h3>
            <ul>
                <li class="has-submenu">
                    <a href="#"><span class="abbr">S</span><span class="label">速卖通</span></a>
                    <ul class="submenu">
                        <li><a href="index.html">全托管</a></li>
                        <li><a href="self-operated.html">自运营</a></li>
                    </ul>
                </li>
                <li><a href="#"><span class="abbr">T</span><span class="label">TikTok Shop</span></a></li>
                <li><a href="#"><span class="abbr">A</span><span class="label">亚马逊</span></a></li>
                <li><a href="indie-shopify.html"><span class="abbr">独</span><span class="label">独立站</span></a></li>
            </ul>
        </nav>
        <div class="main">
            <div class="upload-section">
                <h2>速卖通全托管数据分析</h2>
                <div class="upload-top">
                    <p class="upload-instruction">请选择包含商品数据的 Excel 或 CSV 文件，系统会自动计算转化率并显示完整数据：</p>
                    <label for="fileInput" class="upload-btn">选择文件</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
                </div>
                
                <div class="stats-cards" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                  <div class="stat-card" style="background:#3b82f6">
                    <h4>日期</h4>
                    <p><input type="date" id="statDate" style="width: 150px; padding:6px; border-radius:4px; border:none;"></p>
                  </div>
                  <div class="stat-card" style="background:#3b82f6">
                    <h4>来源</h4>
                    <p>
                      <select id="sourceCode" style="padding:6px; border-radius:4px; border:none;">
                        <option value="SHOPIFY" selected>独立站-Shopify</option>
                        <option value="AE_FBM">速卖通-全托管</option>
                        <option value="AE_SO">速卖通-自运营</option>
                      </select>
                    </p>
                  </div>
                  <div class="stat-card" style="background:#3b82f6">
                    <h4>平台</h4>
                    <p>
                      <select id="platform" style="padding:6px; border-radius:4px; border:none;">
                        <option value="shopify" selected>shopify</option>
                        <option value="aliexpress">aliexpress</option>
                      </select>
                    </p>
                  </div>
                </div>
    
                
                <div class="toolbar" style="display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:10px;">
                  <div style="display:flex; gap:10px; align-items:center;">
                    <label style="color:#cfe3ff;font-weight:600;">日期</label>
                    <input type="date" id="statDate" style="width: 160px; padding:8px 10px; border-radius:6px; border:1px solid #335; background:#0f2239; color:#eaf2ff;">
                    <span class="hint" style="color:#8fb3ff;font-size:12px;">可从文件自动识别，如不准确请手动修改</span>
                  </div>
                  <div style="display:flex; gap:10px; align-items:center;">
                    <button id="saveBtn" class="upload-btn" style="background:#22c55e;border:none;border-radius:8px;padding:10px 14px;color:#fff;cursor:pointer;">保存到数据库</button>
                    <label for="fileInput" class="upload-btn" style="background:#14b8a6;border:none;border-radius:8px;padding:10px 14px;color:#fff;cursor:pointer;">选择文件</label>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display:none;">
                  </div>
                </div>
    
                <div class="stats-cards">
                    <div class="stat-card" id="card-conv1"><h4>平均访客到加购转化率</h4><p></p></div>
                    <div class="stat-card" id="card-conv2"><h4>平均加购到支付转化率</h4><p></p></div>
                    <div class="stat-card" id="card-visavg"><h4>平均访客比</h4><p></p></div>
                    <div class="stat-card" id="card-total"><h4>产品总数</h4><p></p></div>
                    <div class="stat-card" id="card-addcount"><h4>有加购的产品数</h4><p></p></div>
                    <div class="stat-card" id="card-visitors"><h4>到访客户总数</h4><p></p></div>
                    <div class="stat-card" id="card-paycount"><h4>有支付的产品数</h4><p></p></div>
                </div>
                <button id="saveBtn" style="margin-top: 15px; padding: 8px 14px; font-size: 14px; border: none; border-radius: 4px; background: #4a90e2; color: #fff; cursor: pointer; opacity: 0.6;" disabled>保存到数据库</button>
            </div>
            <div class="table-section">
                <table id="report" class="display" style="width:100%"></table>
            </div>
        </div>
    </div>
<script>

// ======== Date inference & Shopify 列名映射 ========
function inferDateFromFilename(filename) {
  const m = filename.match(/(20\d{2})(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])/);
  if (!m) return null;
  return `${m[1]}-${m[2]}-${m[3]}`;
}
function inferDateFromRows(rows) {
  if (!rows || !rows.length) return null;
  const dateKeys = ['Date','date','stat_date','统计日期','统计时间'];
  for (const key of dateKeys) {
    if (Object.prototype.hasOwnProperty.call(rows[0], key)) {
      const vals = Array.from(new Set(rows.map(r => String(r[key] || '').trim()).filter(Boolean)));
      if (vals.length === 1) {
        const v = vals[0].replace(/[-/]/g,'');
        if (/^\d{8}$/.test(v)) {
          return `${v.slice(0,4)}-${v.slice(4,6)}-${v.slice(6,8)}`;
        }
      }
    }
  }
  return null;
}
function normalizeShopifyRow(obj){
  const toNum = v => (v===''||v==null?0:Number(String(v).replace(/,/g,'')));
  // 常见导出字段：Product ID, Product Title, Sessions, Page views, Add to cart, Orders, Units sold, Unique buyers, Revenue
  // 仅保存在统一事实表需要的字段，revenue 会放到 raw 中（后端有 raw jsonb）
  const productId = obj['Product ID'] ?? obj['Variant ID'] ?? obj['product_id'] ?? obj['ID'] ?? obj['id'] ?? '';
  const sessions = toNum(obj['Sessions'] ?? obj['sessions'] ?? obj['Visits'] ?? obj['visitors']);
  const pageviews = toNum(obj['Page views'] ?? obj['Page Views'] ?? obj['pageviews'] ?? obj['views']);
  const addToCart = toNum(obj['Add to cart'] ?? obj['Adds to cart'] ?? obj['add_to_cart'] ?? obj['Add-to-cart'] ?? obj['ATC']);
  const addCount = toNum(obj['Add to cart quantity'] ?? obj['ATC quantity'] ?? obj['add_count']);
  const orders = toNum(obj['Orders'] ?? obj['orders'] ?? obj['Purchases'] ?? obj['pay_orders']);
  const units = toNum(obj['Units sold'] ?? obj['Units Sold'] ?? obj['pay_items']);
  const buyers = toNum(obj['Unique buyers'] ?? obj['Buyers'] ?? obj['pay_buyers']);
  return {
    product_id: String(productId),
    exposure: sessions,           // 暂用 sessions 充当“曝光/流量来源”概念
    visitors: sessions,
    views: pageviews,
    add_people: addToCart,
    add_count: addCount,
    pay_items: units,
    pay_orders: orders,
    pay_buyers: buyers,
    // 其余 revenue 等会在 raw 中保留（由后端存 raw）
  };
}
function autoFillDateFrom(fileName, rows){
  const input = document.getElementById('statDate');
  if (!input) return;
  if (input.value) return;
  const fromRows = inferDateFromRows(rows);
  if (fromRows) { input.value = fromRows; return; }
  const fromName = inferDateFromFilename(fileName);
  if (fromName) input.value = fromName;
}
// ======== END ========

$(document).ready(function() {

document.addEventListener('DOMContentLoaded', function(){ 
  // 隐藏首排旧控件（若仍存在）
  var blocks = document.querySelectorAll('.stats-cards');
  if (blocks && blocks.length) { blocks[0].style.display = 'none'; }
  // 隐藏旧上传按钮
  var ut = document.querySelector('.upload-top');
  if (ut) { ut.querySelectorAll('.upload-btn').forEach(function(btn){ btn.style.display='none'; }); }
  // 默认日期=今天
  var sd = document.getElementById('statDate');
  if (sd) { try { sd.valueAsDate = new Date(); } catch(e){} }
});

    // --- START: Sidebar Active Link Logic ---
    var currentPage = window.location.pathname.split("/").pop();
    if (currentPage === "" || currentPage === "index.html") { // Default to index.html
        $('a[href="index.html"]').addClass('active');
    } else {
        $('.sidebar a[href="' + currentPage + '"]').addClass('active');
    }
    // Ensure the parent menu of the active link is open
    $('.sidebar a.active').closest('.has-submenu').addClass('open');
    // --- END: Sidebar Active Link Logic ---

    // Sidebar submenu toggle logic
    $('.has-submenu > a').on('click', function(e) {
        e.preventDefault();
        $(this).parent().toggleClass('open');
    });

    // Sidebar collapse button
    $('#toggleBtn').on('click', function() {
        var sidebar = $('#sidebar');
        var collapsed = sidebar.toggleClass('collapsed').hasClass('collapsed');
        this.textContent = collapsed ? '»' : '«';
    });

    // --- The rest of your page-specific JavaScript ---
    var table = $('#report').DataTable({
        data: [],
        columns: [
            { title: '商品ID' }, { title: '产品链接' }, { title: '搜索曝光量' }, { title: '商品访客数' },
            { title: '商品浏览量' }, { title: '商品加购人数' }, { title: '商品加购件数' }, { title: '支付件数' },
            { title: '支付订单数' }, { title: '支付买家数' },
            { title: '访客到加购转化率(%) <span class="info" onclick="showInfo(\'conv1\')">?</span>' },
            { title: '加购到支付转化率(%) <span class="info" onclick="showInfo(\'conv2\')">?</span>' },
            { title: '访客比(%) <span class="info" onclick="showInfo(\'visRatio\')">?</span>' }
        ],
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh.json' },
        scrollX: true
    });

    var processedDataToSave = [];
    $('#fileInput').on('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(evt) {
            var data = new Uint8Array(evt.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];
            var json = XLSX.utils.sheet_to_json(worksheet, { defval: '', raw: false });
            var processed = computeAndFormat(json);
            
            processedDataToSave = buildDataForSave(json);
            autoFillDateFrom(file.name, json);

            $('#saveBtn').prop('disabled', false).css('opacity', 1);
            table.clear().rows.add(processed).draw();
            
            updateStats(json, processed);

            if (!$('#sidebar').hasClass('collapsed')) {
                $('#sidebar').addClass('collapsed');
                $('#toggleBtn').text('»');
            }
        };
        reader.readAsArrayBuffer(file);
    });

    $('#saveBtn').on('click', function() {
        if (processedDataToSave.length === 0) {
            alert('没有可保存的数据。');
            return;
        }
        fetch('/api/submitData', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_code: 'SHOPIFY', platform: 'shopify', stat_date: document.getElementById('statDate').value || new Date().toISOString().slice(0,10), rows: processedDataToSave })
        })
        .then(response => response.json())
        .then(result => {
            alert(result.success ? '数据已成功保存到数据库。' : '保存失败：' + (result.error || '未知错误'));
        })
        .catch(err => alert('保存时发生错误：' + err.message));
    });
});

function showInfo(key) {
    var messages = {
        'conv1': '访客到加购转化率 = 商品加购人数 ÷ 商品访客数 × 100%',
        'conv2': '加购到支付转化率 = 支付买家数 ÷ 商品加购人数 × 100%',
        'visRatio': '访客比 = 商品访客数 ÷ 搜索曝光量 × 100%'
    };
    if (messages[key]) alert(messages[key]);
}

function computeAndFormat(dataArray) {
    return dataArray.map(row => {
        var productId = row['商品ID'];
        var exposures = parseFloat(row['搜索曝光量']) || 0;
        var visitors = parseFloat(row['商品访客数']) || 0;
        var addPeople = parseFloat(row['商品加购人数']) || 0;
        var buyers = parseFloat(row['支付买家数']) || 0;
        
        var conv1 = visitors ? (addPeople / visitors * 100).toFixed(2) : '0.00';
        var conv2 = addPeople ? (buyers / addPeople * 100).toFixed(2) : '0.00';
        var visRatio = exposures ? (visitors / exposures * 100).toFixed(2) : '0.00';
        
        var link = productId ? `<a href="https://aliexpress.com/item/${productId}.html" target="_blank">${productId}</a>` : '';
        
        return [
            productId || '', link, row['搜索曝光量'] || '', row['商品访客数'] || '', row['商品浏览量'] || '',
            row['商品加购人数'] || '', row['商品加购件数'] || '', row['支付件数'] || '',
            row['支付订单数'] || '', row['支付买家数'] || '', conv1, conv2, visRatio
        ];
    });
}

function buildDataForSave(dataArray) {
    return dataArray.map(obj => {
        const n = normalizeShopifyRow(obj);
        const visitors = +n.visitors || 0;
        const add_people = +n.add_people || 0;
        const pay_buyers = +n.pay_buyers || 0;
        const exposure = +n.exposure || 0;
        return {
          product_id: n.product_id,
          exposure: exposure,
          visitors: visitors,
          views: +n.views || 0,
          add_people: add_people,
          add_count: +n.add_count || 0,
          pay_items: +n.pay_items || 0,
          pay_orders: +n.pay_orders || 0,
          pay_buyers: pay_buyers,
          visitor_to_add: visitors ? +((add_people/visitors)*100).toFixed(2) : 0,
          add_to_pay: add_people ? +((pay_buyers/add_people)*100).toFixed(2) : 0,
          visitor_ratio: exposure ? +((visitors/exposure)*100).toFixed(2) : 0
        };
    }).filter(r => r.product_id);
}
    return dataArray.map(obj => {
        var visitorCount = parseFloat(obj['商品访客数']) || 0;
        var addPeople = parseFloat(obj['商品加购人数']) || 0;
        var payBuyers = parseFloat(obj['支付买家数']) || 0;
        var exp = parseFloat(obj['搜索曝光量']) || 0;
        return {
            product_id: obj['商品ID'],
            product_link: `https://aliexpress.com/item/${obj['商品ID']}.html`,
            exposure: exp, visitors: visitorCount, views: parseFloat(obj['商品浏览量']) || 0,
            add_people: addPeople, add_count: parseFloat(obj['商品加购件数']) || 0,
            pay_items: parseFloat(obj['支付件数']) || 0, pay_orders: parseFloat(obj['支付订单数']) || 0, pay_buyers: payBuyers,
            visitor_to_add: visitorCount ? (addPeople / visitorCount * 100).toFixed(2) : '0.00',
            add_to_pay: addPeople ? (payBuyers / addPeople * 100).toFixed(2) : '0.00',
            visitor_ratio: exp ? (visitorCount / exp * 100).toFixed(2) : '0.00'
        };
    });
}

function updateStats(json, processed) {
    let total1 = 0, count1 = 0, total2 = 0, count2 = 0, totalVis = 0, countVis = 0;
    processed.forEach(row => {
        let c1 = parseFloat(row[10]); if (!isNaN(c1)) { total1 += c1; count1++; }
        let c2 = parseFloat(row[11]); if (!isNaN(c2)) { total2 += c2; count2++; }
        let c3 = parseFloat(row[12]); if (!isNaN(c3)) { totalVis += c3; countVis++; }
    });

    let addProductCount = 0, payProductCount = 0, totalVisitors = 0;
    json.forEach(row => {
        if (parseFloat(row['商品加购人数']) > 0) addProductCount++;
        if (parseFloat(row['支付订单数']) > 0) payProductCount++;
        totalVisitors += parseFloat(row['商品访客数']) || 0;
    });

    updateCards(
        count1 ? (total1 / count1).toFixed(2) : '0.00',
        count2 ? (total2 / count2).toFixed(2) : '0.00',
        countVis ? (totalVis / countVis).toFixed(2) : '0.00',
        json.length, addProductCount, totalVisitors, payProductCount
    );
}

function updateCards(avg1, avg2, avgVis, totalProducts, addProductCount, totalVisitors, payProductCount) {
    $('#card-conv1 p').text(avg1 + '%');
    $('#card-conv2 p').text(avg2 + '%');
    $('#card-visavg p').text(avgVis + '%');
    $('#card-total p').text(totalProducts);
    $('#card-addcount p').text(addProductCount);
    $('#card-visitors p').text(totalVisitors);
    $('#card-paycount p').text(payProductCount);
}
document.getElementById('statDate') && (document.getElementById('statDate').valueAsDate = new Date());
</script>
</body>

</html>

