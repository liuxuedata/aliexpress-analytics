<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>速卖通报告与导航 - 全托管（修复版）</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    .container { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; background: #2d3e50; color: #fff; padding: 15px; box-sizing: border-box; border-right: 2px solid #444; transition: width 0.3s; }
    .sidebar h3 { margin-top: 0; color: #fff; }
    .sidebar ul { list-style: none; padding-left: 0; }
    .sidebar li { margin-bottom: 10px; }
    .sidebar a { text-decoration: none; color: #ddd; font-size: 14px; display: block; padding: 5px; border-radius: 3px; }
    .sidebar a:hover { color: #fff; text-decoration: underline; }
    .sidebar .submenu { list-style: none; padding-left: 20px; display: none; }
    .sidebar .submenu a { font-size: 13px; color: #bbb; }
    .sidebar .submenu a:hover { color: #fff; }
    .sidebar .submenu a.active { color: #fff; background-color: #4a90e2; }
    .sidebar .has-submenu > a { cursor: pointer; }
    .sidebar .has-submenu.open > .submenu { display: block; }
    .sidebar .abbr { display: none; }
    .sidebar.collapsed { width: 60px; }
    .sidebar.collapsed .nav-title, .sidebar.collapsed .label, .sidebar.collapsed .submenu { display: none; }
    .sidebar.collapsed .abbr { display: block; text-align: center; font-size: 18px; color: #fff; }
    .sidebar.collapsed li { margin-bottom: 20px; }
    .toggle-btn { display: block; margin: 10px; width: 24px; height: 24px; border-radius: 50%; border: none; background: #4a90e2; color: #fff; font-size: 16px; cursor: pointer; text-align: center; line-height: 24px; }
    .sidebar.collapsed .toggle-btn { margin-left: 18px; }
    .main { flex-grow: 1; display: flex; flex-direction: column; }
    .upload-section { background: #2d3e50; color: #fff; padding: 15px; }
    .upload-section h2 { margin-top: 0; color: #fff; }
    .upload-section p { color: #ddd; }
    .stats-cards { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .stat-card { flex: 1 1 160px; padding: 12px; border-radius: 6px; background: #4a90e2; color: #fff; }
    .stat-card h4 { margin: 0 0 5px 0; font-size: 14px; }
    .stat-card p { margin: 0; font-size: 18px; font-weight: bold; }
    .table-section { background: #fff; flex-grow: 1; overflow: auto; padding: 15px; }
    .info { cursor: pointer; margin-left: 4px; color: #4a90e2; font-weight:bold; }
    #report th { white-space: normal; word-break: break-word; }
    .upload-top { display: flex; align-items: center; justify-content: space-between; }
    #fileInput { display: none; }
    .upload-btn { background: #00b488; color: #fff; padding: 6px 14px; border: none; border-radius: 20px; font-size: 14px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
<div class="container">
  <nav class="sidebar" id="sidebar">
    <button id="toggleBtn" class="toggle-btn">«</button>
    <h3 class="nav-title">产品导航</h3>
    <ul>
      <li class="has-submenu">
        <a href="#"><span class="abbr">S</span><span class="label">速卖通</span></a>
        <ul class="submenu">
          <li><a href="index.html">全托管</a></li>
          <li><a href="self-operated.html">自运营</a></li>
        </ul>
      </li>
      <li><a href="#"><span class="abbr">T</span><span class="label">TikTok Shop</span></a></li>
      <li><a href="#"><span class="abbr">A</span><span class="label">亚马逊</span></a></li>
      <li><a href="indie-shopify.html"><span class="abbr">独</span><span class="label">独立站</span></a></li>
    </ul>
  </nav>
  <div class="main">
    <div class="upload-section">
      <h2>速卖通全托管数据分析</h2>
      <div class="upload-top">
        <p class="upload-instruction">请选择包含商品数据的 Excel 或 CSV 文件，系统会自动计算转化率并显示完整数据：</p>
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="date" id="statDate" style="padding:6px; border-radius:6px; border:1px solid #325; background:#19324d; color:#fff;">
          <button id="saveBtn" class="upload-btn" disabled style="opacity:.6">保存到数据库</button>
          <label for="fileInput" class="upload-btn">选择文件</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
        </div>
      </div>
      <div class="stats-cards">
        <div class="stat-card" id="card-conv1"><h4>平均访客到加购转化率</h4><p></p></div>
        <div class="stat-card" id="card-conv2"><h4>平均加购到支付转化率</h4><p></p></div>
        <div class="stat-card" id="card-visavg"><h4>平均访客比</h4><p></p></div>
        <div class="stat-card" id="card-total"><h4>产品总数</h4><p></p></div>
        <div class="stat-card" id="card-addcount"><h4>有加购的产品数</h4><p></p></div>
        <div class="stat-card" id="card-visitors"><h4>到访客户总数</h4><p></p></div>
        <div class="stat-card" id="card-paycount"><h4>有支付的产品数</h4><p></p></div>
      </div>
    </div>
    <div class="table-section">
      <table id="report" class="display" style="width:100%"></table>
    </div>
  </div>
</div>
<script>
// Sidebar interactions
(function(){
  document.querySelectorAll('.has-submenu > a').forEach(a => {
    a.addEventListener('click', e => {
      e.preventDefault();
      a.parentElement.classList.toggle('open');
    });
  });
  document.getElementById('toggleBtn').addEventListener('click', function(){
    var sidebar = document.getElementById('sidebar');
    var collapsed = sidebar.classList.toggle('collapsed');
    this.textContent = collapsed ? '»' : '«';
  });
  const today = new Date();
  const d = document.getElementById('statDate'); if (d) d.valueAsDate = today;
})();

// DataTable
const table = $('#report').DataTable({
  data: [],
  columns: [
    { title: '商品ID' }, { title: '产品链接' }, { title: '搜索曝光量' }, { title: '商品访客数' },
    { title: '商品浏览量' }, { title: '商品加购人数' }, { title: '商品加购件数' }, { title: '支付件数' },
    { title: '支付订单数' }, { title: '支付买家数' },
    { title: '访客到加购转化率(%) <span class="info" onclick="showInfo(\\'conv1\\')">?</span>' },
    { title: '加购到支付转化率(%) <span class="info" onclick="showInfo(\\'conv2\\')">?</span>' },
    { title: '访客比(%) <span class="info" onclick="showInfo(\\'visRatio\\')">?</span>' }
  ],
  language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh.json' },
  scrollX: true
});

function showInfo(key){
  const m = {
    conv1: '访客到加购转化率 = 商品加购人数 ÷ 商品访客数 × 100%',
    conv2: '加购到支付转化率 = 支付买家数 ÷ 商品加购人数 × 100%',
    visRatio: '访客比 = 商品访客数 ÷ 搜索曝光量 × 100%'
  }; alert(m[key] || '');
}

function toNum(v){ if (v===null||v===undefined||v==='') return 0; return Number(String(v).replace(/,/g,'').trim()) || 0; }

// Choose the best sheet (one that has 商品ID/Product ID)
function pickBestSheet(wb){
  for (const name of wb.SheetNames){
    const ws = wb.Sheets[name];
    const arr = XLSX.utils.sheet_to_json(ws, { defval: '' });
    if (arr.length){
      const keys = Object.keys(arr[0]).map(k=>String(k).trim());
      if (keys.includes('商品ID') || keys.includes('商品id') || keys.includes('Product ID') || keys.includes('ID') || keys.includes('id')) {
        return arr;
      }
    }
  }
  // fallback first
  return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
}

function computeAndFormat(rows){
  return rows.map(r => {
    const productId = r['商品ID'] || r['商品id'] || r['Product ID'] || r['ID'] || r['id'] || '';
    const exposures = toNum(r['搜索曝光量'] ?? r['曝光量'] ?? r['商品曝光量']);
    const visitors = toNum(r['商品访客数'] ?? r['访客数']);
    const views = toNum(r['商品浏览量'] ?? r['浏览量']);
    const addPeople = toNum(r['商品加购人数'] ?? r['加购人数']);
    const addCount = toNum(r['商品加购件数'] ?? r['加购件数']);
    const payItems = toNum(r['支付件数']);
    const payOrders = toNum(r['支付订单数'] ?? r['订单数']);
    const payBuyers = toNum(r['支付买家数'] ?? r['支付人数'] ?? r['买家数']);

    const conv1 = visitors ? (addPeople / visitors * 100).toFixed(2) : '0.00';
    const conv2 = addPeople ? (payBuyers / addPeople * 100).toFixed(2) : '0.00';
    const visRatio = exposures ? (visitors / exposures * 100).toFixed(2) : '0.00';

    const link = productId ? `<a href="https://aliexpress.com/item/${productId}.html" target="_blank">${productId}</a>` : '';

    return [
      productId, link, exposures, visitors, views,
      addPeople, addCount, payItems, payOrders, payBuyers,
      conv1, conv2, visRatio
    ];
  });
}

function buildDataForSave(rows){
  return rows.map(r => {
    const productId = r['商品ID'] || r['商品id'] || r['Product ID'] || r['ID'] || r['id'] || '';
    if (!productId) return null;
    const exposure = toNum(r['搜索曝光量'] ?? r['曝光量'] ?? r['商品曝光量']);
    const visitors = toNum(r['商品访客数'] ?? r['访客数']);
    const views = toNum(r['商品浏览量'] ?? r['浏览量']);
    const add_people = toNum(r['商品加购人数'] ?? r['加购人数']);
    const add_count = toNum(r['商品加购件数'] ?? r['加购件数']);
    const pay_items = toNum(r['支付件数']);
    const pay_orders = toNum(r['支付订单数'] ?? r['订单数']);
    const pay_buyers = toNum(r['支付买家数'] ?? r['支付人数'] ?? r['买家数']);
    const visitor_to_add = visitors ? +( (add_people / visitors) * 100 ).toFixed(2) : 0;
    const add_to_pay = add_people ? +( (pay_buyers / add_people) * 100 ).toFixed(2) : 0;
    const visitor_ratio = exposure ? +( (visitors / exposure) * 100 ).toFixed(2) : 0;
    return {
      product_id: String(productId),
      product_link: productId ? `https://aliexpress.com/item/${productId}.html` : '',
      exposure, visitors, views, add_people, add_count, pay_items, pay_orders, pay_buyers,
      visitor_to_add, add_to_pay, visitor_ratio
    };
  }).filter(Boolean);
}

function updateStats(rows, processed){
  let conv1Sum=0, conv2Sum=0, visSum=0, c1=0, c2=0, c3=0;
  processed.forEach(a => {
    const v1 = Number(a[10]); if (!isNaN(v1)) { conv1Sum += v1; c1++; }
    const v2 = Number(a[11]); if (!isNaN(v2)) { conv2Sum += v2; c2++; }
    const v3 = Number(a[12]); if (!isNaN(v3)) { visSum += v3; c3++; }
  });
  const addCount = rows.reduce((acc,r)=> acc + (toNum(r['商品加购人数'] ?? r['加购人数']) > 0 ? 1 : 0), 0);
  const payCount = rows.reduce((acc,r)=> acc + (toNum(r['支付订单数'] ?? r['订单数']) > 0 ? 1 : 0), 0);
  const visitorsTotal = rows.reduce((acc,r)=> acc + toNum(r['商品访客数'] ?? r['访客数']), 0);

  $('#card-conv1 p').text((c1? (conv1Sum/c1).toFixed(2) : '0.00') + '%');
  $('#card-conv2 p').text((c2? (conv2Sum/c2).toFixed(2) : '0.00') + '%');
  $('#card-visavg p').text((c3? (visSum/c3).toFixed(2) : '0.00') + '%');
  $('#card-total p').text(rows.length);
  $('#card-addcount p').text(addCount);
  $('#card-visitors p').text(visitorsTotal);
  $('#card-paycount p').text(payCount);
}

// File handler
document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, { type: 'array' });
  const rows = pickBestSheet(wb);

  const processed = computeAndFormat(rows);
  table.clear().rows.add(processed).draw();
  updateStats(rows, processed);

  // enable save
  window.__rowsToSave = buildDataForSave(rows);
  document.getElementById('saveBtn').disabled = window.__rowsToSave.length === 0;
  document.getElementById('saveBtn').style.opacity = window.__rowsToSave.length ? 1 : .6;
});

// Save
document.getElementById('saveBtn').addEventListener('click', async () => {
  const rows = window.__rowsToSave || [];
  if (!rows.length){ alert('没有可保存的数据'); return; }
  const stat_date = document.getElementById('statDate').value || new Date().toISOString().slice(0,10);
  const payload = { source_code: 'AE_FBM', platform: 'aliexpress', stat_date, rows };
  const resp = await fetch('/api/submitData', {
    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
  });
  const json = await resp.json();
  alert(json.success ? ('入库成功：' + (json.count || rows.length) + '条') : ('入库失败：' + (json.error || '未知错误')));
});
</script>
</body>
</html>
