<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç®¡ç†åå° Â· è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250810d">
  <link rel="stylesheet" href="assets/global-theme.css">
  <script src="assets/site-nav.js" defer></script>
  <style>
    body.fm {
      background: #f3f4f6;
    }
    .admin-layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: calc(100vh - 64px);
    }
    .admin-sidebar {
      background: #111827;
      color: #f9fafb;
      padding: 24px 0;
    }
    .admin-sidebar .site-header {
      padding: 0 24px 16px;
      font-size: 18px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .admin-sidebar .sub-nav {
      list-style: none;
      margin: 16px 0 0;
      padding: 0;
    }
    .admin-sidebar .sub-nav li a {
      display: block;
      padding: 12px 24px;
      color: rgba(255,255,255,0.75);
      text-decoration: none;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .admin-sidebar .sub-nav li a.active,
    .admin-sidebar .sub-nav li a:hover {
      background: rgba(59,130,246,0.12);
      color: #fff;
    }
    .admin-main {
      padding: 32px;
      overflow-y: auto;
    }
    .admin-section {
      display: none;
    }
    .admin-section.active {
      display: block;
      animation: fadeIn 0.25s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }
    .section-header h1 {
      margin: 0;
      font-size: 24px;
      color: #111827;
    }
    .section-subtitle {
      color: #6b7280;
      font-size: 14px;
    }
    .admin-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
    }
    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .form-group label {
      font-weight: 500;
      color: #374151;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
    }
    .form-actions {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn:hover {
      background: #f9fafb;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-secondary {
      background: #111827;
      border-color: #111827;
      color: #f9fafb;
    }
    .btn-danger {
      background: #ef4444;
      border-color: #ef4444;
      color: #fff;
    }
    .btn-danger:hover {
      background: #dc2626;
      border-color: #dc2626;
    }
    .btn-success {
      background: #059669;
      border-color: #059669;
      color: #fff;
    }
    .btn-outline {
      background: transparent;
      border-style: dashed;
    }
    .quick-templates {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }
    .role-grid,
    .user-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }
    .role-card,
    .user-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      background: #fff;
      box-shadow: 0 1px 2px rgba(15,23,42,0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .role-card h3,
    .user-card h3 {
      margin: 0;
      font-size: 18px;
      color: #1f2937;
    }
    .role-meta,
    .user-meta {
      color: #6b7280;
      font-size: 13px;
      line-height: 1.6;
    }
    .user-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
    }
    .role-modules {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
    }
    .role-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #374151;
      background: #f9fafb;
      border-radius: 9999px;
      padding: 6px 12px;
      border: 1px solid #e5e7eb;
    }
    .role-checkbox input {
      margin: 0;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 9999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 12px;
      margin: 2px 4px 2px 0;
      white-space: nowrap;
    }
    .chip-muted {
      background: #f3f4f6;
      color: #6b7280;
    }
    select[multiple] {
      min-height: 120px;
    }
    .multi-select-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: -4px;
    }
    .site-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(16,185,129,0.05));
    }
    .site-card h3 {
      margin: 0;
      font-size: 18px;
      color: #1f2937;
    }
    .site-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      font-size: 13px;
      color: #4b5563;
    }
    .site-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .message.info {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }
    .message.success {
      background: #ecfdf5;
      color: #047857;
      border: 1px solid #a7f3d0;
    }
    .message.error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .permissions-table {
      width: 100%;
      border-collapse: collapse;
    }
    .permissions-table thead th {
      text-align: left;
      font-size: 13px;
      letter-spacing: 0.02em;
      color: #6b7280;
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .permissions-table tbody td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
    }
    .permissions-table tbody tr:nth-child(odd) {
      background: #f9fafb;
    }
    .permissions-table .module-label {
      font-weight: 600;
      color: #1f2937;
    }
    .matrix-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 12px;
      background: #e0f2fe;
      color: #0369a1;
      margin-left: 6px;
    }
    @media (max-width: 960px) {
      .admin-layout {
        grid-template-columns: 1fr;
      }
      .admin-sidebar {
        display: flex;
        overflow-x: auto;
      }
      .admin-sidebar .site-header {
        display: none;
      }
      .admin-sidebar .sub-nav {
        display: flex;
        width: 100%;
      }
      .admin-sidebar .sub-nav li {
        flex: 1;
      }
    }
  </style>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
        <div class="form-subtitle">ç™»å½•è´¦æˆ·ä»¥ç»§ç»­</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">é‚®ç®±</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">å¯†ç </label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">ğŸ‘ï¸</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">ç™»å½•</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">æ¼”ç¤ºè´¦æˆ·</div>
        <div class="demo-account-info">é‚®ç®±ï¼šdemo@example.com<br>å¯†ç ï¼šdemo123</div>
      </div>
    </div>
  </div>
</div>

<header class="header">
  <div class="logo-title">è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="self-operated.html">é€Ÿå–é€š</a></li>
      <li class="amazon"><a href="amazon-overview.html">äºšé©¬é€Š</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-analysis.html">Ozon</a></li>
      <li class="independent"><a href="independent-site.html">ç‹¬ç«‹ç«™</a></li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>

<div class="admin-layout">
  <nav class="sidebar admin-sidebar">
    <div class="site-header">ç®¡ç†åå°</div>
    <ul class="sub-nav" id="adminNav">
      <li><a href="#" class="active" data-target="siteConsole">ç«™ç‚¹ç®¡ç†</a></li>
      <li><a href="#" data-target="roleConsole">è§’è‰²ç®¡ç†</a></li>
      <li><a href="#" data-target="permissionConsole">æƒé™çŸ©é˜µ</a></li>
      <li><a href="#" data-target="userConsole">ç”¨æˆ·ç®¡ç†</a></li>
      <li><a href="#" data-target="syncConsole">åŒæ­¥å·¥å…·</a></li>
    </ul>
  </nav>

  <main class="main admin-main">
    <div id="adminMessage" class="message info" style="display:none"></div>

    <section id="siteConsole" class="admin-section active">
      <div class="section-header">
        <div>
          <h1>ç«™ç‚¹é…ç½®ä¸­å¿ƒ</h1>
          <div class="section-subtitle">é€šè¿‡ `site_configs` æ³¨å†Œæ–°ç«™ç‚¹ï¼Œè‡ªåŠ¨ä¸ç«™ç‚¹æ¨¡å—ã€æ¸ é“é…ç½®ä¸å¯¼èˆªè”åŠ¨ã€‚</div>
        </div>
        <button class="btn btn-outline" id="refreshSitesBtn">åˆ·æ–°åˆ—è¡¨</button>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">å¿«æ·æ¨¡æ¿</h2>
        <p class="section-subtitle">ä¸€é”®å¡«å……å¸¸è§ç«™ç‚¹çš„åŸºç¡€å­—æ®µï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´åå†æäº¤ã€‚</p>
        <div class="quick-templates" id="quickTemplates"></div>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">åˆ›å»º / æ›´æ–°ç«™ç‚¹</h2>
        <form id="siteForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="platformSelect">å¹³å° *</label>
              <select id="platformSelect" required></select>
            </div>
            <div class="form-group">
              <label for="siteNameInput">ç«™ç‚¹åç§° *</label>
              <input id="siteNameInput" placeholder="å¦‚ï¼šrobot æˆ– flagship" required>
            </div>
            <div class="form-group">
              <label for="displayNameInput">æ˜¾ç¤ºåç§° *</label>
              <input id="displayNameInput" placeholder="å¦‚ï¼šé€Ÿå–é€šè‡ªè¿è¥ Robot" required>
            </div>
            <div class="form-group">
              <label for="domainInput">åŸŸå / æ ‡è¯†</label>
              <input id="domainInput" placeholder="å¦‚ï¼šrobot.aliexpress.com">
            </div>
            <div class="form-group">
              <label for="dataSourceSelect">æ•°æ®æº *</label>
              <select id="dataSourceSelect" required></select>
            </div>
            <div class="form-group">
              <label for="templateSelect">æ•°æ®æ¨¡æ¿</label>
              <select id="templateSelect">
                <option value="">è‡ªåŠ¨é€‰æ‹©</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="margin-top:12px;">
            <label for="configJsonInput">é…ç½®ä¿¡æ¯ (JSONï¼Œå¯å« API Key å¼•ç”¨)</label>
            <textarea id="configJsonInput" rows="4" placeholder='{"api_key_ref":"vault://..."}'></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">ä¿å­˜ç«™ç‚¹</button>
            <button type="button" class="btn" id="resetSiteForm">é‡ç½®</button>
          </div>
        </form>
      </div>

      <div class="admin-card">
        <div class="section-header" style="margin-bottom:12px;">
          <div>
            <h2 style="margin:0">å·²æ³¨å†Œç«™ç‚¹</h2>
            <div class="section-subtitle">å…± <span id="siteCount">0</span> ä¸ªç«™ç‚¹ï¼Œæ–°å¢åä¼šè‡ªåŠ¨å‡ºç°åœ¨å‰ç«¯å¯¼èˆªä¸æ¨¡å—é…ç½®ä¸­ã€‚</div>
          </div>
          <select id="platformFilter" class="btn" style="min-width:180px;">
            <option value="">å…¨éƒ¨å¹³å°</option>
          </select>
        </div>
        <div class="admin-grid" id="siteList"></div>
      </div>
    </section>

    <section id="roleConsole" class="admin-section">
      <div class="section-header">
        <div>
          <h1>è§’è‰²ç®¡ç†</h1>
          <div class="section-subtitle">å®šä¹‰å„è§’è‰²çš„é»˜è®¤è®¿é—®èŒƒå›´ï¼Œå¹¶ä¸æƒé™çŸ©é˜µä¿æŒåŒæ­¥ã€‚</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" id="resetRoleBtn">æ¢å¤é»˜è®¤</button>
          <button class="btn btn-primary" id="saveRoleBtn">ä¿å­˜è§’è‰²é…ç½®</button>
        </div>
      </div>

      <div class="admin-card">
        <div class="role-grid" id="roleList"></div>
        <p class="section-subtitle">è§’è‰²æƒé™å½“å‰å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­ï¼Œåç«¯æƒé™ä¸­å¿ƒä¸Šçº¿åå°†å†™å…¥æ•°æ®åº“å¹¶æ”¯æŒå®¡è®¡ã€‚</p>
      </div>
    </section>

    <section id="permissionConsole" class="admin-section">
      <div class="section-header">
        <div>
          <h1>æƒé™çŸ©é˜µ</h1>
          <div class="section-subtitle">åŸºäº `rules.json` é»˜è®¤ç­–ç•¥ç®¡ç†æ¨¡å—å¯è§æ€§ï¼Œå¯æŒ‰ç«™ç‚¹è¦†å†™ã€‚</div>
        </div>
        <div class="matrix-controls">
          <select id="permissionSiteSelect" class="btn">
            <option value="">å…¨å±€é»˜è®¤</option>
          </select>
          <button class="btn" id="resetPermissionBtn">æ¢å¤é»˜è®¤</button>
        </div>
      </div>

      <div class="admin-card">
        <table class="permissions-table">
          <thead>
            <tr>
              <th style="width:180px">æ¨¡å—</th>
              <th>æè¿°</th>
              <th>è§’è‰²è®¿é—®</th>
            </tr>
          </thead>
          <tbody id="permissionMatrix"></tbody>
        </table>
        <div class="form-actions">
          <button class="btn btn-primary" id="savePermissionBtn">ä¿å­˜é…ç½®</button>
          <button class="btn" id="exportPermissionBtn">å¤åˆ¶ JSON</button>
        </div>
        <p class="section-subtitle">ä¿å­˜æ“ä½œä¼šåœ¨æµè§ˆå™¨å†…ç¼“å­˜é…ç½®ï¼Œåç«¯å†™å…¥æ¥å£å°†åœ¨æƒé™ä¸­å¿ƒä¸Šçº¿æ—¶æ¥å…¥ã€‚</p>
      </div>
    </section>

    <section id="userConsole" class="admin-section">
      <div class="section-header">
        <div>
          <h1>ç”¨æˆ·ç®¡ç†</h1>
          <div class="section-subtitle">ä¸ºæˆå‘˜åˆ†é…è§’è‰²ä¸ç«™ç‚¹èŒƒå›´ï¼Œä¸åŒè§’è‰²å°†ç»§æ‰¿ç›¸åº”æ¨¡å—æƒé™ã€‚</div>
        </div>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">æ–°å¢ / ç¼–è¾‘ç”¨æˆ·</h2>
        <form id="userForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="userNameInput">å§“å *</label>
              <input id="userNameInput" placeholder="å¦‚ï¼šç‹å°æ˜" required>
            </div>
            <div class="form-group">
              <label for="userEmailInput">é‚®ç®± *</label>
              <input id="userEmailInput" type="email" placeholder="name@example.com" required>
            </div>
            <div class="form-group">
              <label for="userRoleSelect">è§’è‰² *</label>
              <select id="userRoleSelect" required></select>
            </div>
            <div class="form-group">
              <label for="userSiteMulti">æˆæƒç«™ç‚¹</label>
              <select id="userSiteMulti" multiple></select>
            </div>
          </div>
          <p class="multi-select-hint">æŒ‰ä½ Ctrl / Command å¯å¤šé€‰ç«™ç‚¹ï¼Œç•™ç©ºè¡¨ç¤ºè®¿é—®æ‰€æœ‰ç«™ç‚¹ã€‚</p>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">ä¿å­˜ç”¨æˆ·</button>
            <button type="button" class="btn" id="resetUserForm">é‡ç½®</button>
          </div>
        </form>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">å·²æˆæƒç”¨æˆ·</h2>
        <div id="userList" class="user-grid"></div>
      </div>
    </section>

    <section id="syncConsole" class="admin-section">
      <div class="section-header">
        <div>
          <h1>åŒæ­¥å·¥å…·</h1>
          <div class="section-subtitle">ç”¨äºè§¦å‘ `/api/site-sync` ä¸æ£€æŸ¥æŒ‡æ ‡å­—æ®µè¦†ç›–ï¼Œä¿éšœæ–°ç«™ç‚¹ä¸Šçº¿å³è¿é€šã€‚</div>
        </div>
      </div>
      <div class="admin-card">
        <h2 style="margin-top:0">ç«™ç‚¹åŒæ­¥</h2>
        <div class="form-grid">
          <div class="form-group">
            <label for="syncSiteSelect">é€‰æ‹©ç«™ç‚¹</label>
            <select id="syncSiteSelect"></select>
          </div>
          <div class="form-group">
            <label for="syncActionSelect">åŒæ­¥åŠ¨ä½œ</label>
            <select id="syncActionSelect">
              <option value="create">åˆ›å»ºç«™ç‚¹ç»“æ„</option>
              <option value="update">æ›´æ–°ç«™ç‚¹ç»“æ„</option>
            </select>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" id="runSyncBtn">æ‰§è¡ŒåŒæ­¥</button>
        </div>
        <p class="section-subtitle">åŒæ­¥æ“ä½œå°†åˆ·æ–° `site_module_configs`ã€`site_channel_configs` ç­‰ä¾èµ–ç«™ç‚¹ ID çš„è¡¨ï¼Œä»¥ä¾¿ Lazada/Shopee ç­‰æ–°ç«™ç‚¹ç«‹å³ç”Ÿæ•ˆã€‚</p>
      </div>
      <div class="admin-card">
        <h2 style="margin-top:0">å­—æ®µè¦†ç›–æ ¡éªŒ</h2>
        <p class="section-subtitle">å³å°†ä¸Šçº¿ï¼šè‡ªåŠ¨å¯¹æ¯” `platform_metric_profiles` ä¸æ¥å£è¿”å›çš„ `availableFields`ï¼Œæç¤ºç¼ºå¤±å­—æ®µæˆ–å¯é€‰å­—æ®µã€‚</p>
        <button class="btn" disabled>å¼€å‘ä¸­</button>
      </div>
    </section>
  </main>
</div>

<script>
const PLATFORM_CATALOG = {
  ae_self_operated: {
    label: 'é€Ÿå–é€šè‡ªè¿è¥',
    dataSources: [
      { value: 'ae_api', label: 'é€Ÿå–é€š API' },
      { value: 'ae_report', label: 'é€Ÿå–é€šè¿è¥æŠ¥è¡¨' }
    ],
    quick: { name: 'robot', display: 'é€Ÿå–é€šè‡ªè¿è¥ Robot', domain: 'robot.aliexpress.com' }
  },
  ae_managed: {
    label: 'é€Ÿå–é€šå…¨æ‰˜ç®¡',
    dataSources: [
      { value: 'ae_api', label: 'é€Ÿå–é€š API' },
      { value: 'managed_report', label: 'å…¨æ‰˜ç®¡æŠ¥è¡¨' }
    ],
    quick: { name: 'managed', display: 'é€Ÿå–é€šå…¨æ‰˜ç®¡æ——èˆ°åº—' }
  },
  independent: {
    label: 'ç‹¬ç«‹ç«™',
    dataSources: [
      { value: 'google_ads', label: 'Google Ads' },
      { value: 'facebook_ads', label: 'Facebook Ads' },
      { value: 'tiktok_ads', label: 'TikTok Ads' },
      { value: 'custom', label: 'è‡ªå®šä¹‰/åŸ‹ç‚¹' }
    ],
    quick: { name: 'icyberite', display: 'ç‹¬ç«‹ç«™ icyberite.com', domain: 'icyberite.com' }
  },
  amazon: {
    label: 'äºšé©¬é€Š',
    dataSources: [
      { value: 'amazon_sp_api', label: 'Amazon SP-API' },
      { value: 'amazon_ads', label: 'Amazon Ads æŠ¥è¡¨' }
    ],
    quick: { name: 'amazon_store', display: 'äºšé©¬é€Šæ——èˆ°åº—' }
  },
  ozon: {
    label: 'Ozon',
    dataSources: [
      { value: 'ozon_api', label: 'Ozon API' },
      { value: 'ozon_report', label: 'Ozon æŠ¥è¡¨' }
    ],
    quick: { name: 'ozon_main', display: 'Ozon ä¸»ç«™' }
  },
  tiktok: {
    label: 'TikTok Shop',
    dataSources: [
      { value: 'tiktok_shop_api', label: 'TikTok Shop API' },
      { value: 'tiktok_ads', label: 'TikTok Ads æŠ¥è¡¨' }
    ],
    quick: { name: 'tiktok_flagship', display: 'TikTok Shop å®˜æ–¹åº—' }
  },
  temu: {
    label: 'Temu',
    dataSources: [
      { value: 'temu_report', label: 'Temu æŠ¥è¡¨' },
      { value: 'temu_api', label: 'Temu API (è§„åˆ’)' }
    ],
    quick: { name: 'temu_global', display: 'Temu å…¨çƒåº—' }
  },
  lazada: {
    label: 'Lazada',
    dataSources: [
      { value: 'lazada_api', label: 'Lazada API' },
      { value: 'lazada_ads', label: 'Lazada Ads æŠ¥è¡¨' },
      { value: 'custom', label: 'è‡ªå®šä¹‰/ç¬¬ä¸‰æ–¹' }
    ],
    quick: { name: 'lazada_my', display: 'Lazada é©¬æ¥è¥¿äºšæ——èˆ°åº—' }
  },
  shopee: {
    label: 'Shopee',
    dataSources: [
      { value: 'shopee_api', label: 'Shopee API' },
      { value: 'shopee_ads', label: 'Shopee Ads æŠ¥è¡¨' },
      { value: 'custom', label: 'è‡ªå®šä¹‰/ç¬¬ä¸‰æ–¹' }
    ],
    quick: { name: 'shopee_sg', display: 'Shopee æ–°åŠ å¡æ——èˆ°åº—' }
  }
};

const DATA_SOURCE_LABELS = Object.values(PLATFORM_CATALOG).reduce((acc, platform) => {
  platform.dataSources.forEach(ds => acc[ds.value] = ds.label);
  return acc;
}, { custom: 'è‡ªå®šä¹‰/ç¬¬ä¸‰æ–¹' });

const MODULE_LABELS = {
  operations: 'è¿è¥åˆ†æ',
  products: 'äº§å“åˆ†æ',
  orders: 'è®¢å•ä¸­å¿ƒ',
  advertising: 'å¹¿å‘Šä¸­å¿ƒ',
  inventory: 'åº“å­˜ç®¡ç† (å…¨å±€)',
  permissions: 'æƒé™ç®¡ç† (å…¨å±€)'
};

const DEFAULT_MATRIX = {
  operations: ['super_admin', 'operations_manager', 'viewer'],
  products: ['super_admin', 'operations_manager', 'viewer'],
  orders: ['super_admin', 'operations_manager', 'order_manager', 'finance', 'viewer'],
  advertising: ['super_admin', 'operations_manager', 'ad_manager', 'viewer'],
  inventory: ['super_admin', 'inventory_manager', 'operations_manager'],
  permissions: ['super_admin']
};

const ROLE_LABELS = {
  super_admin: 'è¶…çº§ç®¡ç†å‘˜',
  operations_manager: 'è¿è¥ç®¡ç†å‘˜',
  order_manager: 'è®¢å•ç®¡ç†å‘˜',
  inventory_manager: 'åº“å­˜ç®¡ç†å‘˜',
  ad_manager: 'å¹¿å‘Šç®¡ç†å‘˜',
  finance: 'è´¢åŠ¡',
  viewer: 'åªè¯»ç”¨æˆ·'
};

const ROLE_DESCRIPTIONS = {
  super_admin: 'æ‹¥æœ‰å…¨éƒ¨åŠŸèƒ½æƒé™ï¼Œå¯é…ç½®ç«™ç‚¹ã€æ¨¡å—ä¸æƒé™çŸ©é˜µã€‚',
  operations_manager: 'èšç„¦æ ¸å¿ƒè¿è¥æŒ‡æ ‡ä¸å•†å“è¡¨ç°ï¼ŒæŸ¥çœ‹æŠ¥è¡¨ä¸çœ‹æ¿ã€‚',
  order_manager: 'ç®¡ç†è®¢å•ã€å”®åä¸ç‰©æµä¿¡æ¯ï¼Œç¡®ä¿å±¥çº¦å‡†ç¡®ã€‚',
  inventory_manager: 'ç»´æŠ¤åº“å­˜ã€è°ƒæ‹¨ä¸é¢„è­¦é…ç½®ï¼ŒæŒæ¡ä¾›åº”é“¾çŠ¶æ€ã€‚',
  ad_manager: 'è´Ÿè´£å¹¿å‘Šé¢„ç®—ã€æŠ•æ”¾é…ç½®ä¸æŠ•æ”¾æ•ˆæœè¿½è¸ªã€‚',
  finance: 'æŸ¥çœ‹ç»“ç®—ã€å›æ¬¾ä¸è´¹ç”¨åˆ†æ‘Šç­‰è´¢åŠ¡æ•°æ®ã€‚',
  viewer: 'åªè¯»è®¿é—®ä¸»è¦çœ‹æ¿ï¼Œé€‚ç”¨äºä¸šåŠ¡æŸ¥çœ‹ã€‚'
};

function computeRoleAssignmentsFromMatrix(matrix) {
  const assignments = {};
  Object.keys(ROLE_LABELS).forEach(role => {
    assignments[role] = [];
  });
  Object.entries(matrix).forEach(([moduleKey, roles]) => {
    (roles || []).forEach(role => {
      if (!assignments[role]) {
        assignments[role] = [];
      }
      if (!assignments[role].includes(moduleKey)) {
        assignments[role].push(moduleKey);
      }
    });
  });
  return assignments;
}

let siteConfigs = [];
let matrixOverrides = {};
let activeMatrix = cloneMatrix(DEFAULT_MATRIX);
let roleAssignments = computeRoleAssignmentsFromMatrix(DEFAULT_MATRIX);
let userAccounts = [];
let editingUserId = null;
let editingUserSites = [];

function cloneMatrix(matrix) {
  return JSON.parse(JSON.stringify(matrix));
}

function setMessage(text, type = 'info') {
  const bar = document.getElementById('adminMessage');
  bar.textContent = text;
  bar.className = `message ${type}`;
  bar.style.display = text ? 'block' : 'none';
  if (text) {
    setTimeout(() => {
      bar.style.display = 'none';
    }, 4200);
  }
}

function switchSection(targetId) {
  document.querySelectorAll('.admin-section').forEach(section => {
    section.classList.toggle('active', section.id === targetId);
  });
  document.querySelectorAll('#adminNav a').forEach(link => {
    link.classList.toggle('active', link.dataset.target === targetId);
  });
}

function populatePlatformOptions() {
  const platformSelect = document.getElementById('platformSelect');
  const filterSelect = document.getElementById('platformFilter');

  platformSelect.innerHTML = '<option value="">é€‰æ‹©å¹³å°</option>';
  filterSelect.innerHTML = '<option value="">å…¨éƒ¨å¹³å°</option>';

  Object.entries(PLATFORM_CATALOG).forEach(([value, config]) => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = config.label;
    platformSelect.appendChild(option);

    const filterOption = document.createElement('option');
    filterOption.value = value;
    filterOption.textContent = config.label;
    filterSelect.appendChild(filterOption);
  });
}

function populateQuickTemplates() {
  const container = document.getElementById('quickTemplates');
  container.innerHTML = '';
  Object.entries(PLATFORM_CATALOG).forEach(([value, config]) => {
    if (!config.quick) return;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-outline';
    btn.textContent = `${config.label} Â· å¿«é€Ÿå¡«å……`;
    btn.addEventListener('click', () => {
      document.getElementById('platformSelect').value = value;
      document.getElementById('siteNameInput').value = config.quick.name || '';
      document.getElementById('displayNameInput').value = config.quick.display || '';
      document.getElementById('domainInput').value = config.quick.domain || '';
      updateDataSourceOptions();
    });
    container.appendChild(btn);
  });
}

function updateDataSourceOptions() {
  const platform = document.getElementById('platformSelect').value;
  const dataSourceSelect = document.getElementById('dataSourceSelect');
  dataSourceSelect.innerHTML = '<option value="">é€‰æ‹©æ•°æ®æº</option>';

  const sources = PLATFORM_CATALOG[platform]?.dataSources || [];
  sources.forEach(source => {
    const option = document.createElement('option');
    option.value = source.value;
    option.textContent = source.label;
    dataSourceSelect.appendChild(option);
  });

  if (!sources.find(s => s.value === 'custom')) {
    const custom = document.createElement('option');
    custom.value = 'custom';
    custom.textContent = DATA_SOURCE_LABELS.custom;
    dataSourceSelect.appendChild(custom);
  }
}

async function loadSiteConfigs() {
  setMessage('æ­£åœ¨åŠ è½½ç«™ç‚¹é…ç½®...', 'info');
  try {
    const res = await fetch('/api/site-configs');
    const payload = await res.json();
    if (!res.ok) throw new Error(payload.error || 'åŠ è½½å¤±è´¥');
    siteConfigs = payload.data || [];
    document.getElementById('siteCount').textContent = siteConfigs.length;
    renderSiteList();
    populateSiteSelectors();
    renderUserList();
    setMessage(`å·²åŠ è½½ ${siteConfigs.length} ä¸ªç«™ç‚¹`, 'success');
  } catch (error) {
    console.error('åŠ è½½ç«™ç‚¹å¤±è´¥', error);
    setMessage(`åŠ è½½ç«™ç‚¹å¤±è´¥ï¼š${error.message}`, 'error');
  }
}

function renderSiteList() {
  const list = document.getElementById('siteList');
  const platformFilter = document.getElementById('platformFilter').value;
  const filtered = platformFilter ? siteConfigs.filter(item => item.platform === platformFilter) : siteConfigs;

  if (!filtered.length) {
    list.innerHTML = '<div class="message info">æš‚æ— ç«™ç‚¹ï¼Œè¯·å…ˆåˆ›å»ºæˆ–æ›´æ¢ç­›é€‰æ¡ä»¶ã€‚</div>';
    return;
  }

  list.innerHTML = '';
  filtered.forEach(site => {
    const card = document.createElement('div');
    card.className = 'site-card';
    const platformLabel = PLATFORM_CATALOG[site.platform]?.label || site.platform;
    const dataSourceLabel = DATA_SOURCE_LABELS[site.data_source] || site.data_source || 'æœªé…ç½®';
    card.innerHTML = `
      <div>
        <h3>${site.display_name || site.name}</h3>
        <div class="section-subtitle">ç«™ç‚¹ IDï¼š${site.id}</div>
      </div>
      <div class="site-meta">
        <div><strong>å¹³å°ï¼š</strong>${platformLabel}</div>
        <div><strong>æ•°æ®æºï¼š</strong>${dataSourceLabel}</div>
        <div><strong>æ¨¡æ¿ï¼š</strong>${site.template_id || 'è‡ªåŠ¨åŒ¹é…'}</div>
        <div><strong>åŸŸåï¼š</strong>${site.domain || 'â€”'}</div>
        <div><strong>çŠ¶æ€ï¼š</strong>${site.is_active === false ? 'æœªæ¿€æ´»' : 'å¯ç”¨ä¸­'}</div>
        <div><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${site.created_at ? new Date(site.created_at).toLocaleString() : 'â€”'}</div>
      </div>
      <div class="site-actions">
        <button class="btn" data-action="prefill" data-site-id="${site.id}">å¡«å……åˆ°è¡¨å•</button>
        <button class="btn btn-secondary" data-action="sync" data-site-id="${site.id}">åŒæ­¥ç»“æ„</button>
        <button class="btn btn-danger" data-action="delete" data-site-id="${site.id}">åˆ é™¤ç«™ç‚¹</button>
      </div>
    `;
    list.appendChild(card);
  });

  list.querySelectorAll('button[data-action="prefill"]').forEach(btn => {
    btn.addEventListener('click', () => {
      try {
        const site = siteConfigs.find(item => item.id === btn.dataset.siteId);
        if (!site) throw new Error('æœªæ‰¾åˆ°ç«™ç‚¹é…ç½®');
        document.getElementById('platformSelect').value = site.platform;
        updateDataSourceOptions();
        document.getElementById('siteNameInput').value = site.name;
        document.getElementById('displayNameInput').value = site.display_name || '';
        document.getElementById('domainInput').value = site.domain || '';
        document.getElementById('dataSourceSelect').value = site.data_source || '';
        document.getElementById('templateSelect').value = site.template_id || '';
        document.getElementById('configJsonInput').value = site.config_json ? JSON.stringify(site.config_json, null, 2) : '';
        switchSection('siteConsole');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (error) {
        console.warn('Prefill å¤±è´¥', error);
      }
    });
  });

  list.querySelectorAll('button[data-action="sync"]').forEach(btn => {
    btn.addEventListener('click', () => runSync(btn.dataset.siteId, 'update'));
  });

  list.querySelectorAll('button[data-action="delete"]').forEach(btn => {
    btn.addEventListener('click', () => deleteSiteConfig(btn.dataset.siteId));
  });
}

async function submitSiteForm(event) {
  event.preventDefault();
  const platform = document.getElementById('platformSelect').value;
  const name = document.getElementById('siteNameInput').value.trim();
  const displayName = document.getElementById('displayNameInput').value.trim();
  const domain = document.getElementById('domainInput').value.trim() || null;
  const dataSource = document.getElementById('dataSourceSelect').value;
  const templateId = document.getElementById('templateSelect').value || null;
  const configRaw = document.getElementById('configJsonInput').value.trim();

  if (!platform || !name || !displayName || !dataSource) {
    setMessage('è¯·å®Œæ•´å¡«å†™å¹³å°ã€ç«™ç‚¹åç§°ã€æ˜¾ç¤ºåç§°ä¸æ•°æ®æºã€‚', 'error');
    return;
  }

  let configJson = null;
  if (configRaw) {
    try {
      configJson = JSON.parse(configRaw);
    } catch (error) {
      setMessage('é…ç½®ä¿¡æ¯éœ€ä¸ºåˆæ³• JSON æ ¼å¼ã€‚', 'error');
      return;
    }
  }

  setMessage('æ­£åœ¨ä¿å­˜ç«™ç‚¹é…ç½®...', 'info');
  try {
    const res = await fetch('/api/site-configs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        platform,
        name,
        display_name: displayName,
        domain,
        data_source: dataSource,
        template_id: templateId,
        config_json: configJson
      })
    });
    const payload = await res.json();
    if (!res.ok) throw new Error(payload.error || 'ä¿å­˜å¤±è´¥');

    setMessage('ç«™ç‚¹å·²ä¿å­˜ï¼Œæ­£åœ¨è§¦å‘ç»“æ„åŒæ­¥...', 'success');
    await loadSiteConfigs();
    await runSync(payload.data?.id, 'create');
    document.getElementById('siteForm').reset();
    updateDataSourceOptions();
  } catch (error) {
    console.error('ä¿å­˜ç«™ç‚¹å¤±è´¥', error);
    setMessage(`ä¿å­˜ç«™ç‚¹å¤±è´¥ï¼š${error.message}`, 'error');
  }
}

function populateSiteSelectors() {
  const siteSelects = [
    document.getElementById('permissionSiteSelect'),
    document.getElementById('syncSiteSelect')
  ];
  siteSelects.forEach(select => {
    if (!select) return;
    const preserveFirst = select === document.getElementById('permissionSiteSelect');
    const defaultOption = preserveFirst ? select.querySelector('option[value=""]') : null;
    select.innerHTML = '';
    if (preserveFirst && defaultOption) {
      select.appendChild(defaultOption);
    } else {
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'é€‰æ‹©ç«™ç‚¹';
      select.appendChild(placeholder);
    }

    siteConfigs.forEach(site => {
      const option = document.createElement('option');
      option.value = site.id;
      option.textContent = `${site.display_name || site.name} (${site.platform})`;
      select.appendChild(option);
    });
  });

  const userSiteSelect = document.getElementById('userSiteMulti');
  if (userSiteSelect) {
    const preserved = editingUserId ? new Set(editingUserSites) : new Set(Array.from(userSiteSelect.selectedOptions || []).map(opt => opt.value));
    userSiteSelect.innerHTML = '';
    siteConfigs.forEach(site => {
      const option = document.createElement('option');
      option.value = site.id;
      option.textContent = `${site.display_name || site.name} (${site.platform})`;
      if (preserved.has(site.id)) {
        option.selected = true;
      }
      userSiteSelect.appendChild(option);
    });
  }
}

async function runSync(siteId, action) {
  if (!siteId) {
    setMessage('è¯·å…ˆé€‰æ‹©ç«™ç‚¹åå†æ‰§è¡ŒåŒæ­¥ã€‚', 'error');
    return;
  }
  setMessage('æ­£åœ¨æ‰§è¡Œç«™ç‚¹åŒæ­¥...', 'info');
  try {
    const res = await fetch('/api/site-sync', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ siteId, action })
    });
    const payload = await res.json();
    if (!res.ok) throw new Error(payload.error || 'åŒæ­¥å¤±è´¥');
    setMessage('ç«™ç‚¹åŒæ­¥æˆåŠŸï¼Œæ¨¡å—ä¸æ¸ é“é…ç½®å·²åˆ·æ–°ã€‚', 'success');
  } catch (error) {
    console.error('åŒæ­¥å¤±è´¥', error);
    setMessage(`ç«™ç‚¹åŒæ­¥å¤±è´¥ï¼š${error.message}`, 'error');
  }
}

async function deleteSiteConfig(siteId) {
  if (!siteId) return;
  const target = siteConfigs.find(item => item.id === siteId);
  const name = target ? (target.display_name || target.name || siteId) : siteId;
  const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤ç«™ç‚¹ã€Œ${name}ã€å—ï¼Ÿåˆ é™¤åå¯¼èˆªä¸æƒé™é…ç½®å°†ç§»é™¤è¯¥ç«™ç‚¹ã€‚`);
  if (!confirmed) return;

  setMessage('æ­£åœ¨åˆ é™¤ç«™ç‚¹...', 'info');
  try {
    const res = await fetch('/api/site-configs/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ siteId })
    });
    const payload = await res.json();
    if (!res.ok) throw new Error(payload.error || 'åˆ é™¤å¤±è´¥');
    setMessage('ç«™ç‚¹å·²åˆ é™¤ã€‚', 'success');
    await loadSiteConfigs();
  } catch (error) {
    console.error('åˆ é™¤ç«™ç‚¹å¤±è´¥', error);
    setMessage(`åˆ é™¤ç«™ç‚¹å¤±è´¥ï¼š${error.message}`, 'error');
  }
}

function refreshRoleAssignments() {
  roleAssignments = computeRoleAssignmentsFromMatrix(DEFAULT_MATRIX);
  renderRoleManagement();
  renderUserList();
}

function renderRoleManagement() {
  const container = document.getElementById('roleList');
  if (!container) return;
  container.innerHTML = '';

  Object.entries(ROLE_LABELS).forEach(([role, label]) => {
    const modules = new Set(roleAssignments[role] || []);
    const card = document.createElement('div');
    card.className = 'role-card';
    const checkboxHtml = Object.entries(MODULE_LABELS).map(([moduleKey, moduleLabel]) => {
      const checked = modules.has(moduleKey) ? 'checked' : '';
      return `<label class="role-checkbox"><input type="checkbox" data-role="${role}" data-module="${moduleKey}" ${checked}><span>${moduleLabel}</span></label>`;
    }).join('');
    card.innerHTML = `
      <div>
        <h3>${label}</h3>
        <div class="role-meta">${ROLE_DESCRIPTIONS[role] || ''}</div>
      </div>
      <div class="role-modules">
        ${checkboxHtml || '<span class="chip chip-muted">æš‚æ— å¯é…ç½®æ¨¡å—</span>'}
      </div>
    `;
    container.appendChild(card);
  });

  container.querySelectorAll('input[type="checkbox"]').forEach(input => {
    input.addEventListener('change', () => {
      const role = input.dataset.role;
      const moduleKey = input.dataset.module;
      const modules = new Set(roleAssignments[role] || []);
      if (input.checked) {
        modules.add(moduleKey);
      } else {
        modules.delete(moduleKey);
      }
      roleAssignments[role] = Array.from(modules);
      renderUserList();
    });
  });
}

function populateRoleOptions() {
  const roleSelect = document.getElementById('userRoleSelect');
  if (!roleSelect) return;
  const current = roleSelect.value;
  roleSelect.innerHTML = '<option value="">é€‰æ‹©è§’è‰²</option>';
  Object.entries(ROLE_LABELS).forEach(([value, label]) => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = label;
    if (value === current) {
      option.selected = true;
    }
    roleSelect.appendChild(option);
  });
}

function saveRoleAssignments() {
  const updatedMatrix = {};
  Object.keys(MODULE_LABELS).forEach(moduleKey => {
    updatedMatrix[moduleKey] = Object.keys(roleAssignments).filter(role => {
      return (roleAssignments[role] || []).includes(moduleKey);
    });
  });
  Object.keys(DEFAULT_MATRIX).forEach(key => delete DEFAULT_MATRIX[key]);
  Object.assign(DEFAULT_MATRIX, updatedMatrix);
  const siteId = document.getElementById('permissionSiteSelect').value;
  if (!siteId) {
    activeMatrix = cloneMatrix(DEFAULT_MATRIX);
    renderPermissionMatrix();
  }
  refreshRoleAssignments();
  setMessage('è§’è‰²æƒé™å·²ä¿å­˜å¹¶åŒæ­¥è‡³å…¨å±€é»˜è®¤ã€‚', 'success');
}

function resetRoleAssignments() {
  roleAssignments = computeRoleAssignmentsFromMatrix(DEFAULT_MATRIX);
  renderRoleManagement();
  renderUserList();
  setMessage('å·²æ¢å¤å½“å‰é»˜è®¤çš„è§’è‰²é…ç½®ã€‚', 'success');
}

function getRoleModuleLabels(role) {
  return (roleAssignments[role] || []).map(moduleKey => MODULE_LABELS[moduleKey] || moduleKey);
}

function getSiteDisplayName(siteId) {
  const site = siteConfigs.find(item => item.id === siteId);
  return site ? (site.display_name || site.name || siteId) : siteId;
}

function loadUserAccounts() {
  try {
    const cached = localStorage.getItem('adminUserAccounts');
    userAccounts = cached ? JSON.parse(cached) : [];
  } catch (error) {
    console.warn('åŠ è½½ç”¨æˆ·é…ç½®å¤±è´¥', error);
    userAccounts = [];
  }
}

function saveUserAccounts() {
  try {
    localStorage.setItem('adminUserAccounts', JSON.stringify(userAccounts));
  } catch (error) {
    console.warn('ä¿å­˜ç”¨æˆ·é…ç½®å¤±è´¥', error);
  }
}

function renderUserList() {
  const container = document.getElementById('userList');
  if (!container) return;

  if (!userAccounts.length) {
    container.innerHTML = '<div class="message info">æš‚æ— ç”¨æˆ·ï¼Œè¯·æ·»åŠ æˆå‘˜ååˆ†é…è§’è‰²ã€‚</div>';
    return;
  }

  container.innerHTML = '';
  userAccounts.forEach(user => {
    const card = document.createElement('div');
    card.className = 'user-card';
    const moduleLabels = getRoleModuleLabels(user.role);
    const moduleHtml = moduleLabels.length
      ? moduleLabels.map(label => `<span class="chip">${label}</span>`).join('')
      : '<span class="chip chip-muted">æœªåˆ†é…æ¨¡å—</span>';
    const siteHtml = user.sites && user.sites.length
      ? user.sites.map(getSiteDisplayName).map(name => `<span class="chip chip-muted">${name}</span>`).join('')
      : '<span class="chip chip-muted">å…¨éƒ¨ç«™ç‚¹</span>';

    card.innerHTML = `
      <div>
        <h3>${user.name}</h3>
        <div class="section-subtitle">${user.email}</div>
      </div>
      <div class="user-meta">
        <div><strong>è§’è‰²ï¼š</strong>${ROLE_LABELS[user.role] || user.role}</div>
        <div><strong>å¯è®¿é—®æ¨¡å—ï¼š</strong>${moduleHtml}</div>
        <div><strong>æˆæƒç«™ç‚¹ï¼š</strong>${siteHtml}</div>
      </div>
      <div class="site-actions">
        <button class="btn" data-action="edit-user" data-user-id="${user.id}">ç¼–è¾‘</button>
        <button class="btn btn-danger" data-action="remove-user" data-user-id="${user.id}">åˆ é™¤</button>
      </div>
    `;
    container.appendChild(card);
  });

  container.querySelectorAll('button[data-action="edit-user"]').forEach(btn => {
    btn.addEventListener('click', () => editUser(btn.dataset.userId));
  });

  container.querySelectorAll('button[data-action="remove-user"]').forEach(btn => {
    btn.addEventListener('click', () => removeUser(btn.dataset.userId));
  });
}

function handleUserFormSubmit(event) {
  event.preventDefault();
  const name = document.getElementById('userNameInput').value.trim();
  const email = document.getElementById('userEmailInput').value.trim();
  const role = document.getElementById('userRoleSelect').value;
  const siteSelect = document.getElementById('userSiteMulti');
  const sites = siteSelect ? Array.from(siteSelect.selectedOptions).map(opt => opt.value) : [];

  if (!name || !email || !role) {
    setMessage('è¯·å¡«å†™å®Œæ•´çš„ç”¨æˆ·å§“åã€é‚®ç®±å¹¶é€‰æ‹©è§’è‰²ã€‚', 'error');
    return;
  }

  const payload = {
    id: editingUserId || `user_${Date.now()}`,
    name,
    email,
    role,
    sites
  };

  if (editingUserId) {
    const index = userAccounts.findIndex(user => user.id === editingUserId);
    if (index >= 0) {
      userAccounts[index] = payload;
      setMessage(`å·²æ›´æ–°ç”¨æˆ· ${name}ã€‚`, 'success');
    }
  } else {
    userAccounts.push(payload);
    setMessage(`å·²æ·»åŠ ç”¨æˆ· ${name}ã€‚`, 'success');
  }

  saveUserAccounts();
  resetUserForm();
  renderUserList();
}

function resetUserForm() {
  editingUserId = null;
  editingUserSites = [];
  const form = document.getElementById('userForm');
  if (form) {
    form.reset();
  }
  populateRoleOptions();
  const siteSelect = document.getElementById('userSiteMulti');
  if (siteSelect) {
    Array.from(siteSelect.options).forEach(option => {
      option.selected = false;
    });
  }
}

function editUser(userId) {
  const target = userAccounts.find(user => user.id === userId);
  if (!target) return;
  editingUserId = target.id;
  editingUserSites = Array.isArray(target.sites) ? [...target.sites] : [];
  document.getElementById('userNameInput').value = target.name || '';
  document.getElementById('userEmailInput').value = target.email || '';
  populateRoleOptions();
  document.getElementById('userRoleSelect').value = target.role || '';
  const siteSelect = document.getElementById('userSiteMulti');
  if (siteSelect) {
    Array.from(siteSelect.options).forEach(option => {
      option.selected = editingUserSites.includes(option.value);
    });
  }
  setMessage(`æ­£åœ¨ç¼–è¾‘ç”¨æˆ· ${target.name}`, 'info');
  switchSection('userConsole');
}

function removeUser(userId) {
  const target = userAccounts.find(user => user.id === userId);
  if (!target) return;
  const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ·ã€Œ${target.name}ã€å—ï¼Ÿ`);
  if (!confirmed) return;
  userAccounts = userAccounts.filter(user => user.id !== userId);
  saveUserAccounts();
  renderUserList();
  if (editingUserId === userId) {
    resetUserForm();
  }
  setMessage(`å·²åˆ é™¤ç”¨æˆ· ${target.name}ã€‚`, 'success');
}

function renderPermissionMatrix() {
  const matrixBody = document.getElementById('permissionMatrix');
  matrixBody.innerHTML = '';
  Object.entries(MODULE_LABELS).forEach(([moduleKey, label]) => {
    const row = document.createElement('tr');
    const roleList = Object.keys(ROLE_LABELS).map(role => {
      const checked = (activeMatrix[moduleKey] || []).includes(role);
      return `<label style="margin-right:12px;display:inline-flex;align-items:center;gap:6px;">
        <input type="checkbox" data-module="${moduleKey}" data-role="${role}" ${checked ? 'checked' : ''}>
        <span>${ROLE_LABELS[role]}</span>
      </label>`;
    }).join('');
    row.innerHTML = `
      <td class="module-label">${label}</td>
      <td>${getModuleDescription(moduleKey)}</td>
      <td>${roleList}</td>
    `;
    matrixBody.appendChild(row);
  });

  matrixBody.querySelectorAll('input[type="checkbox"]').forEach(input => {
    input.addEventListener('change', () => {
      const moduleKey = input.dataset.module;
      const role = input.dataset.role;
      const target = activeMatrix[moduleKey] || [];
      if (input.checked && !target.includes(role)) {
        target.push(role);
      } else if (!input.checked) {
        activeMatrix[moduleKey] = target.filter(item => item !== role);
      }
    });
  });
}

function getModuleDescription(moduleKey) {
  switch (moduleKey) {
    case 'operations':
      return 'æ›å…‰ã€è®¿å®¢ã€åŠ è´­ã€æ”¯ä»˜ç­‰å…¨é“¾è·¯æŒ‡æ ‡ã€‚';
    case 'products':
      return 'å•†å“ç»´åº¦åˆ†æã€å±æ€§ä¸ç»©æ•ˆå¯¹æ¯”ã€‚';
    case 'orders':
      return 'è®¢å•åˆ—è¡¨ã€å®¢æˆ·ä¿¡æ¯ã€ç‰©æµæˆæœ¬ä¸ç»“ç®—çŠ¶æ€ã€‚';
    case 'advertising':
      return 'å¹¿å‘Šé¢„ç®—ã€æŠ•æ”¾é…ç½®ã€å½’å› ä¸å¸¦æ¥è®¿å®¢/è®¢å•ã€‚';
    case 'inventory':
      return 'å…¨å±€åº“å­˜ä¸­å¿ƒï¼ˆæ‰¹æ¬¡ã€è°ƒæ‹¨ã€é¢„è­¦ï¼‰ã€‚';
    case 'permissions':
      return 'è§’è‰²ä¸èµ„æºçŸ©é˜µï¼Œä»…é™è¶…çº§ç®¡ç†å‘˜ã€‚';
    default:
      return '';
  }
}

function handlePermissionSiteChange() {
  const siteId = document.getElementById('permissionSiteSelect').value;
  if (siteId && matrixOverrides[siteId]) {
    activeMatrix = cloneMatrix(matrixOverrides[siteId]);
  } else {
    activeMatrix = cloneMatrix(siteId ? DEFAULT_MATRIX : DEFAULT_MATRIX);
    if (siteId && !matrixOverrides[siteId]) {
      matrixOverrides[siteId] = cloneMatrix(DEFAULT_MATRIX);
    }
  }
  renderPermissionMatrix();
}

function resetPermissionMatrix() {
  const siteId = document.getElementById('permissionSiteSelect').value;
  if (siteId) {
    matrixOverrides[siteId] = cloneMatrix(DEFAULT_MATRIX);
  }
  activeMatrix = cloneMatrix(DEFAULT_MATRIX);
  renderPermissionMatrix();
  setMessage('å·²æ¢å¤é»˜è®¤æƒé™çŸ©é˜µã€‚', 'success');
}

function savePermissionMatrix() {
  const siteId = document.getElementById('permissionSiteSelect').value;
  if (siteId) {
    matrixOverrides[siteId] = cloneMatrix(activeMatrix);
    setMessage(`å·²æš‚å­˜ ${siteId} çš„æƒé™çŸ©é˜µï¼Œåç«¯æ¥å£ä¸Šçº¿åå°†å†™å…¥æ•°æ®åº“ã€‚`, 'success');
  } else {
    Object.keys(matrixOverrides).forEach(key => delete matrixOverrides[key]);
    Object.assign(DEFAULT_MATRIX, cloneMatrix(activeMatrix));
    setMessage('å·²æ›´æ–°å…¨å±€é»˜è®¤æƒé™çŸ©é˜µã€‚', 'success');
    refreshRoleAssignments();
  }
}

function exportPermissionMatrix() {
  const siteId = document.getElementById('permissionSiteSelect').value;
  const payload = siteId ? matrixOverrides[siteId] || activeMatrix : activeMatrix;
  const json = JSON.stringify(payload, null, 2);
  navigator.clipboard?.writeText(json).then(() => {
    setMessage('æƒé™çŸ©é˜µ JSON å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚', 'success');
  }).catch(() => {
    setMessage('è¯·æ‰‹åŠ¨å¤åˆ¶ï¼š\n' + json, 'info');
  });
}

function setupAuth() {
  const loginOverlay = document.getElementById('loginOverlay');
  const loginForm = document.getElementById('loginForm');
  const userArea = document.getElementById('userArea');

  function checkAuth() {
    const token = localStorage.getItem('authToken');
    if (!token) {
      loginOverlay.style.display = 'flex';
    } else {
      loginOverlay.style.display = 'none';
      userArea.innerHTML = `
        <span>æ¬¢è¿ï¼Œç®¡ç†å‘˜</span>
        <button class="btn" id="logoutBtn">é€€å‡º</button>
      `;
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        checkAuth();
      });
    }
  }

  loginForm.addEventListener('submit', (event) => {
    event.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if (email === 'demo@example.com' && password === 'demo123') {
      localStorage.setItem('authToken', 'demo-token');
      checkAuth();
    } else {
      alert('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ');
    }
  });

  document.getElementById('password-toggle').addEventListener('click', () => {
    const input = document.getElementById('password');
    input.type = input.type === 'password' ? 'text' : 'password';
  });

  checkAuth();
}

function initializeAdmin() {
  document.querySelectorAll('#adminNav a').forEach(link => {
    link.addEventListener('click', event => {
      event.preventDefault();
      switchSection(link.dataset.target);
    });
  });

  document.getElementById('platformSelect').addEventListener('change', () => {
    updateDataSourceOptions();
  });

  document.getElementById('platformFilter').addEventListener('change', renderSiteList);
  document.getElementById('siteForm').addEventListener('submit', submitSiteForm);
  document.getElementById('resetSiteForm').addEventListener('click', () => {
    document.getElementById('siteForm').reset();
    updateDataSourceOptions();
  });
  document.getElementById('refreshSitesBtn').addEventListener('click', loadSiteConfigs);
  document.getElementById('permissionSiteSelect').addEventListener('change', () => {
    handlePermissionSiteChange();
  });
  document.getElementById('resetPermissionBtn').addEventListener('click', resetPermissionMatrix);
  document.getElementById('savePermissionBtn').addEventListener('click', savePermissionMatrix);
  document.getElementById('exportPermissionBtn').addEventListener('click', exportPermissionMatrix);
  document.getElementById('runSyncBtn').addEventListener('click', () => {
    const siteId = document.getElementById('syncSiteSelect').value;
    const action = document.getElementById('syncActionSelect').value;
    runSync(siteId, action);
  });

  const saveRoleBtn = document.getElementById('saveRoleBtn');
  const resetRoleBtn = document.getElementById('resetRoleBtn');
  if (saveRoleBtn) {
    saveRoleBtn.addEventListener('click', saveRoleAssignments);
  }
  if (resetRoleBtn) {
    resetRoleBtn.addEventListener('click', resetRoleAssignments);
  }

  const userForm = document.getElementById('userForm');
  if (userForm) {
    userForm.addEventListener('submit', handleUserFormSubmit);
  }
  const resetUserBtn = document.getElementById('resetUserForm');
  if (resetUserBtn) {
    resetUserBtn.addEventListener('click', resetUserForm);
  }

  populatePlatformOptions();
  populateQuickTemplates();
  updateDataSourceOptions();
  populateRoleOptions();
  renderRoleManagement();
  loadUserAccounts();
  renderUserList();
  renderPermissionMatrix();
  loadSiteConfigs();
  switchSection('siteConsole');
}

document.addEventListener('DOMContentLoaded', () => {
  setupAuth();
  initializeAdmin();
});
</script>
</body>
</html>
