<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>管理后台 · 跨境电商数据分析平台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250810d">
  <link rel="stylesheet" href="assets/global-theme.css">
  <script src="assets/site-nav.js" defer></script>
  <style>
    body.fm {
      background: #f3f4f6;
    }
    .admin-layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: calc(100vh - 64px);
    }
    .admin-sidebar {
      background: #111827;
      color: #f9fafb;
      padding: 24px 0;
    }
    .admin-sidebar .site-header {
      padding: 0 24px 16px;
      font-size: 18px;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .admin-sidebar .sub-nav {
      list-style: none;
      margin: 16px 0 0;
      padding: 0;
    }
    .admin-sidebar .sub-nav li a {
      display: block;
      padding: 12px 24px;
      color: rgba(255,255,255,0.75);
      text-decoration: none;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .admin-sidebar .sub-nav li a.active,
    .admin-sidebar .sub-nav li a:hover {
      background: rgba(59,130,246,0.12);
      color: #fff;
    }
    .admin-main {
      padding: 32px;
      overflow-y: auto;
    }
    .admin-section {
      display: none;
    }
    .admin-section.active {
      display: block;
      animation: fadeIn 0.25s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }
    .section-header h1 {
      margin: 0;
      font-size: 24px;
      color: #111827;
    }
    .section-subtitle {
      color: #6b7280;
      font-size: 14px;
    }
    .admin-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
    }
    .admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .form-group label {
      font-weight: 500;
      color: #374151;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
    }
    .form-actions {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn:hover {
      background: #f9fafb;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-secondary {
      background: #111827;
      border-color: #111827;
      color: #f9fafb;
    }
    .btn-danger {
      background: #ef4444;
      border-color: #ef4444;
      color: #fff;
    }
    .btn-danger:hover {
      background: #dc2626;
      border-color: #dc2626;
    }
    .btn-success {
      background: #059669;
      border-color: #059669;
      color: #fff;
    }
    .btn-outline {
      background: transparent;
      border-style: dashed;
    }
    .quick-templates {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }
    .role-grid,
    .user-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }
    .role-card,
    .user-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      background: #fff;
      box-shadow: 0 1px 2px rgba(15,23,42,0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .role-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }
    .role-card h3,
    .user-card h3 {
      margin: 0;
      font-size: 18px;
      color: #1f2937;
    }
    .role-id {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .role-meta,
    .user-meta {
      color: #6b7280;
      font-size: 13px;
      line-height: 1.6;
    }
    .role-card-actions {
      display: flex;
      gap: 8px;
    }
    .user-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
    }
    .role-modules {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
    }
    .role-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #374151;
      background: #f9fafb;
      border-radius: 9999px;
      padding: 6px 12px;
      border: 1px solid #e5e7eb;
    }
    .role-checkbox input {
      margin: 0;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 9999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 12px;
      margin: 2px 4px 2px 0;
      white-space: nowrap;
    }
    .chip-muted {
      background: #f3f4f6;
      color: #6b7280;
    }
    select[multiple] {
      min-height: 120px;
    }
    .multi-select-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: -4px;
    }
    .form-hint {
      font-size: 12px;
      color: #9ca3af;
      margin: 4px 0 0;
    }
    .site-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(16,185,129,0.05));
    }
    .site-card h3 {
      margin: 0;
      font-size: 18px;
      color: #1f2937;
    }
    .site-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      font-size: 13px;
      color: #4b5563;
    }
    .site-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .message.info {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }
    .message.success {
      background: #ecfdf5;
      color: #047857;
      border: 1px solid #a7f3d0;
    }
    .message.error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 12px;
      background: #e0f2fe;
      color: #0369a1;
      margin-left: 6px;
    }
    @media (max-width: 960px) {
      .admin-layout {
        grid-template-columns: 1fr;
      }
      .admin-sidebar {
        display: flex;
        overflow-x: auto;
      }
      .admin-sidebar .site-header {
        display: none;
      }
      .admin-sidebar .sub-nav {
        display: flex;
        width: 100%;
      }
      .admin-sidebar .sub-nav li {
        flex: 1;
      }
    }
  </style>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">跨境电商数据分析平台</div>
        <div class="form-subtitle">登录账户以继续</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">邮箱</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">密码</label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">👁️</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">登录</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">演示账户</div>
        <div class="demo-account-info">邮箱：demo@example.com<br>密码：demo123</div>
      </div>
    </div>
  </div>
</div>

<header class="header">
  <div class="logo-title">跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="self-operated.html">速卖通</a></li>
      <li class="amazon"><a href="amazon-overview.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-analysis.html">Ozon</a></li>
      <li class="independent"><a href="independent-site.html">独立站</a></li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>

<div class="admin-layout">
  <nav class="sidebar admin-sidebar">
    <div class="site-header">管理后台</div>
    <ul class="sub-nav" id="adminNav">
      <li><a href="#" class="active" data-target="siteConsole">站点管理</a></li>
      <li><a href="#" data-target="roleConsole">角色管理</a></li>
      <li><a href="#" data-target="userConsole">用户管理</a></li>
    </ul>
  </nav>

  <main class="main admin-main">
    <div id="adminMessage" class="message info" style="display:none"></div>

    <section id="siteConsole" class="admin-section active">
      <div class="section-header">
        <div>
          <h1>站点配置中心</h1>
          <div class="section-subtitle">通过 `site_configs` 注册新站点，自动与站点模块、渠道配置与导航联动。</div>
        </div>
        <button class="btn btn-outline" id="refreshSitesBtn">刷新列表</button>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">快捷模板</h2>
        <p class="section-subtitle">一键填充常见站点的基础字段，可根据实际需求调整后再提交。</p>
        <div class="quick-templates" id="quickTemplates"></div>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">创建 / 更新站点</h2>
        <form id="siteForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="platformSelect">平台 *</label>
              <select id="platformSelect" required></select>
            </div>
            <div class="form-group">
              <label for="siteNameInput">站点名称 *</label>
              <input id="siteNameInput" placeholder="如：robot 或 flagship" required>
            </div>
            <div class="form-group">
              <label for="displayNameInput">显示名称 *</label>
              <input id="displayNameInput" placeholder="如：速卖通自运营 Robot" required>
            </div>
            <div class="form-group">
              <label for="domainInput">域名 / 标识</label>
              <input id="domainInput" placeholder="如：robot.aliexpress.com">
            </div>
            <div class="form-group">
              <label for="dataSourceSelect">数据源 *</label>
              <select id="dataSourceSelect" required></select>
            </div>
            <div class="form-group">
              <label for="templateSelect">数据模板</label>
              <select id="templateSelect">
                <option value="">自动选择</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="margin-top:12px;">
            <label for="configJsonInput">配置信息 (JSON，可含 API Key 引用)</label>
            <textarea id="configJsonInput" rows="4" placeholder='{"api_key_ref":"vault://..."}'></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">保存站点</button>
            <button type="button" class="btn" id="resetSiteForm">重置</button>
          </div>
        </form>
      </div>

      <div class="admin-card">
        <div class="section-header" style="margin-bottom:12px;">
          <div>
            <h2 style="margin:0">已注册站点</h2>
            <div class="section-subtitle">共 <span id="siteCount">0</span> 个站点，新增后会自动出现在前端导航与模块配置中。</div>
          </div>
          <select id="platformFilter" class="btn" style="min-width:180px;">
            <option value="">全部平台</option>
          </select>
        </div>
        <div class="admin-grid" id="siteList"></div>
      </div>
    </section>

    <section id="roleConsole" class="admin-section">
      <div class="section-header">
        <div>
          <h1>角色管理</h1>
          <div class="section-subtitle">以功能模块组合定义角色，可在默认角色之外扩展新的角色。</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" id="resetRoleBtn">恢复默认</button>
          <button class="btn btn-primary" id="saveRoleBtn">保存角色配置</button>
        </div>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">角色与模块</h2>
        <div class="role-grid" id="roleList"></div>
        <p class="section-subtitle">配置保存在浏览器本地，权限中心上线后将同步至后端。</p>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">新增角色</h2>
        <form id="newRoleForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="newRoleNameInput">角色名称 *</label>
              <input id="newRoleNameInput" placeholder="如：数据分析员" required>
            </div>
            <div class="form-group">
              <label for="newRoleKeyInput">角色标识 *</label>
              <input id="newRoleKeyInput" placeholder="如：data_analyst" required>
              <p class="form-hint">仅可包含字母、数字与下划线，用于接口识别。</p>
            </div>
            <div class="form-group">
              <label for="newRoleDescriptionInput">角色说明</label>
              <input id="newRoleDescriptionInput" placeholder="描述该角色的职责范围">
            </div>
          </div>
          <div class="form-group" style="margin-top:12px;">
            <label>赋予功能模块</label>
            <div class="role-modules" id="newRoleModules"></div>
            <p class="form-hint">提交后可在上方角色列表继续调整模块。</p>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">创建角色</button>
            <button type="button" class="btn" id="resetNewRoleForm">重置</button>
          </div>
        </form>
      </div>
    </section>

    <section id="userConsole" class="admin-section">
      <div class="section-header">
        <div>
          <h1>用户管理</h1>
          <div class="section-subtitle">为成员分配角色与站点范围，不同角色将继承相应模块权限。</div>
        </div>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">新增 / 编辑用户</h2>
        <form id="userForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="userNameInput">姓名 *</label>
              <input id="userNameInput" placeholder="如：王小明" required>
            </div>
            <div class="form-group">
              <label for="userEmailInput">邮箱 *</label>
              <input id="userEmailInput" type="email" placeholder="name@example.com" required>
            </div>
            <div class="form-group">
              <label for="userRoleSelect">角色 *</label>
              <select id="userRoleSelect" required></select>
            </div>
            <div class="form-group">
              <label for="userSiteMulti">授权站点 *</label>
              <select id="userSiteMulti" multiple required></select>
            </div>
          </div>
          <p class="multi-select-hint">按住 Ctrl / Command 可多选站点，至少选择一个站点才可保存。</p>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">保存用户</button>
            <button type="button" class="btn" id="resetUserForm">重置</button>
          </div>
        </form>
      </div>

      <div class="admin-card">
        <h2 style="margin-top:0">已授权用户</h2>
        <div id="userList" class="user-grid"></div>
      </div>
    </section>
  </main>
</div>

<script>
const PLATFORM_CATALOG = {
  ae_self_operated: {
    label: '速卖通自运营',
    dataSources: [
      { value: 'ae_api', label: '速卖通 API' },
      { value: 'ae_report', label: '速卖通运营报表' }
    ],
    quick: { name: 'robot', display: '速卖通自运营 Robot', domain: 'robot.aliexpress.com' }
  },
  ae_managed: {
    label: '速卖通全托管',
    dataSources: [
      { value: 'ae_api', label: '速卖通 API' },
      { value: 'managed_report', label: '全托管报表' }
    ],
    quick: { name: 'managed', display: '速卖通全托管旗舰店' }
  },
  independent: {
    label: '独立站',
    dataSources: [
      { value: 'google_ads', label: 'Google Ads' },
      { value: 'facebook_ads', label: 'Facebook Ads' },
      { value: 'tiktok_ads', label: 'TikTok Ads' },
      { value: 'custom', label: '自定义/埋点' }
    ],
    quick: { name: 'icyberite', display: '独立站 icyberite.com', domain: 'icyberite.com' }
  },
  amazon: {
    label: '亚马逊',
    dataSources: [
      { value: 'amazon_sp_api', label: 'Amazon SP-API' },
      { value: 'amazon_ads', label: 'Amazon Ads 报表' }
    ],
    quick: { name: 'amazon_store', display: '亚马逊旗舰店' }
  },
  ozon: {
    label: 'Ozon',
    dataSources: [
      { value: 'ozon_api', label: 'Ozon API' },
      { value: 'ozon_report', label: 'Ozon 报表' }
    ],
    quick: { name: 'ozon_main', display: 'Ozon 主站' }
  },
  tiktok: {
    label: 'TikTok Shop',
    dataSources: [
      { value: 'tiktok_shop_api', label: 'TikTok Shop API' },
      { value: 'tiktok_ads', label: 'TikTok Ads 报表' }
    ],
    quick: { name: 'tiktok_flagship', display: 'TikTok Shop 官方店' }
  },
  temu: {
    label: 'Temu',
    dataSources: [
      { value: 'temu_report', label: 'Temu 报表' },
      { value: 'temu_api', label: 'Temu API (规划)' }
    ],
    quick: { name: 'temu_global', display: 'Temu 全球店' }
  },
  lazada: {
    label: 'Lazada',
    dataSources: [
      { value: 'lazada_api', label: 'Lazada API' },
      { value: 'lazada_ads', label: 'Lazada Ads 报表' },
      { value: 'custom', label: '自定义/第三方' }
    ],
    quick: { name: 'lazada_my', display: 'Lazada 马来西亚旗舰店' }
  },
  shopee: {
    label: 'Shopee',
    dataSources: [
      { value: 'shopee_api', label: 'Shopee API' },
      { value: 'shopee_ads', label: 'Shopee Ads 报表' },
      { value: 'custom', label: '自定义/第三方' }
    ],
    quick: { name: 'shopee_sg', display: 'Shopee 新加坡旗舰店' }
  }
};

const DATA_SOURCE_LABELS = Object.values(PLATFORM_CATALOG).reduce((acc, platform) => {
  platform.dataSources.forEach(ds => acc[ds.value] = ds.label);
  return acc;
}, { custom: '自定义/第三方' });

const MODULE_DEFINITIONS = [
  { key: 'operations', label: '运营分析', description: '曝光、访客、加购、支付等全链路指标。' },
  { key: 'products', label: '产品分析', description: '商品维度分析、属性与绩效对比。' },
  { key: 'orders', label: '订单中心', description: '订单列表、客户信息、物流成本与结算状态。' },
  { key: 'advertising', label: '广告中心', description: '广告预算、投放配置、归因与带来访客/订单。' },
  { key: 'inventory', label: '库存管理 (全局)', description: '全局库存中心（批次、调拨、预警）。' },
  { key: 'permissions', label: '权限管理 (全局)', description: '角色、模块与站点权限设置，仅限超级管理员。' }
];

const MODULE_MAP = MODULE_DEFINITIONS.reduce((acc, item) => {
  acc[item.key] = item;
  return acc;
}, {});

const DEFAULT_ROLES = [
  {
    id: 'super_admin',
    label: '超级管理员',
    description: '拥有全部功能权限，可配置站点、模块与权限矩阵。',
    modules: MODULE_DEFINITIONS.map(item => item.key),
    order: 0
  },
  {
    id: 'operations_manager',
    label: '运营管理员',
    description: '聚焦核心运营指标与商品表现，查看报表与看板。',
    modules: ['operations', 'products', 'orders', 'advertising', 'inventory'],
    order: 1
  },
  {
    id: 'order_manager',
    label: '订单管理员',
    description: '管理订单、售后与物流信息，确保履约准确。',
    modules: ['orders'],
    order: 2
  },
  {
    id: 'inventory_manager',
    label: '库存管理员',
    description: '维护库存、调拨与预警配置，掌握供应链状态。',
    modules: ['inventory'],
    order: 3
  },
  {
    id: 'ad_manager',
    label: '广告管理员',
    description: '负责广告预算、投放配置与投放效果追踪。',
    modules: ['advertising'],
    order: 4
  },
  {
    id: 'finance',
    label: '财务',
    description: '查看结算、回款与费用分摊等财务数据。',
    modules: ['orders'],
    order: 5
  },
  {
    id: 'viewer',
    label: '只读用户',
    description: '只读访问主要看板，适用于业务查看。',
    modules: ['operations', 'products', 'orders', 'advertising'],
    order: 6
  }
];

const ROLE_STORAGE_KEY = 'adminRoleRegistry';
const USER_STORAGE_KEY = 'adminUserAccounts';

function createDefaultRoleRegistry() {
  return DEFAULT_ROLES.map(role => ({
    id: role.id,
    label: role.label,
    description: role.description,
    modules: [...role.modules],
    isCustom: false,
    createdAt: role.order ?? Date.now()
  }));
}

function sanitizeModules(modules) {
  if (!Array.isArray(modules)) {
    return [];
  }
  return Array.from(new Set(modules.filter(key => MODULE_MAP[key])));
}

function normalizeRoleId(raw) {
  const base = String(raw || '').trim().toLowerCase().replace(/[^a-z0-9_]+/g, '_');
  return base.replace(/^_+|_+$/g, '');
}

function loadRoleRegistry() {
  const defaults = createDefaultRoleRegistry();
  try {
    const cached = localStorage.getItem(ROLE_STORAGE_KEY);
    if (!cached) {
      return defaults;
    }
    const parsed = JSON.parse(cached);
    if (!Array.isArray(parsed)) {
      return defaults;
    }
    const sanitized = parsed.map(role => {
      const id = normalizeRoleId(role?.id || role?.key || '');
      if (!id) return null;
      const base = DEFAULT_ROLES.find(item => item.id === id);
      const modules = sanitizeModules(role?.modules);
      return {
        id,
        label: String(role?.label || base?.label || id).trim() || id,
        description: role?.description ? String(role.description) : (base?.description || ''),
        modules: modules.length ? modules : [...(base?.modules || [])],
        isCustom: !base,
        createdAt: typeof role?.createdAt === 'number' ? role.createdAt : Date.now()
      };
    }).filter(Boolean);

    const registryMap = new Map();
    sanitized.forEach(role => registryMap.set(role.id, role));

    defaults.forEach(role => {
      if (registryMap.has(role.id)) {
        const entry = registryMap.get(role.id);
        entry.label = entry.label || role.label;
        entry.description = entry.description || role.description;
        const cleaned = sanitizeModules(entry.modules);
        entry.modules = cleaned.length ? cleaned : [...role.modules];
        entry.isCustom = false;
        entry.createdAt = role.createdAt;
      } else {
        registryMap.set(role.id, { ...role });
      }
    });

    const result = Array.from(registryMap.values());
    result.sort((a, b) => {
      const defaultA = DEFAULT_ROLES.find(role => role.id === a.id);
      const defaultB = DEFAULT_ROLES.find(role => role.id === b.id);
      if (defaultA && defaultB) {
        return (defaultA.order ?? 0) - (defaultB.order ?? 0);
      }
      if (defaultA) return -1;
      if (defaultB) return 1;
      return (a.createdAt || 0) - (b.createdAt || 0);
    });

    return result;
  } catch (error) {
    console.warn('加载角色配置失败', error);
    return defaults;
  }
}

function saveRoleRegistry() {
  try {
    const payload = roleRegistry.map(role => ({
      id: role.id,
      label: role.label,
      description: role.description,
      modules: sanitizeModules(role.modules),
      isCustom: !!role.isCustom,
      createdAt: role.createdAt || Date.now()
    }));
    localStorage.setItem(ROLE_STORAGE_KEY, JSON.stringify(payload));
  } catch (error) {
    console.warn('保存角色配置失败', error);
  }
}

function getRoleById(roleId) {
  return roleRegistry.find(role => role.id === roleId);
}

function getRoleLabel(roleId) {
  const role = getRoleById(roleId);
  return role ? role.label : '';
}

let siteConfigs = [];
let roleRegistry = loadRoleRegistry();
let userAccounts = [];
let editingUserId = null;
let editingUserSites = [];

function setMessage(text, type = 'info') {
  const bar = document.getElementById('adminMessage');
  bar.textContent = text;
  bar.className = `message ${type}`;
  bar.style.display = text ? 'block' : 'none';
  if (text) {
    setTimeout(() => {
      bar.style.display = 'none';
    }, 4200);
  }
}

function switchSection(targetId) {
  document.querySelectorAll('.admin-section').forEach(section => {
    section.classList.toggle('active', section.id === targetId);
  });
  document.querySelectorAll('#adminNav a').forEach(link => {
    link.classList.toggle('active', link.dataset.target === targetId);
  });
}

function populatePlatformOptions() {
  const platformSelect = document.getElementById('platformSelect');
  const filterSelect = document.getElementById('platformFilter');

  platformSelect.innerHTML = '<option value="">选择平台</option>';
  filterSelect.innerHTML = '<option value="">全部平台</option>';

  Object.entries(PLATFORM_CATALOG).forEach(([value, config]) => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = config.label;
    platformSelect.appendChild(option);

    const filterOption = document.createElement('option');
    filterOption.value = value;
    filterOption.textContent = config.label;
    filterSelect.appendChild(filterOption);
  });
}

function populateQuickTemplates() {
  const container = document.getElementById('quickTemplates');
  container.innerHTML = '';
  Object.entries(PLATFORM_CATALOG).forEach(([value, config]) => {
    if (!config.quick) return;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-outline';
    btn.textContent = `${config.label} · 快速填充`;
    btn.addEventListener('click', () => {
      document.getElementById('platformSelect').value = value;
      document.getElementById('siteNameInput').value = config.quick.name || '';
      document.getElementById('displayNameInput').value = config.quick.display || '';
      document.getElementById('domainInput').value = config.quick.domain || '';
      updateDataSourceOptions();
    });
    container.appendChild(btn);
  });
}

function updateDataSourceOptions() {
  const platform = document.getElementById('platformSelect').value;
  const dataSourceSelect = document.getElementById('dataSourceSelect');
  dataSourceSelect.innerHTML = '<option value="">选择数据源</option>';

  const sources = PLATFORM_CATALOG[platform]?.dataSources || [];
  sources.forEach(source => {
    const option = document.createElement('option');
    option.value = source.value;
    option.textContent = source.label;
    dataSourceSelect.appendChild(option);
  });

  if (!sources.find(s => s.value === 'custom')) {
    const custom = document.createElement('option');
    custom.value = 'custom';
    custom.textContent = DATA_SOURCE_LABELS.custom;
    dataSourceSelect.appendChild(custom);
  }
}

async function loadSiteConfigs() {
  setMessage('正在加载站点配置...', 'info');
  try {
    const res = await fetch('/api/site-configs');
    const payload = await res.json();
    if (!res.ok) throw new Error(payload.error || '加载失败');
    siteConfigs = payload.data || [];
    document.getElementById('siteCount').textContent = siteConfigs.length;
    renderSiteList();
    populateSiteSelectors();
    renderUserList();
    setMessage(`已加载 ${siteConfigs.length} 个站点`, 'success');
  } catch (error) {
    console.error('加载站点失败', error);
    setMessage(`加载站点失败：${error.message}`, 'error');
  }
}

function renderSiteList() {
  const list = document.getElementById('siteList');
  const platformFilter = document.getElementById('platformFilter').value;
  const filtered = platformFilter ? siteConfigs.filter(item => item.platform === platformFilter) : siteConfigs;

  if (!filtered.length) {
    list.innerHTML = '<div class="message info">暂无站点，请先创建或更换筛选条件。</div>';
    return;
  }

  list.innerHTML = '';
  filtered.forEach(site => {
    const card = document.createElement('div');
    card.className = 'site-card';
    const platformLabel = PLATFORM_CATALOG[site.platform]?.label || site.platform;
    const dataSourceLabel = DATA_SOURCE_LABELS[site.data_source] || site.data_source || '未配置';
    card.innerHTML = `
      <div>
        <h3>${site.display_name || site.name}</h3>
        <div class="section-subtitle">站点 ID：${site.id}</div>
      </div>
      <div class="site-meta">
        <div><strong>平台：</strong>${platformLabel}</div>
        <div><strong>数据源：</strong>${dataSourceLabel}</div>
        <div><strong>模板：</strong>${site.template_id || '自动匹配'}</div>
        <div><strong>域名：</strong>${site.domain || '—'}</div>
        <div><strong>状态：</strong>${site.is_active === false ? '未激活' : '启用中'}</div>
        <div><strong>创建时间：</strong>${site.created_at ? new Date(site.created_at).toLocaleString() : '—'}</div>
      </div>
      <div class="site-actions">
        <button class="btn" data-action="prefill" data-site-id="${site.id}">填充到表单</button>
        <button class="btn btn-danger" data-action="delete" data-site-id="${site.id}">删除站点</button>
      </div>
    `;
    list.appendChild(card);
  });

  list.querySelectorAll('button[data-action="prefill"]').forEach(btn => {
    btn.addEventListener('click', () => {
      try {
        const site = siteConfigs.find(item => item.id === btn.dataset.siteId);
        if (!site) throw new Error('未找到站点配置');
        document.getElementById('platformSelect').value = site.platform;
        updateDataSourceOptions();
        document.getElementById('siteNameInput').value = site.name;
        document.getElementById('displayNameInput').value = site.display_name || '';
        document.getElementById('domainInput').value = site.domain || '';
        document.getElementById('dataSourceSelect').value = site.data_source || '';
        document.getElementById('templateSelect').value = site.template_id || '';
        document.getElementById('configJsonInput').value = site.config_json ? JSON.stringify(site.config_json, null, 2) : '';
        switchSection('siteConsole');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (error) {
        console.warn('Prefill 失败', error);
      }
    });
  });

  list.querySelectorAll('button[data-action="delete"]').forEach(btn => {
    btn.addEventListener('click', () => deleteSiteConfig(btn.dataset.siteId));
  });
}

async function submitSiteForm(event) {
  event.preventDefault();
  const platform = document.getElementById('platformSelect').value;
  const name = document.getElementById('siteNameInput').value.trim();
  const displayName = document.getElementById('displayNameInput').value.trim();
  const domain = document.getElementById('domainInput').value.trim() || null;
  const dataSource = document.getElementById('dataSourceSelect').value;
  const templateId = document.getElementById('templateSelect').value || null;
  const configRaw = document.getElementById('configJsonInput').value.trim();

  if (!platform || !name || !displayName || !dataSource) {
    setMessage('请完整填写平台、站点名称、显示名称与数据源。', 'error');
    return;
  }

  let configJson = null;
  if (configRaw) {
    try {
      configJson = JSON.parse(configRaw);
    } catch (error) {
      setMessage('配置信息需为合法 JSON 格式。', 'error');
      return;
    }
  }

  setMessage('正在保存站点配置...', 'info');
  try {
    const res = await fetch('/api/site-configs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        platform,
        name,
        display_name: displayName,
        domain,
        data_source: dataSource,
        template_id: templateId,
        config_json: configJson
      })
    });
    const payload = await res.json();
    if (!res.ok) throw new Error(payload.error || '保存失败');

    setMessage('站点已保存。', 'success');
    await loadSiteConfigs();
    document.getElementById('siteForm').reset();
    updateDataSourceOptions();
  } catch (error) {
    console.error('保存站点失败', error);
    setMessage(`保存站点失败：${error.message}`, 'error');
  }
}

function populateSiteSelectors() {
  const userSiteSelect = document.getElementById('userSiteMulti');
  if (!userSiteSelect) return;

  const preserved = editingUserId
    ? new Set(editingUserSites)
    : new Set(Array.from(userSiteSelect.selectedOptions || []).map(opt => opt.value));

  userSiteSelect.innerHTML = '';
  siteConfigs.forEach(site => {
    const option = document.createElement('option');
    option.value = site.id;
    option.textContent = `${site.display_name || site.name} (${site.platform})`;
    if (preserved.has(site.id)) {
      option.selected = true;
    }
    userSiteSelect.appendChild(option);
  });
}

async function deleteSiteConfig(siteId) {
  if (!siteId) return;
  const target = siteConfigs.find(item => item.id === siteId);
  const name = target ? (target.display_name || target.name || siteId) : siteId;
  const confirmed = confirm(`确定要删除站点「${name}」吗？删除后导航与权限配置将移除该站点。`);
  if (!confirmed) return;

  setMessage('正在删除站点...', 'info');
  try {
    const res = await fetch('/api/site-configs/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ siteId })
    });
    const payload = await res.json();
    if (!res.ok) throw new Error(payload.error || '删除失败');
    setMessage('站点已删除。', 'success');
    await loadSiteConfigs();
  } catch (error) {
    console.error('删除站点失败', error);
    setMessage(`删除站点失败：${error.message}`, 'error');
  }
}

function renderRoleManagement() {
  const container = document.getElementById('roleList');
  if (!container) return;
  container.innerHTML = '';

  roleRegistry.forEach(role => {
    const modules = new Set(role.modules || []);
    const card = document.createElement('div');
    card.className = 'role-card';
    const chip = role.isCustom ? '<span class="chip">自定义</span>' : '<span class="chip chip-muted">默认</span>';
    const checkboxHtml = MODULE_DEFINITIONS.map(module => {
      const checked = modules.has(module.key) ? 'checked' : '';
      return `<label class="role-checkbox"><input type="checkbox" data-role="${role.id}" data-module="${module.key}" ${checked}><span>${module.label}</span></label>`;
    }).join('');
    card.innerHTML = `
      <div class="role-card-header">
        <div>
          <h3>${role.label} ${chip}</h3>
          <div class="role-id">标识：${role.id}</div>
          <div class="role-meta">${role.description || '尚未填写角色说明。'}</div>
        </div>
        ${role.isCustom ? `<div class="role-card-actions"><button class="btn btn-danger" data-action="remove-role" data-role-id="${role.id}">删除</button></div>` : ''}
      </div>
      <div class="role-modules">
        ${checkboxHtml || '<span class="chip chip-muted">暂无可配置模块</span>'}
      </div>
    `;
    container.appendChild(card);
  });

  container.querySelectorAll('input[type="checkbox"]').forEach(input => {
    input.addEventListener('change', () => {
      const roleId = input.dataset.role;
      const moduleKey = input.dataset.module;
      const target = getRoleById(roleId);
      if (!target) return;
      const modules = new Set(target.modules || []);
      if (input.checked) {
        modules.add(moduleKey);
      } else {
        modules.delete(moduleKey);
      }
      target.modules = Array.from(modules);
      renderUserList();
    });
  });

  container.querySelectorAll('button[data-action="remove-role"]').forEach(btn => {
    btn.addEventListener('click', () => removeCustomRole(btn.dataset.roleId));
  });
}

function populateRoleOptions() {
  const roleSelect = document.getElementById('userRoleSelect');
  if (!roleSelect) return;
  const current = roleSelect.value;
  roleSelect.innerHTML = '<option value="">选择角色</option>';
  roleRegistry.forEach(role => {
    const option = document.createElement('option');
    option.value = role.id;
    option.textContent = role.label;
    if (role.id === current) {
      option.selected = true;
    }
    roleSelect.appendChild(option);
  });
}

function handleSaveRoleConfig() {
  roleRegistry.forEach(role => {
    role.modules = sanitizeModules(role.modules);
  });
  saveRoleRegistry();
  renderRoleManagement();
  populateRoleOptions();
  renderUserList();
  setMessage('角色配置已保存。', 'success');
}

function resetRoleConfig() {
  roleRegistry = createDefaultRoleRegistry();
  saveRoleRegistry();
  renderRoleManagement();
  populateRoleOptions();
  renderUserList();
  setMessage('已恢复默认角色配置。', 'success');
}

function getRoleModuleLabels(roleId) {
  const role = getRoleById(roleId);
  if (!role) return [];
  return sanitizeModules(role.modules).map(moduleKey => MODULE_MAP[moduleKey]?.label || moduleKey);
}

function removeCustomRole(roleId) {
  const target = getRoleById(roleId);
  if (!target || !target.isCustom) return;
  const confirmed = confirm(`确定要删除角色「${target.label}」吗？已分配该角色的用户将需要重新选择角色。`);
  if (!confirmed) return;

  roleRegistry = roleRegistry.filter(role => role.id !== roleId);
  let affected = 0;
  userAccounts = userAccounts.map(user => {
    if (user.role === roleId) {
      affected += 1;
      return { ...user, role: '' };
    }
    return user;
  });

  saveRoleRegistry();
  saveUserAccounts();
  renderRoleManagement();
  populateRoleOptions();
  renderUserList();

  if (affected > 0) {
    setMessage(`已删除角色「${target.label}」，${affected} 名用户需要重新分配角色。`, 'info');
  } else {
    setMessage(`已删除角色「${target.label}」。`, 'success');
  }
}

function renderNewRoleModuleOptions() {
  const container = document.getElementById('newRoleModules');
  if (!container) return;
  container.innerHTML = MODULE_DEFINITIONS.map(module => `
    <label class="role-checkbox">
      <input type="checkbox" value="${module.key}">
      <span>${module.label}</span>
    </label>
  `).join('');
}

function handleNewRoleSubmit(event) {
  event.preventDefault();
  const nameInput = document.getElementById('newRoleNameInput');
  const keyInput = document.getElementById('newRoleKeyInput');
  const descInput = document.getElementById('newRoleDescriptionInput');
  const modulesContainer = document.getElementById('newRoleModules');

  const label = nameInput?.value.trim();
  const rawKey = keyInput?.value.trim();

  if (!label || !rawKey) {
    setMessage('请填写角色名称和标识。', 'error');
    return;
  }

  const normalized = normalizeRoleId(rawKey);
  if (!normalized || !/^[a-z0-9_]+$/.test(normalized)) {
    setMessage('角色标识仅支持字母、数字与下划线。', 'error');
    return;
  }

  if (getRoleById(normalized)) {
    setMessage('角色标识已存在，请更换一个。', 'error');
    return;
  }

  const selectedModules = modulesContainer
    ? Array.from(modulesContainer.querySelectorAll('input[type="checkbox"]:checked')).map(input => input.value)
    : [];

  if (!selectedModules.length) {
    setMessage('请至少选择一个功能模块。', 'error');
    return;
  }

  const newRole = {
    id: normalized,
    label,
    description: descInput?.value.trim() || '',
    modules: sanitizeModules(selectedModules),
    isCustom: true,
    createdAt: Date.now()
  };

  roleRegistry.push(newRole);
  saveRoleRegistry();
  renderRoleManagement();
  populateRoleOptions();
  renderUserList();
  resetNewRoleForm();
  setMessage(`已创建角色「${label}」。`, 'success');
}

function resetNewRoleForm() {
  const form = document.getElementById('newRoleForm');
  if (form) {
    form.reset();
  }
  renderNewRoleModuleOptions();
}

function getSiteDisplayName(siteId) {
  const site = siteConfigs.find(item => item.id === siteId);
  return site ? (site.display_name || site.name || siteId) : siteId;
}

function loadUserAccounts() {
  try {
    const cached = localStorage.getItem(USER_STORAGE_KEY);
    if (!cached) {
      userAccounts = [];
      return;
    }
    const parsed = JSON.parse(cached);
    userAccounts = Array.isArray(parsed) ? parsed : [];
  } catch (error) {
    console.warn('加载用户配置失败', error);
    userAccounts = [];
  }
}

function saveUserAccounts() {
  try {
    localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(userAccounts));
  } catch (error) {
    console.warn('保存用户配置失败', error);
  }
}

function renderUserList() {
  const container = document.getElementById('userList');
  if (!container) return;

  if (!userAccounts.length) {
    container.innerHTML = '<div class="message info">暂无用户，请添加成员后分配角色。</div>';
    return;
  }

  container.innerHTML = '';
  userAccounts.forEach(user => {
    const card = document.createElement('div');
    card.className = 'user-card';
    const role = getRoleById(user.role);
    const roleLabel = role ? role.label : '';
    const moduleLabels = role ? getRoleModuleLabels(user.role) : [];
    const moduleHtml = moduleLabels.length
      ? moduleLabels.map(label => `<span class="chip">${label}</span>`).join('')
      : '<span class="chip chip-muted">未分配模块</span>';
    const siteHtml = Array.isArray(user.sites) && user.sites.length
      ? user.sites.map(getSiteDisplayName).map(name => `<span class="chip chip-muted">${name}</span>`).join('')
      : '<span class="chip chip-muted">未分配站点</span>';
    const roleHtml = roleLabel || '<span class="chip chip-muted">未分配</span>';

    card.innerHTML = `
      <div>
        <h3>${user.name}</h3>
        <div class="section-subtitle">${user.email}</div>
      </div>
      <div class="user-meta">
        <div><strong>角色：</strong>${roleHtml}</div>
        <div><strong>可访问模块：</strong>${moduleHtml}</div>
        <div><strong>授权站点：</strong>${siteHtml}</div>
      </div>
      <div class="site-actions">
        <button class="btn" data-action="edit-user" data-user-id="${user.id}">编辑</button>
        <button class="btn btn-danger" data-action="remove-user" data-user-id="${user.id}">删除</button>
      </div>
    `;
    container.appendChild(card);
  });

  container.querySelectorAll('button[data-action="edit-user"]').forEach(btn => {
    btn.addEventListener('click', () => editUser(btn.dataset.userId));
  });

  container.querySelectorAll('button[data-action="remove-user"]').forEach(btn => {
    btn.addEventListener('click', () => removeUser(btn.dataset.userId));
  });
}

function handleUserFormSubmit(event) {
  event.preventDefault();
  const name = document.getElementById('userNameInput').value.trim();
  const email = document.getElementById('userEmailInput').value.trim();
  const role = document.getElementById('userRoleSelect').value;
  const siteSelect = document.getElementById('userSiteMulti');
  const sites = siteSelect ? Array.from(siteSelect.selectedOptions).map(opt => opt.value) : [];

  if (!name || !email || !role) {
    setMessage('请填写完整的用户姓名、邮箱并选择角色。', 'error');
    return;
  }

  if (!sites.length) {
    setMessage('请至少选择一个授权站点。', 'error');
    return;
  }

  if (!getRoleById(role)) {
    setMessage('所选角色不存在，请刷新后重试。', 'error');
    return;
  }

  const payload = {
    id: editingUserId || `user_${Date.now()}`,
    name,
    email,
    role,
    sites
  };

  if (editingUserId) {
    const index = userAccounts.findIndex(user => user.id === editingUserId);
    if (index >= 0) {
      userAccounts[index] = payload;
      setMessage(`已更新用户 ${name}。`, 'success');
    }
  } else {
    userAccounts.push(payload);
    setMessage(`已添加用户 ${name}。`, 'success');
  }

  saveUserAccounts();
  resetUserForm();
  renderUserList();
}

function resetUserForm() {
  editingUserId = null;
  editingUserSites = [];
  const form = document.getElementById('userForm');
  if (form) {
    form.reset();
  }
  populateRoleOptions();
  populateSiteSelectors();
  const siteSelect = document.getElementById('userSiteMulti');
  if (siteSelect) {
    Array.from(siteSelect.options).forEach(option => {
      option.selected = false;
    });
  }
}

function editUser(userId) {
  const target = userAccounts.find(user => user.id === userId);
  if (!target) return;
  editingUserId = target.id;
  editingUserSites = Array.isArray(target.sites) ? [...target.sites] : [];
  document.getElementById('userNameInput').value = target.name || '';
  document.getElementById('userEmailInput').value = target.email || '';
  populateRoleOptions();
  document.getElementById('userRoleSelect').value = target.role || '';
  populateSiteSelectors();
  const siteSelect = document.getElementById('userSiteMulti');
  if (siteSelect) {
    Array.from(siteSelect.options).forEach(option => {
      option.selected = editingUserSites.includes(option.value);
    });
  }
  setMessage(`正在编辑用户 ${target.name}`, 'info');
  switchSection('userConsole');
}

function removeUser(userId) {
  const target = userAccounts.find(user => user.id === userId);
  if (!target) return;
  const confirmed = confirm(`确定要删除用户「${target.name}」吗？`);
  if (!confirmed) return;
  userAccounts = userAccounts.filter(user => user.id !== userId);
  saveUserAccounts();
  renderUserList();
  if (editingUserId === userId) {
    resetUserForm();
  }
  setMessage(`已删除用户 ${target.name}。`, 'success');
}

function setupAuth() {
  const loginOverlay = document.getElementById('loginOverlay');
  const loginForm = document.getElementById('loginForm');
  const userArea = document.getElementById('userArea');

  function checkAuth() {
    const token = localStorage.getItem('authToken');
    if (!token) {
      loginOverlay.style.display = 'flex';
    } else {
      loginOverlay.style.display = 'none';
      userArea.innerHTML = `
        <span>欢迎，管理员</span>
        <button class="btn" id="logoutBtn">退出</button>
      `;
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        checkAuth();
      });
    }
  }

  loginForm.addEventListener('submit', (event) => {
    event.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if (email === 'demo@example.com' && password === 'demo123') {
      localStorage.setItem('authToken', 'demo-token');
      checkAuth();
    } else {
      alert('登录失败，请检查邮箱和密码');
    }
  });

  document.getElementById('password-toggle').addEventListener('click', () => {
    const input = document.getElementById('password');
    input.type = input.type === 'password' ? 'text' : 'password';
  });

  checkAuth();
}

function initializeAdmin() {
  document.querySelectorAll('#adminNav a').forEach(link => {
    link.addEventListener('click', event => {
      event.preventDefault();
      switchSection(link.dataset.target);
    });
  });

  document.getElementById('platformSelect').addEventListener('change', () => {
    updateDataSourceOptions();
  });

  document.getElementById('platformFilter').addEventListener('change', renderSiteList);
  document.getElementById('siteForm').addEventListener('submit', submitSiteForm);
  document.getElementById('resetSiteForm').addEventListener('click', () => {
    document.getElementById('siteForm').reset();
    updateDataSourceOptions();
  });
  document.getElementById('refreshSitesBtn').addEventListener('click', loadSiteConfigs);

  const saveRoleBtn = document.getElementById('saveRoleBtn');
  const resetRoleBtn = document.getElementById('resetRoleBtn');
  if (saveRoleBtn) {
    saveRoleBtn.addEventListener('click', handleSaveRoleConfig);
  }
  if (resetRoleBtn) {
    resetRoleBtn.addEventListener('click', resetRoleConfig);
  }

  const newRoleForm = document.getElementById('newRoleForm');
  if (newRoleForm) {
    newRoleForm.addEventListener('submit', handleNewRoleSubmit);
  }
  const resetNewRoleBtn = document.getElementById('resetNewRoleForm');
  if (resetNewRoleBtn) {
    resetNewRoleBtn.addEventListener('click', resetNewRoleForm);
  }

  const userForm = document.getElementById('userForm');
  if (userForm) {
    userForm.addEventListener('submit', handleUserFormSubmit);
  }
  const resetUserBtn = document.getElementById('resetUserForm');
  if (resetUserBtn) {
    resetUserBtn.addEventListener('click', resetUserForm);
  }

  populatePlatformOptions();
  populateQuickTemplates();
  updateDataSourceOptions();
  renderNewRoleModuleOptions();
  populateRoleOptions();
  renderRoleManagement();
  loadUserAccounts();
  renderUserList();
  loadSiteConfigs();
  switchSection('siteConsole');
}

document.addEventListener('DOMContentLoaded', () => {
  setupAuth();
  initializeAdmin();
});
</script>
</body>
</html>
