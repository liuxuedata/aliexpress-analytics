<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>产品分析</title>
  <link rel="stylesheet" href="assets/theme.css?v=20250812-deep">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="assets/product-meta.js"></script>
  <script>const t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);</script>
</head>
<body>
<header class="header">
  <div class="logo-title">跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="#">速卖通</a>
        <ul class="dropdown">
          <li><a href="index.html">全托管</a></li>
          <li><a href="self-operated.html">自运营</a></li>
        </ul>
      </li>
      <li class="amazon"><a href="amazon.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="independent-site.html">独立站</a></li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span id="currentSite"></span><button id="addSite" class="add-site-btn">+</button></div>
    <ul class="sub-nav">
      <li><a id="detailLink" href="index.html">详细数据</a></li>
      <li><a id="analysisLink" href="operation-analysis.html">运营分析</a></li>
      <li><a class="active" href="#">产品分析</a></li>
    </ul>
  </nav>
  <main class="main">
    <div class="content">
      <section class="content-pad">
        <div id="ctrl" class="controls" style="margin-bottom:12px;"></div>
        <div class="controls" style="margin-bottom:12px;flex-wrap:wrap;"><label>产品</label><select id="productSelect" class="sel" style="width:200px;flex:0 0 200px;"></select><img id="productImg" style="width:40px;height:40px;object-fit:cover;margin-left:8px;display:none;"/><a id="productLink" href="#" target="_blank" style="margin-left:8px;display:none;word-break:break-all;white-space:normal;flex:1 1 auto;"></a><span id="listingDate" style="margin-left:8px;"></span></div>
        <div id="kpi" class="kpi-row"></div>
        <div id="lineWrap" class="panel" style="margin-top:16px;display:none;">
          <h3>曝光趋势</h3>
          <div id="expLine" style="width:100%;height:260px;"></div>
          <h3 style="margin-top:24px;">访客比趋势</h3>
          <div id="uvRateLine" style="width:100%;height:260px;"></div>
          <h3 style="margin-top:24px;">加购比趋势</h3>
          <div id="addRateLine" style="width:100%;height:260px;"></div>
        </div>
      </section>
    </div>
  </main>
</div>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const params=new URLSearchParams(location.search);
  const mode=params.get('mode');
  const detailLink=document.getElementById('detailLink');
  const analysisLink=document.getElementById('analysisLink');
  const prodLink=document.getElementById('productLink');
  const platformNav=document.querySelector('.platform-nav');
  platformNav.querySelectorAll('li').forEach(li=>li.classList.remove('active'));
  const platformMap={
    indep:'li.independent',
    ozon:'li.ozon',
    amazon:'li.amazon',
    tiktok:'li.tiktok',
    temu:'li.temu'
  };
  const selector=platformMap[mode];
  if(selector){
    platformNav.querySelector(selector)?.classList.add('active');
  }else{
    const aliLi=platformNav.querySelector('li.ali');
    aliLi?.classList.add('active');
    aliLi?.querySelectorAll('.dropdown li').forEach(li=>li.classList.remove('active'));
    if(mode==='self'){
      aliLi?.querySelector('a[href="self-operated.html"]')?.parentElement.classList.add('active');
    }else{
      aliLi?.querySelector('a[href="index.html"]')?.parentElement.classList.add('active');
    }
  }
  function setProdLink(text,url){
    if(text && url){
      prodLink.textContent=text;
      prodLink.href=url;
      prodLink.title=url;
      prodLink.style.display='';
    }else{
      prodLink.style.display='none';
    }
  }
  if(mode==='self'){
    if(detailLink)detailLink.href='self-operated.html';
    if(analysisLink)analysisLink.href='operation-analysis.html?mode=self';
  }else if(mode==='indep'){
    if(detailLink)detailLink.href='independent-site.html';
    if(analysisLink)analysisLink.removeAttribute('href');
  }else if(mode==='ozon'){
    if(detailLink)detailLink.href='ozon-detail.html';
    if(analysisLink)analysisLink.href='ozon-analysis.html';
  }else{
    if(analysisLink)analysisLink.href='operation-analysis.html';
  }

  const siteListKey='managedSites';
  const currentSiteKey='currentSite';
  let sites=JSON.parse(localStorage.getItem(siteListKey)||'null');
  if(!Array.isArray(sites)||!sites.length){sites=mode==='self'?['A站','B站','C站']:['主站'];}
  const currentSiteEl=document.getElementById('currentSite');
  function save(){localStorage.setItem(siteListKey,JSON.stringify(sites));}
  function updateCurrent(){
    const name=localStorage.getItem(currentSiteKey)||sites[0];
    if(mode==='self'){
      currentSiteEl.textContent='自运营 '+name;
    }else if(mode==='indep'){
      currentSiteEl.textContent='独立站';
    }else{
      currentSiteEl.textContent=sites.length>1?'全托管 '+name:'全托管';
    }
    localStorage.setItem(currentSiteKey,name);
  }
  currentSiteEl.addEventListener('dblclick',()=>{
    if(mode==='indep')return;
    const cur=localStorage.getItem(currentSiteKey)||sites[0];
    const idx=sites.indexOf(cur);
    const n=prompt('修改站点名',cur);
    if(n){sites[idx]=n;save();localStorage.setItem(currentSiteKey,n);updateCurrent();}
  });
  document.getElementById('addSite').addEventListener('click',()=>{
    if(mode==='indep')return;
    const n=prompt('新增站点名');
    if(n){sites.push(n);save();updateCurrent();}
  });
  updateCurrent();

  if(mode==='self' || mode==='indep'){
    setupSelf(mode);
  }else{
    setupFM();
  }

  function card(title,cur,prev,isPct,avg,share){
    const diff=(cur-prev)||0;
    const arrow=diff>=0?'↑':'↓';
    const cls=diff>=0?'up':'down';
    const fmt=v=>isPct?`${(v*100).toFixed(2)}%`:v;
    const delta=isPct?`${Math.abs(diff*100).toFixed(2)}%`:Math.abs(diff);
    const parts=[`<span class="delta ${cls}">${arrow} ${delta}</span>`];
    if(avg!=null){
      const diffAvg=(cur-avg)||0;
      const dir=diffAvg>=0?'高于平均':'低于平均';
      const clsAvg=diffAvg>=0?'up':'down';
      const deltaAvg=isPct?`${Math.abs(diffAvg*100).toFixed(2)}%`:Math.abs(diffAvg);
      parts.push(`<span class="${clsAvg}" style="margin-left:8px;">${dir} ${deltaAvg}</span>`);
    }
    if(share!=null){
      parts.push(`<span style="margin-left:8px;">占比 ${(share*100).toFixed(2)}%</span>`);
    }
    return `<div class="stat-card"><h4>${title}</h4><p>${fmt(cur)}</p><div class="sub">${parts.join('')}</div></div>`;
  }

  function setupFM(){
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<label>粒度</label><label><input type="radio" name="gran" value="week"> 周</label><label><input type="radio" name="gran" value="month"> 月</label><select id="periodSelect" class="sel"></select>';
    const state={ granularity: localStorage.getItem('fmGranularity')||'week', periods: [] };
    document.querySelector(`input[name="gran"][value="${state.granularity}"]`).checked=true;
    document.querySelectorAll('input[name="gran"]').forEach(r=>r.addEventListener('change',e=>{state.granularity=e.target.value;localStorage.setItem('fmGranularity',state.granularity);loadPeriods();}));
    document.getElementById('periodSelect').addEventListener('change',loadData);
    function loadPeriods(){
      fetch('/api/periods').then(r=>r.json()).then(j=>{
        const list=(state.granularity==='week'?j.weeks:j.months)||[];
        state.periods=list.slice();
        const sel=document.getElementById('periodSelect');
        sel.innerHTML='';
        if(!list.length){sel.innerHTML='<option value="">暂无数据</option>';return;}
        list.forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o);});
        const stored=localStorage.getItem('fmPeriod');
        if(stored && list.includes(stored)) sel.value=stored; else {sel.value=list[0]; localStorage.setItem('fmPeriod',list[0]);}
        loadData();
      });
    }
    async function loadData(){
      const period=document.getElementById('periodSelect').value;
      localStorage.setItem('fmPeriod',period||'');
        const idx=state.periods.indexOf(period); const prev=(idx>=0 && idx<state.periods.length-1)?state.periods[idx+1]:'';
      const qsA=new URLSearchParams({granularity:state.granularity}); if(period)qsA.set('period_end',period);
      const qsB=new URLSearchParams({granularity:state.granularity}); if(prev)qsB.set('period_end',prev);
      const [ja,jb]=await Promise.all([
        fetch('/api/stats?'+qsA.toString()).then(r=>r.json()),
        prev?fetch('/api/stats?'+qsB.toString()).then(r=>r.json()):Promise.resolve({rows:[]})
      ]);
      const rowsA=ja.rows||[]; const rowsB=jb.rows||[];
      renderProductFM(rowsA,rowsB);
    }
    function renderProductFM(rowsA,rowsB){
      const expMap=new Map();
      rowsA.forEach(r=>expMap.set(r.product_id,(expMap.get(r.product_id)||0)+Number(r.search_exposure||0)));
      const totalsA=rowsA.reduce((a,x)=>({
        exp:a.exp+Number(x.search_exposure||0),
        uv:a.uv+Number(x.uv||0),
        add:a.add+Number(x.add_to_cart_users||0),
        pay:a.pay+Number(x.pay_buyers||0)
      }),{exp:0,uv:0,add:0,pay:0});
      const ids=Array.from(expMap.keys()).sort((a,b)=>expMap.get(b)-expMap.get(a));
      const sel=document.getElementById('productSelect');
      sel.innerHTML='';
      ids.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;o.setAttribute('data-pid',id);sel.appendChild(o);});
      populateProductNames(sel);
      if(!ids.length){document.getElementById('kpi').innerHTML=''; setProdLink('',''); return;}
      const pid=ids[0]; sel.value=pid; update(pid);
      sel.onchange=()=>update(sel.value);
      function sum(rows,pid){
        return rows.filter(x=>String(x.product_id)===String(pid)).reduce((a,x)=>({
          exp:a.exp+Number(x.search_exposure||0),
          uv:a.uv+Number(x.uv||0),
          add:a.add+Number(x.add_to_cart_users||0),
          pay:a.pay+Number(x.pay_buyers||0)
        }),{exp:0,uv:0,add:0,pay:0});
      }
      function update(pid){
        const cur=sum(rowsA,pid); const prev=sum(rowsB,pid);
        const curUvRate=cur.exp?cur.uv/cur.exp:0;
        const prevUvRate=prev.exp?prev.uv/prev.exp:0;
        const curAddRate=cur.uv?cur.add/cur.uv:0;
        const prevAddRate=prev.uv?prev.add/prev.uv:0;
        const curPayRate=cur.uv?cur.pay/cur.uv:0;
        const prevPayRate=prev.uv?prev.pay/prev.uv:0;
        const avgUvRate=totalsA.exp?totalsA.uv/totalsA.exp:0;
        const avgAddRate=totalsA.uv?totalsA.add/totalsA.uv:0;
        const avgPayRate=totalsA.uv?totalsA.pay/totalsA.uv:0;
        const shareExp=totalsA.exp?cur.exp/totalsA.exp:0;
        const shareUv=totalsA.uv?cur.uv/totalsA.uv:0;
        const shareAdd=totalsA.add?cur.add/totalsA.add:0;
        const sharePay=totalsA.pay?cur.pay/totalsA.pay:0;
        document.getElementById('kpi').innerHTML=[
          card('平均访客比',curUvRate,prevUvRate,true,avgUvRate),
          card('平均加购比',curAddRate,prevAddRate,true,avgAddRate),
          card('平均支付比',curPayRate,prevPayRate,true,avgPayRate),
          card('总曝光量',cur.exp,prev.exp,false,null,shareExp),
          card('总访客数',cur.uv,prev.uv,false,null,shareUv),
          card('总加购人数',cur.add,prev.add,false,null,shareAdd),
          card('总支付买家数',cur.pay,prev.pay,false,null,sharePay)
        ].join('');
        const dates=[...rowsA,...rowsB].filter(x=>String(x.product_id)===String(pid)).map(x=>x.period_start||x.period_end||'').filter(Boolean).sort();
        document.getElementById('listingDate').textContent=dates.length?`上架日期：${dates[0]}`:'';
        const url=`https://aliexpress.com/item/${pid}.html`;
        getProductMeta(pid,url).then(m=>{
          setProdLink(m.title||pid,url);
          const img=document.getElementById('productImg');
          img.src=m.image||'';
          img.style.display=m.image?'':'none';
        });
      }
    }
    loadPeriods();
  }

  function setupSelf(mode){
    document.getElementById('lineWrap').style.display='block';
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<input id="dateRange" class="date-filter" placeholder="选择日期范围">';
    const input=document.getElementById('dateRange');
    const key=mode==='indep'?'indepPeriod':'selfPeriod';
    const fp=flatpickr(input,{mode:'range',dateFormat:'Y-m-d',onClose:ds=>{if(ds.length===2)loadData();}});
    const stored=localStorage.getItem(key);
    if(stored && stored.includes(' to ')) input.value=stored; else {
      const today=new Date(); const end=today.toISOString().slice(0,10); const start=new Date(today.getTime()-6*86400000).toISOString().slice(0,10); const def=`${start} to ${end}`; input.value=def; localStorage.setItem(key,def);
    }
    async function loadData(){
      const val=input.value; if(!val.includes(' to '))return; const [startISO,endISO]=val.split(' to '); localStorage.setItem(key,`${startISO} to ${endISO}`);
      const {prevStart,prevEnd,days}=periodShift(startISO,endISO);
      const [rowsA,rowsB]=await Promise.all([
        fetchAgg(startISO,endISO),
        fetchAgg(prevStart,prevEnd)
      ]);
      renderProductSelf(rowsA,rowsB,days,startISO,prevStart);
    }
    function fetchAgg(start,end){
      if(mode==='indep'){
        const site=params.get('site')||localStorage.getItem('indepSite')||'poolsvacuum.com';
        localStorage.setItem('indepSite',site);
        const url=`/api/independent/stats?site=${encodeURIComponent(site)}&from=${start}&to=${end}`;
        return fetch(url).then(r=>r.json()).then(j=>j.table||[]);
      }
      const url=`/api/ae_query?start=${start}&end=${end}&granularity=day`;
      return fetch(url).then(r=>r.json()).then(j=>j.rows||[]);
    }
    function periodShift(startISO,endISO){
      const start=new Date(startISO+'T00:00:00'); const end=new Date(endISO+'T00:00:00');
      const days=Math.round((end-start)/86400000)+1;
      const prevEnd=new Date(start.getTime()-86400000);
      const prevStart=new Date(prevEnd.getTime()-(days-1)*86400000);
      const fmt=d=>d.toISOString().slice(0,10);
      return{prevStart:fmt(prevStart),prevEnd:fmt(prevEnd),days};
    }
    function renderProductSelf(rowsA,rowsB,days,startA,startB){
      const expMap=new Map();
      const linkMap=new Map();
      const getId=r=>mode==='indep'?r.product:r.product_id;
      const getExp=r=>mode==='indep'?Number(r.impr||0):Number(r.exposure||0);
      rowsA.forEach(r=>{const id=getId(r);expMap.set(id,(expMap.get(id)||0)+getExp(r)); if(mode==='indep' && r.landing_url) linkMap.set(id,r.landing_url);});
      const totalsA=rowsA.reduce((a,r)=>({
        exp:a.exp+getExp(r),
        uv:a.uv+Number(mode==='indep'?r.clicks||0:r.visitors||0),
        add:a.add+Number(mode==='indep'?0:r.add_people||0),
        pay:a.pay+Number(mode==='indep'?r.conversions||0:r.pay_buyers||0)
      }),{exp:0,uv:0,add:0,pay:0});
      const ids=Array.from(expMap.keys()).sort((a,b)=>expMap.get(b)-expMap.get(a));
      const sel=document.getElementById('productSelect'); sel.innerHTML='';
      ids.forEach(id=>{
        const o=document.createElement('option');
        o.value=id; o.textContent=id;
        if(mode==='indep'){
          const link=linkMap.get(id);
          if(link){ o.dataset.url=link; o.dataset.api='/api/indep_fetchProductInfo'; }
        }else{
          o.setAttribute('data-pid',id);
        }
        sel.appendChild(o);
      });
      populateProductNames(sel);
      if(!ids.length){document.getElementById('kpi').innerHTML=''; setProdLink('', ''); return;}
      const pid=ids[0]; sel.value=pid; update(pid);
      sel.onchange=()=>update(sel.value);
      function sum(rows,pid){
        return rows.filter(r=>String(getId(r))===String(pid)).reduce((a,r)=>({
          exp:a.exp+getExp(r),
          uv:a.uv+Number(mode==='indep'?r.clicks||0:r.visitors||0),
          add:a.add+Number(mode==='indep'?0:r.add_people||0),
          pay:a.pay+Number(mode==='indep'?r.conversions||0:r.pay_buyers||0)
        }),{exp:0,uv:0,add:0,pay:0});
      }
      function line(pid){
        const mapExpA=new Map(), mapExpB=new Map();
        const mapUvRateA=new Map(), mapUvRateB=new Map();
        const mapAddRateA=new Map(), mapAddRateB=new Map();
        rowsA.filter(r=>String(getId(r))===String(pid)).forEach(r=>{
          const d=mode==='indep'?r.day:r.bucket;
          const exp=getExp(r);
          const uv=Number(mode==='indep'?r.clicks||0:r.visitors||0);
          const add=Number(mode==='indep'?0:r.add_people||0);
          mapExpA.set(d,exp);
          mapUvRateA.set(d,exp?uv/exp:0);
          mapAddRateA.set(d,uv?add/uv:0);
        });
        rowsB.filter(r=>String(getId(r))===String(pid)).forEach(r=>{
          const d=mode==='indep'?r.day:r.bucket;
          const exp=getExp(r);
          const uv=Number(mode==='indep'?r.clicks||0:r.visitors||0);
          const add=Number(mode==='indep'?0:r.add_people||0);
          mapExpB.set(d,exp);
          mapUvRateB.set(d,exp?uv/exp:0);
          mapAddRateB.set(d,uv?add/uv:0);
        });
        const labels=[], expA=[], expB=[], uvA=[], uvB=[], addA=[], addB=[];
        for(let i=0;i<days;i++){
          const da=new Date(startA+'T00:00:00'); da.setDate(da.getDate()+i); const isoA=da.toISOString().slice(0,10);
          const db=new Date(startB+'T00:00:00'); db.setDate(db.getDate()+i); const isoB=db.toISOString().slice(0,10);
          labels.push(isoA);
          expA.push(mapExpA.get(isoA)||0);
          expB.push(mapExpB.get(isoB)||0);
          uvA.push((mapUvRateA.get(isoA)||0)*100);
          uvB.push((mapUvRateB.get(isoB)||0)*100);
          addA.push((mapAddRateA.get(isoA)||0)*100);
          addB.push((mapAddRateB.get(isoB)||0)*100);
        }
        const expChart=echarts.init(document.getElementById('expLine'));
        expChart.setOption({tooltip:{trigger:'axis'},legend:{data:['本周期','上一周期']},xAxis:{type:'category',data:labels},yAxis:{type:'value'},series:[{name:'本周期',type:'line',smooth:true,data:expA},{name:'上一周期',type:'line',smooth:true,data:expB}]});
        const uvChart=echarts.init(document.getElementById('uvRateLine'));
        uvChart.setOption({tooltip:{trigger:'axis',valueFormatter:v=>v+'%'},legend:{data:['本周期','上一周期']},xAxis:{type:'category',data:labels},yAxis:{type:'value',axisLabel:{formatter:'{value}%'}},series:[{name:'本周期',type:'line',smooth:true,data:uvA},{name:'上一周期',type:'line',smooth:true,data:uvB}]});
        const addChart=echarts.init(document.getElementById('addRateLine'));
        addChart.setOption({tooltip:{trigger:'axis',valueFormatter:v=>v+'%'},legend:{data:['本周期','上一周期']},xAxis:{type:'category',data:labels},yAxis:{type:'value',axisLabel:{formatter:'{value}%'}},series:[{name:'本周期',type:'line',smooth:true,data:addA},{name:'上一周期',type:'line',smooth:true,data:addB}]});
        window.addEventListener('resize',()=>{expChart.resize();uvChart.resize();addChart.resize();});
      }
      function update(pid){
        const cur=sum(rowsA,pid); const prev=sum(rowsB,pid);
        const curUvRate=cur.exp?cur.uv/cur.exp:0;
        const prevUvRate=prev.exp?prev.uv/prev.exp:0;
        const curAddRate=cur.uv?cur.add/cur.uv:0;
        const prevAddRate=prev.uv?prev.add/prev.uv:0;
        const curPayRate=cur.uv?cur.pay/cur.uv:0;
        const prevPayRate=prev.uv?prev.pay/prev.uv:0;
        const avgUvRate=totalsA.exp?totalsA.uv/totalsA.exp:0;
        const avgAddRate=totalsA.uv?totalsA.add/totalsA.uv:0;
        const avgPayRate=totalsA.uv?totalsA.pay/totalsA.uv:0;
        const shareExp=totalsA.exp?cur.exp/totalsA.exp:0;
        const shareUv=totalsA.uv?cur.uv/totalsA.uv:0;
        const shareAdd=totalsA.add?cur.add/totalsA.add:0;
        const sharePay=totalsA.pay?cur.pay/totalsA.pay:0;
        document.getElementById('kpi').innerHTML=[
          card('平均访客比',curUvRate,prevUvRate,true,avgUvRate),
          card('平均加购比',curAddRate,prevAddRate,true,avgAddRate),
          card('平均支付比',curPayRate,prevPayRate,true,avgPayRate),
          card('总曝光量',cur.exp,prev.exp,false,null,shareExp),
          card('总访客数',cur.uv,prev.uv,false,null,shareUv),
          card('总加购人数',cur.add,prev.add,false,null,shareAdd),
          card('总支付买家数',cur.pay,prev.pay,false,null,sharePay)
        ].join('');
        line(pid);
        const dates=[...rowsA,...rowsB].filter(r=>String(getId(r))===String(pid)).map(r=>mode==='indep'?r.day:r.bucket).sort();
        document.getElementById('listingDate').textContent=dates.length?`上架日期：${dates[0]}`:'';
        const url = mode==='indep' ? linkMap.get(pid) : `https://aliexpress.com/item/${pid}.html`;
        const api = mode==='indep' ? '/api/indep_fetchProductInfo' : undefined;
        getProductMeta(pid,url,api).then(m=>{
          const linkText = mode==='indep' ? (m.title||url) : (m.title||pid);
          setProdLink(linkText||'',url);
          const img=document.getElementById('productImg');
          img.src=m.image||'';
          img.style.display=m.image?'':'none';
        });
      }
    }
    loadData();
  }
});
</script>
</body>
</html>
