<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg" sizes="64x64">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>产品分析</title>
  <link rel="stylesheet" href="assets/theme.css?v=20250812-deep">
  <link rel="stylesheet" href="assets/global-theme.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="assets/product-meta.js"></script>
  <script src="assets/loading.js"></script>
  <script>const t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);</script>
  <style>
    /* KPI卡片对比数据样式 */
    .kpi-comparison {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      text-align: center;
    }
    
    .kpi-comparison .delta {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-weight: 600;
    }
    
    .kpi-comparison .delta.up {
      color: #059669;
      background: rgba(34, 197, 94, 0.1);
    }
    
    .kpi-comparison .delta.down {
      color: #dc2626;
      background: rgba(239, 68, 68, 0.1);
    }
    
    .kpi-comparison .up {
      color: #059669;
    }
    
    .kpi-comparison .down {
      color: #dc2626;
    }
  </style>
</head>
<body>
<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> 跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali"><a href="#">速卖通</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon"><a href="amazon-overview.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="#">独立站</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header">
      <div class="site-title">
        <svg class="site-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 0 20M12 2a15.3 15.3 0 0 0 0 20"/></svg>
        <span id="currentSite"></span>
      </div>
      <button id="addSite" class="add-site-btn">+</button>
    </div>
    <ul class="sub-nav">
      <li><a id="detailLink" href="managed.html"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="9" x2="9" y2="21"/><line x1="15" y1="9" x2="15" y2="21"/></svg>详细数据</a></li>
      <li><a id="analysisLink" href="operation-analysis.html"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 8-8"/><path d="M14 3h7v7"/></svg>运营分析</a></li>
      <li><a class="active" href="#"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 3a9 9 0 1 0 9 9h-9z"/><path d="M15 3v8h8"/></svg>产品分析</a></li>
    </ul>
  </nav>
  <main class="main">
    <div class="content">
      <section class="content-pad">
        <div id="ctrl" class="controls" style="margin-bottom:12px;"></div>
        <div class="controls" style="margin-bottom:12px;flex-wrap:wrap;"><label>产品</label><select id="productSelect" class="sel" style="width:200px;flex:0 0 200px;"></select><img id="productImg" style="width:40px;height:40px;object-fit:cover;margin-left:8px;display:none;"/><a id="productLink" href="#" target="_blank" style="margin-left:8px;display:none;word-break:break-all;white-space:normal;flex:1 1 auto;"></a><span id="listingDate" style="margin-left:8px;"></span></div>
        <div id="kpi" class="kpi-grid"></div>
        <div id="lineWrap" class="panel" style="margin-top:16px;display:none;">
          <h3 id="expTitle">曝光趋势</h3>
          <div id="expLine" style="width:100%;height:260px;"></div>
          <h3 id="uvTitle" style="margin-top:24px;">访客比趋势</h3>
          <div id="uvRateLine" style="width:100%;height:260px;"></div>
          <h3 id="addTitle" style="margin-top:24px;">加购比趋势</h3>
          <div id="addRateLine" style="width:100%;height:260px;"></div>
        </div>
      </section>
    </div>
  </main>
</div>
<script src="assets/site-nav.js"></script>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const params=new URLSearchParams(location.search);
  const mode=params.get('mode');
  const pidParam=params.get('pid');
  const detailLink=document.getElementById('detailLink');
  const analysisLink=document.getElementById('analysisLink');
  const prodLink=document.getElementById('productLink');
  const expTitle=document.getElementById('expTitle');
  const uvTitle=document.getElementById('uvTitle');
  const addTitle=document.getElementById('addTitle');
  const platformNav=document.querySelector('.platform-nav');
  platformNav.querySelectorAll('li').forEach(li=>li.classList.remove('active'));
  const platformMap={
    indep:'li.independent',
    ozon:'li.ozon',
    amazon:'li.amazon',
    tiktok:'li.tiktok',
    temu:'li.temu'
  };
  const selector=platformMap[mode];
  if(selector){
    platformNav.querySelector(selector)?.classList.add('active');
  }else{
    const aliLi=platformNav.querySelector('li.ali');
    aliLi?.classList.add('active');
    aliLi?.querySelectorAll('.dropdown li').forEach(li=>li.classList.remove('active'));
    if(mode==='self'){
      aliLi?.querySelector('a[href="index.html"]')?.parentElement.classList.add('active');
    }else{
      aliLi?.querySelector('a[href="managed.html"]')?.parentElement.classList.add('active');
    }
  }
  if(mode==='indep'){
    uvTitle.textContent='CTR趋势';
    addTitle.textContent='转化率趋势';
  }
  function setProdLink(text,url){
    if(text && url){
      prodLink.textContent=text;
      prodLink.href=url;
      prodLink.title=url;
      prodLink.style.display='';
    }else{
      prodLink.style.display='none';
    }
  }
  if(mode==='self'){
    if(detailLink)detailLink.href='self-operated.html';
    if(analysisLink)analysisLink.href='operation-analysis.html?mode=self';
  }else if(mode==='indep'){
    if(detailLink)detailLink.href='independent-site.html';
    if(analysisLink)analysisLink.href='independent-site.html#analysis';
  }else if(mode==='ozon'){
    if(detailLink)detailLink.href='ozon-detail.html';
    if(analysisLink)analysisLink.href='ozon-analysis.html';
  }else{
    if(detailLink)detailLink.href='managed.html';
    if(analysisLink)analysisLink.href='operation-analysis.html';
  }

    const currentSiteEl=document.getElementById('currentSite');
  const addBtn=document.getElementById('addSite');
  const siteListKey='managedSites';
  const currentSiteKey='currentSite';
  let sites=JSON.parse(localStorage.getItem(siteListKey)||'null');
  if(!Array.isArray(sites)||!sites.length){sites=mode==='self'?['A站','B站','C站']:['主站'];}
  function save(){localStorage.setItem(siteListKey,JSON.stringify(sites));renderSiteMenus();}
  function updateCurrent(){
    const currentSiteId = localStorage.getItem('currentSite');
    const currentSiteName = localStorage.getItem('currentSiteName');
    
    // 如果有currentSiteName，直接使用它
    if (currentSiteName) {
      currentSiteEl.textContent = currentSiteName;
    } else if (currentSiteId) {
      // 如果有currentSiteId但没有名称，根据ID判断
      if (currentSiteId.startsWith('ae_self_operated')) {
        currentSiteEl.textContent = '自运营';
      } else {
        currentSiteEl.textContent = '全托管';
      }
    } else {
      // 如果都没有，使用默认逻辑
      const name = localStorage.getItem(currentSiteKey) || sites[0];
      if (mode === 'self') {
        currentSiteEl.textContent = '自运营 ' + name;
      } else {
        currentSiteEl.textContent = sites.length > 1 ? '全托管 ' + name : '全托管';
      }
    }
    
    // 保存当前站点名称到localStorage
    if (currentSiteName) {
      localStorage.setItem(currentSiteKey, currentSiteName);
    }
  }
  currentSiteEl.addEventListener('dblclick',()=>{
    const cur=localStorage.getItem(currentSiteKey)||sites[0];
    const idx=sites.indexOf(cur);
    const n=prompt('修改站点名',cur);
    if(n){sites[idx]=n;save();localStorage.setItem(currentSiteKey,n);updateCurrent();}
  });
  addBtn.addEventListener('click',()=>{
    const n=prompt('新增站点名');
    if(n){sites.push(n);save();updateCurrent();}
  });
  renderSiteMenus();
  updateCurrent();
  
  // 检测当前页面类型：如果有mode=self参数或者从自运营页面访问，使用自运营模式
  const isFromSelfOperated = document.referrer.includes('self-operated.html') || 
                            document.referrer.includes('index.html') ||
                            localStorage.getItem('currentSite')?.startsWith('ae_self_operated');
  
  // 获取当前站点ID和名称
  const currentSiteId = localStorage.getItem('currentSite');
  const currentSiteName = localStorage.getItem('currentSiteName');
  
  console.log('产品分析页面模式检测:', { 
    mode, 
    isFromSelfOperated, 
    referrer: document.referrer,
    currentSiteId,
    currentSiteName
  });
  
  // 根据当前站点ID判断使用哪种模式
  if(mode==='self' || isFromSelfOperated || (currentSiteId && currentSiteId.startsWith('ae_self_operated'))){
    console.log('使用自运营模式，站点:', currentSiteId);
    setupSelf('self');
  }else{
    console.log('使用全托管模式，站点:', currentSiteId); 
    setupFM();
  }
function card(title,cur,prev,isPct,avg,share,cardType='info'){
    const diff=(cur-prev)||0;
    const arrow=diff>=0?'↑':'↓';
    const cls=diff>=0?'delta up':'delta down';
    const fmt=v=>isPct?`${(v*100).toFixed(2)}%`:v;
    const delta=isPct?`${Math.abs(diff*100).toFixed(2)}%`:Math.abs(diff);
    
    let comparisonHtml = '';
    if(avg!=null){
      const diffAvg=(cur-avg)||0;
      const dir=diffAvg>=0?'高于平均':'低于平均';
      const clsAvg=diffAvg>=0?'up':'down';
      const deltaAvg=isPct?`${Math.abs(diffAvg*100).toFixed(2)}%`:Math.abs(diffAvg);
      comparisonHtml += `<span class="${clsAvg}" style="margin-left:8px;">${dir} ${deltaAvg}</span>`;
    }
    if(share!=null){
      comparisonHtml += `<span style="margin-left:8px;">占比 ${(share*100).toFixed(2)}%</span>`;
    }
    
    return `<div class="kpi-card ${cardType}">
      <h4>${title}</h4>
      <p>${fmt(cur)}</p>
      <div class="kpi-comparison">
        <span class="${cls}">${arrow} ${delta}</span>
        ${comparisonHtml}
      </div>
    </div>`;
  }

  function setupFM(){
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<div class="date-controls"><span>时间粒度：</span><button class="granularity-btn active" data-granularity="week">按周</button><button class="granularity-btn" data-granularity="month">按月</button><span style="margin-left: 20px;">周期：</span><select id="periodSelect" class="sel" style="margin-left: 8px;"></select></div>';
    
    // 添加粒度按钮事件
    document.querySelectorAll('.granularity-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.granularity-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        const granularity = e.target.dataset.granularity;
        localStorage.setItem('fmGranularity', granularity);
        loadPeriods();
      });
    });
    
    const state={ granularity: localStorage.getItem('fmGranularity')||'week', periods: [] };
    // 设置默认选中的粒度按钮
    const activeBtn = document.querySelector(`[data-granularity="${state.granularity}"]`);
    if (activeBtn) {
      document.querySelectorAll('.granularity-btn').forEach(b => b.classList.remove('active'));
      activeBtn.classList.add('active');
    }
    
    document.getElementById('periodSelect').addEventListener('change',loadData);
    function loadPeriods(){
      // 从当前激活的按钮获取粒度
      const activeBtn = document.querySelector('.granularity-btn.active');
      const granularity = activeBtn ? activeBtn.dataset.granularity : 'week';
      state.granularity = granularity;
      fetch('/api/periods').then(r=>r.json()).then(j=>{
        const list=(state.granularity==='week'?j.weeks:j.months)||[];
        state.periods=list.slice();
        const sel=document.getElementById('periodSelect');
        sel.innerHTML='';
        if(!list.length){sel.innerHTML='<option value="">暂无数据</option>';return;}
        list.forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o);});
        const stored=localStorage.getItem('fmPeriod');
        if(stored && list.includes(stored)) sel.value=stored; else {sel.value=list[0]; localStorage.setItem('fmPeriod',list[0]);}
        loadData();
      });
    }
    async function loadData(){
      showLoading();
      const period=document.getElementById('periodSelect').value;
      localStorage.setItem('fmPeriod',period||'');
      const idx=state.periods.indexOf(period); const prev=(idx>=0 && idx<state.periods.length-1)?state.periods[idx+1]:'';
      const qsA=new URLSearchParams({granularity:state.granularity,limit:5000}); if(period)qsA.set('period_end',period);
      const qsB=new URLSearchParams({granularity:state.granularity,limit:5000}); if(prev)qsB.set('period_end',prev);
      try{
        const [ja,jb]=await Promise.all([
          fetch('/api/stats?'+qsA.toString()).then(r=>r.json()),
          prev?fetch('/api/stats?'+qsB.toString()).then(r=>r.json()):Promise.resolve({rows:[]})
        ]);
        const rowsA=ja.rows||[]; const rowsB=jb.rows||[];
        renderProductFM(rowsA,rowsB);
      }catch(err){
        console.error(err);
        alert('查询失败：'+(err.message||err));
      }finally{
        hideLoading();
      }
    }
    function renderProductFM(rowsA,rowsB){
      const expMap=new Map();
      rowsA.forEach(r=>expMap.set(r.product_id,(expMap.get(r.product_id)||0)+Number(r.search_exposure||0)));
      const totalsA=rowsA.reduce((a,x)=>({
        exp:a.exp+Number(x.search_exposure||0),
        uv:a.uv+Number(x.uv||0),
        add:a.add+Number(x.add_to_cart_users||0),
        pay:a.pay+Number(x.pay_buyers||0)
      }),{exp:0,uv:0,add:0,pay:0});
      const ids=Array.from(expMap.keys()).sort((a,b)=>expMap.get(b)-expMap.get(a));
      const sel=document.getElementById('productSelect');
      sel.innerHTML='';
      ids.forEach(id=>{const o=document.createElement('option');o.value=id;o.textContent=id;o.setAttribute('data-pid',id);sel.appendChild(o);});
      populateProductNames(sel);
      if(!ids.length){document.getElementById('kpi').innerHTML=''; setProdLink('',''); return;}
      const pid=ids.find(id=>String(id)===String(pidParam))||ids[0];
      sel.value=pid; update(pid);
      sel.onchange=()=>update(sel.value);
      function sum(rows,pid){
        return rows.filter(x=>String(x.product_id)===String(pid)).reduce((a,x)=>({
          exp:a.exp+Number(x.search_exposure||0),
          uv:a.uv+Number(x.uv||0),
          add:a.add+Number(x.add_to_cart_users||0),
          pay:a.pay+Number(x.pay_buyers||0)
        }),{exp:0,uv:0,add:0,pay:0});
      }
      function update(pid){
        const cur=sum(rowsA,pid); const prev=sum(rowsB,pid);
        const curUvRate=cur.exp?cur.uv/cur.exp:0;
        const prevUvRate=prev.exp?prev.uv/prev.exp:0;
        const curAddRate=cur.uv?cur.add/cur.uv:0;
        const prevAddRate=prev.uv?prev.add/prev.uv:0;
        const curPayRate=cur.uv?cur.pay/cur.uv:0;
        const prevPayRate=prev.uv?prev.pay/prev.uv:0;
        const avgUvRate=totalsA.exp?totalsA.uv/totalsA.exp:0;
        const avgAddRate=totalsA.uv?totalsA.add/totalsA.uv:0;
        const avgPayRate=totalsA.uv?totalsA.pay/totalsA.uv:0;
        const shareExp=totalsA.exp?cur.exp/totalsA.exp:0;
        const shareUv=totalsA.uv?cur.uv/totalsA.uv:0;
        const shareAdd=totalsA.add?cur.add/totalsA.add:0;
        const sharePay=totalsA.pay?cur.pay/totalsA.pay:0;
        document.getElementById('kpi').innerHTML=[
          card('平均访客比',curUvRate,prevUvRate,true,avgUvRate),
          card('平均加购比',curAddRate,prevAddRate,true,avgAddRate),
          card('平均支付比',curPayRate,prevPayRate,true,avgPayRate),
          card('总曝光量',cur.exp,prev.exp,false,null,shareExp),
          card('总访客数',cur.uv,prev.uv,false,null,shareUv),
          card('总加购人数',cur.add,prev.add,false,null,shareAdd),
          card('总支付买家数',cur.pay,prev.pay,false,null,sharePay),
          card('曝光商品数',cur.exp > 0 ? 1 : 0, prev.exp > 0 ? 1 : 0, false),
          card('加购商品数',cur.add > 0 ? 1 : 0, prev.add > 0 ? 1 : 0, false),
          card('支付商品数',cur.pay > 0 ? 1 : 0, prev.pay > 0 ? 1 : 0, false)
        ].join('');
        const dates=[...rowsA,...rowsB].filter(x=>String(x.product_id)===String(pid)).map(x=>x.period_start||x.period_end||'').filter(Boolean).sort();
        document.getElementById('listingDate').textContent=dates.length?`上架日期：${dates[0]}`:'';
        const url=`https://aliexpress.com/item/${pid}.html`;
        getProductMeta(pid,url).then(m=>{
          setProdLink(m.title||pid,url);
          const img=document.getElementById('productImg');
          img.src=m.image||'';
          img.style.display=m.image?'':'none';
        });
      }
    }
    loadPeriods();
  }

  function setupSelf(mode, siteParam){
    document.getElementById('lineWrap').style.display='block';
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<input id="dateRange" class="date-filter" placeholder="选择日期范围">';
    const input=document.getElementById('dateRange');
    const currentSiteId = localStorage.getItem('currentSite') || 'ae_self_operated_a';
    const key=mode==='indep'?`indepPeriod_${siteParam}`:`selfPeriod_${currentSiteId}`;
    const fp=flatpickr(input,{mode:'range',dateFormat:'Y-m-d',onClose:ds=>{if(ds.length===2)loadData();}});
    const stored=localStorage.getItem(key);
    if(stored && stored.includes(' to ')) input.value=stored; else {
      const today=new Date(); const end=today.toISOString().slice(0,10); 
// 如果今天是2024年或更早，使用2025-07-01作为开始日期
const start = today.getFullYear() < 2025 ? '2025-07-01' : new Date(today.getTime()-30*86400000).toISOString().slice(0,10); 
const def=`${start} to ${end}`; input.value=def; localStorage.setItem(key,def);
    }
    async function loadData(){
      const val=input.value; if(!val.includes(' to '))return; const [startISO,endISO]=val.split(' to '); localStorage.setItem(key,`${startISO} to ${endISO}`);
      const {prevStart,prevEnd,days}=periodShift(startISO,endISO);
      showLoading();
      try{
        if(mode==='indep'){
          const [rowsA,rowsB]=await Promise.all([
            fetchAgg(startISO,endISO),
            fetchAgg(prevStart,prevEnd)
          ]);
          renderProductSelf(rowsA,rowsB,rowsA,rowsB,days,startISO,prevStart,[]);
          return;
        }
        const allProducts = await fetchAllProducts();
        const [rowsAggA,rowsAggB,rowsDayA,rowsDayB]=await Promise.all([
          fetchAgg(startISO,endISO,'day'),
          fetchAgg(prevStart,prevEnd,'day'),
          fetchAgg(startISO,endISO,'day'),
          fetchAgg(prevStart,prevEnd,'day')
        ]);
        renderProductSelf(rowsAggA,rowsAggB,rowsDayA,rowsDayB,days,startISO,prevStart,allProducts);
      }catch(err){
        console.error(err);
        alert('查询失败：'+(err.message||err));
      }finally{
        hideLoading();
      }
    }
    async function fetchAgg(start,end,gran){
      if(mode==='indep'){
        const url=`/api/independent/stats?site=${encodeURIComponent(siteParam)}&from=${start}&to=${end}`;
        const resp=await fetch(url);
        const txt=await resp.text(); let j; try{ j=JSON.parse(txt);} catch(e){ throw new Error('Query API响应不是JSON：'+txt.slice(0,200)); }
        if(!resp.ok || (j.ok!==undefined && !j.ok)) throw new Error(j.error||'查询失败');
        return j.table||j.rows||[];
      }
      let currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
      
      // 确保使用正确的站点ID格式
      if (currentSite === 'A站' || currentSite === '自运营robot站') {
        currentSite = 'ae_self_operated_a';
        localStorage.setItem('currentSite', currentSite);
      }
      
      // 如果当前站点是Poolslab，使用正确的站点ID
      if (currentSite === 'Poolslab运动娱乐' || currentSite === 'poolslab') {
        currentSite = 'ae_self_operated_poolslab';
      }
      
      console.log('产品分析fetchAgg调用参数:', { start, end, gran, currentSite });
      
      const url=`/api/ae_query?start=${start}&end=${end}&granularity=${gran}&site=${encodeURIComponent(currentSite)}`;
      console.log('产品分析fetchAgg请求URL:', url);
      
      const resp=await fetch(url);
      const txt=await resp.text(); let j; try{ j=JSON.parse(txt);} catch(e){ throw new Error('Query API响应不是JSON：'+txt.slice(0,200)); }
      if(!resp.ok || (j.ok!==undefined && !j.ok)) throw new Error(j.error||'查询失败');
      
      console.log('产品分析fetchAgg响应:', { rows: j.rows?.length || 0, site: currentSite });
      return j.rows||[];
    }
    async function fetchAllProducts(){
      try{
        const today=new Date().toISOString().slice(0,10);
        const qs=new URLSearchParams({platform:'self',from:'2000-01-01',to:today,limit:'5000'});
        let currentSite=localStorage.getItem('currentSite')||'ae_self_operated_a';
        if(currentSite==='A站'||currentSite==='自运营robot站')currentSite='ae_self_operated_a';
        if(currentSite==='Poolslab运动娱乐'||currentSite==='poolslab')currentSite='ae_self_operated_poolslab';
        qs.set('site',currentSite);
        const r=await fetch('/api/new-products?'+qs.toString());
        const j=await r.json();
        const set=new Set((j.items||[]).map(it=>it.product_id).filter(Boolean));
        try{
          const rows=await fetchAgg('2000-01-01',today,'day');
          rows.forEach(r=>{if(r.product_id) set.add(r.product_id);});
        }catch(err){
          console.error('fetchAllProducts补充stats失败:',err);
        }
        console.log('fetchAllProducts合并后的产品总数:',set.size);
        return Array.from(set);
      }catch(e){
        console.error('fetchAllProducts错误:',e);
        return [];
      }
    }
    function periodShift(startISO,endISO){
      const start=new Date(startISO+'T00:00:00'); const end=new Date(endISO+'T00:00:00');
      const days=Math.round((end-start)/86400000)+1;
      const prevEnd=new Date(start.getTime()-86400000);
      const prevStart=new Date(prevEnd.getTime()-(days-1)*86400000);
      const fmt=d=>d.toISOString().slice(0,10);
      return{prevStart:fmt(prevStart),prevEnd:fmt(prevEnd),days};
    }
    function renderProductSelf(rowsAggA,rowsAggB,rowsDayA,rowsDayB,days,startA,startB,allIds){
      const expMap=new Map();
      const linkMap=new Map();
      const getId=r=>mode==='indep'?(r.landing_path||r.product):r.product_id;
      const getExp=r=>mode==='indep'?Number(r.impr||r.exposure||0):Number(r.exposure||0);
      const base = (mode==='indep' && siteParam) ? siteParam.replace(/\/$/,'') : '';
      rowsAggA.forEach(r=>{
        const id=getId(r);
        expMap.set(id,(expMap.get(id)||0)+getExp(r));
        if(mode==='indep'){
          let link='';
          if(r.landing_url && r.landing_url.startsWith('http')){
            link=r.landing_url;
          }else{
            const path=r.landing_path || r.landing_url || '';
            link=base+path;
          }
          if(link) linkMap.set(id,link);
        }
      });
      const totalsA=rowsAggA.reduce((a,r)=>({
        exp:a.exp+getExp(r),
        uv:a.uv+Number(mode==='indep'?r.clicks||0:r.visitors||0),
        add:a.add+Number(mode==='indep'?r.conversions||0:r.add_people||0),
        pay:a.pay+Number(mode==='indep'?r.conversions||0:r.pay_buyers||0)
      }),{exp:0,uv:0,add:0,pay:0});
      const expIds=Array.from(expMap.keys()).sort((a,b)=>expMap.get(b)-expMap.get(a));
      const ids=[...new Set([...expIds,...(allIds||[])])];
      const sel=document.getElementById('productSelect'); sel.innerHTML='';
      ids.forEach(id=>{
        const o=document.createElement('option');
        o.value=id; o.textContent=id;
        if(mode==='indep'){
          const link=linkMap.get(id);
          if(link){ o.dataset.url=link; o.dataset.api='/api/indep_fetchProductInfo'; }
        }else{
          o.setAttribute('data-pid',id);
        }
        sel.appendChild(o);
      });
      populateProductNames(sel);
      if(!ids.length){document.getElementById('kpi').innerHTML=''; setProdLink('', ''); return;}
      const pid=ids.find(id=>String(id)===String(pidParam))||ids[0];
      sel.value=pid; update(pid);
      sel.onchange=()=>update(sel.value);
      function sum(rows,pid){
        return rows.filter(r=>String(getId(r))===String(pid)).reduce((a,r)=>({
          exp:a.exp+getExp(r),
          uv:a.uv+Number(mode==='indep'?r.clicks||0:r.visitors||0),
          add:a.add+Number(mode==='indep'?r.conversions||0:r.add_people||0),
          pay:a.pay+Number(mode==='indep'?r.conversions||0:r.pay_buyers||0)
        }),{exp:0,uv:0,add:0,pay:0});
      }
      function line(pid){
        const mapA=new Map(), mapB=new Map();
        rowsDayA.filter(r=>String(getId(r))===String(pid)).forEach(r=>{
          const d=mode==='indep'?r.day:r.bucket;
          const exp=getExp(r);
          const uv=Number(mode==='indep'?r.clicks||0:r.visitors||0);
          const conv=Number(mode==='indep'?r.conversions||0:r.add_people||0);
          const m=mapA.get(d)||{exp:0,uv:0,conv:0};
          m.exp+=exp; m.uv+=uv; m.conv+=conv;
          mapA.set(d,m);
        });
        rowsDayB.filter(r=>String(getId(r))===String(pid)).forEach(r=>{
          const d=mode==='indep'?r.day:r.bucket;
          const exp=getExp(r);
          const uv=Number(mode==='indep'?r.clicks||0:r.visitors||0);
          const conv=Number(mode==='indep'?r.conversions||0:r.add_people||0);
          const m=mapB.get(d)||{exp:0,uv:0,conv:0};
          m.exp+=exp; m.uv+=uv; m.conv+=conv;
          mapB.set(d,m);
        });
        const labels=[], expA=[], expB=[], uvA=[], uvB=[], convA=[], convB=[];
        for(let i=0;i<days;i++){
          const da=new Date(startA+'T00:00:00'); da.setDate(da.getDate()+i); const isoA=da.toISOString().slice(0,10);
          const db=new Date(startB+'T00:00:00'); db.setDate(db.getDate()+i); const isoB=db.toISOString().slice(0,10);
          labels.push(isoA);
          const a=mapA.get(isoA)||{exp:0,uv:0,conv:0};
          const b=mapB.get(isoB)||{exp:0,uv:0,conv:0};
          expA.push(a.exp);
          expB.push(b.exp);
          uvA.push(a.exp? (a.uv/a.exp*100):0);
          uvB.push(b.exp? (b.uv/b.exp*100):0);
          convA.push(a.uv? (a.conv/a.uv*100):0);
          convB.push(b.uv? (b.conv/b.uv*100):0);
        }
        const expChart=echarts.init(document.getElementById('expLine'));
        expChart.setOption({tooltip:{trigger:'axis'},legend:{data:['本周期','上一周期']},xAxis:{type:'category',data:labels},yAxis:{type:'value'},series:[{name:'本周期',type:'line',smooth:true,data:expA},{name:'上一周期',type:'line',smooth:true,data:expB}]});
        const uvChart=echarts.init(document.getElementById('uvRateLine'));
        uvChart.setOption({tooltip:{trigger:'axis',valueFormatter:v=>v+'%'},legend:{data:['本周期','上一周期']},xAxis:{type:'category',data:labels},yAxis:{type:'value',axisLabel:{formatter:'{value}%'}},series:[{name:'本周期',type:'line',smooth:true,data:uvA},{name:'上一周期',type:'line',smooth:true,data:uvB}]});
        const convChart=echarts.init(document.getElementById('addRateLine'));
        convChart.setOption({tooltip:{trigger:'axis',valueFormatter:v=>v+'%'},legend:{data:['本周期','上一周期']},xAxis:{type:'category',data:labels},yAxis:{type:'value',axisLabel:{formatter:'{value}%'}},series:[{name:'本周期',type:'line',smooth:true,data:convA},{name:'上一周期',type:'line',smooth:true,data:convB}]});
        window.addEventListener('resize',()=>{expChart.resize();uvChart.resize();convChart.resize();});
      }
      function update(pid){
        const cur=sum(rowsAggA,pid); const prev=sum(rowsAggB,pid);
        const curUvRate=cur.exp?cur.uv/cur.exp:0;
        const prevUvRate=prev.exp?prev.uv/prev.exp:0;
        const curAddRate=cur.uv?cur.add/cur.uv:0;
        const prevAddRate=prev.uv?prev.add/prev.uv:0;
        const curPayRate=cur.uv?cur.pay/cur.uv:0;
        const prevPayRate=prev.uv?prev.pay/prev.uv:0;
        const avgUvRate=totalsA.exp?totalsA.uv/totalsA.exp:0;
        const avgAddRate=totalsA.uv?totalsA.add/totalsA.uv:0;
        const avgPayRate=totalsA.uv?totalsA.pay/totalsA.uv:0;
        const shareExp=totalsA.exp?cur.exp/totalsA.exp:0;
        const shareUv=totalsA.uv?cur.uv/totalsA.uv:0;
        const shareAdd=totalsA.add?cur.add/totalsA.add:0;
        const sharePay=totalsA.pay?cur.pay/totalsA.pay:0;
        const uvLabel=mode==='indep'?'平均CTR':'平均访客比';
        const addLabel=mode==='indep'?'平均转化率':'平均加购比';
        const uvTotalLabel=mode==='indep'?'总点击数':'总访客数';
        const addTotalLabel=mode==='indep'?'总转化数':'总加购人数';
        document.getElementById('kpi').innerHTML=[
          card(uvLabel,curUvRate,prevUvRate,true,avgUvRate,'info'),
          card(addLabel,curAddRate,prevAddRate,true,avgAddRate,'success'),
          card('平均支付比',curPayRate,prevPayRate,true,avgPayRate,'danger'),
          card('总曝光量',cur.exp,prev.exp,false,null,shareExp,'success'),
          card(uvTotalLabel,cur.uv,prev.uv,false,null,shareUv,'info'),
          card(addTotalLabel,cur.add,prev.add,false,null,shareAdd,'warning'),
          card('总支付买家数',cur.pay,prev.pay,false,null,sharePay,'danger'),
          card('曝光商品数',cur.exp > 0 ? 1 : 0, prev.exp > 0 ? 1 : 0, false,null,null,'success'),
          card('加购商品数',cur.add > 0 ? 1 : 0, prev.add > 0 ? 1 : 0, false,null,null,'warning'),
          card('支付商品数',cur.pay > 0 ? 1 : 0, prev.pay > 0 ? 1 : 0, false,null,null,'danger')
        ].join('');
        line(pid);
        const dates=[...rowsDayA,...rowsDayB].filter(r=>String(getId(r))===String(pid)).map(r=>mode==='indep'?r.day:r.bucket).sort();
        document.getElementById('listingDate').textContent=dates.length?`上架日期：${dates[0]}`:'';
        const url = mode==='indep' ? linkMap.get(pid) : `https://aliexpress.com/item/${pid}.html`;
        const api = mode==='indep' ? '/api/indep_fetchProductInfo' : undefined;
        getProductMeta(pid,url,api).then(m=>{
          const linkText = mode==='indep' ? (m.title||url) : (m.title||pid);
          setProdLink(linkText||'',url);
          const img=document.getElementById('productImg');
          img.src=m.image||'';
          img.style.display=m.image?'':'none';
        });
      }
    }
    loadData();
  }
});
</script>
</body>
</html>
