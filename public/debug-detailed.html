<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>详细调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>详细调试页面</h1>
    
    <div class="container">
        <h2>模拟 self-operated.html 的 fetchAndRenderAll 函数</h2>
        <button onclick="simulateFetchAndRenderAll()">模拟 fetchAndRenderAll</button>
        <button onclick="clearLog()">清除日志</button>
        <div id="log" class="log"></div>
    </div>

    <div class="container">
        <h2>测试 fetchAgg 函数调用</h2>
        <div class="test-section">
            <h3>测试 1: 基本调用</h3>
            <button onclick="testFetchAgg('2024-01-01', '2024-01-31', 'day')">测试 fetchAgg(start, end, 'day')</button>
        </div>
        <div class="test-section">
            <h3>测试 2: 变量调用</h3>
            <button onclick="testFetchAggWithVariables()">测试 fetchAgg(startISO, endISO, g)</button>
        </div>
        <div class="test-section">
            <h3>测试 3: 模拟页面初始化</h3>
            <button onclick="simulatePageInit()">模拟页面初始化</button>
        </div>
    </div>

    <div class="container">
        <h2>检查 localStorage</h2>
        <button onclick="checkLocalStorage()">检查 localStorage</button>
        <div id="localStorageInfo" class="log"></div>
    </div>

    <div class="container">
        <h2>检查 API 文件版本</h2>
        <button onclick="checkAPIVersion()">检查 API 版本</button>
        <div id="apiVersionInfo" class="log"></div>
    </div>

    <script>
        let logElement;

        function log(message, type = 'info') {
            if (!logElement) {
                logElement = document.getElementById('log');
            }
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            if (logElement) {
                logElement.innerHTML = '';
            }
        }

        // 模拟 fetchAgg 函数
        async function fetchAgg(startISO, endISO, granularity) {
            const currentSite = localStorage.getItem('currentSite') || 'A站';
            const url = `/api/ae_query?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}&granularity=${encodeURIComponent(granularity)}&site=${encodeURIComponent(currentSite)}`;
            
            log(`调用 fetchAgg: start=${startISO}, end=${endISO}, granularity=${granularity}, site=${currentSite}`, 'info');
            log(`请求 URL: ${url}`, 'info');
            
            try {
                const resp = await fetch(url);
                const txt = await resp.text();
                let j;
                try {
                    j = JSON.parse(txt);
                } catch(e) {
                    throw new Error('Query API响应不是JSON：' + txt.slice(0,200));
                }
                
                if (!resp.ok || !j.ok) {
                    log(`API 错误: ${j.error || '查询失败'}`, 'error');
                    throw new Error(j.error || '查询失败');
                }
                
                log(`API 成功: 返回 ${j.rows ? j.rows.length : 0} 条数据`, 'success');
                return j.rows || [];
            } catch (error) {
                log(`fetchAgg 错误: ${error.message}`, 'error');
                throw error;
            }
        }

        // 模拟 fetchAndRenderAll 函数
        async function simulateFetchAndRenderAll() {
            log('开始模拟 fetchAndRenderAll 函数', 'info');
            
            try {
                // 模拟日期设置
                const today = new Date();
                const endISO = today.toISOString().slice(0,10);
                const startISO = new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
                const g = 'day';
                
                log(`设置日期: startISO=${startISO}, endISO=${endISO}, g=${g}`, 'info');
                
                // 模拟第一个 fetchAgg 调用
                log('调用第一个 fetchAgg (rowsNowAgg)', 'info');
                const rowsNowAgg = await fetchAgg(startISO, endISO, g);
                log(`第一个调用成功: ${rowsNowAgg.length} 条数据`, 'success');
                
                // 模拟 periodShift
                const start = new Date(startISO + 'T00:00:00');
                const end = new Date(endISO + 'T00:00:00');
                const days = Math.round((end - start) / 86400000) + 1;
                const prevEnd = new Date(start.getTime() - 86400000);
                const prevStart = new Date(prevEnd.getTime() - (days-1)*86400000);
                const fmt = d => d.toISOString().slice(0,10);
                const prevStartStr = fmt(prevStart);
                const prevEndStr = fmt(prevEnd);
                
                log(`计算对比周期: prevStart=${prevStartStr}, prevEnd=${prevEndStr}, days=${days}`, 'info');
                
                // 模拟第二个 fetchAgg 调用
                log('调用第二个 fetchAgg (rowsA)', 'info');
                const rowsA = await fetchAgg(startISO, endISO, 'day');
                log(`第二个调用成功: ${rowsA.length} 条数据`, 'success');
                
                // 模拟第三个 fetchAgg 调用
                log('调用第三个 fetchAgg (rowsB)', 'info');
                const rowsB = await fetchAgg(prevStartStr, prevEndStr, 'day');
                log(`第三个调用成功: ${rowsB.length} 条数据`, 'success');
                
                log('所有 fetchAgg 调用完成', 'success');
                
            } catch (err) {
                log(`模拟过程中出错: ${err.message}`, 'error');
            }
        }

        // 测试 fetchAgg 函数调用
        async function testFetchAgg(start, end, granularity) {
            log(`测试 fetchAgg(${start}, ${end}, '${granularity}')`, 'info');
            try {
                const result = await fetchAgg(start, end, granularity);
                log(`测试成功: ${result.length} 条数据`, 'success');
            } catch (error) {
                log(`测试失败: ${error.message}`, 'error');
            }
        }

        // 测试带变量的 fetchAgg 调用
        async function testFetchAggWithVariables() {
            log('测试带变量的 fetchAgg 调用', 'info');
            const startISO = '2024-01-01';
            const endISO = '2024-01-31';
            const g = 'day';
            
            log(`变量值: startISO=${startISO}, endISO=${endISO}, g=${g}`, 'info');
            
            try {
                const result = await fetchAgg(startISO, endISO, g);
                log(`测试成功: ${result.length} 条数据`, 'success');
            } catch (error) {
                log(`测试失败: ${error.message}`, 'error');
            }
        }

        // 模拟页面初始化
        async function simulatePageInit() {
            log('模拟页面初始化', 'info');
            
            // 设置 localStorage
            localStorage.setItem('currentSite', 'A站');
            log('设置 localStorage.currentSite = "A站"', 'info');
            
            // 模拟默认日期设置
            const today = new Date();
            const end = today.toISOString().slice(0,10);
            const startDate = new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
            log(`设置默认日期: ${startDate} to ${end}`, 'info');
            
            // 调用 fetchAndRenderAll
            await simulateFetchAndRenderAll();
        }

        // 检查 localStorage
        function checkLocalStorage() {
            const info = document.getElementById('localStorageInfo');
            const currentSite = localStorage.getItem('currentSite');
            const allItems = {};
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allItems[key] = localStorage.getItem(key);
            }
            
            info.innerHTML = `currentSite: ${currentSite || 'undefined'}\n\n所有 localStorage 项目:\n${JSON.stringify(allItems, null, 2)}`;
        }

        // 检查 API 版本
        async function checkAPIVersion() {
            const info = document.getElementById('apiVersionInfo');
            info.innerHTML = '检查中...';
            
            try {
                // 尝试访问 API 文件
                const response = await fetch('/api/ae_query');
                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });
                
                info.innerHTML = `API 响应状态: ${response.status}\n\n响应头:\n${JSON.stringify(headers, null, 2)}`;
            } catch (error) {
                info.innerHTML = `检查失败: ${error.message}`;
            }
        }

        // 页面加载时自动检查
        window.addEventListener('load', function() {
            log('页面加载完成', 'info');
            checkLocalStorage();
        });
    </script>
</body>
</html>
