<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <title>自运营数据分析 · 对比增强版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- libs -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

  <!-- 主题样式（沿用你现有的） -->
  <link rel="stylesheet" href="assets/theme.css?v=20250810b">
  <style>
    /* NewKPICtrl */
    .kpi-ctrl{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .5rem;color:#334155;font:500 13px/1 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .kpi-ctrl button{border:1px solid #e5e7eb;background:#fff;border-radius:8px;padding:.25rem .5rem;cursor:pointer}
    .kpi-ctrl button:hover{background:#f8fafc}
    .kpi-ctrl input[type="date"]{border:1px solid #e5e7eb;border-radius:8px;padding:.25rem .5rem}
    .kpi-ctrl .hint{font-size:12px;color:#64748b}
    .stat-card .mini-link,.kpi .card .mini-link{font-size:12px;margin-left:8px;text-decoration:underline;cursor:pointer;display:none}
    .stat-card.clickable,.kpi .card.clickable{cursor:pointer}
    /* KPI basic helpers */
    .kpi-row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin:.25rem 0 .75rem}
    /* Force hide any old period controls if they still exist */
    #kpi-new-self-ctrl, #kpi-new-managed-ctrl, .kpi .kpi-ctrl { display: none !important; }
  </style>
</head>
<body>
<div class="container">
  <!-- 左侧导航 -->
  <nav class="sidebar" id="sidebar">
    <h3>产品导航</h3>
    <ul>
      <li class="has-submenu">
        <a href="#">速卖通</a>
        <ul class="submenu">
          <li><a href="managed.html">全托管</a></li>
          <li><a href="index.html" class="active">自运营</a></li>
        </ul>
      </li>
      <li><a href="#">TikTok Shop</a></li>
      <li><a href="#">亚马逊</a></li>
      <li class="has-submenu">
        <a href="#">独立站</a>
        <ul class="submenu">
          <li><a href="independent-site.html">数据分析</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <div class="main">
    <!-- 顶部：上传 + 全局过滤 -->
    <div class="upload-section">
      <div class="upload-top">
        <div class="controls">
          <label for="fileInput" class="upload-btn">选择文件</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
          <span class="notice">（上传→服务端入库→可视化与明细展示）</span>
          <span id="progress" class="progress"></span>
        </div>
        <div class="controls">
          <span>粒度：</span>
          <span class="sel" style="background:#1f2937;color:#fff;border-color:#334155;cursor:not-allowed">按日</span>
          <input type="hidden" id="granularity" value="day">
          <span>日期：</span>
          <input id="dateFilter" class="date-filter" placeholder="选择日期范围">
          <button id="refreshBtn" class="btn">刷新</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="kpi">
        <div class="card"><h4>平均访客比</h4><p id="avgVisitor">0%</p></div>
        <div class="card"><h4>平均加购比</h4><p id="avgCart">0%</p></div>
        <div class="card"><h4>平均支付比</h4><p id="avgPay">0%</p></div>
        <div class="card"><h4>商品总数</h4><p id="totalProducts">0</p></div>
        <div class="card"><h4>加购商品数</h4><p id="cartedProducts">0</p></div>
        <div class="card"><h4>支付商品数</h4><p id="purchasedProducts">0</p></div>
      </div>
    </div>

    <!-- 顶部 Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="summary">汇总对比</div>
      <div class="tab" data-tab="detail">明细表</div>
    </div>

    <div class="content">
      <!-- 汇总对比 -->
      <section id="summary" class="content-pad">
        <div class="panel">
          <h3>周期 A vs 周期 B · 总量曲线（按天）</h3>
          <div class="controls" style="margin-bottom:8px;">
            <span>维度：</span>
            <select id="metricSel" class="sel">
              <option value="exposure_sum">曝光量总和</option>
              <option value="visitors_sum">访客数总和</option>
              <option value="add_people_sum">加购人数总和</option>
              <option value="fav_sum">收藏总数</option>
              <option value="orders_sum">下单总数</option>
            </select>
            <span class="notice">A = 当前选择；B = 上一周期（向前平移同长度）。</span>
          </div>
          <div id="lineChart" style="width:100%;height:360px;"></div>
        </div>

        <div class="grid grid-2" style="margin-top:16px;">
          <div class="panel">
            <h3>平均比率对比（A vs B）</h3>
            <div id="ratioBar" style="width:100%;height:300px;"></div>
            <div class="notice">对比：平均加购比、平均访客比、平均支付比。</div>
          </div>
          <div class="panel">
            <h3>Top6 加购商品（A & B 同图）</h3>
            <div id="topBar" style="width:100%;height:320px;"></div>
            <div id="topBarLinks" class="legend-list" style="margin-top:6px;"></div>
          </div>
        </div>
      </section>

      <!-- 明细表 -->
      <section id="detail" class="content-pad" style="display:none;">
        <div class="panel">
          <h3>数据明细</h3>
          <div class="table-wrapper">
            <table id="report" class="display nowrap" style="width:100%"></table>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
/* ---------- UI 基础 ---------- */
(function() { $('.has-submenu > a').on('click', function(e){ e.preventDefault(); $(this).parent().toggleClass('open'); }); })();
$('.tab').on('click', function(){
  $('.tab').removeClass('active'); $(this).addClass('active');
  const id = $(this).data('tab'); $('#summary').toggle(id==='summary'); $('#detail').toggle(id==='detail');
});
const toNum = v => { if (v===null||v===undefined) return 0; if (typeof v==='number') return isFinite(v)?v:0; const n=parseFloat(String(v).replace(/,/g,'').trim()); return isNaN(n)?0:n; };

/* ---------- 高对比样式常量（给 ECharts 用） ---------- */
const AXIS_LABEL = { color: '#E5E7EB', fontWeight: 700, fontSize: 12 };
const GRID_LINE  = 'rgba(148,163,184,0.18)';

/* ---------- 上传 Excel → 入库 ---------- */
// NOTE: 这里已支持 4 个字段：
//  - 支付商品件数（→ pay_items，兼容“支付件数/付款件数/成交件数”）
//  - 下单商品件数（→ order_items）
//  - 平均停留时长（秒）（→ avg_stay_seconds）
//  - 搜索点击率（% 数值）（→ search_ctr）
$('#fileInput').on('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(evt) {
    try {
      $('#progress').text('解析中…');
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
      if (sheet.length < 2) throw new Error('表格无有效数据');
      const headers = sheet[0].map(h => String(h).trim());

      const findIdx = (re) => headers.findIndex(h => re.test(String(h).trim()));
      const idx = {
        product_id: findIdx(/^(商品)?ID$|^商品id$|^id$|^item id$|^item_id$/i),
        stat_date:  findIdx(/^(统计时间|日期|数据时间|date)$/i),
        exposure:   findIdx(/^(搜索曝光量|曝光量|商品曝光量|impressions)$/i),
        visitors:   (function(){ const rs=[/^(商品)?访客数$/i,/^访客人数$/i,/^访客量$/i,/^uv$/i,/^sessions$/i];
          for (const re of rs){const i = findIdx(re); if(i!==-1) return i;}
          const i2=headers.findIndex(h=>/访客数|访客/i.test(String(h).trim())&&!/(老|新|回|复)访客/i.test(String(h).trim()));
          return i2;
        })(),
        visitors_new: findIdx(/^(新访客数|新访客|新用户|新增访客)$/i),
        visitors_old: findIdx(/^(老访客数|老访客|回访客|复访客)$/i),
        views:      findIdx(/^(商品浏览量|浏览量|pv|page views)$/i),
        add_people: findIdx(/^(商品加购人数|加购人数|加购买家数)$/i),
        add_count:  findIdx(/^(商品加购件数|加购件数)$/i),
        // ✅ 支付商品件数：兼容“支付件数/付款件数/成交件数/支付商品件数”
        pay_items:  (function(){ const rs=[/^支付商品件数$/i,/^支付件数$/i,/^付款件数$/i,/^成交件数$/i]; for (const re of rs){const i=findIdx(re); if(i!==-1) return i;} return -1; })(),
        pay_orders: findIdx(/^(支付订单数|下单人数|订单数)$/i),
        pay_buyers: findIdx(/^(支付买家数|支付人数|成交人数)$/i),
        fav_people: findIdx(/^(收藏人数|收藏买家数|收藏用户数)$/i),
        fav_count:  findIdx(/^(收藏件数|收藏量)$/i),
        // ✅ 新增：下单商品件数 / 平均停留时长 / 搜索点击率
        order_items: findIdx(/^(下单商品件数|下单件数|下单商品数|下单商品数量)$/i),
        avg_stay_seconds: findIdx(/^(平均停留时长(\(秒\))?|平均停留时间|平均访问时长)$/i),
        search_ctr: findIdx(/^(搜索点击率(\(%\))?|点击率(\(%\))?|搜索点击率|点击率)$/i),
      };
      if (idx.product_id<0 || idx.stat_date<0) throw new Error('缺少必填：商品ID / 统计时间');

      function excelDateToISO(n){ if(typeof n!=='number') return null; const utc_days=Math.floor(n-25569); const utc_value=utc_days*86400; const date_info=new Date(utc_value*1000); const y=date_info.getUTCFullYear(); const m=(date_info.getUTCMonth()+1).toString().padStart(2,'0'); const d=date_info.getUTCDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; }
      function parseDateToISO(v){ if(v===null||v===undefined||v==='') return null; if(typeof v==='number') return excelDateToISO(v); let s=String(v).trim(); s=s.replace(/[.]/g,'-').replace(/\//g,'-'); const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`; const m2=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/); if(m2) return `${m2[3]}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`; return s.slice(0,10); }

      const rows = sheet.slice(1).filter(r => r && r.length).map(r => {
        const pid = String(r[idx.product_id]).trim();
        const sd  = parseDateToISO(r[idx.stat_date]);
        const visitors = (idx.visitors !== -1 ? toNum(r[idx.visitors])
                        : ((idx.visitors_new !== -1 ? toNum(r[idx.visitors_new]) : 0)
                        + (idx.visitors_old !== -1 ? toNum(r[idx.visitors_old]) : 0)));
        // 将“12.3%”型点击率转成 12.3
        const pct = (x) => { const n = String(x ?? '').trim(); if (!n) return 0; return toNum(n.replace('%','')); };
        const row = {
          product_id: pid, stat_date: sd,
          exposure:  idx.exposure  === -1 ? 0 : toNum(r[idx.exposure]),
          visitors,
          views:     idx.views     === -1 ? 0 : toNum(r[idx.views]),
          add_people:idx.add_people=== -1 ? 0 : toNum(r[idx.add_people]),
          add_count: idx.add_count === -1 ? 0 : toNum(r[idx.add_count]),
          pay_items: idx.pay_items === -1 ? 0 : toNum(r[idx.pay_items]),
          pay_orders:idx.pay_orders=== -1 ? 0 : toNum(r[idx.pay_orders]),
          pay_buyers:idx.pay_buyers=== -1 ? 0 : toNum(r[idx.pay_buyers]),
          // 新增字段
          order_items: idx.order_items === -1 ? 0 : toNum(r[idx.order_items]),
          avg_stay_seconds: idx.avg_stay_seconds === -1 ? 0 : toNum(r[idx.avg_stay_seconds]),
          search_ctr: idx.search_ctr === -1 ? 0 : pct(r[idx.search_ctr]),
        };
        if (idx.fav_people !== -1) row.fav_people = toNum(r[idx.fav_people]);
        if (idx.fav_count  !== -1) row.fav_count  = toNum(r[idx.fav_count]);
        return row;
      }).filter(x => x.product_id && x.stat_date);
      const dmap=new Map(); rows.forEach(r=>dmap.set(r.product_id+'__'+r.stat_date,r)); const deduped=Array.from(dmap.values());

      $('#progress').text(`入库中（${deduped.length} 条）…`);
      const resp = await fetch('/api/ae_upsert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rows: deduped }) });
      const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Upsert API响应不是JSON：' + txt.slice(0,200)); }
      if (!resp.ok || !j.ok) throw new Error(j.error || '入库失败');
      $('#progress').text('入库完成 ✔'); $('#refreshBtn').click();
    } catch(err) {
      console.error(err); alert('处理失败：' + (err.message || err)); $('#progress').text('');
    }
  };
  reader.readAsArrayBuffer(file);
});

/* ---------- 查询 / 汇总 ---------- */
async function fetchAgg(startISO, endISO, granularity) {
  const url = `/api/ae_query?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}&granularity=${encodeURIComponent(granularity)}`;
  const resp = await fetch(url);
  const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Query API响应不是JSON：' + txt.slice(0,200)); }
  if (!resp.ok || !j.ok) throw new Error(j.error || '查询失败');
  return j.rows || [];
}
function periodShift(startISO, endISO) {
  const start = new Date(startISO + 'T00:00:00'); const end = new Date(endISO + 'T00:00:00');
  const days = Math.round((end - start) / 86400000) + 1;
  const prevEnd = new Date(start.getTime() - 86400000);
  const prevStart = new Date(prevEnd.getTime() - (days-1)*86400000);
  const fmt = d => d.toISOString().slice(0,10);
  return { prevStart: fmt(prevStart), prevEnd: fmt(prevEnd), days };
}
function computeCards(rows) {
  if (!rows.length) {
    $('#avgVisitor').text('0%'); $('#avgCart').text('0%'); $('#avgPay').text('0%');
    $('#totalProducts').text(0); $('#cartedProducts').text(0); $('#purchasedProducts').text(0); return;
  }
  const sum = rows.reduce((a,b)=>({exposure:a.exposure+b.exposure,visitors:a.visitors+b.visitors,add_people:a.add_people+b.add_people,pay_buyers:a.pay_buyers+b.pay_buyers}), {exposure:0,visitors:0,add_people:0,pay_buyers:0});
  const products=new Map(); rows.forEach(r=>{ if(!products.has(r.product_id)) products.set(r.product_id,{exp:0,add:0,pay:0}); const acc=products.get(r.product_id); acc.exp+=r.exposure||0; acc.add+=r.add_people||0; acc.pay+=r.pay_buyers||0; });
  let pe=0,pc=0,pp=0; products.forEach(v=>{ if(v.exp>0)pe++; if(v.add>0)pc++; if(v.pay>0)pp++; });
  const vr=sum.exposure>0?((sum.visitors/sum.exposure)*100).toFixed(2)+'%':'0%';
  const cr=sum.visitors>0?((sum.add_people/sum.visitors)*100).toFixed(2)+'%':'0%';
  const pr=sum.add_people>0?((sum.pay_buyers/sum.add_people)*100).toFixed(2)+'%':'0%';
  $('#avgVisitor').text(vr); $('#avgCart').text(cr); $('#avgPay').text(pr);
  $('#totalProducts').text(products.size); $('#cartedProducts').text(pc); $('#purchasedProducts').text(pp);
}
function buildDailyTotals(rows, days, startISO) {
  const byDay=new Map(); rows.forEach(r=>{ const d=r.bucket; if(!byDay.has(d)) byDay.set(d,{exp:0,vis:0,add:0,fav:0,orders:0}); const a=byDay.get(d); a.exp+=r.exposure||0; a.vis+=r.visitors||0; a.add+=r.add_people||0; a.orders+=r.pay_orders||0; a.fav+=(r.fav_people||r.fav_count||0); });
  const x=[],A=[]; const start=new Date(startISO+'T00:00:00');
  for(let i=0;i<days;i++){ const cur=new Date(start.getTime()+i*86400000); const key=cur.toISOString().slice(0,10); x.push(`Day ${i+1}`); const a=byDay.get(key)||{exp:0,vis:0,add:0,fav:0,orders:0}; A.push({exp:a.exp,vis:a.vis,add:a.add,fav:a.fav,orders:a.orders,date:key}); }
  return { x, A };
}
function drawLineChartDaily(rowsA, rowsB, days, startA, startB, metricKey) {
  const chart=echarts.init(document.getElementById('lineChart'));
  const A=buildDailyTotals(rowsA,days,startA); const B=buildDailyTotals(rowsB,days,startB); const x=A.x;
  function pick(arr){ return arr.map(o=>Number((o[metricKey]||0))) }
  chart.setOption({
    tooltip:{ trigger:'axis', formatter:(params)=>{ let s=''; params.forEach(p=>{ const series=p.seriesName==='周期A'?A.A:B.A; const o=series[p.dataIndex]; s+=`<div>${p.marker}${p.seriesName}：${p.data} <span style='color:#9CA3AF'>(${o?.date||''})</span></div>`; }); return s||'无数据'; }, backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
    legend:{ data:['周期A','周期B'], textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:40, right:16, top:36, bottom:24 },
    xAxis:{ type:'category', data:x, axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:true, lineStyle:{ color:GRID_LINE }} },
    yAxis:{ type:'value', axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE }} },
    series:[
      { name:'周期A', type:'line', data:pick(A.A), smooth:true, showSymbol:false, lineStyle:{ width:3 }, itemStyle:{ color:'#2563EB' } },
      { name:'周期B', type:'line', data:pick(B.A), smooth:true, showSymbol:false, lineStyle:{ width:3 }, itemStyle:{ color:'#F97316' } }
    ]
  }); window.addEventListener('resize', ()=>chart.resize());
}
function drawRatioBar(rowsA, rowsB){
  function sums(rows){ return rows.reduce((a,b)=>({exp:a.exp+b.exposure,vis:a.vis+b.visitors,add:a.add+b.add_people,pay:a.pay+b.pay_buyers}),{exp:0,vis:0,add:0,pay:0}); }
  const A=sums(rowsA), B=sums(rowsB);
  const d={ A:[(A.vis>0?A.add/A.vis*100:0),(A.exp>0?A.vis/A.exp*100:0),(A.add>0?A.pay/A.add*100:0)], B:[(B.vis>0?B.add/B.vis*100:0),(B.exp>0?B.vis/B.exp*100:0),(B.add>0?B.pay/B.add*100:0)] };
  const chart=echarts.init(document.getElementById('ratioBar'));
  chart.setOption({
    tooltip:{ trigger:'axis', backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
    legend:{ data:['周期A','周期B'], textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:40, right:16, top:36, bottom:24 },
    xAxis:{ type:'category', data:['平均加购比','平均访客比','平均支付比'], axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:false } },
    yAxis:{ type:'value', axisLabel:{ ...AXIS_LABEL, formatter:'{value} %' }, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE }} },
    series:[
      { name:'周期A', type:'bar', data:d.A.map(v=>Number(v.toFixed(2))), itemStyle:{ color:'#2563EB' }, label:{ show:true, position:'top', formatter:'{c}%', color:'#E5E7EB', fontWeight:700 } },
      { name:'周期B', type:'bar', data:d.B.map(v=>Number(v.toFixed(2))), itemStyle:{ color:'#F97316' }, label:{ show:true, position:'top', formatter:'{c}%', color:'#E5E7EB', fontWeight:700 } }
    ]
  }); window.addEventListener('resize', ()=>chart.resize());
}
async function drawTop6Both(rowsA, rowsB){
  function perAdd(rows){ const m=new Map(); rows.forEach(r=>m.set(r.product_id,(m.get(r.product_id)||0)+(r.add_people||0))); return m; }
  const mapA=perAdd(rowsA), mapB=perAdd(rowsB);
  const topN=(map,n=6)=>Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([id])=>id);
  const unionIds=Array.from(new Set([...topN(mapA,6),...topN(mapB,6)]));
  const rows=unionIds.map(id=>({id,a:mapA.get(id)||0,b:mapB.get(id)||0,max:Math.max(mapA.get(id)||0,mapB.get(id)||0)})).sort((x,y)=>y.max-x.max);
  const ids=rows.map(r=>r.id), labels=ids, dataA=rows.map(r=>r.a), dataB=rows.map(r=>r.b);
  function hue(id){ let h=0; for(let i=0;i<id.length;i++) h=(h*31+id.charCodeAt(i))%360; return h; }
  const colorsA=ids.map(id=>`hsl(${hue(id)}, 70%, 55%)`), colorsB=ids.map(id=>`hsl(${hue(id)}, 70%, 80%)`);
  const chart=echarts.init(document.getElementById('topBar'));
  chart.setOption({
    tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' }, backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
    legend:{ textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:140, right:20, top:20, bottom:24 },
    xAxis:{ type:'value', axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE }} },
    yAxis:{ type:'category', data:labels, axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:false } },
    series:[
      { name:'周期A', type:'bar', data:dataA.map((v,i)=>({value:v,itemStyle:{color:colorsA[i]}})), label:{ show:true, position:'right', color:'#E5E7EB', fontWeight:700 } },
      { name:'周期B', type:'bar', data:dataB.map((v,i)=>({value:v,itemStyle:{color:colorsB[i]}})), label:{ show:true, position:'right', color:'#E5E7EB', fontWeight:700 } }
    ]
  });
  chart.off('click'); chart.on('click', p=>{ const id=ids[p.dataIndex]; if(id) window.open(`https://aliexpress.com/item/${id}.html`,'_blank'); });
  window.addEventListener('resize', ()=>chart.resize());
  const linksDiv=document.getElementById('topBarLinks');
  if(linksDiv){ linksDiv.innerHTML=ids.map(id=>`<a href="https://aliexpress.com/item/${id}.html" target="_blank">#${id}</a>`).join(' '); }
}
async function renderTable(rows, granularity) {
  if (window.dataTable) window.dataTable.destroy(); $('#report').empty();
  const data = rows.map(r => {
    const link = r.product_id ? `<a href="https://aliexpress.com/item/${r.product_id}.html" target="_blank">${r.product_id}</a>` : '';
    const conv1 = r.exposure>0 ? ((r.visitors/r.exposure)*100).toFixed(2) : '0.00';
    const conv2 = r.visitors>0 ? ((r.add_people/r.visitors)*100).toFixed(2) : '0.00';
    const conv3 = r.add_people>0 ? ((r.pay_buyers/r.add_people)*100).toFixed(2) : '0.00';
    const ctr = (r.search_ctr==null || r.search_ctr===undefined) ? '' : Number(r.search_ctr).toFixed(2) + '%';
    const stay = (r.avg_stay_seconds==null || r.avg_stay_seconds===undefined) ? '' : Math.round(r.avg_stay_seconds);
    return [link, r.bucket_label || r.bucket, conv1 + '%', conv2 + '%', conv3 + '%', r.exposure, r.visitors, r.views, r.add_people, r.order_items, r.pay_items, r.pay_buyers, ctr, stay];
  });
  window.dataTable = $('#report').DataTable({
    data,
    columns: [
      { title: '商品（ID）' },
      { title: granularity==='day' ? '日期' : (granularity==='week' ? '周范围' : '月份范围') },
      { title: '访客比(%)' }, { title: '加购比(%)' }, { title: '支付比(%)' },
      { title: '曝光量' }, { title: '访客数' }, { title: '浏览量' },
      { title: '加购人数' },
      // 去掉“加购件数、支付订单数”，新增三列：
      { title: '下单商品件数' },
      { title: '支付件数' },
      { title: '支付买家数' },
      { title: '搜索点击率(%)' },
      { title: '平均停留时长(秒)' }
    ],
    order: [[1,'desc']], scrollX:true, scrollY:'calc(100vh - 420px)', scrollCollapse:true, fixedHeader:true, fixedColumns:{leftColumns:1}
  });
}
async function fetchAndRenderAll() {
  try {
    const val=$('#dateFilter').val(); let startISO,endISO;
    if (val && val.includes(' to ')) { const [s,e]=val.split(' to '); startISO=s; endISO=e; }
    else { const today=new Date(); endISO=today.toISOString().slice(0,10); startISO=new Date(today.getTime()-6*86400000).toISOString().slice(0,10); $('#dateFilter').val(`${startISO} to ${endISO}`); }
    const g = 'day';$('#progress').text('查询中…');

    const rowsNowAgg=await fetchAgg(startISO,endISO,g);
    computeCards(rowsNowAgg);
    await renderTable(rowsNowAgg,g);

    const { prevStart, prevEnd, days }=periodShift(startISO,endISO);
    const rowsA=await fetchAgg(startISO,endISO,'day');
    const rowsB=await fetchAgg(prevStart,prevEnd,'day');
    const metricKey=(function(k){ if(k==='exposure_sum')return 'exp'; if(k==='visitors_sum')return 'vis'; if(k==='add_people_sum')return 'add'; if(k==='orders_sum')return 'orders'; if(k==='fav_sum')return 'fav'; })(document.getElementById('metricSel').value);
    drawLineChartDaily(rowsA,rowsB,days,startISO,prevStart,metricKey);
    drawRatioBar(rowsA,rowsB);
    await drawTop6Both(rowsA,rowsB);

    $('#progress').text(`A: ${rowsA.length} 条 · B: ${rowsB.length} 条`);
  } catch (err) {
    console.error(err); alert('查询失败：' + (err.message || err)); $('#progress').text('');
  }
}
/* ---------- 初始化 ---------- */
const fp=flatpickr('#dateFilter',{ mode:'range', dateFormat:'Y-m-d', onClose:(ds)=>{ if(ds.length===2) fetchAndRenderAll(); } });
$('#refreshBtn').on('click', fetchAndRenderAll);
$('#metricSel').on('change', fetchAndRenderAll);

(async function initDefault(){
  const today=new Date(); const end=today.toISOString().slice(0,10);
  const startDate=new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
  $('#dateFilter').val(`${startDate} to ${end}`);
  await fetchAndRenderAll();
})();
</script>

<!-- ====== New Products KPI (Self) ====== -->
<script>
(function(){
  let removeNewFilter = null;
  let lastData = null;

  function getDT(){
    if (!window.jQuery || !jQuery.fn || !jQuery.fn.dataTable) return null;
    try { return window.dataTable || jQuery('#report').DataTable(); } catch(e){ return null; }
  }
  async function fetchRange(fromISO, toISO){
    const qs = new URLSearchParams({ platform:'self' });
    if (fromISO) qs.set('from', fromISO);
    if (toISO) qs.set('to', toISO);
    const r = await fetch('/api/new-products?'+qs.toString());
    const j = await r.json();
    if (!j.ok) throw new Error(j.msg||'fetch error');
    return j;
  }
  function parseDateRange(){
    const input = document.getElementById('dateFilter');
    if (input && input.value && input.value.includes(' to ')){
      const [s, e] = input.value.split(' to ');
      return { from:s, to:e };
    }
    const today = new Date();
    const to = today.toISOString().slice(0,10);
    const from = new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
    return { from, to };
  }
  function ensureCard(){
    let wrap = document.querySelector('.kpi') || document.getElementById('kpi');
    if (!wrap){
      const table = document.querySelector('#report');
      const host = document.createElement('div');
      host.className = 'kpi-row';
      if (table && table.parentNode) table.parentNode.insertBefore(host, table);
      else document.body.insertBefore(host, document.body.firstChild);
      wrap = host;
    }
    let card = document.getElementById('kpi-new-self-card');
    if (!card){
      const div = document.createElement('div');
      div.className = 'card clickable stat-card';
      div.id = 'kpi-new-self-card';
      div.innerHTML = '<h4>本周期新品数</h4><p id="kpi-new-self-count">--</p><a id="kpi-new-self-clear" class="mini-link">清除筛选</a>';
      wrap.appendChild(div);
      card = div;
    }
    const old = document.getElementById('kpi-new-self-ctrl');
    if (old && old.parentNode) old.parentNode.removeChild(old);
    return {
      card,
      countEl: document.getElementById('kpi-new-self-count'),
      clearEl: document.getElementById('kpi-new-self-clear'),
    };
  }
  function applyFilterByIds(ids){
    const dt = getDT();
    if (removeNewFilter){ removeNewFilter(); removeNewFilter = null; }

    if (dt && jQuery.fn.dataTable.ext){
      const ext = jQuery.fn.dataTable.ext;
      const filterFn = (settings, data, dataIndex) => {
        let pid = (data[0]||'').toString().trim();
        if (!pid || /<a/i.test(pid)) {
          const rowNode = dt.row(dataIndex).node();
          const cell = rowNode && rowNode.querySelector('td:first-child');
          if (cell) pid = (cell.textContent||'').trim();
        }
        const m = pid.match(/(\d{6,})/g);
        if (m && m.length) pid = m[m.length-1];
        return ids.has(pid);
      };
      ext.search.push(filterFn);
      dt.draw();
      removeNewFilter = () => {
        const pos = ext.search.findIndex(f => f === filterFn);
        if (pos > -1) ext.search.splice(pos, 1);
        dt.draw();
      };
    } else {
      const table = document.querySelector('#report');
      if (!table || !table.tBodies[0]) return;
      const rows = Array.from(table.tBodies[0].rows);
      const original = new Map();
      rows.forEach(tr => {
        const td = tr.cells[0];
        let pid = td ? td.textContent.trim() : '';
        const m = pid.match(/(\d{6,})/g);
        if (m && m.length) pid = m[m.length-1];
        if (!original.has(tr)) original.set(tr, tr.style.display);
        tr.style.display = ids.has(pid) ? '' : 'none';
      });
      removeNewFilter = () => { for (const [tr, disp] of original) tr.style.display = disp; };
    }
  }
  async function refreshFromPageRange(){
    const ui = ensureCard();
    const { from, to } = parseDateRange();
    try{
      lastData = await fetchRange(from, to);
      ui.countEl.textContent = lastData.new_count || 0;
      ui.card.onclick = () => {
        if (!lastData.items || !lastData.items.length) return;
        const ids = new Set(lastData.items.map(x => String(x.product_id)));
        applyFilterByIds(ids);
        ui.clearEl.style.display = 'inline';
      };
      ui.clearEl.onclick = (e) => {
        e.stopPropagation();
        if (removeNewFilter) removeNewFilter();
        ui.clearEl.style.display = 'none';
      };
    }catch(e){
      console.warn('[Self KPI] fetch failed:', e);
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const obs = new MutationObserver(()=>{
      const tb = document.querySelector('#report tbody');
      const kpiHost = document.querySelector('.kpi') || document.getElementById('kpi') || document.querySelector('.kpi-row');
      if (kpiHost && tb && tb.children.length){
        obs.disconnect();
        const ghost = document.getElementById('kpi-new-self-ctrl');
        if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
        refreshFromPageRange();
        const input = document.getElementById('dateFilter');
        if (input && !input._newkpi_hook){
          input._newkpi_hook = true;
          input.addEventListener('change', refreshFromPageRange);
          input.addEventListener('blur', refreshFromPageRange);
        }
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn && !refreshBtn._newkpi_hook){
          refreshBtn._newkpi_hook = true;
          refreshBtn.addEventListener('click', () => {
            const prog = document.getElementById('progress');
            if (!prog) return;
            const pObs = new MutationObserver(()=>{
              if ((prog.textContent||'').trim().length){
                pObs.disconnect();
                refreshFromPageRange();
              }
            });
            pObs.observe(prog, { childList:true, characterData:true, subtree:true });
          });
        }
      }
    });
    obs.observe(document.body, { childList:true, subtree:true });

    const tbody = document.querySelector('#report tbody');
    if (tbody){
      const tObs = new MutationObserver(()=>{ refreshFromPageRange(); });
      tObs.observe(tbody, { childList:true });
    }
  });
})();
</script>
</body>
</html>
