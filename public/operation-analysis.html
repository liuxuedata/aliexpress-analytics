<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg" sizes="64x64">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>运营分析</title>
  <link rel="stylesheet" href="assets/theme.css?v=20250812-deep">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>const t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);</script>
  <style>
    /* 移除旧的KPI样式，使用全局统一的样式 */
    .kpi-row{display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:12px}
    
    /* KPI对比卡片样式 */
    .kpi-comparison-section {
      margin-bottom: 30px;
    }
    
    /* 新增：KPI图表容器样式 */
    .kpi-chart-container {
      position: relative;
      height: 180px;
    }
    
    /* 数据加载状态样式 */
    .loading-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      color: #374151;
    }
    .loading-status.error {
      background: #fef2f2;
      border-color: #fecaca;
      color: #dc2626;
    }
    .loading-status.success {
      background: #f0fdf4;
      border-color: #bbf7d0;
      color: #166534;
    }
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 图表区域样式 */
    .charts-section {
      margin-top: 40px;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }
    
    .chart-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
    }
    
    .chart-panel h4 {
      margin: 0 0 16px 0;
      color: #1f2937;
      font-size: 16px;
      font-weight: 600;
    }
    
    /* 时间粒度按钮样式 */
    .date-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .granularity-btn {
      padding: 6px 16px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .granularity-btn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    
    .granularity-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .date-filter {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      min-width: 200px;
    }
    
    .date-filter:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
  </style>
</head>
<body>
<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> 跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali active"><a href="#">速卖通</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon"><a href="amazon-overview.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="#">独立站</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header">
      <div class="site-title">
        <svg class="site-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 0 20M12 2a15.3 15.3 0 0 0 0 20"/></svg>
        <span id="currentSite"></span>
      </div>
      <button id="addSite" class="add-site-btn">+</button>
    </div>
    <ul class="sub-nav">
      <li><a id="detailLink" href="managed.html"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="9" x2="9" y2="21"/><line x1="15" y1="9" x2="15" y2="21"/></svg>详细数据</a></li>
      <li><a class="active" href="#"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 8-8"/><path d="M14 3h7v7"/></svg>运营分析</a></li>
      <li><a id="productLink" href="product-analysis.html"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 3a9 9 0 1 0 9 9h-9z"/><path d="M15 3v8h8"/></svg>产品分析</a></li>
    </ul>
  </nav>
  <main class="main">
    <div class="content">
      <section class="content-pad">
        <!-- 数据加载状态提示 -->
        <div id="loadingStatus" class="loading-status" style="display:none;">
          <div class="loading-spinner"></div>
          <span id="loadingText">数据加载中...</span>
        </div>
        
        <div id="ctrl" class="controls" style="margin-bottom:20px;"></div>
        
        <!-- 顶部KPI卡片 - 本周期 vs 上一周期对比 -->
        <div class="kpi-comparison-section">
          <h3 style="margin-bottom: 16px; color: #1f2937; font-size: 18px;">本周期 vs 上一周期对比</h3>
          <div class="kpi-grid">
            <div class="kpi-card">
              <h4>曝光量</h4>
                             <div class="kpi-chart-container">
                 <div id="expChart" style="width:100%;height:160px;"></div>
               </div>
            </div>
            <div class="kpi-card">
              <h4>访客数</h4>
                             <div class="kpi-chart-container">
                 <div id="uvChart" style="width:100%;height:160px;"></div>
               </div>
            </div>
            <div class="kpi-card">
              <h4>加购次数</h4>
                             <div class="kpi-chart-container">
                 <div id="cartChart" style="width:100%;height:160px;"></div>
               </div>
            </div>
            <div class="kpi-card">
              <h4>支付订单数</h4>
                             <div class="kpi-chart-container">
                 <div id="payChart" style="width:100%;height:160px;"></div>
               </div>
            </div>
            <div class="kpi-card">
              <h4>曝光商品数</h4>
                             <div class="kpi-chart-container">
                 <div id="expProdChart" style="width:100%;height:160px;"></div>
               </div>
            </div>
            <div class="kpi-card">
              <h4>加购商品数</h4>
                             <div class="kpi-chart-container">
                 <div id="cartProdChart" style="width:100%;height:160px;"></div>
               </div>
            </div>
            <div class="kpi-card">
              <h4>支付商品数</h4>
                             <div class="kpi-chart-container">
                 <div id="payProdChart" style="width:100%;height:160px;"></div>
               </div>
            </div>
            <div class="kpi-card">
              <h4>产品总数</h4>
              <div class="kpi-value" id="prodTotal">-</div>
              <div class="kpi-comparison">
                <span class="comparison-label">当前状态</span>
                <span class="comparison-value">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 图表区域 -->
        <div class="charts-section">
          <h3 style="margin: 30px 0 20px 0; color: #1f2937; font-size: 18px;">趋势分析</h3>
          <div class="charts-grid">
            <div class="chart-panel">
              <h4>访客比趋势</h4>
              <div id="uvRateChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h4>加购比趋势</h4>
              <div id="cartRateChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h4>支付比趋势</h4>
              <div id="payRateChart" style="width:100%;height:300px;"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>
<script src="assets/site-nav.js"></script>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const params=new URLSearchParams(location.search);
  const mode=params.get('mode');
  const detailLink=document.getElementById('detailLink');
  const productLink=document.getElementById('productLink');
    if(mode==='self'){
    if(detailLink)detailLink.href='index.html';
    if(productLink)productLink.href='product-analysis.html?mode=self';
  }

  const siteListKey='managedSites';
  const currentSiteKey='currentSite';
  let sites=JSON.parse(localStorage.getItem(siteListKey)||'null');
  if(!Array.isArray(sites)||!sites.length){sites=mode==='self'?['A站','B站','C站']:['主站'];}
  const currentSiteEl=document.getElementById('currentSite');
  function save(){localStorage.setItem(siteListKey,JSON.stringify(sites));renderSiteMenus();}
  function updateCurrent(){
    const currentSiteId = localStorage.getItem('currentSite');
    const currentSiteName = localStorage.getItem('currentSiteName');
    
    // 如果有currentSiteName，直接使用它
    if (currentSiteName) {
      currentSiteEl.textContent = currentSiteName;
    } else if (currentSiteId) {
      // 如果有currentSiteId但没有名称，根据ID判断
      if (currentSiteId.startsWith('ae_self_operated')) {
        currentSiteEl.textContent = '自运营';
      } else {
        currentSiteEl.textContent = '全托管';
      }
    } else {
      // 如果都没有，使用默认逻辑
      const name = localStorage.getItem(currentSiteKey) || sites[0];
      if (mode === 'self') {
        currentSiteEl.textContent = '自运营 ' + name;
      } else {
        currentSiteEl.textContent = sites.length > 1 ? '全托管 ' + name : '全托管';
      }
    }
    
    // 保存当前站点名称到localStorage
    if (currentSiteName) {
      localStorage.setItem(currentSiteKey, currentSiteName);
    }
  }
  currentSiteEl.addEventListener('dblclick',()=>{
    const cur=localStorage.getItem(currentSiteKey)||sites[0];
    const idx=sites.indexOf(cur);
    const n=prompt('修改站点名',cur);
    if(n){sites[idx]=n;save();localStorage.setItem(currentSiteKey,n);updateCurrent();}
  });
  document.getElementById('addSite').addEventListener('click',()=>{
    const n=prompt('新增站点名');
    if(n){sites.push(n);save();updateCurrent();}
  });
  renderSiteMenus();
  updateCurrent();

  if(mode!=='self'){
    ['uvRateChart','cartRateChart','payRateChart'].forEach(id=>{
      const panel=document.getElementById(id)?.parentElement;
      if(panel) panel.remove();
    });
  }

  // 检测当前页面类型：如果有mode=self参数或者从自运营页面访问，使用自运营模式
  const isFromSelfOperated = document.referrer.includes('self-operated.html') || 
                            document.referrer.includes('index.html') ||
                            localStorage.getItem('currentSite')?.startsWith('ae_self_operated');
  
  // 获取当前站点ID和名称
  let currentSiteId = localStorage.getItem('currentSite');
  const currentSiteName = localStorage.getItem('currentSiteName');
  
  // 如果没有设置currentSite，根据模式设置默认值
  if (!currentSiteId) {
    if (mode === 'self') {
      currentSiteId = 'ae_self_operated_a';
      localStorage.setItem('currentSite', currentSiteId);
      console.log('设置默认自运营站点:', currentSiteId);
    } else {
      currentSiteId = 'managed_stats';
      localStorage.setItem('currentSite', currentSiteId);
      console.log('设置默认全托管站点:', currentSiteId);
    }
  }
  
  console.log('运营分析页面模式检测:', { 
    mode, 
    isFromSelfOperated, 
    referrer: document.referrer,
    currentSiteId,
    currentSiteName
  });
  
  // 根据当前站点ID判断使用哪种模式
  if(mode==='self' || isFromSelfOperated || (currentSiteId && currentSiteId.startsWith('ae_self_operated'))){
    console.log('使用自运营模式，站点:', currentSiteId);
    setupSelf();
  }else{
    console.log('使用全托管模式，站点:', currentSiteId); 
    setupFM();
  }

  async function loadProdTotal(){
    const currentSiteId = localStorage.getItem('currentSite');
    let platform = 'managed';
    let site = '';
    
    // 根据当前站点ID确定平台和站点
    if (currentSiteId && currentSiteId.startsWith('ae_self_operated')) {
      platform = 'self';
      // 从currentSiteId中提取站点名称
      if (currentSiteId === 'ae_self_operated_a') {
        site = 'A站';
      } else if (currentSiteId === 'ae_self_operated_poolslab') {
        site = 'Poolslab运动娱乐';
      } else {
        // 如果currentSiteId包含其他站点信息，提取站点名称
        site = currentSiteId.replace('ae_self_operated_', '');
      }
    } else if (currentSiteId && currentSiteId.startsWith('indep_')) {
      platform = 'indep';
    } else if (currentSiteId === 'managed_stats' || currentSiteId === 'ae_managed') {
      // 全托管平台
      platform = 'managed';
      site = 'managed_stats'; // 全托管使用 managed_stats 作为站点标识
    }
    
    const today=new Date().toISOString().slice(0,10);
    const qs=new URLSearchParams({platform,from:'2000-01-01',to:today,limit:'5000'});
    
    // 如果是自运营或全托管平台且有站点信息，添加站点参数
    if ((platform === 'self' || platform === 'managed') && site) {
      qs.set('site', site);
    }
    
    console.log('loadProdTotal调用参数:', { platform, currentSiteId, site, qs: qs.toString() });
    
    try{
      const r=await fetch('/api/new-products?'+qs.toString());
      const j=await r.json();
      
      const newCount = j.new_count || 0;
      document.getElementById('prodTotal').textContent=newCount;
      console.log('loadProdTotal结果:', { platform, currentSiteId, site, newCount, items: j.items?.length || 0 });
    }catch(e){
      console.error('loadProdTotal错误:', e);
      document.getElementById('prodTotal').textContent='0';
    }
  }
  loadProdTotal();

     function renderBar(id,m){
     const element = document.getElementById(id);
     if (!element) {
       console.warn(`图表容器元素 ${id} 不存在，跳过渲染`);
       return;
     }
     
     try {
       const chart=echarts.init(element);
       chart.setOption({
         backgroundColor: 'transparent',
         tooltip:{
           trigger:'axis',
           axisPointer:{type:'shadow'},
           backgroundColor: 'rgba(0,0,0,0.9)',
           borderColor: 'rgba(0,0,0,0.2)',
           textStyle: { color: '#fff' },
           formatter: function(params) {
             return `${params[0].name}<br/>${params[0].seriesName}: ${params[0].value.toLocaleString()}`;
           }
         },
         grid: {
           left: '10%',
           right: '10%',
           top: '15%',
           bottom: '15%'
         },
         xAxis:{
           type:'category',
           data:['本周期','上一周期'],
           axisLine: { lineStyle: { color: '#d1d5db' } },
           axisLabel: { color: '#374151', fontSize: 12 }
         },
         yAxis:{
           type:'value',
           axisLine: { lineStyle: { color: '#d1d5db' } },
           axisLabel: { color: '#6b7280', fontSize: 10 },
           splitLine: { lineStyle: { color: '#f3f4f6' } }
         },
         series:[{
           type:'bar',
           barWidth: '60%',
           data:[
             {value:m.cur,itemStyle:{color:'#1e40af',borderRadius:[4,4,0,0]}},
             {value:m.prev,itemStyle:{color:'#6b7280',borderRadius:[4,4,0,0]}}
           ],
           label:{
             show:true,
             position:'top',
             color: '#111827',
             fontSize: 13,
             fontWeight: 'bold',
             formatter: function(params) {
               return params.value.toLocaleString();
             }
           }
         }]
       });
       window.addEventListener('resize',()=>chart.resize());
       
       // 更新总数显示
       const totalElement = document.getElementById(id.replace('Chart', 'Total'));
       if (totalElement) {
         totalElement.textContent = m.cur.toLocaleString();
       }
     } catch (error) {
       console.error(`渲染图表 ${id} 时出错:`, error);
     }
   }

  function renderLine(id,series){
    const element = document.getElementById(id);
    if (!element) {
      console.warn(`图表容器元素 ${id} 不存在，跳过渲染`);
      return;
    }
    
    try {
      const chart=echarts.init(element);
      chart.setOption({
        tooltip:{trigger:'axis',formatter:p=>p.map(x=>`${x.seriesName}: ${x.data.toFixed(2)}%`).join('<br>')},
        xAxis:{type:'category',data:series.labels},
        yAxis:{type:'value',axisLabel:{formatter:'{value}%'}},
        series:[
          {name:'本周期',type:'line',smooth:true,data:series.cur},
          {name:'上一周期',type:'line',smooth:true,data:series.prev}
        ]
      });
      window.addEventListener('resize',()=>chart.resize());
    } catch (error) {
      console.error(`渲染图表 ${id} 时出错:`, error);
    }
  }

  function setupFM(){
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<div class="date-controls"><span>时间粒度：</span><button class="granularity-btn active" data-granularity="week">按周</button><button class="granularity-btn" data-granularity="month">按月</button><span style="margin-left: 20px;">周期：</span><select id="periodSelect" class="sel" style="margin-left: 8px;"></select></div>';
    
    // 添加粒度按钮事件
    document.querySelectorAll('.granularity-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.granularity-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        const granularity = e.target.dataset.granularity;
        localStorage.setItem('fmGranularity', granularity);
        loadPeriods();
      });
    });
    
    const state={ granularity: localStorage.getItem('fmGranularity')||'week', periods: [] };
    // 设置默认选中的粒度按钮
    const activeBtn = document.querySelector(`[data-granularity="${state.granularity}"]`);
    if (activeBtn) {
      document.querySelectorAll('.granularity-btn').forEach(b => b.classList.remove('active'));
      activeBtn.classList.add('active');
    }
    
    document.getElementById('periodSelect').addEventListener('change',loadData);

    async function loadPeriods(){
      // 从当前激活的按钮获取粒度
      const activeBtn = document.querySelector('.granularity-btn.active');
      const granularity = activeBtn ? activeBtn.dataset.granularity : 'week';
      state.granularity = granularity;
      
      const r=await fetch('/api/periods'); const j=await r.json();
      const list=(state.granularity==='week'?j.weeks:j.months)||[];
      state.periods=list.slice();
      const sel=document.getElementById('periodSelect');
      sel.innerHTML='';
      if(!list.length){sel.innerHTML='<option value="">暂无数据</option>';return;}
      list.forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o);});
      const stored=localStorage.getItem('fmPeriod');
      if(stored && list.includes(stored)) sel.value=stored; else {sel.value=list[0]; localStorage.setItem('fmPeriod',list[0]);}
      loadData();
    }

    async function loadData(){
      const period=document.getElementById('periodSelect').value;
      localStorage.setItem('fmPeriod', period || '');
      const idx=state.periods.indexOf(period);
      const prev=(idx>=0 && idx<state.periods.length-1)?state.periods[idx+1]:'';
      const qsA=new URLSearchParams({granularity:state.granularity});
      if(period)qsA.set('period_end',period);
      const qsB=new URLSearchParams({granularity:state.granularity});
      if(prev)qsB.set('period_end',prev);
      
      // 显示加载状态
      showLoadingStatus('数据加载中...');
      
      console.log('全托管loadData开始加载数据:', { period, prev, granularity: state.granularity });
      
      // 初始化变量
      let rowsA = [];
      let rowsB = [];
      
      try {
        const [ra,rb]=await Promise.all([
          fetch('/api/stats?'+qsA.toString()),
          prev?fetch('/api/stats?'+qsB.toString()):Promise.resolve(null)
        ]);
        const ja=await ra.json();
        const jb=rb?await rb.json():{rows:[]};
        rowsA=ja.rows||[]; rowsB=jb.rows||[];
        
        // 显示成功状态
        showSuccessStatus('数据加载完成');
        
      } catch (error) {
        console.error('全托管数据加载失败:', error);
        showErrorStatus('数据加载失败，请重试');
        
        // 清空图表并显示"暂无数据"
        ['expChart', 'uvChart', 'cartChart', 'payChart', 'expProdChart', 'cartProdChart', 'payProdChart'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            try {
              const chart = echarts.init(element);
              chart.clear();
              chart.setOption({
                title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
              });
            } catch (error) {
              console.error(`清空图表 ${id} 时出错:`, error);
            }
          }
        });
        return;
      }
      
      console.log('全托管loadData获取到数据:', { rowsA: rowsA.length, rowsB: rowsB.length });
      
      // 检查是否有数据
      if (rowsA.length === 0 && rowsB.length === 0) {
        console.log('全托管当前站点没有数据，显示空状态');
        
        // 清空图表并显示"暂无数据"
        ['expChart', 'uvChart', 'cartChart', 'payChart', 'expProdChart', 'cartProdChart', 'payProdChart'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            try {
              const chart = echarts.init(element);
              chart.clear();
              chart.setOption({
                title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
              });
            } catch (error) {
              console.error(`清空图表 ${id} 时出错:`, error);
            }
          }
        });
        return;
      }
      
      function sumExp(rows){return rows.reduce((s,r)=>s+Number(r.search_exposure||r.exposure||r.pv||0),0);}
      const sum= (rows,key)=>rows.reduce((s,r)=>s+Number(r[key]||0),0);
      
      // 计算数据
      const curExp = sumExp(rowsA);
      const prevExp = sumExp(rowsB);
      const curUv = sum(rowsA,'uv');
      const prevUv = sum(rowsB,'uv');
      const curCart = sum(rowsA,'add_to_cart_users');
      const prevCart = sum(rowsB,'add_to_cart_users');
      const curPay = sum(rowsA,'pay_buyers');
      const prevPay = sum(rowsB,'pay_buyers');
      
      const prodExp=rows=>{const set=new Set();rows.forEach(r=>{if(Number(r.search_exposure||r.exposure||r.pv||0)>0)set.add(r.product_id);});return set.size;};
      const prodAdd=rows=>{const set=new Set();rows.forEach(r=>{if(Number(r.add_to_cart_users||0)>0)set.add(r.product_id);});return set.size;};
      const prodPay=rows=>{const set=new Set();rows.forEach(r=>{if(Number(r.pay_buyers||0)>0)set.add(r.product_id);});return set.size;};
      
      const curExpProd = prodExp(rowsA);
      const prevExpProd = prodExp(rowsB);
      const curCartProd = prodAdd(rowsA);
      const prevCartProd = prodAdd(rowsB);
      const curPayProd = prodPay(rowsA);
      const prevPayProd = prodPay(rowsB);
      
      // 渲染柱状图对比（这些会自动更新总数显示）
      renderBar('expChart',{cur:curExp,prev:prevExp});
      renderBar('uvChart',{cur:curUv,prev:prevUv});
      renderBar('cartChart',{cur:curCart,prev:prevCart});
      renderBar('payChart',{cur:curPay,prev:prevPay});
      renderBar('expProdChart',{cur:curExpProd,prev:prevExpProd});
      renderBar('cartProdChart',{cur:curCartProd,prev:prevCartProd});
      renderBar('payProdChart',{cur:curPayProd,prev:prevPayProd});
      
      console.log('全托管KPI数据计算结果:', {
        curExp, prevExp, curUv, prevUv, curCart, prevCart, curPay, prevPay,
        curExpProd, prevExpProd, curCartProd, prevCartProd, curPayProd, prevPayProd
      });
    }

    loadPeriods();
  }

  // 数据加载状态管理
  function showLoadingStatus(message = '数据加载中...') {
    const loadingStatus = document.getElementById('loadingStatus');
    const loadingText = document.getElementById('loadingText');
    if (loadingStatus && loadingText) {
      loadingText.textContent = message;
      loadingStatus.style.display = 'flex';
    }
  }
  
  function hideLoadingStatus() {
    const loadingStatus = document.getElementById('loadingStatus');
    if (loadingStatus) {
      loadingStatus.style.display = 'none';
    }
  }
  
  function showErrorStatus(message = '数据加载失败') {
    const loadingStatus = document.getElementById('loadingStatus');
    const loadingText = document.getElementById('loadingText');
    if (loadingStatus && loadingText) {
      loadingText.textContent = message;
      loadingStatus.style.display = 'flex';
      loadingStatus.classList.add('error');
      
      // 3秒后自动隐藏错误状态
      setTimeout(() => {
        hideLoadingStatus();
        loadingStatus.classList.remove('error');
      }, 3000);
    }
  }
  
  function showSuccessStatus(message = '数据加载完成') {
    const loadingStatus = document.getElementById('loadingStatus');
    const loadingText = document.getElementById('loadingText');
    if (loadingStatus && loadingText) {
      loadingText.textContent = message;
      loadingStatus.style.display = 'flex';
      loadingStatus.classList.add('success');
      
      // 2秒后自动隐藏成功状态
      setTimeout(() => {
        hideLoadingStatus();
        loadingStatus.classList.remove('success');
      }, 2000);
    }
  }

  function setupSelf(){
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<div class="date-controls"><span>时间粒度：</span><button class="granularity-btn active" data-granularity="day">按日</button><span style="margin-left: 20px;">日期：</span><input id="dateFilter" class="date-filter" placeholder="选择日期范围" style="margin-left: 8px;"></div>';
    const input=document.getElementById('dateFilter');
    flatpickr(input,{mode:'range',dateFormat:'Y-m-d',onClose:ds=>{if(ds.length===2)loadData();}});
    const currentSiteId = localStorage.getItem('currentSite') || 'ae_self_operated_a';
    const periodKey = `selfPeriod_${currentSiteId}`;
    const stored=localStorage.getItem(periodKey);
    if(stored && stored.includes(' to ')){
      input.value=stored;
    }else{
      const today=new Date(); const end=today.toISOString().slice(0,10);
      // 如果今天是2024年或更早，使用2025-07-01作为开始日期
      const start = today.getFullYear() < 2025 ? '2025-07-01' : new Date(today.getTime()-30*86400000).toISOString().slice(0,10);
      const def=`${start} to ${end}`;
      input.value=def; localStorage.setItem(periodKey,def);
    }
    loadData();

    async function loadData(){
      const val=input.value; if(!val.includes(' to '))return; const [startISO,endISO]=val.split(' to ');
      localStorage.setItem(periodKey, `${startISO} to ${endISO}`);
      const {prevStart,prevEnd}=periodShift(startISO,endISO);
      
      // 显示加载状态
      showLoadingStatus('数据加载中...');
      
      console.log('loadData开始加载数据:', { startISO, endISO, prevStart, prevEnd });
      
      // 初始化变量
      let rowsCur = [];
      let rowsPrev = [];
      let rowsCurDay = [];
      let rowsPrevDay = [];
      
      try {
        [rowsCur,rowsPrev,rowsCurDay,rowsPrevDay]=await Promise.all([
          fetchAgg(startISO,endISO,'day'),
          fetchAgg(prevStart,prevEnd,'day'),
          fetchAgg(startISO,endISO,'day'),
          fetchAgg(prevStart,prevEnd,'day')
        ]);
        
        // 显示成功状态
        showSuccessStatus('数据加载完成');
        
      } catch (error) {
        console.error('数据加载失败:', error);
        showErrorStatus('数据加载失败，请重试');
        
        // 清空图表并显示"暂无数据"
        ['expChart', 'uvChart', 'cartChart', 'payChart', 'expProdChart', 'cartProdChart', 'payProdChart'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            try {
              const chart = echarts.init(element);
              chart.clear();
              chart.setOption({
                title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
              });
            } catch (error) {
              console.error(`清空图表 ${id} 时出错:`, error);
            }
          }
        });
        
        // 清空趋势图表
        ['uvRateChart', 'cartRateChart', 'payRateChart'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            try {
              const chart = echarts.init(element);
              chart.clear();
              chart.setOption({
                title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
              });
            } catch (error) {
              console.error(`清空趋势图表 ${id} 时出错:`, error);
            }
          }
        });
        return;
      }
      
      console.log('loadData获取到数据:', { 
        rowsCur: rowsCur.length, 
        rowsPrev: rowsPrev.length,
        rowsCurDay: rowsCurDay.length,
        rowsPrevDay: rowsPrevDay.length
      });
      
      // 检查是否有数据
      if (rowsCur.length === 0 && rowsPrev.length === 0) {
        console.log('当前站点没有数据，显示空状态');
        
        // 清空图表并显示"暂无数据"
        ['expChart', 'uvChart', 'cartChart', 'payChart', 'expProdChart', 'cartProdChart', 'payProdChart'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            try {
              const chart = echarts.init(element);
              chart.clear();
              chart.setOption({
                title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
              });
            } catch (error) {
              console.error(`清空图表 ${id} 时出错:`, error);
            }
          }
        });
        
        // 清空趋势图表
        ['uvRateChart', 'cartRateChart', 'payRateChart'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            try {
              const chart = echarts.init(element);
              chart.clear();
              chart.setOption({
                title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
              });
            } catch (error) {
              console.error(`清空趋势图表 ${id} 时出错:`, error);
            }
          }
        });
        return;
      }
      
      const sum=(rows,key)=>rows.reduce((s,r)=>s+Number(r[key]||0),0);
      const pickAdd=r=>Number(r.add_count)||Number(r.add_people)||0;
      const pickPay=r=>Number(r.pay_orders)||Number(r.pay_buyers)||Number(r.pay_items)||0;
      const sumAdd=rows=>rows.reduce((s,r)=>s+pickAdd(r),0);
      const sumPay=rows=>rows.reduce((s,r)=>s+pickPay(r),0);
      
      const prodExp=(rows)=>{const set=new Set();rows.forEach(r=>{if(Number(r.exposure||0)>0)set.add(r.product_id);});return set.size;};
      const prodAdd=(rows)=>{const set=new Set();rows.forEach(r=>{if(pickAdd(r)>0)set.add(r.product_id);});return set.size;};
      const prodPay=(rows)=>{const set=new Set();rows.forEach(r=>{if(pickPay(r)>0)set.add(r.product_id);});return set.size;};

      // 更新KPI卡片
      const curExp = sum(rowsCur,'exposure');
      const prevExp = sum(rowsPrev,'exposure');
      const curUv = sum(rowsCur,'visitors');
      const prevUv = sum(rowsPrev,'visitors');
      const curCart = sumAdd(rowsCur);
      const prevCart = sumAdd(rowsPrev);
      const curPay = sumPay(rowsCur);
      const prevPay = sumPay(rowsPrev);
      const curExpProd = prodExp(rowsCur);
      const prevExpProd = prodExp(rowsPrev);
      const curCartProd = prodAdd(rowsCur);
      const prevCartProd = prodAdd(rowsPrev);
      const curPayProd = prodPay(rowsCur);
      const prevPayProd = prodPay(rowsPrev);
      
      // 渲染柱状图对比
      renderBar('expChart',{cur:curExp,prev:prevExp});
      renderBar('uvChart',{cur:curUv,prev:prevUv});
      renderBar('cartChart',{cur:curCart,prev:prevCart});
      renderBar('payChart',{cur:curPay,prev:prevPay});
      renderBar('expProdChart',{cur:curExpProd,prev:prevExpProd});
      renderBar('cartProdChart',{cur:curCartProd,prev:prevCartProd});
      renderBar('payProdChart',{cur:curPayProd,prev:prevPayProd});

      // 更新KPI总数显示（这些会在renderBar函数中自动更新）
      console.log('KPI数据计算结果:', {
        curExp, prevExp, curUv, prevUv, curCart, prevCart, curPay, prevPay,
        curExpProd, prevExpProd, curCartProd, prevCartProd, curPayProd, prevPayProd
      });

      const dailyAgg=rows=>{
        const map=new Map();
        rows.forEach(r=>{
          const d=r.bucket||r.stat_date; if(!d) return;
          if(!map.has(d)) map.set(d,{exposure:0,visitors:0,add_count:0,add_people:0,pay_orders:0,pay_buyers:0,pay_items:0});
          const obj=map.get(d);
          obj.exposure+=Number(r.exposure)||0;
          obj.visitors+=Number(r.visitors)||0;
          obj.add_count+=Number(r.add_count)||0;
          obj.add_people+=Number(r.add_people)||0;
          obj.pay_orders+=Number(r.pay_orders)||0;
          obj.pay_buyers+=Number(r.pay_buyers)||0;
          obj.pay_items+=Number(r.pay_items)||0;
        });
        return Array.from(map.entries()).sort(([a],[b])=>a.localeCompare(b)).map(([date,val])=>({date,...val}));
      };
      const curDay=dailyAgg(rowsCurDay);
      const prevDay=dailyAgg(rowsPrevDay);
      
      console.log('趋势图表数据:', { curDay: curDay.length, prevDay: prevDay.length });
      
      if (curDay.length > 0) {
        const labels=curDay.map(r=>r.date.slice(5));
        const build=(arr,fn)=>labels.map((_,i)=>arr[i]?fn(arr[i]):0);
        const uvRate=r=>r.exposure>0?(r.visitors/r.exposure*100):0;
        const cartRate=r=>{const a=pickAdd(r);return r.visitors>0?(a/r.visitors*100):0;};
        const payRate=r=>{const p=pickPay(r);return r.visitors>0?(p/r.visitors*100):0;};
        renderLine('uvRateChart',{labels,cur:build(curDay,uvRate),prev:build(prevDay,uvRate)});
        renderLine('cartRateChart',{labels,cur:build(curDay,cartRate),prev:build(prevDay,cartRate)});
        renderLine('payRateChart',{labels,cur:build(curDay,payRate),prev:build(prevDay,payRate)});
      } else {
        // 如果没有数据，显示空状态
        ['uvRateChart', 'cartRateChart', 'payRateChart'].forEach(id => {
          const chart = echarts.init(document.getElementById(id));
          chart.clear();
          chart.setOption({
            title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
          });
        });
      }
    }

    function fetchAgg(start,end,gran='day'){
      let currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
      
      // 确保使用正确的站点ID格式
      if (currentSite === 'A站' || currentSite === '自运营robot站') {
        currentSite = 'ae_self_operated_a';
        localStorage.setItem('currentSite', currentSite);
      }
      
      // 如果当前站点是Poolslab，使用正确的站点ID
      if (currentSite === 'Poolslab运动娱乐' || currentSite === 'poolslab') {
        currentSite = 'ae_self_operated_poolslab';
      }
      
      console.log('fetchAgg调用参数:', { start, end, gran, currentSite });
      
      const url=`/api/ae_query?start=${start}&end=${end}&granularity=${gran}&site=${encodeURIComponent(currentSite)}`;
      console.log('fetchAgg请求URL:', url);
      
      return fetch(url)
        .then(r => {
          console.log('fetchAgg HTTP响应状态:', r.status, r.statusText);
          if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
          }
          return r.json();
        })
        .then(j => {
          console.log('fetchAgg完整响应:', j);
          console.log('fetchAgg响应数据:', { 
            rows: j.rows?.length || 0, 
            site: currentSite,
            hasData: !!j.rows && j.rows.length > 0,
            sampleData: j.rows ? j.rows.slice(0, 2) : []
          });
          return j.rows || [];
        })
        .catch(error => {
          console.error('fetchAgg请求失败:', error);
          return [];
        });
    }
    function periodShift(startISO,endISO){
      const start=new Date(startISO+'T00:00:00'); const end=new Date(endISO+'T00:00:00');
      const days=Math.round((end-start)/86400000)+1;
      const prevEnd=new Date(start.getTime()-86400000);
      const prevStart=new Date(prevEnd.getTime()-(days-1)*86400000);
      const fmt=d=>d.toISOString().slice(0,10);
      return{prevStart:fmt(prevStart),prevEnd:fmt(prevEnd)};
    }
  }
});
</script>
</body>
</html>
