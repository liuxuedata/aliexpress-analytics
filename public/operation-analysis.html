<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg" sizes="64x64">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>运营分析</title>
  <link rel="stylesheet" href="assets/theme.css?v=20250812-deep">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>const t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);</script>
  <style>
    .kpi-row{display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:12px}
    
    /* KPI对比卡片样式 */
    .kpi-comparison-section {
      margin-bottom: 30px;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .kpi-card {
      background: linear-gradient(135deg, #4c51bf 0%, #553c9a 100%);
      border-radius: 12px;
      padding: 20px;
      color: white;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .kpi-card h4 {
      margin: 0 0 12px 0;
      font-size: 15px;
      font-weight: 600;
      opacity: 1;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgba(255, 255, 255, 0.95);
    }
    
    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 12px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .kpi-comparison {
      font-size: 13px;
      opacity: 1;
      color: rgba(255, 255, 255, 0.95);
    }
    
    .comparison-label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .comparison-value {
      font-weight: 700;
      margin-right: 8px;
      color: rgba(255, 255, 255, 0.98);
    }
    
    .trend {
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
    }
    
    .trend.up {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }
    
    .trend.down {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    
    /* 图表区域样式 */
    .charts-section {
      margin-top: 40px;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }
    
    .chart-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
    }
    
    .chart-panel h4 {
      margin: 0 0 16px 0;
      color: #1f2937;
      font-size: 16px;
      font-weight: 600;
    }
    
    /* 时间粒度按钮样式 */
    .date-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .granularity-btn {
      padding: 6px 16px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .granularity-btn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    
    .granularity-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .date-filter {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      min-width: 200px;
    }
    
    .date-filter:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
  </style>
</head>
<body>
<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> 跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali active"><a href="#">速卖通</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon"><a href="amazon-overview.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="#">独立站</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header">
      <div class="site-title">
        <svg class="site-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 0 20M12 2a15.3 15.3 0 0 0 0 20"/></svg>
        <span id="currentSite"></span>
      </div>
      <button id="addSite" class="add-site-btn">+</button>
    </div>
    <ul class="sub-nav">
      <li><a id="detailLink" href="managed.html"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="9" x2="9" y2="21"/><line x1="15" y1="9" x2="15" y2="21"/></svg>详细数据</a></li>
      <li><a class="active" href="#"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 8-8"/><path d="M14 3h7v7"/></svg>运营分析</a></li>
      <li><a id="productLink" href="product-analysis.html"><svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 3a9 9 0 1 0 9 9h-9z"/><path d="M15 3v8h8"/></svg>产品分析</a></li>
    </ul>
  </nav>
  <main class="main">
    <div class="content">
      <section class="content-pad">
        <div id="ctrl" class="controls" style="margin-bottom:20px;"></div>
        
        <!-- 顶部KPI卡片 - 本周期 vs 上一周期对比 -->
        <div class="kpi-comparison-section">
          <h3 style="margin-bottom: 16px; color: #1f2937; font-size: 18px;">本周期 vs 上一周期对比</h3>
          <div class="kpi-grid">
            <div class="kpi-card">
              <h4>曝光量</h4>
              <div class="kpi-value" id="expValue">-</div>
              <div class="kpi-comparison">
                <span class="comparison-label">上一周期：</span>
                <span class="comparison-value" id="expPrev">-</span>
                <span class="trend" id="expTrend">-</span>
              </div>
            </div>
            <div class="kpi-card">
              <h4>访客数</h4>
              <div class="kpi-value" id="uvValue">-</div>
              <div class="kpi-comparison">
                <span class="comparison-label">上一周期：</span>
                <span class="comparison-value" id="uvPrev">-</span>
                <span class="trend" id="uvTrend">-</span>
              </div>
            </div>
            <div class="kpi-card">
              <h4>加购次数</h4>
              <div class="kpi-value" id="cartValue">-</div>
              <div class="kpi-comparison">
                <span class="comparison-label">上一周期：</span>
                <span class="comparison-value" id="cartPrev">-</span>
                <span class="trend" id="cartTrend">-</span>
              </div>
            </div>
            <div class="kpi-card">
              <h4>支付订单数</h4>
              <div class="kpi-value" id="payValue">-</div>
              <div class="kpi-comparison">
                <span class="comparison-label">上一周期：</span>
                <span class="comparison-value" id="payPrev">-</span>
                <span class="trend" id="payTrend">-</span>
              </div>
            </div>
            <div class="kpi-card">
              <h4>曝光商品数</h4>
              <div class="kpi-value" id="expProdValue">-</div>
              <div class="kpi-comparison">
                <span class="comparison-label">上一周期：</span>
                <span class="comparison-value" id="expProdPrev">-</span>
                <span class="trend" id="expProdTrend">-</span>
              </div>
            </div>
            <div class="kpi-card">
              <h4>加购商品数</h4>
              <div class="kpi-value" id="cartProdValue">-</div>
              <div class="kpi-comparison">
                <span class="comparison-label">上一周期：</span>
                <span class="comparison-value" id="cartProdPrev">-</span>
                <span class="trend" id="cartProdTrend">-</span>
              </div>
            </div>
            <div class="kpi-card">
              <h4>支付商品数</h4>
              <div class="kpi-value" id="payProdValue">-</div>
              <div class="kpi-comparison">
                <span class="comparison-label">上一周期：</span>
                <span class="comparison-value" id="payProdPrev">-</span>
                <span class="trend" id="payProdTrend">-</span>
              </div>
            </div>
            <div class="kpi-card">
              <h4>产品总数</h4>
              <div class="kpi-value" id="prodTotal">-</div>
              <div class="kpi-comparison">
                <span class="comparison-label">当前状态</span>
                <span class="comparison-value">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 图表区域 -->
        <div class="charts-section">
          <h3 style="margin: 30px 0 20px 0; color: #1f2937; font-size: 18px;">趋势分析</h3>
          <div class="charts-grid">
            <div class="chart-panel">
              <h4>访客比趋势</h4>
              <div id="uvRateChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h4>加购比趋势</h4>
              <div id="cartRateChart" style="width:100%;height:300px;"></div>
            </div>
            <div class="chart-panel">
              <h4>支付比趋势</h4>
              <div id="payRateChart" style="width:100%;height:300px;"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>
<script src="assets/site-nav.js"></script>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const params=new URLSearchParams(location.search);
  const mode=params.get('mode');
  const detailLink=document.getElementById('detailLink');
  const productLink=document.getElementById('productLink');
    if(mode==='self'){
    if(detailLink)detailLink.href='index.html';
    if(productLink)productLink.href='product-analysis.html?mode=self';
  }

  const siteListKey='managedSites';
  const currentSiteKey='currentSite';
  let sites=JSON.parse(localStorage.getItem(siteListKey)||'null');
  if(!Array.isArray(sites)||!sites.length){sites=mode==='self'?['A站','B站','C站']:['主站'];}
  const currentSiteEl=document.getElementById('currentSite');
  function save(){localStorage.setItem(siteListKey,JSON.stringify(sites));renderSiteMenus();}
  function updateCurrent(){
    const name=localStorage.getItem(currentSiteKey)||sites[0];
    if(mode==='self'){
      currentSiteEl.textContent='自运营 '+name;
    }else{
      currentSiteEl.textContent=sites.length>1?'全托管 '+name:'全托管';
    }
    localStorage.setItem(currentSiteKey,name);
  }
  currentSiteEl.addEventListener('dblclick',()=>{
    const cur=localStorage.getItem(currentSiteKey)||sites[0];
    const idx=sites.indexOf(cur);
    const n=prompt('修改站点名',cur);
    if(n){sites[idx]=n;save();localStorage.setItem(currentSiteKey,n);updateCurrent();}
  });
  document.getElementById('addSite').addEventListener('click',()=>{
    const n=prompt('新增站点名');
    if(n){sites.push(n);save();updateCurrent();}
  });
  renderSiteMenus();
  updateCurrent();

  if(mode!=='self'){
    ['uvRateChart','cartRateChart','payRateChart'].forEach(id=>{
      const panel=document.getElementById(id)?.parentElement;
      if(panel) panel.remove();
    });
  }

  // 检测当前页面类型：如果有mode=self参数或者从自运营页面访问，使用自运营模式
  const isFromSelfOperated = document.referrer.includes('self-operated.html') || 
                            document.referrer.includes('index.html') ||
                            localStorage.getItem('currentSite')?.startsWith('ae_self_operated');
  
  // 获取当前站点ID和名称
  const currentSiteId = localStorage.getItem('currentSite');
  const currentSiteName = localStorage.getItem('currentSiteName');
  
  console.log('运营分析页面模式检测:', { 
    mode, 
    isFromSelfOperated, 
    referrer: document.referrer,
    currentSiteId,
    currentSiteName
  });
  
  // 根据当前站点ID判断使用哪种模式
  if(mode==='self' || isFromSelfOperated || (currentSiteId && currentSiteId.startsWith('ae_self_operated'))){
    console.log('使用自运营模式，站点:', currentSiteId);
    setupSelf();
  }else{
    console.log('使用全托管模式，站点:', currentSiteId); 
    setupFM();
  }

  async function loadProdTotal(){
    const platform=mode==='self'?'self':'managed';
    const today=new Date().toISOString().slice(0,10);
    const qs=new URLSearchParams({platform,from:'2000-01-01',to:today,limit:'5000'});
    try{
      const r=await fetch('/api/new-products?'+qs.toString());
      const j=await r.json();
      document.getElementById('prodTotal').textContent=j.new_count||0;
    }catch(e){
      console.error(e);
      document.getElementById('prodTotal').textContent='0';
    }
  }
  loadProdTotal();

  function renderBar(id,m){
    const chart=echarts.init(document.getElementById(id));
    chart.setOption({
      tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},
      xAxis:{type:'category',data:['本周期','上一周期']},
      yAxis:{type:'value'},
      series:[{
        type:'bar',
        data:[{value:m.cur,itemStyle:{color:'#3b82f6'}},{value:m.prev,itemStyle:{color:'#94a3b8'}}],
        label:{show:true,position:'top'}
      }]
    });
    window.addEventListener('resize',()=>chart.resize());
  }

  function renderLine(id,series){
    const chart=echarts.init(document.getElementById(id));
    chart.setOption({
      tooltip:{trigger:'axis',formatter:p=>p.map(x=>`${x.seriesName}: ${x.data.toFixed(2)}%`).join('<br>')},
      xAxis:{type:'category',data:series.labels},
      yAxis:{type:'value',axisLabel:{formatter:'{value}%'}},
      series:[
        {name:'本周期',type:'line',smooth:true,data:series.cur},
        {name:'上一周期',type:'line',smooth:true,data:series.prev}
      ]
    });
    window.addEventListener('resize',()=>chart.resize());
  }

  function setupFM(){
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<div class="date-controls"><span>时间粒度：</span><button class="granularity-btn active" data-granularity="week">按周</button><button class="granularity-btn" data-granularity="month">按月</button><span style="margin-left: 20px;">周期：</span><select id="periodSelect" class="sel" style="margin-left: 8px;"></select></div>';
    
    // 添加粒度按钮事件
    document.querySelectorAll('.granularity-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.granularity-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        const granularity = e.target.dataset.granularity;
        localStorage.setItem('fmGranularity', granularity);
        loadPeriods();
      });
    });
    
    const state={ granularity: localStorage.getItem('fmGranularity')||'week', periods: [] };
    // 设置默认选中的粒度按钮
    const activeBtn = document.querySelector(`[data-granularity="${state.granularity}"]`);
    if (activeBtn) {
      document.querySelectorAll('.granularity-btn').forEach(b => b.classList.remove('active'));
      activeBtn.classList.add('active');
    }
    
    document.getElementById('periodSelect').addEventListener('change',loadData);

    async function loadPeriods(){
      // 从当前激活的按钮获取粒度
      const activeBtn = document.querySelector('.granularity-btn.active');
      const granularity = activeBtn ? activeBtn.dataset.granularity : 'week';
      state.granularity = granularity;
      
      const r=await fetch('/api/periods'); const j=await r.json();
      const list=(state.granularity==='week'?j.weeks:j.months)||[];
      state.periods=list.slice();
      const sel=document.getElementById('periodSelect');
      sel.innerHTML='';
      if(!list.length){sel.innerHTML='<option value="">暂无数据</option>';return;}
      list.forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o);});
      const stored=localStorage.getItem('fmPeriod');
      if(stored && list.includes(stored)) sel.value=stored; else {sel.value=list[0]; localStorage.setItem('fmPeriod',list[0]);}
      loadData();
    }

    async function loadData(){
      const period=document.getElementById('periodSelect').value;
      localStorage.setItem('fmPeriod', period || '');
      const idx=state.periods.indexOf(period);
      const prev=(idx>=0 && idx<state.periods.length-1)?state.periods[idx+1]:'';
      const qsA=new URLSearchParams({granularity:state.granularity});
      if(period)qsA.set('period_end',period);
      const qsB=new URLSearchParams({granularity:state.granularity});
      if(prev)qsB.set('period_end',prev);
      const [ra,rb]=await Promise.all([
        fetch('/api/stats?'+qsA.toString()),
        prev?fetch('/api/stats?'+qsB.toString()):Promise.resolve(null)
      ]);
      const ja=await ra.json();
      const jb=rb?await rb.json():{rows:[]};
      const rowsA=ja.rows||[]; const rowsB=jb.rows||[];
      function sumExp(rows){return rows.reduce((s,r)=>s+Number(r.search_exposure||r.exposure||r.pv||0),0);}
      const sum= (rows,key)=>rows.reduce((s,r)=>s+Number(r[key]||0),0);
      renderBar('expChart',{cur:sumExp(rowsA),prev:sumExp(rowsB)});
      renderBar('uvChart',{cur:sum(rowsA,'uv'),prev:sum(rowsB,'uv')});
      renderBar('cartChart',{cur:sum(rowsA,'add_to_cart_users'),prev:sum(rowsB,'add_to_cart_users')});
      renderBar('payChart',{cur:sum(rowsA,'pay_buyers'),prev:sum(rowsB,'pay_buyers')});
      const prodExp=rows=>{const set=new Set();rows.forEach(r=>{if(Number(r.search_exposure||r.exposure||r.pv||0)>0)set.add(r.product_id);});return set.size;};
      const prodAdd=rows=>{const set=new Set();rows.forEach(r=>{if(Number(r.add_to_cart_users||0)>0)set.add(r.product_id);});return set.size;};
      const prodPay=rows=>{const set=new Set();rows.forEach(r=>{if(Number(r.pay_buyers||0)>0)set.add(r.product_id);});return set.size;};
      renderBar('expProdChart',{cur:prodExp(rowsA),prev:prodExp(rowsB)});
      renderBar('cartProdChart',{cur:prodAdd(rowsA),prev:prodAdd(rowsB)});
      renderBar('payProdChart',{cur:prodPay(rowsA),prev:prodPay(rowsB)});
    }

    loadPeriods();
  }

  function setupSelf(){
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<div class="date-controls"><span>时间粒度：</span><button class="granularity-btn active" data-granularity="day">按日</button><span style="margin-left: 20px;">日期：</span><input id="dateFilter" class="date-filter" placeholder="选择日期范围" style="margin-left: 8px;"></div>';
    const input=document.getElementById('dateFilter');
    flatpickr(input,{mode:'range',dateFormat:'Y-m-d',onClose:ds=>{if(ds.length===2)loadData();}});
    const currentSiteId = localStorage.getItem('currentSite') || 'ae_self_operated_a';
    const periodKey = `selfPeriod_${currentSiteId}`;
    const stored=localStorage.getItem(periodKey);
    if(stored && stored.includes(' to ')){
      input.value=stored;
    }else{
      const today=new Date(); const end=today.toISOString().slice(0,10);
      // 如果今天是2024年或更早，使用2025-07-01作为开始日期
      const start = today.getFullYear() < 2025 ? '2025-07-01' : new Date(today.getTime()-30*86400000).toISOString().slice(0,10);
      const def=`${start} to ${end}`;
      input.value=def; localStorage.setItem(periodKey,def);
    }
    loadData();

    async function loadData(){
      const val=input.value; if(!val.includes(' to '))return; const [startISO,endISO]=val.split(' to ');
      localStorage.setItem(periodKey, `${startISO} to ${endISO}`);
      const {prevStart,prevEnd}=periodShift(startISO,endISO);
      
      console.log('loadData开始加载数据:', { startISO, endISO, prevStart, prevEnd });
      
      const [rowsCur,rowsPrev,rowsCurDay,rowsPrevDay]=await Promise.all([
        fetchAgg(startISO,endISO,'day'),
        fetchAgg(prevStart,prevEnd,'day'),
        fetchAgg(startISO,endISO,'day'),
        fetchAgg(prevStart,prevEnd,'day')
      ]);
      
      console.log('loadData获取到数据:', { 
        rowsCur: rowsCur.length, 
        rowsPrev: rowsPrev.length,
        rowsCurDay: rowsCurDay.length,
        rowsPrevDay: rowsPrevDay.length
      });
      
      // 检查是否有数据
      if (rowsCur.length === 0 && rowsPrev.length === 0) {
        console.log('当前站点没有数据，显示空状态');
        // 清空所有KPI卡片
        ['expValue', 'uvValue', 'cartValue', 'payValue', 'expProdValue', 'cartProdValue', 'payProdValue', 'prodTotal'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '0';
        });
        ['expPrev', 'uvPrev', 'cartPrev', 'payPrev', 'expProdPrev', 'cartProdPrev', 'payProdPrev'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '0';
        });
        ['expTrend', 'uvTrend', 'cartTrend', 'payTrend', 'expProdTrend', 'cartProdTrend', 'payProdTrend'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = '-';
            el.className = 'trend';
          }
        });
        
        // 清空趋势图表
        ['uvRateChart', 'cartRateChart', 'payRateChart'].forEach(id => {
          const chart = echarts.init(document.getElementById(id));
          chart.clear();
          chart.setOption({
            title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
          });
        });
        return;
      }
      
      const sum=(rows,key)=>rows.reduce((s,r)=>s+Number(r[key]||0),0);
      const pickAdd=r=>Number(r.add_count)||Number(r.add_people)||0;
      const pickPay=r=>Number(r.pay_orders)||Number(r.pay_buyers)||Number(r.pay_items)||0;
      const sumAdd=rows=>rows.reduce((s,r)=>s+pickAdd(r),0);
      const sumPay=rows=>rows.reduce((s,r)=>s+pickPay(r),0);
      renderBar('expChart',{cur:sum(rowsCur,'exposure'),prev:sum(rowsPrev,'exposure')});
      renderBar('uvChart',{cur:sum(rowsCur,'visitors'),prev:sum(rowsPrev,'visitors')});
      renderBar('cartChart',{cur:sumAdd(rowsCur),prev:sumAdd(rowsPrev)});
      renderBar('payChart',{cur:sumPay(rowsCur),prev:sumPay(rowsPrev)});
      const prodExp=(rows)=>{const set=new Set();rows.forEach(r=>{if(Number(r.exposure||0)>0)set.add(r.product_id);});return set.size;};
      const prodAdd=(rows)=>{const set=new Set();rows.forEach(r=>{if(pickAdd(r)>0)set.add(r.product_id);});return set.size;};
      const prodPay=(rows)=>{const set=new Set();rows.forEach(r=>{if(pickPay(r)>0)set.add(r.product_id);});return set.size;};
      renderBar('expProdChart',{cur:prodExp(rowsCur),prev:prodExp(rowsPrev)});
      renderBar('cartProdChart',{cur:prodAdd(rowsCur),prev:prodAdd(rowsPrev)});
      renderBar('payProdChart',{cur:prodPay(rowsCur),prev:prodPay(rowsPrev)});

      // 更新KPI卡片
      const curExp = sum(rowsCur,'exposure');
      const prevExp = sum(rowsPrev,'exposure');
      const curUv = sum(rowsCur,'visitors');
      const prevUv = sum(rowsPrev,'visitors');
      const curCart = sumAdd(rowsCur);
      const prevCart = sumAdd(rowsPrev);
      const curPay = sumPay(rowsCur);
      const prevPay = sumPay(rowsPrev);
      const curExpProd = prodExp(rowsCur);
      const prevExpProd = prodExp(rowsPrev);
      const curCartProd = prodAdd(rowsCur);
      const prevCartProd = prodAdd(rowsPrev);
      const curPayProd = prodPay(rowsCur);
      const prevPayProd = prodPay(rowsPrev);

      // 更新KPI值
      document.getElementById('expValue').textContent = curExp.toLocaleString();
      document.getElementById('expPrev').textContent = prevExp.toLocaleString();
      document.getElementById('uvValue').textContent = curUv.toLocaleString();
      document.getElementById('uvPrev').textContent = prevUv.toLocaleString();
      document.getElementById('cartValue').textContent = curCart.toLocaleString();
      document.getElementById('cartPrev').textContent = prevCart.toLocaleString();
      document.getElementById('payValue').textContent = curPay.toLocaleString();
      document.getElementById('payPrev').textContent = prevPay.toLocaleString();
      document.getElementById('expProdValue').textContent = curExpProd.toLocaleString();
      document.getElementById('expProdPrev').textContent = prevExpProd.toLocaleString();
      document.getElementById('cartProdValue').textContent = curCartProd.toLocaleString();
      document.getElementById('cartProdPrev').textContent = prevCartProd.toLocaleString();
      document.getElementById('payProdValue').textContent = curPayProd.toLocaleString();
      document.getElementById('payProdPrev').textContent = prevPayProd.toLocaleString();

      // 更新趋势
      const updateTrend = (cur, prev, elementId) => {
        const diff = cur - prev;
        const percent = prev > 0 ? (diff / prev * 100) : 0;
        const trendEl = document.getElementById(elementId);
        trendEl.textContent = `${diff >= 0 ? '↑' : '↓'} ${Math.abs(percent).toFixed(0)}%`;
        trendEl.className = `trend ${diff >= 0 ? 'up' : 'down'}`;
      };

      updateTrend(curExp, prevExp, 'expTrend');
      updateTrend(curUv, prevUv, 'uvTrend');
      updateTrend(curCart, prevCart, 'cartTrend');
      updateTrend(curPay, prevPay, 'payTrend');
      updateTrend(curExpProd, prevExpProd, 'expProdTrend');
      updateTrend(curCartProd, prevCartProd, 'cartProdTrend');
      updateTrend(curPayProd, prevPayProd, 'payProdTrend');

      const dailyAgg=rows=>{
        const map=new Map();
        rows.forEach(r=>{
          const d=r.bucket||r.stat_date; if(!d) return;
          if(!map.has(d)) map.set(d,{exposure:0,visitors:0,add_count:0,add_people:0,pay_orders:0,pay_buyers:0,pay_items:0});
          const obj=map.get(d);
          obj.exposure+=Number(r.exposure)||0;
          obj.visitors+=Number(r.visitors)||0;
          obj.add_count+=Number(r.add_count)||0;
          obj.add_people+=Number(r.add_people)||0;
          obj.pay_orders+=Number(r.pay_orders)||0;
          obj.pay_buyers+=Number(r.pay_buyers)||0;
          obj.pay_items+=Number(r.pay_items)||0;
        });
        return Array.from(map.entries()).sort(([a],[b])=>a.localeCompare(b)).map(([date,val])=>({date,...val}));
      };
      const curDay=dailyAgg(rowsCurDay);
      const prevDay=dailyAgg(rowsPrevDay);
      
      console.log('趋势图表数据:', { curDay: curDay.length, prevDay: prevDay.length });
      
      if (curDay.length > 0) {
        const labels=curDay.map(r=>r.date.slice(5));
        const build=(arr,fn)=>labels.map((_,i)=>arr[i]?fn(arr[i]):0);
        const uvRate=r=>r.exposure>0?(r.visitors/r.exposure*100):0;
        const cartRate=r=>{const a=pickAdd(r);return r.visitors>0?(a/r.visitors*100):0;};
        const payRate=r=>{const p=pickPay(r);return r.visitors>0?(p/r.visitors*100):0;};
        renderLine('uvRateChart',{labels,cur:build(curDay,uvRate),prev:build(prevDay,uvRate)});
        renderLine('cartRateChart',{labels,cur:build(curDay,cartRate),prev:build(prevDay,cartRate)});
        renderLine('payRateChart',{labels,cur:build(curDay,payRate),prev:build(prevDay,payRate)});
      } else {
        // 如果没有数据，显示空状态
        ['uvRateChart', 'cartRateChart', 'payRateChart'].forEach(id => {
          const chart = echarts.init(document.getElementById(id));
          chart.clear();
          chart.setOption({
            title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
          });
        });
      }
    }

    function fetchAgg(start,end,gran='day'){
      let currentSite = localStorage.getItem('currentSite') || 'ae_self_operated_a';
      
      // 确保使用正确的站点ID格式
      if (currentSite === 'A站') {
        currentSite = 'ae_self_operated_a';
        localStorage.setItem('currentSite', currentSite);
      }
      
      // 如果当前站点是Poolslab，使用正确的站点ID
      if (currentSite === 'Poolslab运动娱乐') {
        currentSite = 'ae_self_operated_poolslab';
      }
      
      console.log('fetchAgg调用参数:', { start, end, gran, currentSite });
      
      const url=`/api/ae_query?start=${start}&end=${end}&granularity=${gran}&site=${encodeURIComponent(currentSite)}`;
      console.log('fetchAgg请求URL:', url);
      
      return fetch(url).then(r=>r.json()).then(j=>{
        console.log('fetchAgg响应:', { rows: j.rows?.length || 0, site: currentSite });
        return j.rows||[];
      });
    }
    function periodShift(startISO,endISO){
      const start=new Date(startISO+'T00:00:00'); const end=new Date(endISO+'T00:00:00');
      const days=Math.round((end-start)/86400000)+1;
      const prevEnd=new Date(start.getTime()-86400000);
      const prevStart=new Date(prevEnd.getTime()-(days-1)*86400000);
      const fmt=d=>d.toISOString().slice(0,10);
      return{prevStart:fmt(prevStart),prevEnd:fmt(prevEnd)};
    }
  }
});
</script>
</body>
</html>
