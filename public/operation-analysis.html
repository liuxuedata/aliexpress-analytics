<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>运营分析</title>
  <link rel="stylesheet" href="assets/theme.css?v=20250812-deep">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>const t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);</script>
</head>
<body>
<header class="header">
  <div class="logo-title">跨境电商数据分析平台</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali active"><a href="#">速卖通</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon"><a href="amazon-overview.html">亚马逊</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="#">独立站</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span id="currentSite"></span><button id="addSite" class="add-site-btn">+</button></div>
    <ul class="sub-nav">
      <li><a id="detailLink" href="managed.html">详细数据</a></li>
      <li><a class="active" href="#">运营分析</a></li>
      <li><a id="productLink" href="product-analysis.html">产品分析</a></li>
    </ul>
  </nav>
  <main class="main">
    <div class="content">
      <section class="content-pad">
        <div id="ctrl" class="controls" style="margin-bottom:12px;"></div>
        <div class="grid grid-2">
          <div class="panel"><h3>曝光量</h3><div id="expChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>访客数</h3><div id="uvChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>加购次数</h3><div id="cartChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>支付订单数</h3><div id="payChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>加购商品数</h3><div id="cartProdChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>支付商品数</h3><div id="payProdChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>访客比</h3><div id="uvRateChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>加购比</h3><div id="cartRateChart" style="width:100%;height:260px;"></div></div>
          <div class="panel"><h3>支付比</h3><div id="payRateChart" style="width:100%;height:260px;"></div></div>
        </div>
      </section>
    </div>
  </main>
</div>
<script src="assets/site-nav.js"></script>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const params=new URLSearchParams(location.search);
  const mode=params.get('mode');
  const detailLink=document.getElementById('detailLink');
  const productLink=document.getElementById('productLink');
    if(mode==='self'){
    if(detailLink)detailLink.href='index.html';
    if(productLink)productLink.href='product-analysis.html?mode=self';
  }

  const siteListKey='managedSites';
  const currentSiteKey='currentSite';
  let sites=JSON.parse(localStorage.getItem(siteListKey)||'null');
  if(!Array.isArray(sites)||!sites.length){sites=mode==='self'?['A站','B站','C站']:['主站'];}
  const currentSiteEl=document.getElementById('currentSite');
  function save(){localStorage.setItem(siteListKey,JSON.stringify(sites));renderSiteMenus();}
  function updateCurrent(){
    const name=localStorage.getItem(currentSiteKey)||sites[0];
    if(mode==='self'){
      currentSiteEl.textContent='自运营 '+name;
    }else{
      currentSiteEl.textContent=sites.length>1?'全托管 '+name:'全托管';
    }
    localStorage.setItem(currentSiteKey,name);
  }
  currentSiteEl.addEventListener('dblclick',()=>{
    const cur=localStorage.getItem(currentSiteKey)||sites[0];
    const idx=sites.indexOf(cur);
    const n=prompt('修改站点名',cur);
    if(n){sites[idx]=n;save();localStorage.setItem(currentSiteKey,n);updateCurrent();}
  });
  document.getElementById('addSite').addEventListener('click',()=>{
    const n=prompt('新增站点名');
    if(n){sites.push(n);save();updateCurrent();}
  });
  renderSiteMenus();
  updateCurrent();

  if(mode==='self'){
    setupSelf();
  }else{
    setupFM();
  }

  function renderBar(id,m){
    const chart=echarts.init(document.getElementById(id));
    chart.setOption({
      tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},
      xAxis:{type:'category',data:['本周期','上一周期']},
      yAxis:{type:'value'},
      series:[{
        type:'bar',
        data:[{value:m.cur,itemStyle:{color:'#3b82f6'}},{value:m.prev,itemStyle:{color:'#94a3b8'}}],
        label:{show:true,position:'top'}
      }]
    });
    window.addEventListener('resize',()=>chart.resize());
  }

  function renderLine(id,series){
    const chart=echarts.init(document.getElementById(id));
    chart.setOption({
      tooltip:{trigger:'axis',formatter:p=>p.map(x=>`${x.seriesName}: ${x.data.toFixed(2)}%`).join('<br>')},
      xAxis:{type:'category',data:series.labels},
      yAxis:{type:'value',axisLabel:{formatter:'{value}%'}},
      series:[
        {name:'本周期',type:'line',smooth:true,data:series.cur},
        {name:'上一周期',type:'line',smooth:true,data:series.prev}
      ]
    });
    window.addEventListener('resize',()=>chart.resize());
  }

  function setupFM(){
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<label>粒度</label><label><input type="radio" name="gran" value="week"> 周</label><label><input type="radio" name="gran" value="month"> 月</label><select id="periodSelect" class="sel"></select>';
    const state={ granularity: localStorage.getItem('fmGranularity')||'week', periods: [] };
    document.querySelector(`input[name="gran"][value="${state.granularity}"]`).checked=true;
    document.querySelectorAll('input[name="gran"]').forEach(r=>r.addEventListener('change',e=>{
      state.granularity=e.target.value; localStorage.setItem('fmGranularity',state.granularity); loadPeriods();
    }));
    document.getElementById('periodSelect').addEventListener('change',loadData);

    async function loadPeriods(){
      const r=await fetch('/api/periods'); const j=await r.json();
      const list=(state.granularity==='week'?j.weeks:j.months)||[];
      state.periods=list.slice();
      const sel=document.getElementById('periodSelect');
      sel.innerHTML='';
      if(!list.length){sel.innerHTML='<option value="">暂无数据</option>';return;}
      list.forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o);});
      const stored=localStorage.getItem('fmPeriod');
      if(stored && list.includes(stored)) sel.value=stored; else {sel.value=list[0]; localStorage.setItem('fmPeriod',list[0]);}
      loadData();
    }

    async function loadData(){
      const period=document.getElementById('periodSelect').value;
      localStorage.setItem('fmPeriod', period || '');
      const idx=state.periods.indexOf(period);
      const prev=(idx>=0 && idx<state.periods.length-1)?state.periods[idx+1]:'';
      const qsA=new URLSearchParams({granularity:state.granularity});
      if(period)qsA.set('period_end',period);
      const qsB=new URLSearchParams({granularity:state.granularity});
      if(prev)qsB.set('period_end',prev);
      const [ra,rb]=await Promise.all([
        fetch('/api/stats?'+qsA.toString()),
        prev?fetch('/api/stats?'+qsB.toString()):Promise.resolve(null)
      ]);
      const ja=await ra.json();
      const jb=rb?await rb.json():{rows:[]};
      const rowsA=ja.rows||[]; const rowsB=jb.rows||[];
      function sumExp(rows){return rows.reduce((s,r)=>s+Number(r.search_exposure||r.exposure||r.pv||0),0);} 
      const sum= (rows,key)=>rows.reduce((s,r)=>s+Number(r[key]||0),0);
      renderBar('expChart',{cur:sumExp(rowsA),prev:sumExp(rowsB)});
      renderBar('uvChart',{cur:sum(rowsA,'uv'),prev:sum(rowsB,'uv')});
      renderBar('cartChart',{cur:sum(rowsA,'add_to_cart_users'),prev:sum(rowsB,'add_to_cart_users')});
      renderBar('payChart',{cur:sum(rowsA,'pay_buyers'),prev:sum(rowsB,'pay_buyers')});
      // placeholder for self-mode specific charts
      renderBar('cartProdChart',{cur:0,prev:0});
      renderBar('payProdChart',{cur:0,prev:0});
    }

    loadPeriods();
  }

  function setupSelf(){
    const ctrl=document.getElementById('ctrl');
    ctrl.innerHTML='<input id="dateFilter" class="date-filter" placeholder="选择日期范围">';
    const input=document.getElementById('dateFilter');
    flatpickr(input,{mode:'range',dateFormat:'Y-m-d',onClose:ds=>{if(ds.length===2)loadData();}});
    const stored=localStorage.getItem('selfPeriod');
    if(stored && stored.includes(' to ')){
      input.value=stored;
    }else{
      const today=new Date(); const end=today.toISOString().slice(0,10);
      const start=new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
      const def=`${start} to ${end}`;
      input.value=def; localStorage.setItem('selfPeriod',def);
    }
    loadData();

    async function loadData(){
      const val=input.value; if(!val.includes(' to '))return; const [startISO,endISO]=val.split(' to ');
      localStorage.setItem('selfPeriod', `${startISO} to ${endISO}`);
      const {prevStart,prevEnd}=periodShift(startISO,endISO);
      const [rowsCur,rowsPrev,rowsCurDay,rowsPrevDay]=await Promise.all([
        fetchAgg(startISO,endISO,'period'),
        fetchAgg(prevStart,prevEnd,'period'),
        fetchAgg(startISO,endISO,'day'),
        fetchAgg(prevStart,prevEnd,'day')
      ]);
      const sum=(rows,key)=>rows.reduce((s,r)=>s+Number(r[key]||0),0);
      const pickAdd=r=>Number(r.add_count)||Number(r.add_people)||0;
      const pickPay=r=>Number(r.pay_orders)||Number(r.pay_buyers)||Number(r.pay_items)||0;
      const sumAdd=rows=>rows.reduce((s,r)=>s+pickAdd(r),0);
      const sumPay=rows=>rows.reduce((s,r)=>s+pickPay(r),0);
      renderBar('expChart',{cur:sum(rowsCur,'exposure'),prev:sum(rowsPrev,'exposure')});
      renderBar('uvChart',{cur:sum(rowsCur,'visitors'),prev:sum(rowsPrev,'visitors')});
      renderBar('cartChart',{cur:sumAdd(rowsCur),prev:sumAdd(rowsPrev)});
      renderBar('payChart',{cur:sumPay(rowsCur),prev:sumPay(rowsPrev)});
      const prodAdd=(rows)=>{const set=new Set();rows.forEach(r=>{if(pickAdd(r)>0)set.add(r.product_id);});return set.size;};
      const prodPay=(rows)=>{const set=new Set();rows.forEach(r=>{if(pickPay(r)>0)set.add(r.product_id);});return set.size;};
      renderBar('cartProdChart',{cur:prodAdd(rowsCur),prev:prodAdd(rowsPrev)});
      renderBar('payProdChart',{cur:prodPay(rowsCur),prev:prodPay(rowsPrev)});

      const dailyAgg=rows=>{
        const map=new Map();
        rows.forEach(r=>{
          const d=r.bucket||r.stat_date; if(!d) return;
          if(!map.has(d)) map.set(d,{exposure:0,visitors:0,add_count:0,add_people:0,pay_orders:0,pay_buyers:0,pay_items:0});
          const obj=map.get(d);
          obj.exposure+=Number(r.exposure)||0;
          obj.visitors+=Number(r.visitors)||0;
          obj.add_count+=Number(r.add_count)||0;
          obj.add_people+=Number(r.add_people)||0;
          obj.pay_orders+=Number(r.pay_orders)||0;
          obj.pay_buyers+=Number(r.pay_buyers)||0;
          obj.pay_items+=Number(r.pay_items)||0;
        });
        return Array.from(map.entries()).sort(([a],[b])=>a.localeCompare(b)).map(([date,val])=>({date,...val}));
      };
      const curDay=dailyAgg(rowsCurDay);
      const prevDay=dailyAgg(rowsPrevDay);
      const labels=curDay.map(r=>r.date.slice(5));
      const build=(arr,fn)=>labels.map((_,i)=>arr[i]?fn(arr[i]):0);
      const uvRate=r=>r.exposure>0?(r.visitors/r.exposure*100):0;
      const cartRate=r=>{const a=pickAdd(r);return r.visitors>0?(a/r.visitors*100):0;};
      const payRate=r=>{const p=pickPay(r);return r.visitors>0?(p/r.visitors*100):0;};
      renderLine('uvRateChart',{labels,cur:build(curDay,uvRate),prev:build(prevDay,uvRate)});
      renderLine('cartRateChart',{labels,cur:build(curDay,cartRate),prev:build(prevDay,cartRate)});
      renderLine('payRateChart',{labels,cur:build(curDay,payRate),prev:build(prevDay,payRate)});
    }

    function fetchAgg(start,end,gran='period'){
      const url=`/api/ae_query?start=${start}&end=${end}&granularity=${gran}`;
      return fetch(url).then(r=>r.json()).then(j=>j.rows||[]);
    }
    function periodShift(startISO,endISO){
      const start=new Date(startISO+'T00:00:00'); const end=new Date(endISO+'T00:00:00');
      const days=Math.round((end-start)/86400000)+1;
      const prevEnd=new Date(start.getTime()-86400000);
      const prevStart=new Date(prevEnd.getTime()-(days-1)*86400000);
      const fmt=d=>d.toISOString().slice(0,10);
      return{prevStart:fmt(prevStart),prevEnd:fmt(prevEnd)};
    }
  }
});
</script>
</body>
</html>
