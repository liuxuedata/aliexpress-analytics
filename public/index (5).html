<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>速卖通报告与导航 - 全托管</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
<link rel="stylesheet" href="assets/theme.css?v=20250810">
</head>
<body>
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button id="toggleBtn" class="toggle-btn">«</button>
            <h3 class="nav-title">产品导航</h3>
            <ul>
                <li class="has-submenu">
                    <a href="#"><span class="abbr">S</span><span class="label">速卖通</span></a>
                    <ul class="submenu">
                        <li><a href="index.html">全托管</a></li>
                        <li><a href="self-operated.html">自运营</a></li>
                    </ul>
                </li>
                <li><a href="#"><span class="abbr">T</span><span class="label">TikTok Shop</span></a></li>
                <li><a href="#"><span class="abbr">A</span><span class="label">亚马逊</span></a></li>
                <li class="has-submenu">
                    <a href="#"><span class="abbr">独</span><span class="label">独立站</span></a>
                    <ul class="submenu">
                        <li><a href="independent-site.html">数据分析</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
        <div class="main">
            <div class="upload-section">
                <h2>速卖通全托管数据分析</h2>
                <div class="upload-top">
                    <p class="upload-instruction">请选择包含商品数据的 Excel 或 CSV 文件，系统会自动计算转化率并显示完整数据：</p>
                    <label for="fileInput" class="upload-btn">选择文件</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
                </div>
                <div class="stats-cards">
                    <div class="stat-card" id="card-conv1"><h4>平均访客到加购转化率</h4><p></p></div>
                    <div class="stat-card" id="card-conv2"><h4>平均加购到支付转化率</h4><p></p></div>
                    <div class="stat-card" id="card-visavg"><h4>平均访客比</h4><p></p></div>
                    <div class="stat-card" id="card-total"><h4>产品总数</h4><p></p></div>
                    <div class="stat-card" id="card-addcount"><h4>有加购的产品数</h4><p></p></div>
                    <div class="stat-card" id="card-visitors"><h4>到访客户总数</h4><p></p></div>
                    <div class="stat-card" id="card-paycount"><h4>有支付的产品数</h4><p></p></div>
                </div>
                <button id="saveBtn" style="margin-top: 15px; padding: 8px 14px; font-size: 14px; border: none; border-radius: 4px; background: #4a90e2; color: #fff; cursor: pointer; opacity: 0.6;" disabled>保存到数据库</button>
            </div>
            <div class="table-section">
                <table id="report" class="display" style="width:100%"></table>
            </div>
        </div>
    </div>
<script>
$(document).ready(function() {
    // --- START: Sidebar Active Link Logic ---
    var currentPage = window.location.pathname.split("/").pop();
    if (currentPage === "" || currentPage === "index.html") {
        $('a[href="index.html"]').addClass('active');
    } else {
        $('.sidebar a[href="' + currentPage + '"]').addClass('active');
    }
    $('.sidebar a.active').closest('.has-submenu').addClass('open');
    // --- END: Sidebar Active Link Logic ---

    // Sidebar submenu toggle logic
    $('.has-submenu > a').on('click', function(e) {
        e.preventDefault();
        $(this).parent().toggleClass('open');
    });

    // Sidebar collapse button
    $('#toggleBtn').on('click', function() {
        var sidebar = $('#sidebar');
        var collapsed = sidebar.toggleClass('collapsed').hasClass('collapsed');
        this.textContent = collapsed ? '»' : '«';
    });

    // --- The rest of your page-specific JavaScript ---
    var table = $('#report').DataTable({
        data: [],
        columns: [
            { title: '商品ID' }, { title: '产品链接' }, { title: '搜索曝光量' }, { title: '商品访客数' },
            { title: '商品浏览量' }, { title: '商品加购人数' }, { title: '商品加购件数' }, { title: '支付件数' },
            { title: '支付订单数' }, { title: '支付买家数' },
            { title: '访客到加购转化率(%) <span class="info" onclick="showInfo(\'conv1\')">?</span>' },
            { title: '加购到支付转化率(%) <span class="info" onclick="showInfo(\'conv2\')">?</span>' },
            { title: '访客比(%) <span class="info" onclick="showInfo(\'visRatio\')">?</span>' }
        ],
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh.json' },
        scrollX: true
    });

    var processedDataToSave = [];
    $('#fileInput').on('change', function(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(evt) {
            var data = new Uint8Array(evt.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            var firstSheetName = workbook.SheetNames[0];
            var worksheet = workbook.Sheets[firstSheetName];
            var json = XLSX.utils.sheet_to_json(worksheet, { defval: '', raw: false });
            var processed = computeAndFormat(json);
            
            processedDataToSave = buildDataForSave(json);

            $('#saveBtn').prop('disabled', false).css('opacity', 1);
            table.clear().rows.add(processed).draw();
            
            updateStats(json, processed);

            if (!$('#sidebar').hasClass('collapsed')) {
                $('#sidebar').addClass('collapsed');
                $('#toggleBtn').text('»');
            }
        };
        reader.readAsArrayBuffer(file);
    });

    $('#saveBtn').on('click', function() {
        if (processedDataToSave.length === 0) {
            alert('没有可保存的数据。');
            return;
        }
        fetch('/api/submitData', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(processedDataToSave)
        })
        .then(response => response.json())
        .then(result => {
            alert(result.success ? '数据已成功保存到数据库。' : '保存失败：' + (result.error || '未知错误'));
        })
        .catch(err => alert('保存时发生错误：' + err.message));
    });
});

function showInfo(key) {
    var messages = {
        'conv1': '访客到加购转化率 = 商品加购人数 ÷ 商品访客数 × 100%',
        'conv2': '加购到支付转化率 = 支付买家数 ÷ 商品加购人数 × 100%',
        'visRatio': '访客比 = 商品访客数 ÷ 搜索曝光量 × 100%'
    };
    if (messages[key]) alert(messages[key]);
}

function computeAndFormat(dataArray) {
    return dataArray.map(row => {
        var productId = row['商品ID'];
        var exposures = parseFloat(row['搜索曝光量']) || 0;
        var visitors = parseFloat(row['商品访客数']) || 0;
        var addPeople = parseFloat(row['商品加购人数']) || 0;
        var buyers = parseFloat(row['支付买家数']) || 0;
        
        var conv1 = visitors ? (addPeople / visitors * 100).toFixed(2) : '0.00';
        var conv2 = addPeople ? (buyers / addPeople * 100).toFixed(2) : '0.00';
        var visRatio = exposures ? (visitors / exposures * 100).toFixed(2) : '0.00';
        
        var link = productId ? `<a href="https://aliexpress.com/item/${productId}.html" target="_blank">${productId}</a>` : '';
        
        return [
            productId || '', link, row['搜索曝光量'] || '', row['商品访客数'] || '', row['商品浏览量'] || '',
            row['商品加购人数'] || '', row['商品加购件数'] || '', row['支付件数'] || '',
            row['支付订单数'] || '', row['支付买家数'] || '', conv1, conv2, visRatio
        ];
    });
}

function buildDataForSave(dataArray) {
    return dataArray.map(obj => {
        var visitorCount = parseFloat(obj['商品访客数']) || 0;
        var addPeople = parseFloat(obj['商品加购人数']) || 0;
        var payBuyers = parseFloat(obj['支付买家数']) || 0;
        var exp = parseFloat(obj['搜索曝光量']) || 0;
        return {
            product_id: obj['商品ID'],
            product_link: `https://aliexpress.com/item/${obj['商品ID']}.html`,
            exposure: exp, visitors: visitorCount, views: parseFloat(obj['商品浏览量']) || 0,
            add_people: addPeople, add_count: parseFloat(obj['商品加购件数']) || 0,
            pay_items: parseFloat(obj['支付件数']) || 0, pay_orders: parseFloat(obj['支付订单数']) || 0, pay_buyers: payBuyers,
            visitor_to_add: visitorCount ? (addPeople / visitorCount * 100).toFixed(2) : '0.00',
            add_to_pay: addPeople ? (payBuyers / addPeople * 100).toFixed(2) : '0.00',
            visitor_ratio: exp ? (visitorCount / exp * 100).toFixed(2) : '0.00'
        };
    });
}

function updateStats(json, processed) {
    let total1 = 0, count1 = 0, total2 = 0, count2 = 0, totalVis = 0, countVis = 0;
    processed.forEach(row => {
        let c1 = parseFloat(row[10]); if (!isNaN(c1)) { total1 += c1; count1++; }
        let c2 = parseFloat(row[11]); if (!isNaN(c2)) { total2 += c2; count2++; }
        let c3 = parseFloat(row[12]); if (!isNaN(c3)) { totalVis += c3; countVis++; }
    });

    let addProductCount = 0, payProductCount = 0, totalVisitors = 0;
    json.forEach(row => {
        if (parseFloat(row['商品加购人数']) > 0) addProductCount++;
        if (parseFloat(row['支付订单数']) > 0) payProductCount++;
        totalVisitors += parseFloat(row['商品访客数']) || 0;
    });

    updateCards(
        count1 ? (total1 / count1).toFixed(2) : '0.00',
        count2 ? (total2 / count2).toFixed(2) : '0.00',
        countVis ? (totalVis / countVis).toFixed(2) : '0.00',
        json.length, addProductCount, totalVisitors, payProductCount
    );
}

function updateCards(avg1, avg2, avgVis, totalProducts, addProductCount, totalVisitors, payProductCount) {
    $('#card-conv1 p').text(avg1 + '%');
    $('#card-conv2 p').text(avg2 + '%');
    $('#card-visavg p').text(avgVis + '%');
    $('#card-total p').text(totalProducts);
    $('#card-addcount p').text(addProductCount);
    $('#card-visitors p').text(totalVisitors);
    $('#card-paycount p').text(payProductCount);
}
</script>


<script>
(function() {
  var page = location.pathname.split('/').pop() || 'index.html';
  var links = document.querySelectorAll('.sidebar a[href]');
  for (var i=0;i<links.length;i++) {
    if (links[i].getAttribute('href') === page) {
      links[i].classList.add('active');
      var parent = links[i].closest('.has-submenu');
      if (parent) parent.classList.add('open');
    }
  }
  // Improved behavior: if a parent only has one submenu item, click navigates to that page; otherwise toggle submenu
  var parents = document.querySelectorAll('.has-submenu > a');
  for (var j=0;j<parents.length;j++) {
    parents[j].addEventListener('click', function(e){
      var li = this.parentElement;
      var submenu = li.querySelector('.submenu');
      if (submenu) {
        var items = submenu.querySelectorAll('a[href]');
        if (items.length === 1) {
          // direct navigate to the only child page
          window.location.href = items[0].getAttribute('href');
        } else {
          // toggle open for multi-item groups
          e.preventDefault();
          li.classList.toggle('open');
        }
      }
    });
  }
})();
</script>

</body>
</html>
