<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="assets/logo.svg">
  <title>è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- libs -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.2.2/css/fixedColumns.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.datatables.net/fixedcolumns/4.2.2/js/dataTables.fixedColumns.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="assets/product-meta.js"></script>

  <!-- ä¸»é¢˜æ ·å¼ï¼ˆæ²¿ç”¨ä½ ç°æœ‰çš„ï¼‰ -->
  <link rel="stylesheet" href="assets/login.css">
  <link rel="stylesheet" href="assets/theme.css?v=20250812-deep">
  <style>
    /* NewKPICtrl */
    .kpi-ctrl{display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .5rem;color:#334155;font:500 13px/1 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .kpi-ctrl button{border:1px solid #e5e7eb;background:#fff;border-radius:8px;padding:.25rem .5rem;cursor:pointer}
    .kpi-ctrl button:hover{background:#f8fafc}
    .kpi-ctrl input[type="date"]{border:1px solid #e5e7eb;border-radius:8px;padding:.25rem .5rem}
    .kpi-ctrl .hint{font-size:12px;color:#64748b}
    .stat-card .mini-link,.kpi .card .mini-link{font-size:12px;margin-left:8px;text-decoration:underline;cursor:pointer;display:none}
    .stat-card.clickable,.kpi .card.clickable{cursor:pointer}
    /* KPI basic helpers */
    .kpi-row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin:.25rem 0 .75rem}
    /* Force hide any old period controls if they still exist */
    #kpi-new-self-ctrl, #kpi-new-managed-ctrl, .kpi .kpi-ctrl { display: none !important; }
  </style>
</head>
<body class="fm">
<div id="loginOverlay" class="login-overlay">
  <div class="login-container">
    <div class="login-form-card login-card-enter">
      <div class="form-header">
        <div class="form-logo">AI</div>
        <div class="form-title">è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
        <div class="form-subtitle">ç™»å½•è´¦æˆ·ä»¥ç»§ç»­</div>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label" for="email">é‚®ç®±</label>
          <input id="email" type="email" class="form-input" required>
        </div>
        <div class="form-group password-input-wrapper">
          <label class="form-label" for="password">å¯†ç </label>
          <input id="password" type="password" class="form-input" required>
          <span id="password-toggle" class="password-toggle">ğŸ‘ï¸</span>
        </div>
        <button id="loginSubmit" class="login-submit-btn" type="submit">ç™»å½•</button>
      </form>
      <div class="demo-account-tip">
        <div class="demo-account-header">æ¼”ç¤ºè´¦æˆ·</div>
        <div class="demo-account-info">é‚®ç®±ï¼šdemo@example.com<br>å¯†ç ï¼šdemo123</div>
      </div>
    </div>
  </div>
</div>
<header class="header">
  <div class="logo-title"><img src="assets/logo.svg" alt="Ecommerce Analytics" class="site-logo"> è·¨å¢ƒç”µå•†æ•°æ®åˆ†æå¹³å°</div>
  <nav class="header-center">
    <ul class="platform-nav">
      <li class="ali active"><a href="#">é€Ÿå–é€š</a>
        <ul class="dropdown" id="managedMenu"></ul>
      </li>
      <li class="amazon"><a href="amazon-overview.html">äºšé©¬é€Š</a></li>
      <li class="tiktok"><a href="tiktok.html">TikTok Shop</a></li>
      <li class="temu"><a href="temu.html">Temu</a></li>
      <li class="ozon"><a href="ozon-detail.html">Ozon</a></li>
      <li class="independent"><a href="#">ç‹¬ç«‹ç«™</a>
        <ul class="dropdown" id="indepMenu"></ul>
      </li>
    </ul>
  </nav>
  <div id="userArea" class="user-section"></div>
</header>
<div class="layout container">
  <nav class="sidebar" id="sidebar">
    <div class="site-header"><span id="currentSite">è‡ªè¿è¥ Aç«™</span><button id="addSite" class="add-site-btn">+</button></div>
    <ul class="sub-nav">
      <li><a href="#" class="active" data-target="detail">è¯¦ç»†æ•°æ®</a></li>
      <li><a href="operation-analysis.html?mode=self">è¿è¥åˆ†æ</a></li>
      <li><a href="product-analysis.html?mode=self">äº§å“åˆ†æ</a></li>
    </ul>
  </nav>

  <main class="main">
    <!-- é¡¶éƒ¨ï¼šä¸Šä¼  + å…¨å±€è¿‡æ»¤ -->
    <div class="upload-section">
      <div class="upload-top">
        <div class="controls">
          <label for="fileInput" class="upload-btn">é€‰æ‹©æ–‡ä»¶</label>
          <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
          <span class="notice">ï¼ˆä¸Šä¼ â†’æœåŠ¡ç«¯å…¥åº“â†’å¯è§†åŒ–ä¸æ˜ç»†å±•ç¤ºï¼‰</span>
          <span id="progress" class="progress"></span>
        </div>
        <div class="controls">
          <span>ç²’åº¦ï¼š</span>
          <span class="sel" style="background:#1f2937;color:#fff;border-color:#334155;cursor:not-allowed">æŒ‰æ—¥</span>
          <input type="hidden" id="granularity" value="day">
          <span>æ—¥æœŸï¼š</span>
          <input id="dateFilter" class="date-filter" placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´">
          <span id="status" class="notice"></span>
        </div>
      </div>
      <div class="divider"></div>
      <div class="kpi">
        <div class="card"><h4>å¹³å‡è®¿å®¢æ¯”</h4><p id="avgVisitor">0%</p><div class="sub" id="avgVisitorChange"></div></div>
        <div class="card"><h4>å¹³å‡åŠ è´­æ¯”</h4><p id="avgCart">0%</p><div class="sub" id="avgCartChange"></div></div>
        <div class="card"><h4>å¹³å‡æ”¯ä»˜æ¯”</h4><p id="avgPay">0%</p><div class="sub" id="avgPayChange"></div></div>
        <div class="card"><h4>å•†å“æ€»æ•°</h4><p id="totalProducts">0</p><div class="sub" id="totalProductsChange"></div></div>
        <div class="card"><h4>åŠ è´­å•†å“æ•°</h4><p id="cartedProducts">0</p><div class="sub" id="cartedProductsChange"></div></div>
        <div class="card"><h4>æ”¯ä»˜å•†å“æ•°</h4><p id="purchasedProducts">0</p><div class="sub" id="purchasedProductsChange"></div></div>
      </div>
    </div>

    <!-- é¡¶éƒ¨ Tabs -->
    <div class="content">
      <!-- æ˜ç»†è¡¨ -->
      <section id="detail" class="content-pad">
        <div class="panel">
          <h3>æ•°æ®æ˜ç»†</h3>
          <div class="table-wrapper">
            <table id="report" class="display nowrap" style="width:100%"></table>
          </div>
        </div>
      </section>

      <!-- æ±‡æ€»å¯¹æ¯” -->
      <section id="analysis" class="content-pad" style="display:none;">
        <div class="grid grid-2">
          <div class="panel" style="grid-column:1/-1;">
            <h3>å‘¨æœŸ A vs å‘¨æœŸ B Â· æ€»é‡æ›²çº¿ï¼ˆæŒ‰å¤©ï¼‰</h3>
            <div class="controls" style="margin-bottom:8px;">
              <span>ç»´åº¦ï¼š</span>
              <select id="metricSel" class="sel">
                <option value="exposure_sum">æ›å…‰é‡æ€»å’Œ</option>
                <option value="visitors_sum">è®¿å®¢æ•°æ€»å’Œ</option>
                <option value="add_people_sum">åŠ è´­äººæ•°æ€»å’Œ</option>
                <option value="fav_sum">æ”¶è—æ€»æ•°</option>
                <option value="orders_sum">ä¸‹å•æ€»æ•°</option>
              </select>
              <span class="notice">A = å½“å‰é€‰æ‹©ï¼›B = ä¸Šä¸€å‘¨æœŸï¼ˆå‘å‰å¹³ç§»åŒé•¿åº¦ï¼‰ã€‚</span>
            </div>
            <div id="lineChart" style="width:100%;height:360px;"></div>
          </div>
          <div class="panel">
            <h3>å¹³å‡æ¯”ç‡å¯¹æ¯”ï¼ˆA vs Bï¼‰</h3>
            <div id="ratioBar" style="width:100%;height:300px;"></div>
            <div class="notice">å¯¹æ¯”ï¼šå¹³å‡åŠ è´­æ¯”ã€å¹³å‡è®¿å®¢æ¯”ã€å¹³å‡æ”¯ä»˜æ¯”ã€‚</div>
          </div>
          <div class="panel">
            <h3>Top6 åŠ è´­å•†å“ï¼ˆA & B åŒå›¾ï¼‰</h3>
            <div id="topBar" style="width:100%;height:320px;"></div>
            <div id="topBarLinks" class="legend-list" style="margin-top:6px;"></div>
          </div>
        </div>
      </section>
      <section id="product" class="content-pad" style="display:none;">
        <div class="panel">
          <div class="kpi-ctrl">
            <label>é€‰æ‹©å•†å“</label>
            <select id="selfProductSelect"></select>
          </div>
          <div id="selfProductLine" style="width:100%;height:360px;"></div>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
/* ---------- UI åŸºç¡€ ---------- */
const toNum = v => { if (v===null||v===undefined) return 0; if (typeof v==='number') return isFinite(v)?v:0; const n=parseFloat(String(v).replace(/,/g,'').trim()); return isNaN(n)?0:n; };


// ç»Ÿä¸€ç‚¹å‡»ç‡æ˜¾ç¤ºï¼š<=1 è§†ä¸º 0~1 æ¯”ç‡ï¼Œå…ˆÃ—100å†åŠ ç™¾åˆ†å·ï¼›>1 è§†ä¸ºå·²æ˜¯ç™¾åˆ†æ•°
function formatCtr(v){
  if (v==null || v==='') return '';
  let n = Number(v);
  if (!isFinite(n)) return '';
  if (n <= 1) n *= 100;
  return n.toFixed(2) + '%';
}
/* ---------- é«˜å¯¹æ¯”æ ·å¼å¸¸é‡ï¼ˆç»™ ECharts ç”¨ï¼‰ ---------- */
const AXIS_LABEL = { color: '#E5E7EB', fontWeight: 700, fontSize: 12 };
const GRID_LINE  = 'rgba(148,163,184,0.18)';

/* ---------- ä¸Šä¼  Excel â†’ å…¥åº“ ---------- */
// NOTE: è¿™é‡Œå·²æ”¯æŒ 4 ä¸ªå­—æ®µï¼š
//  - æ”¯ä»˜å•†å“ä»¶æ•°ï¼ˆâ†’ pay_itemsï¼Œå…¼å®¹â€œæ”¯ä»˜ä»¶æ•°/ä»˜æ¬¾ä»¶æ•°/æˆäº¤ä»¶æ•°â€ï¼‰
//  - ä¸‹å•å•†å“ä»¶æ•°ï¼ˆâ†’ order_itemsï¼‰
//  - å¹³å‡åœç•™æ—¶é•¿ï¼ˆç§’ï¼‰ï¼ˆâ†’ avg_stay_secondsï¼‰
//  - æœç´¢ç‚¹å‡»ç‡ï¼ˆ% æ•°å€¼ï¼‰ï¼ˆâ†’ search_ctrï¼‰
$('#fileInput').on('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(evt) {
    try {
      $('#progress').text('è§£æä¸­â€¦');
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
      if (sheet.length < 2) throw new Error('è¡¨æ ¼æ— æœ‰æ•ˆæ•°æ®');
      const headers = sheet[0].map(h => String(h).trim());

      const findIdx = (re) => headers.findIndex(h => re.test(String(h).trim()));
      const idx = {
        product_id: findIdx(/^(å•†å“)?ID$|^å•†å“id$|^id$|^item id$|^item_id$/i),
        stat_date:  findIdx(/^(ç»Ÿè®¡æ—¶é—´|æ—¥æœŸ|æ•°æ®æ—¶é—´|date)$/i),
        exposure:   findIdx(/^(æœç´¢æ›å…‰é‡|æ›å…‰é‡|å•†å“æ›å…‰é‡|impressions)$/i),
        visitors:   (function(){ const rs=[/^(å•†å“)?è®¿å®¢æ•°$/i,/^è®¿å®¢äººæ•°$/i,/^è®¿å®¢é‡$/i,/^uv$/i,/^sessions$/i];
          for (const re of rs){const i = findIdx(re); if(i!==-1) return i;}
          const i2=headers.findIndex(h=>/è®¿å®¢æ•°|è®¿å®¢/i.test(String(h).trim())&&!/(è€|æ–°|å›|å¤)è®¿å®¢/i.test(String(h).trim()));
          return i2;
        })(),
        visitors_new: findIdx(/^(æ–°è®¿å®¢æ•°|æ–°è®¿å®¢|æ–°ç”¨æˆ·|æ–°å¢è®¿å®¢)$/i),
        visitors_old: findIdx(/^(è€è®¿å®¢æ•°|è€è®¿å®¢|å›è®¿å®¢|å¤è®¿å®¢)$/i),
        views:      findIdx(/^(å•†å“æµè§ˆé‡|æµè§ˆé‡|pv|page views)$/i),
        add_people: findIdx(/^(å•†å“åŠ è´­äººæ•°|åŠ è´­äººæ•°|åŠ è´­ä¹°å®¶æ•°)$/i),
        add_count:  findIdx(/^(å•†å“åŠ è´­ä»¶æ•°|åŠ è´­ä»¶æ•°)$/i),
        // âœ… æ”¯ä»˜å•†å“ä»¶æ•°ï¼šå…¼å®¹â€œæ”¯ä»˜ä»¶æ•°/ä»˜æ¬¾ä»¶æ•°/æˆäº¤ä»¶æ•°/æ”¯ä»˜å•†å“ä»¶æ•°â€
        pay_items:  (function(){ const rs=[/^æ”¯ä»˜å•†å“ä»¶æ•°$/i,/^æ”¯ä»˜ä»¶æ•°$/i,/^ä»˜æ¬¾ä»¶æ•°$/i,/^æˆäº¤ä»¶æ•°$/i]; for (const re of rs){const i=findIdx(re); if(i!==-1) return i;} return -1; })(),
        pay_orders: findIdx(/^(æ”¯ä»˜è®¢å•æ•°|ä¸‹å•äººæ•°|è®¢å•æ•°)$/i),
        pay_buyers: findIdx(/^(æ”¯ä»˜ä¹°å®¶æ•°|æ”¯ä»˜äººæ•°|æˆäº¤äººæ•°)$/i),
        fav_people: findIdx(/^(æ”¶è—äººæ•°|æ”¶è—ä¹°å®¶æ•°|æ”¶è—ç”¨æˆ·æ•°)$/i),
        fav_count:  findIdx(/^(æ”¶è—ä»¶æ•°|æ”¶è—é‡)$/i),
        // âœ… æ–°å¢ï¼šä¸‹å•å•†å“ä»¶æ•° / å¹³å‡åœç•™æ—¶é•¿ / æœç´¢ç‚¹å‡»ç‡
        order_items: findIdx(/^(ä¸‹å•å•†å“ä»¶æ•°|ä¸‹å•ä»¶æ•°|ä¸‹å•å•†å“æ•°|ä¸‹å•å•†å“æ•°é‡)$/i),
        avg_stay_seconds: findIdx(/^(å¹³å‡åœç•™æ—¶é•¿(\(ç§’\))?|å¹³å‡åœç•™æ—¶é—´|å¹³å‡è®¿é—®æ—¶é•¿)$/i),
        search_ctr: findIdx(/^(æœç´¢ç‚¹å‡»ç‡(\(%\))?|ç‚¹å‡»ç‡(\(%\))?|æœç´¢ç‚¹å‡»ç‡|ç‚¹å‡»ç‡)$/i),
      };
      if (idx.product_id<0 || idx.stat_date<0) throw new Error('ç¼ºå°‘å¿…å¡«ï¼šå•†å“ID / ç»Ÿè®¡æ—¶é—´');

      function excelDateToISO(n){ if(typeof n!=='number') return null; const utc_days=Math.floor(n-25569); const utc_value=utc_days*86400; const date_info=new Date(utc_value*1000); const y=date_info.getUTCFullYear(); const m=(date_info.getUTCMonth()+1).toString().padStart(2,'0'); const d=date_info.getUTCDate().toString().padStart(2,'0'); return `${y}-${m}-${d}`; }
      function parseDateToISO(v){ if(v===null||v===undefined||v==='') return null; if(typeof v==='number') return excelDateToISO(v); let s=String(v).trim(); s=s.replace(/[.]/g,'-').replace(/\//g,'-'); const m=s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`; const m2=s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/); if(m2) return `${m2[3]}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`; return s.slice(0,10); }

      const rows = sheet.slice(1).filter(r => r && r.length).map(r => {
        const pid = String(r[idx.product_id]).trim();
        const sd  = parseDateToISO(r[idx.stat_date]);
        const visitors = (idx.visitors !== -1 ? toNum(r[idx.visitors])
                        : ((idx.visitors_new !== -1 ? toNum(r[idx.visitors_new]) : 0)
                        + (idx.visitors_old !== -1 ? toNum(r[idx.visitors_old]) : 0)));
        // å°†â€œ12.3%â€å‹ç‚¹å‡»ç‡è½¬æˆ 12.3
        const pct = (x) => { const n = String(x ?? '').trim(); if (!n) return 0; return toNum(n.replace('%','')); };
        const row = {
          product_id: pid, stat_date: sd,
          exposure:  idx.exposure  === -1 ? 0 : toNum(r[idx.exposure]),
          visitors,
          views:     idx.views     === -1 ? 0 : toNum(r[idx.views]),
          add_people:idx.add_people=== -1 ? 0 : toNum(r[idx.add_people]),
          add_count: idx.add_count === -1 ? 0 : toNum(r[idx.add_count]),
          pay_items: idx.pay_items === -1 ? 0 : toNum(r[idx.pay_items]),
          pay_orders:idx.pay_orders=== -1 ? 0 : toNum(r[idx.pay_orders]),
          pay_buyers:idx.pay_buyers=== -1 ? 0 : toNum(r[idx.pay_buyers]),
          // æ–°å¢å­—æ®µ
          order_items: idx.order_items === -1 ? 0 : toNum(r[idx.order_items]),
          avg_stay_seconds: idx.avg_stay_seconds === -1 ? 0 : toNum(r[idx.avg_stay_seconds]),
          search_ctr: idx.search_ctr === -1 ? 0 : pct(r[idx.search_ctr]),
        };
        if (idx.fav_people !== -1) row.fav_people = toNum(r[idx.fav_people]);
        if (idx.fav_count  !== -1) row.fav_count  = toNum(r[idx.fav_count]);
        return row;
      }).filter(x => x.product_id && x.stat_date);
      const dmap=new Map(); rows.forEach(r=>dmap.set(r.product_id+'__'+r.stat_date,r)); const deduped=Array.from(dmap.values());

      $('#progress').text(`å…¥åº“ä¸­ï¼ˆ${deduped.length} æ¡ï¼‰â€¦`);
      const resp = await fetch('/api/ae_upsert', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rows: deduped }) });
      const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Upsert APIå“åº”ä¸æ˜¯JSONï¼š' + txt.slice(0,200)); }
      if (!resp.ok || !j.ok) throw new Error(j.error || 'å…¥åº“å¤±è´¥');
      $('#progress').text('å…¥åº“å®Œæˆ âœ”');
      await fetchAndRenderAll();
    } catch(err) {
      console.error(err); alert('å¤„ç†å¤±è´¥ï¼š' + (err.message || err)); $('#progress').text('');
    }
  };
  reader.readAsArrayBuffer(file);
});

/* ---------- æŸ¥è¯¢ / æ±‡æ€» ---------- */
async function fetchAgg(startISO, endISO, granularity) {
  const url = `/api/ae_query?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}&granularity=${encodeURIComponent(granularity)}`;
  const resp = await fetch(url);
  const txt = await resp.text(); let j; try { j = JSON.parse(txt); } catch(e) { throw new Error('Query APIå“åº”ä¸æ˜¯JSONï¼š' + txt.slice(0,200)); }
  if (!resp.ok || !j.ok) throw new Error(j.error || 'æŸ¥è¯¢å¤±è´¥');
  return j.rows || [];
}
function periodShift(startISO, endISO) {
  const start = new Date(startISO + 'T00:00:00'); const end = new Date(endISO + 'T00:00:00');
  const days = Math.round((end - start) / 86400000) + 1;
  const prevEnd = new Date(start.getTime() - 86400000);
  const prevStart = new Date(prevEnd.getTime() - (days-1)*86400000);
  const fmt = d => d.toISOString().slice(0,10);
  return { prevStart: fmt(prevStart), prevEnd: fmt(prevEnd), days };
}
function computeCards(rows, prevRows) {
  function summarize(rs){
    if (!rs.length) return {vr:0,cr:0,pr:0,total:0,pc:0,pp:0};
    const sum = rs.reduce((a,b)=>({exposure:a.exposure+b.exposure,visitors:a.visitors+b.visitors,add_people:a.add_people+b.add_people,pay_buyers:a.pay_buyers+b.pay_buyers}), {exposure:0,visitors:0,add_people:0,pay_buyers:0});
    const products=new Map(); rs.forEach(r=>{ if(!products.has(r.product_id)) products.set(r.product_id,{exp:0,add:0,pay:0}); const acc=products.get(r.product_id); acc.exp+=r.exposure||0; acc.add+=r.add_people||0; acc.pay+=r.pay_buyers||0; });
    let pe=0,pc=0,pp=0; products.forEach(v=>{ if(v.exp>0)pe++; if(v.add>0)pc++; if(v.pay>0)pp++; });
    const vr=sum.exposure>0?((sum.visitors/sum.exposure)*100):0;
    const cr=sum.visitors>0?((sum.add_people/sum.visitors)*100):0;
    const pr=sum.add_people>0?((sum.pay_buyers/sum.add_people)*100):0;
    return {vr,cr,pr,total:products.size,pc,pp};
  }
  function setDelta(id,diff,isPercent){
    const el=document.getElementById(id); if(!el)return;
    const arrow=diff>=0?'â†‘':'â†“';
    const cls=diff>=0?'delta up':'delta down';
    const val=isPercent?Math.abs(diff).toFixed(2)+'%':Math.abs(diff).toString();
    el.innerHTML=`<span class="${cls}">${arrow} ${val}</span>`;
  }
  const cur=summarize(rows), prev=summarize(prevRows||[]);
  $('#avgVisitor').text(cur.vr.toFixed(2)+'%');
  $('#avgCart').text(cur.cr.toFixed(2)+'%');
  $('#avgPay').text(cur.pr.toFixed(2)+'%');
  $('#totalProducts').text(cur.total); $('#cartedProducts').text(cur.pc); $('#purchasedProducts').text(cur.pp);
  setDelta('avgVisitorChange', cur.vr-prev.vr, true);
  setDelta('avgCartChange', cur.cr-prev.cr, true);
  setDelta('avgPayChange', cur.pr-prev.pr, true);
  setDelta('totalProductsChange', cur.total-prev.total, false);
  setDelta('cartedProductsChange', cur.pc-prev.pc, false);
  setDelta('purchasedProductsChange', cur.pp-prev.pp, false);
}
function aggregateByProduct(rows, startISO, endISO) {
  const map=new Map();
  rows.forEach(r=>{
    const id=r.product_id;
    if(!map.has(id)){
      map.set(id,{
        product_id:id,
        exposure:0,visitors:0,views:0,add_people:0,
        order_items:0,pay_items:0,pay_buyers:0,
        _ctr_num:0,_ctr_den:0,_stay_num:0,_stay_den:0
      });
    }
    const acc=map.get(id);
    acc.exposure+=r.exposure||0;
    acc.visitors+=r.visitors||0;
    acc.views+=r.views||0;
    acc.add_people+=r.add_people||0;
    acc.order_items+=r.order_items||0;
    acc.pay_items+=r.pay_items||0;
    acc.pay_buyers+=r.pay_buyers||0;
    if(r.search_ctr!==null&&r.search_ctr!==undefined){
      const w=r.exposure||0;
      acc._ctr_num+=(Number(r.search_ctr)||0)*w;
      acc._ctr_den+=w;
    }
    if(r.avg_stay_seconds!==null&&r.avg_stay_seconds!==undefined){
      const wv=r.visitors||0;
      acc._stay_num+=(Number(r.avg_stay_seconds)||0)*wv;
      acc._stay_den+=wv;
    }
  });
  const label=startISO===endISO?startISO:`${startISO}~${endISO}`;
  return Array.from(map.values()).map(acc=>({
    product_id:acc.product_id,
    bucket_label:label,
    exposure:acc.exposure,
    visitors:acc.visitors,
    views:acc.views,
    add_people:acc.add_people,
    order_items:acc.order_items,
    pay_items:acc.pay_items,
    pay_buyers:acc.pay_buyers,
    search_ctr:acc._ctr_den>0?acc._ctr_num/acc._ctr_den:null,
    avg_stay_seconds:acc._stay_den>0?acc._stay_num/acc._stay_den:null
  }));
}
function buildDailyTotals(rows, days, startISO) {
  const byDay=new Map(); rows.forEach(r=>{ const d=r.bucket; if(!byDay.has(d)) byDay.set(d,{exp:0,vis:0,add:0,fav:0,orders:0}); const a=byDay.get(d); a.exp+=r.exposure||0; a.vis+=r.visitors||0; a.add+=r.add_people||0; a.orders+=r.pay_orders||0; a.fav+=(r.fav_people||r.fav_count||0); });
  const x=[],A=[]; const start=new Date(startISO+'T00:00:00');
  for(let i=0;i<days;i++){ const cur=new Date(start.getTime()+i*86400000); const key=cur.toISOString().slice(0,10); x.push(`Day ${i+1}`); const a=byDay.get(key)||{exp:0,vis:0,add:0,fav:0,orders:0}; A.push({exp:a.exp,vis:a.vis,add:a.add,fav:a.fav,orders:a.orders,date:key}); }
  return { x, A };
}
function drawLineChartDaily(rowsA, rowsB, days, startA, startB, metricKey) {
  const chart=echarts.init(document.getElementById('lineChart'));
  const A=buildDailyTotals(rowsA,days,startA); const B=buildDailyTotals(rowsB,days,startB); const x=A.x;
  function pick(arr){ return arr.map(o=>Number((o[metricKey]||0))) }
  chart.setOption({
    tooltip:{ trigger:'axis', formatter:(params)=>{ let s=''; params.forEach(p=>{ const series=p.seriesName==='å‘¨æœŸA'?A.A:B.A; const o=series[p.dataIndex]; s+=`<div>${p.marker}${p.seriesName}ï¼š${p.data} <span style='color:#9CA3AF'>(${o?.date||''})</span></div>`; }); return s||'æ— æ•°æ®'; }, backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
    legend:{ data:['å‘¨æœŸA','å‘¨æœŸB'], textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:40, right:16, top:36, bottom:24 },
    xAxis:{ type:'category', data:x, axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:true, lineStyle:{ color:GRID_LINE }} },
    yAxis:{ type:'value', axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE }} },
    series:[
      { name:'å‘¨æœŸA', type:'line', data:pick(A.A), smooth:true, showSymbol:false, lineStyle:{ width:3 }, itemStyle:{ color:'#2563EB' } },
      { name:'å‘¨æœŸB', type:'line', data:pick(B.A), smooth:true, showSymbol:false, lineStyle:{ width:3 }, itemStyle:{ color:'#F97316' } }
    ]
  }); window.addEventListener('resize', ()=>chart.resize());
}
function drawRatioBar(rowsA, rowsB){
  function sums(rows){ return rows.reduce((a,b)=>({exp:a.exp+b.exposure,vis:a.vis+b.visitors,add:a.add+b.add_people,pay:a.pay+b.pay_buyers}),{exp:0,vis:0,add:0,pay:0}); }
  const A=sums(rowsA), B=sums(rowsB);
  const d={ A:[(A.vis>0?A.add/A.vis*100:0),(A.exp>0?A.vis/A.exp*100:0),(A.add>0?A.pay/A.add*100:0)], B:[(B.vis>0?B.add/B.vis*100:0),(B.exp>0?B.vis/B.exp*100:0),(B.add>0?B.pay/B.add*100:0)] };
  const chart=echarts.init(document.getElementById('ratioBar'));
  chart.setOption({
    tooltip:{ trigger:'axis', backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
    legend:{ data:['å‘¨æœŸA','å‘¨æœŸB'], textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:40, right:16, top:36, bottom:24 },
    xAxis:{ type:'category', data:['å¹³å‡åŠ è´­æ¯”','å¹³å‡è®¿å®¢æ¯”','å¹³å‡æ”¯ä»˜æ¯”'], axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:false } },
    yAxis:{ type:'value', axisLabel:{ ...AXIS_LABEL, formatter:'{value} %' }, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE }} },
    series:[
      { name:'å‘¨æœŸA', type:'bar', data:d.A.map(v=>Number(v.toFixed(2))), itemStyle:{ color:'#2563EB' }, label:{ show:true, position:'top', formatter:'{c}%', color:'#E5E7EB', fontWeight:700 } },
      { name:'å‘¨æœŸB', type:'bar', data:d.B.map(v=>Number(v.toFixed(2))), itemStyle:{ color:'#F97316' }, label:{ show:true, position:'top', formatter:'{c}%', color:'#E5E7EB', fontWeight:700 } }
    ]
  }); window.addEventListener('resize', ()=>chart.resize());
}
async function drawTop6Both(rowsA, rowsB){
  function perAdd(rows){ const m=new Map(); rows.forEach(r=>m.set(r.product_id,(m.get(r.product_id)||0)+(r.add_people||0))); return m; }
  const mapA=perAdd(rowsA), mapB=perAdd(rowsB);
  const topN=(map,n=6)=>Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([id])=>id);
  const unionIds=Array.from(new Set([...topN(mapA,6),...topN(mapB,6)]));
  const rows=unionIds.map(id=>({id,a:mapA.get(id)||0,b:mapB.get(id)||0,max:Math.max(mapA.get(id)||0,mapB.get(id)||0)})).sort((x,y)=>y.max-x.max);
  const ids=rows.map(r=>r.id), labels=ids, dataA=rows.map(r=>r.a), dataB=rows.map(r=>r.b);
  function hue(id){ let h=0; for(let i=0;i<id.length;i++) h=(h*31+id.charCodeAt(i))%360; return h; }
  const colorsA=ids.map(id=>`hsl(${hue(id)}, 70%, 55%)`), colorsB=ids.map(id=>`hsl(${hue(id)}, 70%, 80%)`);
  const chart=echarts.init(document.getElementById('topBar'));
  chart.setOption({
    tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' }, backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
    legend:{ textStyle:{ color:'#E5E7EB', fontWeight:700 } },
    grid:{ left:140, right:20, top:20, bottom:24 },
    xAxis:{ type:'value', axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE }} },
    yAxis:{ type:'category', data:labels, axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:false } },
    series:[
      { name:'å‘¨æœŸA', type:'bar', data:dataA.map((v,i)=>({value:v,itemStyle:{color:colorsA[i]}})), label:{ show:true, position:'right', color:'#E5E7EB', fontWeight:700 } },
      { name:'å‘¨æœŸB', type:'bar', data:dataB.map((v,i)=>({value:v,itemStyle:{color:colorsB[i]}})), label:{ show:true, position:'right', color:'#E5E7EB', fontWeight:700 } }
    ]
  });
  chart.off('click'); chart.on('click', p=>{ const id=ids[p.dataIndex]; if(id) window.open(`https://aliexpress.com/item/${id}.html`,'_blank'); });
  window.addEventListener('resize', ()=>chart.resize());
  const linksDiv=document.getElementById('topBarLinks');
  if(linksDiv){
    linksDiv.innerHTML=ids.map(id=>`<a data-pid="${id}" data-link="https://aliexpress.com/item/${id}.html" href="https://aliexpress.com/item/${id}.html" target="_blank">${id}</a>`).join(' ');
    populateProductNames(linksDiv);
  }
}

function renderProductChart(rowsA, rowsB, days, startA, startB){
  const sel = $('#selfProductSelect').off('change');
  const ids = Array.from(new Set((rowsA||[]).map(r=>r.product_id))).filter(Boolean);
  sel.empty();
  if (!ids.length){ const c=echarts.init(document.getElementById('selfProductLine')); c.clear(); return; }
  ids.forEach(id=> sel.append(`<option value="${id}" data-pid="${id}">${id}</option>`));
  populateProductNames(sel[0]);
  function draw(pid){
    const mapA=new Map(); rowsA.filter(r=>r.product_id==pid).forEach(r=>mapA.set(r.bucket,r.exposure||0));
    const mapB=new Map(); rowsB.filter(r=>r.product_id==pid).forEach(r=>mapB.set(r.bucket,r.exposure||0));
    const x=[], a=[], b=[];
    for(let i=0;i<days;i++){
      const da=new Date(startA+'T00:00:00'); da.setDate(da.getDate()+i); const isoA=da.toISOString().slice(0,10);
      const db=new Date(startB+'T00:00:00'); db.setDate(db.getDate()+i); const isoB=db.toISOString().slice(0,10);
      x.push(isoA); a.push(mapA.get(isoA)||0); b.push(mapB.get(isoB)||0);
    }
    const chart=echarts.init(document.getElementById('selfProductLine'));
    chart.setOption({
      tooltip:{ trigger:'axis', backgroundColor:'#0b1220', borderColor:GRID_LINE, textStyle:{ color:'#E5E7EB' } },
      legend:{ data:['å‘¨æœŸA','å‘¨æœŸB'], textStyle:{ color:'#E5E7EB', fontWeight:700 } },
      grid:{ left:40, right:16, top:36, bottom:24 },
      xAxis:{ type:'category', data:x, axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ show:true, lineStyle:{ color:GRID_LINE } } },
      yAxis:{ type:'value', axisLabel:AXIS_LABEL, axisLine:{ lineStyle:{ color:GRID_LINE }}, splitLine:{ lineStyle:{ color:GRID_LINE } } },
      series:[
        { name:'å‘¨æœŸA', type:'line', data:a, smooth:true, showSymbol:false, lineStyle:{ width:3 }, itemStyle:{ color:'#2563EB' } },
        { name:'å‘¨æœŸB', type:'line', data:b, smooth:true, showSymbol:false, lineStyle:{ width:3 }, itemStyle:{ color:'#F97316' } }
      ]
    });
    window.addEventListener('resize', ()=>chart.resize());
  }
  sel.on('change', ()=>draw(sel.val()));
  draw(ids[0]);
}
async function renderTable(rows, granularity) {
  if (window.dataTable) window.dataTable.destroy(); $('#report').empty();
  const data = rows.map(r => {
    const link = r.product_id ? `<a data-pid="${r.product_id}" data-link="https://aliexpress.com/item/${r.product_id}.html" href="https://aliexpress.com/item/${r.product_id}.html" target="_blank">${r.product_id}</a>` : '';
    const conv1 = r.exposure>0 ? ((r.visitors/r.exposure)*100).toFixed(2) : '0.00';
    const conv2 = r.visitors>0 ? ((r.add_people/r.visitors)*100).toFixed(2) : '0.00';
    const conv3 = r.add_people>0 ? ((r.pay_buyers/r.add_people)*100).toFixed(2) : '0.00';
    const ctr = formatCtr(r.search_ctr);
    const stay = (r.avg_stay_seconds==null || r.avg_stay_seconds===undefined) ? '' : Math.round(r.avg_stay_seconds);
    const detailLink = '<a href="product-analysis.html?mode=self&pid='+ (r.product_id||'') +'" target="_blank">è¯¦æƒ…</a>';
    return [link, r.bucket_label || r.bucket, conv1 + '%', conv2 + '%', conv3 + '%', r.exposure, r.visitors, r.views, r.add_people, r.order_items, r.pay_items, r.pay_buyers, ctr, stay, detailLink];
  });
  window.dataTable = $('#report').DataTable({
    data,
    columns: [
      { title: 'å•†å“ï¼ˆIDï¼‰' },
      { title: granularity==='day' ? 'æ—¥æœŸ' : (granularity==='week' ? 'å‘¨èŒƒå›´' : (granularity==='period' ? 'å‘¨æœŸ' : 'æœˆä»½èŒƒå›´')) },
      { title: 'è®¿å®¢æ¯”(%)' }, { title: 'åŠ è´­æ¯”(%)' }, { title: 'æ”¯ä»˜æ¯”(%)' },
      { title: 'æ›å…‰é‡' }, { title: 'è®¿å®¢æ•°' }, { title: 'æµè§ˆé‡' },
      { title: 'åŠ è´­äººæ•°' },
      // å»æ‰â€œåŠ è´­ä»¶æ•°ã€æ”¯ä»˜è®¢å•æ•°â€ï¼Œæ–°å¢ä¸‰åˆ—ï¼š
      { title: 'ä¸‹å•å•†å“ä»¶æ•°' },
      { title: 'æ”¯ä»˜ä»¶æ•°' },
      { title: 'æ”¯ä»˜ä¹°å®¶æ•°' },
      { title: 'æœç´¢ç‚¹å‡»ç‡(%)' },
      { title: 'å¹³å‡åœç•™æ—¶é•¿(ç§’)' },
      { title: 'äº§å“è¯¦æƒ…' }
    ],
    order: [[1,'desc']], scrollX:true, scrollY:'calc(100vh - 420px)', scrollCollapse:true, fixedHeader:true, fixedColumns:{leftColumns:1}
  });
  $('#report tbody').on('dblclick','td',function(){
    const col = window.dataTable.cell(this).index().column;
    const last = window.dataTable.columns().count()-1;
    if(col===0 || col===last) return;
    const pid = $(this).closest('tr').find('a[data-pid]').data('pid');
    if(pid) window.open('product-analysis.html?mode=self&pid='+pid, '_blank');
  });
  populateProductNames(document.getElementById('report'));
}
const statusEl = document.getElementById('status');
async function fetchAndRenderAll() {
  statusEl.textContent = 'åŠ è½½ä¸­...';
  try {
    const val=$('#dateFilter').val(); let startISO,endISO;
    if (val && val.includes(' to ')) { const [s,e]=val.split(' to '); startISO=s; endISO=e; }
    else {
      const today=new Date(); endISO=today.toISOString().slice(0,10);
      startISO=new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
      $('#dateFilter').val(`${startISO} to ${endISO}`);
    }
    localStorage.setItem('selfPeriod', `${startISO} to ${endISO}`);
    const { prevStart, prevEnd, days }=periodShift(startISO,endISO);
    const [rowsAggA, rowsAggB, rowsDayA, rowsDayB] = await Promise.all([
      fetchAgg(startISO,endISO,'period'),
      fetchAgg(prevStart,prevEnd,'period'),
      fetchAgg(startISO,endISO,'day'),
      fetchAgg(prevStart,prevEnd,'day')
    ]);
    computeCards(rowsAggA, rowsAggB);
    await renderTable(rowsAggA,'period');
    const metricKey=(function(k){ if(k==='exposure_sum')return 'exp'; if(k==='visitors_sum')return 'vis'; if(k==='add_people_sum')return 'add'; if(k==='orders_sum')return 'orders'; if(k==='fav_sum')return 'fav'; })(document.getElementById('metricSel').value);
    drawLineChartDaily(rowsDayA,rowsDayB,days,startISO,prevStart,metricKey);
    drawRatioBar(rowsAggA,rowsAggB);
    await drawTop6Both(rowsAggA,rowsAggB);
    renderProductChart(rowsDayA,rowsDayB,days,startISO,prevStart);
    if (window.refreshFromPageRange) {
      window.refreshFromPageRange();
    }
    $('#progress').text(`A: ${rowsDayA.length} æ¡ Â· B: ${rowsDayB.length} æ¡`);
    statusEl.textContent = 'åŠ è½½å®Œæˆ';
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'åŠ è½½å¤±è´¥ï¼š' + (err.message || err);
    alert('æŸ¥è¯¢å¤±è´¥ï¼š' + (err.message || err));
    $('#progress').text('');
  }
}
/* ---------- åˆå§‹åŒ– ---------- */
const fp=flatpickr('#dateFilter',{ mode:'range', dateFormat:'Y-m-d', onClose:(ds)=>{ if(ds.length===2) fetchAndRenderAll(); } });
$('#metricSel').on('change', fetchAndRenderAll);

(async function initDefault(){
  const stored = localStorage.getItem('selfPeriod');
  if (stored && stored.includes(' to ')) {
    $('#dateFilter').val(stored);
  } else {
    const today=new Date(); const end=today.toISOString().slice(0,10);
    const startDate=new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
    const def=`${startDate} to ${end}`;
    $('#dateFilter').val(def);
    localStorage.setItem('selfPeriod', def);
  }
  await fetchAndRenderAll();
})();
</script>

<!-- ====== New Products KPI (Self) ====== -->
<script>
(function(){
  let removeNewFilter = null;
  let lastData = null;

  function getDT(){
    if (!window.jQuery || !jQuery.fn || !jQuery.fn.dataTable) return null;
    try { return window.dataTable || jQuery('#report').DataTable(); } catch(e){ return null; }
  }
  async function fetchRange(fromISO, toISO){
    const qs = new URLSearchParams({ platform:'self' });
    if (fromISO) qs.set('from', fromISO);
    if (toISO) qs.set('to', toISO);
    const r = await fetch('/api/new-products?'+qs.toString());
    const j = await r.json();
    if (!j.ok) throw new Error(j.msg||'fetch error');
    return j;
  }
  function parseDateRange(){
    const input = document.getElementById('dateFilter');
    if (input && input.value && input.value.includes(' to ')){
      const [s, e] = input.value.split(' to ');
      return { from:s, to:e };
    }
    const today = new Date();
    const to = today.toISOString().slice(0,10);
    const from = new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
    return { from, to };
  }
  function ensureCard(){
    let wrap = document.querySelector('.kpi') || document.getElementById('kpi');
    if (!wrap){
      const table = document.querySelector('#report');
      const host = document.createElement('div');
      host.className = 'kpi-row';
      if (table && table.parentNode) table.parentNode.insertBefore(host, table);
      else document.body.insertBefore(host, document.body.firstChild);
      wrap = host;
    }
    let card = document.getElementById('kpi-new-self-card');
    if (!card){
      const div = document.createElement('div');
      div.className = 'card clickable stat-card';
      div.id = 'kpi-new-self-card';
      div.innerHTML = '<h4>æœ¬å‘¨æœŸæ–°å“æ•°</h4><p id="kpi-new-self-count">--</p><a id="kpi-new-self-clear" class="mini-link">æ¸…é™¤ç­›é€‰</a>';
      wrap.appendChild(div);
      card = div;
    }
    const old = document.getElementById('kpi-new-self-ctrl');
    if (old && old.parentNode) old.parentNode.removeChild(old);
    return {
      card,
      countEl: document.getElementById('kpi-new-self-count'),
      clearEl: document.getElementById('kpi-new-self-clear'),
    };
  }
  function applyFilterByIds(ids){
    const dt = getDT();
    if (removeNewFilter){ removeNewFilter(); removeNewFilter = null; }

    if (dt && jQuery.fn.dataTable.ext){
      const ext = jQuery.fn.dataTable.ext;
      const filterFn = (settings, data, dataIndex) => {
        let pid = (data[0]||'').toString().trim();
        if (!pid || /<a/i.test(pid)) {
          const rowNode = dt.row(dataIndex).node();
          const cell = rowNode && rowNode.querySelector('td:first-child');
          if (cell) pid = (cell.textContent||'').trim();
        }
        const m = pid.match(/(\d{6,})/g);
        if (m && m.length) pid = m[m.length-1];
        return ids.has(pid);
      };
      ext.search.push(filterFn);
      dt.draw();
      removeNewFilter = () => {
        const pos = ext.search.findIndex(f => f === filterFn);
        if (pos > -1) ext.search.splice(pos, 1);
        dt.draw();
      };
    } else {
      const table = document.querySelector('#report');
      if (!table || !table.tBodies[0]) return;
      const rows = Array.from(table.tBodies[0].rows);
      const original = new Map();
      rows.forEach(tr => {
        const td = tr.cells[0];
        let pid = td ? td.textContent.trim() : '';
        const m = pid.match(/(\d{6,})/g);
        if (m && m.length) pid = m[m.length-1];
        if (!original.has(tr)) original.set(tr, tr.style.display);
        tr.style.display = ids.has(pid) ? '' : 'none';
      });
      removeNewFilter = () => { for (const [tr, disp] of original) tr.style.display = disp; };
    }
  }
  async function refreshFromPageRange(){
    const ui = ensureCard();
    const { from, to } = parseDateRange();
    try{
      lastData = await fetchRange(from, to);
      ui.countEl.textContent = lastData.new_count || 0;
      ui.card.onclick = () => {
        if (!lastData.items || !lastData.items.length) return;
        const ids = new Set(lastData.items.map(x => String(x.product_id)));
        applyFilterByIds(ids);
        ui.clearEl.style.display = 'inline';
      };
      ui.clearEl.onclick = (e) => {
        e.stopPropagation();
        if (removeNewFilter) removeNewFilter();
        ui.clearEl.style.display = 'none';
      };
    }catch(e){
      console.warn('[Self KPI] fetch failed:', e);
    }
  }

  // expose for external calls (e.g., initial data fetch)
  window.refreshFromPageRange = refreshFromPageRange;

  document.addEventListener('DOMContentLoaded', function(){
    const obs = new MutationObserver(()=>{
      const tb = document.querySelector('#report tbody');
      const kpiHost = document.querySelector('.kpi') || document.getElementById('kpi') || document.querySelector('.kpi-row');
      if (kpiHost && tb && tb.children.length){
        obs.disconnect();
        const ghost = document.getElementById('kpi-new-self-ctrl');
        if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
        refreshFromPageRange();
        const input = document.getElementById('dateFilter');
        if (input && !input._newkpi_hook){
          input._newkpi_hook = true;
          input.addEventListener('change', refreshFromPageRange);
          input.addEventListener('blur', refreshFromPageRange);
        }
      }
    });
    obs.observe(document.body, { childList:true, subtree:true });

    const tbody = document.querySelector('#report tbody');
    if (tbody){
      const tObs = new MutationObserver(()=>{ refreshFromPageRange(); });
      tObs.observe(tbody, { childList:true });
    }
  });
})();
</script>
<script src="assets/login.js"></script>
<script src="assets/site-nav.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const siteListKey='managedSites';
  const currentSiteKey='currentSite';
  let sites=JSON.parse(localStorage.getItem(siteListKey)||'null');
  if(!Array.isArray(sites)||!sites.length){sites=['Aç«™','Bç«™','Cç«™'];}
  const currentSiteEl=document.getElementById('currentSite');
  function save(){localStorage.setItem(siteListKey,JSON.stringify(sites));renderSiteMenus();}
  function updateCurrent(){
    const name=localStorage.getItem(currentSiteKey)||sites[0];
    currentSiteEl.textContent='è‡ªè¿è¥ '+name;
    localStorage.setItem(currentSiteKey,name);
  }
  currentSiteEl.addEventListener('dblclick',()=>{
    const cur=localStorage.getItem(currentSiteKey)||sites[0];
    const idx=sites.indexOf(cur);
    const n=prompt('ä¿®æ”¹ç«™ç‚¹å',cur);
    if(n){sites[idx]=n;save();localStorage.setItem(currentSiteKey,n);updateCurrent();}
  });
  document.getElementById('addSite').addEventListener('click',()=>{
    const n=prompt('æ–°å¢ç«™ç‚¹å');
    if(n){sites.push(n);save();updateCurrent();}
  });
  renderSiteMenus();
  updateCurrent();
  const userArea=document.getElementById('userArea');
  function refreshUser(){
    const u=JSON.parse(localStorage.getItem('user')||'null');
    if(u){
      userArea.innerHTML=`<div class="user-section"><div class="user-menu-trigger">${u.name}</div><div class="user-dropdown" style="display:none"><button class="user-dropdown-item" id="logoutBtn">é€€å‡º</button></div></div>`;
      const trigger=userArea.querySelector('.user-menu-trigger');
      const dropdown=userArea.querySelector('.user-dropdown');
      trigger.addEventListener('click',()=>{dropdown.style.display=dropdown.style.display==='block'?'none':'block';});
      document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.removeItem('user');dropdown.style.display='none';refreshUser();showLoginOverlay();});
    }else{
      userArea.innerHTML='<div class="user-section"><span class="user-demo">æœªç™»å½•</span><button class="login-button" id="loginTrigger">ç™»å½•</button></div>';
      document.getElementById('loginTrigger').addEventListener('click',showLoginOverlay);
      showLoginOverlay();
    }
  }
  refreshUser();
  window.addEventListener('user-login', refreshUser);
  const sb=document.getElementById('sidebar');
  sb.addEventListener('click',e=>{
    const a=e.target.closest('a[data-target]');
    if(!a) return;
    e.preventDefault();
    const t=a.dataset.target;
    ['detail','analysis','product'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.style.display=id===t?'':'none';
    });
    sb.querySelectorAll('a[data-target]').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    setTimeout(()=>window.dispatchEvent(new Event('resize')),0);
  });
});
</script>
</body>
</html>
